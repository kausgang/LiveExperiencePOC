/*!
 * Copyright (c) 2018 Oracle. All rights reserved.
 *
 * This material is the confidential property of Oracle Corporation or its
 * licensors and may be used, reproduced, stored or transmitted only in
 * accordance with a valid Oracle license or sublicense agreement.
 */

/*! Oracle Live Experience JS API (Built on: 2023-07-12)
 * version: [release/21.10.1 @ cc3030a6bf42f6d1de19c27fe0cf372d76b4fbd0] */

!function(){return function e(t,i,o){function s(a,r){if(!i[a]){if(!t[a]){var l="function"==typeof require&&require;if(!r&&l)return l(a,!0);if(n)return n(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var d=i[a]={exports:{}};t[a][0].call(d.exports,function(e){return s(t[a][1][e]||e)},d,d.exports,e,t,i,o)}return i[a].exports}for(var n="function"==typeof require&&require,a=0;a<o.length;a++)s(o[a]);return s}}()({1:[function(e,t,i){"use strict";var o=(0,e("./adapter_factory.js").adapterFactory)({window:"undefined"==typeof window?void 0:window});t.exports=o},{"./adapter_factory.js":2}],2:[function(e,t,i){"use strict";function o(e){"@babel/helpers - typeof";return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(s=function(e){return e?i:t})(e)}function n(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==o(e)&&"function"!=typeof e)return{default:e};var i=s(t);if(i&&i.has(e))return i.get(e);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var l=a?Object.getOwnPropertyDescriptor(e,r):null;l&&(l.get||l.set)?Object.defineProperty(n,r,l):n[r]=e[r]}return n.default=e,i&&i.set(e,n),n}Object.defineProperty(i,"__esModule",{value:!0}),i.adapterFactory=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},i=a.log,o=a.detectBrowser(e),s={browserDetails:o,commonShim:d,extractVersion:a.extractVersion,disableLog:a.disableLog,disableWarnings:a.disableWarnings,sdp:u};switch(o.browser){case"chrome":if(!r||!r.shimPeerConnection||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),s;if(null===o.version)return i("Chrome shim can not determine version, not shimming."),s;i("adapter.js shimming chrome."),s.browserShim=r,d.shimAddIceCandidateNullOrEmpty(e,o),d.shimParameterlessSetLocalDescription(e,o),r.shimGetUserMedia(e,o),r.shimMediaStream(e,o),r.shimPeerConnection(e,o),r.shimOnTrack(e,o),r.shimAddTrackRemoveTrack(e,o),r.shimGetSendersWithDtmf(e,o),r.shimGetStats(e,o),r.shimSenderReceiverGetStats(e,o),r.fixNegotiationNeeded(e,o),d.shimRTCIceCandidate(e,o),d.shimRTCIceCandidateRelayProtocol(e,o),d.shimConnectionState(e,o),d.shimMaxMessageSize(e,o),d.shimSendThrowTypeError(e,o),d.removeExtmapAllowMixed(e,o);break;case"firefox":if(!l||!l.shimPeerConnection||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),s;i("adapter.js shimming firefox."),s.browserShim=l,d.shimAddIceCandidateNullOrEmpty(e,o),d.shimParameterlessSetLocalDescription(e,o),l.shimGetUserMedia(e,o),l.shimPeerConnection(e,o),l.shimOnTrack(e,o),l.shimRemoveStream(e,o),l.shimSenderGetStats(e,o),l.shimReceiverGetStats(e,o),l.shimRTCDataChannel(e,o),l.shimAddTransceiver(e,o),l.shimGetParameters(e,o),l.shimCreateOffer(e,o),l.shimCreateAnswer(e,o),d.shimRTCIceCandidate(e,o),d.shimConnectionState(e,o),d.shimMaxMessageSize(e,o),d.shimSendThrowTypeError(e,o);break;case"safari":if(!c||!t.shimSafari)return i("Safari shim is not included in this adapter release."),s;i("adapter.js shimming safari."),s.browserShim=c,d.shimAddIceCandidateNullOrEmpty(e,o),d.shimParameterlessSetLocalDescription(e,o),c.shimRTCIceServerUrls(e,o),c.shimCreateOfferLegacy(e,o),c.shimCallbacksAPI(e,o),c.shimLocalStreamsAPI(e,o),c.shimRemoteStreamsAPI(e,o),c.shimTrackEventTransceiver(e,o),c.shimGetUserMedia(e,o),c.shimAudioContext(e,o),d.shimRTCIceCandidate(e,o),d.shimRTCIceCandidateRelayProtocol(e,o),d.shimMaxMessageSize(e,o),d.shimSendThrowTypeError(e,o),d.removeExtmapAllowMixed(e,o);break;default:i("Unsupported browser!")}return s};var a=n(e("./utils")),r=n(e("./chrome/chrome_shim")),l=n(e("./firefox/firefox_shim")),c=n(e("./safari/safari_shim")),d=n(e("./common_shim")),u=n(e("sdp"))},{"./chrome/chrome_shim":3,"./common_shim":6,"./firefox/firefox_shim":7,"./safari/safari_shim":10,"./utils":11,sdp:12}],3:[function(e,t,i){"use strict";function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function s(e,t,i){return(t=function(e){var t=function(e,t){if("object"!==n(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!==n(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===n(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function n(e){"@babel/helpers - typeof";return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(t){return e._shimmedLocalStreams[t][0]})};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var o=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(o)&&this._shimmedLocalStreams[i.id].push(o):this._shimmedLocalStreams[i.id]=[i,o],o};var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(function(e){if(t.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")});var o=this.getSenders();i.apply(this,arguments);var s=this.getSenders().filter(function(e){return-1===o.indexOf(e)});this._shimmedLocalStreams[e.id]=[e].concat(s)};var o=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],o.apply(this,arguments)};var s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(function(i){var o=t._shimmedLocalStreams[i].indexOf(e);-1!==o&&t._shimmedLocalStreams[i].splice(o,1),1===t._shimmedLocalStreams[i].length&&delete t._shimmedLocalStreams[i]}),s.apply(this,arguments)}}Object.defineProperty(i,"__esModule",{value:!0}),i.fixNegotiationNeeded=function(e,t){r.wrapPeerConnectionEvent(e,"negotiationneeded",function(e){var i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e})},i.shimAddTrackRemoveTrack=function(e,t){function i(e,t){var i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(function(t){var o=e._reverseStreams[t],s=e._streams[o.id];i=i.replace(new RegExp(s.id,"g"),o.id)}),new RTCSessionDescription({type:t.type,sdp:i})}if(e.RTCPeerConnection){if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return a(e);var o=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=o.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map(function(t){return e._reverseStreams[t.id]})};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var i=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(function(e){if(i.getSenders().find(function(t){return t.track===e}))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){var o=new e.MediaStream(t.getTracks());this._streams[t.id]=o,this._reverseStreams[o.id]=t,t=o}n.apply(this,[t])};var r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){var o=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var s=[].slice.call(arguments,1);if(1!==s.length||!s[0].getTracks().find(function(e){return e===t}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(function(e){return e.track===t}))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var n=this._streams[i.id];if(n)n.addTrack(t),Promise.resolve().then(function(){o.dispatchEvent(new Event("negotiationneeded"))});else{var a=new e.MediaStream([t]);this._streams[i.id]=a,this._reverseStreams[a.id]=i,this.addStream(a)}return this.getSenders().find(function(e){return e.track===t})},["createOffer","createAnswer"].forEach(function(t){var o=e.RTCPeerConnection.prototype[t],n=s({},t,function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?o.apply(this,[function(o){var s=i(e,o);t[0].apply(null,[s])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):o.apply(this,arguments).then(function(t){return i(e,t)})});e.RTCPeerConnection.prototype[t]=n[t]});var l=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=(e=this,t=arguments[0],i=t.sdp,Object.keys(e._reverseStreams||[]).forEach(function(t){var o=e._reverseStreams[t],s=e._streams[o.id];i=i.replace(new RegExp(o.id,"g"),s.id)}),new RTCSessionDescription({type:t.type,sdp:i})),l.apply(this,arguments)):l.apply(this,arguments);var e,t,i};var c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=c.get.apply(this);return""===e.type?e:i(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,i=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{},Object.keys(this._streams).forEach(function(o){i._streams[o].getTracks().find(function(t){return e.track===t})&&(t=i._streams[o])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}},i.shimAddTrackRemoveTrackWithNative=a,Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return c.shimGetDisplayMedia}}),i.shimGetSendersWithDtmf=function(e){if("object"===n(e)&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,o){var s=i.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};var o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){o.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var i=this;this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach(function(e){i._senders.push(t(i,e))})};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach(function(e){var i=t._senders.find(function(t){return t.track===e});i&&t._senders.splice(t._senders.indexOf(i),1)})}}else if("object"===n(e)&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var r=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=r.apply(this,[]);return t.forEach(function(t){return t._pc=e}),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},i.shimGetStats=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=this,i=Array.prototype.slice.call(arguments),o=i[0],s=i[1],n=i[2];if(arguments.length>0&&"function"==typeof o)return t.apply(this,arguments);var a=function(e){var t={};return e.result().forEach(function(e){var i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(function(t){i[t]=e.stat(t)}),t[i.id]=i}),t},r=function(e){var t=new Map(Object.keys(e).map(function(t){return[t,e[t]]}));return Object.keys(e).forEach(function(i){t[i]=e[i]}),t};return arguments.length>=2?t.apply(this,[function(e){s(r(a(e)))},o]):new Promise(function(i,o){t.apply(e,[function(e){i(r(a(e)))},o])}).then(s,n)}}},Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return l.shimGetUserMedia}}),i.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},i.shimOnTrack=function(e){if("object"!==n(e)||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)r.wrapPeerConnectionEvent(e,"track",function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e});else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var i=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",function(o){var s;s=e.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(e){return e.track&&e.track.id===o.track.id}):{track:o.track};var n=new Event("track");n.track=o.track,n.receiver=s,n.transceiver={receiver:s},n.streams=[t.stream],i.dispatchEvent(n)}),t.stream.getTracks().forEach(function(o){var s;s=e.RTCPeerConnection.prototype.getReceivers?i.getReceivers().find(function(e){return e.track&&e.track.id===o.id}):{track:o};var n=new Event("track");n.track=o,n.receiver=s,n.transceiver={receiver:s},n.streams=[t.stream],i.dispatchEvent(n)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}},i.shimPeerConnection=function(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){try{var i=e.RTCPeerConnection.prototype[t],o=s({},t,function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)});e.RTCPeerConnection.prototype[t]=o[t]}catch(e){}})},i.shimSenderReceiverGetStats=function(e){if("object"===n(e)&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,i=t.apply(this,[]);return i.forEach(function(t){return t._pc=e}),i});var i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return r.filterStats(t,e.track,!0)})}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var o=e.RTCPeerConnection.prototype.getReceivers;o&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=o.apply(this,[]);return t.forEach(function(t){return t._pc=e}),t}),r.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then(function(t){return r.filterStats(t,e.track,!1)})}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t,i,o,n=arguments[0];return this.getSenders().forEach(function(e){e.track===n&&(t?o=!0:t=e)}),this.getReceivers().forEach(function(e){return e.track===n&&(i?o=!0:i=e),e.track===n}),o||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return s.apply(this,arguments)}}}};var r=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==n(e)&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var s={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var l=a?Object.getOwnPropertyDescriptor(e,r):null;l&&(l.get||l.set)?Object.defineProperty(s,r,l):s[r]=e[r]}return s.default=e,i&&i.set(e,s),s}(e("../utils.js")),l=e("./getusermedia"),c=e("./getdisplaymedia")},{"../utils.js":11,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(e,t){if(!(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices)&&e.navigator.mediaDevices)return"function"!=typeof t?void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void(e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(function(t){var o=i.video&&i.video.width,s=i.video&&i.video.height,n=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:n||3}},o&&(i.video.mandatory.maxWidth=o),s&&(i.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(i)})})}},{}],5:[function(e,t,i){"use strict";function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function s(e){"@babel/helpers - typeof";return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetUserMedia=function(e,t){var i=e&&e.navigator;if(i.mediaDevices){var o=function(e){if("object"!==s(e)||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(i){if("require"!==i&&"advanced"!==i&&"mediaSource"!==i){var o="object"===s(e[i])?e[i]:{ideal:e[i]};void 0!==o.exact&&"number"==typeof o.exact&&(o.min=o.max=o.exact);var n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==o.ideal){t.optional=t.optional||[];var a={};"number"==typeof o.ideal?(a[n("min",i)]=o.ideal,t.optional.push(a),(a={})[n("max",i)]=o.ideal,t.optional.push(a)):(a[n("",i)]=o.ideal,t.optional.push(a))}void 0!==o.exact&&"number"!=typeof o.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=o.exact):["min","max"].forEach(function(e){void 0!==o[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=o[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},a=function(e,a){if(t.version>=61)return a(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===s(e.audio)){var r=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};r((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),r(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=o(e.audio)}if(e&&"object"===s(e.video)){var l=e.video.facingMode;l=l&&("object"===s(l)?l:{ideal:l});var c,d=t.version<66;if(l&&("user"===l.exact||"environment"===l.exact||"user"===l.ideal||"environment"===l.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||d)&&(delete e.video.facingMode,"environment"===l.exact||"environment"===l.ideal?c=["back","rear"]:"user"!==l.exact&&"user"!==l.ideal||(c=["front"]),c))return i.mediaDevices.enumerateDevices().then(function(t){var i=(t=t.filter(function(e){return"videoinput"===e.kind})).find(function(e){return c.some(function(t){return e.label.toLowerCase().includes(t)})});return!i&&t.length&&c.includes("back")&&(i=t[t.length-1]),i&&(e.video.deviceId=l.exact?{exact:i.deviceId}:{ideal:i.deviceId}),e.video=o(e.video),n("chrome: "+JSON.stringify(e)),a(e)});e.video=o(e.video)}return n("chrome: "+JSON.stringify(e)),a(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,o){a(e,function(e){i.webkitGetUserMedia(e,t,function(e){o&&o(r(e))})})}.bind(i),i.mediaDevices.getUserMedia){var l=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(e){return a(e,function(e){return l(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(r(e))})})}}}};var n=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==s(e)&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var l=a?Object.getOwnPropertyDescriptor(e,r):null;l&&(l.get||l.set)?Object.defineProperty(n,r,l):n[r]=e[r]}return n.default=e,i&&i.set(e,n),n}(e("../utils.js")).log},{"../utils.js":11}],6:[function(e,t,i){"use strict";function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function s(e){"@babel/helpers - typeof";return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(i,"__esModule",{value:!0}),i.removeExtmapAllowMixed=function(e,t){if(e.RTCPeerConnection&&!("chrome"===t.browser&&t.version>=71||"safari"===t.browser&&t.version>=605)){var i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){var o=t.sdp.split("\n").filter(function(e){return"a=extmap-allow-mixed"!==e.trim()}).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:o}):t.sdp=o}return i.apply(this,arguments)}}},i.shimAddIceCandidateNullOrEmpty=function(e,t){if(e.RTCPeerConnection&&e.RTCPeerConnection.prototype){var i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}},i.shimConnectionState=function(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(e){var i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}},i.shimMaxMessageSize=function(e,t){if(e.RTCPeerConnection){"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});try{var i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76&&"plan-b"===this.getConfiguration().sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0}),function(e){if(!e||!e.sdp)return!1;var t=n.default.splitSections(e.sdp);return t.shift(),t.some(function(e){var t=n.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})}(arguments[0])){var e,o=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),s=function(e){var i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(o),a=function(e,i){var o=65536;"firefox"===t.browser&&57===t.version&&(o=65535);var s=n.default.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?o=parseInt(s[0].substring(19),10):"firefox"===t.browser&&-1!==i&&(o=2147483637),o}(arguments[0],o);e=0===s&&0===a?Number.POSITIVE_INFINITY:0===s||0===a?Math.max(s,a):Math.min(s,a);var r={};Object.defineProperty(r,"maxMessageSize",{get:function(){return e}}),this._sctp=r}return i.apply(this,arguments)}}catch(e){}}},i.shimParameterlessSetLocalDescription=function(e,t){if(e.RTCPeerConnection&&e.RTCPeerConnection.prototype){var i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this,t=arguments[0]||{};if("object"!==s(t)||t.type&&t.sdp)return i.apply(this,arguments);if(!(t={type:t.type,sdp:t.sdp}).type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":t.type="offer";break;default:t.type="answer"}return t.sdp||"offer"!==t.type&&"answer"!==t.type?i.apply(this,[t]):("offer"===t.type?this.createOffer:this.createAnswer).apply(this).then(function(t){return i.apply(e,[t])})})}},i.shimRTCIceCandidate=function(e){if(e.RTCIceCandidate&&!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===s(e)&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){var i=new t(e),o=n.default.parseCandidate(e.candidate);for(var a in o)a in i||Object.defineProperty(i,a,{value:o[a]});return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t})}},i.shimRTCIceCandidateRelayProtocol=function(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||a.wrapPeerConnectionEvent(e,"icecandidate",function(e){if(e.candidate){var t=n.default.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})},i.shimSendThrowTypeError=function(e){function t(e,t){var i=e.send;e.send=function(){var o=arguments[0],s=o.length||o.size||o.byteLength;if("open"===e.readyState&&t.sctp&&s>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=i.apply(this,arguments);return t(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",function(e){return t(e.channel,e.target),e})}};var n=function(e){return e&&e.__esModule?e:{default:e}}(e("sdp")),a=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==s(e)&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var l=a?Object.getOwnPropertyDescriptor(e,r):null;l&&(l.get||l.set)?Object.defineProperty(n,r,l):n[r]=e[r]}return n.default=e,i&&i.set(e,n),n}(e("./utils"))},{"./utils":11,sdp:12}],7:[function(e,t,i){"use strict";function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function s(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,o=new Array(t);i<t;i++)o[i]=e[i];return o}function a(e,t,i){return(t=function(e){var t=function(e,t){if("object"!==r(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!==r(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===r(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e){"@babel/helpers - typeof";return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(i,"__esModule",{value:!0}),i.shimAddTransceiver=function(e){if("object"===r(e)&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]);var i=(e=s(e)).length>0;i&&e.forEach(function(e){if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});var o=t.apply(this,arguments);if(i){var n=o.sender,a=n.getParameters();"encodings"in a&&(1!==a.encodings.length||0!==Object.keys(a.encodings[0]).length)||(a.encodings=e,n.sendEncodings=e,this.setParametersPromises.push(n.setParameters(a).then(function(){delete n.sendEncodings}).catch(function(){delete n.sendEncodings})))}return o})}},i.shimCreateAnswer=function(e){if("object"===r(e)&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){var e=arguments,i=this;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return t.apply(i,e)}).finally(function(){i.setParametersPromises=[]}):t.apply(this,arguments)}}},i.shimCreateOffer=function(e){if("object"===r(e)&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){var e=arguments,i=this;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return t.apply(i,e)}).finally(function(){i.setParametersPromises=[]}):t.apply(this,arguments)}}},Object.defineProperty(i,"shimGetDisplayMedia",{enumerable:!0,get:function(){return d.shimGetDisplayMedia}}),i.shimGetParameters=function(e){if("object"===r(e)&&e.RTCRtpSender){var t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){var e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}},Object.defineProperty(i,"shimGetUserMedia",{enumerable:!0,get:function(){return c.shimGetUserMedia}}),i.shimOnTrack=function(e){"object"===r(e)&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},i.shimPeerConnection=function(e,t){if("object"===r(e)&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){try{var i=e.RTCPeerConnection.prototype[t],o=a({},t,function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)});e.RTCPeerConnection.prototype[t]=o[t]}catch(e){}});var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=Array.prototype.slice.call(arguments),s=e[0],n=e[1],a=e[2];return o.apply(this,[s||null]).then(function(e){if(t.version<53&&!n)try{e.forEach(function(e){e.type=i[e.type]||e.type})}catch(t){if("TypeError"!==t.name)throw t;e.forEach(function(t,o){e.set(o,Object.assign({},t,{type:i[t.type]||t.type}))})}return e}).then(n,a)}}},i.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},i.shimReceiverGetStats=function(e){if("object"===r(e)&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,i=t.apply(this,[]);return i.forEach(function(t){return t._pc=e}),i}),l.wrapPeerConnectionEvent(e,"track",function(e){return e.receiver._pc=e.srcElement,e}),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},i.shimRemoveStream=function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;l.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(i){i.track&&e.getTracks().includes(i.track)&&t.removeTrack(i)})})},i.shimSenderGetStats=function(e){if("object"===r(e)&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,i=t.apply(this,[]);return i.forEach(function(t){return t._pc=e}),i});var i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}};var l=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==r(e)&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var s={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var l=n?Object.getOwnPropertyDescriptor(e,a):null;l&&(l.get||l.set)?Object.defineProperty(s,a,l):s[a]=e[a]}return s.default=e,i&&i.set(e,s),s}(e("../utils")),c=e("./getusermedia"),d=e("./getdisplaymedia")},{"../utils":11,"./getdisplaymedia":8,"./getusermedia":9}],8:[function(e,t,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){var o=new DOMException("getDisplayMedia without video constraints is undefined");return o.name="NotFoundError",o.code=8,Promise.reject(o)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}},{}],9:[function(e,t,i){"use strict";function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function s(e){"@babel/helpers - typeof";return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(i,"__esModule",{value:!0}),i.shimGetUserMedia=function(e,t){var i=e&&e.navigator,o=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,o){n.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,o)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){var a=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},r=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(e){return"object"===s(e)&&"object"===s(e.audio)&&(e=JSON.parse(JSON.stringify(e)),a(e.audio,"autoGainControl","mozAutoGainControl"),a(e.audio,"noiseSuppression","mozNoiseSuppression")),r(e)},o&&o.prototype.getSettings){var l=o.prototype.getSettings;o.prototype.getSettings=function(){var e=l.apply(this,arguments);return a(e,"mozAutoGainControl","autoGainControl"),a(e,"mozNoiseSuppression","noiseSuppression"),e}}if(o&&o.prototype.applyConstraints){var c=o.prototype.applyConstraints;o.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===s(e)&&(e=JSON.parse(JSON.stringify(e)),a(e,"autoGainControl","mozAutoGainControl"),a(e,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[e])}}}};var n=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==s(e)&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var l=a?Object.getOwnPropertyDescriptor(e,r):null;l&&(l.get||l.set)?Object.defineProperty(n,r,l):n[r]=e[r]}return n.default=e,i&&i.set(e,n),n}(e("../utils"))},{"../utils":11}],10:[function(e,t,i){"use strict";function o(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,i=new WeakMap;return(o=function(e){return e?i:t})(e)}function s(e){"@babel/helpers - typeof";return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e){return e&&void 0!==e.video?Object.assign({},e,{video:a.compactObject(e.video)}):e}Object.defineProperty(i,"__esModule",{value:!0}),i.shimAudioContext=function(e){"object"!==s(e)||e.AudioContext||(e.AudioContext=e.webkitAudioContext)},i.shimCallbacksAPI=function(e){if("object"===s(e)&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,i=t.createOffer,o=t.createAnswer,n=t.setLocalDescription,a=t.setRemoteDescription,r=t.addIceCandidate;t.createOffer=function(e,t){var o=arguments.length>=2?arguments[2]:arguments[0],s=i.apply(this,[o]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){var i=arguments.length>=2?arguments[2]:arguments[0],s=o.apply(this,[i]);return t?(s.then(e,t),Promise.resolve()):s};var l=function(e,t,i){var o=n.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o};t.setLocalDescription=l,l=function(e,t,i){var o=a.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o},t.setRemoteDescription=l,l=function(e,t,i){var o=r.apply(this,[e]);return i?(o.then(t,i),Promise.resolve()):o},t.addIceCandidate=l}},i.shimConstraints=n,i.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var i=this.getTransceivers().find(function(e){return"audio"===e.receiver.track.kind});!1===e.offerToReceiveAudio&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveAudio||i||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var o=this.getTransceivers().find(function(e){return"video"===e.receiver.track.kind});!1===e.offerToReceiveVideo&&o?"sendrecv"===o.direction?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":"recvonly"===o.direction&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):!0!==e.offerToReceiveVideo||o||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}},i.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var i=t.mediaDevices,o=i.getUserMedia.bind(i);t.mediaDevices.getUserMedia=function(e){return o(n(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,o){t.mediaDevices.getUserMedia(e).then(i,o)}.bind(t))},i.shimLocalStreamsAPI=function(e){if("object"===s(e)&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var i=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(function(o){return t.call(i,o,e)}),e.getVideoTracks().forEach(function(o){return t.call(i,o,e)})},e.RTCPeerConnection.prototype.addTrack=function(e){for(var i=this,o=arguments.length,s=new Array(o>1?o-1:0),n=1;n<o;n++)s[n-1]=arguments[n];return s&&s.forEach(function(e){i._localStreams?i._localStreams.includes(e)||i._localStreams.push(e):i._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var i=this._localStreams.indexOf(e);if(-1!==i){this._localStreams.splice(i,1);var o=e.getTracks();this.getSenders().forEach(function(e){o.includes(e.track)&&t.removeTrack(e)})}})}},i.shimRTCIceServerUrls=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){for(var o=[],s=0;s<e.iceServers.length;s++){var n=e.iceServers[s];void 0===n.urls&&n.url?(a.deprecated("RTCIceServer.url","RTCIceServer.urls"),(n=JSON.parse(JSON.stringify(n))).urls=n.url,delete n.url,o.push(n)):o.push(e.iceServers[s])}e.iceServers=o}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})}},i.shimRemoteStreamsAPI=function(e){if("object"===s(e)&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach(function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var i=new Event("addstream");i.stream=e,t.dispatchEvent(i)}})})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}})}),t.apply(e,arguments)}}},i.shimTrackEventTransceiver=function(e){"object"===s(e)&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})};var a=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==s(e)&&"function"!=typeof e)return{default:e};var i=o(t);if(i&&i.has(e))return i.get(e);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var r in e)if("default"!==r&&Object.prototype.hasOwnProperty.call(e,r)){var l=a?Object.getOwnPropertyDescriptor(e,r):null;l&&(l.get||l.set)?Object.defineProperty(n,r,l):n[r]=e[r]}return n.default=e,i&&i.set(e,n),n}(e("../utils"))},{"../utils":11}],11:[function(e,t,i){"use strict";function o(e,t,i){return(t=function(e){var t=function(e,t){if("object"!==s(e)||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var o=i.call(e,t||"default");if("object"!==s(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===s(t)?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function s(e){"@babel/helpers - typeof";return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t,i){var o=e.match(t);return o&&o.length>=i&&parseInt(o[i],10)}function a(e){return"[object Object]"===Object.prototype.toString.call(e)}function r(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach(function(o){o.endsWith("Id")?r(e,e.get(t[o]),i):o.endsWith("Ids")&&t[o].forEach(function(t){r(e,e.get(t),i)})}))}Object.defineProperty(i,"__esModule",{value:!0}),i.compactObject=function e(t){return a(t)?Object.keys(t).reduce(function(i,s){var n=a(t[s]),r=n?e(t[s]):t[s],l=n&&!Object.keys(r).length;return void 0===r||l?i:Object.assign(i,o({},s,r))},{}):t},i.deprecated=function(e,t){c&&console.warn(e+" is deprecated, please use "+t+" instead.")},i.detectBrowser=function(e){var t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;var i=e.navigator;if(i.mozGetUserMedia)t.browser="firefox",t.version=n(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=n(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=n(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t},i.disableLog=function(e){return"boolean"!=typeof e?new Error("Argument type: "+s(e)+". Please use a boolean."):(l=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},i.disableWarnings=function(e){return"boolean"!=typeof e?new Error("Argument type: "+s(e)+". Please use a boolean."):(c=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},i.extractVersion=n,i.filterStats=function(e,t,i){var o=i?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;var n=[];return e.forEach(function(e){"track"===e.type&&e.trackIdentifier===t.id&&n.push(e)}),n.forEach(function(t){e.forEach(function(i){i.type===o&&i.trackId===t.id&&r(e,i,s)})}),s},i.log=function(){if("object"===("undefined"==typeof window?"undefined":s(window))){if(l)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},i.walkStats=r,i.wrapPeerConnectionEvent=function(e,t,i){if(e.RTCPeerConnection){var o=e.RTCPeerConnection.prototype,s=o.addEventListener;o.addEventListener=function(e,o){if(e!==t)return s.apply(this,arguments);var n=function(e){var t=i(e);t&&(o.handleEvent?o.handleEvent(t):o(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(o,n),s.apply(this,[e,n])};var n=o.removeEventListener;o.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return n.apply(this,arguments);if(!this._eventMap[t].has(i))return n.apply(this,arguments);var o=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,n.apply(this,[e,o])},Object.defineProperty(o,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}};var l=!0,c=!0},{}],12:[function(e,t,i){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};s.localCName=s.generateIdentifier(),s.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},s.splitSections=function(e){return e.split("\nm=").map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},s.getDescription=function(e){var t=s.splitSections(e);return t&&t[0]},s.getMediaSections=function(e){var t=s.splitSections(e);return t.shift(),t},s.matchPrefix=function(e,t){return s.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},s.parseCandidate=function(e){for(var t=void 0,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},o=8;o<t.length;o+=2)switch(t[o]){case"raddr":i.relatedAddress=t[o+1];break;case"rport":i.relatedPort=parseInt(t[o+1],10);break;case"tcptype":i.tcpType=t[o+1];break;case"ufrag":i.ufrag=t[o+1],i.usernameFragment=t[o+1];break;default:void 0===i[t[o]]&&(i[t[o]]=t[o+1])}return i},s.writeCandidate=function(e){var t=[];t.push(e.foundation);var i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var o=e.type;return t.push("typ"),t.push(o),"host"!==o&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},s.parseIceOptions=function(e){return e.substring(14).split(" ")},s.parseRtpMap=function(e){var t=e.substring(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},s.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},s.parseExtmap=function(e){var t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},s.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},s.parseFmtp=function(e){for(var t={},i=void 0,o=e.substring(e.indexOf(" ")+1).split(";"),s=0;s<o.length;s++)t[(i=o[s].trim().split("="))[0].trim()]=i[1];return t},s.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var o=[];Object.keys(e.parameters).forEach(function(t){void 0!==e.parameters[t]?o.push(t+"="+e.parameters[t]):o.push(t)}),t+="a=fmtp:"+i+" "+o.join(";")+"\r\n"}return t},s.parseRtcpFb=function(e){var t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},s.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},s.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},o=e.indexOf(":",t);return o>-1?(i.attribute=e.substring(t+1,o),i.value=e.substring(o+1)):i.attribute=e.substring(t+1),i},s.parseSsrcGroup=function(e){var t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(function(e){return parseInt(e,10)})}},s.getMid=function(e){var t=s.matchPrefix(e,"a=mid:")[0];if(t)return t.substring(6)},s.parseFingerprint=function(e){var t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},s.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:s.matchPrefix(e+t,"a=fingerprint:").map(s.parseFingerprint)}},s.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),i},s.parseCryptoLine=function(e){var t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},s.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"===o(e.keyParams)?s.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},s.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},s.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},s.getCryptoParameters=function(e,t){return s.matchPrefix(e+t,"a=crypto:").map(s.parseCryptoLine)},s.getIceParameters=function(e,t){var i=s.matchPrefix(e+t,"a=ice-ufrag:")[0],o=s.matchPrefix(e+t,"a=ice-pwd:")[0];return i&&o?{usernameFragment:i.substring(12),password:o.substring(10)}:null},s.writeIceParameters=function(e){var t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},s.parseRtpParameters=function(e){var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=s.splitLines(e)[0].split(" ");t.profile=i[2];for(var o=3;o<i.length;o++){var n=i[o],a=s.matchPrefix(e,"a=rtpmap:"+n+" ")[0];if(a){var r=s.parseRtpMap(a),l=s.matchPrefix(e,"a=fmtp:"+n+" ");switch(r.parameters=l.length?s.parseFmtp(l[0]):{},r.rtcpFeedback=s.matchPrefix(e,"a=rtcp-fb:"+n+" ").map(s.parseRtcpFb),t.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(r.name.toUpperCase())}}}s.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(s.parseExtmap(e))});var c=s.matchPrefix(e,"a=rtcp-fb:* ").map(s.parseRtcpFb);return t.codecs.forEach(function(e){c.forEach(function(t){e.rtcpFeedback.find(function(e){return e.type===t.type&&e.parameter===t.parameter})||e.rtcpFeedback.push(t)})}),t},s.writeRtpDescription=function(e,t){var i="";i+="m="+e+" ",i+=t.codecs.length>0?"9":"0",i+=" "+(t.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){i+=s.writeRtpMap(e),i+=s.writeFmtp(e),i+=s.writeRtcpFb(e)});var o=0;return t.codecs.forEach(function(e){e.maxptime>o&&(o=e.maxptime)}),o>0&&(i+="a=maxptime:"+o+"\r\n"),t.headerExtensions&&t.headerExtensions.forEach(function(e){i+=s.writeExtmap(e)}),i},s.parseRtpEncodingParameters=function(e){var t=[],i=s.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),n=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=s.matchPrefix(e,"a=ssrc:").map(function(e){return s.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),r=a.length>0&&a[0].ssrc,l=void 0,c=s.matchPrefix(e,"a=ssrc-group:FID").map(function(e){return e.substring(17).split(" ").map(function(e){return parseInt(e,10)})});c.length>0&&c[0].length>1&&c[0][0]===r&&(l=c[0][1]),i.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:r,codecPayloadType:parseInt(e.parameters.apt,10)};r&&l&&(i.rtx={ssrc:l}),t.push(i),o&&((i=JSON.parse(JSON.stringify(i))).fec={ssrc:r,mechanism:n?"red+ulpfec":"red"},t.push(i))}}),0===t.length&&r&&t.push({ssrc:r});var d=s.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substring(5),10)*.95-16e3:void 0,t.forEach(function(e){e.maxBitrate=d})),t},s.parseRtcpParameters=function(e){var t={},i=s.matchPrefix(e,"a=ssrc:").map(function(e){return s.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];i&&(t.cname=i.value,t.ssrc=i.ssrc);var o=s.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=o.length>0,t.compound=0===o.length;var n=s.matchPrefix(e,"a=rtcp-mux");return t.mux=n.length>0,t},s.writeRtcpParameters=function(e){var t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},s.parseMsid=function(e){var t=void 0,i=s.matchPrefix(e,"a=msid:");if(1===i.length)return{stream:(t=i[0].substring(7).split(" "))[0],track:t[1]};var o=s.matchPrefix(e,"a=ssrc:").map(function(e){return s.parseSsrcMedia(e)}).filter(function(e){return"msid"===e.attribute});return o.length>0?{stream:(t=o[0].value.split(" "))[0],track:t[1]}:void 0},s.parseSctpDescription=function(e){var t=s.parseMLine(e),i=s.matchPrefix(e,"a=max-message-size:"),o=void 0;i.length>0&&(o=parseInt(i[0].substring(19),10)),isNaN(o)&&(o=65536);var n=s.matchPrefix(e,"a=sctp-port:");if(n.length>0)return{port:parseInt(n[0].substring(12),10),protocol:t.fmt,maxMessageSize:o};var a=s.matchPrefix(e,"a=sctpmap:");if(a.length>0){var r=a[0].substring(10).split(" ");return{port:parseInt(r[0],10),protocol:r[1],maxMessageSize:o}}},s.writeSctpDescription=function(e,t){var i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},s.generateSessionId=function(){return Math.random().toString().substr(2,22)},s.writeSessionBoilerplate=function(e,t,i){var o,n=void 0!==t?t:2;return o=e||s.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+o+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},s.getDirection=function(e,t){for(var i=s.splitLines(e),o=0;o<i.length;o++)switch(i[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[o].substring(2)}return t?s.getDirection(t):"sendrecv"},s.getKind=function(e){return s.splitLines(e)[0].split(" ")[0].substring(2)},s.isRejected=function(e){return"0"===e.split(" ",2)[1]},s.parseMLine=function(e){var t=s.splitLines(e)[0].substring(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},s.parseOLine=function(e){var t=s.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},s.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=s.splitLines(e),i=0;i<t.length;i++)if(t[i].length<2||"="!==t[i].charAt(1))return!1;return!0},"object"===(void 0===t?"undefined":o(t))&&(t.exports=s)},{}]},{},[1]);var live=function(e){function t(e,t,i){var o=e.match(t);return o&&o.length>=i&&parseInt(o[i],10)}var i=e._private=e._private||{},o=function(){var e={browser:null,version:null};if("undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(console.log("navigator.userAgent:"+navigator.userAgent),navigator.mozGetUserMedia)e.browser="firefox",e.version=t(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(void 0!=window.opr)e.browser="Opera";else if(navigator.userAgent.indexOf("UBrowser")>=0)e.browser="UCBrowser";else if(navigator.userAgent.indexOf("Edg")>=0)e.browser="Edge";else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=t(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=t(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=t(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e}(),s={};s.isFirefox="firefox"===o.browser,s.isChrome="chrome"===o.browser,s.isEdge="edge"===o.browser,s.isIE=!1,s.isSafari=!1,s.version=o.version,s.supportSessionStorage=!1;try{s.supportSessionStorage="sessionStorage"in window&&null!=window.sessionStorage}catch(e){}return(-1!==navigator.userAgent.indexOf("MSIE")?/MSIE (\d+\.\d+);/:/Trident.*rv[ :]*(\d+\.\d+)/).test(navigator.userAgent)&&(s.isIE=!0,s.version=Number(RegExp.$1)),"undefined"==typeof Android&&navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)&&(s.isSafari=!0),-1===navigator.userAgent.indexOf("OPR")||s.isChrome||s.isFirefox||s.isEdge||s.isSafari||(s.isOpera=!0),i.browser=s,e}(live||{}),live=function(e){"use strict";var t={LOGLEVEL:{DEBUG:2,INFO:4,WARN:6,ERROR:8,OFF:10},SESSIONSTATE:{NONE:"NONE",CONNECTED:"CONNECTED",RECONNECTING:"RECONNECTING",RELOADING:"RELOADING",HIBERNATED:"HIBERNATED",SUSPENDED:"SUSPENDED",FAILED:"FAILED",CLOSED:"CLOSED"},CALLSTATE:{NONE:"NONE",STARTED:"STARTED",RESPONDED:"RESPONDED",ESTABLISHED:"ESTABLISHED",UPDATING:"UPDATING",UPDATE_FAILED:"UPDATE_FAILED",UPDATED:"UPDATED",FAILED:"FAILED",ERROR:"ERROR",ENDED:"ENDED"},MEDIASTREAMEVENT:{LOCAL_STREAM_ADDED:"LOCAL_STREAM_ADDED",LOCAL_STREAM_REMOVED:"LOCAL_STREAM_REMOVED",LOCAL_STREAM_ERROR:"LOCAL_STREAM_ERROR",REMOTE_STREAM_ADDED:"REMOTE_STREAM_ADDED",REMOTE_STREAM_REMOVED:"REMOTE_STREAM_REMOVED",REMOTE_STREAM_ERROR:"REMOTE_STREAM_ERROR"},MEDIADIRECTION:{SENDONLY:"sendonly",RECVONLY:"recvonly",SENDRECV:"sendrecv",NONE:"inactive",INACTIVE:"inactive"},ERRORCODE:{UNAUTHORIZED:401,FORBIDDEN:403,RESOURCE_UNAVAILABLE:404,PROXYAUTH_REQUIRED:407,TEMPORARILY_UNAVAILABLE:480,BUSY_HERE:486,REQUEST_TERMINATED:487,SYSTEM_ERROR:500,BUSY_EVERYWHERE:600,DECLINED:603,WEBSOCKET_ERROR:1001,PEERCONNECTION_ERROR:1101,SET_LOCAL_SDP_ERROR:1102,SET_REMOTE_SDP_ERROR:1103,GENERATE_SDP_ERROR:1104,MEDIA_ERROR:1201,GET_USER_MEDIA_ERROR:1202,RESTORE_FAILED:1301,SAVE_FAILED:1302,SIGNALING_ERROR:1401,ICE_CONNECTION_ERROR:1501},PROTOCOL:{HOST:"HOST",STUN:"STUN",TURN:"TURN"},LOGTYPE:{EVENT_LOG:"event",ERROR_LOG:"error"},EVENTLOG:{CALL_START:"call starts",CALL_END:"call ends",CALL_UPDATE:"call updates",ESTABLISH_PEER_CONNECTION_START:"establishing peer connection starts",ESTABLISH_PEER_CONNECTION_END:"establishing peer connection ends",PEER_CONNECTION_CREATE_OFFER:"peer connection creates offer",PEER_CONNECTION_CREATE_ANSWER:"peer connection creates answer",NETWORK_SWITCHED:"network switched",GET_USER_MEDIA:"succeed to get user media",ON_ICE_CANDIDATE:"onicecandidate",ON_ADD_STREAM:"onaddstream",ON_REMOVE_STREAM:"onremovestream",ON_SIGNALING_STATE_CHANGE:"onsignalingstatechange",ON_ICE_CONNECTION_STATE_CHANGE:"oniceconnectionstatechange",ON_NEGOTIATION_NEEDED:"onnegotiationneeded",ON_DATA_CHANNEL:"ondatachannel",ON_ICE_GATHERING_STATE_CHANGE:"onicegatheringstatechange"},ERRORLOG:{ERROR_FROM_SERVER:"receive error responded from server",GET_USER_MEDIA_ERROR:"failed to get access to local media",GENERATE_SDP_ERROR:"failed to generate SDP",ICE_CONNECTION_ERROR:"ice connection failed",SET_REMOTE_SDP_ERROR:"failed to set remote SDP"},AUTHTYPE:{SERVICE:"SERVICE",TURN:"TURN"},ConnectionStateEnum:{INIT:"init",ESTABLISHED:"established",ERROR:"error",CLOSED:"closed"},PACKAGE:{ALL:"all",REGISTER:"register",CALL:"call",CONVERSATION:"conversation",MESSAGE_NOTIFICATION:"message_notification",MESSAGING:"messaging",CAPABILITY:"capability",CHAT:"chat",FILE_TRANSFER:"file_transfer"},CONSTCS:{SERVER:"s",CLIENT:"c"},RESUME_STATE:{waittingFinalResp:"waittingFinalResp",reStartingCall:"reStartingCall",updateCallByIceFailure:"updateCallByIceFailure"},OFFER_ANSWER_STATE:{INITIAL:"Initial state",OFFER_SENT:"Offer sent",OFFER_GOT:"Offer received",OFFER_REJECTED:"My offer was rejected by the other peer",OFFER_REJECT:"I Rejected the other peer's offer",ANSWER_SENT:"Answer sent",ANSWER_GOT:"Answer received",ACK_SENT:"Ack sent",ACK_GOT:"Ack received",GLARE:"Glare state"},TYPE:{REQUEST:"request",ACK:"acknowledgement",RESPONSE:"response",MESSAGE:"message",ERROR:"error"},ACTION:{CONNECT:"connect",START:"start",SHUTDOWN:"shutdown",COMPLETE:"complete",NOTIFY:"notify",RELAY:"relay",RELIABLE_RELAY:"reliableRelay",TRICKLE:"trickle",PRACK:"prack",ENQUIRY:"enquiry",MODIFY:"modify",HIBERNATE:"hibernate",ICE_ENQUIRY:"iceEnquiry",RELAY_FAILED:"relayFailed",AUDIT:"audit",SUBSCRIBE:"subscribe"},MESSAGESTATE:{INITIAL:"initial",SUBSEQUENT:"subsequent",FINAL:"final"},CONVERSATION:{ADD_STREAM:"add_stream",REMOVE_STREAM:"remove_stream",BEGIN_RECORD:"begin_record",END_RECORD:"end_record",LIST_PARTICIPANTS:"list_participants",STREAM_OPTIONS:"media_direction",STREAM_LAYOUT:"video_layout",RECORDING_RULES:"recording_rules",PAUSE_RESUME_STREAM:"pause_resume_stream",UPDATE_PROFILE:"update_profile",CANCEL:"cancel",CREATE_SIDEBAR:"create_sidebar",REMOTE_ADD_STREAM:"remote_add_stream",ANNOTATE_CUSTOMER_STREAM:"annotate_customer_stream"},CONVERSATIONSTATE:{STREAM_ADDED:"stream_added",STREAM_REMOVED:"stream_removed",STREAM_REJECTED:"stream_rejected",STREAM_JOINED:"stream_joined",STREAM_STARTED:"stream_started",STREAM_LEFT:"stream_left",STREAM_CHANGED:"stream_changed",STREAM_ACTIVE:"stream_active",RECORDING_STARTED:"recording_started",RECORDING_ENDED:"recording_ended",PROFILE_UPDATED:"profile_updated",SIDEBAR_CREATED:"sidebar_created"},STREAMTYPE:{AUDIOVIDEO:"audiovideo",SCREENSHARE:"screenshare",ANNOTATION:"annotation"},STREAMSIZE:{MAX:"maximize",MIN:"minimize",PRIMARY:"primary",NORMAL:"normal"},RELAYTYPE:{COMMAND:"command",TEXT:"text",DATA:"data"},RELAYSTATUS:{ACCEPTED:"accepted",DECLINED:"declined"},PAUSERESUME:{PAUSE:"pause",RESUME:"resume"},PAUSERESUMEREASON:{PAUSE_RESUME:"pause_resume",UPGRADE_DOWNGRADE:"upgrade_downgrade"},ICE_CHECK_PERIOD:2e3,PROTOCOL_VERSION:"4.0",ExperienceFactor:{VIDEO_INBOUND:"video_inbound",VIDEO_OUTBOUND:"video_outbound",AUDIO_INBOUND:"audio_inbound",AUDIO_OUTBOUND:"audio_outbound"},ExperienceStatus:{GOOD:2,BAD:1,NOT_AVAILABLE:0}};return(e._private=e._private||{}).wscConst=t,e.MEDIADIRECTION=t.MEDIADIRECTION,e.SESSIONSTATE=t.SESSIONSTATE,e.CONNECTIONSTATE=t.SESSIONSTATE,e.CALLSTATE=t.CALLSTATE,e.STREAMSTATE=t.CALLSTATE,e.MEDIASTREAMEVENT=t.MEDIASTREAMEVENT,e.ERRORCODE=t.ERRORCODE,e.AUTHTYPE=t.AUTHTYPE,e.ConnectionStateEnum=t.ConnectionStateEnum,e.LOGLEVEL=t.LOGLEVEL,e.MSSAGETYPE=t.TYPE,e.ACTION=t.ACTION,e.CONVERSATION=t.CONVERSATION,e.CONVERSATIONSTATE=t.CONVERSATIONSTATE,e.STREAMTYPE=t.STREAMTYPE,e.STREAMSIZE=t.STREAMSIZE,e.RELAYTYPE=t.RELAYTYPE,e.RELAYSTATUS=t.RELAYSTATUS,e.PAUSERESUME=t.PAUSERESUME,e.PAUSERESUMEREASON=t.PAUSERESUMEREASON,e.ExperienceFactor=t.ExperienceFactor,e.ExperienceStatus=t.ExperienceStatus,e}(live||{}),live=function(e){var t=e._private=e._private||{},i=t.wscUtils=t.wscUtils||{};return i.Map=function(){"use strict";this.mapSize=0,this.entry={}},i.Map.prototype={put:function(e,t){this.containsKey(e)||(this.mapSize=this.mapSize+1),this.entry[e]=t},get:function(e){var t=null;return this.containsKey(e)&&(t=this.entry[e]),t},remove:function(e){var t=!1;return this.containsKey(e)&&delete this.entry[e]&&(t=!0,this.mapSize=this.mapSize-1),t},clear:function(){for(var e in this.entry)delete this.entry[e];this.mapSize=0},containsKey:function(e){var t=!1;return e in this.entry&&(t=!0),t},containsValue:function(e){for(var t in this.entry)if(this.entry[t]===e)return!0;return!1},values:function(){var e=[];for(var t in this.entry)this.entry.hasOwnProperty(t)&&e.push(this.entry[t]);return e},keys:function(){var e=[];for(var t in this.entry)e.push(t);return e},size:function(){return this.mapSize}},i.Queue=function(){var e=[],t=0;this.toJSON=function(){return{array:e,offset:t}},this.length=function(){return e.length-t},this.enqueue=function(t){e.push(t)},this.dequeue=function(){if(0===e.length)return null;var i=e[t];return 2*++t>=e.length&&(e=e.slice(t),t=0),i},this.peek=function(){return e.length>0?e[t]:null}},e.Map=i.Map,e}(live||{}),live=function(e){var t=e._private=e._private||{},i=t.wscUtils=t.wscUtils||{},o=t.wscConst,s=console,n=null,a=o.LOGLEVEL.WARN;return i.setLogger=function(e){s=e,i.AspectConfig.aspectClassMap.clear(),i.initAspectConfig()},i.getLogger=function(){return n},i.setLogLevel=function(e){a=e},i.getLogLevel=function(){return a},i.setsessionid=function(e){e},i.printTimeStr=function(e){var t=new Date;return(e?t.getDateStr(e):t.getDateStr())+" "},Date.prototype.getDateStr=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var i in e||(e="yyyy-MM-dd hh:mm:ss"),/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e},i.waveFunc=function(e,t){if(t){if(t.prototype){var o=function(){};o.prototype=t.prototype;var s=e.prototype;e.prototype=new o,s&&i.deepCopy(s,e.prototype),e.prototype.constructor=e}if(t.prototype)e.superclass=t.prototype,e.superclass.constructor=t;else{for(var n in t)e[n]="object"==typeof t&&"error"!=n&&"warn"!=n&&"log"!=n&&"info"!=n&&"debug"!=n?function(e){return function(){t[e](arguments[0])}}(n):t[n];e.superclass=t,e.prototype=void 0}}},i.AspectConfig={},i.getCaller_line=function(){var e=null;try{(e=(new Error).stack.split("\n")[4]).indexOf("Error")>=0&&(e=null)}catch(e){}return e},i.isDebugEnabled=function(){var e=!1;if(a===o.LOGLEVEL.DEBUG&&(e=!0),e&&s){var t=i.getCaller_line();if((t=t?"Debug line:"+t:"Debug:").indexOf("tmpProxyClass")>0)return!0;s.debug(i.printTimeStr()+"[wsc "+t+"]")}return e},i.isInfoEnabled=function(){var e=!1;return a<=o.LOGLEVEL.INFO&&(e=!0),e&&s&&s.info(i.printTimeStr()+"[wsc Info]:"),e},i.isWarnEnabled=function(){var e=!1;if(a<=o.LOGLEVEL.WARN&&(e=!0),e&&s){var t=i.getCaller_line();if((t=t?"Warn line:"+t:"Warn:").indexOf("tmpProxyClass")>0)return!0;s.warn(i.printTimeStr()+"[wsc "+t+"]")}return e},i.isErrorEnabled=function(){var e=!1;if(a<=o.LOGLEVEL.ERROR&&(e=!0),e&&s){var t=null;if((t=(t=i.getCaller_line())?"Error line:"+t:"Error:").indexOf("tmpProxyClass")>0)return!0}return e},i.AspectConfig.aspectClassMap=new i.Map,o.WAVETYPE={BEFORE:"before",AFTER:"after",AFTERRETURN:"afterReturn",AFTERTHROW:"afterThrow"},i.AspectConfig.wavePointcut=function(e,t,a,r){var l,c,d=i.AspectConfig.aspectClassMap.get(e);null==d?(d=function(){d.superclass&&d.superclass.prototype&&d.superclass.constructor.apply(this,arguments)},i.waveFunc(d,e),c=d):(l=function(){l.superclass&&l.superclass.prototype&&l.superclass.constructor.apply(this,arguments)},i.waveFunc(l,d),c=l);var u,h=t.indexOf("*"),g=!1;h>=0&&(u=h>0?new RegExp("^"+t.substr(0,h)):new RegExp(t.substr(1)+"$"));var m=function(i){var o=null,s=c;n.superclass&&(s=n.superclass);try{for(;s.superclass;)s=s.superclass;o=s[t]?s[t].apply(s,i):e[t].apply(e,i)}catch(e){n.warn(e)}return o};if(e.prototype){if(e.prototype[t]){switch(r){case o.WAVETYPE.BEFORE:c.prototype[t]=function(){var e=!1,i=null;try{e=a(arguments)}catch(e){throw e}if(e&&(null!==(i=c.superclass[t].apply(this,arguments))&&void 0!==i))return i};break;case o.WAVETYPE.AFTER:c.prototype[t]=function(){var e=null;try{e=c.superclass[t].apply(this,arguments)}catch(e){throw s.error(t+" exception:"+e),e}if(a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERRETURN:c.prototype[t]=function(){var e;if(e=c.superclass[t].apply(this,arguments),a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERTHROW:c.prototype[t]=function(){var e=null;try{if(null!==(e=c.superclass[t].apply(this,arguments))&&void 0!==e)return e}catch(e){a(t,e)}}}g=!0}else if(h>=0)for(var p in e.prototype)if(u.test(p)){switch(r){case o.WAVETYPE.BEFORE:c.prototype[p]=function(){var e=!1,t=null;try{e=a(arguments)}catch(e){throw e}if(e&&(null!==(t=c.superclass[p].apply(this,arguments))&&void 0!==t))return t};break;case o.WAVETYPE.AFTER:c.prototype[p]=function(){var e=null;try{e=c.superclass[p].apply(this,arguments)}catch(e){throw s.error(p+" exception:"+e),e}if(a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERRETURN:c.prototype[p]=function(){var e;if(e=c.superclass[p].apply(this,arguments),a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERTHROW:c.prototype[p]=function(){var e=null;try{if(null!==(e=c.superclass[p].apply(this,arguments))&&void 0!==e)return e}catch(e){a(p,e)}}}g=!0}}else if(e[t]){switch(r){case o.WAVETYPE.BEFORE:c[t]=function(){if(a(arguments)){var e=m(arguments);if(null!==e&&void 0!==e)return e}};break;case o.WAVETYPE.AFTER:c[t]=function(){try{var e=m(arguments)}catch(e){s.error(t+" exception:"+e)}if(a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERRETURN:c[t]=function(){var e=m(arguments);if(a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERTHROW:c[t]=function(){try{var e=m(arguments);if(null!==e&&void 0!==e)return e}catch(e){a(t,e)}}}g=!0}else if(h>=0)for(var p in e)if(u.test(p)){switch(r){case o.WAVETYPE.BEFORE:c[p]=function(){if(a(arguments)){var e=m(arguments);if(null!==e&&void 0!==e)return e}};break;case o.WAVETYPE.AFTER:c[p]=function(){try{var e=m(arguments);if(null!==e&&void 0!==e)return e}catch(e){s.error(p+" exception:"+e)}return a(arguments),e};break;case o.WAVETYPE.AFTERRETURN:c[p]=function(){var e=m(arguments);if(a(arguments),null!==e&&void 0!==e)return e};break;case o.WAVETYPE.AFTERTHROW:c[p]=function(){try{var e=m(arguments);if(null!==e&&void 0!==e)return e}catch(e){a(p,e)}}}g=!0}g&&i.AspectConfig.aspectClassMap.put(e,c)},i.AspectConfig.before=function(e,t,s){i.AspectConfig.wavePointcut(e,t,s,o.WAVETYPE.BEFORE)},i.AspectConfig.after=function(e,t,s){i.AspectConfig.wavePointcut(e,t,s,o.WAVETYPE.AFTER)},i.AspectConfig.afterReturn=function(e,t,s){i.AspectConfig.wavePointcut(e,t,s,o.WAVETYPE.AFTERRETURN)},i.AspectConfig.afterThrow=function(e,t,s){i.AspectConfig.wavePointcut(e,t,s,o.WAVETYPE.AFTERTHROW)},i.AspectConfig.getWavedObject=function(e){var t=i.AspectConfig.aspectClassMap.get(e);return t||(t=e),new t},i.AspectConfig.getWavedClass=function(e){var t=i.AspectConfig.aspectClassMap.get(e);return t||(t=e),t},i.initAspectConfig=function(){s?(i.AspectConfig.before(s,"info",i.isInfoEnabled),i.AspectConfig.before(s,"debug",i.isDebugEnabled),i.AspectConfig.before(s,"warn",i.isWarnEnabled),i.AspectConfig.before(s,"error",i.isErrorEnabled),i.AspectConfig.before(s,"log",i.isInfoEnabled),n=i.AspectConfig.getWavedClass(s)):n=s={},n.info||(n.info=function(){},s.info=function(){}),n.debug||(n.debug=function(){},s.debug=function(){}),n.warn||(n.warn=function(){},s.warn=function(){}),n.error||(n.error=function(){},s.error=function(){}),n.log||(n.log=function(){},s.log=function(){})},i.initAspectConfig(),e.setLogLevel=i.setLogLevel,e.getLogLevel=i.getLogLevel,e.setLogger=i.setLogger,e.getLogger=i.getLogger,e}(live||{}),live=function(e){function t(e){var t=!1;if(void 0===g)return Promise.reject("Audio context is not supported.");return navigator.mediaDevices.enumerateDevices().then(function(i){var o=[],s=[];return i.forEach(function(t){t.kind===e&&o.push(t)}),u.debug("We have audio sources (for "+e+") as follows:",o),0===o.length?Promise.resolve({available:!1,details:s}):m(o,function(e){return new function(e){this.sourceInfo=e;var t,i,o={},s=null,n=null,a=[],r=0,l=this;for(i=6;i--;)a[i]=[];this.test=function(){return o.sourceId=this.sourceInfo.deviceId,o.label=this.sourceInfo.label,new Promise(function(e,i){l.resolve=e,l.reject=i;var a={audio:{optional:[{echoCancellation:!1},{sourceId:l.sourceInfo.deviceId}]}};u.debug("Calling getUserMedia with constraints",a),navigator.mediaDevices.getUserMedia(a).then(function(i){if(t=i,"undefined"!=typeof RTCRtpReceiver&&i instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&i instanceof RTCRtpSender){if(!i.track||i.track&&"video"===i.track.kind)return u.warn("There is not audio track in the stream."),o.available=!1,void e(o);i.track&&"audio"===i.track.kind&&(o.label=i.track.label)}else{if(i.getAudioTracks().length<1)return u.warn("There is not audio track in the stream."),o.available=!1,void e(o);var a=i.getAudioTracks();a.length>0&&(o.label=a[0].label)}s=g.createMediaStreamSource(i),n=g.createScriptProcessor(0,6,2),s&&n?(s.connect(n),n.connect(g.destination),n.onaudioprocess=c):(u.warn("AudioStreamSource or ScriptProcessor is invalid."),o.available=!1,e(o))}).catch(i)})};var c=function(e){var c,h,m,p=e.inputBuffer.length,v=e.inputBuffer.numberOfChannels,S=e.inputBuffer.sampleRate;for(c=0;c<v;c++)h=e.inputBuffer.getChannelData(c),(m=new Float32Array(p)).set(h),a[c].push(m);if((r+=p)/S>=2){if("undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender)t.track&&"audio"===t.track.kind&&t.track.stop();else{var _=t.getAudioTracks();for(i=_.length;i--;)_[i].stop()}if(s&&n){u.debug("Try to disconnect the audio node");try{s.disconnect(n)}catch(e){u.debug("Failed to disconnect audio node",e)}try{n.disconnect(g.destination)}catch(e){u.debug("Failed to disconnect audio node",e)}}d(a),l.resolve(o)}},d=function(e){var t=[];if(e.forEach(function(e,i){h(e)&&t.push(i)}),t.length>0?(o.available=!0,u.debug(t.length+" active audio channels are found")):(o.available=!1,u.warn("Can not detect any active channels. Please check if audio device is valid.")),o.channelNumber=t.length,2===t.length){for(var i=e[t[0]],s=e[t[1]],n=0,a=i.length;n<a;n++){var r=i[n],l=s[n];if(r.length!==l.length)return o.isStereo=!0,void u.info("Audio device might be stereo.");for(var c=0;c<r.length;c++)if(Math.abs(r[c]-l[c])>1/65536)return o.isStereo=!0,void u.info("Audio device might be stereo.")}o.isStereo=!1,u.info("Audio device might be mono.")}},h=function(e){for(var t=0,i=e.length;t<i;t++){var o=e[t];if(o.length>0)for(var s=0,n=0;n<o.length;n++)if(Math.abs(o[n])>1/32767){if((s+=1)>10)return!0}else s=0}return!1}}(e).test().then(function(e){return s.push(e),{available:t=t||e.available,details:s}})}).catch(function(e){return u.debug(e),Promise.resolve({available:!1,details:[]})})}).catch(function(e){return u.debug("Device selection is not supported",e),Promise.resolve({available:!1,details:[]})})}function i(e,t,i,o){this.turnURI=e,this.username=t,this.password=i,this.protocol=o,this.test=function(){if(!this.turnURI||!this.username||!this.password)return Promise.reject("TURN URI, username and password are required");if("string"!=typeof this.turnURI||"string"!=typeof this.username||"string"!=typeof this.password)return Promise.reject("TURN URI, username and password must be string type");var e={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};s(e,o);var t={iceServers:[e]};return new Promise(function(e,i){var o;try{var s={};u.debug("Constraints used for peerConnection: "+JSON.stringify(s)),o=new RTCPeerConnection(t,s)}catch(t){return u.error("Fail to create peer connection: "+t),void e(!1)}o.onicecandidate=function(t){{if("closed"!==o.signalingState)return t.candidate?"relay"===p(t.candidate.candidate).type?(u.info("Got a relay candidate",t.candidate),o.close(),void e(!0)):void u.debug("Got a non-relay candidate",t.candidate):(o.close(),u.warn("No relay candidate is got before end of candidates"),void e(!1));e(!1)}},o.addTransceiver("audio"),o.createOffer().then(function(e){u.debug("got offer: ",e),o.setLocalDescription(e).then(function(){console.log("Local description set successfully")}).catch(function(e){console.log("Setting local description failed",e)})}).catch(function(e){console.log("Create offer failed with reason ",e)})})};var s=function(e,t){for(var i="transport="+t,o=[],s=0;s<e.urls.length;s++){var n=e.urls[s];-1!==n.indexOf(i)?o.push(n):-1===n.indexOf("?transport=")&&"turn"===n.slice(0,4)&&o.push(n+"?"+i)}e.urls=o}}function o(e,t,i){this.turnURI=e,this.username=t,this.password=i,this.testResult={}}function s(e,t,i){void 0!==g&&void 0!==g.createScriptProcessor||i&&i("Audio context is not supported.");var o=function(e){var i,o={available:!1,details:[]};0==(i=e.filter(function(e){return"audioinput"===e.kind})).length&&t(o);var s=function(e,i,o){this.available=this.available||o.available,this.details.push(o),e&&i?e.test(i):t(this)},n=i.map(function(e){return new function(e){this.sourceInfo=e;var t,i,o,s,n={},a=[],r=0;for(i=6;i--;)a[i]=[];this.test=function(e){n.sourceId=this.sourceInfo.deviceId,n.label=this.sourceInfo.label;var i={audio:{optional:[{echoCancellation:!1},{sourceId:this.sourceInfo.deviceId}]}};u.debug("Calling getUserMedia with constraints",i),h(i).then(function(i){if(t=i,"undefined"!=typeof RTCRtpReceiver&&i instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&i instanceof RTCRtpSender){if(!i.track||i.track&&"video"===i.track.kind)return u.warn("There is not audio track in the stream."),n.available=!1,void e(n)}else if(i.getAudioTracks().length<1)return u.warn("There is not audio track in the stream."),n.available=!1,void e(n);return o=g.createMediaStreamSource(i),s=g.createScriptProcessor(0,6,2),o&&s?(o.connect(s),s.connect(g.destination),void(s.onaudioprocess=l.bind(null,e))):(u.warn("AudioStreamSource or ScriptProcessor is invalid."),n.available=!1,void e(n))}).catch(function(){n.available=!1,e(n)})};var l=function(e,l){var d,u,h,m=l.inputBuffer.length,p=l.inputBuffer.numberOfChannels,v=l.inputBuffer.sampleRate;for(d=0;d<p;d++)u=l.inputBuffer.getChannelData(d),(h=new Float32Array(m)).set(u),a[d].push(h);if((r+=m)/v>=2){if("undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender)t.track&&"audio"===t.track.kind&&t.track.stop();else{var S=t.getAudioTracks();for(i=S.length;i--;)S[i].stop()}o.disconnect(s),s.disconnect(g.destination),c(a),e(n)}},c=function(e){var t=[];if(e.forEach(function(e,i){d(e)&&t.push(i)}),t.length>0?(n.available=!0,u.debug(t.length+" active audio input channels are found")):(n.available=!1,u.warn("Can not detect any active input channels. Please check if microphone is valid.")),n.channelNumber=t.length,2===t.length){for(var i=e[t[0]],o=e[t[1]],s=0,a=i.length;s<a;s++){var r=i[s],l=o[s];if(r.length!==l.length)return n.isStereo=!0,void u.info("Audio device might be stereo.");for(var c=0;c<r.length;c++)if(Math.abs(r[c]-l[c])>1/65536)return n.isStereo=!0,void u.info("Audio device might be stereo.")}n.isStereo=!1,u.info("Audio device might be mono.")}},d=function(e){for(var t=0,i=e.length;t<i;t++){var o=e[t];if(o.length>0)for(var s=0,n=0;n<o.length;n++)if(Math.abs(o[n])>1/32767){if((s+=1)>10)return!0}else s=0}return!1}}(e)}),a=n.shift(),r=n.reverse().reduce(function(e,t){return s.bind(o,t,e)},s.bind(o,null,null));a.test(r)};void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(o).catch(function(e){u.debug("Device selection is not supported",e),t&&t({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&void 0!==MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(e){o(e.map(function(e){return{label:e.label,kind:kinds[e.kind],deviceId:e.id,groupId:""}}))}):i("Devices cannot be enumerated.")}function n(e,t,i,o){this.turnURI=e,this.username=t,this.password=i,this.protocol=o;var s=function(e){u.debug("dumbFunc: ",e)};this.test=function(e){var t={username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")};n(t,o);var i,a={iceServers:[t]};try{var r={};u.debug("Constraints used for peerConnection: "+JSON.stringify(r)),i=new RTCPeerConnection(a,r)}catch(t){return u.error("Fail to create peer connection: "+t),void e(!1)}i.onicecandidate=function(t){{if("closed"!==i.signalingState)return t.candidate?"relay"===p(t.candidate.candidate).type?(u.info("Got a relay candidate",t.candidate),i.close(),void e(!0)):void u.debug("Got a non-relay candidate",t.candidate):(i.close(),u.warn("No relay candidate is got before end of candidates"),void e(!1));e(!1)}};i.createOffer(function(e){u.debug("got offer: ",e),i.setLocalDescription(e,s,s)},s,{offerToReceiveAudio:1})};var n=function(e,t){for(var i="transport="+t,o=[],s=0;s<e.urls.length;s++){var n=e.urls[s];-1!==n.indexOf(i)?o.push(n):-1===n.indexOf("?transport=")&&"turn"===n.slice(0,4)&&o.push(n+"?"+i)}e.urls=o}}function a(e,t,i){this.turnURI=e,this.username=t,this.password=i,this.testResult={}}function r(e,t,i){var o={};u.debug("Constraints used for peerConnection: "+JSON.stringify(o)),u.debug("Config used for peerConnection: "+JSON.stringify(e,null,2)),this.pc1=new RTCPeerConnection(e,o),this.pc2=new RTCPeerConnection(e,o);var s,n=this.pc1,a=this.pc2,r=!1,l=!1,c=this,d=function(e,i){e.candidate?"relay"===p(e.candidate.candidate).type&&(i.addIceCandidate(e.candidate),l=!0):l||t(c,"No relay candidate is got before end of candidates")};n.onicecandidate=function(e){d(e,a)},a.onicecandidate=function(e){d(e,n)};var h=function(e){u.debug("offer answer",e),t(c,e)},g=function(e){return e.replace(/a=candidate:[^\r]*\r\n/g,"").replace(/a=end-of-candidates\r\n/g,"")};const m=function(e){if(r&&(e.sdp=e.sdp.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+s+"\r\n")),i){var t=e.sdp;e.sdp=g(t)}a.setLocalDescription(e).then(function(){n.setRemoteDescription(e).then(function(){}).catch(h)}).catch(h)},v=function(e){r&&(t=(t=(t=(t=(t=(t=e.sdp).replace(/(m=video 1 [^\r]+) 116 117\r\n/g,function(e,t){return t.trim()+"\r\n"})).split(/a=rtpmap:116 red\/90000\r\n/g).join("")).split(/a=rtpmap:117 ulpfec\/90000\r\n/g).join("")).split(/a=rtpmap:98 rtx\/90000\r\n/g).join("")).split(/a=fmtp:98 apt=116\r\n/g).join(""),e.sdp=t);if(i){var t=e.sdp;e.sdp=g(t)}n.setLocalDescription(e).then(function(){a.setRemoteDescription(e).then(function(){a.createAnswer().then(m).catch(h)}).catch(h)}).catch(h)};this.start=function(){n.createOffer().then(v).catch(h)},this.end=function(){"closed"!=this.pc1.signalingState&&this.pc1.close(),"closed"!=this.pc2.signalingState&&this.pc2.close()},this.setMaxVideoBitRate=function(e){s=e},this.disableVideoFec=function(){r=!0}}var l=e._private=e._private||{},c=l.wscUtils=l.wscUtils||{},d=l.wscConst,u=e.getLogger(),h=navigator.getUserMedia;navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia&&(h=navigator.mediaDevices.getUserMedia);try{var g=new(window.AudioContext||window.webkitAudioContext)}catch(e){u.debug("Failed to instantiate an audio context, error: "+e)}window.msCrypto&&(window.crypto=window.msCrypto),"function"!=typeof Array.prototype.find&&(Array.prototype.find=function(e){"use strict";if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,i=Object(this),o=i.length>>>0,s=arguments[1],n=0;n<o;n++)if(t=i[n],e.call(s,t,n,i))return t});var m=function(e,t){return e.reduce(function(e,i){return e.then(function(){return t(i)})},Promise.resolve())},p=function(e){var t=e.split(/\s+/);return t.length>7?{type:t[7],protocol:t[2],address:t[4]}:{}},v=[{label:"720p",width:1280,height:720,ratio:"16:9"},{label:"SVGA",width:800,height:600,ratio:"4:3"},{label:"VGA",width:640,height:480,ratio:"4:3"},{label:"360p",width:640,height:360,ratio:"16:9"}];if(c.Message=function(e){"use strict";if(this.control={type:void 0,package_type:void 0,session_id:void 0,subsession_id:void 0,sequence:void 0,message_state:void 0,correlation_id:void 0,ack_sequence:void 0,version:void 0},this.header={action:void 0,initiator:void 0,target:void 0,error_code:void 0,reason:void 0,participant:void 0,conversation_key:void 0,instruction:void 0,conversation_topic:void 0,recording_channel:void 0,web_context:void 0,conversation_info:void 0,stream_id:void 0,stream_type:void 0},this.payload={},e)for(var t in"string"==typeof e&&(e=JSON.parse(e)),e)e.hasOwnProperty(t)&&(this[t]=e[t])},c.Message.systemHeaders={action:"action",initiator:"initiator",target:"target",cslr:"cslr",cslw:"cslw",csuw:"csuw",sslr:"sslr",error_code:"error_code",response_code:"response_code",reason:"reason",participant:"participant",enquiry_data:"enquiry_data",authorization:"authorization",authenticate:"authenticate",expiry:"expiry",participants:"participants",conversation_key:"conversation_key",instruction:"instruction",conversation_topic:"conversation_topic",recording_channel:"recording_channel",web_context:"web_context",conversation_info:"conversation_info",stream_id:"stream_id",stream_type:"stream_type"},c.Message.prototype={isRequest:function(){return this.control.type===d.TYPE.REQUEST},isResponse:function(){return this.control.type===d.TYPE.RESPONSE},isEnquiry:function(){return this.header.action===d.ACTION.ENQUIRY},isModify:function(){return this.header.action===d.ACTION.MODIFY},isFinalResponse:function(){var e=this.control.type,t=this.control.message_state;return e===d.TYPE.RESPONSE&&t===d.MESSAGESTATE.FINAL},isError:function(){return this.control.type===d.TYPE.ERROR},isMessage:function(){return this.control.type===d.TYPE.MESSAGE},isReliableRelay:function(){return this.header.action===d.ACTION.RELIABLE_RELAY},isACK:function(){return this.control.type===d.TYPE.ACK},isReconnect:function(){var e=this.control.package_type,t=this.control.session_id,i=this.header.action;return!(e!==d.PACKAGE.REGISTER||!t||i!==d.ACTION.CONNECT)},ack:function(e){var t=new c.Message;t.control.session_id=this.control.session_id,t.control.subsession_id=this.control.subsession_id,t.control.type=d.TYPE.ACK,t.control.package_type=this.control.package_type,t.control.sequence=this.control.sequence,e.sendMessage(t)},complete:function(e){var t=new c.Message;t.control.session_id=this.control.session_id,t.control.subsession_id=this.control.subsession_id,t.control.correlation_id=this.control.correlation_id,t.control.type=d.TYPE.MESSAGE,t.control.package_type=this.control.package_type,t.header.action=d.ACTION.COMPLETE,t.header.stream_id=this.header.stream_id,t.header.stream_type=this.header.stream_type,e.sendMessage(t)},addExtHeaders:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];this.header[t]||(this.header[t]=i)}},getExtHeaders:function(){var e;if(this.header)for(var t in this.header)if(this.header.hasOwnProperty(t)){if(c.Message.systemHeaders[t])continue;e||(e={}),e[t]=this.header[t]}return e},addExtPayloads:function(e){for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];this.payload[t]||(this.payload[t]=i)}}},c.ErrorInfo=function(e,t){this.code=e,this.reason=t},c.wscLoginWithOAuthToken=function(e,t,i,o,s){var n=o+"?oauth_token="+e+"&final_redirect_uri="+t+"&wsc_app_uri="+s;if(u.debug("Login WebRTC Session Controller by OAuth token to destination -> "+n),!i){var a="The parameter loginWindowType is required.";throw u.error(a),a}"current_window"===i?window.location.href=n:"new_window"===i&&window.open(n,"Wsc Login","width=500,height=500,left=200,top=100")},c.AuthHandler=function(e){"use strict";this.session=e,e.authHandler=this,this.refresh=null,this.toJSON=function(){return c.toJSON({session:""},this)}},c.checkAuthInfo=function(e,t){var i=!1;if(e===d.AUTHTYPE.SERVICE){if(!t)return!1;i=!0}else if(e===d.AUTHTYPE.TURN){if(!t)return!0;null!=t.iceServers&&(i=!0)}return i},c.getRTCConfiguration=function(e){var t,i=e.authHandler,o=0,s=null,n=!0;if(i&&i.refresh)for(;n&&o<3;){o++;try{if(s=i.refresh(d.AUTHTYPE.TURN),c.checkAuthInfo(d.AUTHTYPE.TURN,s))break;if(!1===s){t="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",u.warn(t),n=!1;break}t="No correct information was return from the callback function 'AuthHandler.refresh()'. Please try again.",u.warn(t)}catch(e){u.error("Handle unauthenticated message error: "+e),n=!1}}else u.warn("No AuthHandler object created for this Session, or this AuthHandler does not have the callback function 'AuthHandler.refresh()'."),n=!1;if(!1===n&&(s=null),s||(s={iceServers:[],iceTransportPolicy:"all"}),e.iceServerListFromServer.length>0){var a=e.iceServerListFromServer.concat(s.iceServers);s.iceServers=a}return s},c.calcHa1=function(e,t){return""},c.extend=function(e,t){var i=function(){};i.prototype=t.prototype;var o=e.prototype;e.prototype=new i,o&&c.deepCopy(o,e.prototype),e.prototype.constructor=e,e.superclass=t.prototype,e.superclass&&(e.superclass.constructor=t)},c.deepCopy=function(e,t){for(var i in t=t||{},e)"object"==typeof e[i]?(t[i]=e[i].constructor===Array?[]:{},c.deepCopy(e[i],t[i])):t[i]=e[i];return t},c.toJSON=function(e,t){var i={};for(var o in t)o in e||(i[o]=t[o]);return i},c.testBrowser=function(){var e,t,i,o,s,n,a=!1;if(l.browser.isChrome){e="Chrome",a=!0;try{t=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10)}catch(e){console.warn("Unable to get (Chrome) version from navigator.userAgent",navigator.userAgent)}i=void 0,o=void 0}if(l.browser.isFirefox){e="Firefox",a=!0;try{t=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10)}catch(e){console.warn("Unable to get (Firefox) version from navigator.userAgent",navigator.userAgent)}i=void 0,o=void 0}if(navigator.mediaDevices&&navigator.userAgent.match(/Edg\/(\d+).(\d+)/)){e="Edge",a=!0;try{t=parseInt(navigator.userAgent.match(/Edg\/(\d+).(\d+)/)[1],10)}catch(e){console.warn("Unable to get (Edge) version from navigator.userAgent",navigator.userAgent)}i=void 0,o=void 0}if(l.browser.isIE){e="IE",a=!1;try{t=parseInt(navigator.userAgent.match(/rv\:([0-9]+)\./)[1],10)}catch(e){console.warn("Unable to get (IE) version from navigator.userAgent",navigator.userAgent)}i=void 0,o=void 0}if(l.browser.isSafari){e="Safari",a=!0;try{t=parseInt(navigator.userAgent.match(/Version\/([0-9]+)\./)[1],10)}catch(e){console.warn("Unable to get (Safari) version from navigator.userAgent",navigator.userAgent)}i=void 0,o=void 0}if(l.browser.isOpera){e="Opera",a=!0;try{t=parseInt(navigator.userAgent.match(/OPR\/([0-9]+)\./)[1],10)}catch(e){console.warn("Unable to get (Opera) version from navigator.userAgent",navigator.userAgent)}i=void 0,o=void 0}if(n=l.browser.supportSessionStorage,s="WebSocket"in window,void 0===e){var r=navigator.userAgent;if(r.startsWith("Mozilla")){if(u.debug("Mozilla user agent: "+r),r.includes("CriOS/")){e="Chrome";try{t=parseInt(navigator.userAgent.match(/CriOS\/([0-9]+)\./)[1],10)}catch(e){console.warn("Unable to get (Chrome in iOS) version from navigator.userAgent",navigator.userAgent)}a=!0,i=void 0,o=void 0,n=!0,s=!0}r.includes("FxiOS/")&&(e="Firefox",t="60",a=!0,i=void 0,o=void 0,n=!0,s=!0),u.debug("iOS browser app:"+e+" v"+t)}}return{compatible:a&&s&&n,details:{browserName:e,browserVersion:t,supportedMinimumVersion:i,supportedMaximumVersion:o,supportWebRTC:a,supportWebSocket:s,supportSessionStorage:n,OS:navigator.userAgent.match(/Android/i)?"Android":navigator.userAgent.match(/iPhone|iPad|iPod/i)?"iOS":navigator.userAgent.match(/Windows/i)?"Windows":navigator.userAgent.match(/Mac/i)?"Mac":"Others"}}},c.resumeAudioContext=function(e,t){return void 0===g?t("Audio context is not supported."):void g.resume().then(e).catch(t)},c.testMicrophone=function(){return t("audioinput")},c.testAudio=function(){return t("audiooutput")},c.testCamera=function(){var e=!1;return navigator.mediaDevices.enumerateDevices().then(function(t){var i=[],o=[];return t.forEach(function(e){"videoinput"===e.kind&&i.push(e)}),0==i.length?Promise.resolve({available:!1,details:o}):m(i,function(t){return new function(e){this.sourceInfo=e;var t={};this.test=function(){var e=[];return t.sourceId=this.sourceInfo.deviceId,t.label=this.sourceInfo.label,m(v,function(o){var s={audio:!1,video:{width:{ideal:o.width},height:{ideal:o.height}}};return i(s).then(function(i){if(i){if("undefined"!=typeof RTCRtpReceiver&&i instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&i instanceof RTCRtpSender)i.track&&"video"===i.track.kind&&(i.track.stop(),t.label=i.track.label);else{var s=i.getVideoTracks();s.length>0&&(s[0].stop(),t.label=s[0].label)}e.push(o.width+"x"+o.height)}return t.availableResolutions=e,e.length>0&&(t.available=!0),t})}).catch(function(e){u.debug(e)})};var i=function(e){return new Promise(function(t,i){u.debug("Calling getUserMedia with constraints",e),navigator.mediaDevices.getUserMedia(e).then(t).catch(function(e){u.warn("getUserMedia error when check resolution of camera",e),t()})})}}(t).test().then(function(t){return o.push(t),{available:e=e||t.available,details:o}})}).catch(function(e){return u.debug(e),Promise.resolve({available:!1,details:[]})})}).catch(function(e){return u.debug("Device selection is not supported",e),Promise.resolve({available:!1,details:[]})})},c.testNetwork=function(e,t,s){var n={details:{}};return new i(e,t,s,"udp").test().then(function(o){return u.debug("udp connectivity test..."),n.details.udpConnectivity=o,new i(e,t,s,"tcp").test()}).then(function(i){return u.debug("tcp connectivity test..."),n.details.tcpConnectivity=i,new function(e,t,i){this.turnURI=e,this.username=t,this.password=i,this.test=function(){var e={iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]};return new Promise(function(t,i){var o,s=new r(e,function(e,i){u.warn(i),e.end(),t(0)}),n=null,a=0,l=0,c=!1,d="",h=null;d="12345";for(var g=0;g<5;g++)d+=d+d;o=100*d.length,(h=s.pc1.createDataChannel(null)).onopen=function(){n||(n=new Date);var e=function(){for(var t=0;100!==t&&!(h.bufferedAmount>=o);++t)a+=d.length,h.send(d);new Date-n>=3e3?c=!0:setTimeout(e,1)};e()},s.pc2.ondatachannel=function(e){e.channel.onmessage=function(e){if(l+=e.data.length,c&&a===l){s.end();var i=l/(new Date-n);i=Math.round(1e3*i*8)/1e3,s.end(),t(i)}}},s.start()})}}(e,t,s).test()}).then(function(i){return u.debug("data channel connectivity test..."),n.details.dataThroughput=i,new o(e,t,s).test()}).then(function(e){return u.debug("video bandwidth connectivity test..."),n.details.videoBandwidth=e,n.connectivity=(n.details.udpConnectivity||n.details.tcpConnectivity)&&n.details.dataThroughput>0&&n.details.videoBandwidth>0,n}).catch(function(e){return u.error("Error happens when test network. ",e),Promise.reject(e)})},o.prototype={test:function(){var e={iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]};return new Promise(function(t,i){var o=4e4,s=0,n=0,a=null,l=null,c=new r(e,function(e,i){u.warn(i),g(),t(-1)});c.setMaxVideoBitRate(2e3),c.disableVideoFec();var d={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};u.debug("Calling getUserMedia with constraints",d),h(d).then(function(e){e.getTracks().forEach(function(t){c.pc1.addTrack(t,e)}),c.start(),a=setTimeout(function(){m(),null==l&&(l=setTimeout(function(){g();var e=-1;n>0&&(e=Math.round(s/n)),t(e)},o))},2e3)}).catch(function(e){u.warn("getUserMedia error when testing video bandwidth",e),t(-1)});var g=function(){if(a&&clearTimeout(a),l&&clearTimeout(l),c&&c.pc1){var e=c.pc1.getLocalStreams();e.length>0&&e[0].getTracks().forEach(function(e){e.stop()}),c.end()}},m=function(){c.pc1.getStats(null,function(e){var i;for(var o in e){var a=e[o];if("bweforvideo"===a.id){i=a.googAvailableSendBandwidth/1e3;break}}void 0==i?(u.warn("Cannot get bandwidth from getStats()."),g(),t(-1)):(s+=i,n+=1)},function(e){u.warn("Error when get statistics.",e),g(),t(-1)}),a=setTimeout(m,1e3)}})}},c.testMicrophoneCallback=function(e,t){return s(0,e,t)},c.testAudioCallback=function(e,t){return s(0,e,t)},c.testCameraCallback=function(e,t){var i=function(t){var i,o={available:!1,details:[]};0==(i=t.filter(function(e){return"videoinput"===e.kind})).length&&e(o);var s=function(t,i,o){this.available=this.available||o.available,this.details.push(o),t&&i?t.test(i):e(this)},n=i.map(function(e){return new function(e){this.sourceInfo=e;var t={};this.test=function(e){t.sourceId=this.sourceInfo.deviceId,t.label=this.sourceInfo.label,t.availableResolutions=[];var i=function(i,o,s){s&&("undefined"!=typeof RTCRtpReceiver&&s instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&s instanceof RTCRtpSender?s.track&&"video"===s.track.kind&&s.track.stop():s.getVideoTracks()[0].stop(),t.availableResolutions.push(i.video.mandatory.minWidth+"x"+i.video.mandatory.minHeight)),o?o():(t.available=t.availableResolutions.length>0,e(t))},o=function(i,o){u.warn("getUserMedia error when check resolution of camera",o),i?i():(t.available=t.availableResolutions.length>0,e(t))},s=v.map(function(e){return{audio:!1,video:{mandatory:{minWidth:e.width,minHeight:e.height,maxWidth:e.width,maxHeight:e.height},optional:[{sourceId:t.sourceId}]}}}),n=s.reverse().shift();s.reduce(function(e,t){return u.debug("Calling getUserMedia with constraints",n),h.bind(null,t,i.bind(null,t,e),o.bind(null,e))},h.bind(null,n,i.bind(null,n,null),o.bind(null,null)))()}}(e)}),a=n.shift(),r=n.reverse().reduce(function(e,t){return s.bind(o,t,e)},s.bind(o,null,null));a.test(r)};void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.enumerateDevices?navigator.mediaDevices.enumerateDevices().then(i).catch(function(t){u.debug("Device selection is not supported",t),e&&e({available:!1,details:[]})}):"undefined"!=typeof MediaStreamTrack&&void 0!==MediaStreamTrack.getSources?MediaStreamTrack.getSources(function(e){i(e.map(function(e){return{label:e.label,kind:kinds[e.kind],deviceId:e.id,groupId:""}}))}):t("Devices cannot be enumerated.")},c.testNetworkCallback=function(e,t,i,o,s){e&&t&&i||s("TURN URI, username and password are required"),"string"==typeof e&&"string"==typeof t&&"string"==typeof i||s("TURN URI, username and password must be string type");var r={},l={iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]};r.connectivity=!1,r.details={},new n(e,t,i,"udp").test(function(s){u.debug("udp connectivity test...Done"),r.details.udpConnectivity=s,new n(e,t,i,"tcp").test(function(s){u.debug("tcp connectivity test...Done"),r.details.tcpConnectivity=s,new c.DataChannelThroughput_CallbackBased(l,3).test(function(s){u.debug("data channel connectivity test...Done"),r.details.dataThroughput=s,new a(e,t,i).test(function(e){u.debug("video bandwidth connectivity test...Done"),r.details.videoBandwidth=e,r.connectivity=(r.details.udpConnectivity||r.details.tcpConnectivity)&&r.details.dataThroughput>0&&r.details.videoBandwidth>0,o(r)})})})})},c.DataChannelThroughput_CallbackBased=function(e,t,i,o){var s=c.DataChannelThroughput_CallbackBased;this.test=function(n,a){var l=new r(e,function(e,t){h&&clearTimeout(h),e.end(),b=!0,"function"==typeof a&&a(t)},!0);s.lastConfig=e;var d,h,g,m,p,v=null,S=0,_=0,f=!1,C=null,b=!1,E=0,R=0,A=[],T=function(e){e&&e.end(),d&&clearTimeout(d)};if(!c.__throughputPayloadData__){c.__throughputPayloadData__="";for(var y=0;y<128;y++)c.__throughputPayloadData__+="12345678"}var I=function(e){m&&clearTimeout(m),p&&clearTimeout(p),"function"==typeof a&&a(e),T(l),b=!0};if("closed"===l.pc1.connectionState||"closed"===l.pc1.signalingState||"closed"===l.pc2.connectionState||"closed"===l.pc2.signalingState)return u.info("Failed to open data channel, connectionState="+l.pc1.connectionState+", signalingState="+l.pc1.signalingState),"function"==typeof a&&a("Cannot get network status.Illegal state for peer connection."),T(l),void(b=!0);(C=l.pc1.createDataChannel(null)).onopen=function(){h&&clearTimeout(h);var e,s=function(){if(Date.now()-e>1100)return u.warn("The timer is executed after additional 1000ms, the page tab may be inactive so that browser tunes the timer interval"),"function"==typeof a&&a("Network diagnostics : Throughput determination failed. The page tab may be inactive so that browser tunes the timer interval."),T(l),void(b=!0);if(C.bufferedAmount<c.__throughputPayloadData__.length){S+=c.__throughputPayloadData__.length;try{C.send(c.__throughputPayloadData__)}catch(e){return void I(e)}}new Date-v>=1e3*t||S-R>307200?f=!0:(e=Date.now(),m=setTimeout(s,1))},n=function(){void 0!==i&&null!==i&&(g=setTimeout(function(){u.debug("Timeout for network status detection, interrupt it and get throughput"),w()},1e3*i)),v||(v=new Date),s()};if(!0===o){var r=function(){if(Date.now()-e>1100)return u.warn("The timer is executed after additional 1000ms, the page tab may be inactive so that browser tunes the timer interval"),"function"==typeof a&&a("Network diagnostics : Latency determination failed. The page tab may be inactive so that browser tunes the timer interval."),T(l),void(b=!0);var t=""+Date.now();try{C.send(t)}catch(e){return void I(e)}R+=t.length,S+=t.length,(E+=1)>=40?n():(e=Date.now(),p=setTimeout(r,100))};r()}else n()};var w=function(){if(!b){b=!0,clearTimeout(m),T(l);var e,t,i,s=new Date-v;if(o){if(A.length>10){var a=A.slice(10),r=0;e=a[0],t=e,a.forEach(function(i){r+=i,i>e&&(e=i),i<t&&(t=i)}),i=Math.round(r/a.length),u.debug("Latency(ms): average: "+i+", min: "+t+", max: "+e+", count: "+a.length+", details: "+a.toString())}u.debug("Warmup details(ms):"+A.slice(0,10))}var c=_-R,d=Math.round(8*c/s);u.debug("Network status detection succeeds. The throughput is: "+d+" kbps, use time (ms): "+s+", received bytes: "+c),"function"==typeof n&&(o?n(d,i,e,t):n(d))}};l.pc2.ondatachannel=function(e){e.channel.onmessage=function(e){if(e.data.length<20){var t=parseInt(e.data),i=Date.now()-t;A.push(i)}_+=e.data.length,f&&S===_&&(g&&clearTimeout(g),w())}};h=setTimeout(function(){u.debug("Takes more than 10000ms to open the data channel. End the call and invoke error callback"),T(l),b=!0,"function"==typeof a&&a("Network diagnostics : ICE failed. Takes more than 10000ms to open the data channel.")},1e4),l.start(),d=setTimeout(function(){T(l)},6e4)}},a.prototype={test:function(e){var t=4e4,i=0,o=0,s=null,n=null,a=new r({iceServers:[{username:this.username||"",credential:this.password||"",urls:this.turnURI.split(",")}]},function(t,i){u.warn(i),c(),e(-1)});a.setMaxVideoBitRate(2e3),a.disableVideoFec();var l={audio:!1,video:{optional:[{minWidth:1280},{minHeight:720}]}};console.log("Calling getUserMedia with constraints",l),h(l).then(function(r){r.getTracks().forEach(function(e){a.pc1.addTrack(e,r)}),a.start(),s=setTimeout(function(){d(),null==n&&(n=setTimeout(function(){c();var t=-1;o>0&&(t=Math.round(i/o)),e(t)},t))},2e3)}).catch(function(t){u.warn("getUserMedia error when testing video bandwidth",t),e(-1)});var c=function(){if(s&&clearTimeout(s),n&&clearTimeout(n),a&&a.pc1){var e=a.pc1.getLocalStreams();e.length>0&&e[0].getTracks().forEach(function(e){e.stop()}),a.end()}},d=function(){a.pc1.getStats(null,function(t){var s;for(var n in t){var a=t[n];if("bweforvideo"===a.id){s=a.googAvailableSendBandwidth/1e3;break}}void 0==s?(u.warn("Cannot get bandwidth from getStats()."),c(),e(-1)):(i+=s,o+=1)},function(t){u.warn("Error when get statistics.",t),c(),e(-1)}),s=setTimeout(d,1e3)}}},l.browser.isIE){var S=JSON.stringify;JSON.stringify=function(){var e=Array.prototype.slice.call(arguments);return(1===e.length||e.length>1&&(null===e[1]||void 0===e[1]))&&(e[1]=function(e,t){return t&&t.call&&t.apply?void 0:t}),S.apply(this,e)}}return e.extend=c.extend,e.wscLoginWithOAuthToken=c.wscLoginWithOAuthToken,e.Message=c.Message,e.ErrorInfo=c.ErrorInfo,e.AuthHandler=c.AuthHandler,e.testBrowser=c.testBrowser,e.testMicrophone=c.testMicrophone,e.testAudio=c.testAudio,e.testCamera=c.testCamera,e.testNetwork=c.testNetwork,e.testMicrophoneCallback=c.testMicrophoneCallback,e.testAudioCallback=c.testAudioCallback,e.testCameraCallback=c.testCameraCallback,e.testNetworkCallback=c.testNetworkCallback,e.resumeAudioContext=c.resumeAudioContext,e}(live||{}),live=function(e){"use strict";function t(e,t){var i=t.pkgInstance.videoSendBitrate;return i?(p.debug("Prefer video send bitrate: "+i),o(e,i,"video")):e}function i(e,t){var i=t.pkgInstance.videoRecvBitrate;return i?(p.debug("Prefer video receive bitrate: "+i),o(e,i,"video")):e}function o(e,t,i){var o=e.split("\r\n"),s=c(o,"m=",i);if(null===s)return p.debug("Failed to add bandwidth line to sdp, as no m-line found"),e;var n=d(o,s+1,-1,"m=");null===n&&(n=o.length);var a=d(o,s+1,n,"c=");if(null===a)return p.debug("Failed to add bandwidth line to sdp, as no c-line found"),e;var r=d(o,a+1,n,"b=AS");r&&o.splice(r,1);var l="b=AS:"+t;return o.splice(a+1,0,l),o.join("\r\n")}function s(e,t){if(!t.pkgInstance.removeVideoFec)return e;p.debug("Removing FEC-related SDP lines (red / ulpfec / rtx)");var i=e.split("\r\n"),o=c(i,"a=rtpmap","red");if(null===o)return e;var s=l(i[o]);if(null===(o=c(i=n(i=a(i,s),"ulpfec"),"a=fmtp",s.toString())))return e;var r=function(e){var t={},i=e.indexOf(" "),o=e.substring(i+1).split("; "),s=new RegExp("a=fmtp:(\\d+)"),n=e.match(s);if(!n||2!==n.length)return null;t.pt=n[1];for(var a={},r=0;r<o.length;++r){var l=o[r].split("=");2===l.length&&(a[l[0]]=l[1])}return t.params=a,t}(i[o]).pt;return null===r?e:(i.splice(o,1),(i=a(i,r)).join("\r\n"))}function n(e,t){var i=c(e,"a=rtpmap",t);if(null===i)return e;var o=l(e[i]);e.splice(i,1);var s=c(e,"m=","video");return null===s?e:(e[s]=r(e[s],o),e)}function a(e,t){var i=c(e,"a=rtpmap",t.toString());if(null===i)return e;e.splice(i,1);var o=c(e,"m=","video");return null===o?e:(e[o]=r(e[o],t),e)}function r(e,t){e=e.split(" ");for(var i=0;i<e.length;++i)e[i]===t.toString()&&e.splice(i,1);return e.join(" ")}function l(e){var t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),i=e.match(t);return i&&2===i.length?i[1]:null}function c(e,t,i){return d(e,0,-1,t,i)}function d(e,t,i,o,s){for(var n=-1!==i?i:e.length,a=t;a<n;++a)if(0===e[a].indexOf(o)&&(!s||-1!==e[a].toLowerCase().indexOf(s.toLowerCase())))return a;return null}var u=e._private=e._private||{},h={},g=u.wscConst,m=u.browser,p=e.getLogger();return h.collectHostIPsByPc=function(e,t){function i(e){p.error("Create offer error while collect Host IP, "+e);o([])}function o(i){try{n&&(n.close(),n=null),a&&(a.close(),a=null),i.length>0?(p.debug("Collected hostIPs: "+JSON.stringify(i,null,2)),e&&e(i)):t()}catch(e){p.error(e)}}var s={};p.debug("Constraints used for peerConnection: "+JSON.stringify(s));var n=new window.RTCPeerConnection(null,s),a=new window.RTCPeerConnection(null,s);try{n.onicecandidate=function(e){if(e.candidate)p.debug("Collected candidate: candidate- "+JSON.stringify(e.candidate));else if(n&&n.localDescription){var i=n.localDescription.sdp;p.debug("Collecting host ips from sdp -"+i),o(function(e){for(var t=[],i=e.split("\r\n"),o=0;o<i.length;o++){var s=i[o],n=null;if(s.match(/^c=/i)){var a=s.split(/\s+/);n=a[2]}else if(s.match(/^a=candidate:.*typ host/i)){var r=s.split(/\s+/);n=r[4]}n&&-1===t.indexOf(n)&&t.push(n)}return t}(i))}else t()},n.createDataChannel("");n.createOffer().then(function(e){n&&a&&(n.setLocalDescription(e),a.setRemoteDescription(e),a.createAnswer().then(function(e){a.setLocalDescription(e),n.setRemoteDescription(e)}).catch(function(e){i(e)}))}).catch(function(e){i(e)})}catch(e){p.error("Got exception when trying to get host IPs: "+e);o([])}},h.addCandidatesFromSdp=function(e,t){var i,o=h.getMediaFromSDP(t),s=[],n={},a=o.length,r=0,l=0;for(r=0;r<a;r++)for(i=(s=o[r].candidates).length,l=0;l<i;l++)n=new RTCIceCandidate({sdpMLineIndex:r,candidate:s[l]}),e.addIceCandidate(n)},h.createPeerConnection=function(t,i){var o,s=null,n=u.wscUtils;try{s=n.getRTCConfiguration(t.session);var a={};a.optional=[{googIPv6:t.pkgInstance.ipv6},{googDscp:t.pkgInstance.dscp}],p.debug("Constraints used for peerConnection: "+JSON.stringify(a)),p.debug("authInfo: "+JSON.stringify(s));var r={};r.start=(new Date).getTime(),t.timeRecording.timeToNewPeerConnection=r,t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ESTABLISH_PEER_CONNECTION_START),o=new window.RTCPeerConnection(s,a),t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ESTABLISH_PEER_CONNECTION_END),t.timeRecording.timeToNewPeerConnection.end=(new Date).getTime();o.onremovestream=function(e){p.info("Remote stream removed."),t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ON_REMOVE_STREAM+":"+e.stream),t.fireMediaStreamEvent(g.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED,e.stream)},o.ontrack=function(e){p.info("Remote stream added via onAddStream.",e),e.streams.length>0&&(t.collectClientLog(g.LOGTYPE.EVENT_LOG,g.EVENTLOG.ON_ADD_STREAM+":"+e.streams[0]),t.timeRecording.timeToGetRemoteMedia.end=(new Date).getTime(),t.fireMediaStreamEvent(g.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED,e.streams[0]),o.___wsc_onaddstream_called=!0)},o.onconnecting=function(e){p.info("Session connecting.")},o.onopen=function(e){p.info("Session opened.")},t.peerConnection=o,i?(p.debug("Adding local to streams to ",i),h.addLocalStreams(t,i)):h.addLocalStream(t),o.onstatechange=function(e){p.debug("iceConnectionState : "+e.currentTarget.iceConnectionState+"\niceGatheringState : "+e.currentTarget.iceGatheringState+"\n")}}catch(i){p.error("Create peer connection: "+i),h.invokeCallError(t,e.ERRORCODE.PEERCONNECTION_ERROR,i)}},h.createNewPeerConnection=function(e){if(e.peerConnection){var t=h.getLocalStreams(e.peerConnection);if(e.temporarySavedStreams=t,t)for(var i=0;i<t.length;i++){var o=t[i];h.removeLocalStream(e,o)}e.peerConnection.close(),e.peerConnection=null}h.createPeerConnection(e)},h.clearPeerConnection=function(e){var t=e.peerConnection,i=0;if(t){var o=h.getLocalStreams(t),s=h.getRemoteStreams(t);if(o)for(i=0;i<o.length;i++){var n=o[i];h.removeLocalStream(e,n)}if(s)for(i=0;i<s.length;i++)m.isFirefox;t.close(),e.peerConnection=null}},h.setLocalDescription=function(i,o,n,a){p.debug("rtcHelper.setLocalDescription, newSdp:",o);var r=null,l=null;if(i&&i.peerConnection&&o){n||(n=function(){p.debug("Set localDescription succeed!")}),l=function(){i.timeRecording.timeToGetIceCandidates.start=(new Date).getTime(),n.apply(this,arguments)},r=a?function(t){a(t),h.invokeCallError(i,e.ERRORCODE.SET_LOCAL_SDP_ERROR,t)}:function(t){p.warn("Set local description failed: ",t),h.invokeCallError(i,e.ERRORCODE.SET_LOCAL_SDP_ERROR,t)};var c=i.peerConnection.localDescription;p.debug("iceConnectionState/iceGatheringState is: "+i.getIceConnectionState()+"/"+i.peerConnection.iceGatheringState),p.debug("Updating SDP parameters by reconstruction (in case sdp is read only)..",o);var d=o.sdp;if(d=s(d=t(d,i),i),!m.isFirefox&&"offer"===o.type&&d.includes("m=video")){var u=d.indexOf("m=video");d.includes("a=ssrc",u)||(d+="a=ssrc:1 cname:AAAa0AaA0AaAaaaO\r\n")}var g=new RTCSessionDescription({type:o.type,sdp:d});p.debug("setLocalDescription: type: "+g.type+", sdp: \n"+JSON.stringify(g,null,2)),i.peerConnection.setLocalDescription(g).then(l).catch(r),i.peerConnection.__wscLastLocalSdp=c}},h.setRemoteDescription=function(t,o,n,a){var r=null;if(t&&t.peerConnection&&o){n||(n=function(){p.debug("Set remote description succeed!")}),r=a?function(i){a(i),h.invokeCallError(t,e.ERRORCODE.SET_REMOTE_SDP_ERROR,i)}:function(i){p.warn("Set remote description failed!",i),t.collectClientLog(g.LOGTYPE.ERROR_LOG,g.ERRORLOG.SET_REMOTE_SDP_ERROR+":"+o),h.invokeCallError(t,e.ERRORCODE.SET_REMOTE_SDP_ERROR,i)},p.debug("Updating (remote) SDP parameters by reconstruction (in case sdp is read only)..",o);var l=o.sdp;if(l=function(e){return p.debug("Pre H264 fixes sdp: "+e),e=(e=(e=e.replace("profile-level-id=42001f","profile-level-id=42e01f")).replace("profile-level-id=420c1f","profile-level-id=42e01f")).replace("packetization-mode=0","packetization-mode=1"),m.isFirefox&&e.includes("m=application 0 UDP/DTLS/SCTP 0")&&(console.log("GT: note fixSdp is suppressing 'm=application 0 UDP/DTLS/SCTP 0' line to help FireFox"),e=e.split("\r\n").filter(function(e){return"m=application 0 UDP/DTLS/SCTP 0"!==e}).join("\r\n")),m.isSafari&&(e=e.replace("h264","H264")),p.debug("Post H264 fixes sdp: "+e),e}(l=s(l=i(l=function(e,t){return p.debug("Browser is: "+JSON.stringify(m,null,2)),m.isIE&&(p.debug("Filtering SDP to remove 'rtcp-fb:* nack' support"),t=t.split("\r\n").filter(function(e){return!e.match(/rtcp-fb:\* nack.*/)}).join("\r\n"),p.debug("Filtering SDP to remove b=AS:0"),t=t.split("\r\n").filter(function(e){return"b=AS:0"!==e}).join("\r\n")),t.split("\r\n").map(function(t){var i=t.match(/a=setup:.*/g);return"offer"===e&&i?(p.debug("SDP offer contains: "+i),"a=setup:actpass"!==i[0]?(p.debug("SDP offer should not contain "+i),"a=setup:actpass"):t):t}).join("\r\n")}(o.type,l),t),t)),m.isFirefox&&"offer"===o.type&&l.includes("m=audio")&&!l.includes("m=video")&&!l.includes("m=application")){var c=l.indexOf("m=audio");l.includes("a=mid",c)||(l+="a=mid:audio\r\n")}p.debug("setRemoteDescription: type: "+o.type+", sdp: \n"+JSON.stringify(l,null,2));var d=new RTCSessionDescription({type:o.type,sdp:l});t.peerConnection.setRemoteDescription(d).then(n).catch(r)}},h.removeLocalStream=function(e,t){t&&(t.peerConnectionNum&&(t.peerConnectionNum--,p.debug("removeLocalStream, peerConnectionNum: "+t.peerConnectionNum)),m.isFirefox||("undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?e.peerConnection.removeTrack(t):e.peerConnection.removeStream(t)),e.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED,t))},h.addLocalStream=function(e,t){var i=e.peerConnection,o=0;if(t){t.peerConnectionNum?t.peerConnectionNum++:t.peerConnectionNum=1,"undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?(t.track&&"video"===t.track.kind&&!e.callConfig.shouldSendVideo()&&(t.track.enabled=!1),t.track&&"audio"===t.track.kind&&(p.debug("Adding audio track to new stream",t.track),i.addTrack(t.track,t),p.debug("addLocalStream (video: 0, audio: 1), peerConnectionNum: "+t.peerConnectionNum,t)),t.track&&"video"===t.track.kind&&(p.debug("Adding video track to new stream",t.track),i.addTrack(t.track,t),p.debug("addLocalStream (video: 1, audio: 0), peerConnectionNum: "+t.peerConnectionNum,t))):(t.getVideoTracks().length>0&&!e.callConfig.shouldSendVideo()&&t.getVideoTracks().map(function(e){e.enabled=!1}),t.getAudioTracks().forEach(function(e){p.debug("Adding audio track to new stream",e),i.addTrack(e,t)}),t.getVideoTracks().forEach(function(e){p.debug("Adding video track to new stream",e),i.addTrack(e,t)}),p.debug("addLocalStream (video: "+t.getVideoTracks().length+", audio: "+t.getAudioTracks().length+"), peerConnectionNum: "+t.peerConnectionNum,t));var s=!0,n=e.localMediaStreams;for(o=0;o<n.length;o++){if(n[o]===t){s=!1;break}}s&&(e.localMediaStreams||(e.localMediaStreams=[]),e.localMediaStreams.push(t)),i.__wscIsAudioStreamAdded||(i.__wscIsAudioStreamAdded=h.streamHasMediaTracks([t],"audio")),i.__wscIsVideoStreamAdded||(i.__wscIsVideoStreamAdded=h.streamHasMediaTracks([t],"video")),e.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,t)}else{for(o=0;o<e.temporarySavedStreams.length;o++){var a=e.temporarySavedStreams[o];a.peerConnectionNum?a.peerConnectionNum++:a.peerConnectionNum=1,"undefined"!=typeof RTCRtpReceiver&&a instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&a instanceof RTCRtpSender?(a.track&&"audio"===a.track.kind&&(p.debug("Adding audio track to existing stream",a.track),i.addTrack(a.track,a)),a.track&&"video"===a.track.kind&&(p.debug("Adding video track to existing stream",a.track),i.addTrack(a.track,a))):(a.getAudioTracks().forEach(function(e){p.debug("Adding audio track to existing stream",e),i.addTrack(e,a)}),a.getVideoTracks().forEach(function(e){p.debug("Adding video track to existing stream",e),i.addTrack(e,a)})),e.fireMediaStreamEvent(g.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED,a),p.debug("addLocalStream, peerConnectionNum: "+a.peerConnectionNum)}i.__wscIsAudioStreamAdded||(i.__wscIsAudioStreamAdded=h.streamHasMediaTracks(e.localMediaStreams,"audio")),i.__wscIsVideoStreamAdded||(i.__wscIsVideoStreamAdded=h.streamHasMediaTracks(e.localMediaStreams,"video"))}p.debug("call local media streams length : "+e.localMediaStreams.length)},h.addLocalStreams=function(e,t){if(t)for(var i=0;i<t.length;i++){var o=t[i];h.addLocalStream(e,o)}},h.calculateMediaChange=function(e,t){var i=!1,o=[],s=[];if(e.forEach(function(e){"inactive"!==e.mode&&0!==e.port&&o.push(e)}),t.forEach(function(e){"inactive"!==e.mode&&0!==e.port&&s.push(e)}),o.length<s.length)i=!0;else if(o.length>s.length)i=!0;else for(var n=0;n<s.length;n++){for(var a=s[n],r=!1,l=0;l<o.length;l++)if(a.equals(o[l])){r=!0;break}if(!r){i=!0;break}}return i},h.isMediaChanged=function(e,t){return h.calculateMediaChange(e,t)},h.getMediaFromSDP=function(e){var t,i,o,s,n,a,r,l,c=e.split("\r\n"),d=0,u="sendrecv",g=[],m=c.length;for(t=0;t<m;t++)switch(i=c[t].split("="),i[0]){case"a":"sendonly"===(o=i[1])||"sendrecv"===o||"recvonly"===o||"inactive"===o?0===d?u=i[1]:g[d-1].mode=i[1]:0===o.indexOf("candidate:")?g[d-1].candidates.push(c[t]):0===o.indexOf("mid:")&&(g[d-1].mid=c[t]);break;case"m":n=(s=i[1].split(" "))[0],a=s[1],r=new h.Media(n,u,a),g[d++]=r;break;case"o":l=(o=i[1]).split(" ")[1],g.sessionId=l}return g},h.Media=function(e,t,i){this.type=e,this.mode=t,this.port=i,this.candidates=[],this.mid="",this.toJSON=function(){return{type:this.type,mode:this.mode,port:this.port}},this.equals=function(e){return 0===this.port&&(this.mode="inactive"),0===e.port&&(e.mode="inactive"),this.type===e.type&&this.mode===e.mode}},h.getMediaServerIp=function(e){if(!e)return null;var t,i=e.split("\r\n"),o=i.length;for(t=0;t<o;t++)if(-1!==i[t].indexOf("o=xmserver")){var s=i[t].split(" ");return s[s.length-1]}return null},h.getCallConfigFromRemoteSDP=function(t,i){var o=g.MEDIADIRECTION.NONE,s=g.MEDIADIRECTION.NONE,n=null,a=function(e,t){switch(e.toLowerCase()){case"sendonly":return t?g.MEDIADIRECTION.SENDONLY:g.MEDIADIRECTION.RECVONLY;case"recvonly":return t?g.MEDIADIRECTION.RECVONLY:g.MEDIADIRECTION.SENDONLY;case"sendrecv":return g.MEDIADIRECTION.SENDRECV;case"inactive":return g.MEDIADIRECTION.NONE}};if(t){for(var r=h.getMediaFromSDP(t),l=null,c=0;c<r.length;c++)"audio"===r[c].type.toLowerCase()?s=a(r[c].mode,i):"video"===r[c].type.toLowerCase()?o=a(r[c].mode,i):"application"===r[c].type.toLowerCase()&&(l=[]);n=new e.CallConfig(s,o,l)}return n},h.streamHasMediaTracks=function(e,t){var i=!1;if(null===e||"audio"!==t&&"video"!==t)return i;for(var o=0;o<e.length;o++)if("audio"===t)if("undefined"!=typeof RTCRtpReceiver&&e[o]instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e[o]instanceof RTCRtpSender)e[o].track&&"audio"===e[o].track.kind&&(i=!0);else{var s=e[o].getAudioTracks();if(null!==s&&s.length>0){i=!0;break}}else if("undefined"!=typeof RTCRtpReceiver&&e[o]instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e[o]instanceof RTCRtpSender)e[o].track&&"video"===e[o].track.kind&&(i=!0);else{var n=e[o].getVideoTracks();if(null!==n&&n.length>0){i=!0;break}}return i},h.changeSdpByCallConfig=function(e,t){function i(e){var t=a;switch(e){case g.MEDIADIRECTION.RECVONLY:t=m[1];break;case g.MEDIADIRECTION.SENDONLY:t=m[2];break;case g.MEDIADIRECTION.SENDRECV:t=m[0];break;case g.MEDIADIRECTION.NONE:t=m[3]}return t}function o(i,o,s){if(!(i<=-1)){var n="",a="";(d=e.indexOf(c,i+o.length))>-1?(a=e.substring(i,d),n=e.substring(d)):a=e.substring(i);for(var r=0;r<m.length;r++){a.indexOf(m[r])>=0&&(a=a.replace(m[r],s))}var l=t.pkgInstance.trickleIceMode;"full"!==l&&"half"!==l||(a.indexOf("ice-options:google-ice")>0?a=a.replace(/ice-options:google-ice/g,"ice-options:trickle"):a.indexOf("ice-options:trickle")<0&&(a+="a=ice-options:trickle\r\n")),e=e.substring(0,i)+a+n}}var s,n,a="a=inactive",r="m=video",l="m=audio",c="m=",d=-1,u=t.callConfig.audioConfig,h=t.callConfig.videoConfig,m=[];return m[0]="a=sendrecv",m[1]="a=recvonly",m[2]="a=sendonly",m[3]=a,(n=e.indexOf(l))>-1&&o(n,l,i(u)),(s=e.indexOf(r))>-1&&o(s,r,i(h)),e},h.getLocalStreams=function(e){return e?"function"==typeof e.getLocalStreams?e.getLocalStreams():u.browser.isFirefox?e.localStreams:void 0:[]},h.getRemoteStreams=function(e){return e?"function"==typeof e.getRemoteStreams?e.getRemoteStreams():u.browser.isFirefox?e.remoteStreams:void 0:[]},h.invokeCallError=function(t,i,o){if(t.onCallError){var s=new e.ErrorInfo(i,o);try{t.onCallError(s)}catch(e){p.error("The callback function 'Call.onCallError()' exception:"+e)}}},u.rtcHelper=h,e}(live||{}),live=function(e){function t(){this.value,this.statistics={peak:0,bottom:0,count:0,sdv:0,mean:0,oldMean:0,S:0,oldS:0}}var i=e._private=e._private||{},o={},s=i.wscConst,n=i.wscUtils,a=e.getLogger();var r=function(i,r,u,h,g,m,p,v){"use strict";if(m&&(this.extHeaders=m),g){var S=o.rehydrateSession(i,r,u,h,g,m,p,v);if(null==S){var _="Failed to reload session data.",f=new n.ErrorInfo(s.ERRORCODE.RESTORE_FAILED,_);a.warn(_);try{h&&h(f)}catch(e){a.error("onError callback exception: "+e)}}return a.debug("Completed session rehydration: "+g),S}this.webSocketUri=r,this.wscWebsocket=null,this.sessionId=null,this.userName=i,this.sessionState=s.SESSIONSTATE.NONE,this.timeToInitWebSocket=0;try{o.initWebSocket(this)}catch(e){if(a.error("Websocket initialization exception: "+e),h){f=new n.ErrorInfo(s.ERRORCODE.WEBSOCKET_ERROR,e);try{h(f)}catch(e){a.error("The callback function 'Session.failureCallback()' returned the exception: "+e)}}}this.subSessionsMap=new e.Map,this.unACKedMsgQueue=new l,this.successCallback=u,this.failureCallback=h,this.lastOutboundSeq=0,this.lastInboundSeq=0,this.lastUnHandledInboundReq=null,this.lastUnACKedInboundMsg=null,this.hostIPs=[],this.onSessionStateChange=null,this.packagesMap=new e.Map,this.sendBuffer=[],this.sendTimer=null,this.lastSendTime=null,this.firstSendTime=null,this.sendMessageCount=0,this.sendMessageAccumulatedSize=0,this.maxMsgSendRate=30,this.sendTimerValue=1e3,this.sendMsgIntervalTimer=null,this.highTrafficSendRateCount=0,this.highTrafficLowIntervalCount=0,this.disableSendBuffer=!1,this.busyPingInterval=3e3,this.idlePingInterval=1e4,this.pingMessage="ping",this.pongMessage="pong",this.pingInterval=this.idlePingInterval,this.reConnectInterval=2e3,this.ackInterval=6e4,this.reConnectTime=6e4,this.retryCount=2,this.retryTimes=0,this.timeToLive=0,this.hibernateSuccessCallback=null,this.hibernateFailureCallback=null,this.onHibernationRequest=null,this.iceServerListFromServer=[],this.iceServerAccessToken=null,p&&(this.extPayloads=p,this.timeToLive=3600,this.clientCapability=new c),this.sessionTimeOut=null,this.reConnectTimeOut=null,this.pingTimeOut=null,this.periodlyACKChecker=new function(e){var t,i,o=e,r=this;this.start=function(){if(o.sessionState===s.SESSIONSTATE.CONNECTED){t&&window.clearTimeout(t);var e=o.lastUnACKedInboundMsg;if(e){var l=e.control.sequence;l&&l!==i&&(typeof e!==n.Message&&(e=new n.Message(e)),e.ack(o),a.debug("PeriodlyACKChecker ack the message in sequence "+l),i=l)}t=window.setTimeout(function(){r.start()},o.ackInterval)}else r.stop()},this.stop=function(){t&&(a.debug("Stop PeriodlyACKChecker"),window.clearTimeout(t))}}(this),this.iceServerEnquirer=new function(e){var t,i,n=e,r=[],l=!1,c=function(){try{r.forEach(function(e){e()})}catch(e){a.warn("Caught error running after Ice Enquiry Callbacks: ",e)}r=[],l=!1};this.stop=function(){t&&(a.debug("Stop IceServerEnquiry Timer"),window.clearTimeout(t),t=void 0)},this.scheduleIceEnquiry=function(e){t&&window.clearTimeout(t),t=window.setTimeout(function(){a.debug("Enquiring...."),o.sendIceEnquiry(n)},Math.max(e,0))},this.doIceEnquiry=function(e){if(r.push(e),!l){l=!0;var t=this,s=t.handleIceEnquiry;t.handleIceEnquiry=function(e,o){t.handleIceEnquiry=s,s(e,o),clearTimeout(i),c()},a.debug("Enquiring...."),o.sendIceEnquiry(n),i=setTimeout(function(){a.warn("Timeout of IceServerEnquirer is triggered..."),t.handleIceEnquiry=s,c()},3e3)}},this.handleIceEnquiry=function(e,t){var i=t.control.type;if(i===s.TYPE.RESPONSE){a.debug("Receive Response for ICE-Enquiry "),e.iceServerListFromServer=[];var o=t.payload.iceServers,n=-1;if(o)for(var r=0;r<o.length;r++){var l="",c="",d=-1;if(o[r].username&&(l=o[r].username,e.iceServerAccessToken=l),o[r].credential&&(c=o[r].credential),o[r].lifetime&&(d=1e3*o[r].lifetime),o[r].urls)for(var u=0;u<o[r].urls.length;u++){var h={urls:o[r].urls[u],username:l,credential:c};a.debug("Retrieve an ICE Server from response: "+JSON.stringify(h)),e.iceServerListFromServer.push(h),d>0&&(d<n||n<=0)&&(n=d)}}n<=0?a.warn("The minimum lifetime retrieved from response is "+n+" ms, so stop ICE Enquiry"):(n=2*n/3,a.debug("Schedule an ICE Enquiry in "+n+" ms"),e.iceServerEnquirer.scheduleIceEnquiry(n),e.iceServerEnquiryLifetime=n,e.iceServerEnquiryNextTime=Date.now()+n),e.saveToStorage()}else i===s.TYPE.ERROR&&a.error("Receive an error for ICE-Enquiry Request");if(a.debug("session.callUpdateOnIceResponse="+e.callUpdateOnIceResponse),e.callUpdateOnIceResponse){var g=e.getAllSubSessions();if(g&&g.length>0)for(r=0;r<g.length;r++){var m=g[r],p=m.peerConnection,v=m.getStreams();if(!p||"relay"!==p.sessionType&&"relayed"!==p.sessionType){if(v)for(a.debug("Updating conversation due to Relay Failure"),r=0;r<v.length;r++){var S=v[r];"relayed"!==S.call.sessionType&&"relay"!==S.call.sessionType||S.update(S.getStreamOptions())}}else a.debug("Updating the call due to Relay Failure"),e.allowRetry=!0,m.update(m.callConfig)}e.callUpdateOnIceResponse=!1}}}(this),this.iceServerEnquiryLifetime=0,this.iceServerEnquiryNextTime=0,this.connectSubSessionId=null,this.lastActiveTime=null,this.pingSentTime=null,this.expectedTimeLimitToReceivePong=3e3,this.callUpdateOnIceResponse=!1,this.allowRetry=!1,this.enableVerbose=!1,this.isGetNetworkStatusInProgress=!1,this.getNetworkStatusListeners={successCBs:[],errorCBs:[]},this.networkStatusFactor=new t,this.throughputFactor=new t,this.avgLatencyFactor=new t,this.subscribeErrorCallback=null,this.subscribeNotifyCallback=null,this.__externalAuditData__=[],new d(this),this.toJSON=function(){return{sessionId:this.sessionId,userName:this.userName,unACKedMsgQueue:this.unACKedMsgQueue,lastOutboundSeq:this.lastOutboundSeq,lastInboundSeq:this.lastInboundSeq,lastUnHandledInboundReq:this.lastUnHandledInboundReq,subSessionsMap:this.subSessionsMap,packagesMap:this.packagesMap,iceServerListFromServer:this.iceServerListFromServer,iceServerEnquiryNextTime:this.iceServerEnquiryNextTime}}};r.prototype={getAllSubSessions:function(){for(var e=[],t=this.subSessionsMap.values(),i=0,o=0;o<t.length;o++)for(var s=t[o].values(),n=0;n<s.length;n++)e[i]=s[n],i++;return e},getSubSessionsByPackageType:function(e){return this.subSessionsMap.get(e)},putSubSession:function(t,i,s){var n=this.subSessionsMap.get(t);n||(n=new e.Map,this.subSessionsMap.put(t,n)),n.put(i,s),o.updateActivityMarker(this),o.schedulePing(this,!1)},getSubSession:function(e){"use strict";for(var t=null,i=this.subSessionsMap.values(),o=0;o<i.length&&null==(t=i[o].get(e));o++);return t},removeSubSession:function(e){"use strict";a.debug("Removing sub-session: "+e);for(var t=this.subSessionsMap.values(),i=0;i<t.length;i++)t[i].remove(e);var s=this.getAllSubSessions();s&&0===s.length&&o.updateActivityMarker(this),this.saveToStorage()},saveToStorage:function(){if(this.sessionState!==s.SESSIONSTATE.CLOSED&&this.sessionState!==s.SESSIONSTATE.FAILED&&this.sessionState!==s.SESSIONSTATE.RELOADING)if(i.browser.supportSessionStorage)if(this.sessionId)try{sessionStorage.setItem(this.sessionId,JSON.stringify(this));var t=JSON.parse(sessionStorage.getItem(this.sessionId));a.debug("saved ..."),a.debug(t)}catch(t){a.error("Failed to save. Error = "+t),o.invokeSessionError(this,e.ERRORCODE.SAVE_FAILED,t)}else a.debug("Not saving. No sessionId");else a.warn("Sorry, web storage is not supported...");else a.debug("Do not save session data with session state: "+this.sessionState)},setSessionState:function(e){"use strict";this.sessionState=e,null!=this.sessionId&&this.saveToStorage(),this.onSessionStateChange&&this.onSessionStateChange(e)},close:function(){o.clearSession(this),this.wscWebsocket&&(this.wscWebsocket.close(1e3,"Normal close"),this.wscWebsocket=null,a.info("Websocket normally closed")),this.setSessionState(s.SESSIONSTATE.CLOSED)},getPackage:function(e){return this.packagesMap.get(e)},registerPackage:function(t){var i=t.packageType;if(!i)throw"There is no packageType defined in the package.";try{if(this.packagesMap.get(i))throw"Duplicated package type in Session.";this.packagesMap.put(i,t);var o=new e.Map;this.subSessionsMap.put(i,o)}catch(e){a.error("Package registration failed:"+e)}},getUserName:function(){return this.userName},getSessionId:function(){return this.sessionId},getLastOutboundSeq:function(){return this.lastOutboundSeq},setIdlePingInterval:function(e){this.idlePingInterval=e<1e3?1e3:e},setBusyPingInterval:function(e){this.busyPingInterval=e<1e3?1e3:e},setPingPongMessages:function(e,t){this.pingMessage=e,this.pongMessage=t},setReconnectInterval:function(e){this.reConnectInterval=e},setReconnectTime:function(e){this.reConnectTime=e},startSendTimer:function(){var e=this;this.sendTimer=setTimeout(function(){e.sendTimerFn()},this.sendTimerValue)},sendTimerFn:function(){if(this.sendTimerValue=1e3,this.wscWebsocket){if(this.wscWebsocket&&this.sendBuffer.length>0){var e=JSON.stringify(this.sendBuffer[this.sendBuffer.length-1]).length;if(0===this.wscWebsocket.bufferedAmount){var t="Sent from buffer; message ["+this.sendBuffer.length+"]";this._sendMessage(this.sendBuffer.shift(),t),this.sendTimerValue=this.getSendTimerValue(!1,e)}else this.sendTimerValue=this.getSendTimerValue(!1,this.wscWebsocket.bufferedAmount)}else this.sendTimerValue=1e3;this.startSendTimer()}else this.startSendTimer&&"function"==typeof this.startSendTimer&&this.startSendTimer()},getSendTimerValue:function(e,t){if(e)return this.highTrafficSendRateCount>0?(1===this.highTrafficSendRateCount&&a.debug("Applying delay for high traffic (rate count)"),this.defaultSendInterval):this.highTrafficLowIntervalCount>5?(6===this.highTrafficLowIntervalCount&&a.debug("Applying delay for extended high traffic (interval count)"),2*this.defaultSendInterval):this.defaultSendInterval;var i=50;return t>5e4?i=100:t>1e5?i=200:t>1e6?i=300:t>15e5&&(i=400),i},stopSendTimer:function(){this.sendTimer&&clearInterval(this.sendTimer),this.sendTimer=null},resetSendData:function(){this.sendMsgIntervalTimer&&(clearInterval(this.sendMsgIntervalTimer),this.sendMsgIntervalTimer=null),this.sendTimer&&(clearTimeout(this.sendTimer),this.sendTimer=null),this.defaultSendInterval=Math.floor(1e3/this.maxMsgSendRate),this.sendInterval=null,this.lastSendTime=null,this.firstSendTime=null,this.highTrafficSendRateCount=0,this.highTrafficLowIntervalCount=0,this.sendMessageCount=0,this.sendMessageAccumulatedSize=0},sendBufferConfig:function(e,t){void 0!==e&&(this.disableSendBuffer=!e,this.maxMsgSendRate=t||30),console.log("configSendBuffer:"),console.log("       Status = "+(this.disableSendBuffer?"Send Buffer DISABLED":"Send Buffer Enabled")),console.log(" Max Send Rate = "+this.maxMsgSendRate)},sendMessage:function(e){if(this.disableSendBuffer)return void this._sendMessage(e,"Send Buffer disabled. Sent immediately");var t=this.wscWebsocket?this.wscWebsocket.bufferedAmount:null;const i=this.calculateSendMessageTrafficRate(JSON.stringify(e).length);if(0!==t||0!==this.sendBuffer.length||i){this.sendBuffer.push(e);const o=null===t?1e3:this.getSendTimerValue(i,t);a.debug("wsc-sendMessage: Delaying send by "+o+"ms. Buffered messages: "+this.sendBuffer.length),this.sendTimerValue=o}else this._sendMessage(e,"Sent immediately")},startSendMessageIntervalTimer:function(){const e=this;null===this.sendMsgIntervalTimer&&(a.debug("wsc-startSendMessageIntervalTimer"),this.sendMsgIntervalTimer=setInterval(function(){e.sendMessageCount>=e.maxMsgSendRate&&a.debug("Message Send Rate "+e.sendMessageCount+"/s exceeds maximum "+e.maxMsgSendRate+"/s"),(e.sendMessageCount>0||e.sendMessageAccumulatedSize>0)&&(a.debug("wsc-sendMessage Traffic Rate"),a.debug("Messages per second: "+e.sendMessageCount),a.debug("Bytes per second: "+e.sendMessageAccumulatedSize)),e.sendMessageCount=0,e.sendMessageAccumulatedSize=0,e.firstSendTime=null,e.highTrafficSendRateCount=0,e.highTrafficLowIntervalCount=0},1e3))},calculateSendMessageTrafficRate:function(e){const t=Date.now();var i=!1,o=!1;if(this.sendMessageCount++,this.sendMessageAccumulatedSize+=e,null===this.firstSendTime&&(this.firstSendTime=t),this.startSendMessageIntervalTimer(),null!==this.lastSendTime){this.sendInterval=t-this.lastSendTime;const e=Math.ceil(this.defaultSendInterval/2),o=e<=3?3:e;this.sendInterval<=o&&(a.debug("xxx---\x3e Message send interval too small"),i=!0,this.highTrafficLowIntervalCount++)}return this.lastSendTime=t,this.sendMessageCount>this.maxMsgSendRate&&(a.debug("xxx---\x3e Message send rate too high"),o=!0,this.highTrafficSendRateCount++),i||o},_sendMessage:function(e,t){"use strict";var i,o=e.control.package_type,n=this.sessionId,r=e.control.type;if(n&&(e.control.session_id=n),e.control.version=s.PROTOCOL_VERSION,e.isReconnect()||r!==s.TYPE.ACK&&(e.control.sequence=this.lastOutboundSeq+1),i=JSON.stringify(e),this.sessionState===s.SESSIONSTATE.CLOSED||this.sessionState===s.SESSIONSTATE.FAILED)throw a.debug("Cannot send message; session state: "+this.sessionState),"Cannot send message; session state: "+this.sessionState;if(this.sessionState===s.SESSIONSTATE.CONNECTED||o===s.PACKAGE.REGISTER)try{this.wscWebsocket&&this.wscWebsocket.bufferedAmount+i.length>=2147483647&&(a.warn("wscWebsocket.bufferedAmount = "+this.wscWebsocket.bufferedAmount),a.debug("Exceeds network.websocket.max-message-size 2147483647 for Firefox")),this.wscWebsocket.send(i);var l=t?" "+t:"";this.wscWebsocket&&a.debug("wsc-sendMessage: ("+this.wscWebsocket.bufferedAmount+")"+l),a.debug("Session: "+n+", Sending message: "+JSON.stringify(e,null,2))}catch(e){a.error("Received an exception when sending message: "+e)}e.isACK()||e.isReconnect()||this.lastOutboundSeq++,a.debug("Send message - lastInboundSeq = "+this.lastInboundSeq+", lastOutboundSeq = "+this.lastOutboundSeq),this.unACKedMsgQueue.addMessage(e),(e.isFinalResponse()||e.isError()||"complete"===e.header.action)&&(this.lastUnHandledInboundReq&&this.lastUnHandledInboundReq.control.sequence<=e.control.ack_sequence&&(this.lastUnHandledInboundReq=null),this.lastUnACKedInboundMsg&&this.lastUnACKedInboundMsg.control.sequence===e.control.ack_sequence&&(this.lastUnACKedInboundMsg=null)),this.saveToStorage()},reSendMessage:function(e){var t=JSON.stringify(e);try{this.wscWebsocket.send(t),a.debug("Re-send message: "+JSON.stringify(e,null,4))}catch(e){a.error("Received an exception when re-sending message: "+e)}this.unACKedMsgQueue.addMessage(e),a.debug("Re-send message - lastInboundSeq = "+this.lastInboundSeq+", lastOutboundSeq = "+this.lastOutboundSeq),this.saveToStorage()},genNewCorrelationId:function(){return s.CONSTCS.CLIENT+(this.getLastOutboundSeq()+1)},generateSubSessionId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=window.crypto.getRandomValues(new Uint8Array(1))[0]%16|0;return("x"===e?t:3&t|8).toString(16)})},hibernate:function(t,i,s){var n=this.getAllSubSessions();t&&t>0&&(this.timeToLive=t),this.hibernateSuccessCallback=i,this.hibernateFailureCallback=s,o.updateActivityMarker(this),n&&n.length>0?o.invokeHibernateError(this,e.ERRORCODE.BUSY_EVERYWHERE,"session on busy"):o.sendHibernate(this,t)},getNetworkStatus:function(e,t){var i=this;if(i.getNetworkStatusListeners.successCBs.push(e),i.getNetworkStatusListeners.errorCBs.push(t),!0!==i.isGetNetworkStatusInProgress)if(0!==this.iceServerListFromServer.length){i.isGetNetworkStatusInProgress=!0;var o={iceServers:[].concat(this.iceServerListFromServer)},r=function(e){a.warn("Error happens when get network status: "+e);try{i.getNetworkStatusListeners.errorCBs.forEach(function(e){"function"==typeof e&&e("Cannot get network status.")})}finally{i.getNetworkStatusListeners.successCBs=[],i.getNetworkStatusListeners.errorCBs=[],i.isGetNetworkStatusInProgress=!1}},l=o.iceServers;Array.isArray(l)&&(o.iceServers=[].concat(l.filter(function(e){return e.urls&&(0===e.urls.toLowerCase().indexOf("turn:")||0===e.urls.toLowerCase().indexOf("turns:"))})));try{new n.DataChannelThroughput_CallbackBased(o,4,8,!0).test(function(e,t,o,r){var l=1,c={};try{if(e>=0){if(c.throughput=e,l=e<=25?1:e>25&&e<=150?2:e>150&&e<=300?3:e>300&&e<=1e3?4:5,void 0!==t&&void 0!==o&&void 0!==r&&(t>1e3&&(l=1),c.avgLatency=t,c.maxLatency=o,c.minLatency=r),i.getNetworkStatusListeners.successCBs.forEach(function(e){"function"==typeof e&&e(l,c)}),i.networkStatusFactor.put(l),i.throughputFactor.put(e),i.avgLatencyFactor.put(t),i.enableVerbose&&i.sessionState===s.SESSIONSTATE.CONNECTED){var d=new n.Message;d.control.type=s.TYPE.MESSAGE,d.control.package_type=s.PACKAGE.REGISTER,d.control.subsession_id=i.connectSubSessionId,d.control.session_id=i.sessionId,d.control.ack_sequence=i.lastInboundSeq,d.header.initiator=i.userName,d.header.action=s.ACTION.AUDIT,d.header.module="WEB";var u=null,h=i.getSubSessionsByPackageType(s.PACKAGE.CONVERSATION);h&&h.size()>0&&(u=h.values()[0].conversationKey),u&&(d.header.conversation_key=u),d.header.access_token=i.iceServerAccessToken;var g={network_test:{mos:l,bandwidth:e,rtt:t}};d.payload={audit_data:g},i.sendMessage(d)}}else i.getNetworkStatusListeners.errorCBs.forEach(function(e){"function"==typeof e&&e("Throughput is less than zero.")})}catch(e){a.error("Error happens when getNetworkStatus..."+e),i.getNetworkStatusListeners.errorCBs.forEach(function(e){"function"==typeof e&&e("Throughput is less than zero.")})}finally{i.getNetworkStatusListeners.successCBs=[],i.getNetworkStatusListeners.errorCBs=[],i.isGetNetworkStatusInProgress=!1}},r)}catch(e){a.info("Network test failed..",e),r(e)}}else a.warn("ICE servers is not ready. The callbacks will be invoked by next effective invocation");else a.warn("getNetworkStatus is already in progress.")},getNetworkTestStatisticsData:function(){return{mos:this.networkStatusFactor.toJSON(),bandwidth:this.throughputFactor.toJSON(),rtt:this.avgLatencyFactor.toJSON()}},setTimeToLive:function(e){e&&e>0&&(this.timeToLive=e)},suspend:function(){return this.wscWebsocket&&(this.wscWebsocket.close(3001,"Abnormal close"),this.wscWebsocket=null,a.info("Websocket abnormal closed")),this.setSessionState(s.SESSIONSTATE.SUSPENDED),i.browser.supportSessionStorage?sessionStorage.getItem(this.sessionId):(a.warn("The browser does not support SessionStorage, there is no stateInfo stored."),null)},subscribeToEntity:function(e,t,i,s){return this.subscribeErrorCallback=i,this.subscribeNotifyCallback=s,o.sendSubscribe(this,null,e,t)},unsubscribeFromEntity:function(e){o.sendSubscribe(this,e.subsession_id,e.entity,0)},logEventTimestamp:function(e,t){var i={};i[e]=t||Date.now(),this.__externalAuditData__.push(i)}},t.prototype={put:function(e){return void 0===e||isNaN(e)?void(this.value=void 0):e<0?void(this.value=e):(e*=1,this.value=e,this.statistics.count++,1===this.statistics.count?(this.statistics.peak=e,this.statistics.bottom=e):(this.statistics.peak<e&&(this.statistics.peak=e),this.statistics.bottom>e&&(this.statistics.bottom=e)),void(1==this.statistics.count?this.statistics.oldMean=this.statistics.mean=e:(this.statistics.mean=this.statistics.oldMean+(e-this.statistics.oldMean)/this.statistics.count,this.statistics.S=this.statistics.oldS+(e-this.statistics.oldMean)*(e-this.statistics.mean),this.statistics.oldMean=this.statistics.mean,this.statistics.oldS=this.statistics.S,this.statistics.sdv=this.statistics.count>1?Math.sqrt(this.statistics.S/(this.statistics.count-1)):0)))},toJSON:function(){return{peak:void 0===this.statistics.peak?void 0:this.statistics.peak%1==0?this.statistics.peak:1*this.statistics.peak.toFixed(2),bottom:void 0===this.statistics.bottom?void 0:this.statistics.bottom%1==0?this.statistics.bottom:1*this.statistics.bottom.toFixed(2),count:this.statistics.count,sdv:void 0===this.statistics.sdv?void 0:this.statistics.sdv%1==0?this.statistics.sdv:1*this.statistics.sdv.toFixed(2),mean:void 0===this.statistics.mean?void 0:this.statistics.sdv%1==0?this.statistics.sdv:1*this.statistics.mean.toFixed(2)}}},o.handleWsOpen=function(e){function t(){var t=e.getAllSubSessions();if(t&&t.length>0)for(var n=0;n<t.length;n++){var r=t[n],l=r.peerConnection;if(l){a.debug("Cleanup call between caller ["+r.getCaller()+"] and callee ["+r.getCallee()+"]");var c=s.getLocalStreams(l),d=s.getRemoteStreams(l);if(r.temporarySavedStreams=c,c)for(n=0;n<c.length;n++)s.removeLocalStream(r,c[n]);if(d)for(n=0;n<d.length;n++)i.browser.isFirefox||l.removeStream(d[n]);"closed"!==l.iceConnectionState&&(l.close(),r.peerConnection=null)}}o.sendRegister(e,null)}a.debug("Session opened with id: "+e.sessionId+", Old IPs: "+JSON.stringify(e.hostIPs,null,2)),e.resetSendData(),e.startSendTimer();var s=i.rtcHelper;s.collectHostIPsByPc(function(i){a.debug("New IPs: "+JSON.stringify(i,null,2)+"\nOld IPs: "+JSON.stringify(e.hostIPs,null,2)),0!==e.hostIPs.length?function(e,t){for(var i=!0,o=0;o<t.length;o++){var s=t[o];if(e.indexOf(s)>-1){i=!1;break}}return i}(e.hostIPs,i)?(a.debug("Host IPs have changed"),e.clientIpNotChangedAfterReconnect=!1,t()):(a.debug("Host IPs have NOT changed"),e.clientIpNotChangedAfterReconnect=!0,o.sendRegister(e,null)):o.sendRegister(e,null),e.hostIPs=i,a.debug("New IPs: "+JSON.stringify(e.hostIPs,null,2))},function(){a.error("Failed to get host IPs."),t()})},o.handleWsClose=function(t,i){a.debug("Session closed with id: "+t.sessionId),t.stopSendTimer(),t.resetSendData(),o.clearWebSocket(t.wscWebsocket,i),t.wscWebsocket=null,t.sessionState===s.SESSIONSTATE.CONNECTED?(t.periodlyACKChecker.stop(),t.iceServerEnquirer.stop(),t.setSessionState(s.SESSIONSTATE.RECONNECTING),window.clearTimeout(t.pingTimeOut),t.sessionTimeOut=window.setTimeout(function(){a.warn("reconnect timeout."),o.clearSession(t),t.setSessionState(s.SESSIONSTATE.FAILED),window.clearTimeout(t.reConnectTimeOut)},t.reConnectTime),t.reInitTimes=0,o.reInitWebSocket(t)):t.sessionState===s.SESSIONSTATE.RELOADING?o.invokeSessionError(t,e.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror"):t.sessionState===s.SESSIONSTATE.NONE&&(o.clearSession(t),o.invokeSessionError(t,e.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror"))},o.reInitWebSocket=function(t){a.debug("Session reinitialised with id: "+t.sessionId);var i=t.sessionState;if(a.debug("reInitWebSocket with state: "+i),i!==s.SESSIONSTATE.CONNECTED&&i!==s.SESSIONSTATE.CLOSED){if(t.reConnectTimeOut&&window.clearTimeout(t.reConnectTimeOut),t.sessionTimeOut&&window.clearTimeout(t.sessionTimeOut),!t.__isDAE__&&(t.reInitTimes+=1,t.reInitTimes>10))return o.clearSession(t),void o.invokeSessionError(t,e.ERRORCODE.WEBSOCKET_ERROR,"websocket onerror");o.initWebSocket(t),t.reConnectTimeOut=window.setTimeout(function(){o.reInitWebSocket(t)},t.reConnectInterval)}},o.schedulePing=function(e,t){if(e.sessionState===s.SESSIONSTATE.CONNECTED){e.pingTimeOut&&window.clearTimeout(e.pingTimeOut),t&&o.sendPing(e);var i=e.getAllSubSessions();i&&i.length>0?e.pingInterval=e.busyPingInterval:e.pingInterval=e.idlePingInterval,e.pingInterval>0&&(e.pingTimeOut=window.setTimeout(function(){o.schedulePing(e,!0)},e.pingInterval))}},o.sendPing=function(e){try{null!=e.wscWebsocket&&(e.wscWebsocket.send(e.pingMessage),e.pingSentTime=Date.now(),o.isAlive(e))}catch(e){a.debug("can not send ping now: "+e)}},o.isAlive=function(e){setTimeout(function(){var t=e.lastActiveTime-e.pingSentTime;t<0||t>e.expectedTimeToGetResponseFromServer?(e.retryTimes++,a.debug("The ping-pong retryTimes/retryCount: "+e.retryTimes+"/"+e.retryCount),e.retryTimes===e.retryCount&&(e.retryTimes=0,a.warn("Client reconnecting..."),o.handleWsClose(e,!0))):e.retryTimes=0},e.expectedTimeLimitToReceivePong)},o.updateActivityMarker=function(e){e.lastActiveTime=Date.now()},o.clearSession=function(e,t){var o=1e3,s=[];e.packagesMap&&(s=e.packagesMap.values());for(var a=0;a<s.length;a++)s[a].clear&&s[a].clear();t&&(o=t),1e3==o&&i.browser.supportSessionStorage&&sessionStorage&&sessionStorage.removeItem(e.sessionId),e.periodlyACKChecker&&e.periodlyACKChecker.stop(),e.iceServerEnquirer&&e.iceServerEnquirer.stop(),n.setsessionid("")};var l=function(){var e=null,t=null,i=new n.Queue;this.toJSON=function(){return{lowerSeq:e,upperSeq:t,msgQueue:i}},this.getLowerSeq=function(){return e},this.setLowerSeq=function(t){e=t},this.getUpperSeq=function(){return t},this.setUpperSeq=function(e){t=e},this.getMsgQueue=function(){return i},this.addMessage=function(o){if(!o.isACK()&&!o.isReconnect()){var s=o.control.sequence;null==e&&(e=s),t=s,i.enqueue(o),a.debug("addMessage - queue size = "+i.length()+", cslw: "+e+", csuw: "+t)}},this.ackMessages=function(o){if(a.debug("ackMessages - (before) ackSeq = "+o+", queue size = "+i.length()+", cslw = "+e+", csuw = "+t),0!==i.length()&&o>=e&&o<=t){for(var s=i.dequeue(),n=s.control.sequence;s&&n<o;)n=(s=i.dequeue()).control.sequence;return a.debug("ackMessages - queued message sequence = "+n),null==i.peek()?(e=t+1,a.debug("ackMessages - Reset cslw to csuw+1 = "+e)):(s=i.peek(),e=s.control.sequence,a.debug("ackMessages - Reset cslw to incoming seq = "+e)),a.debug("ackMessages - (after) queue size = "+i.length()+", cslw = "+e+", csuw = "+t),!0}return!1},this.reSendMessage=function(o,s){for(var n=i.length(),r=0;r++<n;){(l=i.dequeue()).control.sequence>=s+1?(l.control.sequence=o.lastOutboundSeq+1,o.reSendMessage(l),o.lastOutboundSeq=l.control.sequence):a.debug("skip message: "+JSON.stringify(l))}if(null==i.peek())e=t+1,a.debug("reSendMessage - Reset cslw to csuw+1 = "+e);else{var l=i.peek();e=l.control.sequence,a.debug("reSendMessage - Reset cslw to incoming seq = "+e)}a.debug("reSendMessage - cslw: "+this.getLowerSeq()+", csuw: "+this.getUpperSeq()+", queue size = "+i.length())}};o.handleWsData=function(e,t){"use strict";if(o.updateActivityMarker(t),e===t.pongMessage);else{o.schedulePing(t,!1);var i;i="string"==typeof e?JSON.parse(e):e,a.debug("Session: "+t.sessionId+", Received data from server: "+JSON.stringify(i,null,2));var r=new n.Message(i),l=null,c=null,d=null,u=null,h=null;if(r&&(l=r.control.sequence,c=r.control.ack_sequence,d=r.control.type,u=r.header.action,h=r.control.package_type),l&&(t.lastInboundSeq=l),c?(t.unACKedMsgQueue.ackMessages(c),a.debug("handleWsData: lastInboundSeq = "+t.lastInboundSeq+", lastOutboundSeq = "+t.lastOutboundSeq)):d===s.TYPE.RESPONSE&&null!=l&&(t.unACKedMsgQueue.ackMessages(l),a.debug("handleWsData: lastInboundSeq = "+t.lastInboundSeq+", lastOutboundSeq = "+t.lastOutboundSeq)),h||(h=s.PACKAGE.REGISTER),d===s.TYPE.REQUEST&&(t.lastUnHandledInboundReq=r),t.lastUnACKedInboundMsg=r,u===s.ACTION.SHUTDOWN&&null!=t.lastUnHandledInboundReq)t.lastUnHandledInboundReq.control.subsession_id===r.control.subsession_id&&(t.lastUnHandledInboundReq=null);var g=t.getPackage(h);g?g.onMessage(r):a.warn("package_type '"+h+"' is not defined!"),t.saveToStorage()}},o.invokeSessionError=function(t,i,o){if(t.failureCallback){var s=new e.ErrorInfo(i,o);try{t.failureCallback(s)}catch(e){a.error("The callback function 'Session.failureCallback()' returned an exception: "+e)}}},o.invokeHibernateError=function(t,i,o){if(t.hibernateFailureCallback){var s=new e.ErrorInfo(i,o);try{t.hibernateFailureCallback(s)}catch(e){a.error("The callback function 'Session.hibernateFailureCallback()' returned an exception: "+e)}}},o.initWebSocket=function(e){"use strict";if(null==e.wscWebsocket){a.debug("creating the websocket..."),e.timeToInitWebSocket=(new Date).getTime();try{e.wscWebsocket=new WebSocket(e.webSocketUri,"webrtc.oracle.com")}catch(e){throw a.debug("sessionHelper.initWebSocket(): new WebSocket() returns error: ",e),new Error("sessionHelper.initWebSocket(): new WebSocket() returns error: "+JSON.stringify(e))}if(null==e.wscWebsocket)throw new Error("sessionHelper.initWebSocket(): new WebSocket() returns null.");e.wscWebsocket.onopen=function(t){e.timeToInitWebSocket=(new Date).getTime()-e.timeToInitWebSocket,a.debug("websocket event handler onopen is invoked."),o.handleWsOpen(e)},e.wscWebsocket.onclose=function(t){a.debug("websocket event handler onclose is invoked.",t),o.handleWsClose(e)},e.wscWebsocket.onmessage=function(t){t.data&&o.handleWsData(t.data,e)},e.wscWebsocket.onerror=function(t){a.info("websocket onerror",t),e.stopSendTimer()}}},o.clearWebSocket=function(e,t){if(null!=e){a.debug("Closing web socket",e),e.onopen=null,e.onclose=null,e.onmessage=null,e.onerror=null;var i=1e3,o="Normal close";t&&(i=3001,o="Abnormal close"),a.debug("Closing web socket with code: "+i,e),e.close(i,o)}},o.sendRegister=function(e,t){"use strict";var i=new n.Message;if(i.control.type=s.TYPE.REQUEST,i.control.package_type=s.PACKAGE.REGISTER,e.userName&&(i.header.initiator=e.userName,i.header.target=e.userName),i.header.action=s.ACTION.CONNECT,t&&(i.header.authorization=t),e.extHeaders&&i.addExtHeaders(e.extHeaders),e.extPayloads&&i.addExtPayloads(e.extPayloads),e.clientCapability){var o={family:e.clientCapability.family,version:e.clientCapability.version};if(i.payload.capability)for(var a in o){var r=o[a];i.payload.capability[a]||(i.payload.capability[a]=r)}else i.payload.capability=o}e.sessionId?t?e.sendMessage(i):(i.header.cslr=e.lastInboundSeq,i.header.cslw=e.unACKedMsgQueue.getLowerSeq(),i.header.csuw=e.unACKedMsgQueue.getUpperSeq(),e.sendMessage(i)):e.sendMessage(i)},o.sendHibernate=function(e,t){"use strict";var i,o=new n.Message;o.control.type=s.TYPE.REQUEST,o.control.package_type=s.PACKAGE.REGISTER,o.control.subsession_id=e.generateSubSessionId(),o.control.correlation_id=e.genNewCorrelationId(),o.header.action=s.ACTION.HIBERNATE,i=t&&t>0?{ttl:t}:{ttl:3600},o.addExtHeaders(i),e.sendMessage(o)},o.respondHibernate=function(e,t){"use strict";var i=new n.Message;if(e.timeToLive&&e.timeToLive>0){i.control.type=s.TYPE.RESPONSE,i.header.response_code=200,i.control.message_state=s.MESSAGESTATE.FINAL;var o={ttl:e.timeToLive};i.addExtHeaders(o),i.header.response_code}else i.control.type=s.TYPE.ERROR,i.header.error_code=s.ERRORCODE.FORBIDDEN,i.header.reason="Not supported",i.header.error_code;i.control.package_type=s.PACKAGE.REGISTER,i.control.subsession_id=t.control.subsession_id,i.control.correlation_id=t.control.correlationId,i.control.ack_sequence=e.lastInboundSeq,i.header.action=s.ACTION.HIBERNATE,e.sendMessage(i)},o.sendIceEnquiry=function(e){"use strict";var t=new n.Message;t.control.type=s.TYPE.REQUEST,t.control.package_type=s.PACKAGE.REGISTER,t.control.subsession_id=e.connectSubSessionId,t.control.correlation_id=e.genNewCorrelationId(),t.header.action=s.ACTION.ICE_ENQUIRY,e.sendMessage(t)},o.rehydrateSession=function(e,t,n,l,d,u,h,g){if(g){if(d&&d!==g.sessionId)return a.error("SessionId is inconsistent, sessionId in stateInfo is: "+g.sessionId+", but the given sessionId is: "+d),null;i.browser.supportSessionStorage?sessionStorage.setItem(g.sessionId,JSON.stringify(g)):a.warn("Sorry, web storage is not supported...")}var m=o.getStoredSession(d);if(a.debug("Get stored session: "+JSON.stringify(m)),m){var p=new r(e,t,n,l);p.userName=m.userName,p.sessionId=m.sessionId,p.lastOutboundSeq=m.lastOutboundSeq,p.lastInboundSeq=m.lastInboundSeq,p.lastUnHandledInboundReq=m.lastUnHandledInboundReq,p.iceServerListFromServer=m.iceServerListFromServer,p.iceServerEnquiryNextTime=m.iceServerEnquiryNextTime,p.extHeaders=u,h&&(p.extPayloads=h,p.timeToLive=3600,p.clientCapability=new c),p.unACKedMsgQueue.setUpperSeq(m.unACKedMsgQueue.upperSeq),p.unACKedMsgQueue.setLowerSeq(m.unACKedMsgQueue.lowerSeq);for(var v=m.unACKedMsgQueue.msgQueue.array,S=0;S<v.length;S++)p.unACKedMsgQueue.getMsgQueue().enqueue(v[S]);return p.rehydrationData={subSessionsMap:m.subSessionsMap,packagesMap:m.packagesMap},p.setSessionState(s.SESSIONSTATE.RELOADING),p}return null},o.getStoredSession=function(e){if(i.browser.supportSessionStorage){var t=sessionStorage.getItem(e);if(t)return JSON.parse(t)}return null},o.removeStoredSession=function(e){i.browser.supportSessionStorage&&sessionStorage.removeItem(e)},o.handleAuthenticateChallenge=function(e,t,i,o){var r=e.authHandler,l=null,c=!0,d=0;if(r&&r.refresh)for(;c&&d<3;)try{d++;var u=t.header.authenticate,h=r.refresh(s.AUTHTYPE.SERVICE,null);if(n.checkAuthInfo(s.AUTHTYPE.SERVICE,h)){u.ha1=n.calcHa1(h,u),u.username=h.username,i(u),c=!1;break}if(null==h||""===h){l="No correct information was returned from the callback function 'AuthHandler.refresh()', or the user canceled the operation.",a.warn(l);break}l="No correct information was returned from the callback function 'AuthHandler.refresh()'. Please try again.",a.warn(l)}catch(e){l="Handle unauthenticated message error:"+e,a.error(l),c=!0}else l="No AuthHandler object was created for this Session or this AuthHandler did not implement the callback function 'AuthHandler.refresh()'!",a.warn(l);c&&o(l)},o.handleConnection=function(e,t){var i=t.control.type,r=t.getExtHeaders();if(i===s.TYPE.RESPONSE){e.sessionId&&e.sessionId!==t.control.session_id&&(a.warn("Local session id does not match remote session id - local: "+e.sessionId+", remote: "+t.control.session_id),o.clearSession(e),e.lastOutboundSeq=1,e.lastUnHandledInboundReq=null,e.lastUnACKedInboundMsg=null,e.sessionState=s.SESSIONSTATE.NONE),e.sessionId=t.control.session_id,a.debug("Retrieve verbose log flag from connect/response message : "+t.header.enable_verbose),t.header.enable_verbose&&(e.enableVerbose=t.header.enable_verbose),e.connectSubSessionId=t.control.subsession_id;var l=function(){var i=e.sessionState;switch(a.debug("doAfterIceEnquiry: session state = "+i),e.setSessionState(s.SESSIONSTATE.CONNECTED),i){case s.SESSIONSTATE.NONE:if(e.userName=t.header.initiator,n.setsessionid(e.sessionId),e.successCallback)try{e.successCallback(r)}catch(e){a.warn("The callback function 'session.successCallback()' exception:"+e)}break;case s.SESSIONSTATE.RECONNECTING:a.info("Session re-connected."),e.sessionTimeOut&&window.clearTimeout(e.sessionTimeOut),e.reConnectTimeOut&&window.clearTimeout(e.reConnectTimeOut),(m=t.header.sslr)&&m>e.unACKedMsgQueue.getUpperSeq&&e.unACKedMsgQueue.setUpperSeq(m),e.unACKedMsgQueue.reSendMessage(e,m);var l=e.packagesMap.entry,c=e.subSessionsMap.entry;for(var d in l){var u=e.getPackage(d),h=c[d];if(u&&u.onResurrect)for(var g in h.entry)u.onResurrect(h.get(g))}break;case s.SESSIONSTATE.RELOADING:a.info("Session re-loaded.");var m=t.header.sslr;if(e.successCallback)try{e.successCallback(r)}catch(e){a.warn("The callback function 'session.successCallback()' exception:"+e)}var p=e.rehydrationData;if(p){l=p.packagesMap.entry,c=p.subSessionsMap.entry;for(var d in l){u=e.getPackage(d),h=c[d];u&&u.onRehydration&&u.onRehydration(h)}}var v=e.lastUnHandledInboundReq;v&&o.handleWsData(v,e)}o.updateActivityMarker(e),o.schedulePing(e,!1),e.periodlyACKChecker.start()},c=t.header.sslr;if(void 0===c)a.debug("sslr is undefined and this is the first time register, do ice enquiry..."),e.iceServerEnquirer.doIceEnquiry(l);else{if(a.debug("sslr is NOT undefined and this is the reconnecting register, skip ice enquiry."),e.lastOutboundSeq=c,e.iceServerEnquiryNextTime>0){var d=e.iceServerEnquiryNextTime-Date.now();a.debug("Schedule ice enquiry after: "+d+"ms."),e.iceServerEnquirer.scheduleIceEnquiry(d)}l()}}else if(i===s.TYPE.ERROR){var u=t.header.error_code,h=t.header.reason,g=new n.ErrorInfo(u,h),m=function(t){t&&(h=h+"("+t+")"),a.warn("Session connect failed:"+h),o.invokeSessionError(e,u,h),e.close()};if(u===s.ERRORCODE.UNAUTHORIZED||u===s.ERRORCODE.PROXYAUTH_REQUIRED){a.debug("Authentication failed: "+g.code);o.handleAuthenticateChallenge(e,t,function(t){o.sendRegister(e,t)},m)}else m()}},o.handleHibernation=function(e){o.clearSession(e,3001),e.wscWebsocket&&(e.wscWebsocket.close(3001,"Session hibernated"),e.wscWebsocket=null,a.info("Websocket closed for hibernation")),e.lastUnHandledInboundReq=null,e.lastUnACKedInboundMsg=null,e.pingTimeOut&&window.clearTimeout(e.pingTimeOut),e.reConnectTimeOut&&window.clearTimeout(e.reConnectTimeOut),e.sessionTimeOut&&window.clearTimeout(e.sessionTimeOut),e.setSessionState(s.SESSIONSTATE.HIBERNATED)},o.sendSubscribe=function(e,t,i,o){"use strict";var a=new n.Message,r=null===t?e.generateSubSessionId():t;a.control.type=s.TYPE.REQUEST,a.control.package_type=s.PACKAGE.REGISTER,a.control.subsession_id=r,a.control.correlation_id=e.genNewCorrelationId(),a.header.action=s.ACTION.SUBSCRIBE,a.header.initiator=e.userName;var l=i.split("@"),c={tenant:l.length>1?l[1]:"unknown",entity:i,expires:o};return a.header.presence_data=c,e.sendMessage(a),{entity:i,subsession_id:r}},o.handleSubscribeResponse=function(e,t){"use strict";var i=t.control.type;if(i===s.TYPE.RESPONSE)a.debug("Subscription success");else if(i===s.TYPE.ERROR&&e.subscribeErrorCallback){var o=t.header.error_code,r=t.header.reason,l=new n.ErrorInfo(o,r);a.warn("Subscription failed: "+JSON.stringify(l));try{e.subscribeErrorCallback(l)}catch(e){a.warn("The callback function 'session.subscribeErrorCallback()' exception: "+e)}}},o.handleSubscribeNotify=function(e,t){"use strict";var i=t.header.presence_data;if(a.debug("Subscription notify: "+JSON.stringify(i)),void 0!==i&&e.subscribeNotifyCallback)try{e.subscribeNotifyCallback(i)}catch(e){a.warn("The callback function 'session.subscribeNotifyCallback()' exception: "+e)}};var c=function(){"use strict";var e,t,i,o=navigator.userAgent,s=navigator.appName,n=""+parseFloat(navigator.appVersion);o&&(-1!=(t=o.indexOf("Opera"))?(s="Opera",n=o.substring(t+6),-1!=(t=o.indexOf("Version"))&&(n=o.substring(t+8))):-1!=(t=o.indexOf("MSIE"))?(s="Microsoft Internet Explorer",n=o.substring(t+5)):-1!=(t=o.indexOf("Chrome"))?(s="Chrome",n=o.substring(t+7)):-1!=(t=o.indexOf("Safari"))?(s="Safari",n=o.substring(t+7),-1!=(t=o.indexOf("Version"))&&(n=o.substring(t+8))):-1!=(t=o.indexOf("Firefox"))?(s="Firefox",n=o.substring(t+8)):(e=o.lastIndexOf(" ")+1)<(t=o.lastIndexOf("/"))&&(s=o.substring(e,t),n=o.substring(t+1),s.toLowerCase()==s.toUpperCase()&&(s=navigator.appName)),-1!=(i=n.indexOf(";"))&&(n=n.substring(0,i)),-1!=(i=n.indexOf(" "))&&(n=n.substring(0,i)),n=n.replace(",",".")),this.family=s,this.version=n},d=function(e){"use strict";this.session=e,this.packageType=s.PACKAGE.REGISTER,e.packagesMap.put(this.packageType,this)};return d.prototype={toJSON:function(){"use strict";return n.toJSON({session:""},this)},onMessage:function(t){"use strict";var i=t.control.type,n=t.header.action;if(t.getExtHeaders(),delete e._private,n===s.ACTION.HIBERNATE)if(i===s.TYPE.REQUEST)this.session.onHibernationRequest&&this.session.onHibernationRequest(t),o.respondHibernate(this.session,t),this.session.timeToLive&&this.session.timeToLive>0&&o.handleHibernation(this.session);else{var r,l;if(o.handleHibernation(this.session),i===s.TYPE.RESPONSE?r=t.header.response_code:i===s.TYPE.ERROR&&(r=t.header.error_code),l=t.header.reason,null==r||r>=200&&r<300){if(this.session.hibernateSuccessCallback)try{this.session.hibernateSuccessCallback(r)}catch(e){a.warn("The callback function 'session.successCallback()' exception: "+e)}}else o.invokeHibernateError(this.session,r,l)}else n===s.ACTION.CONNECT?o.handleConnection(this.session,t):n===s.ACTION.ICE_ENQUIRY?this.session.iceServerEnquirer.handleIceEnquiry(this.session,t):n===s.ACTION.RELAY_FAILED?(a.warn("Received relayFailed message: "+t),this.session.callUpdateOnIceResponse=!0,o.sendIceEnquiry(this.session)):n===s.ACTION.SUBSCRIBE?o.handleSubscribeResponse(this.session,t):n===s.ACTION.NOTIFY?o.handleSubscribeNotify(this.session,t):a.warn("Receive an unexpected message: "+t)}},i.sessionHelper=o,e.Session=r,e.ExtensibleSession=r,e}(live||{}),live=function(e){"use strict";var t,i=e._private=e._private||{},o={},s={},n=i.wscConst,a=i.wscUtils,r=i.rtcHelper,l=e.getLogger();return e.CallConfig=function(e,t,i){this.audioConfig=e,this.videoConfig=t,this.dataChannelConfig=i},e.CallConfig.prototype={hasAudio:function(){return this.shouldSendAudio()||this.shouldReceiveAudio()},hasVideo:function(){return this.shouldSendVideo()||this.shouldReceiveVideo()},shouldSendAudio:function(){return null!==this.audioConfig&&(this.audioConfig===n.MEDIADIRECTION.SENDRECV||this.audioConfig===n.MEDIADIRECTION.SENDONLY)},shouldSendVideo:function(){return null!==this.videoConfig&&(this.videoConfig===n.MEDIADIRECTION.SENDRECV||this.videoConfig===n.MEDIADIRECTION.SENDONLY)},shouldReceiveAudio:function(){return null!==this.audioConfig&&(this.audioConfig===n.MEDIADIRECTION.SENDRECV||this.audioConfig===n.MEDIADIRECTION.RECVONLY)},shouldReceiveVideo:function(){return null!==this.videoConfig&&(this.videoConfig===n.MEDIADIRECTION.SENDRECV||this.videoConfig===n.MEDIADIRECTION.RECVONLY)},isPaused:function(){return this.audioConfig===n.MEDIADIRECTION.NONE&&this.videoConfig===n.MEDIADIRECTION.NONE},getChannelType:function(){return this.shouldSendVideo()?"video":this.shouldSendAudio()?"audio":this.shouldReceiveVideo()?"video":"audio"},toJSON:function(){return{audioConfig:this.audioConfig,videoConfig:this.videoConfig,dataChannelConfig:this.dataChannelConfig}},asJSON:function(){return{audio:this.audioConfig,video:this.videoConfig}}},e.CallConfig.fromJSON=function(t){return new e.CallConfig(t.audio,t.video)},e.StreamOptions=function(t,i){e.StreamOptions.superclass.constructor.apply(this,[t,i])},a.extend(e.StreamOptions,e.CallConfig),e.CallState=function(e,t,i,o){this.state=e,this.status={code:t,reason:i},this.streamId=o},e.CallState.prototype={isFinalState:function(){var e=!1;return this.state!==n.CALLSTATE.ENDED&&this.state!==n.CALLSTATE.FAILED||(e=!0),e},is180Ringing:function(){return!(!this.status||this.state!==n.CALLSTATE.RESPONDED||180!==this.status.code)},hasEstablished:function(){return this.state===n.CALLSTATE.ESTABLISHED||this.state===n.CALLSTATE.UPDATE_FAILED||this.state===n.CALLSTATE.UPDATED||this.state===n.CALLSTATE.UPDATING}},e.StreamState=function(t,i,o,s){e.StreamState.superclass.constructor.apply(this,[t,i,o,s])},a.extend(e.StreamState,e.CallState),o.doRequest=function(e,t){function i(){l.debug("=== doStartCallRequest ==="),s.isValidSdp(e,p)?(e.caller=h,e.callee=g,e.setCallState(n.CALLSTATE.STARTED,null,"receive call"),e.subSessionId=m,e.startReqCorrId=u,e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_GOT,p),e._template.doStartCallRequest&&e._template.doStartCallRequest(t)):s.sendReject(e,603,"Invalid Sdp")}function o(){l.debug("=== doUpdateCallRequest ==="),e.callState.state===n.CALLSTATE.UPDATING&&(l.debug("Got update message when call state is UPDATING, that is, my offer lost the glare then."),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_REJECTED),e._template.rollbackUpdate&&(l.debug("Roll back the update initiated by me and accept the update from the other peer."),e._template.rollbackUpdate())),s.isValidSdp(e,p)?(e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_GOT,p),e._template.doUpdateCallRequest&&e._template.doUpdateCallRequest(t)):s.sendReject(e,603,"Invalid Sdp")}var a=e.callState,r=a.state,c=a.status.code,d=t.header.action,u=t.control.correlation_id,h=t.header.initiator,g=t.header.target,m=t.control.subsession_id,p=t.payload.sdp;switch(u&&(e.lastServerCorrelationId=u),t.payload&&t.payload.sdp&&l.debug("The SDP in the request is :\r\n"+t.payload.sdp),r){case n.CALLSTATE.NONE:case n.CALLSTATE.STARTED:switch(d){case n.ACTION.START:i();break;default:s.doUnexpectedMsg(e,t)}break;case n.CALLSTATE.RESPONDED:switch(d){case n.ACTION.START:switch(c){case 180:i();break;case 183:l.debug("=== doUpdateCallReqInEarlyPhase ==="),o(),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ACK_GOT)}break;default:s.doUnexpectedMsg(e,t)}break;case n.CALLSTATE.ESTABLISHED:case n.CALLSTATE.UPDATED:case n.CALLSTATE.UPDATE_FAILED:case n.CALLSTATE.ERROR:case n.CALLSTATE.UPDATING:switch(d){case n.ACTION.START:o();break;default:s.doUnexpectedMsg(e,t)}break;default:s.doUnexpectedMsg(e,t)}},o.doResponse=function(e,t){function i(){t.complete(d),e.callState.state===n.CALLSTATE.UPDATING?e.setCallState(n.CALLSTATE.UPDATED,null,"sent complete"):e.setCallState(n.CALLSTATE.ESTABLISHED,null,"sent complete"),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ACK_SENT),s.checkResumeState(e)}function o(e){var t="";return 180===e&&(t="Ringing"),181===e&&(t="Call Is Being Forwarded"),182===e&&(t="Queued"),183===e&&(t="Session Progress"),t}var a=e.callState.state,r=t.header.action,c=t.header.response_code,d=e.session;switch(t.payload&&t.payload.sdp&&l.debug("The SDP in the response is :\r\n"+t.payload.sdp),a){case n.CALLSTATE.NONE:s.doUnexpectedMsg(e,t);break;case n.CALLSTATE.STARTED:case n.CALLSTATE.RESPONDED:switch(r){case n.ACTION.START:c>100&&c<200?t.payload&&t.payload.sdp?t.header.reliable?(l.debug("=== doStartReliableProvRespWithSDP ==="),e.earlyMediaState=n.OFFER_ANSWER_STATE.INITIAL,e.setCallState(n.CALLSTATE.RESPONDED,c,o(c)),e._template.doStartReliableProvRespWithSDP&&e._template.doStartReliableProvRespWithSDP(t)):(l.debug("=== doStartUnReliableProvRespWithSDP ==="),e.setCallState(n.CALLSTATE.RESPONDED,c,o(c)),e.gotAnsweredInProvResp=!0,e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ANSWER_GOT,t.payload.sdp),e._template.doStartUnReliableProvRespWithSDP&&e._template.doStartUnReliableProvRespWithSDP(t)):t.header.reliable?(l.debug("=== doStartReliableProvRespWithoutSDP ==="),e._template.doStartReliableProvRespWithoutSDP&&e._template.doStartReliableProvRespWithoutSDP(t)):(l.debug("=== doStartUnReliableProvRespWithoutSDP ==="),e.setCallState(n.CALLSTATE.RESPONDED,c,o(c))):c>=200&&c<300&&function(){if(e.earlyMediaState)switch(e.earlyMediaState){case n.OFFER_ANSWER_STATE.ACK_SENT:case n.OFFER_ANSWER_STATE.ACK_GOT:l.debug("=== doStart200RespInEarlyPahse ==="),e._template.doStart200RespInEarlyPhase&&e._template.doStart200RespInEarlyPhase(t);break;case n.OFFER_ANSWER_STATE.OFFER_SENT:l.debug("=== doUpdate200RespInEarlyPhase ==="),e._template.doUpdate200RespInEarlyPhase&&e._template.doUpdate200RespInEarlyPhase(t)}else l.debug("=== doStart2XXResponse ==="),e.extHeaders&&delete e.extHeaders,e.gotAnsweredInProvResp?e.gotAnsweredInProvResp=null:e._template.doStart2XXResponse&&(e._template.doStart2XXResponse(t),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ANSWER_GOT,t.payload.sdp)),e.setCallState(n.CALLSTATE.RESPONDED,c,"got success response"),i()}();break;case n.ACTION.PRACK:l.debug("=== doPrack200Response ==="),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ACK_SENT);break;default:s.doUnexpectedMsg(e,t)}break;case n.CALLSTATE.ESTABLISHED:case n.CALLSTATE.UPDATING:case n.CALLSTATE.UPDATED:case n.CALLSTATE.UPDATE_FAILED:case n.CALLSTATE.ERROR:switch(r){case n.ACTION.START:200===c&&(l.debug("=== doUpdate200Response ==="),e.extHeaders&&delete e.extHeaders,t.payload.sdp?(e._template.doUpdate200Response&&e._template.doUpdate200Response(t),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ANSWER_GOT,t.payload.sdp),i()):l.error("Failed to handle update response with no SDP"));break;default:s.doUnexpectedMsg(e,t)}break;default:s.doUnexpectedMsg(e,t)}},o.doMessage=function(e,t){function o(){l.debug("=== doCancelCallMessage ==="),e.setCallState(n.CALLSTATE.ENDED,"","cancelled"),e.end()}function a(){l.debug("=== doShutdownMessage ==="),e.setCallState(n.CALLSTATE.ENDED,"","shutdown"),e._template.doShutdownMessage&&e._template.doShutdownMessage()}function r(){l.debug("=== doCompleteMessage ==="),e.setCallState(n.CALLSTATE.ESTABLISHED,null,"got complete"),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ACK_GOT)}function c(){if(l.debug("=== doTrickleIce ==="),t.payload.candidates&&e.peerConnection){var i,o=t.payload.candidates.split("\r\n");if(o.length>0){var s=(i=o.shift()).split(":");0===i.indexOf("a=mid")&&2===s.length?d(s[1],o):l.warn("invalid trickle ice candidate")}}}function d(t,o){var s={};null!==e.peerConnection.remoteSDP&&void 0!==e.peerConnection.remoteSDP||e.peerConnection.remoteDescription&&(e.peerConnection.remoteSDP=e.peerConnection.remoteDescription.sdp);for(var n=e.peerConnection.remoteSDP;o.length>0;){var a=o.shift();if(a&&0===a.indexOf("a=mid:")){var r=a.split(":");2===r.length&&(t=r[1])}else if(a&&0===a.indexOf("a=candidate:")){var c={};if(c.candidate=a,c.sdpMid=t,i.browser.isFirefox||i.browser.isEdge||i.browser.isSafari){if(void 0===s[t]){var d=n.split("a=mid:"),u=-1;d.length>1&&(d.shift(),d.every(function(e,i){return 0!==e.indexOf(t+"\r\n")||(u=i,!1)})),s[t]=u}s[t]>-1&&(c.sdpMLineIndex=s[t])}var h=new RTCIceCandidate(c);e.peerConnection.addIceCandidate(h).then(function(){l.debug("addIceCandidate succeed, "+JSON.stringify(h))}).catch(function(e){l.warn("For candidate: "+JSON.stringify(h)+", addIceCandidate gets error: "+e.name)})}else a&&0===a.indexOf("a=end-of-candidates")?l.debug("Get end-of-candidates when handling trickle ice candidate"):""!==a.trim()&&l.debug("Get unknown line of trickle ice candidate: "+a)}}var u=e.callState.state,h=t.header.action;switch(u){case n.CALLSTATE.NONE:s.doUnexpectedMsg(e,t);break;case n.CALLSTATE.STARTED:switch(h){case n.ACTION.SHUTDOWN:o();break;default:s.doUnexpectedMsg(e,t)}break;case n.CALLSTATE.RESPONDED:switch(h){case n.ACTION.SHUTDOWN:o();break;case n.ACTION.COMPLETE:r();break;case n.ACTION.TRICKLE:c();break;default:s.doUnexpectedMsg(e,t)}break;case n.CALLSTATE.ESTABLISHED:case n.CALLSTATE.UPDATED:case n.CALLSTATE.UPDATE_FAILED:case n.CALLSTATE.ERROR:switch(h){case n.ACTION.SHUTDOWN:a();break;case n.ACTION.COMPLETE:r();break;case n.ACTION.TRICKLE:c();break;default:s.doUnexpectedMsg(e,t)}break;case n.CALLSTATE.UPDATING:switch(h){case n.ACTION.SHUTDOWN:l.debug("=== doUpdateShutdownMessage ==="),"##re-invite_cancel@server##"===t.header.initiator?(e.setCallState(n.CALLSTATE.UPDATE_FAILED,null,"canceled by server"),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_REJECT)):a();break;case n.ACTION.COMPLETE:l.debug("=== doUpdateComplete ==="),e.setCallState(n.CALLSTATE.UPDATED,null,"got complete"),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.ACK_GOT);break;case n.ACTION.TRICKLE:c();break;default:s.doUnexpectedMsg(e,t)}break;default:h===n.ACTION.TRICKLE?c():s.doUnexpectedMsg(e,t)}},o.doError=function(e,t){var i=e.callState,o=t.header.action,r=t.header.error_code,c=t.header.reason,d=e.session;switch(o){case n.ACTION.START:switch(r){case 401:case 407:!function(){l.debug("=== doAuthentication ===");var i,o=!0,s=0,d=e.session.authHandler,u=t.header.authenticate;if(d&&d.refresh)for(;o&&s<3;){s++;try{if(i=d.refresh(n.AUTHTYPE.SERVICE,null),a.checkAuthInfo(n.AUTHTYPE.SERVICE,i))u.ha1=a.calcHa1(i,u),u.username=i.username,e.authInfo=u,e._template.sendOffer(),o=!1;else{if(null===i||""===i){l.warn("No valid authentication information");break}l.warn("No valid authentication information")}}catch(e){l.error("Got exception: "+e),o=!0}}else l.warn("No AuthHandler for this Session");!0===o&&(e.setCallState(n.CALLSTATE.FAILED,r,c),e._template.clearCall())}();break;case 491:l.debug("Got 491, ACK and do nothing."),t.ack(d);break;default:!function(){l.debug("=== doErrorMessage ==="),t.ack(d);var o=new a.ErrorInfo(r,c);if(d.sessionState===n.SESSIONSTATE.CONNECTED)e.callState.state!==n.CALLSTATE.NONE&&(i.hasEstablished()?function(){if(l.debug("=== doUpdateCallError ==="),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_REJECTED),e.callState.state===n.CALLSTATE.UPDATING&&e.setCallState(n.CALLSTATE.UPDATE_FAILED,r,c),e._template.rollbackUpdate&&e._template.rollbackUpdate(),e.session.allowRetry){l.debug("Retry update due to Relay failure");var t=Math.floor(500*Math.random());window.setTimeout(e.update(e.callConfig),t)}e.session.allowRetry=!1,s.checkResumeState(e)}():(l.debug("=== doStartCallError ==="),e.setCallState(n.CALLSTATE.FAILED,r,c),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_REJECTED),e._template.doStartCallError&&e._template.doStartCallError()));else try{d.failureCallback(o)}catch(e){l.error("Exception in Session failureCallback: "+e)}}()}break;default:s.doUnexpectedMsg(e,t)}},o.doACK=function(e,t){l.debug("ACK")},t=function(t){var i=n.OFFER_ANSWER_STATE.INITIAL,o=n.OFFER_ANSWER_STATE.INITIAL,a=t,c="",d="",u="";this.trickledCandidatesMap=new e.Map,this.getMasterState=function(){return i},this.getSlaveState=function(){return o},this.updateCallRemoteMedias=function(e){a.remoteMedias=r.getMediaFromSDP(e)},this.updateState=function(e,t){switch(l.debug("Trying to update offer-answer state to : "+e),e){case n.OFFER_ANSWER_STATE.OFFER_SENT:d=t,i=e;break;case n.OFFER_ANSWER_STATE.OFFER_GOT:c=t,o=e;break;case n.OFFER_ANSWER_STATE.ANSWER_SENT:o=e,d=t,u=c,this.updateCallRemoteMedias(u);break;case n.OFFER_ANSWER_STATE.ANSWER_GOT:i=e,u=t,this.updateCallRemoteMedias(u);break;case n.OFFER_ANSWER_STATE.ACK_SENT:i=e,t&&(d=t),s.sendTrickledCandidates(a);break;case n.OFFER_ANSWER_STATE.ACK_GOT:o=e,s.sendTrickledCandidates(a);break;case n.OFFER_ANSWER_STATE.OFFER_REJECTED:i=e;break;case n.OFFER_ANSWER_STATE.OFFER_REJECT:o=e}a.offerAnswerManager.masterState=i,a.offerAnswerManager.slaveState=o,a.earlyMediaState&&(a.earlyMediaState=e)},this.canSendOffer=function(){var e=!1;if(a.callState){var t=a.callState.state;t!==n.CALLSTATE.END&&t!==n.CALLSTATE.FAILED||(e=!0)}var s=!(i!==n.OFFER_ANSWER_STATE.ACK_SENT&&i!==n.OFFER_ANSWER_STATE.INITIAL&&i!==n.OFFER_ANSWER_STATE.OFFER_REJECTED||o!==n.OFFER_ANSWER_STATE.ACK_GOT&&o!==n.OFFER_ANSWER_STATE.OFFER_REJECT&&o!==n.OFFER_ANSWER_STATE.INITIAL&&o!==n.OFFER_ANSWER_STATE.ANSWER_SENT||e);return l.debug((s?"Can":"Cannot")+" send offer now. The offer-answer master/slave state is: "+a.offerAnswerManager.getMasterState()+" / "+a.offerAnswerManager.getSlaveState()+", call State: "+a.callState.state+", session State: "+a.session.sessionState+", ICE connection state: "+(a.peerConnection?a.getIceConnectionState():"peerConnection is null")),s},this.reset=function(){i=n.OFFER_ANSWER_STATE.INITIAL,o=n.OFFER_ANSWER_STATE.INITIAL,c=""},this.getLatestActiveRemoteSdp=function(){return u},this.getLatestActiveLocalSdp=function(){return d}},s.isValidSdp=function(e,t){return!(void 0===t||null===t||t.indexOf("a=")<0&&t.indexOf("m=")<0)},s.getInitiator=function(e){return e.session.userName},s.getTarget=function(e){return e.session.userName===e.caller?e.callee:e.caller},s.send180Ringing=function(e){var t=s.createResponse(e);t.control.message_state=n.MESSAGESTATE.SUBSEQUENT,t.header.action=n.ACTION.START,e.session.sendMessage(t),e.setCallState(n.CALLSTATE.RESPONDED,180,"Ringing")},s.sendReject=function(e,t,i,o){var a=s.createError(e),r=n.ERRORCODE.DECLINED;a.header.error_code=t||r,i&&(a.header.reason=i),a.header.action=n.ACTION.START,o&&a.addExtHeaders(o),e.session.sendMessage(a),e.offerAnswerManager.updateState(n.OFFER_ANSWER_STATE.OFFER_REJECT)},s.sendPrack=function(e){var t=s.createRequest(e);t.control.correlation_id=e.lastServerCorrelationId,t.header.action=n.ACTION.PRACK,e.session.sendMessage(t)},s.createRequest=function(e){var t=new a.Message,i=e.session.lastInboundSeq,o=s.getInitiator(e),r=s.getTarget(e);return t.control.type=n.TYPE.REQUEST,t.control.subsession_id=e.subSessionId,t.control.package_type=e.pkgInstance.packageType,t.control.ack_sequence=i,t.header.initiator=o,r&&(t.header.target=r),e.streamId&&e.streamType&&(t.header.stream_id=e.streamId,t.header.stream_type=e.streamType),t},s.createResponse=function(e){var t=new a.Message,i=e.lastServerCorrelationId,o=e.session.lastInboundSeq,s=e.caller,r=e.callee,l=e.subSessionId;return t.control.type=n.TYPE.RESPONSE,t.control.subsession_id=l,t.control.package_type=e.pkgInstance.packageType,t.control.correlation_id=i,t.control.ack_sequence=o,t.header.initiator=s,r&&(t.header.target=r),e.streamId&&e.streamType&&(t.header.stream_id=e.streamId,t.header.stream_type=e.streamType),t},s.createError=function(e){var t=s.createResponse(e);return t.control.type=n.TYPE.ERROR,t},s.createMessage=function(e){var t=new a.Message,i=e.session.lastInboundSeq,o=s.getInitiator(e),r=s.getTarget(e),l=e.subSessionId;return t.control.type=n.TYPE.MESSAGE,t.control.subsession_id=l,t.control.package_type=e.pkgInstance.packageType,t.control.ack_sequence=i,t.header.initiator=o,r&&(t.header.target=r),e.streamId&&e.streamType&&(t.header.stream_id=e.streamId,t.header.stream_type=e.streamType),t},s.sendTrickledCandidates=function(e){var t=e.offerAnswerManager.trickledCandidatesMap,i="";if(t.size()>0){for(var o=t.keys();o.length>0;){var n=o.shift();i+=n;for(var a=t.get(n);a.length>0;){var r=a.shift();if(r){i+=r.match(/^a=.*\r\n$/i)?r:"a="+r+"\r\n"}else l.warn("sendTrickledCandidates found invalid candidate in candidatesArray; skipping")}}s.sendTrickleMessage(e,i)}},s.sendTrickleMessage=function(e,t){var i=s.createMessage(e);i.header.action=n.ACTION.TRICKLE,i.payload={candidates:t},e.session.sendMessage(i),t.indexOf("end-of-candidates")>-1&&e.offerAnswerManager.trickledCandidatesMap.clear()},s.checkResumeState=function(e){if(e.resumeState)switch(e.resumeState){case n.RESUME_STATE.waittingFinalResp:e.resumeState=null,e.resume();break;case n.RESUME_STATE.reStartingCall:e.resumeSuccessCallback&&(e.resumeSuccessCallback(),e.resumeState=null);break;case n.RESUME_STATE.updateCallByIceFailure:e.resumeState=null}},s.setCallState=function(e,t,i,o){var s=e.callState,a=s.state;if(!s.isFinalState()&&(!s.hasEstablished()||t!==n.CALLSTATE.NONE&&t!==n.CALLSTATE.STARTED&&t!==n.CALLSTATE.RESPONDED)){var r=s.status.code;if(a!==t||a===t&&r!==i){e.callState.state=t,e.callState.status.code=i,e.callState.status.reason=o;try{if(e.onCallStateChange)if(e.lastServerExtHeader){var c=e.lastServerExtHeader;e.onCallStateChange(e.callState,c),delete e.lastServerExtHeader}else e.onCallStateChange(e.callState);else if(e.onStateChange)if(e.lastServerExtHeader){var d=e.lastServerExtHeader;e.onStateChange(e.callState,d),delete e.lastServerExtHeader}else e.onStateChange(e.callState)}catch(e){l.warn("The callback function 'Call.onCallStateChange()' exception: "+e)}e.session.saveToStorage()}}},s.onMessage=function(e,t){if(e.isEnquiry()){if(!t.capabilityExchange){var i="No CapabilityExchange registered with Chat";throw l.error(i),i}t.capabilityExchange.onMessage(e)}else e.isRequest()?o.doRequest(t,e):e.isResponse()?o.doResponse(t,e):e.isMessage()?o.doMessage(t,e):e.isACK()?o.doACK(t,e):e.isError()&&o.doError(t,e)},s.clearMsrpSubSession=function(e){e.session.removeSubSession(e.subSessionId),e.msrpSession&&e.msrpSession.close()},s.msrpSubSessionDecline=function(e,t,i,o){var a,r;a=t||n.ERRORCODE.DECLINED,r=i||"Decline",e.callState.state===n.CALLSTATE.UPDATING?e.setCallState(n.CALLSTATE.UPDATE_FAILED,a,r):(s.clearMsrpSubSession(e),e.setCallState(n.CALLSTATE.FAILED,a,r)),s.sendReject(e,a,r,o)},s.sendAcceptResponse=function(e,t,i,o){var a=s.createResponse(e);a.control.message_state=n.MESSAGESTATE.FINAL,a.header.action=n.ACTION.START,a.control.correlation_id=t,o&&a.addExtHeaders(o),a.payload={sdp:i},e.session.sendMessage(a)},s.addParticipants2MsrpSubSession=function(e,t){if(t.callState.state!==n.CALLSTATE.NONE)throw{name:"IllegalStateException",message:"Cannot add participants at subSession state: "+t.callState.state};if(!(e instanceof Array))throw{name:"IllegalArgumentException",message:"parameter participants is not array type"};t.participants=e},s.doUnexpectedMsg=function(e,t){l.warn("Unexpected message is received: "+JSON.stringify(t,null,4))},e._private.CallStateMachine=o,e._private.offerAnswerManager=t,e._private.CallCommonUtils=s,e}(live||{}),live=function(e){var t=e._private=e._private||{},i=t.browser,o=e.getLogger(),s=function(){this.dataChannel=null,this.origDataChannel=null,this.state="none",this.label=null,this.onOpen=null,this.onClose=null,this.onError=null,this.dataSender=null,this.dataReceiver=null;var e=this,t=function(){e.dataSender=new n(e.dataChannel),o.info("Sender of DataTransfer created.")},s=function(t){o.debug("DataTransfer: Received data:"+t.data),e.dataReceiver?e.dataReceiver.onMessage(t):o.warn("The default data receiver is still initialized to receive data.")},r=function(i){e.origDataChannel&&(e.origDataChannel=null),e.state="open",t(),e.dataReceiver=new a,o.info("Receiver of DataTransfer created.");var n=e.dataChannel.readyState;null==e.label&&(e.label=e.dataChannel.label),o.debug('Data Channel "'+e.dataChannel.label+'" is open; current readyState: '+n),e.dataChannel.disabled=!1,e.dataChannel.onmessage=s,e.onOpen&&e.onOpen(i)},l=function(t){if(e.origDataChannel&&t.target&&e.origDataChannel.id!=t.target.id)return e.dataChannel=e.origDataChannel,void(e.origDataChannel=null);e.state="closed";var i=e.dataChannel.readyState;null==e.label&&(e.label=e.dataChannel.label),o.debug('Data Channel "'+e.dataChannel.label+'" is closing; current readyState is: '+i),e.dataChannel.disabled=!0,e.onClose&&e.onClose(t)},c=function(t){o.debug("Received dataChannel error event for DataTransfer: "+e.dataChannel.label),e.onError&&e.onError(t)};this.initDataChannel=function(t,s){if(o.debug("DataTransfer object initialized by the dataChannel."),s&&(e.origDataChannel=e.dataChannel),e.dataChannel=t,e.state="starting",e.label=t.label,e.dataChannel)try{e.dataChannel.onopen=r,i.isIE&&"open"==e.dataChannel.readyState&&setTimeout(function(){var t=null;try{t=new Event("open")}catch(e){(t=document.createEvent("Event")).initEvent("open",!1,!1)}r.call(e.dataChannel,t)},0),e.dataChannel.onerror=c,e.dataChannel.onclose=l}catch(e){o.error("Exception occured when initializing the callback functions of the data channel: "+e)}else o.error("Could not initialize the data channel with null.")},this.clear=function(){try{null!=e.dataChannel&&(e.dataChannel.close(),e.dataChannel.disabled=!0,o.info("DataTransfer closed its data channel; current readyState is: "+e.dataChannel.readyState)),o.info("DataTransfer object cleared")}catch(e){o.error("Recieved an exception when cleaning the DataTransfer object: "+e)}},this.toJSON=function(){var e={},t={session:"",pkgInstance:""};for(var i in this)i in t||(e[i]=this[i]);return e}};s.prototype={getState:function(){return this.state},getSender:function(){return this.dataSender},getReceiver:function(){return this.dataReceiver}};var n=function(e){this.dataChannel=e};n.prototype={send:function(e){if(null!=this.dataChannel&&"open"===this.dataChannel.readyState)try{this.dataChannel.send(e)}catch(e){throw o.debug("Exception when sending data by dataChannel: "+e),e}else o.error("Error when sending data. The dataChannel is not in a valid state.")}};var a=function(){this.onMessage=function(e){o.info("onMessage function is not overridden by the application. New received data is handle by the default DataReceiver object."+e.data)}};return a.prototype={},t.DataTransfer=s,t.DataSender=n,t.DataReceiver=a,e}(live||{});window.console||(console={log:function(){},info:function(){},debug:function(){},warn:function(){},error:function(){}}),"function"!=typeof Date.prototype.now&&(Date.now=function(){return+new Date}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),void 0===Error.prototype.stack&&(Error.prototype.stack="Error:\n\n\n\n\n"),Array.prototype.some||(Array.prototype.some=function(e){"use strict";if(null==this)throw new TypeError("Array.prototype.some called on null or undefined");if("function"!=typeof e)throw new TypeError;for(var t=Object(this),i=t.length>>>0,o=arguments.length>=2?arguments[1]:void 0,s=0;s<i;s++)if(s in t&&e.call(o,t[s],s,t))return!0;return!1});var browserIsIE=!1,IEversion=null;if(-1!=navigator.userAgent.indexOf("MSIE"))var ie_regexp=/MSIE (\d+\.\d+);/;else var ie_regexp=/Trident.*rv[ :]*(\d+\.\d+)/;ie_regexp.test(navigator.userAgent)&&(browserIsIE=!0,IEversion=new Number(RegExp.$1),console.log("Browser is IE, version "+IEversion)),browserIsIE&&IEversion<=9&&(baseconsole=console,9==IEversion&&(console={log:function(e){baseconsole.log(e)},info:function(e){baseconsole.info(e)},debug:function(e){baseconsole.log(e)},warn:function(e){baseconsole.warn(e)},error:function(e){baseconsole.error(e)},clear:function(e){baseconsole.clear(e)},assert:function(e){baseconsole.assert(e)},dir:function(e){baseconsole.dir(e)},profile:function(e){baseconsole.profile(e)},profileEnd:function(e){baseconsole.profileEnd(e)}}),IEversion<=8&&(console={log:function(e){baseconsole.log(e)},info:function(e){baseconsole.info(e)},debug:function(e){baseconsole.log(e)},warn:function(e){baseconsole.warn(e)},error:function(e){baseconsole.error(e)},clear:function(e){baseconsole.clear(e)},assert:function(e){baseconsole.assert(e)}}));var live=function(e){function t(e,t){if(e.session.sessionState===c.SESSIONSTATE.CONNECTED){var i=new d.Message;i.control.type=c.TYPE.MESSAGE,i.control.package_type=c.PACKAGE.REGISTER,i.control.subsession_id=e.session.connectSubSessionId,i.control.session_id=e.session.sessionId,i.control.ack_sequence=e.session.lastInboundSeq,i.header.initiator=e.session.userName,i.header.action=c.ACTION.AUDIT,i.header.module="WEB",i.header.conversation_key=e.conversation.conversationKey,i.header.access_token=e.session.iceServerAccessToken,i.payload={audit_data:t},e.session.sendMessage(i)}}function i(e){function i(){function t(e){return e.getType()===c.STREAMTYPE.AUDIOVIDEO}this.audio={inbound:{bitRate:new I(M,N),rtt:new I(M,N),jitter:new I(M,N),packetLossRate:new I(M,N)},outbound:{bitRate:new I(M,D),rtt:new I(M,D),jitter:new I(M,D),packetLossRate:new I(M,D)}},this.video={inbound:{bitRate:new I(P,N),rtt:new I(P,N),jitter:new I(P,N),packetLossRate:new I(P,N),frameRate:new I(P,N),resolutionWidth:new I(P,N),resolutionHeight:new I(P,N),firsSent:new w(P,N),nacksSent:new w(P,N),plisSent:new w(P,N)},outbound:{bitRate:new I(P,D),rtt:new I(P,D),jitter:new I(P,D),packetLossRate:new I(P,D),frameRate:new I(P,D),resolutionWidth:new I(P,D),resolutionHeight:new I(P,D),firsReceived:new w(P,D),nacksReceived:new w(P,D),plisReceived:new w(P,D)}},this.mos={inbound:{transmission:new I,video:new I(P,N),audio:new I(M,N)},outbound:{transmission:new I,video:new I(P,D),audio:new I(M,D)}},this.calculateInboundVideoMOS=function(){var e,i=this.video.inbound.packetLossRate.value,o=this.video.inbound.frameRate.value;e=void 0!==i&&void 0!==o?t(_.streamInfo)&&o<=_.__frameRateThreshold?c.ExperienceStatus.BAD:c.ExperienceStatus.GOOD:c.ExperienceStatus.NOT_AVAILABLE,this.mos.inbound.video.alarmPut(e,c.ExperienceFactor.VIDEO_INBOUND,{packetLossRate:this.video.inbound.packetLossRate.value,frameRate:this.video.inbound.frameRate.value})},this.calculateOutboundVideoMOS=function(){var e,i=this.video.outbound.packetLossRate.value,o=this.video.outbound.frameRate.value,s=this.video.outbound.rtt.value;e=void 0!==i&&void 0!==o&&void 0!==s?t(_.streamInfo)&&o<=_.__frameRateThreshold?c.ExperienceStatus.BAD:s>=_.__videoOutboundRttThreshold?c.ExperienceStatus.BAD:c.ExperienceStatus.GOOD:c.ExperienceStatus.NOT_AVAILABLE,this.mos.outbound.video.alarmPut(e,c.ExperienceFactor.VIDEO_OUTBOUND,{packetLossRate:i,frameRate:o,rtt:s})},this.calculateInboundAudioMOS=function(){if(!s.browser.isFirefox){var e,t=this.audio.inbound.jitter.value,i=this.audio.inbound.packetLossRate.value;e=void 0!==t&&void 0!==i?t>=_.__jitterThreshold?c.ExperienceStatus.BAD:c.ExperienceStatus.GOOD:c.ExperienceStatus.NOT_AVAILABLE,this.mos.inbound.audio.alarmPut(e,c.ExperienceFactor.AUDIO_INBOUND,{packetLossRate:i,jitter:t})}},this.calculateOutboundAudioMOS=function(){if(!s.browser.isFirefox){var e,t=this.audio.outbound.jitter.value,i=this.audio.outbound.packetLossRate.value,o=this.audio.outbound.rtt.value;e=void 0!==t&&void 0!==i&&void 0!==o?t>=_.__jitterThreshold?c.ExperienceStatus.BAD:o>=_.__audioOutboundRttThreshold?c.ExperienceStatus.BAD:c.ExperienceStatus.GOOD:c.ExperienceStatus.NOT_AVAILABLE,this.mos.outbound.audio.alarmPut(e,c.ExperienceFactor.AUDIO_OUTBOUND,{packetLossRate:i,jitter:t,rtt:o})}},this.calculateMOS=function(){if(this.calculateInboundVideoMOS(),this.calculateOutboundVideoMOS(),this.calculateInboundAudioMOS(),this.calculateOutboundAudioMOS(),Object.keys(v).length>0);else{var t=[];e.conversation.getParticipants().forEach(function(e){-1===p.indexOf(e)&&t.push.apply(t,e.getStreamInfos())}),t.length>0&&(v={},void 0!==this.mos.inbound.audio.publishedValue&&(v[c.ExperienceFactor.AUDIO_INBOUND]={value:this.mos.inbound.audio.publishedValue,hints:{packetLossRate:this.audio.inbound.packetLossRate.value,jitter:this.audio.inbound.jitter.value}}),void 0!==this.mos.inbound.video.publishedValue&&(v[c.ExperienceFactor.VIDEO_INBOUND]={value:this.mos.inbound.video.publishedValue,hints:{packetLossRate:this.video.inbound.packetLossRate.value,frameRate:this.video.inbound.frameRate.value}}),void 0!==this.mos.outbound.audio.publishedValue&&(v[c.ExperienceFactor.AUDIO_OUTBOUND]={value:this.mos.outbound.audio.publishedValue,hints:{packetLossRate:this.audio.outbound.packetLossRate.value,jitter:this.audio.outbound.jitter.value,rtt:this.audio.outbound.rtt.value}}),void 0!==this.mos.outbound.video.publishedValue&&(v[c.ExperienceFactor.VIDEO_OUTBOUND]={value:this.mos.outbound.video.publishedValue,hints:{packetLossRate:this.video.outbound.packetLossRate.value,frameRate:this.video.outbound.frameRate.value,rtt:this.video.outbound.rtt.value}}))}p=e.conversation.getParticipants(),v={}},this.cleanProperties=function(){delete this.audio.inbound.packetsReceived,delete this.audio.inbound.packetsLost,delete this.audio.outbound.packetsSent,delete this.audio.outbound.packetsLost,delete this.video.inbound.packetsReceived,delete this.video.inbound.packetsLost,delete this.video.outbound.packetsSent,delete this.video.outbound.packetsLost}}function o(e,t,i){if(void 0!==e&&void 0!==t){var s,n,a=o[i]=o[i]||{lastPacketsLost:void 0,lastPacketsTransmitted:void 0,lastEffectivePacketsTransmitted:void 0,keepCount:999};return s=i.indexOf("audio.")>-1?_.__audioPacketsLostKeepLimit:_.__videoPacketsLostKeepLimit,void 0!==a.lastPacketsLost?e<=a.lastPacketsLost?(a.keepCount=a.keepCount+1,n=a.keepCount<=s?-1:0):(n=a.keepCount<=s?(e-a.lastPacketsLost)/(e-a.lastPacketsLost+(t-a.lastEffectivePacketsTransmitted)):-1,a.lastEffectivePacketsTransmitted=t,a.keepCount=0):n=-1,a.lastPacketsLost=e,a.lastPacketsTransmitted=t,n}}function n(t,i,s){var n=L;if(s&&(n=s),"audio"==t.mediaType){if(t.id.indexOf("_recv")>-1){var a=void 0;m&&m[t.id]&&(a=8*(t.bytesReceived-m[t.id].bytesReceived)),n.audio.inbound.bitRate.put(a),n.audio.inbound.jitter.put(t.googJitterReceived);var r=void 0;if(m&&m[t.id]){var l=t.packetsLost-m[t.id].packetsLost,c=t.packetsReceived-m[t.id].packetsReceived;r=o(t.packetsLost,t.packetsReceived,"audio.inbound")}if(n.audio.inbound.packetsLost=l,n.audio.inbound.packetsReceived=c,n.audio.inbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){var d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;var u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("_send")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesSent-m[t.id].bytesSent)),n.audio.outbound.bitRate.put(a),n.audio.outbound.rtt.put(t.googRtt);r=void 0;if(m&&m[t.id]){l=t.packetsLost-m[t.id].packetsLost;var h=t.packetsSent-m[t.id].packetsSent;r=o(t.packetsLost,t.packetsSent,"audio.outbound")}if(n.audio.outbound.packetsLost=l,n.audio.outbound.packetsSent=h,n.audio.outbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}}else if("video"==t.mediaType)if(t.id.indexOf("_recv")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesReceived-m[t.id].bytesReceived)),n.video.inbound.bitRate.put(a),n.video.inbound.jitter.put(t.googJitterReceived);r=void 0;if(m&&m[t.id]){l=t.packetsLost-m[t.id].packetsLost,c=t.packetsReceived-m[t.id].packetsReceived;r=o(t.packetsLost,t.packetsReceived,"video.inbound")}if(n.video.inbound.packetsLost=l,n.video.inbound.packetsReceived=c,n.video.inbound.packetLossRate.put(r),n.video.inbound.frameRate.triggerPut(t.googFrameRateReceived,"onNewInboundFrameRate"),n.video.inbound.resolutionWidth.triggerPut(t.googFrameWidthReceived,"onNewInboundResolution",[t.googFrameWidthReceived,t.googFrameHeightReceived]),n.video.inbound.resolutionHeight.put(t.googFrameHeightReceived),n.video.inbound.firsSent.put(1*t.googFirsSent),n.video.inbound.nacksSent.put(1*t.googNacksSent),n.video.inbound.plisSent.put(1*t.googPlisSent),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("_send")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesSent-m[t.id].bytesSent)),n.video.outbound.bitRate.put(a),n.video.outbound.rtt.put(t.googRtt);r=void 0;if(m&&m[t.id]){l=t.packetsLost-m[t.id].packetsLost,h=t.packetsSent-m[t.id].packetsSent;r=o(t.packetsLost,t.packetsSent,"video.outbound")}if(n.video.outbound.packetsLost=l,n.video.outbound.packetsSent=h,n.video.outbound.packetLossRate.put(r),n.video.outbound.frameRate.triggerPut(t.googFrameRateSent,"onNewOutboundFrameRate"),n.video.outbound.resolutionWidth.triggerPut(t.googFrameWidthSent,"onNewOutboundResolution",[t.googFrameWidthSent,t.googFrameHeightSent]),n.video.outbound.resolutionHeight.put(t.googFrameHeightSent),n.video.outbound.firsReceived.put(1*t.googFirsReceived),n.video.outbound.nacksReceived.put(1*t.googNacksReceived),n.video.outbound.plisReceived.put(1*t.googPlisReceived),t.transportId&&t.transportId.indexOf("Channel-")>-1){var g;d=i[g=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[g].googRemoteAddress;u=i[g].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}}function a(t,i,s){var n=L;if(s&&(n=s),t.id.indexOf("inbound_rtp_audio")>-1){var a=void 0;m&&m[t.id]&&(a=8*(t.bytesReceived-m[t.id].bytesReceived)),n.audio.inbound.bitRate.put(a),n.audio.inbound.jitter.put(1e3*t.jitter);var r=void 0;if(m&&m[t.id]){var l=t.packetsLost-m[t.id].packetsLost,c=t.packetsReceived-m[t.id].packetsReceived;r=o(t.packetsLost,t.packetsReceived,"audio.inbound")}if(n.audio.inbound.packetsLost=l,n.audio.inbound.packetsReceived=c,n.audio.inbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){var d=i[v=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[v].googRemoteAddress;var u=i[v].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("outbound_rtp_audio")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesSent-m[t.id].bytesSent)),n.audio.outbound.bitRate.put(a),jitter=void 0,i[t.remoteId]&&(jitter=1e3*i[t.remoteId].jitter);r=void 0;if(m&&m[t.id]&&i[t.remoteId]&&m[t.remoteId]){l=i[t.remoteId].packetsLost-m[t.remoteId].packetsLost;var h=i[t.remoteId].packetsReceived-m[t.remoteId].packetsReceived;r=o(i[t.remoteId].packetsLost,i[t.remoteId].packetsReceived,"audio.outbound")}if(n.audio.outbound.packetsLost=l,n.audio.outbound.packetsSent=h,n.audio.outbound.packetLossRate.put(r),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[v=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[v].googRemoteAddress;u=i[v].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("inbound_rtp_video")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesReceived-m[t.id].bytesReceived)),n.video.inbound.bitRate.put(a),n.video.inbound.jitter.put(1e3*t.jitter);r=void 0;if(m&&m[t.id]){l=t.packetsLost-m[t.id].packetsLost,c=t.packetsReceived-m[t.id].packetsReceived;r=o(t.packetsLost,t.packetsReceived,"video.inbound")}n.video.inbound.packetsLost=l,n.video.inbound.packetsReceived=c,n.video.inbound.packetLossRate.put(r);var p=void 0;if(m&&m[t.id]&&(p=(t.framesDecoded-m[t.id].framesDecoded)/(g/1e3)),n.video.inbound.frameRate.triggerPut(p,"onNewInboundFrameRate"),n.video.inbound.firsSent.put(1*t.firCount),n.video.inbound.nacksSent.put(1*t.nackCount),n.video.inbound.plisSent.put(1*t.pliCount),t.transportId&&t.transportId.indexOf("Channel-")>-1){d=i[v=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[v].googRemoteAddress;u=i[v].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if(t.id.indexOf("outbound_rtp_video")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesSent-m[t.id].bytesSent)),n.video.outbound.bitRate.put(a);r=void 0;if(m&&m[t.id]&&i[t.remoteId]&&m[t.remoteId]){l=i[t.remoteId].packetsLost-m[t.remoteId].packetsLost,h=i[t.remoteId].packetsReceived-m[t.remoteId].packetsReceived;r=o(i[t.remoteId].packetsLost,i[t.remoteId].packetsReceived,"video.outbound")}n.video.outbound.packetsLost=l,n.video.outbound.packetsSent=h,n.video.outbound.packetLossRate.put(r);p=void 0;if(m&&m[t.id]&&(p=(t.framesEncoded-m[t.id].framesEncoded)/(g/1e3)),n.video.outbound.frameRate.triggerPut(p,"onNewOutboundFrameRate"),n.video.outbound.firsReceived.put(1*t.firCount),n.video.outbound.nacksReceived.put(1*t.nackCount),n.video.outbound.plisReceived.put(1*t.pliCount),t.transportId&&t.transportId.indexOf("Channel-")>-1){var v;d=i[v=i[t.transportId].selectedCandidatePairId].googLocalAddress.split(":");e.userIp=d[0],e.url=i[v].googRemoteAddress;u=i[v].googLocalCandidateType;e.sessionType=u,e.protocol=x(u)}}else if("candidatepair"===t.type&&"succeeded"===t.state&&t.selected){var S=t.localCandidateId;u=i[S].candidateType;e.userIp=i[S].ipAddress,e.url=i[S].ipAddress+":"+i[S].portNumber,e.sessionType=u,e.protocol=x(u)}}function r(t,i,s){var n=L;if(s&&(n=s),t.id.indexOf("RTCInboundRTPAudioStream")>-1){var a=void 0;m&&m[t.id]&&(a=8*(t.bytesReceived-m[t.id].bytesReceived)),n.audio.inbound.bitRate.put(a),n.audio.inbound.jitter.put(1e3*t.jitter);var r=void 0;if(m&&m[t.id]){var l=t.packetsLost-m[t.id].packetsLost,c=t.packetsReceived-m[t.id].packetsReceived;r=o(t.packetsLost,t.packetsReceived,"audio.inbound")}n.audio.inbound.packetsLost=l,n.audio.inbound.packetsReceived=c,n.audio.inbound.packetLossRate.put(r)}else if(t.id.indexOf("RTCOutboundRTPAudioStream")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesSent-m[t.id].bytesSent)),n.audio.outbound.bitRate.put(a),n.audio.outbound.rtt.put(t.googRtt);r=void 0;if(m&&m[t.id]){l=t.packetsLost-m[t.id].packetsLost;var d=t.packetsSent-m[t.id].packetsSent;r=o(t.packetsLost,t.packetsSent,"audio.outbound")}n.audio.outbound.packetsLost=l,n.audio.outbound.packetsSent=d,n.audio.outbound.packetLossRate.put(r)}else if(t.id.indexOf("RTCInboundRTPVideoStream")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesReceived-m[t.id].bytesReceived)),n.video.inbound.bitRate.put(a),n.video.inbound.jitter.put(1e3*t.jitter);r=void 0;if(m&&m[t.id]){l=1*t.packetsLost-1*m[t.id].packetsLost,c=1*t.packetsReceived-1*m[t.id].packetsReceived;r=o(1*t.packetsLost,1*t.packetsReceived,"video.inbound")}n.video.inbound.packetsLost=l,n.video.inbound.packetsReceived=c,n.video.inbound.packetLossRate.put(r),t.googFrameRateInput?n.video.inbound.frameRate.triggerPut(t.googFrameRateInput,"onNewInboundFrameRate"):t.googFrameRateReceived&&n.video.inbound.frameRate.triggerPut(t.googFrameRateReceived,"onNewInboundFrameRate"),i[u=t.trackId].frameHeight&&i[u].frameWidth&&(n.video.inbound.resolutionWidth.triggerPut(i[u].frameWidth,"onNewInboundResolution",[i[u].frameWidth,i[u].frameHeight]),n.video.inbound.resolutionHeight.put(i[u].frameHeight)),n.video.inbound.firsReceived.put(1*t.firCount),n.video.inbound.nacksReceived.put(1*t.nackCount),n.video.inbound.plisReceived.put(1*t.pliCount)}else if(t.id.indexOf("RTCOutboundRTPVideoStream")>-1){a=void 0;m&&m[t.id]&&(a=8*(t.bytesSent-m[t.id].bytesSent)),n.video.outbound.bitRate.put(a);var u;r=void 0;if(m&&m[t.id]){l=t.packetsLost-m[t.id].packetsLost,d=t.packetsSent-m[t.id].packetsSent;r=o(t.packetsLost,t.packetsSent,"video.outbound")}n.video.outbound.packetsLost=l,n.video.outbound.packetsSent=d,n.video.outbound.packetLossRate.put(r),n.video.outbound.frameRate.triggerPut(t.googFrameRateSent,"onNewOutboundFrameRate"),i[u=t.trackId].frameHeight&&i[u].frameWidth&&(n.video.outbound.resolutionWidth.triggerPut(i[u].frameWidth,"onNewInboundResolution",[i[u].frameWidth,i[u].frameHeight]),n.video.outbound.resolutionHeight.put(i[u].frameHeight)),n.video.outbound.firsSent.put(1*t.firCount),n.video.outbound.nacksSent.put(1*t.nackCount),n.video.outbound.plisSent.put(1*t.pliCount)}if(t.id.indexOf("RTCIceCandidatePair_")>-1&&(t.transportId.indexOf("audio")>-1?n.audio.outbound.rtt.put(1e3*t.totalRoundTripTime):t.transportId.indexOf("video")>-1&&n.video.outbound.rtt.put(1e3*t.totalRoundTripTime)),t.id.indexOf("RTCIceCandidate_")>-1&&t.type.indexOf("local-candidate")>-1){var h=t.candidateType;e.sessionType=h,e.protocol=x(h)}}function l(t,i){if(t.googFrameRateReceived||t.googFrameRateSent){if(t.googFrameRateReceived||t.googFrameRateSent)if(t.id.indexOf("_recv")>-1){var s=void 0;m&&m[t.id]&&(s=8*(t.bytesReceived-m[t.id].bytesReceived)),factorReports.video.inbound.bitRate.put(s),factorReports.video.inbound.jitter.put(t.googJitterReceived);var n=void 0;if(m&&m[t.id]){var a=1*t.packetsLost-1*m[t.id].packetsLost,r=1*t.packetsReceived-1*m[t.id].packetsReceived;n=o(1*t.packetsLost,1*t.packetsReceived,"video.inbound")}if(factorReports.video.inbound.packetsLost=a,factorReports.video.inbound.packetsReceived=r,factorReports.video.inbound.packetLossRate.put(n),t.googFrameRateInput?factorReports.video.inbound.frameRate.triggerPut(t.googFrameRateInput,"onNewInboundFrameRate"):t.googFrameRateReceived&&factorReports.video.inbound.frameRate.triggerPut(t.googFrameRateReceived,"onNewInboundFrameRate"),t.googFrameWidthInput&&t.googFrameHeightInput?(factorReports.video.inbound.resolutionWidth.triggerPut(t.googFrameWidthInput,"onNewInboundResolution",[t.googFrameWidthInput,t.googFrameHeightInput]),factorReports.video.inbound.resolutionHeight.put(t.googFrameHeightInput)):t.googFrameWidthReceived&&t.googFrameHeightReceived&&(factorReports.video.inbound.resolutionWidth.triggerPut(t.googFrameWidthReceived,"onNewInboundResolution",[t.googFrameWidthReceived,t.googFrameHeightReceived]),factorReports.video.inbound.resolutionHeight.put(t.googFrameHeightReceived)),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){var l=i[u].googLocalAddress.split(":");e.userIp=l[0],e.url=i[u].googRemoteAddress;var c=i[u].googLocalCandidateType;e.sessionType=c,e.protocol=x(c)}}else if(t.id.indexOf("_send")>-1){s=void 0;m&&m[t.id]&&(s=8*(t.bytesSent-m[t.id].bytesSent)),factorReports.video.outbound.bitRate.put(s),factorReports.video.outbound.rtt.put(t.googRtt);n=void 0;if(m&&m[t.id]){a=t.packetsLost-m[t.id].packetsLost;var d=t.packetsSent-m[t.id].packetsSent;n=o(t.packetsLost,t.packetsSent,"video.outbound")}if(factorReports.video.outbound.packetsLost=a,factorReports.video.outbound.packetsSent=d,factorReports.video.outbound.packetLossRate.put(n),factorReports.video.outbound.frameRate.triggerPut(t.googFrameRateSent,"onNewOutboundFrameRate"),factorReports.video.outbound.resolutionWidth.triggerPut(t.googFrameWidthSent,"onNewOutboundResolution",[t.googFrameWidthSent,t.googFrameHeightSent]),factorReports.video.outbound.resolutionHeight.put(t.googFrameHeightSent),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){l=i[u].googLocalAddress.split(":");e.userIp=l[0],e.url=i[u].googRemoteAddress;c=i[u].googLocalCandidateType;e.sessionType=c,e.protocol=x(c)}}}else if(t.id.indexOf("_recv")>-1){s=void 0;m&&m[t.id]&&(s=8*(t.bytesReceived-m[t.id].bytesReceived)),factorReports.audio.inbound.bitRate.put(s),factorReports.audio.inbound.jitter.put(t.googJitterReceived);n=void 0;if(m&&m[t.id]){a=t.packetsLost-m[t.id].packetsLost,r=t.packetsReceived-m[t.id].packetsReceived;n=o(t.packetsLost,t.packetsReceived,"audio.inbound")}if(factorReports.audio.inbound.packetsLost=a,factorReports.audio.inbound.packetsReceived=r,factorReports.audio.inbound.packetLossRate.put(n),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){l=i[u].googLocalAddress.split(":");e.userIp=l[0],e.url=i[u].googRemoteAddress;c=i[u].googLocalCandidateType;e.sessionType=c,e.protocol=x(c)}}else if(t.id.indexOf("_send")>-1){s=void 0;m&&m[t.id]&&(s=8*(t.bytesSent-m[t.id].bytesSent)),factorReports.audio.outbound.bitRate.put(s),factorReports.audio.outbound.rtt.put(t.googRtt);var u;n=void 0;if(m&&m[t.id]){a=t.packetsLost-m[t.id].packetsLost,d=t.packetsSent-m[t.id].packetsSent;n=o(t.packetsLost,t.packetsSent,"audio.outbound")}if(factorReports.audio.outbound.packetsLost=a,factorReports.audio.outbound.packetsSent=d,factorReports.audio.outbound.packetLossRate.put(n),t.transportId&&t.transportId.indexOf("Channel-")>-1)if(void 0!==(u=i[t.transportId].selectedCandidatePairId)){l=i[u].googLocalAddress.split(":");e.userIp=l[0],e.url=i[u].googRemoteAddress;c=i[u].googLocalCandidateType;e.sessionType=c,e.protocol=x(c)}}}var d="initial",u=null,g=1e3,m=null,p=e.conversation.getParticipants(),v={},S={},_=e.conversation.getLocalParticipant().getStreamInfo(e.avStream.getId()).getQualityMonitor(),f=_.factorMonitors,C=e.callConfig,b=null,E=null,R=null;var A=!1,T=!1,y=!1,I=function(e,t){this.value,this.isVideo=e,this.isInbound=t,this.statistics={peak:0,bottom:0,count:0,sdv:0,mean:0,oldMean:0,S:0,oldS:0}};I.prototype={put:function(e){return void 0===e||isNaN(e)?void(this.value=void 0):e<0?void(this.value=e):(e*=1,this.value=e,this.statistics.count++,1===this.statistics.count?(this.statistics.peak=e,this.statistics.bottom=e):(this.statistics.peak<e&&(this.statistics.peak=e),this.statistics.bottom>e&&(this.statistics.bottom=e)),void(1===this.statistics.count?(this.statistics.oldMean=e,this.statistics.mean=e):(this.statistics.mean=this.statistics.oldMean+(e-this.statistics.oldMean)/this.statistics.count,this.statistics.S=this.statistics.oldS+(e-this.statistics.oldMean)*(e-this.statistics.mean),this.statistics.oldMean=this.statistics.mean,this.statistics.oldS=this.statistics.S,this.statistics.sdv=this.statistics.count>1?Math.sqrt(this.statistics.S/(this.statistics.count-1)):0)))},alarmPut:function(t,i,o,s){void 0===this.publishedValue&&(this.publishedValue=c.ExperienceStatus.NOT_AVAILABLE,this.lastValue=c.ExperienceStatus.NOT_AVAILABLE,this.keepCount=0);var n=this.publishedValue;if(k(this))t!==this.publishedValue&&(t===this.lastValue?(this.keepCount=this.keepCount+1,this.keepCount===_.__keepCount&&(this.publishedValue=t)):this.keepCount=1,!0===s&&(this.publishedValue=t));else{var a=e.callState.state===c.CALLSTATE.UPDATING?e.lastCallConfig:e.callConfig;if(a.audioConfig===C.audioConfig&&a.videoConfig===C.videoConfig)return;this.publishedValue=c.ExperienceStatus.NOT_AVAILABLE,o={},t=c.ExperienceStatus.NOT_AVAILABLE}var r=f[i];n!==this.publishedValue?("function"==typeof r&&r.call(_,this.publishedValue,o),v[i]={value:this.publishedValue,hints:o}):"function"==typeof r&&"function"!=typeof S[i]&&r.call(_,this.publishedValue,o),S[i]=r,this.lastValue=t,this.put(t)},triggerPut:function(e,t,i){var o=e&&Math.floor(e),s=this.value&&Math.floor(this.value),n=_[t];i||(i=[o]),s!==o?"function"==typeof n&&(n.apply(_,i),S[t]=n):"function"==typeof n&&"function"!=typeof S[t]&&(n.call(_,i),S[t]=n),this.put(e)},toJSON:function(){return 0==this.statistics.count?{peak:"N/A",bottom:"N/A",count:"N/A",sdv:"N/A",mean:"N/A"}:{peak:void 0===this.statistics.peak?void 0:this.statistics.peak%1==0?this.statistics.peak:1*this.statistics.peak.toFixed(2),bottom:void 0===this.statistics.bottom?void 0:this.statistics.bottom%1==0?this.statistics.bottom:1*this.statistics.bottom.toFixed(2),count:this.statistics.count,sdv:void 0===this.statistics.sdv?void 0:this.statistics.sdv%1==0?this.statistics.sdv:1*this.statistics.sdv.toFixed(2),mean:void 0===this.statistics.mean?void 0:this.statistics.mean%1==0?this.statistics.mean:1*this.statistics.mean.toFixed(2)}}};var w=function(e,t){this.value,this.isVideo=e,this.isInbound=t};w.prototype={put:function(e){this.value=e},toJSON:function(){return this.value}};var k=function(t){var i=e.callConfig;return e.callState.state===c.CALLSTATE.UPDATING&&(i=e.lastCallConfig),t.isInbound&&t.isVideo&&i.shouldReceiveVideo()||t.isInbound&&!t.isVideo&&i.shouldReceiveAudio()||!t.isInbound&&t.isVideo&&i.shouldSendVideo()||!t.isInbound&&!t.isVideo&&i.shouldSendAudio()},L=new i,O=new i,P=!0,M=!1,N=!0,D=!1,x=function(e){var t=void 0;return"local"===e||"host"===e?t=c.PROTOCOL.HOST:"srflx"===e?t=c.PROTOCOL.STUN:"relay"!==e&&"relayed"!==e||(t=c.PROTOCOL.TURN),t},V=0,U=function(o){if(0!==Object.keys(o).length){if(null!=m)try{if(V>=20){var d=e.generateIntermidateAuditData();if(t(e,d),e.avStream&&e.avStream.onQualityMetrics){var u=d.streams[0];e.avStream.onQualityMetrics(u.stream_id,u.data)}O=new i,V=0}else V++;for(var g in o){var p=o[g];s.browser.isChrome?(n(p,o,O),n(p,o)):s.browser.isFirefox?(a(p,o,O),a(p,o)):s.browser.isSafari?(r(p,o,O),r(p,o)):s.browser.isIE&&l(p,o)}L.calculateMOS(),O.calculateMOS(),void 0!==window.__debug_monitor_data_detail__&&!0===window.__debug_monitor_data_detail__&&function e(t,i){e.__headerPrinted||(e.__headerPrinted=!0,h.debug("==audio==inbound.bitRate,inbound.rtt,inbound.packetsReceived,inbound.packetsLost,inbound.jitter,inbound.packetLossRate,outbound.bitRate,outbound.rtt,outbound.packetsSent,outbound.packetsLost,outbound.jitter,outbound.packetLossRate,inbound.mos,outbound.mos,inbound.publishedMos,outbound.publishedMos"),h.debug("==video==inbound.bitRate,inbound.rtt,inbound.packetsReceived,inbound.packetsLost,inbound.jitter,inbound.packetLossRate,inbound.frameRate,inbound.resolutionWidth*inbound.resolutionHeight,outbound.bitRate,outbound.rtt,outbound.packetsSent,outbound.packetsLost,outbound.jitter,outbound.packetLossRate,outbound.frameRate,outbound.resolutionWidth*outbound.resolutionHeight,inbound.mos,outbound.mos,inbound.publishedMos,outbound.publishedMos")),h.debug("==audio=="+i.audio.inbound.bitRate.value+","+i.audio.inbound.rtt.value+","+i.audio.inbound.packetsReceived+","+i.audio.inbound.packetsLost+","+i.audio.inbound.jitter.value+","+i.audio.inbound.packetLossRate.value+","+i.audio.outbound.bitRate.value+","+i.audio.outbound.rtt.value+","+i.audio.outbound.packetsSent+","+i.audio.outbound.packetsLost+","+i.audio.outbound.jitter.value+","+i.audio.outbound.packetLossRate.value+","+i.mos.inbound.audio.lastValue+","+i.mos.outbound.audio.lastValue+","+i.mos.inbound.audio.publishedValue+","+i.mos.outbound.audio.publishedValue),h.debug("==video=="+i.video.inbound.bitRate.value+","+i.video.inbound.rtt.value+","+i.video.inbound.packetsReceived+","+i.video.inbound.packetsLost+","+i.video.inbound.jitter.value+","+i.video.inbound.packetLossRate.value+","+i.video.inbound.frameRate.value+","+i.video.inbound.resolutionWidth.value+"*"+i.video.inbound.resolutionHeight.value+","+i.video.outbound.bitRate.value+","+i.video.outbound.rtt.value+","+i.video.outbound.packetsSent+","+i.video.outbound.packetsLost+","+i.video.outbound.jitter.value+","+i.video.outbound.packetLossRate.value+","+i.video.outbound.frameRate.value+","+i.video.outbound.resolutionWidth.value+"*"+i.video.outbound.resolutionHeight.value+","+i.mos.inbound.video.lastValue+","+i.mos.outbound.video.lastValue+","+i.mos.inbound.video.publishedValue+","+i.mos.outbound.video.publishedValue),h.debug("==stats==",t)}(o,L)}catch(e){h.debug("Error happens when extractDataFromStats: ",e)}C=e.callState.state===c.CALLSTATE.UPDATING?e.lastCallConfig:e.callConfig,m=o}},B=function(){var t=e.getPeerConnection();null==t||"connected"!==t.iceConnectionState&&"completed"!==t.iceConnectionState||(b=t.iceConnectionState,t.getStats(null).then(function(e){var t={};s.browser.isFirefox||s.browser.isSafari?e.forEach(function(e){t[e.id]=e}):t=e,U(t)}).catch(function(e){h.warn("Error when get statistics.",e)})),null!=t&&"disconnected"===t.iceConnectionState&&"disconnected"!==b&&(b="disconnected",function(){var e=c.ExperienceStatus.NOT_AVAILABLE;"undefined"!=typeof factorReports&&(s.browser.isFirefox||factorReports.mos.inbound.audio.alarmPut(e,c.ExperienceFactor.AUDIO_INBOUND,{},!0),factorReports.mos.inbound.video.alarmPut(e,c.ExperienceFactor.VIDEO_INBOUND,{},!0),s.browser.isFirefox||factorReports.mos.outbound.audio.alarmPut(e,c.ExperienceFactor.AUDIO_OUTBOUND,{},!0),factorReports.mos.outbound.video.alarmPut(e,c.ExperienceFactor.VIDEO_OUTBOUND,{},!0),mosNotify("*"))}())},F=function(){h.debug("getDiagnosticMetricsPeriodically.");var t=e.getPeerConnection();null==t||"connected"!==t.iceConnectionState&&"completed"!==t.iceConnectionState?(h.debug("getDiagnosticMetricsPeriodically... schedule next process for pc.iceConnectionState is: ",null!==t?t.iceConnectionState:"unknown, no peer connection"),E=setTimeout(function(){F()},50)):t.getStats(null).then(function(t){try{for(var i in A||e.getCallConfig().shouldReceiveAudio()||(A=!0),T&&y||e.getCallConfig().shouldReceiveVideo()||(T=!0,y=!0),t){var o=t[i];s.browser.isChrome?"audio"==o.mediaType&&o.id.indexOf("_recv")>-1?(h.debug("audio packetsReceived...",o.packetsReceived),!A&&o.packetsReceived&&o.packetsReceived>1&&(e.session.logEventTimestamp("avFirstAudioPktReceived",o.timestamp.getTime()),A=!0)):"video"==o.mediaType&&o.id.indexOf("_recv")>-1&&(h.debug("video packetsReceived...",o.packetsReceived),!T&&o.packetsReceived&&o.packetsReceived>1&&(e.session.logEventTimestamp("avFirstVideoPktReceived",o.timestamp.getTime()),T=!0),h.debug("framesDecoded...",o.framesDecoded),!y&&o.framesDecoded&&o.framesDecoded>1&&(e.session.logEventTimestamp("avFirstVideoDecoded",o.timestamp.getTime()),y=!0)):s.browser.isFirefox||s.browser.isIE||s.browser.isSafari}}catch(e){h.debug("Error happens when getDiagnosticMetricsPeriodically: ",e)}}).catch(function(e){h.debug("Error when get statistics in getDiagnosticMetricsPeriodically.",e)}).finally(function(){A&&T&&y?(h.debug("getDiagnosticMetricsPeriodically... Done."),z()):(h.debug("getDiagnosticMetricsPeriodically... schedule next process."),E=setTimeout(function(){F()},50))})},z=function(){h.debug("getDiagnosticMetricsPeriodically... stop timers."),clearTimeout(E),clearTimeout(R)};this.getReports=function(){return L.cleanProperties(),e.callConfig.hasAudio()||delete L.audio,e.callConfig.hasVideo()||delete L.video,L},this.getIntermidateReports=function(){return O.cleanProperties(),delete O.mos,e.callConfig.hasAudio()||delete O.audio,e.callConfig.hasVideo()||delete O.video,O},this.start=function(){"running"!==d&&(d="running",s.browser.isChrome&&"audiovideo"==e.streamType&&(F(),h.debug("Start timeout for getDiagnosticMetrics."),R=setTimeout(function(){z()},1e4)),u=setInterval(B,g))},this.stop=function(){d="stopped",clearInterval(u),z()}}function o(e){var t=0,i=function(i){if(i&&(null===e.peerConnection||void 0===e.peerConnection))return h.debug("call.peerConnection: "+e.peerConnection+", the call may need to be updated."),!0;var o=e.getIceConnectionState();return"connected"===o&&t>0&&(h.debug("ICE connection state gets to 'connected', reset the counter to 0."),t=0),t>=3?(h.debug("No more updating. Have updated call to restore ICE failure for "+t+" times."),!1):"failed"===o||i&&"closed"===o},o=function(){var t=e.callState;return t.state===c.CALLSTATE.ESTABLISHED||t.state===c.CALLSTATE.UPDATE_FAILED||t.state===c.CALLSTATE.UPDATED||t.state===c.CALLSTATE.ERROR},s=function(){var s="Call state: "+e.callState.state+", ICE connection state: "+(e.peerConnection?e.getIceConnectionState():"peerConnection is null")+", Retry number: "+(t+1);o()&&i(!0)?(e.resumeState=c.RESUME_STATE.updateCallByIceFailure,t+=1,h.debug("Do call update to fix the ICE failure. "+s),e.update(e.callConfig)):h.debug("No update is needed to fix the ICE failure. "+s)};this.updateIceConnectionState=function(t){t.target===e.peerConnection&&i()&&o()&&(h.debug("Waiting for receiving any message from session web socket... "),function(t){var i=e.session.lastActiveTime,o=function(){i!=e.session.lastActiveTime?(h.debug("Waiting for receiving any message from session web socket... Done"),t()):setTimeout(function(){o()},50)};o()}(function(){var t=e.session.sessionState;if(t===c.SESSIONSTATE.CONNECTED)s();else{h.debug("Session state: "+t+", waiting for session state CONNECTED.");var i=e.session.setSessionState.bind(e.session);e.session.setSessionState=function(t){return t===c.SESSIONSTATE.CONNECTED&&(e.session.setSessionState=i,s()),i(t)}}}))}}var s=e._private=e._private||{},n={},a=s.CallStateMachine,r=s.CallCommonUtils,l=s.rtcHelper,c=s.wscConst,d=s.wscUtils,u=s.DataTransfer,h=e.getLogger(),g=(e.getLogLevel(),new WeakMap),m=function(e,t){"use strict";if(!e){var i="The parameter 'session' cannot be null!";throw h.error(i),i}this.packageType=t||c.PACKAGE.CALL,e.registerPackage(this),this.session=e,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.videoSendBitrate=!1,this.videoRecvBitrate=!1,this.removeVideoFec=!1,this.onIncomingCall=null,this.onResurrect=null};m.prototype={getCalls:function(){"use strict";var e=[],t=this.session.getSubSessionsByPackageType(this.packageType),i=null;if(t){i=t.values();for(var o=0;o<i.length;o++)e[o]=i[o]}return e},createCall:function(e,t,i){"use strict";var o,s,n=this.session,a=this.session.userName;if(null==e||""===e)throw s="The callee cannot be empty!",h.warn(s),"CallPackage.createCall(): Empty callee exception.";return(o=this.prepareCall(n,t,a,e)).subSessionId=n.generateSubSessionId(),o.onCallError=i,o.pkgInstance=this,this.putCall(o.subSessionId,o),o},close:function(){"use strict";for(var e=this.getCalls(),t=0;t<e.length;t++){var i=e[t];i.end(),i=null}},clear:function(){for(var e=this.getCalls(),t=0;t<e.length;t++){var i=e[t];n.clearCall(i),i=null}},onMessage:function(e){"use strict";var t=this.session,i=e.control.subsession_id,o=this.session.getSubSession(i),s=e.getExtHeaders();null==o&&((o=this.prepareCall(t)).pkgInstance=this),s&&(o.lastServerExtHeader=s),o.onMessage(e)},onRehydration:function(t){"use strict";for(var i in t.entry){var o,s=t.entry[i],n=s.caller,a=s.callee,r=s.callConfig,c=new e.CallConfig(r.audioConfig,r.videoConfig,r.dataChannelConfig),d=this.prepareCall(this.session,c,n,a);if(d.pkgInstance=this,d.callState=new e.CallState(s.callState.state,s.callState.status.code,s.callState.status.reason),d.earlyMediaState=s.earlyMediaState,d.subSessionId=s.subSessionId,s.remoteMedias&&s.remoteMedias.length){o=[];for(var u=0;u<s.remoteMedias.length;u++){var h=s.remoteMedias[u],g=new l.Media(h.mode,h.port,h.type);o[u]=g}}d.remoteMedias=o,d.offerAnswerManager.updateState(s.offerAnswerManager.masterState),d.offerAnswerManager.updateState(s.offerAnswerManager.slaveState),d.iceTimeout=s.iceTimeout,d.streamId=s.streamId,d.streamType=s.streamType,d.shortCircuitMode=s.shortCircuitMode,this.putCall(i,d),this.onResurrect(d)}},prepareCall:function(e,t,i,o){"use strict";return new p(e,t,i,o)},putCall:function(e,t){this.session.putSubSession(this.packageType,e,t)},setTrickleIceMode:function(e){this.trickleIceMode=e},setIPv6:function(e){this.ipv6=e},setDSCP:function(e){this.dscp=e},setVideoSendBitrate:function(e){this.videoSendBitrate=e},setVideoRecvBitrate:function(e){this.videoRecvBitrate=e},setRemoveVideoFec:function(e){this.removeVideoFec=e},toJSON:function(){var e={},t={session:""};for(var i in this)i in t||(e[i]=this[i]);return e}};var p=function(t,i,a,d){this.session=t,this.caller=a,this.callee=d,this.callConfig=i,this.dataTransfers=new e.Map,this.lastCallConfig=null,this.callState=new e.CallState(c.CALLSTATE.NONE,null,""),this.earlyMediaState=null,this.resumeState=null,this.peerConnection=null,this.onMediaStreamEvent=null,this.onCallStateChange=null,this.onIceConnectionStateChange=null,this.onDataTransfer=null,this.errorLog=[],this.eventLog=[],this.onUpdate=null,this.onCallError=null,this.streamAddTimes=0,this.hungupCallback=null,this.subSessionId=null,this.conversation=null,this.avStream=null,this.streamId="default",this.streamType="audiovideo",this.shortCircuitMode=!1,this.startReqCorrId=null,this.newRemoteSDP=null,this.newRemoteMedias=null,this.remoteMedias=null,this.localMediaStreams=[],this.temporarySavedStreams=[],this.offerAnswerManager=new s.offerAnswerManager(this),this.userIp=null,this.sessionType=null,this.protocol=null,this.url=null,this.mediaServerIp=null,this.callStartOnIceResponse=!1,this.timeRecording={timeToNewPeerConnection:{},timeToGetUserMedia:{},timeToMakeCall:{},timeToGetIceConnection:{},timeToGetIceCandidates:{},timeToGetRemoteMedia:{}};var u=2e3;this.setIceCheckInterval=function(e){if(e<=0)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};u=e},this.getIceCheckInterval=function(){return u},this.setCapabilityExchange=function(e){this.capabilityExchange=e},this._template={doStartCallRequest:function(e){var t=e.payload.sdp,i=this.parent,o=l.getCallConfigFromRemoteSDP(t,!1),s=l.getCallConfigFromRemoteSDP(t,!0),n=this.parent.callState,a=e.control.subsession_id,c=l.getMediaServerIp(t),d=e.getExtHeaders();i.callConfig=o,i.newRemoteSDP=e.payload,i.newRemoteMedias=l.getMediaFromSDP(t),c&&(i.mediaServerIp=c),i.conversation?i.pkgInstance.putCall(a,i.conversation):i.pkgInstance.putCall(a,i),n.is180Ringing()||r.send180Ringing(i);var u=i.pkgInstance.onIncomingCall;u&&(i.conversation?u(i.conversation,i.avStream,s,d):u(i,s,d))},doUpdateCallRequest:function(e){var t=e.payload.sdp,i=this.parent,o=l.getCallConfigFromRemoteSDP(t),s=e.getExtHeaders();i.lastCallConfig=i.callConfig,i.callConfig=o,i.newRemoteMedias=l.getMediaFromSDP(t),i.newRemoteSDP=e.payload,n.handleUpdateCallRequest(i,s)},doStartUnReliableProvRespWithSDP:function(e){n.handleAnswer(this.parent,e.payload)},doStart2XXResponse:function(e){n.handleAnswer(this.parent,e.payload);var t=l.getMediaServerIp(e.payload.sdp);t&&(this.parent.mediaServerIp=t)},doUpdate200Response:function(e){n.handleAnswer(this.parent,e.payload)},doShutdownMessage:function(){n.clearCall(this.parent)},clearCall:function(){n.clearCall(this.parent)},rollbackUpdate:function(){n.rollbackUpdate(this.parent)},doStartCallError:function(){n.clearCall(this.parent)},doStartReliableProvRespWithSDP:function(e){var t=e.payload,i=this.parent;if(t.type="answer",i.offerAnswerManager.getMasterState()===c.OFFER_ANSWER_STATE.OFFER_SENT){l.setRemoteDescription(i,new RTCSessionDescription(t),function(){i.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.ANSWER_GOT,t.sdp),i.lastServerCorrelationId=e.control.correlation_id,r.sendPrack(i),i.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.ACK_SENT)},n.srdError(i))}},doStartReliableProvRespWithoutSDP:function(e){var t=(e.payload,this.parent);t.lastServerCorrelationId=e.control.correlation_id,r.sendPrack(t)},doStart200RespInEarlyPhase:function(e){var i=this.parent;i.earlyMediaState=null,i.setCallState(c.CALLSTATE.RESPONDED,200,"got success response"),e.complete(t),i.setCallState(c.CALLSTATE.ESTABLISHED,null,"sent complete"),r.checkResumeState(i)},doUpdate200RespInEarlyPhase:function(e){var t=this.parent;n.handleAnswer(t,e.payload),t.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.ANSWER_GOT,e.payload.sdp),e.complete(t.session),t.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.ACK_SENT),r.checkResumeState(t)},sendOffer:function(){n.sendOfferImpl(this.parent)}},this._template.parent=this;var h={iceFailureHandler:new o(this),statsCollector:null};g.set(this,h)};return p.prototype={start:function(t,i){function o(t){try{s.callConfig.dataChannelConfig&&n.initDataTransfers(s),n.initOfferCtx(s,t,i)}catch(t){h.error("Start exception: "+t),s.onCallError&&l.invokeCallError(s,e.ERRORCODE.PEERCONNECTION_ERROR,t)}}var s=this;if(h.debug("Call.start()"),s.callState.state!==c.CALLSTATE.NONE&&s.resumeState!==c.RESUME_STATE.reStartingCall)throw"The call has already been started";if(i&&(s.extHeaders=i),t&&(s.localMediaStreams=[].concat(t)),this.callStartOnIceResponse||0!==this.session.iceServerListFromServer.length){this.callStartOnIceResponse=!1,this.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.CALL_START);var a=s.callConfig.shouldSendAudio(),r=s.callConfig.shouldSendVideo();a||r?s.localMediaStreams&&s.localMediaStreams.length>0?o(s.localMediaStreams):n.initUserMedia(s,function(e){o([e])},function(e){h.error("Cannot get local stream... ",e),s.fireMediaStreamEvent(c.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null)}):o(s.localMediaStreams)}else h.info("There are no TURN candidates available when starting call"),this.callStartOnIceResponse=!0,this.session.iceServerEnquirer.doIceEnquiry(function(){s.start(s.localMediaStreams,s.extHeaders)})},getDataTransfer:function(e){return this.dataTransfers.get(e)},getCaller:function(){return this.caller},getCallee:function(){return this.callee},getCallState:function(){return this.callState},getCallConfig:function(){return this.callConfig?new e.CallConfig(this.callConfig.audioConfig,this.callConfig.videoConfig,this.callConfig.dataChannelConfig):null},getPeerConnection:function(){return this.peerConnection},getIceConnectionState:function(){return this.peerConnection?""+this.peerConnection.iceConnectionState:"closed"},restartIceConnections:function(){h.debug("restartIceConnections called"),this.resumeState=c.RESUME_STATE.updateCallByIceFailure,this.update(this.callConfig)},canUpdate:function(){return h.debug("canUpdate() - ICE connection state is: "+this.getIceConnectionState()+", call state is: "+this.callState.state),this.callState.state===c.CALLSTATE.ESTABLISHED||this.callState.state===c.CALLSTATE.UPDATE_FAILED||this.callState.state===c.CALLSTATE.UPDATED?"checking"===this.getIceConnectionState()?(h.debug("canUpdate() - Update denied, invalid ICE state: "+this.getIceConnectionState()),!1):(h.debug("canUpdate() - Update allowed"),!0):(h.debug("canUpdate() - Update denied, invalid call state: "+this.callState.state),!1)},toJSON:function(){return{caller:this.caller,callee:this.callee,callConfig:this.callConfig,callState:this.callState,earlyMediaState:this.earlyMediaState,subSessionId:this.subSessionId,remoteMedias:this.remoteMedias,offerAnswerManager:this.offerAnswerManager,iceTimeout:this.iceTimeout,onDataTransfer:this.onDataTransfer,onCallError:this.onCallError,onUpdate:this.onUpdate,onCallStateChange:this.onCallStateChange,onMediaStreamEvent:this.onMediaStreamEvent,streamId:this.streamId,streamType:this.streamType}},statsStart:function(){try{if(null!=this.conversation){var e=g.get(this).statsCollector;null==e&&(e=g.get(this).statsCollector=new i(this),h.log("Call - statsCollector start"),e.start())}}catch(e){h.warn("Error happens when doing peer connection stats collector start: "+e)}},statsStop:function(){try{var e=g.get(this).statsCollector;null==e&&(e=g.get(this).statsCollector=new i(this),h.log("Call - statsCollector stop"),e.stop())}catch(e){h.warn("Error happens when doing peer connection stats collector stop: "+e)}},setCallState:function(e,o,s){if(!this.callState.isFinalState()){try{if(null!=this.conversation&&e===c.CALLSTATE.ESTABLISHED)null==(n=g.get(this).statsCollector)&&(n=g.get(this).statsCollector=new i(this)).start();else if(null!=this.conversation&&(e===c.CALLSTATE.ENDED||e===c.CALLSTATE.FAILED)){var n;null!=(n=g.get(this).statsCollector)&&n.stop()}}catch(e){h.warn("Error happens when doing peer connection stats collector start/stop: "+e)}r.setCallState(this,e,o,s);try{if(null!=this.conversation&&(e===c.CALLSTATE.ENDED||e===c.CALLSTATE.FAILED)){h.debug("verbose logging is enabled? "+this.session.enableVerbose);var a=this.generateAuditData();if(this.session.__externalAuditData__&&this.conversation.streams.size()<=1){var l=a.externalData||{};l.events=this.session.__externalAuditData__.slice(0),a.externalData=l,this.session.__externalAuditData__.length=0}t(this,a)}}catch(e){h.warn("Error happens when sending audit data to server: "+e)}}},fireMediaStreamEvent:function(e,t){"use strict";if(this.onMediaStreamEvent)try{if(this.lastServerExtHeader){var i=this.lastServerExtHeader;this.onMediaStreamEvent(e,t,i),delete this.lastServerExtHeader}else this.onMediaStreamEvent(e,t)}catch(e){h.warn("The callback function 'Call.onMediaStreamEvent()' exception:"+e)}},mute:function(e){return null===this.peerConnection?(h.error("Cannot get the audio track. failed to mute audio!"),!1):(l.getLocalStreams(this.peerConnection).map(function(t){"undefined"!=typeof RTCRtpReceiver&&t instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?t.track&&"audio"===t.track.kind&&(t.track.enabled=!e):t.getAudioTracks().map(function(t){t.enabled=!e})}),!0)},isMuted:function(){return null===this.peerConnection?(h.debug("Cannot get the audio track, assuming not muted"),!1):l.getLocalStreams(this.peerConnection).some(function(e){return"undefined"!=typeof RTCRtpReceiver&&e instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e instanceof RTCRtpSender?e.track&&"audio"===e.track.kind?!1===e.track.enabled:void 0:e.getAudioTracks().some(function(e){return!1===e.enabled})})},getRemoteStreams:function(){return l.getRemoteStreams(this.peerConnection)},decline:function(e,t){"use strict";try{null==e&&(e=c.ERRORCODE.DECLINED),this.callState.state===c.CALLSTATE.UPDATING?(h.debug("Update declined"),this.callConfig=this.lastCallConfig,this.setCallState(c.CALLSTATE.UPDATE_FAILED,e,"Decline")):(h.debug("Call declined"),l.clearPeerConnection(this),this.peerConnection=null,this.session.removeSubSession(this.subSessionId),this.setCallState(c.CALLSTATE.FAILED,e,"Decline")),r.sendReject(this,e,null,t),h.info("decline call.")}catch(e){h.error("answer error: "+e)}},accept:function(t,i,o){"use strict";function s(t){try{n.initAnswerCtx(a,t,o)}catch(t){h.error("Got exception when accept the call: "+t),a.onCallError&&l.invokeCallError(a,e.ERRORCODE.PEERCONNECTION_ERROR,t)}}var a=this;t||(t=this.callConfig);try{if(this.setCallState(c.CALLSTATE.STARTED,null,"receive call"),!n.isValidAnswerCallConfig(this.callConfig,t))throw{name:"InvalidCallConfig",message:"The parameter 'callConfig' is invalid."};if(this.callState.state===c.CALLSTATE.UPDATING&&null!=this.peerConnection)n.onUpdateCall(this,t,i,o);else{t&&(this.callConfig=t);var r=t.shouldSendAudio(),d=t.shouldSendVideo();r||d?i?s(i):n.initUserMedia(a,function(e){s([e])},function(e){h.error("Cannot get local stream... ",e),a.fireMediaStreamEvent(c.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),a.decline()}):s()}h.debug("accept call")}catch(e){throw h.error("answer error: "+e),e}},end:function(e){this.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.CALL_END);var t=r.createMessage(this),i="cancelled";t.header.action=c.ACTION.SHUTDOWN,t.addExtHeaders(e),this.callState.state===c.CALLSTATE.NONE||this.callState.isFinalState()||(this.callState.hasEstablished()?(t.control.correlation_id=this.session.genNewCorrelationId(),i="shutdown"):(t.control.correlation_id=this.startReqCorrId,i="cancelled"),this.session.sendMessage(t)),n.clearCall(this),this.setCallState(c.CALLSTATE.ENDED,"",i)},update:function(e,t,i){this.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.CALL_UPDATE),this.setCallState(c.CALLSTATE.UPDATING,"","update"),n.updateCall(this,e,t,i)},resume:function(e,t){h.info("Begin to resume call");var i=this,o=i.temporarySavedStreams;if(i.resumeSuccessCallback=e,i.resumeFailureCallback=t,i.session.clientIpNotChangedAfterReconnect)return h.debug("Client network was not changed, no further action needed."),void(i.resumeSuccessCallback&&i.resumeSuccessCallback());if(i.resumeState===c.RESUME_STATE.updateCallByIceFailure)return h.debug("The call is under updated by IceFailureHandler, no further action needed."),void(i.resumeSuccessCallback&&i.resumeSuccessCallback());i.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.NETWORK_SWITCHED);var s=i.offerAnswerManager.getMasterState(),n=i.offerAnswerManager.getSlaveState(),a=c.OFFER_ANSWER_STATE;switch(h.debug("The m/s offer-answer states are: "+s+"/"+n),s){case a.INITIAL:switch(n){case a.OFFER_REJECT:case a.INITIAL:case a.OFFER_GOT:i.resumeSuccessCallback&&i.resumeSuccessCallback();break;case a.ANSWER_SENT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o);break;case a.ACK_GOT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o)}break;case a.OFFER_SENT:switch(n){case a.OFFER_REJECT:case a.INITIAL:case a.OFFER_GOT:case a.ACK_GOT:i.resumeState=c.RESUME_STATE.waittingFinalResp,i.resumeSuccessCallback&&i.resumeSuccessCallback()}break;case a.ANSWER_GOT:switch(n){case a.OFFER_REJECT:case a.INITIAL:case a.OFFER_GOT:case a.GLARE:case a.ACK_GOT:case a.ANSWER_SENT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o)}break;case a.ACK_SENT:switch(n){case a.OFFER_GOT:i.resumeSuccessCallback&&i.resumeSuccessCallback();break;case a.ANSWER_SENT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o);break;case a.INITIAL:case a.OFFER_REJECT:case a.ACK_GOT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o)}break;case a.OFFER_REJECTED:switch(n){case a.OFFER_REJECT:case a.INITIAL:case a.ACK_GOT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o);break;case a.OFFER_GOT:i.resumeSuccessCallback&&i.resumeSuccessCallback();break;case a.ANSWER_SENT:i.resumeState=c.RESUME_STATE.reStartingCall,i.start(o)}}},onMessage:function(e){var t=this,i=[];if(this.session.iceServerListFromServer.length>0&&(i=this.session.iceServerListFromServer),h.debug("iceServers="+JSON.stringify(i,null,2)),this.callStartOnIceResponse||0!==i.length)if(e.isEnquiry()){if(!this.capabilityExchange){var o="No CapabilityExchange registered with this call";throw h.error(o),o}this.capabilityExchange.onMessage(e)}else e.isRequest()?a.doRequest(this,e):e.isResponse()?a.doResponse(this,e):e.isMessage()?a.doMessage(this,e):e.isError()?a.doError(this,e):r.doUnexpectedMsg(this,e);else h.info("There are no TURN candidates available on receiving start"),this.callStartOnIceResponse=!0,this.session.iceServerEnquirer.doIceEnquiry(function(){t.onMessage(e)})},collectClientLog:function(e,t){var i=new Date;t="["+(("0"+(i.getMonth()+1)).slice(-2)+"/"+("0"+i.getDate()).slice(-2)+"/"+i.getFullYear()+" "+("0"+i.getHours()).slice(-2)+":"+("0"+i.getMinutes()).slice(-2)+":"+("0"+i.getSeconds()).slice(-2)+"."+("00"+i.getMilliseconds()).slice(-3))+"]"+t,"error"===e?this.errorLog.push(t):"event"===e&&this.eventLog.push(t)},generateIntermidateAuditData:function(){var e={};e.stream_id=this.avStream.getId();var t=g.get(this).statsCollector,i=null==t?{}:t.getIntermidateReports();for(var o in e.data={},i)e.data[o]=i[o];var s={};return s["conversation-id"]=this.conversation.getLocalId(),s.streams=[],s.streams.push(e),s},generateAuditData:function(){var e={};e.stream_id=this.avStream.getId();var t=g.get(this).statsCollector,i=null==t?{}:t.getReports();for(var o in e.data={},i)e.data[o]=i[o];this.session.__isDAE__&&(e.data.isDAE="true"),e.data.timeToNewPeerConnection=this.timeRecording.timeToNewPeerConnection.end-this.timeRecording.timeToNewPeerConnection.start,e.data.timeToGetUserMedia=this.timeRecording.timeToGetUserMedia.end-this.timeRecording.timeToGetUserMedia.start,e.data.timeToSetupSignalingChannel=this.session.timeToInitWebSocket,void 0!==this.timeRecording.timeToMakeCall.end&&void 0!==this.timeRecording.timeToMakeCall.start&&(e.data.timeToMakeCall=this.timeRecording.timeToMakeCall.end-this.timeRecording.timeToMakeCall.start),e.data.timeToGetIceCandidates=this.timeRecording.timeToGetIceCandidates.end-this.timeRecording.timeToGetIceCandidates.start,e.data.timeToGetIceCandidates<0&&(e.data.timeToGetIceCandidates=0),e.data.timeToGetIceConnection=this.timeRecording.timeToGetIceConnection.end-this.timeRecording.timeToGetIceConnection.start,e.data.timeToGetIceConnection<0&&(e.data.timeToGetIceConnection=0);var n=this.timeRecording.timeToGetRemoteMedia.end-this.timeRecording.timeToGetIceCandidates.start;n>=0&&(e.data.timeToGetRemoteMedia=n),e.data.errorLog=this.errorLog,e.data.eventLog=this.eventLog,e.data.userId=this.session.userName,e.data.userIp=this.userIp,e.data.sessionId=this.session.sessionId,e.data.sessionType=this.sessionType,e.data.protocol=this.protocol,e.data.url=this.url,e.data.mediaServerIp=this.mediaServerIp;var a={};s.browser.isFirefox?a.clientType="firefox":s.browser.isChrome?a.clientType="chrome":s.browser.isEdge?a.clientType="edge":s.browser.isIE?a.clientType="ie":s.browser.isSafari&&(a.clientType="safari"),a.version=s.browser.version,e.data.deviceInformation=a,e.data.participants=this.conversation.__participantsHistory;var r={};return r["conversation-id"]=this.conversation.getLocalId(),r.streams=[],r.streams.push(e),r}},n.sendOffer=function(e,t){e.offerAnswerManager.canSendOffer()?e.peerConnection&&e.peerConnection.localDescription&&e.peerConnection.localDescription.sdp&&n.sendOfferImpl(e,t):h.debug("Cannot send offer")},n.sendOfferImpl=function(e,t){if(e.callState.state===c.CALLSTATE.ENDED||e.callState.state===c.CALLSTATE.FAILED)h.warn("Call has ended while sending offer, clear the call."),n.clearCall(e);else{var i,o=r.createRequest(e),s=e.session.genNewCorrelationId();if(!e.peerConnection)return void h.warn("The peerConnection of the call is null");i=e.peerConnection.localDescription.sdp,o.header.action=c.ACTION.START,o.control.correlation_id=s,o.payload={sdp:i},t?o.addExtHeaders(t):e.extHeaders&&(o.addExtHeaders(e.extHeaders),e.extHeaders=null);e.authInfo&&(o.header.authorization=e.authInfo,!0,e.authInfo=null);try{e.session.sendMessage(o),e.startReqCorrId=o.control.correlation_id,e.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.OFFER_SENT,i),e.callState.state===c.CALLSTATE.NONE&&e.setCallState(c.CALLSTATE.STARTED,null,"start call")}catch(e){}}},n.sendAnswer=function(e,t){if(e.callState.state===c.CALLSTATE.ENDED||e.callState.state===c.CALLSTATE.FAILED)h.warn("Call has ended while sending answer, clear the call."),n.clearCall(e);else if(e&&e.peerConnection&&e.peerConnection.localDescription&&e.peerConnection.localDescription.sdp){var i=r.createResponse(e),o=e.peerConnection.localDescription.sdp,s=e.lastServerCorrelationId;i.control.message_state=c.MESSAGESTATE.FINAL,i.header.action=c.ACTION.START,i.control.correlation_id=s,t&&i.addExtHeaders(t),i.payload={sdp:o},e.session.sendMessage(i),h.debug("Answer is sent...\r\n"+o),e.setCallState(c.CALLSTATE.RESPONDED,200,"sent success response"),e.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.ANSWER_SENT,o)}},n.sendAnswerInComplete=function(e,t){var i=e.peerConnection.localDescription.sdp,o=r.createMessage(e);o.header.action=c.ACTION.COMPLETE,o.control.correlation_id=e.startReqCorrId,o.payload={sdp:i},t&&o.addExtHeaders(t),e.session.sendMessage(o),e.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.ACK_SENT,i),e.setCallState(c.CALLSTATE.ESTABLISHED,null,"sent complete")},n.initOfferCtx=function(t,i,o){"use strict";var s=t.peerConnection,a=function(){n.sendOffer(t,o),t.timeRecording.timeToMakeCall.end=(new Date).getTime()};null==t.peerConnection&&(l.createPeerConnection(t,i),s=t.peerConnection),t.callConfig.dataChannelConfig&&n.initDataChannel(t);var r={offerToReceiveAudio:t.callConfig.shouldReceiveAudio()?1:0,offerToReceiveVideo:t.callConfig.shouldReceiveVideo()?1:0};h.debug("Creating offer with constraints ",r),t.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.PEER_CONNECTION_CREATE_OFFER+":"+JSON.stringify(r,null,2)),t.timeRecording.timeToMakeCall.start=(new Date).getTime(),s.createOffer(r).then(function(e){var i=l.changeSdpByCallConfig(e.sdp,t);n.bindIceConnectionStateChangeHandler(t),l.setLocalDescription(t,new RTCSessionDescription({type:"offer",sdp:i}),function(){n.bindIceHandler(t,a,!0)})}).catch(function(i){h.error("Offer error:"+i),l.invokeCallError(t,e.ERRORCODE.GENERATE_SDP_ERROR,i)}),t.peerConnection=s},n.initAnswerCtx=function(t,i,o){"use strict";var s=t.peerConnection;null==t.peerConnection&&(l.createPeerConnection(t,i),s=t.peerConnection),t.callConfig.dataChannelConfig&&n.initReceivedDataChannel(t);var a=t.newRemoteSDP;a.type="offer";var r=new RTCSessionDescription(a);n.bindIceConnectionStateChangeHandler(t),l.setRemoteDescription(t,r,function(){var i=function(){n.sendAnswer(t,o)};t.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.PEER_CONNECTION_CREATE_ANSWER),s.createAnswer().then(function(o){h.debug("Answer SDP",o);var s=l.changeSdpByCallConfig(o.sdp,t);l.setLocalDescription(t,new RTCSessionDescription({type:"answer",sdp:s}),function(){n.bindIceHandler(t,i,!1)},function(i){h.warn("Set localDescription failed!"),l.invokeCallError(t,e.ERRORCODE.PEERCONNECTION_ERROR,i)})}).catch(function(i){h.error("Answer error:"+i),l.invokeCallError(t,e.ERRORCODE.GENERATE_SDP_ERROR,i)})},n.srdError(t))},n.clearCall=function(e){"use strict";e&&n.clearDataTransfers(e.dataTransfers);try{l.clearPeerConnection(e),e.peerConnection=null}catch(e){h.error("clear call error: "+e)}var t=e.localMediaStreams;if(t)for(var i=0;i<t.length;i++){var o=t[i];h.debug("Media stream "+i+": used by "+o.peerConnectionNum+" peer connections."),o&&(null==o.peerConnectionNum||o.peerConnectionNum<=0)&&("undefined"!=typeof RTCRtpReceiver&&o instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&o instanceof RTCRtpSender?(o.track&&"video"===o.track.kind&&(h.debug("Stop this media stream: [video tracks: 1, audio tracks: 0]"),o.track.enabled=!1,o.track.stop()),o.track&&"audio"===o.track.kind&&(h.debug("Stop this media stream: [video tracks: 0, audio tracks: 1]"),o.track.enabled=!1,o.track.stop())):(h.debug("Stop this media stream: [video tracks: "+o.getVideoTracks().length+", audio tracks: "+o.getAudioTracks().length+"]"),o.getAudioTracks().forEach(function(e){e.enabled=!1,e.stop()}),o.getVideoTracks().forEach(function(e){e.enabled=!1,e.stop()})))}e.conversation||e.session.removeSubSession(e.subSessionId)},n.clearDataTransfers=function(e){"use strict";if(e&&0!==e.size())for(var t=e.values(),i=0;i<t.length;i++)t[i].clear()},n.rollbackUpdate=function(e){"use strict";if(e&&e.peerConnection){var t=e.peerConnection.remoteDescription;if(t){h.debug("Altering type of remote SDP via reconstruction (in case original object is ready only)");var i=new RTCSessionDescription({type:"answer",sdp:t.sdp});l.setRemoteDescription(e,i)}e.lastCallConfig&&(e.callConfig=e.lastCallConfig)}},n.updateCall=function(e,t,i,o){e.lastCallConfig=e.callConfig,e.callConfig=t;n.bindIceConnectionStateChangeHandler(e),n.doUpdate(e,t,i,function(t,i,o){h.debug("createOffer with media constraints: "+JSON.stringify(o,null,2)),e.peerConnection.createOffer(t,i,o)},function(){},function(){n.bindIceHandler(e,function(){n.sendOffer(e,o)},!0)},!0)},n.closePcForUpdate=function(e,t){for(var i=l.getLocalStreams(e),o=0;o<i.length;o++){var s=i[o];s.peerConnectionNum&&s.peerConnectionNum--}"closed"!==e.signalingState&&e.close()},n.handleMediaStreamForUpdate=function(e,t,i,o){var s=!1,n=!1,a=(e.peerConnection,e.localMediaStreams),r=!1,c=function(t,i,o){for(var s=!1,n=0;n<t.length;n++){h.debug("round the loop: "+n+" s is "+a);var a=t[n];if(a){var r=!1,c=!1;if("undefined"!=typeof RTCRtpReceiver&&a instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&a instanceof RTCRtpSender)a.track&&"audio"===a.track.kind&&(r=!0),a.track&&"video"===a.track.kind&&(c=!0);else{var d=a.getAudioTracks(),u=a.getVideoTracks();r=d&&d.length>0,c=u&&u.length>0}h.debug("hasAudio: "+r),h.debug("hasVideo: "+c),h.debug("handleMediaStreamForUpdate: needAudio="+i+", hasAudio="+r+", needVideo="+o+", hasVideo="+c),i===r&&o===c&&(l.addLocalStream(e,a),s=!0)}}return s};return t&&(r=c(t,i,o)),!r&&a&&(r=c(a,i,o)),i&&!o?s=!r:!i&&o?n=!r:i&&o&&(r||(s=n=!0,t&&(s=!c(t,!0,!1),n=!c(t,!1,!0)),(s||n)&&a&&(s&&(s=!c(a,!0,!1)),n&&(n=!c(a,!1,!0))))),h.debug("handleMediaStreamForUpdate: needNewAudioStream="+s+", needNewVideoStream="+n),{needNewAudioStream:s,needNewVideoStream:n}},n.initUserMedia=function(t,i,o,s){"use strict";s||(s={audio:t.callConfig.shouldSendAudio(),video:t.callConfig.shouldSendVideo()}),h.debug("getUserMedia with media options: "+JSON.stringify(s,null,2));try{var n={};n.start=(new Date).getTime(),t.timeRecording.timeToGetUserMedia=n,navigator.mediaDevices.getUserMedia(s).then(function(e){if(t.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.GET_USER_MEDIA),t.timeRecording.timeToGetUserMedia.end=(new Date).getTime(),t.callState){var o=t.callState.state;if(o===c.CALLSTATE.END||o===c.CALLSTATE.FAILED)return void h.debug("Got media stream, but the call state is failed or end. So do nothing then.")}i(e)}).catch(function(i){if(h.error("Failed to get access to local media. Error name was "+i.name),t.collectClientLog(c.LOGTYPE.ERROR_LOG,c.ERRORLOG.GET_USER_MEDIA_ERROR+":"+i.name+(""===i.message?"":":"+i.message)),t.callState){var s=t.callState.state;if(s===c.CALLSTATE.END||s===c.CALLSTATE.FAILED)return void h.debug("Failed to get access to local media, but the call state is failed or end. So do nothing then.")}l.invokeCallError(t,e.ERRORCODE.GET_USER_MEDIA_ERROR,i.name+": "+i.message),o&&o(i)})}catch(e){throw h.error("The callConfig is invalid, cause initialize user media exception:"+e),e}},n.handleUpdateCallRequest=function(e,t){"use strict";var i=e.offerAnswerManager.getLatestActiveRemoteSdp();h.debug("The latest active remote SDP is: "+i),h.debug("The latest active remote medias is: "+e.remoteMedias),l.isMediaChanged(e.newRemoteMedias,e.remoteMedias)?(e.setCallState(c.CALLSTATE.UPDATING,null,"onUpdate"),e.onUpdate?e.onUpdate(e.callConfig,t):h.warn("No callback for update call request")):null==e.peerConnection||null==e.peerConnection.localDescription?(h.info("Client is not ready. Reject incoming call."),r.sendReject(e)):(l.createNewPeerConnection(e),e.offerAnswerManager.reset(),e.offerAnswerManager.updateState(c.OFFER_ANSWER_STATE.OFFER_GOT,e.newRemoteSDP.sdp),n.initAnswerCtx(e))},n.handleAnswer=function(e,t){"use strict";if(t.type="answer",e.peerConnection&&t.sdp){try{l.setRemoteDescription(e,new RTCSessionDescription(t),function(){e&&e.peerConnection&&e.peerConnection.remoteDescription})}catch(e){console.warn("Exception handleAnswer: ",e)}}},n.onUpdateCall=function(e,t,i,o){n.bindIceConnectionStateChangeHandler(e),n.doUpdate(e,t,i,function(t,i,o){var s=new RTCSessionDescription({type:"offer",sdp:e.newRemoteSDP.sdp});l.setRemoteDescription(e,s,function(){h.debug("[UPDATE] offer is set as remote description...\r\n"+e.newRemoteSDP.sdp),e.peerConnection.createAnswer().then(t).catch(function(t){i(t),e.decline()})},n.srdError(e))},function(){e.decline()},function(){n.bindIceHandler(e,function(){n.sendAnswer(e,o)},!1)},!1)},n.doUpdate=function(t,i,o,s,a,r,d){"use strict";var u=i,g=!1,m=!1,p=!1,v=!1,S=t.peerConnection;n.rollbackUpdate=function(e){var t=e.peerConnection;e.peerConnection=S,n.closePcForUpdate(t,e),e.lastCallConfig&&(e.callConfig=e.lastCallConfig)};var _=t.temporarySavedStreams;t.temporarySavedStreams=[],l.createPeerConnection(t),t.callConfig.dataChannelConfig&&(d?(n.initDataTransfers(t),n.initDataChannel(t)):n.initReceivedDataChannel(t)),t.temporarySavedStreams=_,u.audioConfig!==c.MEDIADIRECTION.NONE&&(g=!0),u.videoConfig!==c.MEDIADIRECTION.NONE&&(m=!0),u.audioConfig!==c.MEDIADIRECTION.RECVONLY&&u.audioConfig!==c.MEDIADIRECTION.SENDRECV||(p=!0),u.videoConfig!==c.MEDIADIRECTION.RECVONLY&&u.videoConfig!==c.MEDIADIRECTION.SENDRECV||(v=!0),h.debug("doUpdate: needAudioStream="+g+", needVideoStream="+m),h.debug("doUpdate: receiveAudio="+p+", receiveVideo="+v);var f=t.peerConnection,C=f.signalingHandlerForUpdate;f.signalingHandlerForUpdate=function(e){h.debug("signalingState : ",f.signalingState),"stable"===f.signalingState&&(n.closePcForUpdate(S,t),h.debug("Upgrade: the old peer connection is closed.",S),f.signalingHandlerForUpdate=C)};var b=n.handleMediaStreamForUpdate(t,o,g,m),E=function(){if(!t.peerConnection)throw h.error("Peer connection of the call is null."),{name:"Error",message:"Peer connection of the call is null."};s(function(e){t.callConfig=u;var i=l.changeSdpByCallConfig(e.sdp,t);e=new RTCSessionDescription({type:e.type,sdp:i}),h.debug("Updating call: "+e.type+" created... "+e.sdp),l.setLocalDescription(t,e,r)},function(i){h.error("Browser failed to create sdp! The error is: ",i),t.collectClientLog(c.LOGTYPE.ERROR_LOG,c.ERRORLOG.GENERATE_SDP_ERROR),t.setCallState(c.CALLSTATE.UPDATE_FAILED,e.ERRORCODE.PEERCONNECTION_ERROR,i),l.invokeCallError(t,e.ERRORCODE.GENERATE_SDP_ERROR,i),n.rollbackUpdate(t)},{OfferToReceiveAudio:p?1:0,OfferToReceiveVideo:v?1:0})};if(b.needNewAudioStream||b.needNewVideoStream){var R={audio:b.needNewAudioStream,video:b.needNewVideoStream};n.initUserMedia(t,function(i){var o=e.getLogLevel();o===c.LOGLEVEL.DEBUG?h.debug("[UPDATE] got local stream..."+i):o<=c.LOGLEVEL.INFO&&h.info("[UPDATE] got local stream..."),l.addLocalStream(t,i),E()},function(e){h.error("[Update] Cannot get local stream... ",e),t.fireMediaStreamEvent(c.MEDIASTREAMEVENT.LOCAL_STREAM_ERROR,null),a&&a(),n.rollbackUpdate(t)},R)}else E()},n.initDataTransfers=function(e){var t,i=e.callConfig.dataChannelConfig,o=i.length;if(0!==o)for(t=0;t<o;t++){var s=i[t],n=e.dataTransfers.get(s.label);n||(n=new u,e.dataTransfers.put(s.label,n));try{e.onDataTransfer?e.onDataTransfer(n):h.warn("The onDataTransfer() callback function is not set when starting.")}catch(e){h.warn("The callback function 'Call.onDataTransfer()' encountered an exception: "+e)}}},n.initDataChannel=function(e){var t,i=e.peerConnection,o=e.callConfig.dataChannelConfig,s=o.length;if(0!==s)for(t=0;t<s;t++){var n=o[t],a=JSON.parse(JSON.stringify(n));for(var r in delete a.label,a)a.hasOwnProperty(r)&&-1===a[r]&&delete a[r];var l=i.createDataChannel(n.label,a);e.dataTransfers.get(n.label).initDataChannel(l,e.callState.state==c.CALLSTATE.UPDATING)}h.debug("DataChannel is initiated")},n.initReceivedDataChannel=function(e){e.peerConnection.ondatachannel=function(t){h.debug("Data channel is received"),e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_DATA_CHANNEL+":"+t.channel.label);for(var i=t.channel.label,o=!1,s=0;s<e.callConfig.dataChannelConfig.length;s++)i===e.callConfig.dataChannelConfig[s]&&(o=!0);o||e.callConfig.dataChannelConfig.push({label:i,ordered:t.channel.ordered,maxPacketLifeTime:t.channel.maxPacketLifeTime,maxRetransmits:t.channel.maxRetransmits,protocol:t.channel.protocol,negotiated:t.channel.negotiated,id:t.channel.id});var n=e.getDataTransfer(i);n?h.debug("Data channel is updating."):(n=new u,h.debug("The dataTransfer object with label "+i+" is created"),e.dataTransfers.put(i,n));var a=t.channel;n.initDataChannel(a,!1);try{e.onDataTransfer?e.onDataTransfer(n):h.warn("The onDataTransfer() callback function is not set.")}catch(e){h.warn("The callback function 'Call.onDataTransfer()' exception: "+e)}e.session.saveToStorage()}},n.bindIceHandler=function(e,t,i){function o(){g.onicecandidate=a}function s(){e.peerConnection.onicecandidate=n,t()}function n(t){e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(t.candidate));var i=t.candidate;i?(h.debug("handleNewIceCandidate: candidate- "+JSON.stringify(i)),function(t){var i,o,s=e.offerAnswerManager.trickledCandidatesMap;if(t.sdpMid)i="a=mid:"+t.sdpMid+"\r\n";else{if(null==t.sdpMLineIndex)return void h.warn("ICE Candidate is invalid, ignore it!");var n=e.offerAnswerManager.getLatestActiveLocalSdp();if(n){var a=l.getMediaFromSDP(n);if(a.length>0){var c=a[t.sdpMLineIndex];i=c.mid+"\r\n"}}}t.candidate&&(o=t.candidate),function(){var e=s.get(i);o?e?e.push(o):((e=[]).push(o),s.put(i,e)):h.warn("sdpCandidate is not valid; not adding to candidatesArray")}(),e.offerAnswerManager.canSendOffer()&&r.sendTrickledCandidates(e)}(i)):(e.timeRecording.timeToGetIceCandidates.end=(new Date).getTime(),h.debug("handleNewIceCandidate: got 'end of candidates' event."),function(){for(var t=e.offerAnswerManager.trickledCandidatesMap,i=t.keys();i.length>0;){var o=i.shift(),s=t.get(o);s.push("end-of-candidates")}e.offerAnswerManager.canSendOffer()&&r.sendTrickledCandidates(e)}())}function a(i){e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(i.candidate));var o=i.candidate;h.debug("ICE gathering state: "+g.iceGatheringState),o?h.debug("handleEndOfCandidate: candidate- "+JSON.stringify(o)):(e.timeRecording.timeToGetIceCandidates.end=(new Date).getTime(),h.debug("handleEndOfCandidate: got 'end of candidates' event."),t(),g&&(g.onicecandidate=d))}function d(t){e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_ICE_CANDIDATE+":"+JSON.stringify(t.candidate)),t.candidate?h.debug("logIceCandidates : candidate- "+JSON.stringify(t.candidate)):h.debug("logIceCandidates : end of candidates.")}function u(e){return e.search("a=ice-options:.*trickle")>-1?(h.debug("SDP supports trickle ICE"),!0):(h.debug("SDP does NOT support trickle ICE"),!1)}var g=(e.offerAnswerManager,e.peerConnection);if(!g)throw{name:"IllegalStateError",message:"There is no peerConnection in the call, cannot bind."};switch(h.debug("Bind ICE handler with trickle ICE mode: "+e.pkgInstance.trickleIceMode),e.pkgInstance.trickleIceMode){case"off":o();break;case"half":i?o():u(e.newRemoteSDP.sdp)?s():o();break;case"full":i||u(e.newRemoteSDP.sdp)?s():o();break;default:o()}g.onsignalingstatechange=function(t){var i=g.signalingHandlerForUpdate;"function"==typeof i&&i(t),e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_SIGNALING_STATE_CHANGE+":"+t.target.signalingState)},g.onnegotiationneeded=function(t){e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_NEGOTIATION_NEEDED+":"+t.target.signalingState)},g.onicegatheringstatechange=function(t){e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_ICE_GATHERING_STATE_CHANGE+":"+t.target.iceGatheringState),function(e){h.debug("ICE gathering state: "+e.target.iceGatheringState)}(t)}},n.bindIceConnectionStateChangeHandler=function(e){var t=e.peerConnection;if(!t)throw{name:"IllegalStateError",message:"There is no peerConnection in the call, cannot bind."};t.oniceconnectionstatechange=function(t){if(e.collectClientLog(c.LOGTYPE.EVENT_LOG,c.EVENTLOG.ON_ICE_CONNECTION_STATE_CHANGE+":"+t.target.iceConnectionState),"failed"===t.target.iceConnectionState){e.collectClientLog(c.LOGTYPE.ERROR_LOG,c.ERRORLOG.ICE_CONNECTION_ERROR+": To "+e.callee);var o=e.onCallError;if(o)o(new d.ErrorInfo(c.ERRORCODE.ICE_CONNECTION_ERROR,"ICE connection state gets failed"))}else if("new"===t.target.iceConnectionState||"checking"===t.target.iceConnectionState)e.timeRecording.timeToGetIceConnection.start=(new Date).getTime();else if("connected"===t.target.iceConnectionState){e.timeRecording.timeToGetIceConnection.end=(new Date).getTime();var s=g.get(e).statsCollector;null==s&&(s=g.get(e).statsCollector=new i(e)).start()}else t.target.iceConnectionState;(function(t){h.debug("ICE connection state: "+t.target.iceConnectionState),e.onIceConnectionStateChange&&e.onIceConnectionStateChange(t.target.iceConnectionState)})(t),e.getCallState().isFinalState()||g.get(e).iceFailureHandler.updateIceConnectionState(t)}},n.isValidAnswerCallConfig=function(e,t){var i={sendrecv:6,sendonly:4,recvonly:2,inactive:1,none:1},o=t.audioConfig,s=t.videoConfig,n=e.audioConfig,a=e.videoConfig,r=!1,l=!1;return h.debug("Old audio = "+n+", video = "+a),h.debug("New audio = "+o+", video = "+s),h.debug("Audio direction values: newAudio="+i[o]+", oldAudio="+i[n]+", newAudio <= oldAudio: "+(i[o]<=i[n])),h.debug("Video direction values: newVideo="+i[s]+", oldVideo="+i[a]+", newVideo <= oldVideo: "+(i[s]<=i[a])),n===c.MEDIADIRECTION.SENDONLY||n===c.MEDIADIRECTION.RECVONLY||n===c.MEDIADIRECTION.NONE?n!==o&&o!==c.MEDIADIRECTION.NONE||(r=!0):i[o]<=i[n]&&(r=!0),a===c.MEDIADIRECTION.SENDONLY||a===c.MEDIADIRECTION.RECVONLY||a===c.MEDIADIRECTION.NONE?a!==s&&s!==c.MEDIADIRECTION.NONE||(l=!0):i[s]<=i[a]&&(l=!0),h.debug("isValidAudio="+r+", isValidVideo="+l),!0},n.srdError=function(t){return function(i){h.warn("Error when set remote description: "+i),t.collectClientLog(c.LOGTYPE.ERROR_LOG,c.ERRORLOG.SET_REMOTE_SDP_ERROR+":"+i),l.invokeCallError(t,e.ERRORCODE.PEERCONNECTION_ERROR,i)}},s.CallPackageHelper=n,e.Call=p,e.CallPackage=m,console.log("wsc-call initialized."),e}(live||{}),live=function(e){"use strict";var t=e._private=e._private||{},i=t.CallPackageHelper,o=t.wscConst,s=t.wscUtils,n=t.rtcHelper,a=e.getLogger(),r={};e.timeoutIfEocNotHappen=1e3;var l=function(t,i,o,s){a.debug("Creating connection for user: '"+t+"' with uri: "+i),this.localParticipantUri=t,this.webSocketUri=i,this.onConnectionSuccess=o,this.onConnectionError=s,this.connectionId=null,this.refresh=!1,this.extHeaders=null,this.extPayloads=null,this.stateInfo=null,this.withConnectionId=function(e){return this.connectionId=e,this.refresh=!!e,this},this.withEarlyCallbacks=function(e,t){return this.onConnectionStateChange=e,this.onAuthRefresh=t,this},this.withExtHeaders=function(e){return this.extHeaders=e,this},this.withExtPayloads=function(e){return this.extPayloads=e,this},this.withStateInfo=function(e){return this.stateInfo=e,this},this.start=function(){a.debug("Starting connection to URI = "+this.webSocketUri+", ID = "+this.connectionId),this.connectionId&&null===sessionStorage.getItem(this.connectionId)&&(a.info("Warning: No stored session found for id: "+this.connectionId),this.connectionId=null,this.refresh=!1),this.session=new e.Session(this.localParticipantUri,this.webSocketUri,this.onConnectionSuccess,this.onConnectionError,this.connectionId,this.extHeaders,this.extPayloads,this.stateInfo),this.extPayloads&&this.extPayloads.capability&&"dae"===this.extPayloads.capability.appid&&(a.debug("This is DAE."),this.session.__isDAE__=!0),a.debug("Session created with id: "+this.session.sessionId),this.session.onSessionStateChange=this.onConnectionStateChange,this.package=new e.ConversationPackage(this.session,null),this.authHandler=new e.AuthHandler(this.session),this.authHandler.refresh=this.onAuthRefresh;var t=function(e,t){e=e.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return i?i[2]?decodeURIComponent(i[2].replace(/\+/g," ")):"":null}("jwt",this.webSocketUri);if(t){a.debug("JWT token: ",t);var i=t.split(".")[1];if(i){var o=i.replace("-","+").replace("_","/");if(o){var s=JSON.parse(atob(o));s&&(a.debug("Parsed JWT:"+JSON.stringify(s,null,2)),a.debug("Found username in JWT: "+s.username),s.username&&(this.package.clientId=s.username))}}}return this}};l.prototype={getLocalParticipantUri:function(){return this.session.userName},getConnectionId:function(){return this.session.sessionId},close:function(){this.session.close()},setTrickleIceMode:function(e){this.package.setTrickleIceMode(e)},setIPv6:function(e){this.package.setIPv6(e)},setShortCircuit:function(e){this.package.setShortCircuit(e)},setDSCP:function(e){this.package.setDSCP(e)},setVideoSendBitrate:function(e){this.package.setVideoSendBitrate(e)},setVideoRecvBitrate:function(e){this.package.setVideoRecvBitrate(e)},setRemoveVideoFec:function(e){this.package.setRemoveVideoFec(e)},setIntervals:function(e,t,i,o){e&&e>0&&this.session.setBusyPingInterval(e),t&&e>0&&this.session.setIdlePingInterval(t),i&&i>0&&this.session.setReconnectInterval(i),o&&o>=0&&(this.session.retryCount=o)},setPingPongMessages:function(e,t){this.session.setPingPongMessages(e,t)},updateWebSocketUri:function(e){a.debug("updateWebSocketUri: "+e),this.webSocketUri=e,this.session&&(this.session.webSocketUri=e)},isRefresh:function(){return this.refresh},initCallbacks:function(e,t,i){this.package.initCallbacks(e,t),i&&(this.onConnectionStateChange=i,this.session.onSessionStateChange=this.onConnectionStateChange)},makeConversation:function(e,t){return e||(e=null),t||(t=null),this.package.createConversation(null,null,null,t,e)},getConversations:function(){return this.package.getConversations()},hibernate:function(e,t,i){this.session.hibernate(e,t,i)},getNetworkStatus:function(e,t){this.session.getNetworkStatus(e,t)},subscribeToEntity:function(e,t,i,o){return this.session.subscribeToEntity(e,t,i,o)},unsubscribeFromEntity:function(e){this.session.unsubscribeFromEntity(e)},logEventTimestamp:function(e){r.logEventTimestamp(this.session,e)},setAuditDataModule:function(e){this.session.__auditDataModule__=e}};var c=function(e,t){if(!e){var i="The parameter 'session' cannot be null!";throw a.error(i),i}this.packageType=t||o.PACKAGE.CONVERSATION,e.registerPackage(this),this.session=e,this.trickleIceMode="off",this.ipv6=!1,this.dscp=!1,this.videoSendBitrate=!1,this.videoRecvBitrate=!1,this.removeVideoFec=!1,this.shortCircuitMode=!1,this.onIncoming=null,this.onResurrect=null,this.getConversations=function(){var e=[],t=this.session.getSubSessionsByPackageType(this.packageType),i=null;if(t){i=t.values();for(var o=0;o<i.length;o++)e[o]=i[o]}return e},this.encodeConversationTopic=function(e){return e?((e=e.replace(/[\W]+/g,"_")).indexOf("@")<0&&(e+="@conversation.topic"),e):null}};c.prototype={initCallbacks:function(e,t){this.onIncoming=e,this.onResurrect=t},createConversation:function(e,t,i,o,s){i||(i="video"),s?a.debug("Creating conversation with streamId: "+s):s=null;var n=this.prepareConversation(e,this.encodeConversationTopic(t),this.session,this.session.userName,i),r=n.localAddParticipant(this.session.userName);return o&&r.localAddStreamInfo(s,null,o,null),n.subSessionId=this.session.generateSubSessionId(),this.putConversation(n.subSessionId,n),e&&(a.debug("Conversation Key provided ("+e+") - joining existing conversation"),n.joiningConversation=!0),this.shortCircuitMode&&(a.debug("Enabling short-circuit communication in conversation"),n.withShortCircuit()),n},clear:function(){var e,t=this.session.getSubSessionsByPackageType(this.packageType).values();for(e=0;e<t.length;e++){for(var o=t[e],s=o.streams.values(),n=0;n<s.length;n++)i.clearCall(s[n].call);o=null}},remove:function(e){var t=this,i=e.subSessionId;e.removed||(e.removed=!0,setTimeout(function(){a.debug("Removing conversation: "+i),t.session.removeSubSession(i)},1e3))},onMessage:function(e){var t=this.session,i=e.control.subsession_id,s=e.header.stream_id,r=e.header.stream_type,l=this.session.getSubSession(i);if(e.isRequest()&&"start"===e.header.action){var c=e.payload.sdp,d=n.getCallConfigFromRemoteSDP(c,!1);if(null===l){var u="video";d&&(u=d.getChannelType()),(l=this.prepareConversation(e.header.conversation_key,e.header.conversation_topic,t,e.header.initiator,u)).subSessionId=i,l.joiningConversation=!0,l.localAddParticipant(t.userName),this.putConversation(l.subSessionId,l),a.debug("Have incoming conversation from: "+e.header.initiator,l)}else a.debug("Have incoming start request from: "+e.header.initiator,l);l&&!l.getStreamForId(s)&&(a.debug("No existing stream for the stream id: "+s+", type: "+r),r===o.STREAMTYPE.SCREENSHARE?l.createScreenShareStream(s):l.createAudioVideoStream(d,s))}l?l.onMessage(e):a.info("Ignoring "+e.control.type+" with action: '"+e.header.action+"' for unknown conversation: "+i)},onRehydration:function(t){function i(t,i){var o,s=t.call,a=i.call;if(s.callState=new e.CallState(a.callState.state,a.callState.status.code,a.callState.status.reason,a.callState.streamId),s.earlyMediaState=a.earlyMediaState,a.remoteMedias&&a.remoteMedias.length){o=[];for(var r=0;r<a.remoteMedias.length;r++){var l=a.remoteMedias[r];o[r]=new n.Media(l.mode,l.port,l.type)}}s.remoteMedias=o,s.offerAnswerManager.updateState(a.offerAnswerManager.masterState),s.offerAnswerManager.updateState(a.offerAnswerManager.slaveState),s.iceTimeout=a.iceTimeout,s.onCallError=a.onCallError,s.onUpdate=a.onUpdate,s.onCallStateChange=a.onCallStateChange,s.onMediaStreamEvent=a.onMediaStreamEvent,s.onIceConnectionStateChange=a.onIceConnectionStateChange}for(var s in t.entry)if(t.entry.hasOwnProperty(s)){var r=t.entry[s];a.debug("onRehydration invoked for conversation: "+r.subSessionId);var l=this.prepareConversation(r.conversationKey,r.conversationTopic,this.session,r.initiator,r.conversationChannel);if(l.joiningConversation=r.joiningConversation,l.shortCircuitMode=r.shortCircuitMode,l.onRecordingStatusChange=r.onRecordingStatusChange,l.onParticipantChange=r.onParticipantChange,l.onError=r.onError,l.onEnquiryResponse=r.onEnquiryResponse,l.subSessionId=r.subSessionId,l.recording=r.recording,l.recordingRules=r.recordingRules,l.alwaysRecordOnCreation=r.alwaysRecordOnCreation,l.neverRecordOnCreation=r.neverRecordOnCreation,l.sentAutomaticRecordingRequest=r.sentAutomaticRecordingRequest,l.recordingStyle=r.recordingStyle,l.lastRemovedParticipant=r.lastRemovedParticipant,l.pendingTargetURI=r.pendingTargetURI,l.pendingTargetStreamId=r.pendingTargetStreamId,l.pendingTargetStreamOptions=r.pendingTargetStreamOptions,l.pendingTargetStreamProfile=r.pendingTargetStreamProfile,l.webContext=r.webContext,l.pendingAVStreams=r.pendingAVStreams,l.iceCheckInterval=r.iceCheckInterval,l.pendingAddStreamRelay=r.pendingAddStreamRelay,l.sidebarId=r.sidebarId,l.clientId=r.clientId,l.clientVersion=r.clientVersion,l.postCallRating=r.postCallRating,l.participants=new e.Map,r.participants){var c=[];for(var d in r.participants.entry)r.participants.entry.hasOwnProperty(d)&&c.push(r.participants.entry[d]);for(var u=0;u<c.length;u++){var h=c[u],m=new e.Participant(l,h.uri);if(m.onParticipantStateChange=h.onParticipantStateChange,m.onAddStream=h.onAddStream,m.onAddRemoteStream=h.onAddRemoteStream,h.uri!==this.session.userName){var p=[];for(var v in h.streams.entry)h.streams.entry.hasOwnProperty(v)&&p.push(h.streams.entry[v]);for(var S=0;S<p.length;S++){var _=g.createStreamOptions(p[S].streamOptions.audioConfig,p[S].streamOptions.videoConfig),f=m.localAddStreamInfo(p[S].streamId,p[S].streamType,_,p[S].streamProfile);f.recording=p[S].recording,f.streamLayout=p[S].streamLayout,f.active=p[S].active}}l.participants.put(h.uri,m)}}if(l.streams=new e.Map,r.streams){var C=[];for(var b in r.streams.entry)r.streams.entry.hasOwnProperty(b)&&C.push(r.streams.entry[b]);for(var E=0;E<C.length;E++){var R,A=C[E];a.debug("Rehydrating: ",A.call.streamType,A.call.streamId);var T=g.createStreamOptions(A.call.callConfig.audioConfig,A.call.callConfig.videoConfig);switch(A.call.streamType){case o.STREAMTYPE.AUDIOVIDEO:R=l.createAudioVideoStream(T,A.streamId,A.streamInfo.streamProfile);break;case o.STREAMTYPE.SCREENSHARE:R=l.createScreenShareStream(A.streamId,T,A.streamInfo.streamProfile);break;case o.STREAMTYPE.ANNOTATION:R=l.createStreamOfType(A.streamId,o.STREAMTYPE.ANNOTATION,T,A.streamInfo.streamProfile)}i(R,A),R.localMediaStreams=A.localMediaStreams,R.extHeaders=A.extHeaders,R.onPauseResumeStream=A.onPauseResumeStream,R.onUpdateStreamOptions=A.onUpdateStreamOptions,R.streamInfo.recording=A.streamInfo.recording,R.streamInfo.streamLayout=A.streamInfo.streamLayout,R.streamInfo.active=A.streamInfo.active,a.debug("Rehydrated stream: "+JSON.stringify(R,null,2))}}if(l.relays=new e.Map,r.relays){var y=[];for(var I in r.relays.entry)r.relays.entry.hasOwnProperty(I)&&y.push(r.relays.entry[I]);for(var w=0;w<y.length;w++){var k=y[w];"string"!=typeof k.relayDest&&(k.relayDest=l.getParticipant(k.relayDest.uri).getStreamInfo(k.relayDest.streamId));var L=new e.Relay(l,k.streamId,k.relayDest,k.relayId);L.responseHandler=k.responseHandler,L.retryHandler=k.retryHandler,L.timeoutHandler=k.timeoutHandler,L.errorHandler=k.errorHandler,L.retries=k.retries,L.timeout=k.timeout,L.timer=k.timer,L.startTime=k.startTime;var O=[];for(var P in k.relayMessages.entry)k.relayMessages.entry.hasOwnProperty(P)&&O.push(k.relayMessages.entry[P]);for(var M=0;M<O.length;M++){var N=new e.RelayMessage(L,O[M].messageType,O[M].messageId);N.responseHandler=O[M].responseHandler,N.retryHandler=O[M].retryHandler,N.timeoutHandler=O[M].timeoutHandler,N.errorHandler=O[M].errorHandler,N.retries=O[M].retries,N.retryCount=O[M].retryCount,N.timeout=O[M].timeout,N.final=O[M].final,N.relayDestinations=O[M].relayDestinations,N.gotRelayResponses=O[M].gotRelayResponses,N.gotAllResponses=O[M].gotAllResponses,N.timestamp=O[M].timestamp,N.message=O[M].message,N.text=O[M].text,N.data=O[M].data,N.commands=O[M].commands,L.relayMessages.put(N.messageId,N)}l.relays.put(L.relayId,L)}}this.putConversation(s,l),a.debug("Completed rehydration of conversation: "+s),this.onResurrect?(a.debug("Conversation has been rehydrated - calling onResurrect"),this.onResurrect(l)):a.debug("onResurrect is not set")}},prepareConversation:function(t,i,s,n,a){var r=new e.Conversation(t,i,s,n,a),l=new Date;return r.startTime=""+l.getHours()+l.getMinutes()+l.getSeconds()+l.getMilliseconds(),r.callPackage=s.getPackage(o.PACKAGE.CALL),r.callPackage||(r.callPackage=new e.CallPackage(s)),r.callPackage.packageType=this.packageType,r.callPackage.setTrickleIceMode(this.trickleIceMode),r.callPackage.setIPv6(this.ipv6),r.callPackage.setDSCP(this.dscp),r.callPackage.setVideoSendBitrate(this.videoSendBitrate),r.callPackage.setVideoRecvBitrate(this.videoRecvBitrate),r.callPackage.setRemoveVideoFec(this.removeVideoFec),r.callPackage.onIncomingCall=this.onIncoming,r.callPackage.onResurrect=this.onResurrect,r.pkgInstance=this,r.clientId=this.clientId,r},putConversation:function(e,t){this.session.putSubSession(this.packageType,e,t)},setTrickleIceMode:function(e){this.trickleIceMode=e},setIPv6:function(e){this.ipv6=e},setDSCP:function(e){this.dscp=e},setVideoSendBitrate:function(e){this.videoSendBitrate=e},setVideoRecvBitrate:function(e){this.videoRecvBitrate=e},setRemoveVideoFec:function(e){this.removeVideoFec=e},setShortCircuit:function(e){this.shortCircuitMode=e},toJSON:function(){var e={},t={session:""};for(var i in this)this.hasOwnProperty(i)&&(i in t||(e[i]=this[i]));return e}};var d=function(t,i,s,n,l){this.conversationKey=t,this.conversationTopic=i,this.session=s,this.initiator=n,this.conversationChannel=l,this.joiningConversation=!1,this.pkgInstance=null,this.callPackage=null,this.streams=new e.Map,this.relays=new e.Map,this.startTime="",this.__participantsHistory=[],this.onRecordingStatusChange=null,this.onParticipantChange=null,this.onError=null,this.onEnquiryResponse=null,this.onRelayCommand=null,this.onRelayText=null,this.onRelayData=null,this.subSessionId=null,this.participants=new e.Map,this.recording=!1,this.recordingRules=null,this.alwaysRecordOnCreation=!1,this.neverRecordOnCreation=!1,this.sentAutomaticRecordingRequest=!1,this.shortCircuitMode=!1,this.recordingStyle="single",this.lastRemovedParticipant=null,this.pendingTargetURI=null,this.pendingTargetStreamId=null,this.pendingTargetStreamOptions=null,this.pendingTargetStreamProfile=null,this.webContext=null,this.pendingAVStreams=[],this.removed=!1,this.pendingAddStreamRelay=null,this.sidebarId=null,this.clientId=null,this.clientVersion=null,this.postCallRating=!1,this.statusCheckTimeout=null,this.statusCheckSuccess=null,this.addStreamScreenSharePromise=null,this.addStreamShareResolve=null,this.screenShareValues=null,this.shortCircuitModeAllowed=!0;var c=2e3;this.setIceCheckInterval=function(e){if(e<=0)throw{name:"IllegalArgumentError",message:"The ICE check Interval must be greater than zero."};c=e},this.getIceCheckInterval=function(){return c},this.getLocalId=function(){return this.subSessionId},this.generateStreamId=function(e){var t=this.streams.values().filter(function(t){return t.getType()===e}).length;a.debug("Found "+t+" streams with type: "+e);var i="av";switch(e){case o.STREAMTYPE.AUDIOVIDEO:i="av";break;case o.STREAMTYPE.SCREENSHARE:i="ss";break;case o.STREAMTYPE.ANNOTATION:i="an"}return i+(t+1)+"-"+this.startTime},this.generateRelayId=function(){var e=this.relays.size();a.debug("Found "+e+" relays");return"r"+(e+1)+"-"+this.startTime},this.withParticipant=function(e,t,i,s,n){this.pendingTargetURI=e,n?a.debug("with participant "+e+" and stream id "+n):(a.debug("with participant "+e),n=null);var r=this.localAddParticipant(e);return t||(t=this.getDefaultStreamOptions()),this.pendingTargetStreamId=r.localAddStreamInfo(n,s||null,t,i).getId(),this.pendingTargetStreamOptions=t,this.pendingTargetStreamProfile=i,this.onParticipantChange&&this.onParticipantChange(this,o.CONVERSATIONSTATE.STREAM_ADDED,r),this},this.withChannel=function(e){return this.conversationChannel=e,this},this.withKey=function(e){return e&&(a.debug("Joining conversation with key="+e),this.conversationKey=e,this.joiningConversation=!0),this},this.withTopic=function(e){return this.conversationTopic=this.pkgInstance.encodeConversationTopic(e),this},this.withContext=function(e){return this.webContext=e,this},this.withVersion=function(e){return this.clientVersion=e,this},this.withCallbacks=function(e,t,i,s,n,a,r){if(this.onRecordingStatusChange=e,this.onParticipantChange=t,this.onError=i,this.onRelayCommand=s,this.onRelayText=n,this.onRelayData=a,this.onEnquiryResponse=r,this.onParticipantChange)for(var l=this.participants.values(),c=0;c<l.length;c++)this.onParticipantChange(this,o.CONVERSATIONSTATE.STREAM_ADDED,l[c]);return this},this.withShortCircuit=function(){return a.debug("Conversation withShortCircuit setting SCM to (allowed): "+this.shortCircuitModeAllowed),this.shortCircuitMode=this.shortCircuitModeAllowed,this},this.withoutShortCircuit=function(){return a.debug("Conversation withoutShortCircuit setting SCM allowed to false"),this.shortCircuitModeAllowed=!1,this},this.isShortCircuit=function(){return this.shortCircuitMode},this.getSidebar=function(){return this.sidebarId},this.withRecording=function(){return this.alwaysRecordOnCreation=!0,this},this.withoutRecording=function(){return this.neverRecordOnCreation=!0,this},this.localSetRecording=function(e){this.recording=e,this.recording?a.debug("Conversation is being recorded"):a.debug("Conversation is not being recorded")},this.localAddParticipant=function(t){var i=new e.Participant(this,t);return this.participants.put(t,i),i},this.localRemoveParticipant=function(e){return this.lastRemovedParticipant=this.getParticipant(e),this.participants.remove(e)&&a.debug("Removed Participant with uri="+e),this.lastRemovedParticipant},this.decodeConversationTopic=function(){if(!this.conversationTopic)return null;var e=this.conversationTopic,t=e.indexOf("@");return t&&(e=e.substring(0,t)),e.replace(/_/g," ")},this.setRecordingStyle=function(e){this.recordingStyle=e},this.getRecordingStyle=function(){return this.recordingStyle},this.setPostCallRating=function(e){a.debug("Post-call rating is required"),this.postCallRating=e},this.isPostCallRatingRequired=function(){return this.postCallRating},this.setRecordingRules=function(e){this.recordingRules=e},this.getRecordingRules=function(){return this.recordingRules},this.getPendingTarget=function(){return{uri:this.pendingTargetURI,streamId:this.pendingTargetStreamId,streamOptions:this.pendingTargetStreamOptions,streamProfile:this.pendingTargetStreamProfile}},this.clearPendingTarget=function(){this.pendingTargetURI=null,this.pendingTargetStreamId=null,this.pendingTargetStreamOptions=null,this.pendingTargetStreamProfile=null},this.replacePendingTarget=function(e){var t=this.getPendingTarget();a.debug("Replacing pending destination: '"+t.uri+"' with actual destination: '"+e+"'"),this.getParticipant(t.uri)&&this.localRemoveParticipant(t.uri);var i=this.localAddParticipant(e);i.localAddStreamInfo(t.streamId,o.STREAMTYPE.AUDIOVIDEO,t.streamOptions,t.streamProfile),a.debug("Replaced pending destination with actual destination: '"+e+"'"),this.clearPendingTarget(),this.onParticipantChange&&this.onParticipantChange(this,o.CONVERSATIONSTATE.STREAM_ADDED,i)},this.defaultEnquiryResponse=function(e){var t=null;if(e){t=JSON.parse("{}"),a.debug("Processing recording rules for conversation: "+JSON.stringify(e,null,2));var i=e.destination_uri;i&&this.replacePendingTarget(i);var o=e.recording_style;o&&(a.debug("Will record using style: "+o),this.setRecordingStyle(o)),e.post_call_rating&&(a.debug("Will request a post-call rating"),this.setPostCallRating(!0));var s=e.exclude_conversation,n=e.include_conversation,r=e.include_associations,l=e.exclude_associations,c=e.include_participants;s?(a.debug("Not recording conversation"),this.withoutRecording().withShortCircuit()):n?(a.debug("Recording conversation"),t.participants=["*"],this.withRecording()):(r&&(a.debug("Including associations: "+JSON.stringify(r,null,2)),t.include_associations=[].concat(r),this.withRecording()),l&&(a.debug("Excluding associations: "+JSON.stringify(l,null,2)),t.exclude_associations=[].concat(l),this.withRecording()),c&&(a.debug("Including participants: "+JSON.stringify(c,null,2)),t.participants=[].concat(c),this.withRecording()))}this.setRecordingRules(t)},this.onIceConnectionStateChange=function(e,t){a.debug("onIceConnectionStateChange: "+t,e);var i=this.getLocalParticipant();if(i){var s=i.getStreamInfo(e.streamId);if(s)if("connected"===t||"completed"===t){if(!s.isActive()){s.localSetActive(!0);var n=[{uri:i.getUri(),streams:[{stream_id:e.getId(),stream_type:e.getType(),stream_options:e.getStreamOptions()}]}];r.relayStreamEvent(e,o.CONVERSATIONSTATE.STREAM_ACTIVE,n),r.handleParticipantChange(this,o.CONVERSATIONSTATE.STREAM_ACTIVE,n[0].uri,n[0].streams)}}else s.isActive()&&s.localSetActive(!1),"failed"===t&&e.call.onCallStateChange&&(a.info("onIceConnectionStateChange: failed - updating stream state to: "+o.CALLSTATE.FAILED),e.call.setCallState(o.CALLSTATE.ERROR,o.ERRORCODE.ICE_CONNECTION_ERROR,"ICE state failed"))}},this.createStreamOfType=function(t,i,s,n){a.debug("createStreamOfType()",i,t,s,n);var r=this.callPackage.prepareCall(this.session,s,this.initiator,null);r.subSessionId=this.subSessionId,r.pkgInstance=this.callPackage,r.conversation=this,r.streamId=t,r.streamType=i,r.callState.streamId=t,r.shortCircuitMode=this.shortCircuitMode;var l,c=this.getLocalParticipant().localAddStreamInfo(t,i,s,n);switch(i){case o.STREAMTYPE.AUDIOVIDEO:l=new e.AudioVideoStream(this,r,t,c);break;case o.STREAMTYPE.SCREENSHARE:l=new e.ScreenShareStream(this,r,t,c);break;case o.STREAMTYPE.ANNOTATION:l=new e.AudioVideoStream(this,r,t,c,o.STREAMTYPE.ANNOTATION);break;default:return a.error("Unknown stream type: "+i),null}return this.streams.put(t,l),l.call.onIceConnectionStateChange=this.onIceConnectionStateChange.bind(this,l),l},this.addStreamOfType=function(e,t,i,o){a.debug("addStreamOfType()",e,t,i,o);var s=this.createStreamOfType(e,t,i,o);return Promise.resolve({stream:s,type:t,options:i})},this.createAudioVideoStream=function(e,t,i){return a.debug("createAudioVideoStream()",t,e,i),e||(e=this.getDefaultStreamOptions()),t||(t=this.generateStreamId(o.STREAMTYPE.AUDIOVIDEO)),this.createStreamOfType(t,o.STREAMTYPE.AUDIOVIDEO,e,i)},this.addAudioVideoStream=function(e,t,i){a.debug("addAudioVideoStream()",e,t,i);var o=this.createAudioVideoStream(e,t,i);return Promise.resolve({stream:o,options:t})},this.createScreenShareStream=function(t,i,s){return a.debug("createScreenShareStream()",t,i,s),i||(i=new e.StreamOptions(o.MEDIADIRECTION.NONE,o.MEDIADIRECTION.SENDRECV)),t||(t=this.generateStreamId(o.STREAMTYPE.SCREENSHARE)),this.createStreamOfType(t,o.STREAMTYPE.SCREENSHARE,i,s)},this.addScreenShareStream=function(e,t,i){a.debug("addScreenShareStream()",e,t,i);var o=this.createScreenShareStream(e,t,i);if(this.isShortCircuit()){a.debug("Short-circuit conversation - creating sidebar before adding stream"),r.sendCreateSidebar(this),this.screenShareValues={stream:o,options:t};var s=this;return this.addStreamScreenSharePromise=new Promise(function(e,t){a.debug("created addStreamScreenSharePromise"),s.addStreamShareResolve=e}),this.addStreamScreenSharePromise}return Promise.resolve({stream:o,options:t})},this.getDefaultStreamOptions=function(){return"audio"===this.conversationChannel?new e.StreamOptions(o.MEDIADIRECTION.SENDRECV,o.MEDIADIRECTION.NONE):new e.StreamOptions(o.MEDIADIRECTION.SENDRECV,o.MEDIADIRECTION.SENDRECV)},this.getStreamForId=function(e){var t=this.streams.get(e);return t||"default"!==e||(t=this.streams.get("av1-"+this.startTime)),t},this.remove=function(){this.pkgInstance.remove(this)},this.createRelay=function(t,i,o){o||(o=this.generateRelayId());var s=new e.Relay(this,t,i,o);return this.relays.put(o,s),a.debug("Created relay for stream: "+t+" with id: "+o+" and destination: "+JSON.stringify(i,null,2)),s},this.getRelayForId=function(e){var t=this.relays.get(e);return t||"default"!==e||(t=this.getRelay()),t},this.getRelayForStream=function(e){var t=this.relays.values().filter(function(t){return e.getId&&t.getStreamId()===e.getId()},this);return t.length>0?t[0]:null},this.getSpecificRelayForStream=function(e){var t=this.relays.values().filter(function(t){return e.getId&&t.getStreamId()===e.getId()&&t.getDestination()===e.uri},this);return t.length>0?(a.debug("getSpecificRelayForStream ("+e+")found a relay of "+t[0]),t[0]):null},this.getRelayForDestUrl=function(e){var t=function(t){return!(!t.getParticipant||t.getParticipant().getUri()!==e)||t===e},i=this.relays.values().filter(function(e){var i=e.getDestination();return Array.isArray(i)?i.filter(t).length>0:t(i)},this);return i.length>0?i[0]:null},this.getRelay=function(){return this.relays.get("r1-"+this.startTime)}};d.prototype={end:function(e){this.session.sessionState!==o.SESSIONSTATE.CLOSED&&this.session.sessionState!==o.SESSIONSTATE.FAILED&&this.streams.size()>0&&(a.info("Begin to remove all participants",this),r.sendRemoveAllParticipants(this),this.streams.values().forEach(function(t){t.end(e)})),this.participants.clear(),this.remove()},getInitiator:function(){return this.initiator},getTopic:function(){return this.decodeConversationTopic()},getKey:function(){return this.conversationKey},getChannel:function(){return this.conversationChannel},getContext:function(){return this.webContext},addParticipant:function(e,t,i){var o=this.localAddParticipant(e);return t||(t=this.getDefaultStreamOptions()),o.localAddStreamInfo(null,null,t,i),this.streams.size()>0&&(a.info("Begin to add participant: "+e,this),r.sendAddParticipant(this,o)),o},getParticipants:function(){return this.participants.values()},getParticipant:function(e){return this.participants.values().find(function(t){return t.uri===e},this)},getLocalParticipant:function(){return this.getParticipant(this.getLocalParticipantUri())},getRemoteParticipant:function(){for(var e=this.getParticipants(),t=0;t<e.length;t++)if(this.getLocalParticipantUri()!==e[t].getUri())return e[t];return null},getLocalParticipantUri:function(){return this.session.userName},showParticipantsAndStreams:function(e){console.log("---\x3e "+e);for(var t=this.getParticipants(),i=0;i<t.length;i++){var o;o=this.getLocalParticipantUri()===t[i].getUri()?"- Local Participant ["+i+"]: ":"- Remote Participant ["+i+"]: ",a.debug(o);for(var s=0;s<t[i].getStreamInfos().length;s++)a.debug("    - Stream["+s+"]: "+JSON.stringify(t[i].getStreamInfos()[s].toJSON()))}},getAudioVideoStream:function(e){if(!e){var t=this.streams.values().filter(function(e){return e.getType()===o.STREAMTYPE.AUDIOVIDEO&&!e.getStreamState().isFinalState()});t.length>0&&(e=t[0].streamId)}return this.getStreamForId(e)},getScreenShareStream:function(e){if(!e){var t=this.streams.values().filter(function(e){return e.getType()===o.STREAMTYPE.SCREENSHARE&&!e.getStreamState().isFinalState()});t.length>0&&(e=t[0].streamId)}return this.getStreamForId(e)},offerOutboundScreenShare:function(e,t,i){var s=i||this.getRemoteParticipant();if(s){var n=s.getStreamInfos()[0],l=s.getUri();a.debug("offerOutboundScreenShare to remote participant: "+l);var c=this.getRelayForStream(n);null===c?c=this.createRelay(n.getId(),n):a.debug("Found relay with id: "+c.getId());var d=[{stream_type:o.STREAMTYPE.SCREENSHARE,stream_options:{audio:o.MEDIADIRECTION.NONE,video:o.MEDIADIRECTION.SENDONLY}}],u=c.createCommand(o.CONVERSATION.REMOTE_ADD_STREAM,d).withCallbacks(e,t);this.isShortCircuit()?(a.debug("offerOutboundScreenShare: Short-circuit conversation - creating sidebar before requesting outbound stream"),r.sendCreateSidebar(this),this.pendingAddStreamRelay=u):(a.debug("offerOutboundScreenShare: Sending relay to request outbound stream"),u.send())}else a.info("offerOutboundScreenShare: no remote participant - cannot request outbound stream"),"function"==typeof t&&t("no remote participant")},annotateCustomerStream:function(e,t,i,s,n,r){a.debug("annotateCustomerStream");var l=s||this.getRemoteParticipant();if(l){var c=l.getUri();a.debug("annotateCustomerStream to remote participant: "+c),l.conversation.showParticipantsAndStreams("AnnotateCustomerStream");var d=null;r&&(d=l.getStreamInfos().find(r)),d||(a.debug("No stream found; Selecting first stream (Index: [0])"),d=l.getStreamInfos()[0]),a.debug("remoteParticipant stream found: "+JSON.stringify(d.asJSON()));var u=this.getRelayForStream(d);null===u?(a.debug("creating new relay with streamId: "+d.getId()),u=this.createRelay(d.getId(),d)):a.debug("Found relay with id: "+u.getId()),u.createCommand(o.CONVERSATION.ANNOTATE_CUSTOMER_STREAM,e).withOrigStreamOptionsCallback(n).withDestStreamOptionsCallback(r).withCallbacks(t,i).send()}},getStreams:function(){return this.streams.values()},isEstablished:function(){var e=this.streams.values().some(function(e){return e.getStreamState().hasEstablished()});return a.debug("Conversation.isEstablished: "+e),e},updateStreamId:function(e,t){this.streams.remove(t),this.streams.put(e.streamId,e)},toJSON:function(){return{conversationKey:this.conversationKey,conversationTopic:this.conversationTopic,initiator:this.initiator,conversationChannel:this.conversationChannel,joiningConversation:this.joiningConversation,shortCircuitMode:this.shortCircuitMode,streams:this.streams,relays:this.relays,startTime:this.startTime,onRecordingStatusChange:this.onRecordingStatusChange,onParticipantChange:this.onParticipantChange,onError:this.onError,onEnquiryResponse:this.onEnquiryResponse,subSessionId:this.subSessionId,participants:this.participants,recording:this.recording,recordingRules:this.recordingRules,alwaysRecordOnCreation:this.alwaysRecordOnCreation,neverRecordOnCreation:this.neverRecordOnCreation,sentAutomaticRecordingRequest:this.sentAutomaticRecordingRequest,recordingStyle:this.recordingStyle,lastRemovedParticipant:this.lastRemovedParticipant,pendingTargetURI:this.pendingTargetURI,pendingTargetStreamId:this.pendingTargetStreamId,pendingTargetStreamOptions:this.pendingTargetStreamOptions,pendingTargetStreamProfile:this.pendingTargetStreamProfile,webContext:this.webContext,pendingAVStreams:this.pendingAVStreams,iceCheckInterval:this.iceCheckInterval,pendingAddStreamRelay:this.pendingAddStreamRelay,sidebarId:this.sidebarId,clientId:this.clientId,clientVersion:this.clientVersion}},onMessage:function(e){if(a.debug("Received "+e.control.type+" with action: "+e.header.action,this),e.isReliableRelay())r.doReliableRelay(this,e);else if(e.isRequest())r.doRequest(this,e);else if(e.isResponse())r.doResponse(this,e);else if(e.isMessage())r.doMessage(this,e);else if(e.isError())r.doError(this,e);else{var t=this.getAudioVideoStream().call;t&&t.onMessage(e)}},startRecording:function(){a.info("Begin to start recording",this),this.streams.size()>0?r.sendBeginRecording(this):(a.debug("Will start recording conversation on creation"),this.alwaysRecordOnCreation=!0)},stopRecording:function(){a.info("Begin to stop recording",this),this.streams.size()>0?r.sendEndRecording(this):(a.debug("Will NOT start recording conversation on creation"),this.neverRecordOnCreation=!0)},isRecording:function(){a.debug("Conversation.isRecording() entered..");var e=!1;return this.participants.values().forEach(function(t){a.debug("isRecording: checking participant",t),t.isRecording()&&(a.debug("isRecording: have found a recording participant"),e=!0)}),a.debug("Conversation level isRecording() returning "+e),e},switchToSidebar:function(){r.sendCreateSidebar(this)},checkStatus:function(e,t){this.statusCheckSuccess=e,this.statusCheckTimeout&&clearTimeout(this.statusCheckTimeout),this.statusCheckTimeout=setTimeout(function(){a.info("Failed to get status check response"),"function"==typeof t&&t("Timeout")},5e3),r.sendConversationEnquiry(this)},addRemainingStreams:function(){var e=this;if(this.pendingAddStreamRelay){a.debug("addRemainingStreams: pendingAddStreamRelay");var t=this.getRemoteParticipant(),i=null;t&&((i=t.getStreamInfos().find(function(t){return null!==e.getRelayForStream(t)}))&&t.getStreamInfos().forEach(function(t){e.createRelay(t.getId(),t,i.getId())})),r.sendDelayedAddStreamRequest(this)}else this.addStreamShareResolve?(a.debug("addRemainingStreams: addStreamScreenSharePromise"),this.addStreamShareResolve(this.screenShareValues),this.addStreamScreenSharePromise=null,this.addStreamShareResolve=null,this.screenShareValues=null):a.debug("addRemainingStreams: default else")},relayCommandTo:function(e,t,i,o){if(!this.conversationKey)return a.warn("Failed to relay command: "+i+" - conversation not established"),null;if(!e){var s=this.getAudioVideoStream();s&&(e=s.getId())}if(!e){var n=this.getScreenShareStream();n&&(e=n.getId())}return e?this.createRelay(e,t).createRelayMessage().withCommand(i,o).send():(a.warn("Failed to relay command: "+i+" - invalid stream"),null)},relayTextTo:function(e,t,i,o){return this.conversationKey?(e||(e=this.getAudioVideoStream().getId()),this.createRelay(e,t).createRelayMessage().withText(i,o).send()):(a.warn("Failed to relay text: "+o+" - conversation not established"),null)},relayDataTo:function(e,t,i,o){return this.conversationKey?(e||(e=this.getAudioVideoStream().getId()),this.createRelay(e,t).createRelayMessage().withData(i,o).send()):(a.warn("Failed to relay data: "+i+" - conversation not established"),null)}};var u=function(e,t,i){this.audio=e,this.video=t,this.reason=i,this.pausedBy=null};u.prototype={toJSON:function(){return{audio:this.audio,video:this.video,reason:this.reason?this.reason:""}}};var h=function(e,t,i,o){this.upgraded=e&&"true"===e.toString(),this.paused=t&&"true"===t.toString(),this.paused_by=i||"",this.pauseResume=o};h.create=function(t){var i=new e.PauseResume(o.PAUSERESUME.RESUME,o.PAUSERESUME.RESUME,null);if(t){var s=t.paused_by?t.paused_by:"";return t.pause_resume_audio&&t.pause_resume_video?i=new e.PauseResume(t.pause_resume_audio,t.pause_resume_video,t.pause_resume_reason):t.pauseResume&&t.pauseResume.audio&&t.pauseResume.video?i=new e.PauseResume(t.pauseResume.audio,t.pauseResume.video,t.pauseResume.reason):(t.upgraded=!0,t.paused=!1),new e.StreamProfile(t.upgraded,t.paused,s,i)}return new e.StreamProfile(!0,!1,"",i)},h.prototype={toJSON:function(){return{upgraded:this.upgraded,paused:this.paused,paused_by:this.paused_by,pause_resume_audio:this.pauseResume.audio,pause_resume_video:this.pauseResume.video,pause_resume_reason:this.pauseResume.reason?this.pauseResume.reason:""}},updateForPauseResume:function(t,i){var s=t.audio===o.PAUSERESUME.PAUSE&&t.video===o.PAUSERESUME.PAUSE;this.pauseResume=new e.PauseResume(t.audio,t.video,t.reason),t.reason===o.PAUSERESUMEREASON.UPGRADE_DOWNGRADE?this.upgraded=t.video===o.PAUSERESUME.RESUME:(this.paused=s,this.paused_by=i&&s?i:"")}};var g=function(t,i,s,n,r){this.participant=t,this.uri=this.participant.getUri(),this.streamId=i,this.streamType=s,this.streamLayout=o.STREAMSIZE.MIN,this.recording=!1,this.PAUSED=new e.StreamOptions(o.MEDIADIRECTION.NONE,o.MEDIADIRECTION.NONE),this.streamProfile=h.create(r),this.streamOptions=this.PAUSED,this.qualityMonitor=null,this.active=!1,this.localSetStreamOptions=function(e){if(e){var t=e.audio,i=e.video,o=e.audioConfig,s=e.videoConfig;e=t&&i?g.createStreamOptions(t,i):o&&s?g.createStreamOptions(o,s):this.participant.conversation.getDefaultStreamOptions()}else e=this.participant.conversation.getDefaultStreamOptions();a.debug("Changing options for stream: "+this.streamId+", options="+JSON.stringify(e,null,2)),this.streamOptions=e},this.localSetStreamOptions(n),this.localSetStreamLayout=function(e){null!==e&&a.debug("Changing layout '"+e+"' for stream: "+this.streamId),this.streamLayout=e},this.localSetStreamProfile=function(t){a.debug("Changing profile '"+JSON.stringify(t,null,2)+"' for stream: "+this.streamId),this.streamProfile=e.StreamProfile.create(t)},this.localSetRecording=function(e){this.recording=e,this.recording?a.debug("Participant "+this.participant.uri+" is being recorded"):a.debug("Participant "+this.participant.uri+" is not being recorded")},this.localSetActive=function(e){this.active=e,a.debug("Participant "+this.participant.uri+" stream: "+this.streamId+(e?" is active":" is not active"))},this.asJSON=function(){return{stream_id:this.streamId,stream_type:this.streamType,stream_options:this.streamOptions.asJSON(),stream_profile:this.streamProfile}}};g.prototype={toJSON:function(){return{uri:this.uri,streamId:this.streamId,streamType:this.streamType,streamLayout:this.streamLayout,recording:this.recording,streamProfile:this.streamProfile.toJSON(),streamOptions:this.streamOptions.toJSON(),active:this.active}},getParticipant:function(){return this.participant},getId:function(){return this.streamId},getType:function(){return this.streamType},getStreamOptions:function(){return this.streamOptions},getStreamProfile:function(){return this.streamProfile},pauseResumeStream:function(e,t,i){a.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(e,null,2));var o=this.participant.conversation.getLocalParticipantUri();return this.participant.getUri()!==o?r.sendPauseResume(this.participant.conversation,this,e,t,i):(a.debug("Pausing/Resuming audio/video tracks in stream: "+this.streamId,e),void this.participant.conversation.getAudioVideoStream(this.streamId).pauseResumeStream(e,t,i))},cancelPauseResumeStream:function(e,t){return a.debug("cancelPauseResumeStream"),r.sendCancelRequest(this.participant.conversation,this,o.CONVERSATION.PAUSE_RESUME_STREAM,e,t)},cancelAddStream:function(e,t){return a.debug("cancelAddStream"),r.sendCancelRequest(this.participant.conversation,this,o.CONVERSATION.ADD_STREAM,e,t)},setStreamOptions:function(e,t,i){if(a.debug("setStreamOptions",e),e||(a.debug("Pausing media for stream: "+this.streamId),e=this.PAUSED),r.isPauseResume(this.streamOptions,e))return this.pauseResumeStream(r.getPauseResumeTargets(e),t,i);var s,n=this.participant.getStreamInfos().some(function(e){return e.getStreamOptions().videoConfig===o.MEDIADIRECTION.SENDONLY||e.getStreamOptions().videoConfig===o.MEDIADIRECTION.RECVONLY}),l=e.videoConfig===o.MEDIADIRECTION.SENDONLY;return this.participant.getUri()!==this.participant.conversation.getLocalParticipantUri()?this.participant.conversation.isShortCircuit()?(a.debug("Short-circuit, checking video options: "+e.videoConfig),s=g.createStreamOptions(e.audioConfig,e.videoConfig),n&&l?s.videoConfig=o.MEDIADIRECTION.SENDRECV:n&&!l&&(a.debug("Single video downgrade, do not swap directions"),s.videoConfig=o.MEDIADIRECTION.NONE),r.sendStreamOptions(this.participant.conversation,this,s,t,i)):r.sendStreamOptions(this.participant.conversation,this,e,t,i):(a.debug("Updating local AV stream with new stream options: "+JSON.stringify(e,null,2)),s=g.createStreamOptions(e.audioConfig,e.videoConfig),this.participant.conversation.isShortCircuit()&&(n&&l?s.videoConfig=o.MEDIADIRECTION.SENDRECV:n&&!l&&(s.videoConfig=o.MEDIADIRECTION.NONE)),void this.participant.conversation.getAudioVideoStream(this.streamId).update(s,t,i))},getLayout:function(){return this.streamLayout},setLayout:function(e,t){this.localSetStreamLayout(e),r.sendStreamLayout(this.participant.conversation,this,e,t)},isRecording:function(){return this.recording},isActive:function(){return this.active},startRecording:function(){a.info("Begin to start recording stream: "+this.streamId,this),r.sendBeginRecording(this.participant.conversation,this)},stopRecording:function(){a.info("Begin to stop recording stream: "+this.streamId,this),r.sendEndRecording(this.participant.conversation,this)},remove:function(){this.participant.streams.size()>1?(a.info("Begin to remove stream: "+this.streamId,this),r.sendRemoveParticipant(this.participant.conversation,this.participant,this)):this.participant.remove()},isAudioPaused:function(){return this.streamProfile&&this.streamProfile.pauseResume&&this.streamProfile.pauseResume.audio===o.PAUSERESUME.PAUSE},isVideoPaused:function(){return this.streamProfile&&this.streamProfile.pauseResume&&this.streamProfile.pauseResume.video===o.PAUSERESUME.PAUSE},getQualityMonitor:function(){return this.qualityMonitor||(this.qualityMonitor=new e.QualityMonitor(this))}},g.createStreamOptions=function(t,i){var s=function(e){var t=o.MEDIADIRECTION.NONE;switch(e.toLowerCase()){case"inactive":case"none":t=o.MEDIADIRECTION.NONE;break;case"sendonly":t=o.MEDIADIRECTION.SENDONLY;break;case"recvonly":t=o.MEDIADIRECTION.RECVONLY;break;case"sendrecv":t=o.MEDIADIRECTION.SENDRECV}return t},n=s(t),a=s(i);return new e.StreamOptions(n,a)};var m=function(t,i){this.streams=new e.Map,this.removedStreams=[],this.conversation=t,this.uri=i,a.debug("Participant with URI: "+this.uri),this.onParticipantStateChange=null,this.onAddStream=null,this.onAddRemoteStream=null,this.localAddStreamInfo=function(t,i,s,n){a.debug("this.localAddStreamInfo()",i,t,s,n),t||(t=this.conversation.generateStreamId(i),a.debug("No streamId supplied: using:",t)),i||(i=o.STREAMTYPE.AUDIOVIDEO,a.debug("No streamType supplied: using:",i)),s||(s=this.conversation.getDefaultStreamOptions(),a.debug("No streamOptions supplied: using:",s)),n?n=e.StreamProfile.create(n):((n=e.StreamProfile.create()).upgraded=s.shouldSendVideo(),a.debug("No streamProfile supplied: using:",n)),a.debug("Creating StreamInfo: id="+t+", URI="+this.uri+", type="+i+", options="+JSON.stringify(s,null,2)+", profile="+JSON.stringify(n,null,2));var r=new e.StreamInfo(this,t,i,s,n);return this.streams.put(t,r),a.debug("Found stream length after adding "+this.streams.values().length),r},this.notRemovedStream=function(e){return-1===this.removedStreams.indexOf(e)},this.localRemoveStreamInfo=function(e){return this.streams.remove(e)&&(this.removedStreams.push(e),a.debug("Removed StreamInfo with ="+this.uri+"/"+e)),this.streams.size()}};m.prototype={initCallbacks:function(e,t,i){a.debug("Initialise callbacks for participant: "+this.uri),this.onParticipantStateChange=e,this.onAddStream=t,this.onAddRemoteStream=i},remove:function(e){this.conversation.localRemoveParticipant(this.uri),this.conversation.streams.size()>0&&(this.uri===this.conversation.getLocalParticipantUri()?(this.conversation.streams.values().forEach(function(t){t.end(e)}),this.conversation.remove()):(a.info("Begin to remove participant: "+this.uri,this),r.sendRemoveParticipant(this.conversation,this)))},asJSONArray:function(e){for(var t=this.streams.values(),i=[],o=0;o<t.length;o++){var s={uri:this.uri,stream_id:t[o].getId(),stream_type:e||t[o].getType(),stream_options:t[o].getStreamOptions().asJSON(),stream_profile:t[o].getStreamProfile()},n=t[o].getLayout();n&&(s.size=n),i.push(s)}return i},toJSON:function(){return{streams:this.streams,removedStreams:this.removedStreams,uri:this.uri,onParticipantStateChange:this.onParticipantStateChange,onAddStream:this.onAddStream,onAddRemoteStream:this.onAddRemoteStream}},getUri:function(){return this.uri},getStreamInfos:function(){return this.streams.values()},getStreamInfo:function(e){var t=this.streams.get(e);return t||"default"!==e||(t=this.streams.get("av1")),t},isRecording:function(){var e=!1;return this.streams.values().forEach(function(t){t.isRecording()&&(e=!0)}),e},addScreenShareStream:function(e,t,i,s,n){if(this.uri===this.conversation.getLocalParticipantUri())return this.conversation.createScreenShareStream(e,s,n);var a=g.createStreamOptions(o.MEDIADIRECTION.INACTIVE,o.MEDIADIRECTION.SENDONLY);return r.sendAddStream(this.conversation,this,o.STREAMTYPE.SCREENSHARE,a,t,i),!0},addAudioVideoStream:function(e,t,i,s,n){return this.uri===this.conversation.getLocalParticipantUri()?this.conversation.createAudioVideoStream(e,t,n):(r.sendAddStream(this.conversation,this,o.STREAMTYPE.AUDIOVIDEO,e,i,s),!0)}};var p=function(e,t,i,s,n){this.conversation=e,this.call=t,this.call.avStream=this,this.streamId=i,this.extHeaders=null,this.localMediaStreams=null,this.streamInfo=s,this.type=void 0===n?o.STREAMTYPE.AUDIOVIDEO:n,this.onPauseResumeStream=null,this.onUpdateStreamOptions=null,this.onQualityMetrics=null};p.prototype={toJSON:function(){return{call:this.call,streamId:this.streamId,extHeaders:this.extHeaders,localMediaStreams:this.localMediaStreams,streamInfo:this.streamInfo.toJSON(),onPauseResumeStream:this.onPauseResumeStream,onUpdateStreamOptions:this.onUpdateStreamOptions}},withCallbacks:function(e,t,i,o,s,n){return this.call.onCallStateChange=e,this.call.onMediaStreamEvent=t,this.call.onUpdate=i,this.call.onCallError=o,this.onPauseResumeStream=s,this.onUpdateStreamOptions=n,this},getConversation:function(){return this.conversation},getId:function(){return this.streamId},getType:function(){return this.type},getStreamOptions:function(){return this.call.callConfig},getStreamState:function(){return this.call.callState},getStreamInfo:function(){return this.streamInfo},isAudioPaused:function(){return this.streamInfo&&this.streamInfo.isAudioPaused()},isVideoPaused:function(){return this.streamInfo&&this.streamInfo.isVideoPaused()},mute:function(e){return a.debug("Muting stream? "+e),this.call.mute(e)},isMuted:function(){return this.call.isMuted()},getRemoteStreams:function(){return n.getRemoteStreams(this.call.peerConnection)},getLocalStreams:function(){return n.getLocalStreams(this.call.peerConnection)},getLocalMediaStream:function(){return this.call.localMediaStreams[0]},extractVideoForPreview:function(){var e=this.call.peerConnection;e.getSenders().map(function(t){t.track&&"video"===t.track.kind&&e.removeTrack(t)});var t=this.call.localMediaStreams[0];return"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?t.track&&"video"===t.track.kind&&(t.track.enabled=!0):t.getVideoTracks().map(function(e){e.enabled=!0}),t},addbackVideoAfterPreview:function(e){var t=this.call.localMediaStreams[0],i=this.call.peerConnection;"undefined"!=typeof RTCRtpSender&&t instanceof RTCRtpSender?t.track&&"video"===t.track.kind&&(t.track.enabled=e,i.addTrack(t.track,t)):t.getVideoTracks().map(function(o){o.enabled=e,i.addTrack(o,t)})},start:function(e,t){return this.localMediaStreams=e,this.extHeaders=t,!this.conversation.recordingRules&&r.retrieveRecordingRules(this.conversation)?this.conversation.pendingAVStreams.push(this):r.sendStartRequest(this),this},end:function(e){r.sendEndRequest(this,e)},accept:function(e,t,i){r.sendAcceptResponse(this,e,t,i)},decline:function(e,t){r.sendDeclineResponse(this,e,t)},update:function(e,t,i,o,s){return a.debug("Attempting to update AV stream"),this.call.canUpdate()?(r.isPauseResume(this.getStreamOptions(),e)?this.pauseResumeStream(r.getPauseResumeTargets(e),o,s):(r.sendUpdateRequest(this,e,t,i),"function"==typeof o&&o(!0)),!0):(a.info("Cannot update call - not in correct ICE state: "+this.call.getIceConnectionState()+", call state: "+this.call.getCallState().state,this.call),"function"==typeof s&&s(!1),!1)},pauseResumeStream:function(e,t,i){var s=e.audio===o.PAUSERESUME.PAUSE,n=e.video===o.PAUSERESUME.PAUSE;return a.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamInfo.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(e,null,2)),a.debug((s?"Pausing":"Resuming")+" audio tracks in AV stream"),a.debug((n?"Pausing":"Resuming")+" video tracks in AV stream"),r.pauseResumeLocalAVStream(this,e),"function"==typeof t&&t(!0),!0},resume:function(e,t){var i=this;a.info("Begin to resume AV stream",i),new Promise(function(e,t){i.call.resume(e,t)}).then(function(){if(a.info("AV stream resumed"),i.isVideoPaused()||i.isAudioPaused()){var t=i.getStreamInfo().getStreamProfile().pauseResume;r.enableDisableTracks(i,t),a.info("Resumed AV stream is paused")}e()}).catch(t)}};var v=function(e,t,i,o){this.conversation=e,this.call=t,this.call.avStream=this,this.streamId=i,this.extHeaders=null,this.localMediaStreams=null,this.streamInfo=o,this.onPauseResumeStream=null,this.onUpdateStreamOptions=null};v.prototype={toJSON:function(){return{call:this.call,streamId:this.streamId,extHeaders:this.extHeaders,localMediaStreams:this.localMediaStreams,streamInfo:this.streamInfo,onPauseResumeStream:this.onPauseResumeStream,onUpdateStreamOptions:this.onUpdateStreamOptions}},withCallbacks:function(e,t,i,o,s,n){return this.call.onCallStateChange=e,this.call.onMediaStreamEvent=t,this.call.onUpdate=i,this.call.onCallError=o,this.onPauseResumeStream=s,this.onUpdateStreamOptions=n,this},getConversation:function(){return this.conversation},getId:function(){return this.streamId},getType:function(){return o.STREAMTYPE.SCREENSHARE},getStreamOptions:function(){return this.call.callConfig},getStreamState:function(){return this.call.callState},getStreamInfo:function(){return this.streamInfo},isAudioPaused:function(){return this.streamInfo&&this.streamInfo.isAudioPaused()},isVideoPaused:function(){return this.streamInfo&&this.streamInfo.isVideoPaused()},mute:function(e){return a.debug("Muting stream? "+e),this.call.mute(e)},isMuted:function(){return this.call.isMuted()},getRemoteStreams:function(){return n.getRemoteStreams(this.call.peerConnection)},getLocalStreams:function(){return n.getLocalStreams(this.call.peerConnection)},start:function(e,t){return this.localMediaStreams=e,t||(t=JSON.parse("{}")),this.extHeaders=t,this.conversation.joiningConversation||this.conversation.recordingRules?r.sendStartRequest(this):r.retrieveRecordingRules(this.conversation)&&this.conversation.pendingAVStreams.push(this),this},end:function(e){r.sendEndRequest(this,e)},accept:function(e,t,i){r.sendAcceptResponse(this,e,t,i)},decline:function(e,t){r.sendDeclineResponse(this,e,t)},update:function(e,t,i,o,s){return a.debug("Attempting to update SS stream"),this.call.canUpdate()?(r.isPauseResume(this.getStreamOptions(),e)?this.pauseResumeStream(r.getPauseResumeTargets(e),o,s):(r.sendUpdateRequest(this,e,t,i),"function"==typeof o&&o(!0)),!0):(a.info("Cannot update call - not in correct ICE state: "+this.call.getIceConnectionState()+", call state: "+this.call.getCallState().state,this.call),"function"==typeof s&&s(!1),!1)},pauseResumeStream:function(e,t,i){var s=e.audio===o.PAUSERESUME.PAUSE,n=e.video===o.PAUSERESUME.PAUSE;return a.debug("pauseResumeStream: pauseResume="+JSON.stringify(this.streamInfo.streamProfile.pauseResume,null,2)+", pauseResumeTargets="+JSON.stringify(e,null,2)),this.streamInfo&&this.streamInfo.streamProfile&&this.streamInfo.streamProfile.pauseResume&&e.audio===this.streamInfo.streamProfile.pauseResume.audio&&e.video===this.streamInfo.streamProfile.pauseResume.video?(e.audio===this.streamInfo.streamProfile.pauseResume.audio&&a.debug("AV stream audio tracks already "+(s?"paused":"resumed")),e.video===this.streamInfo.streamProfile.pauseResume.video&&a.debug("AV stream video tracks already "+(n?"paused":"resumed")),r.enableDisableTracks(this,e)):(a.debug((s?"Pausing":"Resuming")+" audio tracks in AV stream"),a.debug((n?"Pausing":"Resuming")+" video tracks in AV stream"),r.pauseResumeLocalAVStream(this,e)),"function"==typeof t&&t(!0),!0},resume:function(e,t){var i=this;a.info("Begin to resume SS stream",i),new Promise(function(e,t){i.call.resume(e,t)}).then(function(){if(a.info("SS stream resumed"),i.isVideoPaused()||i.isAudioPaused()){var t=i.getStreamInfo().getStreamProfile().pauseResume;r.enableDisableTracks(i,t),a.info("Resumed SS stream is paused")}e()}).catch(t)}};var S=function(t,i,o,s){this.conversation=t,this.responseHandler=null,this.retryHandler=null,this.timeoutHandler=null,this.errorHandler=null,this.relayId=s,this.retries=1,this.timeout=10,this.streamId=i,this.relayDest=o,this.relayMessages=new e.Map,this.timer=null;var n=new Date;this.startTime=""+n.getHours()+n.getMinutes()+n.getSeconds()+n.getMilliseconds()};S.prototype={toJSON:function(){return{responseHandler:this.responseHandler,retryHandler:this.retryHandler,timeoutHandler:this.timeoutHandler,errorHandler:this.errorHandler,relayId:this.relayId,retries:this.retries,timeout:this.timeout,streamId:this.streamId,relayDest:this.relayDest,relayMessages:this.relayMessages,timer:this.timer,startTime:this.startTime}},withCallbacks:function(e,t){return this.responseHandler=e,this.errorHandler=t,this},withTimeout:function(e,t){return t&&(this.timeoutHandler=t),this.timeout=e,this},withRetries:function(e,t){t&&(this.retryHandler=t),this.retries=e},getConversation:function(){return this.conversation},getId:function(){return this.relayId},getDestination:function(){return this.relayDest},getStreamId:function(){return this.streamId},createRelayRequest:function(t){t||(a.debug("Calling generateRelayMessageId with type: "+o.TYPE.REQUEST),t=this.generateRelayMessageId(o.TYPE.REQUEST));var i=new e.RelayMessage(this,o.TYPE.REQUEST,t);return this.relayMessages.put(t,i),i},createRelayMessage:function(t){return t||(a.debug("Calling generateRelayMessageId with type: "+o.TYPE.MESSAGE),t=this.generateRelayMessageId(o.TYPE.MESSAGE)),new e.RelayMessage(this,o.TYPE.MESSAGE,t)},createSubsequentRelayResponse:function(t){return new e.RelayMessage(this,o.TYPE.RESPONSE,t.header.relay.msgId)},createFinalRelayResponse:function(t){return new e.RelayMessage(this,o.TYPE.RESPONSE,t).asFinalMessage()},createRelayError:function(t){return new e.RelayMessage(this,o.TYPE.ERROR,t)},generateRelayMessageId:function(e){var t=this.relayMessages.values().filter(function(t){return t.getMessageType()===e}).length;a.debug("Found "+t+" messages with type: "+e);var i="rly-";return e===o.TYPE.REQUEST?i+="req":e===o.TYPE.RESPONSE?i+="res":e===o.TYPE.ERROR?i+="err":e===o.TYPE.MESSAGE&&(i+="msg"),i+(t+1)+"-"+this.startTime},getRelayMessageForId:function(e){return this.relayMessages.get(e)},end:function(){clearInterval(this.timer),this.conversation.relays.remove(this.relayId)},send:function(e){if(e.isRequest()&&(e.updateTimestamp(),void 0===e.retryCount||null===e.retryCount?(e.retryCount=0,a.debug("Relay sending message: id="+e.getId())):(e.retryCount++,a.debug("Relay sending message: id="+e.getId()+", retry="+e.retryCount))),this.conversation.session.sendMessage(e.getMessage(!1)),e.isRequest()){var t=this;this.timer||(a.debug("Relay "+this.relayId+" starting interval timer for tracking timeouts"),this.timer=setInterval(function(){t.handleIntervalTimeout()},1e3))}return e},handleIntervalTimeout:function(){a.debug("handleIntervalTimeout...");var e=Date.now();if(0===this.relayMessages.size())a.debug("Relay.handleIntervalTimeout no messages being tracked. Stopping interval timer"),clearInterval(this.timer),this.timer=null;else{var t,i,o=this.relayMessages.keys(),s=o.length;a.debug("Relay.handleIntervalTimeout tracking "+s+" relay messages"),o.forEach(function(o){a.debug("Found key="+o+" in relayMessages cache");var n=this.relayMessages.get(o);if(n.gotAllResponses)return a.debug("Got all responses"),void(s-=1);var r=!1,l=1,c=[];if(n&&n.gotRelayResponses)for(l=(c=Object.keys(n.gotRelayResponses)).length,a.debug("Message sent to "+l+" destinations"),t=0;t<c.length;t++)i=c[t],a.debug("relayMessage.gotRelayResponses["+i+"] is set to '"+n.gotRelayResponses[i]+"'"),!0===n.gotRelayResponses[i]&&(r=!0);if(n){var d=e-n.getTimestamp(),u=d/1e3,h=n.timeout;null===h&&(h=this.timeout);var g=n.retries;if(null===g&&(g=this.retries),a.debug("elapsedSeconds="+u),a.debug("       timeout="+h),r){if(u>=h){for(a.debug("Only some relay destinations have responded. Creating separate relays for re-sends"),t=0;t<c.length;t++)if(i=c[t],!1===n.gotRelayResponses[i]){var m=this.getConversation().createRelay(this.streamId,i),p=this.createRelayRequest().withMessage(n);m.send(p)}a.debug("Removing Relay Message "+o+" from cache"),this.relayMessages.remove(o)}}else c.length>1&&a.debug("All relay destinations have not responded"),a.debug("Found cached relay with msgId="+n.getId()+" key="+o),u>=h&&(a.debug("relayMessage.retryCount="+n.retryCount),a.debug("                retries="+g),n.retryCount>=g?(a.debug("Relay: relay message has timed out after "+n.retryCount+" reattempt(s): id="+n.getId()),n.timeoutHandler&&n.timeoutHandler(d,n.retryCount,n),this.timeoutHandler&&this.timeoutHandler(d,n.retryCount,n),n.resetCount(),a.debug("Removing Relay Message "+o+" from cache"),this.relayMessages.remove(o)):(a.debug("Relay: About to retry sending timed out message. Calling retry handlers..."),n.retryHandler&&n.retryHandler(d,n.retryCount,n),this.retryHandler&&this.retryHandler(d,n.retryCount,n),a.debug("relay: re-sending timed out relay message: id="+n.getId()+", reattempts="+n.retryCount),this.send(n)))}},this),s<=0&&(a.debug("Relay.handleIntervalTimeout no messages being tracked. Stopping interval timer"),clearInterval(this.timer),this.timer=null)}},createCommand:function(e,t){return this.createRelayRequest().withCommand(e,t)},createText:function(e,t){return this.createRelayRequest().withText(e,t)},createData:function(e,t){return this.createRelayRequest().withData(e,t)},close:function(){var e=this.createRelayRequest().asFinalMessage();this.send(e)},respond:function(e){var t=this.createSubsequentRelayResponse(e);this.send(t)},processSubsequentResponse:function(e){a.debug("Relay "+this.getId()+" processing subsequent response...");var t=e.header.relay.msgId,i=e.header.relay.from;a.debug("  msgId = "+t);var o=this.getRelayMessageForId(t),s=[],n=1;if(o){o.gotRelayResponses&&(n=(s=Object.keys(o.gotRelayResponses)).length,a.debug("Message was sent to "+n+" destinations")),o.receivedResponseFrom(i);var r=0;if(n>1)for(var l=0;l<s.length;l++){var c=s[l];a.debug("processSubsequentResponse: gotRelayResponses["+c+"] is set to '"+o.gotRelayResponses[c]+"'"),o.gotRelayResponses[c]&&r++}1===n||r===n?(a.debug("Got all expected responses"),o.gotAllResponses=!0):a.debug("Number of destinations="+n+", number of responses received="+r)}},processFinalResponse:function(e){a.debug("Relay "+this.getId()+" processing final response...");var t=e.header.relay.msgId,i=e.header.relay.from,o=e.header.relay.messages[0].commands[0];null===o&&(o=e.header.relay.messages[0].text[0]),null===o&&(o=e.header.relay.messages[0].data[0]),a.debug("  msgId = "+t);var s=this.getRelayMessageForId(t),n=[],r=1;if(s){s.gotRelayResponses&&(r=(n=Object.keys(s.gotRelayResponses)).length,a.debug("Message was sent to "+r+" destinations")),s.receivedResponseFrom(i),s.responseHandler&&(a.debug("  Calling user defined RelayMessage.responseHandler"),s.responseHandler(o)),this.responseHandler&&(a.debug("  Calling user defined Relay.responseHandler"),this.responseHandler(o));var l=0;if(r>1)for(var c=0;c<n.length;c++){var d=n[c];a.debug("processFinalResponse: gotRelayResponses["+d+"] is set to '"+s.gotRelayResponses[d]+"'"),s.gotRelayResponses[d]&&l++}a.debug("Number of destinations="+r+", number of responses received="+l),1!==r&&l!==r||(a.debug("  Removing msgId entry from relayMessages request cache"),this.relayMessages.remove(t))}},processError:function(e){a.debug("Relay "+this.getId()+" processing error...");var t=e.header.relay.msgId,i=e.header.relay.from,o=e.header.relay.messages[0].commands[0];null===o&&(o=e.header.relay.messages[0].text[0]),null===o&&(o=e.header.relay.messages[0].data[0]),!o.reason&&e.header.reason&&(o.reason=e.header.reason),e.header.error_code&&(o.error_code=e.header.error_code),a.debug("  msgId = "+t);var s=this.getRelayMessageForId(t),n=[],r=1;if(s){s.gotRelayResponses&&(r=(n=Object.keys(s.gotRelayResponses)).length,a.debug("Message was sent to "+r+" destinations")),s.receivedResponseFrom(i),s.errorHandler&&(a.debug("  Calling user defined RelayMessage.errorHandler with: "+JSON.stringify(o,null,2)),s.errorHandler(o)),this.errorHandler&&(a.debug("  Calling user defined Relay.errorHandler with: "+JSON.stringify(o,null,2)),this.errorHandler(o));var l=0;if(r>1)for(var c=0;c<n.length;c++){var d=n[c];a.debug("processError: gotRelayResponses["+d+"] is set to '"+s.gotRelayResponses[d]+"'"),s.gotRelayResponses[d]&&l++}a.debug("Number of destinations="+r+", number of responses received="+l),1!==r&&l!==r||(a.debug("  Removing msgId entry from relayMessages request cache"),this.relayMessages.remove(t))}}};var _=function(e,t,i){this.relay=e,this.messageId=i,this.responseHandler=null,this.retryHandler=null,this.timeoutHandler=null,this.errorHandler=null,this.retries=null,this.retryCount=null,this.timeout=null,this.final=!1,this.relayDestinations=[],this.excludeDest=null,this.gotRelayResponses=null,this.gotAllResponses=!1,this.timestamp=Date.now(),this.origStreamOptionsCallback=null,this.destStreamOptionsCallback=null,this.messageType=void 0!==t?t:o.TYPE.REQUEST,this.message=null,this.text=null,this.data=null,this.commands=null};_.prototype={toJSON:function(){return{messageId:this.messageId,responseHandler:this.responseHandler,retryHandler:this.retryHandler,timeoutHandler:this.timeoutHandler,errorHandler:this.errorHandler,retries:this.retries,retryCount:this.retryCount,timeout:this.timeout,final:this.final,relayDestinations:this.relayDestinations,gotRelayResponses:this.gotRelayResponses,gotAllResponses:this.gotAllResponses,timestamp:this.timestamp,messageType:this.messageType,message:this.message,origStreamOptionsCallback:this.origStreamOptionsCallback,destStreamOptionsCallback:this.destStreamOptionsCallback,text:this.text,data:this.data,commands:this.commands}},withCallbacks:function(e,t){return a.debug("RelayMessage.withCallbacks: responseHandler="+e),this.responseHandler=e,this.errorHandler=t,this},withTimeout:function(e,t){return t&&(this.timeoutHandler=t),this.timeout=e,this},withRetries:function(e,t){return t&&(this.retryHandler=t),this.retries=e,this},buildMessage:function(e){if(null===this.gotRelayResponses&&(this.relayDestinations=r.determineRelayDestinations(this.getRelay().getConversation(),this.getRelay().getDestination(),this.excludeDest),this.excludeDest=null,this.isRequest())){this.gotRelayResponses={};for(var t=0;t<this.relayDestinations.length;t++){var i=this.relayDestinations[t].uri;this.gotRelayResponses[i]=!1}}null===this.message&&(this.message=r.buildReliableRelayMsg(this,e))},receivedResponseFrom:function(e){a.debug("receivedResponseFrom "+e),e in this.gotRelayResponses&&(a.debug("Marking tracked destination "+e+" as responded"),this.gotRelayResponses[e]=!0)},getConversation:function(){return this.relay.getConversation()},getRelay:function(){return this.relay},getId:function(){return this.messageId},getMessageType:function(){return this.messageType},isRequest:function(){return this.messageType===o.TYPE.REQUEST},isResponse:function(){return this.messageType===o.TYPE.RESPONSE},isError:function(){return this.messageType===o.TYPE.ERROR},isMessage:function(){return this.messageType===o.TYPE.MESSAGE},asFinalMessage:function(){return this.final=!0,this},isFinalMessage:function(){return this.final},getMessage:function(e){return this.buildMessage(e),this.message},resetCount:function(){this.retryCount=null},withText:function(e,t){return a.debug("text relay on thread: "+e+" with content: "+t),this.text||(this.text=[]),this.text.push({thread:e,content:t}),a.debug("total text messages = "+this.text.length),this},withData:function(e,t){return a.debug("data relay for tag: "+e),this.data||(this.data=[]),this.data.push({tag:e,content:t}),a.debug("total data messages = "+this.data.length),this},withCommand:function(e,t){return a.debug("command relay with directive: "+e),this.commands||(this.commands=[]),this.commands.push({directive:e,arguments:[].concat(t)}),a.debug("total command messages = "+this.commands.length),this},withMessage:function(e){return this.message=e.getMessage(!0),this},withOrigStreamOptionsCallback:function(e){return this.origStreamOptionsCallback=e,this},withDestStreamOptionsCallback:function(e){return this.destStreamOptionsCallback=e,this},excludeDestination:function(e){return this.excludeDest=e,this},getOrigStreamOptionsCallback:function(){return this.origStreamOptionsCallback},getDestStreamOptionsCallback:function(){return this.destStreamOptionsCallback},updateTimestamp:function(){this.timestamp=Date.now()},getTimestamp:function(){return this.timestamp},send:function(){this.relay.send(this)},end:function(){a.debug("Removing message id "+this.messageId+" from relay"),this.relay.relayMessages.remove(this.messageId)}};var f=function(e,t,i,o,s){this.relay=e,this.command=t,this.isRequest=i,this.relayMsgId=o,this.relayFrom=s};f.prototype={from:function(){return this.relayFrom},accept:function(e){this.isRequest&&this.relay&&(a.debug("Accepting relay request from: "+this.relayFrom+", for: "+this.command),this.relay.createFinalRelayResponse(this.relayMsgId).withCommand(this.command,[{status:o.RELAYSTATUS.ACCEPTED,info:e}]).send())},decline:function(e){if(this.isRequest&&this.relay){var t=e;t||(t=o.RELAYSTATUS.DECLINED),a.debug("Declining relay request from: "+this.relayFrom+", for: "+this.command),this.relay.createRelayError(this.relayMsgId).withCommand(this.command,[{status:o.RELAYSTATUS.DECLINED,reason:t}]).send()}}};var C=function(e){this.factorMonitors={},this.streamInfo=e,this.onNewInboundFrameRate=null,this.onNewOutboundFrameRate=null,this.onNewInboundResolution=null,this.onNewOutboundResolution=null,this.__audioOutboundRttThreshold=500,this.__videoOutboundRttThreshold=500,this.__videoPacketLossRateThreshold=.3,this.__audioPacketLossRateThreshold=.3,this.__frameRateThreshold=10,this.__jitterThreshold=500,this.__keepCount=3,this.__audioPacketsLostKeepLimit=7,this.__videoPacketsLostKeepLimit=3};return C.prototype={onNewStatus:function(e,t){var i=!1;for(var s in o.ExperienceFactor)if(o.ExperienceFactor.hasOwnProperty(s)&&o.ExperienceFactor[s]===e){this.factorMonitors[e]=t,i=!0;break}i||a.warn("The given factor: "+e+" is not valid.")},withCallbacks:function(e,t,i,o){return this.onNewInboundFrameRate=e,this.onNewOutboundFrameRate=t,this.onNewInboundResolution=i,this.onNewOutboundResolution=o,this},getStreamInfo:function(){return this.streamInfo}},r.isPauseResume=function(e,t){var i=e.shouldSendVideo(),o=t.shouldSendVideo(),s=e.shouldReceiveVideo(),n=t.shouldReceiveVideo(),r=e.shouldSendAudio(),l=t.shouldSendAudio(),c=t.isPaused();return a.debug("isPauseResume: isPaused="+c+", oldAudio="+r+", oldVideo="+i+", oldVideoRecv="+s+", newAudio="+l+", newVideo="+o+", newVideoRecv="+n),!!c||r===l&&i===o&&s===n},r.enableDisableTracks=function(e,t){var i=t.audio===o.PAUSERESUME.PAUSE,s=t.video===o.PAUSERESUME.PAUSE;a.debug((i?"Disable":"Enable")+" audio tracks for stream: "+e.getId()),a.debug((s?"Disable":"Enable")+" video tracks for stream: "+e.getId()),e.paused=t,e.getLocalStreams().map(function(e){"undefined"!=typeof RTCRtpReceiver&&e instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e instanceof RTCRtpSender?e.track&&"audio"===e.track.kind?e.track.enabled=!i:e.track&&"video"===e.track.kind&&(e.track.enabled=!s):(e.getAudioTracks().map(function(e){e.enabled=!i}),e.getVideoTracks().map(function(e){e.enabled=!s}))}),t.reason===o.PAUSERESUMEREASON.PAUSE_RESUME&&this.enableDisableRemoteTracks(e,t)},r.enableDisableRemoteTracks=function(e,t){a.debug("enableDisableRemoteTracks");var i=t.audio===o.PAUSERESUME.PAUSE,s=t.video===o.PAUSERESUME.PAUSE;a.debug((i?"Disable":"Enable")+" audio tracks for stream: "+e.getId()),a.debug((s?"Disable":"Enable")+" video tracks for stream: "+e.getId()),e.paused=t,e.getRemoteStreams().map(function(e){"undefined"!=typeof RTCRtpReceiver&&e instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&e instanceof RTCRtpSender?e.track&&"audio"===e.track.kind?e.track.enabled=!i:e.track&&"video"===e.track.kind&&(e.track.enabled=!s):(e.getAudioTracks().map(function(e){e.enabled=!i}),e.getVideoTracks().map(function(e){e.enabled=!s}))})},r.pauseResumeLocalAVStream=function(e,t){r.enableDisableTracks(e,t);var i=e.conversation.getLocalParticipantUri();t.pausedBy&&(i=t.pausedBy,t.pausedBy=null),e.streamInfo.streamProfile.updateForPauseResume(t,i),r.sendProfileUpdate(e.conversation,e.streamInfo)},r.relayStreamEvent=function(e,t,i){var o=e.conversation.getRelayForDestUrl("*");null===o&&(o=e.conversation.createRelay(e.getId(),"*")),o.createRelayMessage().withCommand(t,i).send()},r.handleParticipantChange=function(t,i,s,n,r){a.debug("handleParticipantChange: uri="+s+", change="+i,n);var l,c,d,u=!1,h=o.CONVERSATIONSTATE.STREAM_CHANGED;switch(i){case o.CONVERSATION.ADD_STREAM:if(t.__participantsHistory.indexOf(s)<0&&t.__participantsHistory.push(s),(l=t.getParticipant(s))||(u=!0,l=t.localAddParticipant(s)),n&&n.length>0)for(a.debug("Adding streams: "+JSON.stringify(n,null,2)),c=0;c<n.length;c++)n[c].stream_id&&((d=l.getStreamInfo(n[c].stream_id))||(h=o.CONVERSATIONSTATE.STREAM_ADDED,d=l.localAddStreamInfo(n[c].stream_id,n[c].stream_type,n[c].stream_options,n[c].stream_profile)),d&&(void 0!==n[c].stream_options&&d.localSetStreamOptions(n[c].stream_options),void 0!==n[c].stream_profile&&d.localSetStreamProfile(n[c].stream_profile),void 0!==n[c].size&&d.localSetStreamLayout(n[c].size),void 0!==n[c].recording_status&&d.localSetRecording(n[c].recording_status),l.onParticipantStateChange&&!u&&(a.debug("Invoking onParticipantStateChange callback for change: "+h),l.onParticipantStateChange(h,d))));t.onParticipantChange&&u&&(a.debug("Invoking onParticipantChange callback for change: "+o.CONVERSATIONSTATE.STREAM_ADDED),t.onParticipantChange(t,o.CONVERSATIONSTATE.STREAM_ADDED,l));break;case o.CONVERSATION.REMOVE_STREAM:var g=0;if((l=t.getParticipant(s))&&n&&n.length>0)for(a.debug("Removing streams: "+JSON.stringify(n,null,2)),c=0;c<n.length;c++)n[c].stream_id&&(a.debug("Removing stream ("+n[c].stream_id+") from participant: "+JSON.stringify(l,null,2)),(d=l.getStreamInfo(n[c].stream_id))||(d=new e.StreamInfo(l,n[c].stream_id,n[c].stream_type,n[c].stream_options,n[c].stream_profile)),g=l.localRemoveStreamInfo(n[c].stream_id),l.onParticipantStateChange&&(a.debug("Invoking onParticipantStateChange callback for change: "+o.CONVERSATIONSTATE.STREAM_REMOVED),l.onParticipantStateChange(o.CONVERSATIONSTATE.STREAM_REMOVED,d)));if(g<=0&&(t.localRemoveParticipant(s),t.onParticipantChange)){l||(l=new e.Participant(t,s));var m=o.CONVERSATIONSTATE.STREAM_REMOVED;r&&(m=o.CONVERSATIONSTATE.STREAM_REJECTED),a.debug("Invoking onParticipantChange callback for change: "+m),t.onParticipantChange(t,m,l)}break;case o.CONVERSATION.STREAM_OPTIONS:case o.CONVERSATIONSTATE.STREAM_JOINED:case o.CONVERSATIONSTATE.STREAM_CHANGED:case o.CONVERSATIONSTATE.STREAM_ACTIVE:case o.CONVERSATIONSTATE.PROFILE_UPDATED:case o.CONVERSATIONSTATE.SIDEBAR_CREATED:if(i===o.CONVERSATIONSTATE.SIDEBAR_CREATED&&(a.debug("Sidebar created - disable short-circuit mode"),t.shortCircuitMode=!1),(l=t.getParticipant(s))&&n&&n.length>0)for(a.debug("Updating streams: "+JSON.stringify(n,null,2)),c=0;c<n.length;c++)n[c].stream_id&&(!(d=l.getStreamInfo(n[c].stream_id))&&l.notRemovedStream(n[c].stream_id)&&(d=l.localAddStreamInfo(n[c].stream_id,n[c].stream_type,n[c].stream_options,n[c].stream_profile)),d&&(void 0!==n[c].stream_options&&d.localSetStreamOptions(n[c].stream_options),void 0!==n[c].stream_profile&&d.localSetStreamProfile(n[c].stream_profile),void 0!==n[c].size&&d.localSetStreamLayout(n[c].size),void 0!==n[c].recording_status&&d.localSetRecording(n[c].recording_status),i===o.CONVERSATIONSTATE.STREAM_ACTIVE&&(d.localSetActive(!0),d.streamType===o.STREAMTYPE.AUDIOVIDEO&&n[c].stream_type===o.STREAMTYPE.SCREENSHARE&&(d.streamType=n[c].stream_type,a.debug("Stream "+d.getId()+" is active (updating type to: "+d.getType()+")"))),l.onParticipantStateChange&&(i===o.CONVERSATION.STREAM_OPTIONS?(a.debug("Invoking onParticipantStateChange callback for change: "+o.CONVERSATIONSTATE.STREAM_CHANGED,d),l.onParticipantStateChange(o.CONVERSATIONSTATE.STREAM_CHANGED,d)):(a.debug("Invoking onParticipantStateChange callback for change: "+i,d),l.onParticipantStateChange(i,d)))));else console.log("Failed to process instruction - no participant found for: "+s)}},r.doRequest=function(e,t){var i=t.header,s=i.action,n=i.conversation_key,l=i.conversation_topic,c=i.instructions,d=i.conversation_info,u=i.stream_id,h=i.sidebar,g=i.allow_direct_calls,m=null,p=[],v=0;switch(a.debug("Have conversation request with action: "+s),c&&(p=[].concat(c),a.debug("Have conversation instructions: "+JSON.stringify(p,null,2))),u?(a.debug("Have conversation request for stream: "+u),(m=e.getStreamForId(u))||(m=e.getAudioVideoStream())):m=e.getAudioVideoStream(),s){case o.ACTION.START:for(a.debug("Conversation start request with conversation key: "+n),e.conversationKey=n,l&&(a.debug("Have conversation name: "+l),e.conversationTopic=l),void 0!==g&&a.debug("Have short-circuit mode: "+g),g&&e.withShortCircuit(),h&&(a.debug("Have sidebar: "+h),e.sidebarId=h),v=0;v<p.length;v++)if(p[v].participants){a.debug("Conversation start request with participants: "+p[v].participants);for(var S=[].concat(p[v].participants),_=0;_<S.length;_++)r.handleParticipantChange(e,o.CONVERSATION.ADD_STREAM,S[_].uri,S[v].streams)}d&&r.processConversationInfo(e,d),a.debug("Conversation has "+e.getParticipants().length+" participants (including initiator)"),m.call.onMessage(t);break;case o.ACTION.MODIFY:p.length>0&&function(){var t,i;for(v=0;v<p.length;v++)switch(a.debug("Conversation modify request with instruction: "+p[v].instruction_name),p[v].instruction_name){case o.CONVERSATION.ADD_STREAM:case o.CONVERSATION.REMOVE_STREAM:if(p[v].participants)for(a.debug("Conversation modify request with participants: "+p[v].participants),t=[].concat(p[v].participants),i=0;i<t.length;i++)r.handleParticipantChange(e,p[v].instruction_name,t[i].uri,t[v].streams);break;case o.CONVERSATION.BEGIN_RECORD:e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0);break;case o.CONVERSATION.END_RECORD:e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!1)}}();break;default:m.call.onMessage(t)}},r.doResponse=function(e,t){var i=t.header,s=i.action,n=i.conversation_key,l=i.conversation_topic,c=i.response_code,d=t.control.message_state,u=i.conversation_info,h=i.enquiry_data,g=i.stream_id,m=i.allow_direct_calls,p=i.sidebar,v=null;switch(a.debug("Have conversation response with action: "+s+" and code: "+c),g?(a.debug("Have conversation response for stream: "+g),(v=e.getStreamForId(g))||(v=e.getAudioVideoStream())):v=e.getAudioVideoStream(),s){case o.ACTION.START:a.debug("Conversation start response with conversation key: "+n),!e.conversationKey&&n&&(e.conversationKey=n),l&&(a.debug("Have conversation name: "+l),e.conversationTopic=l),void 0!==m&&a.debug("Have short-circuit mode: "+m),m&&e.withShortCircuit(),p&&(a.debug("Have sidebar: "+p),e.sidebarId=p),v.call.onMessage(t);var S=200===c&&"final"===d;u?r.processConversationInfo(e,u):S&&r.sendConversationEnquiry(e);break;case o.ACTION.ENQUIRY:a.debug("Conversation enquiry response with conversation key: "+n),!e.conversationKey&&n&&(e.conversationKey=n),u||h?(r.processConversationInfo(e,u),r.processEnquiryResponse(e,h),"function"==typeof e.statusCheckSuccess&&(a.debug("Successful status check response"),e.statusCheckSuccess(),clearTimeout(e.statusCheckTimeout),e.statusCheckTimeout=null,e.statusCheckSuccess=null)):v.call.onMessage(t);break;case o.ACTION.MODIFY:a.debug("Received modify response with code: "+c);break;default:v.call.onMessage(t)}},r.processConversationInfo=function(e,t){if(t){if(a.debug("Have some conversation info: "+JSON.stringify(t,null,2)),t.participants&&t.participants.length>0){var i=[].concat(t.participants);a.debug("Have some participants: "+JSON.stringify(i,null,2));for(var s=0;s<i.length;s++){var n=i[s].uri,l=i[s].streams;r.handleParticipantChange(e,o.CONVERSATION.ADD_STREAM,n,l)}if(e.isEstablished())for(var c=e.getParticipants(),d=0;d<c.length;d++){var u=c[d].getUri();a.debug("Checking if participant is present: "+u),i.some(function(e){return e.uri===u})||(a.info("Participant left the conversation: "+u),r.handleParticipantChange(e,o.CONVERSATION.REMOVE_STREAM,u,c[d].getStreamInfos()))}}t.recording_status&&(e.localSetRecording(t.recording_status),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,e.isRecording())),t.web_context&&!e.webContext&&(a.debug("Have some web context information: "+JSON.stringify(t.web_context)),e.webContext=t.web_context)}},r.processEnquiryResponse=function(e,t){if(t){var i=JSON.parse(t);a.debug("Received some enquiry data: "+JSON.stringify(i,null,2)),e.defaultEnquiryResponse(i),e.onEnquiryResponse&&(a.debug("Invoking conversation.onEnquiryResponse",e),e.onEnquiryResponse(i)),r.sendDelayedStartRequests(e)}},r.processInstructions=function(e,t,i){var s,n,l,c=[];for(s=0;s<t.length;s++){a.debug("Processing conversation instruction: "+t[s].instruction_name);var d,u=null;switch(t[s].instruction_name){case o.CONVERSATION.ADD_STREAM:case o.CONVERSATIONSTATE.STREAM_ADDED:case o.CONVERSATIONSTATE.STREAM_STARTED:if(i)for(c=[].concat(i),a.debug("Adding participants to conversation: "+JSON.stringify(c,null,2)),n=0;n<c.length;n++)(l=c[n].streams)||(l=[{stream_id:c[n].stream_id,stream_type:c[n].stream_type,stream_options:c[n].stream_options,recording_status:c[n].recording_status}]),r.handleParticipantChange(e,o.CONVERSATION.ADD_STREAM,c[n].uri,l);break;case o.CONVERSATION.REMOVE_STREAM:case o.CONVERSATIONSTATE.STREAM_REMOVED:case o.CONVERSATIONSTATE.STREAM_LEFT:case o.CONVERSATIONSTATE.STREAM_REJECTED:if(i)for(c=[].concat(i),a.debug("Removing participants from conversation: "+JSON.stringify(c,null,2)),n=0;n<c.length;n++)(l=c[n].streams)&&(l=l.filter(function(e){return e.stream_id===c[n].stream_id})),d&&0!==l.length||(l=[{stream_id:c[n].stream_id,stream_type:c[n].stream_type}]),r.handleParticipantChange(e,o.CONVERSATION.REMOVE_STREAM,c[n].uri,l,t[s].instruction_name===o.CONVERSATIONSTATE.STREAM_REJECTED);break;case o.CONVERSATION.BEGIN_RECORD:case o.CONVERSATIONSTATE.RECORDING_STARTED:if(i)if((c=[].concat(i)).length>0&&"*"!==c[0].uri)for(n=0;n<c.length;n++)(u=e.getParticipant(c[n].uri))?(d=u.getStreamInfo(c[n].stream_id))?(d.localSetRecording(!0),u.onParticipantStateChange&&u.onParticipantStateChange(o.CONVERSATIONSTATE.RECORDING_STARTED,d)):console.log("Failed to process instruction - no stream with id: "+c[n].stream_id+" found for participant: "+c[n].uri):console.log("Failed to process instruction - no participant found for: "+c[n].uri);else e.localSetRecording(!0),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0);break;case o.CONVERSATION.END_RECORD:case o.CONVERSATIONSTATE.RECORDING_ENDED:if(e.localSetRecording(!1),i)if((c=[].concat(i)).length>0&&"*"!==c[0].uri)for(n=0;n<c.length;n++)(u=e.getParticipant(c[n].uri))?(d=u.getStreamInfo(c[n].stream_id))?(d.localSetRecording(!1),u.onParticipantStateChange&&(a.debug("Invoking onParticipantStateChange callback for change: "+o.CONVERSATIONSTATE.RECORDING_ENDED),u.onParticipantStateChange(o.CONVERSATIONSTATE.RECORDING_ENDED,d))):console.log("Failed to process instruction - no stream with id: "+c[n].stream_id+" found for participant: "+c[n].uri):console.log("Failed to process instruction - no participant found for: "+c[n].uri);else e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!1);break;case o.CONVERSATION.STREAM_OPTIONS:case o.CONVERSATIONSTATE.STREAM_JOINED:case o.CONVERSATIONSTATE.STREAM_CHANGED:case o.CONVERSATIONSTATE.PROFILE_UPDATED:case o.CONVERSATIONSTATE.SIDEBAR_CREATED:if(i)for(c=[].concat(i),a.debug("Updating participants in conversation: "+JSON.stringify(c,null,2)),n=0;n<c.length;n++)(l=c[n].streams)||(l=[{stream_id:c[n].stream_id,stream_type:c[n].stream_type,stream_options:c[n].stream_options,recording_status:c[n].recording_status}]),r.handleParticipantChange(e,t[s].instruction_name,c[n].uri,l);break;case o.CONVERSATIONSTATE.STREAM_ACTIVE:if(i)for(c=[].concat(i),a.debug("Processing participants in conversation: "+JSON.stringify(c,null,2)),n=0;n<c.length;n++)l=[{stream_id:c[n].stream_id,stream_type:c[n].stream_type}],r.handleParticipantChange(e,t[s].instruction_name,c[n].uri,l);break;default:a.info("Unknown conversation instruction: "+t[s].instruction_name)}}},r.doMessage=function(e,t){var i=t.header,s=i.action,l=i.conversation_key,c=i.conversation_topic,d=i.conversation_info,u=i.participant,h=i.event,g=i.relay,m=i.stream_id,p=i.stream_type,v=i.sidebar,S=null,_=!1,f=[],C=[];switch(a.debug("Have conversation message with action: "+s),m?(a.debug("Have conversation message for stream: "+m+" (type: "+p+")"),_=null!==(S=e.getStreamForId(m)),S||(S=e.getAudioVideoStream())):S=e.getAudioVideoStream(),i.instructions&&(C=[].concat(i.instructions)),i.instruction_name&&(C=[].concat({instruction_name:i.instruction_name})),h&&h.event_name&&(C=[].concat({instruction_name:h.event_name})),C&&C.length>0&&a.debug("Have conversation instructions: "+JSON.stringify(C,null,2)),h&&h.participants&&(a.debug("Have event participants: "+JSON.stringify(h.participants,null,2)),f=[].concat(h.participants)),u&&(a.debug("Have target participant: "+u+", stream: "+m+"/"+p),f=[].concat({uri:u,stream_id:m,stream_type:p})),s){case o.ACTION.COMPLETE:null===e.conversationKey&&null!==l?e.conversationKey=l:null!==e.conversationKey&&(l=e.conversationKey),a.debug("Conversation complete message with key: "+l),c&&(a.debug("Have conversation name: "+c),e.conversationTopic=c),v&&(a.debug("Have sidebar: "+v),e.sidebarId=v);for(var b=0;b<C.length;b++)switch(a.debug("Conversation message with instruction: "+C[b].instruction_name),C[b].instruction_name){case o.CONVERSATION.BEGIN_RECORD:case o.CONVERSATIONSTATE.RECORDING_STARTED:e.localSetRecording(!0),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0)}S.call.onMessage(t),d?r.processConversationInfo(e,d):r.sendConversationEnquiry(e);break;case o.ACTION.NOTIFY:C.length>0?r.processInstructions(e,C,f):l?a.warn("Ignoring notify message with no conversation instructions"):S.call.onMessage(t);break;case o.ACTION.RELAY:e.getLocalParticipantUri();g.from&&g.from,[].concat(g.messages).forEach(function(i){r.processRelay(e,S,t,i)});break;case o.ACTION.SHUTDOWN:_&&function(i){if(!i)return a.debug("Failed to process shutdown for invalid AV stream - ending conversation"),void e.end();var s=i.getStreamState().state;if(a.debug("Processing shutdown for conversation with "+e.streams.size()+" streams, AV stream to shutdown has id: "+i.getId()+", type:"+i.getType()+", state: "+s),e.streams.size()>1)switch(s){case o.CALLSTATE.ESTABLISHED:case o.CALLSTATE.UPDATED:case o.CALLSTATE.UPDATE_FAILED:case o.CALLSTATE.ERROR:a.debug("=== (conversation) doShutdownMessage ==="),i.call.setCallState(o.CALLSTATE.ENDED,"","shutdown");try{n.clearPeerConnection(i.call),i.call.peerConnection=null}catch(e){a.error("clear peer connection error: "+e)}for(var r=i.call.localMediaStreams,l=0;l<r.length;l++){var c=r[l];a.debug("Media stream "+l+": used by "+c.peerConnectionNum+" peer connections."),c&&(null===c.peerConnectionNum||c.peerConnectionNum<=0)&&("undefined"!=typeof RTCRtpReceiver&&c instanceof RTCRtpReceiver||"undefined"!=typeof RTCRtpSender&&c instanceof RTCRtpSender?(c.track&&"video"===c.track.kind&&(a.debug("Stop this media stream: [video tracks: 1, audio tracks: 0]"),c.track.stop()),c.track&&"audio"===c.track.kind&&(a.debug("Stop this media stream: [video tracks: 0, audio tracks: 1]"),c.track.stop())):(a.debug("Stop this media stream: [video tracks: "+c.getVideoTracks().length+", audio tracks: "+c.getAudioTracks().length+"]"),c.getTracks().forEach(function(e){e.stop()})))}e.streams.remove(i.getId());var d=e.getLocalParticipant();d&&(a.debug("Remove stream from local participants: "+i.getId()),d.localRemoveStreamInfo(i.getId())),0===e.streams.size()&&e.remove();break;default:i.call.onMessage(t)}else i.call.onMessage(t)}(S);break;default:S.call.onMessage(t)}},r.processRelay=function(t,i,s,n){var l=s.header,c=l.relay,d=c.from,u=c.msgId,h=c.relayId,m=l.stream_id,p=t.getRelayForId(h);a.debug("Processing Relay: Relay message from "+d,n);var v=n.commands;if(v){var S=[].concat(v);S.length>0&&a.debug("Have relay command message: "+JSON.stringify(S,null,2)),S.forEach(function(n){a.debug("Processing relay command: "+JSON.stringify(n,null,2));var l,c,h,m=n.directive,v=new e.StreamRequest(p,m,s.isRequest(),u,d),S=[].concat(n.arguments);switch(m){case o.CONVERSATION.STREAM_OPTIONS:var _=g.createStreamOptions(S[0].audio,S[0].video);a.debug("Request to modify media direction: "+JSON.stringify(_,null,2)),i.onUpdateStreamOptions?(a.debug("Calling onUpdateStreamOptions callback with arguments: options="+JSON.stringify(_,null,2)+", streamRequest="+JSON.stringify(v,null,2)),i.onUpdateStreamOptions(t,i,v,_)):v.decline("Not implemented");break;case o.CONVERSATION.PAUSE_RESUME_STREAM:(l=S[0]).pausedBy=v.from(),a.debug((l?"Pausing":"Resuming")+" local AV stream"),i.onPauseResumeStream?(a.debug("Calling onPauseResumeStream callback with arguments: paused="+JSON.stringify(l,null,2)+", streamRequest="+JSON.stringify(v,null,2)),i.onPauseResumeStream(t,i,v,l)):v.decline("Not implemented");break;case o.CONVERSATIONSTATE.STREAM_ACTIVE:h=S[0],r.handleParticipantChange(t,o.CONVERSATIONSTATE.STREAM_ACTIVE,h.uri,h.streams);break;case o.CONVERSATION.ADD_STREAM:h=t.getLocalParticipant(),c=S[0],a.debug("Adding "+c.stream_type+" stream to local participant with options: "+c.stream_options),h.onAddStream?(a.debug("Calling onAddStream callback with arguments: type="+c.stream_type+", options="+c.stream_options+", from="+d),h.onAddStream(t,h,v,c.stream_type,c.stream_options)):v.decline("Not implemented");break;case o.CONVERSATION.REMOTE_ADD_STREAM:c=S[0],(h=t.getParticipant(d))?(a.debug("Request to add "+c.stream_type+" stream to remote participant ("+d+") with options: "+c.stream_options),h.onAddRemoteStream?(a.debug("Calling onAddRemoteStream callback with arguments: type="+c.stream_type+", options="+c.stream_options+", from="+d),h.onAddRemoteStream(t,h,v,c.stream_type,c.stream_options)):v.decline("Not implemented")):(a.debug("No remote participant - cannot handle 'remote add stream' request"),v.decline("No remote participant"));break;default:a.debug("Unknown relay command directive: "+m),t.onRelayCommand&&t.onRelayCommand(t,i,v,m,S)}})}var _=n.text;if(_){var f=[].concat(_);f.length>0&&a.debug("Have relay text message: "+JSON.stringify(f,null,2)),f.forEach(function(e){a.debug("Processing relay text: "+e);var i=e.thread,o=e.content;t.onRelayText&&t.onRelayText(t,d,i,o)})}var C=n.data;if(C){var b=[].concat(C);b.length>0&&a.debug("Have relay data message: "+JSON.stringify(b,null,2)),b.forEach(function(e){a.debug("Processing relay data: "+e);var i=e.tag,o=e.content;if(0===i.indexOf("__wsc_internal_")){if("__wsc_internal_quality_monitor_new_status__"===i){var s=t.getParticipant(d);if(s){var n=s.getStreamInfo(m);if(n){var r=n.getQualityMonitor();for(var l in o)if(o.hasOwnProperty(l)){var c=r.factorMonitors[l];"function"==typeof c&&c.call(r,o[l].value,o[l].hints)}}}}}else t.onRelayData&&t.onRelayData(t,d,i,o)})}},r.doReliableRelay=function(e,t){var i=t.header,o=i.relay,s=o.from,n=o.relayId;a.debug("doReliableRelay received relay message from: "+s+" (with id: "+n+")",t);var l=null,c=i.stream_id,d=i.stream_type,u=null;return c?(a.debug("Have reliable relay message for stream: "+c+" (type: "+d+")"),(l=e.getStreamForId(c))||(l=e.getAudioVideoStream())):l=e.getAudioVideoStream(),t.isFinalResponse()?(a.debug("Processing reliable relay final response..."),void((u=e.getRelayForId(n))&&u.processFinalResponse(t))):t.isResponse()?(a.debug("Processing reliable relay subsequent response..."),void((u=e.getRelayForId(n))&&u.processSubsequentResponse(t))):t.isError()?(a.debug("Processing reliable relay error..."),void((u=e.getRelayForId(n))&&u.processError(t))):(t.isRequest()&&(a.debug("Attempting to respond to reliable relay request..."),void 0!==(u=e.getRelayForId(n))&&null!==u||(a.debug("Creating new relay to respond to new incoming message"),u=e.createRelay(l.getId(),s,n)),a.debug("Responding to request message:"),u.respond(t)),a.debug("Iterating over relay messages..."),void[].concat(o.messages).forEach(function(i){r.processRelay(e,l,t,i)}))},r.doError=function(e,t){function i(){for(a.debug("=== doErrorMessage ==="),t.ack(e.session),v=0;v<p.length;v++){a.debug("Conversation error with instruction: "+p[v].instruction_name);var i;switch(p[v].instruction_name){case o.CONVERSATION.ADD_STREAM:h&&r.handleParticipantChange(e,o.CONVERSATION.REMOVE_STREAM,h,null);break;case o.CONVERSATION.REMOVE_STREAM:if(e.lastRemovedParticipant&&e.lastRemovedParticipant.uri===h){var l=e.lastRemovedParticipant.streams;r.handleParticipantChange(e,o.CONVERSATION.ADD_STREAM,h,l)}break;case o.CONVERSATION.BEGIN_RECORD:h&&"*"!==h?(n=e.getParticipant(h))&&((i=n.getStreamInfo(g)).localSetRecording(!1),n.onParticipantStateChange&&n.onParticipantStateChange(o.CONVERSATIONSTATE.RECORDING_ENDED,i)):(e.localSetRecording(!1),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!1)),o.CONVERSATION.END_RECORD;break;case o.CONVERSATION.END_RECORD:h&&"*"!==h?(n=e.getParticipant(h))&&((i=n.getStreamInfo(g)).localSetRecording(!0),n.onParticipantStateChange&&(a.debug("Invoking onParticipantStateChange callback for change: "+o.CONVERSATIONSTATE.RECORDING_STARTED),n.onParticipantStateChange(o.CONVERSATIONSTATE.RECORDING_STARTED,i))):(e.localSetRecording(!0),e.onRecordingStatusChange&&e.onRecordingStatusChange(e,!0))}}var c=new s.ErrorInfo(d,u);try{e.onError(c)}catch(e){a.error("Exception occurred while invoking onError callback: "+e)}}var n,l=t.header,c=l.action,d=l.error_code,u=l.reason,h=String(l.participant),g=l.stream_id,m=null,p=[],v=0;if(a.warn("Have conversation error with action: "+c+", code: "+d+" and reason: "+u),g)if(a.debug("Have conversation error for stream: "+g),m=e.getStreamForId(g)){m&&m.call&&m.call.collectClientLog(o.LOGTYPE.ERROR_LOG,o.ERRORLOG.ERROR_FROM_SERVER+":"+JSON.stringify(t));var S=m.call&&m.call.onCallError;if(S)S(new s.ErrorInfo(o.ERRORCODE.SIGNALING_ERROR,d+"/"+u))}else m=e.getAudioVideoStream();else m=e.getAudioVideoStream();switch(l.instructions&&(p=[].concat(l.instructions)),l.instruction_name&&(p=[].concat({instruction_name:l.instruction_name})),p&&p.length>0&&a.debug("Have conversation instructions: "+JSON.stringify(p,null,2)),h&&a.debug("Have target participant: "+h),c){case o.ACTION.START:m?m.call.onMessage(t):(a.error("Failed to forward error message to stream"),i());break;default:i()}},r.retrieveRecordingRules=function(e){return e.joiningConversation?(a.debug("Joining conversation, not retrieving recording rules"),!1):(a.info("Begin to retrieve recording rules",e),r.logEventTimestamp(e.session,"enquiryRequestSent"),r.sendConversationEnquiry(e),!0)},r.sendDelayedStartRequests=function(e){for(a.debug("Sending "+e.pendingAVStreams.length+" delayed start requests");e.pendingAVStreams.length>0;){var t=e.pendingAVStreams.pop();t&&r.sendStartRequest(t)}},r.sendStartRequest=function(e){var t=e.conversation;a.debug("Starting stream with key: "+t.conversationKey);var i,s=JSON.parse("{}");e.extHeaders&&(s=e.extHeaders);var n=[];if(t.joiningConversation)a.debug("Joining conversation - not adding participants");else if(t.streams.size()<=1){var r=t.getParticipants().filter(function(e){return e.uri!==t.initiator});if(r.length>0){var l=[];for(i=0;i<r.length;i++)Array.prototype.push.apply(l,r[i].asJSONArray(e.getType()));a.debug("Adding participants to conversation: "+JSON.stringify(l,null,2)),n.push({instruction_name:o.CONVERSATION.ADD_STREAM,participants:l})}}a.debug("Checking recording rules for automatic recording");var c=t.recordingRules;if(c&&t.alwaysRecordOnCreation&&!t.neverRecordOnCreation){a.info("Conversation will be recorded (with rules) "+JSON.stringify(c,null,2));var d={instruction_name:o.CONVERSATION.BEGIN_RECORD,recording_style:t.recordingStyle};if(c.participants){d.participants=[];for(var u=0;u<c.participants.length;u++)d.participants.push({uri:c.participants[u]})}c.include_associations&&(a.info("Adding associations "+c.include_associations),d.include_associations=c.include_associations),c.exclude_associations&&(a.info("Adding exclude associations "+c.exclude_associations),d.exclude_associations=c.exclude_associations),n.push(d)}else t.alwaysRecordOnCreation&&!t.neverRecordOnCreation&&(a.debug("Conversation will be recorded (without rules)"),n.push({instruction_name:o.CONVERSATION.BEGIN_RECORD,recording_style:t.recordingStyle}));if(s.instructions=n,t.conversationTopic&&(s.conversation_topic=t.conversationTopic),t.shortCircuitMode&&(s.allow_direct_calls=t.shortCircuitMode),t.conversationChannel&&(s.conversation_channel=t.conversationChannel),t.conversationKey&&(s.conversation_key=t.conversationKey),t.webContext?s.web_context=t.webContext:s.web_context={},t.clientId&&(s.web_context.clientId=t.clientId),t.clientId&&(s.web_context.clientVersion=t.clientVersion),t.sidebarId&&(s.sidebar=t.sidebarId),s.stream_id&&s.stream_type){var h=e.streamId;e.streamId=s.stream_id,e.call.streamId=s.stream_id,e.call.callState.streamId=s.stream_id,e.call.streamType=s.stream_type,h!==e.streamId&&t.updateStreamId(e,h)}else s.stream_id=e.getId(),s.stream_type=e.getType();s.stream_profile=t.getLocalParticipant().getStreamInfo(s.stream_id).getStreamProfile(),a.debug("start with extHeaders: "+JSON.stringify(s,null,2)),e.call.shortCircuitMode=t.shortCircuitMode,e.call.start(e.localMediaStreams,s)},r.sendUpdateRequest=function(e,t,i,o){a.info("Begin to update stream with streamOptions: "+JSON.stringify(t),e);var s=e.conversation.getLocalParticipant().getStreamInfo(e.getId()),n=s.getStreamOptions();s.localSetStreamOptions(t),a.debug("Updating participant stream options from: "+JSON.stringify(n,null,2)+" to: "+JSON.stringify(t,null,2));var r=JSON.parse("{}");o&&(r=o),r.stream_id=e.getId(),r.stream_type=e.getType(),r.stream_options=t.asJSON(),e.conversation.conversationKey&&(r.conversation_key=e.conversation.conversationKey),e.conversation.webContext&&(r.web_context=e.conversation.webContext),e.conversation.sidebarId&&(r.sidebar=e.conversation.sidebarId),a.debug("update with extHeaders: "+JSON.stringify(r,null,2)),e.call.shortCircuitMode=e.conversation.shortCircuitMode,e.call.update(t,i,r)},r.sendAcceptResponse=function(e,t,i,o){a.info("Begin to accept request for stream with streamOptions: "+JSON.stringify(t,null,2),e);var s=e.conversation.getLocalParticipant().getStreamInfo(e.getId());s.localSetStreamOptions(t);var n=JSON.parse("{}");o&&(n=o),n.stream_id=e.getId(),n.stream_type=e.getType(),n.stream_options=t.asJSON(),n.stream_profile=s.getStreamProfile().toJSON(),a.debug("accept with extHeaders: "+JSON.stringify(n,null,2)),e.call.shortCircuitMode=e.conversation.shortCircuitMode,e.call.accept(t,i,n)},r.sendDeclineResponse=function(t,i,o){var s=t.getStreamState().state;a.info("Begin to decline request for stream in state: "+s,t);var n=JSON.parse("{}");if(o&&(n=o),n.stream_id=t.getId(),n.stream_type=t.getType(),s===e.CALLSTATE.UPDATING){var r=t.call.lastCallConfig;a.debug("accept with incoming streamOptions and extHeaders: "+JSON.stringify(n,null,2)),t.call.accept(null,null,n),setTimeout(function(){a.debug("accept with original streamOptions: "+JSON.stringify(r,null,2)+" and extHeaders: "+JSON.stringify(n,null,2)),t.update(r,null,n)},1e3)}else a.debug("decline with code: "+i+" and extHeaders: "+JSON.stringify(n,null,2)),t.call.decline(i,n),t.conversation.remove()},r.sendEndRequest=function(e,t){if(a.info("Begin to end stream",e),e.call){var i=JSON.parse("{}");t&&(i=t),e.conversation.webContext&&(i.web_context=e.conversation.webContext),e.conversation.sidebarId&&(i.sidebar=e.conversation.sidebarId),i.stream_id=e.getId(),i.stream_type=e.getType(),a.debug("end with extHeaders: "+JSON.stringify(i,null,2));var o=e.conversation.getLocalParticipant();o&&(a.debug("Remove stream from local participants: "+e.getId()),o.localRemoveStreamInfo(e.getId())),e.call.end(i),e.conversation.streams.remove(e.getId()),0===e.conversation.streams.size()&&e.conversation.remove()}},r.sendBeginRecording=function(e,t){var i=r.conversationRequest(e),s=[{instruction_name:o.CONVERSATION.BEGIN_RECORD,recording_style:e.recordingStyle}];t?(s[0].participants=[].concat({uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType()}),i.header.stream_id=t.getId(),i.header.stream_type=t.getType()):(t=e.getAudioVideoStream())&&(i.header.stream_id=t.getId(),i.header.stream_type=t.getType()),i.header.instructions=s,a.debug("Sending conversation modify request to begin recording"),e.session.sendMessage(i)},r.sendEndRecording=function(e,t){var i=r.conversationRequest(e),s=[{instruction_name:o.CONVERSATION.END_RECORD}];t?(s[0].participants=[].concat({uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType()}),i.header.stream_id=t.getId(),i.header.stream_type=t.getType()):(t=e.getAudioVideoStream())&&(i.header.stream_id=t.getId(),i.header.stream_type=t.getType()),i.header.instructions=s,a.debug("Sending conversation modify request to end recording"),e.session.sendMessage(i)},r.sendAddParticipant=function(e,t){var i=r.conversationRequest(e),s=[{instruction_name:o.CONVERSATION.ADD_STREAM,participants:t.asJSONArray()}];t.isRecording()&&s.push({instruction_name:o.CONVERSATION.BEGIN_RECORD,recording_style:e.recordingStyle,participants:[{uri:t.getUri()}]}),i.header.instructions=s;var n=e.getAudioVideoStream();n&&(i.header.stream_id=n.getId(),i.header.stream_type=n.getType()),a.debug("Sending conversation modify request to add participant"),e.session.sendMessage(i),e.onParticipantChange&&(a.debug("Invoking onParticipantChange callback for change: "+o.CONVERSATIONSTATE.STREAM_ADDED),e.onParticipantChange(e,o.CONVERSATIONSTATE.STREAM_ADDED,t))},r.sendRemoveParticipant=function(e,t,i){var s=r.conversationRequest(e),n=[{instruction_name:o.CONVERSATION.REMOVE_STREAM}];i?(n[0].participants=[].concat({uri:i.getParticipant().getUri(),stream_id:i.getId(),stream_type:i.getType()}),s.header.stream_id=i.getId(),s.header.stream_type=i.getType()):(n[0].participants=t.asJSONArray(),(i=e.getAudioVideoStream())&&(s.header.stream_id=i.getId(),s.header.stream_type=i.getType())),s.header.instructions=n,a.debug("Sending conversation modify request to remove participant"),e.session.sendMessage(s)},r.sendRemoveAllParticipants=function(e){for(var t=r.conversationRequest(e),i=e.getParticipants(),s=[],n=0;n<i.length;n++)e.getLocalParticipantUri()!==i[n].getUri()&&Array.prototype.push.apply(s,i[n].asJSONArray());t.header.instructions=[{instruction_name:o.CONVERSATION.REMOVE_STREAM,participants:s},{instruction_name:o.CONVERSATION.END_RECORD}];var l=e.getAudioVideoStream();l&&(t.header.stream_id=l.getId(),t.header.stream_type=l.getType()),a.debug("Sending conversation modify request to remove all participants"),e.session.sendMessage(t)},r.sendProfileUpdate=function(e,t){var i=r.conversationRequest(e),s=[{instruction_name:o.CONVERSATION.UPDATE_PROFILE}];s[0].participants=[].concat({uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType(),stream_profile:t.getStreamProfile()}),i.header.stream_id=t.getId(),i.header.stream_type=t.getType(),i.header.stream_profile=t.getStreamProfile(),i.header.instructions=s,a.debug("Sending conversation modify request to update profile"),e.session.sendMessage(i)},r.sendConversationEnquiry=function(e){var t=r.conversationRequest(e);t.header.action=o.ACTION.ENQUIRY,t.header.enquiry_data={},e.pendingTargetURI&&(t.header.enquiry_data.target=e.pendingTargetURI),e.conversationChannel&&(t.header.enquiry_data.channel=e.conversationChannel),e.webContext?t.header.enquiry_data.web_context=e.webContext:t.header.enquiry_data.web_context={},e.clientId&&(t.header.enquiry_data.web_context.clientId=e.clientId),e.clientVersion&&(t.header.enquiry_data.web_context.clientVersion=e.clientVersion),t.header.web_context=t.header.enquiry_data.web_context;var i=e.getAudioVideoStream();i&&(t.header.stream_id=i.getId(),t.header.stream_type=i.getType()),a.debug("Sending conversation enquiry request"),e.session.sendMessage(t)},r.buildRelayMsg=function(e,t,i,s){a.debug("Building relay message for: "+JSON.stringify(t,null,2));var n,l=r.conversationRequest(e);if(l.control.type=o.TYPE.MESSAGE,l.header.action=o.ACTION.RELAY,"string"==typeof t)n="*"===t?"*":[{uri:t}];else{n=[];for(var c,d=[].concat(t),u=null,h=0;h<d.length;h++)d[h]&&(c=d[h].getParticipant(),s&&(u=c.getStreamInfos().find(s)),u||(u=c.getStreamInfos()[0]),n.push({uri:c.getUri(),stream_id:u.getId(),stream_type:u.getType()}))}var g=e.getLocalParticipant(),m=null;return i&&(m=g.getStreamInfos().find(i)),m||(m=g.getStreamInfos()[0]),a.debug("Building relay message with fromStream id : "+m.getId()),l.header.relay={from:g.getUri(),messages:[{participants:n}]},l.header.stream_id=m.getId(),l.header.stream_type=m.getType(),l},r.determineRelayDestinations=function(e,t,i){var o,s=[];if(i&&a.debug("Excluding relay destination: "+i),"string"==typeof t)if("*"===t){var n=e.getParticipants();for(o=0;o<n.length;o++){var r=n[o].getUri();e.getLocalParticipantUri()===r||i&&i===r||(a.debug("- relay destination: "+r),s.push({uri:r}))}}else s=[{uri:t}];else{s=[];var l=[].concat(t);for(o=0;o<l.length;o++)l[o]&&s.push({uri:l[o].participant.uri,stream_id:l[o].id,stream_type:l[o].type})}return s},r.buildReliableRelayMsg=function(e,t){var i=e.getMessageType(),s=e.getRelay(),n=e.getId(),l=e.isFinalMessage(),c=s.getDestination();a.debug("Building reliable relay "+i+" with: msgId="+n+" and relayId="+s.getId());var d=r.buildRelayMsg(s.getConversation(),c,e.getOrigStreamOptionsCallback(),e.getDestStreamOptionsCallback());return d.control.type=i,d.header.action=o.ACTION.RELIABLE_RELAY,i===o.TYPE.MESSAGE&&(d.header.action=o.ACTION.RELAY),d.header.relay.msgId=n,d.header.relay.relayId=s.getId(),t&&e.message&&(a.debug("Resending original message with correlation_id: "+e.message.control.correlation_id),d.control.sequence=e.message.control.sequence,d.control.correlation_id=e.message.control.correlation_id),i===o.TYPE.RESPONSE&&(a.debug("  as "+(l?"final":"subsequent")+" response"),d.control.message_state=l?o.MESSAGESTATE.FINAL:o.MESSAGESTATE.SUBSEQUENT),i===o.TYPE.ERROR&&(d.header.error_code=406),e.text&&(d.header.relay.messages[0].text=e.text),e.data&&(d.header.relay.messages[0].data=e.data),e.commands&&(d.header.relay.messages[0].commands=e.commands,i===o.TYPE.ERROR&&(d.header.reason=e.commands[0].arguments[0].reason)),d},r.sendStreamOptions=function(e,t,i,s,n){var r=e.getRelayForStream(t);null===r?r=e.createRelay(t.getId(),t):a.debug("Found relay with id: "+r.getId()),r.createCommand(o.CONVERSATION.STREAM_OPTIONS,[i.asJSON()]).withCallbacks(s,n).send()},r.sendPauseResume=function(e,t,i,s,n){var r=e.getSpecificRelayForStream(t);null===r?r=e.createRelay(t.getId(),t):a.debug("Found relay with id: "+r.getId()),r.createCommand(o.CONVERSATION.PAUSE_RESUME_STREAM,[i]).withCallbacks(s,n).send()},r.sendCancelRequest=function(e,t,i,s,n){var r=e.getRelayForStream(t);null===r?console.warn("No previous command for stream",t):(a.debug("Found relay with id: "+r.getId()),r.createCommand(o.CONVERSATION.CANCEL,[{original_directive:i}]).withCallbacks(s,n).send())},r.sendAddStream=function(e,t,i,s,n,l){var c=t.getStreamInfos()[0],d=t.getUri();a.debug("sendAddStream to participant: "+d+" with type: "+i);var u=e.getRelayForStream(c);null===u?u=e.createRelay(c.getId(),c):a.debug("Found relay with id: "+u.getId());var h={stream_type:i,stream_options:s.asJSON()},g=u.createCommand(o.CONVERSATION.ADD_STREAM,[h]).withCallbacks(n,l);e.isShortCircuit()?(a.debug("Short-circuit conversation - creating sidebar before adding stream"),r.sendCreateSidebar(e),e.pendingAddStreamRelay=g):(a.debug("Sending relay to add stream"),g.send())},r.sendDelayedAddStreamRequest=function(e){a.debug("sendDelayedAddStreamRequest",e.pendingAddStreamRelay),e.pendingAddStreamRelay&&(a.debug("Sending delayed relay to add stream"),e.pendingAddStreamRelay.send(),e.pendingAddStreamRelay=null)},r.sendStreamLayout=function(e,t,i,s){if(s||(s=e.getAudioVideoStream())){var n=r.conversationRequest(e);n.header.instructions=[{instruction_name:o.CONVERSATION.STREAM_LAYOUT,participants:[{uri:t.getParticipant().getUri(),stream_id:t.getId(),stream_type:t.getType(),size:i}]}],s&&(n.header.stream_id=s.getId(),n.header.stream_type=s.getType()),a.debug("Sending conversation modify request to set stream size for "+t.participant.uri),e.session.sendMessage(n)}else a.debug("Failed to set stream size for stream - invalid local AV stream",t)},r.sendCreateSidebar=function(e){var t=e.getAudioVideoStream(),i=r.conversationRequest(e);i.header.instructions=[{instruction_name:o.CONVERSATION.CREATE_SIDEBAR}],i.header.stream_id=t.getId(),i.header.stream_type=t.getType(),a.debug("Sending conversation modify request to create sidebar"),e.session.sendMessage(i)},r.conversationRequest=function(e){var t=new s.Message;return t.control.type=o.TYPE.REQUEST,t.control.subsession_id=e.subSessionId,t.control.package_type=e.pkgInstance.packageType,t.control.ack_sequence=e.session.lastInboundSeq,t.header.initiator=e.session.userName,t.header.action=o.ACTION.MODIFY,e.conversationKey&&(t.header.conversation_key=e.conversationKey),e.conversationTopic&&(t.header.conversation_topic=e.conversationTopic),e.sidebarId&&(t.header.sidebar=e.sidebarId),t},r.getPauseResumeTargets=function(t){var i=t.audioConfig===o.MEDIADIRECTION.NONE,s=t.videoConfig===o.MEDIADIRECTION.NONE;return new e.PauseResume(i?o.PAUSERESUME.PAUSE:o.PAUSERESUME.RESUME,s?o.PAUSERESUME.PAUSE:o.PAUSERESUME.RESUME,o.PAUSERESUMEREASON.PAUSE_RESUME)},r.logEventTimestamp=function(e,t){e.logEventTimestamp(t)},t.ConversationStateMachine=r,e.StreamInfo=g,e.AudioVideoStream=p,e.ScreenShareStream=v,e.Participant=m,e.Conversation=d,e.ConversationPackage=c,e.Connection=l,e.Relay=S,e.RelayMessage=_,e.QualityMonitor=C,e.PauseResume=u,e.StreamRequest=f,e.StreamProfile=h,console.log("conversation initialized."),console.info("LX-WSC-Conversation-API: 20221118-1630"),e}(live||{});define("oracle.live.sdk",function(){}),define("LiveSessionStore",[],function(){"use strict";const e="OracleLive_SessionState_";return new class{constructor(){this.stateMap=new Map,window.addEventListener("beforeunload",()=>{this.saveState()})}initState(e,t){this.stateMap.set(e,t),console.log("LiveSessionStore.initState: "+e)}loadState(t,i,o){console.log("LiveSessionStore.loadState: "+t);const s=sessionStorage.getItem(e+t);s?(console.log("LiveSessionStore.loadState: found key: "+t,s),i(JSON.parse(s))):o&&o()}saveState(){console.log("LiveSessionStore.saveState"),this.stateMap.forEach((t,i)=>{console.log("LiveSessionStore.saveState: "+i),t.toJSON()?sessionStorage.setItem(e+i,t.toJSON()):sessionStorage.removeItem(e+i),"function"==typeof t.beforeUnload&&(console.log("LiveSessionStore.beforeUnload: "+i),t.beforeUnload())})}loadStateCompleted(){console.log("LiveSessionStore.loadStateCompleted"),this.stateMap.forEach((e,t)=>{"function"==typeof e.loadComplete&&(console.log("LiveSessionStore.loadStateCompleted: "+t),e.loadComplete())})}clearState(){console.log("LiveSessionStore.clearState"),this.stateMap.forEach((t,i)=>{console.log("LiveSessionStore.clearState: "+i),sessionStorage.removeItem(e+i)}),this.stateMap.clear()}}}),define("LiveService",["LiveSessionStore"],function(e){"use strict";const t=1200;return class{constructor(t){this._impl=t,this._address="https://live.oraclecloud.com",this._userID="",this._tenantID="",this._authToken=null,this._tokenRefreshInterval=null,this._language=null,this._startCallDirectly=!1,this._kycScanReference="",this._skipRecordingPermissionRequest=!1,this._mutatedSinceConstruction=!1,e.initState("LiveService",this),$(()=>{console.log("LiveService: Loading"),e.loadState("LiveService",e=>{this._mutatedSinceConstruction||(this._address=e.address,this._userID=e.userID,this._tenantID=e.tenantID,this._language=e.language?e.language:null,this._startCallDirectly=e.startCallDirectly,this._skipRecordingPermissionRequest=e.skipRecordingPermissionRequest),console.log("LiveService: Loaded")})})}toJSON(){return JSON.stringify({address:this._address,userID:this._userID,tenantID:this._tenantID,language:this._language,startCallDirectly:this._startCallDirectly,skipRecordingPermissionRequest:this._skipRecordingPermissionRequest})}set language(e){this._mutatedSinceConstruction=!0,this._language=e}get language(){return this._language}set address(e){this._mutatedSinceConstruction=!0,this._address=e}get address(){return this._address}set userID(e){this._mutatedSinceConstruction=!0,this._userID=e}get userID(){return this._userID}set tenantID(e){this._mutatedSinceConstruction=!0,this._tenantID=e}get tenantID(){return this._tenantID}set startCallDirectly(e){this._mutatedSinceConstruction=!0,this._startCallDirectly=e}get startCallDirectly(){return this._startCallDirectly}set kycScanReference(e){this._mutatedSinceConstruction=!0,this._kycScanReference=e}get kycScanReference(){return this._kycScanReference}set skipRecordingPermissionRequest(e){this._mutatedSinceConstruction=!0,this._skipRecordingPermissionRequest=e}get skipRecordingPermissionRequest(){return this._skipRecordingPermissionRequest}set authToken(e){console.log("LiveService::set authToken: ",e),this._authToken=e,this._impl.updateAuthToken(this._authToken)}get authToken(){return this._authToken}authRefresh(e,i){if("function"==typeof i){e<60&&(e=t);const o=e>200?e-120:e;console.log("Will refresh token every "+o+" seconds"),this._tokenRefreshInterval&&(clearInterval(this._tokenRefreshInterval),this._tokenRefreshInterval=null),this._tokenRefreshInterval=setInterval(()=>{console.log("Refreshing auth token..."),i()},1e3*o)}else console.error("Invalid token refresh function")}isValid(){let e=!0;return null!==this._authToken&&""!==this._authToken||(console.error("Live Experience - controller.service invalid: authToken not set"),e=!1),null!==this._userID&&""!==this._userID||(console.error("Live Experience - controller.service invalid: userID not set"),e=!1),null!==this._tenantID&&""!==this._tenantID||(console.error("Live Experience - controller.service invalid: tenantID not set"),e=!1),null!==this._address&&""!==this._address||(console.error("Live Experience - controller.service invalid: address not set"),e=!1),void 0!==this._language&&""!==this._language||(console.error("Live Experience - controller.service invalid: language must be null or set",this._language),e=!1),e}}}),define("LiveContextAttributes",[],function(){"use strict";return class{constructor(e){this._impl=e,this._entries=new Map}set(e,t){this._entries.set(e,t),console.log("ContextAttributes: Setting "+e+" to "+t),this._impl.sendUpdatedContextAttribute(e,t)}get(e){return this._entries.get(e)}removeAll(){console.log("Removing all contextAttributes"),this._entries.clear()}remove(e){console.log("Removing "+e+" from contextAttributes"),this._entries.delete(e)}isValid(){return 0===this._entries.size&&console.error("Live Experience - controller.contextAttributes invalid: No context attributes defined"),this._entries.size>0}toJSON(){let e=Object.create(null);for(let[t,i]of this._entries)e[t]=i;return JSON.stringify(e)}toWebContext(){let e=Object.create(null);for(let[t,i]of this._entries)console.log("Create web context with",t,i),i&&"behaviours"!==t&&"messages"!==t&&(e[t]=i,console.log("Adding key"));return e}populateContext(e,t,i){this.set("browser",t),this.set("browserVersion",""+i),this.set("clientVersion",e);const o=document.URL;console.log("current URL: "+o),this.set("url",o),console.log("populateContext:",this)}}}),define("LiveSettings",["LiveSessionStore"],function(e){"use strict";return class{constructor(){this._startVideoWithFrontCamera=!1,this._startVideoInFullScreen=!1,this._hideEndCallButton=!1,this._hidePauseButton=!1,this._hideQueueLengthIndicator=!1,this._mutatedSinceConstruction=!1,this._attemptFaceMatchWhenVerifyingIdentity=!1,e.initState("LiveSettings",this),$(()=>{console.log("LiveSettings: Loading"),e.loadState("LiveSettings",e=>{this._mutatedSinceConstruction||(this._startVideoWithFrontCamera=e.startVideoWithFrontCamera,this._startVideoInFullScreen=e.startVideoInFullScreen,this._hideEndCallButton=e.hideEndCallButton,this._hidePauseButton=e.hidePauseButton,this._hideQueueLengthIndicator=e.hideQueueLengthIndicator,this._attemptFaceMatchWhenVerifyingIdentity=e.attemptFaceMatchWhenVerifyingIdentity)})})}toJSON(){return JSON.stringify({startVideoWithFrontCamera:this._startVideoWithFrontCamera,startVideoInFullScreen:this._startVideoInFullScreen,hideEndCallButton:this._hideEndCallButton,hidePauseButton:this._hidePauseButton,hideQueueLengthIndicator:this._hideQueueLengthIndicator,attemptFaceMatchWhenVerifyingIdentity:this.attemptFaceMatchWhenVerifyingIdentity})}reset(){this._startVideoWithFrontCamera=!1,this._startVideoInFullScreen=!1,this._hideEndCallButton=!1,this._hidePauseButton=!1,this._hideQueueLengthIndicator=!1,this._mutatedSinceConstruction=!1,this._attemptFaceMatchWhenVerifyingIdentity=!1}get startVideoWithFrontCamera(){return this._startVideoWithFrontCamera}set startVideoWithFrontCamera(e){this._mutatedSinceConstruction=!0,this._startVideoWithFrontCamera=e}get startVideoInFullScreen(){return this._startVideoInFullScreen}set startVideoInFullScreen(e){this._mutatedSinceConstruction=!0,this._startVideoInFullScreen=e}get hideEndCallButton(){return this._hideEndCallButton}set hideEndCallButton(e){this._mutatedSinceConstruction=!0,this._hideEndCallButton=e}get hidePauseButton(){return this._hidePauseButton}set hidePauseButton(e){this._mutatedSinceConstruction=!0,this._hidePauseButton=e}get hideQueueLengthIndicator(){return this._hideQueueLengthIndicator}set hideQueueLengthIndicator(e){this._mutatedSinceConstruction=!0,this._hideQueueLengthIndicator=e}get attemptFaceMatchWhenVerifyingIdentity(){return this._attemptFaceMatchWhenVerifyingIdentity}set attemptFaceMatchWhenVerifyingIdentity(e){this._mutatedSinceConstruction=!0,this._attemptFaceMatchWhenVerifyingIdentity=e}}}),define("LiveApiVersion",[],function(){"use strict";return class{constructor(){this.TEST_VERSION="99.12",this.LATEST_KNOWN_RELEASE="19.11",this.COMMIT_BRANCH="release/21.10.1",this.COMMIT_HASH="cc3030a6bf42f6d1de19c27fe0cf372d76b4fbd0",this.BUILD_TAG="21.10.1",this.appVersion=null}get version(){if(!this.appVersion){console.log("build info: "+this.buildInfo);const e=this.buildTag,t=e.lastIndexOf("/");this.appVersion=t>-1?e.substring(t+1):e,console.log("appVersion="+this.appVersion)}return this.appVersion&&"UNKNOWN_BRANCH"!==this.appVersion||(this.appVersion=this.LATEST_KNOWN_RELEASE),this.appVersion}get commitBranch(){return this.COMMIT_BRANCH}get commitHash(){return this.COMMIT_HASH}get buildTag(){let e=this.BUILD_TAG;return"unknown"!==e&&-1===e.indexOf("BUILD_TAG")||"unknown"!==(e=this.COMMIT_BRANCH)&&-1===e.indexOf("COMMIT_BRANCH")||(e=this.TEST_VERSION),e}get buildInfo(){const e=this.buildTag,t=""!==e?" @ "+e:"";return this.commitHash+" : "+this.commitBranch+t}}}),define("LiveEvents",[],function(){"use strict";const e={LiveConnecting:"LiveConnecting",LiveCanceled:"LiveCanceled",LiveConnected:"LiveConnected",LiveStreamError:"LiveStreamError",LiveEnded:"LiveEnded",LiveLoginSuccess:"LiveLoginSuccess",LiveLoginError:"LiveLoginError",LiveStartCall:"LiveStartCall",LiveStateReloaded:"LiveStateReloaded",LiveWaiting:"LiveWaiting",LiveConnectingNoAnswer:"LiveConnectingNoAnswer",LiveConnectingError:"LiveConnectingError",LiveConnectingTeamBusy:"LiveConnectingTeamBusy",LivePausedLocally:"LivePausedLocally",LiveResumedLocally:"LiveResumedLocally",LiveRatingRequired:"LiveRatingRequired",LiveRatingCompleted:"LiveRatingCompleted",LiveParticipantLeft:"LiveParticipantLeft",LiveStreamActive:"LiveStreamActive",LiveReconnectingRemote:"LiveReconnectingRemote",LiveReconnectedRemote:"LiveReconnectedRemote",LiveRecordingStarted:"LiveRecordingStarted",LiveRecordingStopped:"LiveRecordingStopped",LivePausedRemotely:"LivePausedRemotely",LiveResumedRemotely:"LiveResumedRemotely",LiveReconnectingLocal:"LiveReconnectingLocal",LiveReconnectedLocal:"LiveReconnectedLocal",LiveStartVideoRequested:"LiveStartVideoRequested",LiveStartVideoRequestCancelled:"LiveStartVideoRequestCancelled",LiveStartScreenShareRequested:"LiveStartScreenShareRequested",LiveStartScreenShareRequestCancelled:"LiveStartScreenShareRequestCancelled",LiveScreenSharePluginRequired:"LiveScreenSharePluginRequired",LiveScreenSharePluginInstalling:"LiveScreenSharePluginInstalling",LiveScreenSharePluginInstalled:"LiveScreenSharePluginInstalled",LiveSystemScreenShareDialogShowing:"LiveSystemScreenShareDialogShowing",LiveSystemScreenShareDialogRemoved:"LiveSystemScreenShareDialogRemoved",LiveRemoteVideoStarted:"LiveRemoteVideoStarted",LiveRemoteVideoStopped:"LiveRemoteVideoStopped",LiveRemoteVideoRemoved:"LiveRemoteVideoRemoved",LiveRemoteVideoLoading:"LiveRemoteVideoLoading",LiveRemoteVideoLoaded:"LiveRemoteVideoLoaded",LiveLocalVideoStarted:"LiveLocalVideoStarted",LiveLocalVideoStopped:"LiveLocalVideoStopped",LiveNetworkPoor:"LiveNetworkPoor",LiveNetworkNormal:"LiveNetworkNormal",LiveRemoteScreenShareRequested:"LiveRemoteScreenShareRequested",LiveRemoteScreenShareCancelled:"LiveRemoteScreenShareCancelled",LiveLocalScreenStarted:"LiveLocalScreenStarted",LiveLocalScreenStopped:"LiveLocalScreenStopped",LiveRemoteScreenStarted:"LiveRemoteScreenStarted",LiveRemoteScreenStopped:"LiveRemoteScreenStopped",LiveRemoteScreenActive:"LiveRemoteScreenActive",LiveDiagnosticsAudioVideoStarted:"LiveDiagnosticsAudioVideoStarted",LiveDiagnosticsAudioStarted:"LiveDiagnosticsAudioStarted",LiveDiagnosticsComplete:"LiveDiagnosticsComplete",LiveDiagnosticsFailed:"LiveDiagnosticsFailed",LiveScreenShareAnnotationStarted:"LiveScreenShareAnnotationStarted",LiveScreenShareAnnotationStopped:"LiveScreenShareAnnotationStopped",LiveAssociateAnnotationStarted:"LiveAssociateAnnotationStarted",LiveAssociateAnnotationStopped:"LiveAssociateAnnotationStopped",LiveAssociateAnnotationReceived:"LiveAssociateAnnotationReceived",LiveAssociateVideoAnnotationStarted:"LiveAssociateVideoAnnotationStarted",LiveAssociateVideoAnnotationStopped:"LiveAssociateVideoAnnotationStopped",LiveAssociateFreezeCustomerStream:"LiveAssociateFreezeCustomerStream",LiveAssociateUnfreezeCustomerStream:"LiveAssociateUnfreezeCustomerStream",LiveAssociateVideoAnnotationReceived:"LiveAssociateVideoAnnotationReceived",LiveMessageEmitted:"LiveMessageEmitted",LivePreCallIDCheckStarted:"LivePreCallIDCheckStarted",LivePreCallIDCheckError:"LivePreCallIDCheckError",LivePreCallIDCheckNone:"LivePreCallIDCheckNone",LivePreCallIDCheckVerifyIdentity:"LivePreCallIDCheckVerifyIdentity",LivePreCallIDCheckComplete:"LivePreCallIDCheckComplete",LivePreCallIDCheckFailed:"LivePreCallIDCheckFailed",LivePreCallIDCheckCancelled:"LivePreCallIDCheckCancelled",LivePreCallIDCheckIncomplete:"LivePreCallIDCheckIncomplete",LiveStartVerificationCall:"LiveStartVerificationCall",LiveProgressIndicator:"LiveProgressIndicator",LiveCallQueuePositionUpdate:"LiveCallQueuePositionUpdate",LiveAssociateTransferStarted:"LiveAssociateTransferStarted",LiveAssociateTransferStartStream:"LiveAssociateTransferStartStream",LiveAssociateTransferCompleted:"LiveAssociateTransferCompleted",LiveAssociateTransferFailed:"LiveAssociateTransferFailed",LiveAssociateTransferStopped:"LiveAssociateTransferStopped",LiveAssociateAddParticipantStarted:"LiveAssociateAddParticipantStarted",LiveAssociateAddParticipantStartStream:"LiveAssociateAddParticipantStartStream",LiveAssociateAddParticipantCompleted:"LiveAssociateAddParticipantCompleted",LiveAssociateAddParticipantFailed:"LiveAssociateAddParticipantFailed",LiveAssociateAddParticipantStopped:"LiveAssociateAddParticipantStopped",LiveCallbackPromptUser:"LiveCallbackPromptUser",LiveCallbackRegister:"LiveCallbackRegister",LiveCallbackRegisterSuccess:"LiveCallbackRegisterSuccess",LiveCallbackRegisterFailure:"LiveCallbackRegisterFailure",LiveCobrowseStarted:"LiveCobrowseStarted",LiveCobrowseEnded:"LiveCobrowseEnded",LiveCobrowseRequest:"LiveCobrowseRequest",LiveCobrowseStart:"LiveCobrowseStart",LiveCobrowseRequestDialogShowing:"isCobrowseRequestDialogShowing"};return Object.freeze(e),e}),define("LiveExposedEvents",["LiveEvents"],function(e){"use strict";return[e.LiveConnecting,e.LiveConnected,e.LiveCanceled,e.LiveEnded,e.LiveLoginSuccess,e.LiveStreamError,e.LivePreCallIDCheckComplete,e.LivePreCallIDCheckIncomplete,e.LivePreCallIDCheckCancelled,e.LivePreCallIDCheckFailed,e.LiveProgressIndicator]}),define("text",["module"],function(e){"use strict";var t,i,o,s,n,a=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],r=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,l=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,c="undefined"!=typeof location&&location.href,d=c&&location.protocol&&location.protocol.replace(/\:/,""),u=c&&location.hostname,h=c&&(location.port||void 0),g={},m=e.config&&e.config()||{};function p(e,t){return void 0===e||""===e?t:e}return t={version:"2.0.15",strip:function(e){if(e){var t=(e=e.replace(r,"")).match(l);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:m.createXhr||function(){var e,t,i;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(t=0;t<3;t+=1){i=a[t];try{e=new ActiveXObject(i)}catch(e){}if(e){a=[i];break}}return e},parseName:function(e){var t,i,o,s=!1,n=e.lastIndexOf("."),a=0===e.indexOf("./")||0===e.indexOf("../");return-1!==n&&(!a||n>1)?(t=e.substring(0,n),i=e.substring(n+1)):t=e,-1!==(n=(o=i||t).indexOf("!"))&&(s="strip"===o.substring(n+1),o=o.substring(0,n),i?i=o:t=o),{moduleName:t,ext:i,strip:s}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,i,o,s){var n,a,r,l=t.xdRegExp.exec(e);return!l||(n=l[2],r=(a=(a=l[3]).split(":"))[1],a=a[0],(!n||n===i)&&(!a||a.toLowerCase()===o.toLowerCase())&&(!r&&!a||function(e,t,i,o){if(t===o)return!0;if(e===i){if("http"===e)return p(t,"80")===p(o,"80");if("https"===e)return p(t,"443")===p(o,"443")}return!1}(n,r,i,s)))},finishLoad:function(e,i,o,s){o=i?t.strip(o):o,m.isBuild&&(g[e]=o),s(o)},load:function(e,i,o,s){if(s&&s.isBuild&&!s.inlineText)o();else{m.isBuild=s&&s.isBuild;var n=t.parseName(e),a=n.moduleName+(n.ext?"."+n.ext:""),r=i.toUrl(a),l=m.useXhr||t.useXhr;0!==r.indexOf("empty:")?!c||l(r,d,u,h)?t.get(r,function(i){t.finishLoad(e,n.strip,i,o)},function(e){o.error&&o.error(e)}):i([a],function(e){t.finishLoad(n.moduleName+"."+n.ext,n.strip,e,o)}):o()}},write:function(e,i,o,s){if(g.hasOwnProperty(i)){var n=t.jsEscape(g[i]);o.asModule(e+"!"+i,"define(function () { return '"+n+"';});\n")}},writeFile:function(e,i,o,s,n){var a=t.parseName(i),r=a.ext?"."+a.ext:"",l=a.moduleName+r,c=o.toUrl(a.moduleName+r)+".js";t.load(l,o,function(i){var o=function(e){return s(c,e)};o.asModule=function(e,t){return s.asModule(e,c,t)},t.write(e,l,o,n)},n)}},"node"===m.env||!m.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(i=require.nodeRequire("fs"),t.get=function(e,t,o){try{var s=i.readFileSync(e,"utf8");"\ufeff"===s[0]&&(s=s.substring(1)),t(s)}catch(e){o&&o(e)}}):"xhr"===m.env||!m.env&&t.createXhr()?t.get=function(e,i,o,s){var n,a=t.createXhr();if(a.open("GET",e,!0),s)for(n in s)s.hasOwnProperty(n)&&a.setRequestHeader(n.toLowerCase(),s[n]);m.onXhr&&m.onXhr(a,e),a.onreadystatechange=function(t){var s,n;4===a.readyState&&((s=a.status||0)>399&&s<600?((n=new Error(e+" HTTP status: "+s)).xhr=a,o&&o(n)):i(a.responseText),m.onXhrComplete&&m.onXhrComplete(a,e))},a.send(null)}:"rhino"===m.env||!m.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?t.get=function(e,t){var i,o,s=new java.io.File(e),n=java.lang.System.getProperty("line.separator"),a=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(s),"utf-8")),r="";try{for(i=new java.lang.StringBuffer,(o=a.readLine())&&o.length()&&65279===o.charAt(0)&&(o=o.substring(1)),null!==o&&i.append(o);null!==(o=a.readLine());)i.append(n),i.append(o);r=String(i.toString())}finally{a.close()}t(r)}:("xpconnect"===m.env||!m.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(o=Components.classes,s=Components.interfaces,Components.utils.import("resource://gre/modules/FileUtils.jsm"),n="@mozilla.org/windows-registry-key;1"in o,t.get=function(e,t){var i,a,r,l={};n&&(e=e.replace(/\//g,"\\")),r=new FileUtils.File(e);try{(i=o["@mozilla.org/network/file-input-stream;1"].createInstance(s.nsIFileInputStream)).init(r,1,0,!1),(a=o["@mozilla.org/intl/converter-input-stream;1"].createInstance(s.nsIConverterInputStream)).init(i,"utf-8",i.available(),s.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),a.readString(i.available(),l),a.close(),i.close(),t(l.value)}catch(e){throw new Error((r&&r.path||"")+": "+e)}}),t}),define("text!oracle.live.button.html",[],function(){return'\x3c!--\n  ~ Copyright (c) 2018 Oracle. All rights reserved.\n  ~\n  ~ This material is the confidential property of Oracle Corporation or its\n  ~ licensors and may be used, reproduced, stored or transmitted only in\n  ~ accordance with a valid Oracle license or sublicense agreement.\n--\x3e\n\n<div id="oracle-live" class="oracle-live">\n  <div class="oracle-live-menu">\n    <div class="oracle-live-menu-leftspacer" role="presentation"></div>\n    <div class="oracle-live-ellipses-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-cobrowse-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-spinner"></div>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-screenshare-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-spinner"></div>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-video-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-annotate-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-pause-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-mute-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-exit-button" role="button" tabindex=0>\n      <div class="oracle-live-exitbutton-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-menu-rightspacer" role="presentation"></div>\n  </div>\n  <div class="oracle-live-menu-more">\n    <div class="oracle-live-cobrowse-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-spinner"></div>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-screenshare-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-spinner"></div>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-video-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n    <div class="oracle-live-annotate-button oracle-live-buttonbar-button" role="button" tabindex=0>\n      <div class="oracle-live-buttonbar-icon" role="presentation"></div>\n    </div>\n  </div>\n  <div class="oracle-live-top-notifications">\n    <div class="oracle-live-top-notify-screenshare">\n      <div class="oracle-live-top-notify-button oracle-live-top-notify-stop-screenshare-button" role="button">\n        <div class="oracle-live-top-notify-stop-screenshare-icon" role="presentation"></div>\n      </div>\n      <div class="oracle-live-top-notify-stop-screenshare-message">\n      </div>\n    </div>\n    <div class="oracle-live-top-notify-cobrowse">\n      <div class="oracle-live-top-notify-button oracle-live-top-notify-stop-cobrowse-button" role="button">\n        <div class="oracle-live-top-notify-stop-cobrowse-icon" role="presentation"></div>\n      </div>\n      <div class="oracle-live-top-notify-stop-cobrowse-message">\n      </div>\n    </div>\n  </div>\n  <div role="application" class="oracle-live-cancel-rejoin-buttons">\n    <div class="oracle-live-cancel-button" role="button" tabindex=0></div>\n    <div class="oracle-live-rejoin-button" role="button" tabindex=0></div>\n  </div>\n  <div class="oracle-live-main-button" role="button" tabindex=0>\n    <div class="oracle-live-mainbutton-spinner"></div>\n    <div class="oracle-live-mainbutton-icon" role="presentation"></div>\n    <div class="oracle-live-mainbutton-initials"></div>\n    <img class="oracle-live-agent-image" src=""/>\n    <div class="oracle-live-mainbutton-overlay" role="presentation"></div>\n    <div class="oracle-live-mainbutton-badge-mute"></div>\n    <div class="oracle-live-mainbutton-badge"></div>\n  </div>\n  <div class="oracle-live-callinfo">\n    <div class="oracle-live-callinfo-icons">\n      <span class="oracle-live-callinfo-channel-icon"></span>\n      <span name="callInfoPanel" class="oracle-live-callinfo-maximize-icon" role="button" tabindex="0"></span>\n    </div>\n    <div class="oracle-live-callinfo-associate" id="oracle-live-callinfo-associate">\n      <div class="oracle-live-associate"></div>\n    </div>\n    <span class="oracle-live-callinfo-duration">\n      <span role="timer" class="oracle-live-callinfo-timer">00:00</span>\n      <span class="oracle-live-recording oracle-live-callinfo-recording"></span>\n    </span>\n  </div>\n  <div class="oracle-live-call-queue-info" tabindex="0">\n    <label class="oracle-live-position-in-queue-label"></label>\n    <span class="oracle-live-position-in-queue"></span>\n  </div>\n  <div class="oracle-live-popmessage" role="status">\n    <div role="alert" class="oracle-live-popmessage-text"></div>\n    <div class="oracle-live-popmessage-shortcode">ABCDEF</div>\n  </div>\n  <div role="alert" class="oracle-live-notificationmessage">\n    <span role="presentation"></span>\n    <div class="oracle-live-notification"></div>\n    <div role="button" tabindex=0></div>\n  </div>\n\n  <div class="oracle-live-messaging-container">\n    <div role="alert" class="oracle-live-messaging" tabindex="0">\n      <div class="oracle-live-messaging-header" id="oracle-live-messaging-header"\n           role="note" aria-labelledby="messaging-header-title" aria-live="polite">\n        <p id="messaging-header-title"></p>\n      </div>\n      <div class="oracle-live-messaging-messages" id="oracle-live-messaging-messages">\n      </div>\n      <div role="application" class="oracle-live-dialog-buttons">\n        <div role="button" tabindex=0 class="oracle-live-messaging-close oracle-live-label-ellipsis"></div>\n      </div>\n    </div>\n  </div>\n\n  <div class="oracle-live-dialog-container">\n    <div role="alert" class="oracle-live-dialog">\n      <div class="oracle-live-dialog-message" role="note"></div>\n      <div class="oracle-live-dialog-feedback">\n        <div id="oracle-live-dialog-question" class="oracle-live-dialog-question"></div>\n        <div class="oracle-live-dialog-options" role="radiogroup" aria-labelledby="oracle-live-dialog-question">\n          <div class="oracle-live-dialog-option-poor oracle-live-label-ellipsis"\n               role="radio"\n               aria-checked="false"\n               tabindex=0>\n            <div role="presentation"></div>\n            <label></label>\n          </div>\n          <div class="oracle-live-dialog-option-good oracle-live-label-ellipsis"\n               role="radio"\n               aria-checked="false"\n               tabindex=0>\n            <div role="presentation"></div>\n            <label></label>\n          </div>\n          <div class="oracle-live-dialog-option-excellent oracle-live-label-ellipsis"\n               role="radio"\n               aria-checked="false"\n               tabindex=0>\n            <div role="presentation"></div>\n            <label></label>\n          </div>\n        </div>\n      </div>\n      <div class="oracle-live-dialog-phone-number">\n        <div id="oracle-live-phone-number-fields" class="oracle-live-phone-number-fields">\n\n          <div class="oracle-live-phone-number-country">\n            <div class="phone-number-label-container">\n              <label id="label-phone-number-country" for="phone-number-country"></label>\n            </div>\n            <div>\n              <div id="phone-number-country-input-container" class="phone-number-country-input-container">\n                <input type="text" placeholder="Code"\n                       id="phone-number-country-code" title="Country code" class="oracle-live-phone-number-country-code" />\n                <span class="oracle-live-phone-number-country-code-expand">\n                  <div id="oracle-live-country-list-expand-icon" class="oracle-live-country-list-expand-icon"></div>\n                </span>\n              </div>\n\n              <div class="phone-number-country-list-container">\n                <ul name="country" id="phone-number-country-list" class="phone-number-country-list">\n                </ul>\n              </div>\n            </div>\n          </div>\n          <div class="oracle-live-phone-number-digits">\n            <div class="phone-number-label-container">\n              <label id="label-phone-number-digits" for="phone-number-digits"></label>\n            </div>\n            <div class="phone-number-digits-input-container">\n              <input type="text" name="phoneNumber" id="phone-number-digits" placeholder="Calling Number"/>\n            </div>\n            <div class="phone-number-digits-readonly">\n              <span id="phone-number-digits-readonly"/>\n            </div>\n            <div id="phone-number-digits-error-container" class="phone-number-digits-error-container">\n              <div class="phone-number-error-title">\n                <div class="phone-number-digits-error-icon">\n                  <div class="phone-number-validation-error-icon"></div>\n                </div>\n                <div class="phone-number-digits-error-message">\n                  <div id="phone-number-digits-error-title" class="phone-number-digits-error-title">Error</div>\n                </div>\n              </div>\n              <div class="phone-number-error-action">\n                <div id="phone-number-digits-error-action" class="phone-number-digits-error-action"></div>\n              </div>\n            </div>\n\n          </div>\n\n        </div>\n      </div>\n      <div role="application" class="oracle-live-dialog-buttons">\n        <div role="button" tabindex=0 class="oracle-live-dialog-cancel oracle-live-label-ellipsis"></div>\n        <div role="button" tabindex=0 class="oracle-live-dialog-ok oracle-live-label-ellipsis"></div>\n        <div role="button" tabindex=0 class="oracle-live-dialog-close oracle-live-label-ellipsis"></div>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- audio and video tags --\x3e\n  <div id="oracle-live-audio" class="oracle-live-audio">\n    <audio id="oracle-live-local-audio" class="oracle-live-local-audio" autoplay muted preload="metadata"></audio>\n    <audio id="oracle-live-remote-audio" class="oracle-live-remote-audio" autoplay preload="metadata"></audio>\n    <audio id="connectingAudio" preload="auto">\n      <source src="" type="audio/wav" loop="true">\n    </audio>\n  </div>\n\n  <div class="oracle-live-audio-panel">\n    <div>\n      <div role="heading" class="oracle-live-heading"></div>\n      <div role="timer">00:00</div>\n      <div class="oracle-live-recording">Rec</div>\n    </div>\n    <div class="oracle-live-audio-graphic"></div>\n    <div class="oracle-live-video-pause-graphic"></div>\n    <span class="oracle-live-audio-panel-message"></span>\n    <hr/>\n  </div>\n\n   <div class="oracle-live-video-panel oracle-live-screenshare-panel-enduser">\n      <div class="oracle-live-video-pause-graphic">\n      </div>\n      <video id="oracle-live-local-screenshare" class="oracle-live-local-screenshare"\n             autoplay muted playsinline preload="metadata"></video>\n      <div class=""><span></span></div>\n  </div>\n\n  \x3c!-- This is the maximized callInfo panel --\x3e\n  <div class="oracle-live-video-panel oracle-live-callinfo-panel-maximized">\n    <div class="oracle-live-video-no-connection-graphic">\n    </div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-callinfo-toolbar">\n      <div name="callInfoPanel" class="oracle-live-video-maximize oracle-live-callinfo-toolbar" role="button" tabindex=0></div>\n      <div role="heading" class="oracle-live-video-associate-maximized-title oracle-live-callinfo-toolbar oracle-live-heading"></div>\n      <div class="oracle-live-video-toolbar-info">\n        <span role="img" class="oracle-live-video-panel-channel-icon"></span>\n        <span role="timer" class="oracle-live-video-toolbar-timer oracle-live-callinfo-toolbar">00:00</span>\n        <span class="oracle-live-recording oracle-live-video-toolbar-recording oracle-live-callinfo-toolbar">Rec</span>\n      </div>\n    </div>\n    <div class="oracle-live-video-associate-name"></div>\n    <div class="oracle-live-recording oracle-live-video-inline-recording oracle-live-callinfo-inline">Rec</div>\n    <div class="oracle-live-video-panel-message"></div>\n  </div>\n\n  \x3c!-- This is where you connect the local video (customer camera) --\x3e\n  <div class="oracle-live-video-panel oracle-live-video-panel-enduser">\n   <div class="oracle-live-video-pause-graphic">\n   </div>\n    <div class="oracle-live-call-queue-info">\n      <label class="oracle-live-position-in-queue-label"></label>\n      <span class="oracle-live-position-in-queue"></span>\n    </div>\n    <div class="oracle-live-video-no-connection-graphic">\n    </div>\n    <video id="oracle-live-local-video" class="oracle-live-local-video"\n           autoplay muted playsinline preload="metadata"></video>\n    <div role="presentation"></div>\n    <div role="presentation"></div>\n    <div role="application" class="oracle-live-video-buttons-preview">\n      <button role="button" tabindex=0 class="oracle-live-preview-start-button"></button>\n      <button role="button" tabindex=0 class="oracle-live-preview-cancel-button"></button>\n    </div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-enduser">\n      <div name="endUserVideo" class="oracle-live-video-maximize" role="button" tabindex=0></div>\n      <div role="heading" class="oracle-live-video-end-user-maximized-title oracle-live-heading"></div>\n      <div role="heading" class="oracle-live-video-maximized-group">\n        <div role="status" class="oracle-live-video-group-number">\n          <span class="oracle-live-remote-video-count"></span>\n        </div>\n      </div>\n      <div class="oracle-live-video-toolbar-info">\n        <span role="img" class="oracle-live-video-panel-channel-icon"></span>\n        <span role="timer" class="oracle-live-video-toolbar-timer">00:00</span>\n        <span class="oracle-live-recording oracle-live-video-toolbar-recording">Rec</span>\n      </div>\n      <div role="button" class="oracle-live-swap-camera oracle-live-hide-camera-swap-button" tabindex="0"></div>\n      <div class="oracle-live-video-maximize-camera-backing"></div>\n      <div name="endUserVideo" class="oracle-live-video-maximize-camera" role="button" tabindex=0></div>\n    </div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-enduser-unfreeze">\n      <div tabindex="0" role="main" class="oracle-live-unfreeze-annotation-camera">\n        <div name="unfreezeAnnotationCamera" class="oracle-live-unfreeze-annotation-camera" role="button" style="cursor: default"></div>\n      </div>\n      <div name="unfreezeAnnotationCross" class="oracle-live-unfreeze-annotation-cross" role="button" tabindex=0></div>\n    </div>\n    <div class="oracle-live-video-associate-name"></div>\n    <div class="oracle-live-recording oracle-live-video-inline-recording">Rec</div>\n    <div role="heading" class="oracle-live-heading"></div>\n    <div class="oracle-live-video-panel-message"></div>\n    <canvas class="oracle-live-annotation-video-canvas"></canvas>\n  </div>\n\n  \x3c!-- This is where you connect the remote video (associate camera) --\x3e\n  <div class="oracle-live-video-panel oracle-live-video-panel-associate oracle-live-video-grid-single">\n    <div class="oracle-live-video-pause-graphic">\n    </div>\n    <div class="oracle-live-video-no-connection-graphic">\n    </div>\n    <div id="oracle-live-remote-videos" class="oracle-live-remote-videos">\n    </div>\n    <div role="button" class="oracle-live-video-left"></div>\n    <div role="button" class="oracle-live-video-right"></div>\n    <div role="presentation"></div>\n    <div role="presentation"></div>\n    <div role="toolbar" class="oracle-live-video-toolbar oracle-live-video-toolbar-associate">\n      <div name="associateVideo" class="oracle-live-video-maximize oracle-live-video-toolbar-associate" role="button" tabindex=0></div>\n      <div role="heading" class="oracle-live-video-maximized-label oracle-live-video-toolbar-associate">\n        <div class="current-associate oracle-live-heading"></div>\n        <div role="status" class="oracle-live-video-group-number">\n          <span class="oracle-live-remote-video-count"></span>\n        </div>\n      </div>\n      <div role="heading" class="oracle-live-video-maximized-group oracle-live-video-toolbar-associate">\n        <div role="status" class="oracle-live-video-group-number">\n          <span class="oracle-live-remote-video-count"></span>\n        </div>\n      </div>\n      <div class="oracle-live-video-toolbar-info">\n        <span role="img" class="oracle-live-video-panel-channel-icon"></span>\n        <span role="timer" class="oracle-live-video-toolbar-timer oracle-live-video-toolbar-associate">00:00</span>\n        <span class="oracle-live-recording oracle-live-video-toolbar-recording oracle-live-video-toolbar-associate">Rec</span>\n      </div>\n      <div role="button" class="oracle-live-video-maximized-display-grid oracle-live-video-toolbar-associate">\n        <div class="oracle-live-video-maximized-display-grid-icon"></div>\n        <div class="oracle-live-video-maximized-display-grid-icon-backing"></div>\n      </div>\n      <div name="associateVideo" class="oracle-live-video-maximize-camera" role="button" tabindex="0"></div>\n      <div role="button" class="oracle-live-swap-camera oracle-live-hide-camera-swap-button" tabindex="0"></div>\n    </div>\n    <div class="oracle-live-video-associate-name"></div>\n    <div class="oracle-live-recording oracle-live-video-inline-recording oracle-live-video-inline-associate">Rec</div>\n    <div class="oracle-live-video-panel-message"></div>\n    <div role="progressbar" class="oracle-live-video-loading-spinner"></div>\n  </div>\n\n  <canvas class="oracle-live-annotation-canvas"></canvas>\n  <canvas id="screen-share-arriving" class="oracle-live-screen-share-canvas"></canvas>\n\n  \x3c!-- This is where we show the Jumio ID Verification screens in an iframe. --\x3e\n  <div class="oracle-live-know-your-customer">\n    <iframe id="kyc-iframe" class="kyc-jumio-iframe"\n      src=""\n      allow="camera">\n    </iframe>\n  </div>\n\n  \x3c!-- This is where we display the preCallIDCheck verifying screens. --\x3e\n  <div class="oracle-live-verification-panel oracle-live-verification-verified">\n    <div role="toolbar">\n      <div name="kyc-verifying" class="oracle-live-verification-close" role="button" tabindex="0" title="Close"></div>\n    </div>\n    <div class="oracle-live-verification-container">\n      <div class="oracle-live-verification-image oracle-live-verification-almost-done-image"></div>\n      <div class="oracle-live-verification-heading oracle-live-heading" role="heading">Almost Done</div>\n      <div class="oracle-live-verification-message" role="alert">\n        We just need to have a quick video call with you to complete the verification process.\n      </div>\n      <div class="oracle-live-verification-continue-button" role="button"\n           title="Continue" aria-disabled="false">Continue</div>\n    </div>\n  </div>\n\n\n</div>\n'}),define("LiveCallTimer",["LiveSessionStore"],function(e){"use strict";class t{constructor(){this._timer=null,this._restartTimer=!1,this._now=0,this._startTime=0,e.initState("LiveCallTimer",this),$(()=>{console.log("LiveCallTimer: Loading"),e.loadState("LiveCallTimer",e=>{if(this._startTime=e.startTime,e.timer){this._restartTimer=!0,this._now=this.getTimeNow();const e=t.formatDuration(this._startTime,this._now);$(".oracle-live [role='timer']").each(function(){$(this).text(e),$(this).attr("aria-label",e)})}console.log("LiveCallTimer: Loaded, startTime="+this._startTime)})})}toJSON(){return JSON.stringify({startTime:this._startTime,timer:this._timer})}loadComplete(){console.log("LiveCallTimer: Load complete, restartTimer="+this._restartTimer),this._restartTimer&&this.resumeTimer()}static formatDuration(e,t){let i=Math.floor(t-e);const o=Math.floor(i/3600);i=Math.floor(i-3600*o);const s=Math.floor(i/60),n=Math.floor(i-60*s),a=(e,t,i)=>(new Array(i+1).join(t)+e).slice(-i);return(o>0?a(o,"",2)+":":"")+(s>0?a(s,"0",2):"00")+":"+a(n,"0",2)}startTimer(){this._timer&&this.stopTimer(),this._startTime=this.getTimeNow(),this.resumeTimer()}resumeTimer(){this._timer=setInterval(()=>{this._now=this.getTimeNow();const e=t.formatDuration(this._startTime,this._now);$(".oracle-live [role='timer']").each(function(){$(this).text(e),$(this).attr("aria-label",e)})},1e3),console.log("Started timer... startTime="+this._startTime,this._timer)}stopTimer(){console.log("Stopping timer...",this._timer),this._timer&&(clearInterval(this._timer),this._timer=null)}resetTimer(){console.log("Resetting timer"),$(".oracle-live [role='timer']").each(function(){$(this).text("00:00"),$(this).attr("aria-label","00:00")}),this._startTime=0,this.stopTimer()}getTimeNow(){return Math.floor(Date.now()/1e3)}}return t}),define("LiveCountryCodes",[],function(){"use strict";const e={CountryCodes:[["213","application_universal_country_Algeria"],["376","application_universal_country_Andorra"],["244","application_universal_country_Angola"],["1264","application_universal_country_Anguilla"],["1268","application_universal_country_AntiguaBarbuda"],["54","application_universal_country_Argentina"],["374","application_universal_country_Armenia"],["297","application_universal_country_Aruba"],["61","application_universal_country_Australia"],["43","application_universal_country_Austria"],["994","application_universal_country_Azerbaijan"],["1242","application_universal_country_Bahamas"],["973","application_universal_country_Bahrain"],["880","application_universal_country_Bangladesh"],["1246","application_universal_country_Barbados"],["375","application_universal_country_Belarus"],["32","application_universal_country_Belgium"],["501","application_universal_country_Belize"],["229","application_universal_country_Benin"],["1441","application_universal_country_Bermuda"],["975","application_universal_country_Bhutan"],["591","application_universal_country_Bolivia"],["387","application_universal_country_BosniaHerzegovina"],["267","application_universal_country_Botswana"],["55","application_universal_country_Brazil"],["673","application_universal_country_Brunei"],["359","application_universal_country_Bulgaria"],["226","application_universal_country_BurkinaFaso"],["257","application_universal_country_Burundi"],["855","application_universal_country_Cambodia"],["237","application_universal_country_Cameroon"],["1","application_universal_country_Canada"],["238","application_universal_country_CapeVerdeIslands"],["1345","application_universal_country_CaymanIslands"],["236","application_universal_country_CentralAfricanRepublic"],["56","application_universal_country_Chile"],["86","application_universal_country_China"],["57","application_universal_country_Colombia"],["269","application_universal_country_Comoros"],["242","application_universal_country_Congo"],["682","application_universal_country_CookIslands"],["506","application_universal_country_CostaRica"],["385","application_universal_country_Croatia"],["53","application_universal_country_Cuba"],["90","application_universal_country_CyprusNorth"],["357","application_universal_country_CyprusSouth"],["420","application_universal_country_CzechRepublic"],["45","application_universal_country_Denmark"],["253","application_universal_country_Djibouti"],["1809","application_universal_country_Dominica"],["1809","application_universal_country_DominicanRepublic"],["593","application_universal_country_Ecuador"],["20","application_universal_country_Egypt"],["503","application_universal_country_ElSalvador"],["240","application_universal_country_EquatorialGuinea"],["291","application_universal_country_Eritrea"],["372","application_universal_country_Estonia"],["251","application_universal_country_Ethiopia"],["500","application_universal_country_FalklandIslands"],["298","application_universal_country_FaroeIslands"],["679","application_universal_country_Fiji"],["358","application_universal_country_Finland"],["33","application_universal_country_France"],["594","application_universal_country_FrenchGuiana"],["689","application_universal_country_FrenchPolynesia"],["241","application_universal_country_Gabon"],["220","application_universal_country_Gambia"],["7880","application_universal_country_Georgia"],["49","application_universal_country_Germany"],["233","application_universal_country_Ghana"],["350","application_universal_country_Gibraltar"],["30","application_universal_country_Greece"],["299","application_universal_country_Greenland"],["1473","application_universal_country_Grenada"],["590","application_universal_country_Guadeloupe"],["671","application_universal_country_Guam"],["502","application_universal_country_Guatemala"],["224","application_universal_country_Guinea"],["245","application_universal_country_GuineaBissau"],["592","application_universal_country_Guyana"],["509","application_universal_country_Haiti"],["504","application_universal_country_Honduras"],["852","application_universal_country_HongKong"],["36","application_universal_country_Hungary"],["354","application_universal_country_Iceland"],["91","application_universal_country_India"],["62","application_universal_country_Indonesia"],["964","application_universal_country_Iraq"],["98","application_universal_country_Iran"],["353","application_universal_country_Ireland"],["972","application_universal_country_Israel"],["39","application_universal_country_Italy"],["1876","application_universal_country_Jamaica"],["81","application_universal_country_Japan"],["962","application_universal_country_Jordan"],["7","application_universal_country_Kazakhstan"],["254","application_universal_country_Kenya"],["686","application_universal_country_Kiribati"],["850","application_universal_country_KoreaNorth"],["82","application_universal_country_KoreaSouth"],["965","application_universal_country_Kuwait"],["996","application_universal_country_Kyrgyzstan"],["856","application_universal_country_Laos"],["371","application_universal_country_Latvia"],["961","application_universal_country_Lebanon"],["266","application_universal_country_Lesotho"],["231","application_universal_country_Liberia"],["218","application_universal_country_Libya"],["417","application_universal_country_Liechtenstein"],["370","application_universal_country_Lithuania"],["352","application_universal_country_Luxembourg"],["853","application_universal_country_Macao"],["389","application_universal_country_Macedonia"],["261","application_universal_country_Madagascar"],["265","application_universal_country_Malawi"],["60","application_universal_country_Malaysia"],["960","application_universal_country_Maldives"],["223","application_universal_country_Mali"],["356","application_universal_country_Malta"],["692","application_universal_country_MarshallIslands"],["596","application_universal_country_Martinique"],["222","application_universal_country_Mauritania"],["269","application_universal_country_Mayotte"],["52","application_universal_country_Mexico"],["691","application_universal_country_Micronesia"],["373","application_universal_country_Moldova"],["377","application_universal_country_Monaco"],["976","application_universal_country_Mongolia"],["1664","application_universal_country_Montserrat"],["212","application_universal_country_Morocco"],["258","application_universal_country_Mozambique"],["95","application_universal_country_Myanmar"],["264","application_universal_country_Namibia"],["674","application_universal_country_Nauru"],["977","application_universal_country_Nepal"],["31","application_universal_country_Netherlands"],["687","application_universal_country_NewCaledonia"],["64","application_universal_country_NewZealand"],["227","application_universal_country_Niger"],["234","application_universal_country_Nigeria"],["683","application_universal_country_Niue"],["672","application_universal_country_NorfolkIslands"],["670","application_universal_country_NorthernMarianas"],["47","application_universal_country_Norway"],["968","application_universal_country_Oman"],["92","application_universal_country_Pakistan"],["680","application_universal_country_Palau"],["507","application_universal_country_Panama"],["675","application_universal_country_PapuaNewGuinea"],["595","application_universal_country_Paraguay"],["51","application_universal_country_Peru"],["63","application_universal_country_Philippines"],["48","application_universal_country_Poland"],["351","application_universal_country_Portugal"],["1787","application_universal_country_PuertoRico"],["974","application_universal_country_Qatar"],["262","application_universal_country_Reunion"],["40","application_universal_country_Romania"],["7","application_universal_country_Russia"],["250","application_universal_country_Rwanda"],["378","application_universal_country_SanMarino"],["239","application_universal_country_SaoTomePrincipe"],["966","application_universal_country_SaudiArabia"],["221","application_universal_country_Senegal"],["381","application_universal_country_Serbia"],["248","application_universal_country_Seychelles"],["232","application_universal_country_SierraLeone"],["65","application_universal_country_Singapore"],["421","application_universal_country_SlovakRepublic"],["386","application_universal_country_Slovenia"],["677","application_universal_country_SolomonIslands"],["252","application_universal_country_Somalia"],["27","application_universal_country_SouthAfrica"],["34","application_universal_country_Spain"],["94","application_universal_country_SriLanka"],["290","application_universal_country_StHelena"],["1869","application_universal_country_StKitts"],["1758","application_universal_country_StLucia"],["597","application_universal_country_Suriname"],["249","application_universal_country_Sudan"],["268","application_universal_country_Swaziland"],["46","application_universal_country_Sweden"],["41","application_universal_country_Switzerland"],["963","application_universal_country_Syria"],["886","application_universal_country_Taiwan"],["992","application_universal_country_Tajikistan"],["66","application_universal_country_Thailand"],["228","application_universal_country_Togo"],["676","application_universal_country_Tonga"],["1868","application_universal_country_TrinidadTobago"],["216","application_universal_country_Tunisia"],["90","application_universal_country_Turkey"],["993","application_universal_country_Turkmenistan"],["1649","application_universal_country_TurksCaicosIslands"],["688","application_universal_country_Tuvalu"],["256","application_universal_country_Uganda"],["44","application_universal_country_UK"],["380","application_universal_country_Ukraine"],["971","application_universal_country_UnitedArabEmirates"],["598","application_universal_country_Uruguay"],["1","application_universal_country_USA"],["998","application_universal_country_Uzbekistan"],["678","application_universal_country_Vanuatu"],["379","application_universal_country_VaticanCity"],["58","application_universal_country_Venezuela"],["84","application_universal_country_Vietnam"],["1","application_universal_country_VirginIslandsBritish"],["1","application_universal_country_VirginIslandsUS"],["681","application_universal_country_WallisFutuna"],["969","application_universal_country_Yemen"],["967","application_universal_country_NorthYemen"],["260","application_universal_country_Zambia"],["263","application_universal_country_Zimbabwe"]]};return Object.freeze(e),e}),define("LiveIconColours",[],function(){"use strict";return class{_hex2dec(e){let t=parseInt(e,16);return isNaN(t)&&(t=-2),t}_hex2rgba(e){console.log("_hex2rgba: incoming",e);let t=[-1,-1,-1,-1],i=!0;if(e)switch(e.length){case 4:case 5:t[0]=this._hex2dec("0x"+e[1]+e[1]),t[1]=this._hex2dec("0x"+e[2]+e[2]),t[2]=this._hex2dec("0x"+e[3]+e[3]),5===e.length&&(t[3]=this._hex2dec("0x"+e[4]+e[4]));break;case 7:case 9:t[0]=this._hex2dec("0x"+e[1]+e[2]),t[1]=this._hex2dec("0x"+e[3]+e[4]),t[2]=this._hex2dec("0x"+e[5]+e[6]),9===e.length&&(t[3]=this._hex2dec("0x"+e[7]+e[8]));break;default:i=!1}return!i||-2!==t[0]&&-2!==t[1]&&-2!==t[2]&&-2!==t[3]||(i=!1),i||(console.log("_hex2rgba: returning null"),t=null),console.log("_hex2rgba: returning",t),t}constructor(){this._mainButtonInitial=null,this._mainButtonInitial_rgba=[-1,-1,-1,-1],this._mainButtonInitialInverse=null,this._mainButtonInitialInverse_rgba=[-1,-1,-1,-1],this._mainButtonInline=null,this._mainButtonInline_rgba=[-1,-1,-1,-1],this._menuButtonDefault=null,this._menuButtonDefault_rgba=[-1,-1,-1,-1],this._menuButtonInverse=null,this._menuButtonInverse_rgba=[-1,-1,-1,-1],this._menuButtonDisabled=null,this._menuButtonDisabled_rgba=[-1,-1,-1,-1],this._menuEndButtonDefault=null,this._menuEndButtonDefault_rgba=[-1,-1,-1,-1],this._menuEndButtonInverse=null,this._menuEndButtonInverse_rgba=[-1,-1,-1,-1],this._maximizedTopBar=null,this._maximizedTopBar_rgba=[-1,-1,-1,-1],this._callInfoIcon=null,this._callInfoIcon_rgba=[-1,-1,-1,-1],this._callInfoIcons=null,this._callInfoIcons_rgba=[-1,-1,-1,-1]}restoreAll(e){this.mainButtonInitial=e._mainButtonInitial,this.mainButtonInitialInverse=e._mainButtonInitialInverse,this.mainButtonInline=e._mainButtonInline,this.menuButtonDefault=e._menuButtonDefault,this.menuButtonInverse=e._menuButtonInverse,this.menuButtonDisabled=e._menuButtonDisabled,this.menuEndButtonDefault=e._menuEndButtonDefault,this.menuEndButtonInverse=e._menuEndButtonInverse,this.maximizedTopBar=e._maximizedTopBar,this.callInfoIcon=e._callInfoIcon,this.callInfoIcons=e._callInfoIcons}get mainButtonInitial(){return this._mainButtonInitial}set mainButtonInitial(e){this._mainButtonInitial=e,this._mainButtonInitial_rgba=this._hex2rgba(e),Object.defineProperty(this,"mainButtonInitial_rgba",{value:this._mainButtonInitial_rgba})}get mainButtonInitialInverse(){return this._mainButtonInitialInverse}set mainButtonInitialInverse(e){this._mainButtonInitialInverse=e,this._mainButtonInitialInverse_rgba=this._hex2rgba(e),Object.defineProperty(this,"mainButtonInitialInverse_rgba",{value:this._mainButtonInitialInverse_rgba})}get mainButtonInline(){return this._mainButtonInline}set mainButtonInline(e){this._mainButtonInline=e,this._mainButtonInline_rgba=this._hex2rgba(e),Object.defineProperty(this,"mainButtonInline_rgba",{value:this._mainButtonInline_rgba})}get menuButtonDefault(){return this._menuButtonDefault}set menuButtonDefault(e){this._menuButtonDefault=e,this._menuButtonDefault_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuButtonDefault_rgba",{value:this._menuButtonDefault_rgba})}get menuButtonInverse(){return this._menuButtonInverse}set menuButtonInverse(e){this._menuButtonInverse=e,this._menuButtonInverse_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuButtonInverse_rgba",{value:this._menuButtonInverse_rgba})}get menuButtonDisabled(){return this._menuButtonDisabled}set menuButtonDisabled(e){this._menuButtonDisabled=e,this._menuButtonDisabled_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuButtonDisabled_rgba",{value:this._menuButtonDisabled_rgba})}get menuEndButtonDefault(){return this._menuEndButtonDefault}set menuEndButtonDefault(e){this._menuEndButtonDefault=e,this._menuEndButtonDefault_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuEndButtonDefault_rgba",{value:this._menuEndButtonDefault_rgba})}get menuEndButtonInverse(){return this._menuEndButtonInverse}set menuEndButtonInverse(e){this._menuEndButtonInverse=e,this._menuEndButtonInverse_rgba=this._hex2rgba(e),Object.defineProperty(this,"menuEndButtonInverse_rgba",{value:this._menuEndButtonInverse_rgba})}get maximizedTopBar(){return this._maximizedTopBar}set maximizedTopBar(e){this._maximizedTopBar=e,this._maximizedTopBar_rgba=this._hex2rgba(e),Object.defineProperty(this,"maximizedTopBar_rgba",{value:this._maximizedTopBar_rgba})}get callInfoIcon(){return this._callInfoIcon}set callInfoIcon(e){this._callInfoIcon=e,this._callInfoIcon_rgba=this._hex2rgba(e),Object.defineProperty(this,"callInfoIcon_rgba",{value:this._callInfoIcon_rgba})}get callInfoIcons(){return this._callInfoIcons}set callInfoIcons(e){this._callInfoIcons=e,this._callInfoIcons_rgba=this._hex2rgba(e),Object.defineProperty(this,"callInfoIcons_rgba",{value:this._callInfoIcons_rgba})}}}),define("LiveScenarioCustomization",["LiveIconColours"],function(e){"use strict";return class{constructor(t){if(this.pinnedTo=null,this.verticalMargin=null,this.horizontalMargin=null,this.iconColours=new e,this.mainButtonInitialBackgroundColour=null,this.mainButtonInitialInverseBackgroundColour=null,this.mainButtonInlineBackgroundColour=null,this.mainButtonInlineFontColour=null,this.initialMessageBackgroundColour=null,this.initialMessageFontColour=null,this.infoPanelBackgroundColour=null,this.infoPanelFontColour=null,this.maximizedTopBarBackgroundColour=null,this.maximizedTopBarFontColour=null,this.buttonBarBackgroundColour=null,this.menuButtonDefaultBackgroundColour=null,this.menuButtonActiveBackgroundColour=null,this.menuButtonDisabledBackgroundColour=null,this.menuEndButtonDefaultBackgroundColour=null,this.menuEndButtonActiveBackgroundColour=null,this.dialogPrimaryButtonBackgroundColour=null,this.dialogPrimaryButtonBorderColour=null,this.dialogPrimaryButtonFontColour=null,this.dialogPrimaryButtonInverseBackgroundColour=null,this.dialogPrimaryButtonInverseBorderColour=null,this.dialogPrimaryButtonInverseFontColour=null,this.dialogSecondaryButtonBackgroundColour=null,this.dialogSecondaryButtonBorderColour=null,this.dialogSecondaryButtonFontColour=null,this.dialogSecondaryButtonInverseBackgroundColour=null,this.dialogSecondaryButtonInverseBorderColour=null,this.dialogSecondaryButtonInverseFontColour=null,t){if(console.log("Incoming customization:",t),t.iconColours&&this.iconColours.restoreAll(t.iconColours),t.position){const e=t.position;e.pinnedTo&&(this.pinnedTo=e.pinnedTo),e.verticalMargin&&(this.verticalMargin=e.verticalMargin),e.horizontalMargin&&(this.horizontalMargin=e.horizontalMargin)}else this.pinnedTo=t.pinnedTo?t.pinnedTo:null,this.verticalMargin=t.verticalMargin>=0?t.verticalMargin:null,this.horizontalMargin=t.horizontalMargin>=0?t.horizontalMargin:null;if(t.mainButton){const e=t.mainButton;if(e.initial&&e.initial.colors){const t=e.initial.colors;t.background&&(this.mainButtonInitialBackgroundColour=t.background),t.icon&&(this.iconColours.mainButtonInitial=t.icon)}if(e.initial&&e.initial.inverse){const t=e.initial.inverse;t.background&&(this.mainButtonInitialInverseBackgroundColour=t.background),t.icon&&(this.iconColours.mainButtonInitialInverse=t.icon)}if(e.inline&&e.inline.colors){const t=e.inline.colors;t.background&&(this.mainButtonInlineBackgroundColour=t.background),t.font&&(this.mainButtonInlineFontColour=t.font),t.icon&&(this.iconColours.mainButtonInline=t.icon)}}else this.mainButtonInitialBackgroundColour=t.mainButtonInitialBackgroundColour?t.mainButtonInitialBackgroundColour:null,this.mainButtonInitialInverseBackgroundColour=t.mainButtonInitialInverseBackgroundColour?t.mainButtonInitialInverseBackgroundColour:null,this.mainButtonInlineBackgroundColour=t.mainButtonInlineBackgroundColour?t.mainButtonInlineBackgroundColour:null,this.mainButtonInlineFontColour=t.mainButtonInlineFontColour?t.mainButtonInlineFontColour:null;if(t.initialMessage&&t.initialMessage.colors){const e=t.initialMessage.colors;e.background&&(this.initialMessageBackgroundColour=e.background),e.font&&(this.initialMessageFontColour=e.font)}else this.initialMessageBackgroundColour=t.initialMessageBackgroundColour?t.initialMessageBackgroundColour:null,this.initialMessageFontColour=t.initialMessageFontColour?t.initialMessageFontColour:null;if(t.infoPanel&&t.infoPanel.colors){const e=t.infoPanel.colors;e.background&&(this.infoPanelBackgroundColour=e.background),e.font&&(this.infoPanelFontColour=e.font,this.iconColours.callInfoIcon=e.font,this.iconColours.callInfoIcons=e.font)}else this.infoPanelBackgroundColour=t.infoPanelBackgroundColour?t.infoPanelBackgroundColour:null,this.infoPanelFontColour=t.infoPanelFontColour?t.infoPanelFontColour:null;if(t.maximisedComponent&&t.maximisedComponent.colors){const e=t.maximisedComponent.colors;e.background&&(this.maximizedTopBarBackgroundColour=e.background),e.font&&(this.maximizedTopBarFontColour=e.font),e.icon&&(this.iconColours.maximizedTopBar=e.icon)}else this.maximizedTopBarBackgroundColour=t.maximizedTopBarBackgroundColour?t.maximizedTopBarBackgroundColour:null,this.maximizedTopBarFontColour=t.maximizedTopBarFontColour?t.maximizedTopBarFontColour:null;if(t.buttonBar){const e=t.buttonBar;if(e.bar&&e.bar.colors&&e.bar.colors.background&&(this.buttonBarBackgroundColour=e.bar.colors.background),e.buttons){const t=e.buttons;t.default&&t.default.colors&&(t.default.colors.background&&(this.menuButtonDefaultBackgroundColour=t.default.colors.background),t.default.colors.icon&&(this.iconColours.menuButtonDefault=t.default.colors.icon)),t.inverse&&t.inverse.colors&&(t.inverse.colors.background&&(this.menuButtonInverseBackgroundColour=t.inverse.colors.background),t.inverse.colors.icon&&(this.iconColours.menuButtonInverse=t.inverse.colors.icon)),t.disabled&&t.disabled.colors&&(t.disabled.colors.background&&(this.menuButtonDisabledBackgroundColour=t.disabled.colors.background),t.disabled.colors.icon&&(this.iconColours.menuButtonDisabled=t.disabled.colors.icon)),t.end&&(t.end.colors&&(t.end.colors.background&&(this.menuEndButtonDefaultBackgroundColour=t.end.colors.background),t.end.colors.icon&&(this.iconColours.menuEndButtonDefault=t.end.colors.icon)),t.end.inverse&&(t.end.inverse.background&&(this.menuEndButtonInverseBackgroundColour=t.end.inverse.background),t.end.inverse.icon&&(this.iconColours.menuEndButtonInverse=t.end.inverse.icon)))}}else this.buttonBarBackgroundColour=t.buttonBarBackgroundColour?t.buttonBarBackgroundColour:null,this.menuButtonDefaultBackgroundColour=t.menuButtonDefaultBackgroundColour?t.menuButtonDefaultBackgroundColour:null,this.menuButtonInverseBackgroundColour=t.menuButtonInverseBackgroundColour?t.menuButtonInverseBackgroundColour:null,this.menuButtonDisabledBackgroundColour=t.menuButtonDisabledBackgroundColour?t.menuButtonDisabledBackgroundColour:null,this.menuEndButtonDefaultBackgroundColour=t.menuEndButtonDefaultBackgroundColour?t.menuEndButtonDefaultBackgroundColour:null,this.menuEndButtonInverseBackgroundColour=t.menuEndButtonInverseBackgroundColour?t.menuEndButtonInverseBackgroundColour:null;if(t.dialogs){if(t.dialogs.primaryButton){if(t.dialogs.primaryButton.colors){const e=t.dialogs.primaryButton.colors;e.background&&(this.dialogPrimaryButtonBackgroundColour=e.background),e.border&&(this.dialogPrimaryButtonBorderColour=e.border),e.font&&(this.dialogPrimaryButtonFontColour=e.font)}if(t.dialogs.primaryButton.inverse){const e=t.dialogs.primaryButton.inverse;e.background&&(this.dialogPrimaryButtonInverseBackgroundColour=e.background),e.border&&(this.dialogPrimaryButtonInverseBorderColour=e.border),e.font&&(this.dialogPrimaryButtonInverseFontColour=e.font)}}if(t.dialogs.secondaryButton){if(t.dialogs.secondaryButton.colors){const e=t.dialogs.secondaryButton.colors;e.background&&(this.dialogSecondaryButtonBackgroundColour=e.background),e.border&&(this.dialogSecondaryButtonBorderColour=e.border),e.font&&(this.dialogSecondaryButtonFontColour=e.font)}if(t.dialogs.secondaryButton.inverse){const e=t.dialogs.secondaryButton.inverse;e.background&&(this.dialogSecondaryButtonInverseBackgroundColour=e.background),e.border&&(this.dialogSecondaryButtonInverseBorderColour=e.border),e.font&&(this.dialogSecondaryButtonInverseFontColour=e.font)}}}else this.dialogPrimaryButtonBackgroundColour=t.dialogPrimaryButtonBackgroundColour?t.dialogPrimaryButtonBackgroundColour:null,this.dialogPrimaryButtonBorderColour=t.dialogPrimaryButtonBorderColour?t.dialogPrimaryButtonBorderColour:null,this.dialogPrimaryButtonFontColour=t.dialogPrimaryButtonFontColour?t.dialogPrimaryButtonFontColour:null,this.dialogPrimaryButtonInverseBackgroundColour=t.dialogPrimaryButtonInverseBackgroundColour?t.dialogPrimaryButtonInverseBackgroundColour:null,this.dialogPrimaryButtonInverseBorderColour=t.dialogPrimaryButtonInverseBorderColour?t.dialogPrimaryButtonInverseBorderColour:null,this.dialogPrimaryButtonInverseFontColour=t.dialogPrimaryButtonInverseFontColour?t.dialogPrimaryButtonInverseFontColour:null,this.dialogSecondaryButtonBackgroundColour=t.dialogSecondaryButtonBackgroundColour?t.dialogSecondaryButtonBackgroundColour:null,this.dialogSecondaryButtonBorderColour=t.dialogSecondaryButtonBorderColour?t.dialogSecondaryButtonBorderColour:null,this.dialogSecondaryButtonFontColour=t.dialogSecondaryButtonFontColour?t.dialogSecondaryButtonFontColour:null,this.dialogSecondaryButtonInverseBackgroundColour=t.dialogSecondaryButtonInverseBackgroundColour?t.dialogSecondaryButtonInverseBackgroundColour:null,this.dialogSecondaryButtonInverseBorderColour=t.dialogSecondaryButtonInverseBorderColour?t.dialogSecondaryButtonInverseBorderColour:null,this.dialogSecondaryButtonInverseFontColour=t.dialogSecondaryButtonInverseFontColour?t.dialogSecondaryButtonInverseFontColour:null}console.log("mainButtonInitialBackgroundColour",this.mainButtonInitialBackgroundColour),console.log("iconColours.mainButtonInitial",this.iconColours.mainButtonInitial),console.log("mainButtonInitialInverseBackgroundColour",this.mainButtonInitialInverseBackgroundColour),console.log("iconColours.mainButtonInitialInverse",this.iconColours.mainButtonInitialInverse),console.log("mainButtonInlineBackgroundColour",this.mainButtonInlineBackgroundColour),console.log("mainButtonInlineFontColour",this.mainButtonInlineFontColour),console.log("iconColours.mainButtonInline",this.iconColours.mainButtonInline),console.log("initialMessageBackgroundColour",this.initialMessageBackgroundColour),console.log("initialMessageFontColour",this.initialMessageFontColour),console.log("infoPanelBackgroundColour",this.infoPanelBackgroundColour),console.log("infoPanelFontColour",this.infoPanelFontColour),console.log("iconColours.callInfoIcons",this.iconColours.callInfoIcons),console.log("maximizedTopBarBackgroundColour",this.maximizedTopBarBackgroundColour),console.log("maximizedTopBarFontColour",this.maximizedTopBarFontColour),console.log("iconColours.maximizedTopBar",this.iconColours.maximizedTopBar),console.log("buttonBarBackgroundColour",this.buttonBarBackgroundColour),console.log("menuButtonDefaultBackgroundColour",this.menuButtonDefaultBackgroundColour),console.log("iconColours.menuButtonDefault",this.iconColours.menuButtonDefault),console.log("menuButtonActiveBackgroundColour",this.menuButtonActiveBackgroundColour),console.log("iconColours.menuButtonActive",this.iconColours.menuButtonActive),console.log("menuButtonDisabledBackgroundColour",this.menuButtonDisabledBackgroundColour),console.log("iconColours.menuButtonDisabled",this.iconColours.menuButtonDisabled),console.log("menuEndButtonDefaultBackgroundColour",this.menuEndButtonDefaultBackgroundColour),console.log("iconColours.menuEndButtonDefault",this.iconColours.menuEndButtonDefault),console.log("menuEndButtonActiveBackgroundColour",this.menuEndButtonActiveBackgroundColour),console.log("iconColours.menuEndButtonActive",this.iconColours.menuEndButtonActive),console.log("dialogPrimaryButtonBackgroundColour",this.dialogPrimaryButtonBackgroundColour),console.log("dialogPrimaryButtonBorderColour",this.dialogPrimaryButtonBorderColour),console.log("dialogPrimaryButtonFontColour",this.dialogPrimaryButtonFontColour),console.log("dialogPrimaryButtonInverseBackgroundColour",this.dialogPrimaryButtonInverseBackgroundColour),console.log("dialogPrimaryButtonInverseBorderColour",this.dialogPrimaryButtonInverseBorderColour),console.log("dialogPrimaryButtonInverseFontColour",this.dialogPrimaryButtonInverseFontColour),console.log("dialogSecondaryButtonBackgroundColour",this.dialogSecondaryButtonBackgroundColour),console.log("dialogSecondaryButtonBorderColour",this.dialogSecondaryButtonBorderColour),console.log("dialogSecondaryButtonFontColour",this.dialogSecondaryButtonFontColour),console.log("dialogSecondaryButtonInverseBackgroundColour",this.dialogSecondaryButtonInverseBackgroundColour),console.log("dialogSecondaryButtonInverseBorderColour",this.dialogSecondaryButtonInverseBorderColour),console.log("dialogSecondaryButtonInverseFontColour",this.dialogSecondaryButtonInverseFontColour)}}}),define("LiveZoom",["LiveScenarioCustomization"],function(e){"use strict";return class{constructor(e){console.log("LiveZoom: constructing.."),this._customization=e,this._customization&&$(".oracle-live-video-buttons-zoom").css("background-color",this._customization.buttonBarBackgroundColour).css("border-color",this._customization.buttonBarBackgroundColour),this.ZOOM_FACTOR=1.25,this.CONTENT_SHRINK_FACTOR=1-1/this.ZOOM_FACTOR,this.reset()}disable(e){!0===e?(this.reset(),$(".oracle-live-remote-screenshare").off("click"),$(".oracle-live-video-zoomin-button").off("click"),$(".oracle-live-video-zoomout-button").off("click"),$(".oracle-live-video-default-button").off("click")):($(".oracle-live-remote-screenshare").off("click").click(e=>{this.centreOnClickedPoint(e.offsetX,e.offsetY)}),$(".oracle-live-video-zoomin-button").off("click").click(this.zoomIn.bind(this)),$(".oracle-live-video-zoomout-button").off("click").click(this.zoomOut.bind(this)),$(".oracle-live-video-default-button").off("click").click(this.reset.bind(this)))}reset(){console.log("LiveZoom: ---- Reset ----"),this.zoomPercent=100,this.scrolledLeft=0,this.scrolledTop=0,this.targetTag?this.assertCameraPanAndZoom():this.sensitizeButtons()}centreOnClickedPoint(e,t,i){this.captureCurrentScrolledValues();let o=this.parentTag.width(),s=this.parentTag.height(),n=i;if(!n){let i=e>this.innerWidth/2?this.innerWidth-e:e,a=t>this.innerHeight/2?this.innerHeight-t:t,r=i<o?o/i:1,l=a<s?s/a:1;(n=r>l?r/2:l/2)<this.ZOOM_FACTOR&&(n=this.ZOOM_FACTOR)}this.zoomPercent*=n,console.log("Zoom percent is ",this.zoomPercent),this.zoomPercent>2e3&&(n=1,this.zoomPercent=100,console.log("Zoom is too large. Resetting to 100%"));const a=document.getElementsByClassName("oracle-live-video-buttons-zoom");a&&(console.log("Zoom control classes = ",a.length),1===a.length&&(console.log("Showing zoom panel (override/workaround for hidden panel)"),a[0].style="display: block")),this.scrolledLeft=e*n-o/2,this.scrolledTop=t*n-s/2,this.assertCameraPanAndZoom()}zoomIn(){console.log("LiveZoom: ---- Zoom In ----"),this.captureCurrentScrolledValues();let e=this.parentTag.width(),t=this.parentTag.height();console.log("viewerWidthScaled="+e+", viewerHeightScaled="+t);let i=this.scrolledLeft+e/2,o=this.scrolledTop+t/2;this.centreOnClickedPoint(i,o,this.ZOOM_FACTOR)}saveScrollPosition(){const e=document.getElementsByClassName("oracle-live-video-scroller");e&&e.length>0&&void 0!==e[0].scrollTop&&void 0!==e[0].scrollLeft&&(this.scrollTop=document.getElementsByClassName("oracle-live-video-scroller")[0].scrollTop,this.scrollLeft=document.getElementsByClassName("oracle-live-video-scroller")[0].scrollLeft,console.log(`saveScrollPosition: (${this.scrollLeft},${this.scrollTop})`))}restoreScrollPosition(){void 0!==this.scrollTop&&void 0!==this.scrollLeft?(console.log(`restoreScrollPosition: (${this.scrollLeft},${this.scrollTop})`),this.scrollTop=document.getElementsByClassName("oracle-live-video-scroller")[0].scroll({top:this.scrollTop,left:this.scrollLeft})):(console.log("restoreScrollPosition: reset zoom"),this.reset())}zoomOut(){if(this.zoomPercent>100){console.log("LiveZoom: ---- Zoom Out ----"),this.captureCurrentScrolledValues(),this.zoomPercent/=this.ZOOM_FACTOR,this.zoomPercent<100&&(this.zoomPercent=100);let e=this.innerWidth*this.CONTENT_SHRINK_FACTOR,t=this.innerHeight*this.CONTENT_SHRINK_FACTOR;console.log("Our content will shrink via this zoom by width="+e+", height="+t),this.scrolledLeft=this.scrolledLeft-e/2,this.scrolledTop=this.scrolledTop-t/2,this.assertCameraPanAndZoom()}else console.log("LiveZoom: Zoom out request ignored - already fully 'out'")}assertCameraPanAndZoom(){console.log("LiveZoom: ===> Asserting: zoom="+this.zoomPercent+"%, scrollLeft="+this.scrolledLeft+", scrollTop="+this.scrolledTop);let e={width:this.zoomPercent+"%",height:this.zoomPercent+"%"};console.log("LiveZoom: Setting pan/zoom related styles to..",e),this.targetTag.css(e),console.log("LiveZoom: (re-styled) targetTag:",this.targetTag),this.sensitizeButtons(),this.parentTag.scrollLeft(this.scrolledLeft),this.parentTag.scrollTop(this.scrolledTop)}ensureTagsAreValid(){this.targetTag||(console.log("LiveZoom: no targetTag yet, resolving.."),this.targetTag=$(".oracle-live-remote-screenshare"),console.log("LiveZoom: targetTag:",this.targetTag)),this.parentTag||(console.log("LiveZoom: no parentTag yet, resolving.."),this.parentTag=$(".oracle-live-video-scroller"),console.log("LiveZoom: parentTag:",this.parentTag)),this.zoomInButton||(console.log("LiveZoom: no zoomInButton yet, resolving.."),this.zoomInButton=$(".oracle-live-video-zoomin-button"),console.log("LiveZoom: zoomInButton:",this.zoomInButton)),this.zoomOutButton||(console.log("LiveZoom: no zoomOutButton yet, resolving.."),this.zoomOutButton=$(".oracle-live-video-zoomout-button"),console.log("LiveZoom: zoomOutButton:",this.zoomOutButton)),this.resetButton||(console.log("LiveZoom: no resetButton yet, resolving.."),this.resetButton=$(".oracle-live-video-default-button"),console.log("LiveZoom: resetButton:",this.resetButton))}captureCurrentScrolledValues(){console.log("LiveZoom: captureCurrentScrolledValues"),this.ensureTagsAreValid(),this.scrolledLeft=this.parentTag.scrollLeft()||0,this.scrolledTop=this.parentTag.scrollTop()||0,console.log("scrolledLeft="+this.scrolledLeft+", scrolledTop="+this.scrolledTop),this.innerWidth=this.targetTag.width(),this.innerHeight=this.targetTag.height(),console.log("innerWidth="+this.innerWidth+", innerHeight="+this.innerHeight)}sensitizeButtons(){this.ensureTagsAreValid();const e=this.zoomPercent>100,t=100!==this.zoomPercent;if(console.log("LiveZoom: sensitizeButtons: canZoomIn=true, canZoomOut="+e+", canReset="+t),this.zoomInButton.attr("aria-disabled",!1),this.zoomOutButton.attr("aria-disabled",!e),this.resetButton.attr("aria-disabled",!t),this._customization){const i=this._customization.menuButtonDefaultBackgroundColour,o=this._customization.iconColours.menuButtonDefault,s=e?this._customization.menuButtonDefaultBackgroundColour:this._customization.menuButtonDisabledBackgroundColour,n=e?this._customization.iconColours.menuButtonDefault:this._customization.iconColours.menuButtonDisabled,a=t?this._customization.menuButtonDefaultBackgroundColour:this._customization.menuButtonDisabledBackgroundColour,r=t?this._customization.iconColours.menuButtonDefault:this._customization.iconColours.menuButtonDisabled;this.zoomInButton.css("background-color",i).css("border-color",i).css("color",o),this.zoomOutButton.css("background-color",s).css("border-color",s).css("color",n),this.resetButton.css("background-color",a).css("border-color",a).css("color",r)}}}}),define("LiveIconColourChange",["LiveIconColours"],function(e){"use strict";return class{constructor(e,t,i,o){if(console.log("LiveIconColourChange",e,t),console.log("rgbas.menuButtonDefault_rgba1",t.menuButtonDefault_rgba),this._updatedImg=null,!e)return void(o?o("Missing icon file url"):console.error("Missing icon file url"));let s=e.startsWith("url")?e.replace(/^url\(['"](.+)['"]\)/,"$1"):e,n=new Image;n.setAttribute("crossOrigin",""),n.onload=(()=>{console.log("LiveIconColourChange: url:",s);let e=document.createElement("canvas"),o=e.getContext("2d",{willReadFrequently:!0}),a=n.width,r=n.height;e.width=a,e.height=r,o.drawImage(n,0,0,a,r);let l=(e,t,i,s,n)=>{console.log("LiveIconColourChange: onload.replaceImage: x, y, w, h, rgba",e,t,i,s,n);let a=o.getImageData(e,t,i,s);for(let e=0;e<a.data.length;e+=4)if(0!==a.data[e+3]&&(a.data[e]=n[0],a.data[e+1]=n[1],a.data[e+2]=n[2],n[3]>=0)){const t=100-n[3]/255*100;a.data[e+3]-=a.data[e+3]/100*t}o.putImageData(a,e,t)};t.mainButtonInitial&&t.mainButtonInitial_rgba&&l(8,8,a-8,41,t.mainButtonInitial_rgba),t.mainButtonInitialInverse&&t.mainButtonInitialInverse_rgba&&l(8,50,a-8,41,t.mainButtonInitialInverse_rgba),t.mainButtonInline&&t.mainButtonInline_rgba&&l(8,746,a-8,20,t.mainButtonInline_rgba),t.menuButtonDefault&&t.menuButtonDefault_rgba&&l(30,686,a-30,20,t.menuButtonDefault_rgba),t.menuButtonInverse&&t.menuButtonInverse_rgba&&l(30,706,a-30,20,t.menuButtonInverse_rgba),t.menuButtonDisabled&&t.menuButtonDisabled_rgba&&(l(7,666,a-7,20,t.menuButtonDisabled_rgba),l(7,726,a-7,20,t.menuButtonDisabled_rgba)),t.menuEndButtonDefault&&t.menuEndButtonDefault_rgba&&l(7,686,20,20,t.menuEndButtonDefault_rgba),t.menuEndButtonInverse&&t.menuEndButtonInverse_rgba&&l(7,706,20,20,t.menuEndButtonInverse_rgba),t.maximizedTopBar&&t.maximizedTopBar_rgba&&l(8,970,a-8,16,t.maximizedTopBar_rgba),t.callInfoIcon&&t.callInfoIcon_rgba&&l(54,771,10,15,t.callInfoIcon_rgba),t.callInfoIcons&&t.callInfoIcons_rgba&&l(8,1005,a-8,20,t.callInfoIcons_rgba),this._updatedImg="url("+e.toDataURL("image/png")+")",Object.defineProperty(this,"icons",{value:this._updatedImg}),i&&i(this._updatedImg)}),n.src=s,console.log("LiveIconColourChange: image:",n)}}}),function(){"use strict";var e=/(^.*(^|\/)nls(\/|$))([^\/]*)\/?([^\/]*)/;function t(e,t,i,o,s,n){t[e]&&(i.push(e),!0!==t[e]&&1!==t[e]||o.push(s+e+"/"+n))}function i(e,t,i,o,s){var n=o+t+"/"+s;require._fileExists(e.toUrl(n+".js"))&&i.push(n)}function o(e,t,i){var s;for(s in t)!t.hasOwnProperty(s)||e.hasOwnProperty(s)&&!i?"object"==typeof t[s]&&o(e[s],t[s],i):e[s]=t[s]}define("i18n",["module"],function(s){var n=s.config?s.config():{};return{version:"2.0.2",load:function(s,a,r,l){(l=l||{}).locale&&(n.locale=l.locale);var c,d,u,h=e.exec(s),g=h[1],m=h[4],p=h[5],v=m.split("-"),S=[],_={},f="";if(h[5]?c=(g=h[1])+p:(c=s,p=h[4],(m=n.locale)||(m=n.locale="undefined"==typeof navigator?"root":(navigator.language||navigator.userLanguage||"root").toLowerCase()),v=m.split("-")),l.isBuild){for(S.push(c),i(a,"root",S,g,p),d=0;d<v.length;d++)u=v[d],i(a,f+=(f?"-":"")+u,S,g,p);a(S,function(){r()})}else a([c],function(e){var i,s=[];for(t("root",e,s,S,g,p),d=0;d<v.length;d++)i=v[d],t(f+=(f?"-":"")+i,e,s,S,g,p);a(S,function(){var t,i,n;for(t=s.length-1;t>-1&&s[t];t--)!0!==(i=e[n=s[t]])&&1!==i||(i=a(g+n+"/"+p)),o(_,i);r(_)})})}}})}(),define("css",[],function(){if("undefined"==typeof window)return{load:function(e,t,i){i()}};var e=document.getElementsByTagName("head")[0],t=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)|AndroidWebKit\/([^ ;]*)/)||0,i=!1,o=!0;t[1]||t[7]?i=parseInt(t[1])<6||parseInt(t[7])<=9:t[2]||t[8]?o=!1:t[4]&&(i=parseInt(t[4])<18);var s,n,a,r={pluginBuilder:"./css-builder"},l=function(){s=document.createElement("style"),e.appendChild(s),n=s.styleSheet||s.sheet},c=0,d=[],u=function(e){32==++c&&(l(),c=0),n.addImport(e),s.onload=function(){h()}},h=function(){a();var e=d.shift();return e?(a=e[1],void u(e[0])):void(a=null)},g=function(t,i){var s=document.createElement("link");if(s.type="text/css",s.rel="stylesheet",o)s.onload=function(){s.onload=function(){},setTimeout(i,7)};else var n=setInterval(function(){for(var e=0;e<document.styleSheets.length;e++){if(document.styleSheets[e].href==s.href)return clearInterval(n),i()}},10);s.href=t,e.appendChild(s)};return r.normalize=function(e,t){return".css"==e.substr(e.length-4,4)&&(e=e.substr(0,e.length-4)),t(e)},r.load=function(e,t,o){(i?function(e,t){if(n&&n.addImport||l(),n&&n.addImport)a?d.push([e,t]):(u(e),a=t);else{s.textContent='@import "'+e+'";';var i=setInterval(function(){try{s.sheet.cssRules,clearInterval(i),t()}catch(e){}},10)}}:g)(t.toUrl(e+".css"),o)},r}),define("LiveButtonMenu",["jquery","text!oracle.live.button.html","LiveCallTimer","LiveEvents","LiveCountryCodes","LiveZoom","LiveIconColourChange","LiveIconColours","i18n!nls/oracle.live.messages","css!oracle.live.style.css"],function($,e,t,i,o,s,n,a,r){"use strict";const l=10;return class{constructor(e){this._impl=e,this._messages=r,console.log("Language is: "+navigator.language),this._callTimer=new t,this._agentName="",this._endUserName="",this._avatarImageUrl=null,this._connectingAudioSrc=null,this._isMeeting=!1,this._transferMode="None",this._meetingTitle=null,this._greetingMessage=null,this._connectingMessage=null,this._transferringMessage=null,this._notificationUptime=8e3,this._timedDialogTimer=null,this._isCallbackDialogVisible=!1,this._inputPhoneNumber="",this._inputPhoneCountryCode="",this._thisCallbackInputInitialized=!1,this._inputListenersInitialized=!1,this._messagingMsgId=1,this._lastAssociateJoined=null,this._showingPausedNotification=!1,this._notificationTimer=null,this._shortCode=null,this._shortCodeMode=!1,this._usingExternalAudio=!1,this._preCallIDCheck=!1,this._connectingAudioTimer=null,this._startInVideo=!1,this._startVideoInFullScreen=!1,this._startVideoWithFrontCamera=!1,this._startInScreenShare=!1,this._endUserControlsCamera=!1,this._endUserControlsScreenShare=!1,this._endUserControlsCobrowse=!1,this._previousMaximizedFeed=null,this._havePausedResumed=!1,this._canRejoinMeeting=!0,this._annotationList=[],this._videoAnnotationList=[],this._maximizedFeedWhenScreenShareAdded=null,this._liveUpdatedIcons=null,this._iconColours=null,this._positionsDefined=!1,this._vertpx=null,this._horzpx=null,this._vertpn=null,this._horzpn=null,this._buttonBarReversed="Default",this._hideEndCallButton=!1,this._hidePauseButton=!1,this._cameraDefaultOn=null,this._addedOracleLiveVideoControlEnduser=!1,this._hideQueueLengthIndicator=!1,this._diagnosticsRunning=!1,this._resumeConnectedStatus=!1,this._originMaximizedVideo="NONE",this._numParticipants=0,this._videoMaxStateBeforeOff=null,this._lastCountrySearched="",this._defaultBodyMarginTop=$("body").css("margin-top")}get messages(){return this._messages}addComponent(e,t,i){this._addComponent(),this.updateMessages(e,i),this._browser=t}setMessages(e){console.log("Installing messages downloaded from REST service",e),this._messages=e,this._populateMessages()}setPopMessageText(e,t){e&&t?($(".oracle-live-popmessage").attr("tabindex",0).attr("aria-label",e+" "+t),$(".oracle-live-popmessage-text").attr("tabindex",null).text(e).attr("aria-label",null),$(".oracle-live-popmessage-shortcode").attr("tabindex",null).text(t).attr("aria-label",null)):($(".oracle-live-popmessage").attr("tabindex",null).attr("aria-label",null),e?$(".oracle-live-popmessage-text").attr("tabindex",0).text(e).attr("aria-label",e):$(".oracle-live-popmessage-text").attr("tabindex",null).text("").attr("aria-label",null),t?$(".oracle-live-popmessage-shortcode").attr("tabindex",0).text(t).attr("aria-label",t):$(".oracle-live-popmessage-shortcode").attr("tabindex",null).text("").attr("aria-label",null))}setPopMessageAriaDisabled(e){let t="false";!0===e&&(t="true",this.setPopMessageText(null,null)),$(".oracle-live-popmessage").attr("aria-disabled",t),$(".oracle-live-popmessage-text").attr("aria-disabled",t),$(".oracle-live-popmessage-shortcode").attr("aria-disabled",t)}updateMessages(e,t){console.log("updateMessages: "+JSON.stringify(e,null,2)+", meetingTitle: "+t),e&&(this._greetingMessage=this._messages.hasOwnProperty(e.greetingMessage)?this._messages[e.greetingMessage]:e.greetingMessage,e.connectingMessage&&(this._connectingMessage=this._messages.hasOwnProperty(e.connectingMessage)?this._messages[e.connectingMessage]:e.connectingMessage),this.setPopMessageText(this._greetingMessage,null)),t&&(this._meetingTitle=t),this._okButton=$(".oracle-live-dialog-ok"),this._cancelButton=$(".oracle-live-dialog-cancel")}setCustomization(e){console.log("Installing customization downloaded from REST service",e),this._customization=e,this._customize()}resetClass(e){console.log("LiveButtonMenu::resetClass => ",e);const t=$(".oracle-live").hasClass("oracle-live-video-associate-maximized"),i=document.getElementsByClassName("oracle-live");if(i.length>0){const o=i[0];let s=!1;o.classList.contains("oracle-live-show-messaging")&&(s=!0),o.classList.contains("oracle-live-hidden")&&-1===e.indexOf("oracle-live-hidden")?(console.log("Resetting class with oracle-live-hidden to: "+e),o.className=e+" oracle-live-hidden"):(console.log("Resetting class to "+e),o.className=e),this._isMeeting?o.classList.add("oracle-live-meeting"):t&&o.classList.contains("oracle-live-connected")&&(console.log("LiveButtonMenu::resetClass: preserving maximized remote video"),o.classList.add("oracle-live-video-associate-maximized")),s&&o.classList.add("oracle-live-show-messaging"),console.log("resetClass to: "+o.className)}}_addComponent(){console.log("Menu::addComponent, meeting=",this._isMeeting);let t=$("body");const i=document.getElementsByClassName("oracle-live"),o=!i||0===i.length;t.length?(o&&t.prepend(e),this._impl.service.startCallDirectly?this.resetClass("oracle-live oracle-live-hidden"):this.resetClass("oracle-live"),this._populateMessages(),this._customize(),console.log("Attaching mouse listeners"),$(".oracle-live-video-panel").off("click").on("click",e=>{console.log("Clicked the video panel");const t=$(".oracle-live"),i=t.hasClass("oracle-live-paused-associate"),o=t.hasClass("oracle-live-paused-enduser");return!(!t.hasClass("oracle-live-video-preview")&&(!this.getMaximizedFeed()||o)&&!i&&(t.hasClass("oracle-live-videopanel-toolbars-hidden")?t.removeClass("oracle-live-videopanel-toolbars-hidden"):o?this._unHideTopbarAndToolbar(!0):t.addClass("oracle-live-videopanel-toolbars-hidden"),0))}),$(".oracle-live-video-panel .oracle-live-local-video").off("click").on("click",e=>{console.log("Clicked the video panel when in maximized status of end user");const t=$(".oracle-live");if(t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on"))return this._toggleTopbarAndToolbar(),!0})):console.warn("No body element on this page - there's nowhere to attach LX component")}_toggleTopbarAndToolbar(){$(".oracle-live").hasClass("oracle-live-videopanel-topbar-toolbar-hidden")?this._unHideTopbarAndToolbar():this._hideTopbarAndToolbar()}_hideTopbarAndToolbar(){const e=$(".oracle-live");e.hasClass("oracle-live-videopanel-topbar-toolbar-hidden")||e.addClass("oracle-live-videopanel-topbar-toolbar-hidden"),this._isMeeting&&e.hasClass("oracle-live-connected")||$(".oracle-live-menu").css("display","none"),$(".oracle-live-video-toolbar-enduser").css("display","none")}_unHideTopbarAndToolbar(e){this._topBarShowTimer&&clearTimeout(this._topBarShowTimer);const t=$(".oracle-live");t.hasClass("oracle-live-videopanel-topbar-toolbar-hidden")&&t.removeClass("oracle-live-videopanel-topbar-toolbar-hidden");const i=t.hasClass("oracle-live-annotation-associate-video-on");this._isMeeting&&t.hasClass("oracle-live-connected")&&!i||$(".oracle-live-menu").css("display","block"),e||($(".oracle-live-video-toolbar-enduser").css("display","block"),this._topBarShowTimer=setTimeout(()=>{this._hideTopbarAndToolbar()},5e3))}toggleStreamMenu(e,t=null){let i;null===e?(t=!1,i=$(".oracle-live .oracle-live-video-display-menu")):i=$(".oracle-live .oracle-live-video-display-menu[name='"+e+"']"),null===t?i.toggle():t?i.show():i.hide()}toggleRemoteLayout(e){0===$(".oracle-live.oracle-live-video-associate-maximized").length&&(e="Single");const t=$(".oracle-live .oracle-live-video-panel.oracle-live-video-panel-associate");switch("Horizontal"!==e&&t.hasClass("oracle-live-video-grid-horizontal")?t.removeClass("oracle-live-video-grid-horizontal"):"Vertical"!==e&&t.hasClass("oracle-live-video-grid-vertical")?t.removeClass("oracle-live-video-grid-vertical"):"Single"!==e&&t.hasClass("oracle-live-video-grid-single")&&t.removeClass("oracle-live-video-grid-single"),e){case"Horizontal":t.addClass("oracle-live-video-grid-horizontal"),console.log("LiveButtonMenu: layout horizontal");break;case"Vertical":t.addClass("oracle-live-video-grid-vertical"),console.log("LiveButtonMenu: layout vertical");break;case"Single":t.addClass("oracle-live-video-grid-single"),this.nextRemoteVideo(),console.log("LiveButtonMenu: layout single");break;default:console.log("Unsupported layout for remote videos")}return this.toggleStreamMenu(null),e}nextRemoteVideo(){let e=$(".oracle-live-remote-videos .oracle-live-remote-video-container.oracle-live-streaming");if(e.length>1){let t=!1;e.each(function(i){if($(this).hasClass("oracle-live-video-current"))return $(this).removeClass("oracle-live-video-current"),i===e.length-1?e.first().addClass("oracle-live-video-current"):e.eq(i+1).addClass("oracle-live-video-current"),t=!0,!1}),t||e.first().next().addClass("oracle-live-video-current")}else 1===e.length&&e.addClass("oracle-live-video-current");this._setTitle()}prevRemoteVideo(){let e=$(".oracle-live-remote-videos .oracle-live-remote-video-container.oracle-live-streaming");if(e.length>1){let t=!1;e.each(function(i){if($(this).hasClass("oracle-live-video-current"))return $(this).removeClass("oracle-live-video-current"),0===i?e.last().addClass("oracle-live-video-current"):e.eq(i-1).addClass("oracle-live-video-current"),t=!0,!1}),t||e.last().addClass("oracle-live-video-current")}this._setTitle()}_clearCustomPositionCss(e){e.css("left","").css("right","").css("top","").css("bottom","").css("width","").css("height","")}_clearCustomColourCss(e){e.css("background-color","").css("border-color","").css("color","")}_setIconColourCss(){this._liveUpdatedIcons&&($(".oracle-live-mainbutton-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-mainbutton-badge").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-buttonbar-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-exitbutton-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-video-maximize").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-unfreeze-annotation-camera").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-unfreeze-annotation-cross").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-video-panel-channel-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-callinfo-channel-icon").css("background-image",this._liveUpdatedIcons.icons),$(".oracle-live-callinfo-maximize-icon").css("background-image",this._liveUpdatedIcons.icons))}_setCustomColourCssMinMax(e=this.isFullScreen()){if(this._customization){const t=$(".oracle-live"),i=$(".oracle-live-video-toolbar-minimized"),o=$(".oracle-live-video-toolbar-maximized"),s=$(".oracle-live-video-toolbar-enduser"),n=$(".oracle-live-video-toolbar-associate"),a=$(".oracle-live-video-toolbar-screenshare"),r=$(".oracle-live-callinfo-toolbar"),l=$(".oracle-live-video-panel-channel-icon");this._clearCustomColourCss(i),this._clearCustomColourCss(o),s.removeClass("oracle-live-video-toolbar-minimized"),n.removeClass("oracle-live-video-toolbar-minimized"),a.removeClass("oracle-live-video-toolbar-minimized"),r.removeClass("oracle-live-video-toolbar-minimized"),s.removeClass("oracle-live-video-toolbar-maximized"),n.removeClass("oracle-live-video-toolbar-maximized"),a.removeClass("oracle-live-video-toolbar-maximized"),r.removeClass("oracle-live-video-toolbar-maximized"),e?t.hasClass("oracle-live-video-enduser-maximized")?(s.addClass("oracle-live-video-toolbar-maximized"),n.addClass("oracle-live-video-toolbar-minimized"),a.addClass("oracle-live-video-toolbar-minimized"),r.addClass("oracle-live-video-toolbar-minimized")):t.hasClass("oracle-live-video-associate-maximized")?(n.addClass("oracle-live-video-toolbar-maximized"),s.addClass("oracle-live-video-toolbar-minimized"),a.addClass("oracle-live-video-toolbar-minimized"),r.addClass("oracle-live-video-toolbar-minimized")):t.hasClass("oracle-live-screenshare-associate-maximized")?(a.addClass("oracle-live-video-toolbar-maximized"),s.addClass("oracle-live-video-toolbar-minimized"),n.addClass("oracle-live-video-toolbar-minimized"),r.addClass("oracle-live-video-toolbar-minimized")):t.hasClass("oracle-live-callinfo-maximized")&&(r.addClass("oracle-live-video-toolbar-maximized"),s.addClass("oracle-live-video-toolbar-minimized"),n.addClass("oracle-live-video-toolbar-minimized"),a.addClass("oracle-live-video-toolbar-minimized")):(s.addClass("oracle-live-video-toolbar-minimized"),n.addClass("oracle-live-video-toolbar-minimized"),a.addClass("oracle-live-video-toolbar-minimized"),r.addClass("oracle-live-video-toolbar-minimized")),this._customization.maximizedTopBarBackgroundColour&&$(".oracle-live-video-toolbar-maximized:not(.oracle-live-unfreeze-annotation-camera):not(.oracle-live-unfreeze-annotation-cross)").css("background-color",this._customization.maximizedTopBarBackgroundColour).css("border-color",this._customization.maximizedTopBarBackgroundColour),this._customization.maximizedTopBarFontColour&&(o.css("color",this._customization.maximizedTopBarFontColour),l.css("color",this._customization.maximizedTopBarFontColour)),i.css("color","white"),$(".oracle-live-video-maximize").css("background-color","transparent").css("border-color","transparent"),$(".oracle-live-video-associate-maximized-title").css("background-color","transparent").css("border-color","transparent"),$(".oracle-live-video-toolbar-recording").css("background-color","transparent").css("border-color","transparent"),$(".oracle-live-video-inline-recording").css("background-color","transparent").css("border-color","transparent"),$(".oracle-live-video-toolbar-info").css("background-color","transparent").css("border-color","transparent"),$(".oracle-live-video-toolbar-timer").css("background-color","transparent").css("border-color","transparent"),l.css("background-color","transparent").css("border-color","transparent")}}_setButtonBarButtonColourCss(e,t,i){this._customization&&(t||i?t&&!i?e.css("background-color",this._customization.menuButtonInverseBackgroundColour).css("border-color",this._customization.menuButtonInverseBackgroundColour):i&&e.css("background-color",this._customization.menuButtonDisabledBackgroundColour).css("border-color",this._customization.menuButtonDisabledBackgroundColour):e.css("background-color",this._customization.menuButtonDefaultBackgroundColour).css("border-color",this._customization.menuButtonDefaultBackgroundColour))}_defineCustomPosition(){if(!this._positionsDefined&&this._customization){if(this._vertpx=12,this._horzpx=12,this._vertpn="bottom",this._horzpn="right",this._customization.pinnedTo&&this._customization.pinnedTo.indexOf("-")>-1){let e=this._customization.pinnedTo.split("-");this._vertpn=e[0],this._horzpn=e[1]}this._customization.verticalMargin&&(this._vertpx=parseInt(this._customization.verticalMargin),isNaN(this._vertpx)&&(this._vertpx=12)),this._customization.horizontalMargin&&(this._horzpx=parseInt(this._customization.horizontalMargin),isNaN(this._horzpx)&&(this._horzpx=12)),console.log("Custom _vertpx",this._vertpx),console.log("Custom _horzpx",this._horzpx),console.log("Custom _vertpn",this._vertpn),console.log("Custom _horzpn",this._horzpn),this._positionsDefined=!0}}_setDialogButtonColourCss(e,t,i){this._customization&&(t?i?e.css("background-color",this._customization.dialogPrimaryButtonInverseBackgroundColour).css("border-color",this._customization.dialogPrimaryButtonInverseBorderColour).css("color",this._customization.dialogPrimaryButtonInverseFontColour):e.css("background-color",this._customization.dialogPrimaryButtonBackgroundColour).css("border-color",this._customization.dialogPrimaryButtonBorderColour).css("color",this._customization.dialogPrimaryButtonFontColour):i?e.css("background-color",this._customization.dialogSecondaryButtonInverseBackgroundColour).css("border-color",this._customization.dialogSecondaryButtonInverseBorderColour).css("color",this._customization.dialogSecondaryButtonInverseFontColour):e.css("background-color",this._customization.dialogSecondaryButtonBackgroundColour).css("border-color",this._customization.dialogSecondaryButtonBorderColour).css("color",this._customization.dialogSecondaryButtonFontColour))}_setButtonBarEndButtonColourCss(e,t){this._customization&&(e||t?e&&!t?$(".oracle-live-exit-button").css("background-color",this._customization.menuEndButtonInverseBackgroundColour).css("border-color",this._customization.menuEndButtonInverseBackgroundColour):t&&$(".oracle-live-exit-button").css("background-color",this._customization.menuButtonDisabledBackgroundColour).css("border-color",this._customization.menuButtonDisabledBackgroundColour):$(".oracle-live-exit-button").css("background-color",this._customization.menuEndButtonDefaultBackgroundColour).css("border-color",this._customization.menuEndButtonDefaultBackgroundColour))}_setButtonBarEndButtonIconCss(e){this._customization&&(e?$(".oracle-live-exitbutton-icon").css("background-position-x","-7px").css("background-position-y","-728px").css("width","20px").css("height","16px"):$(".oracle-live-exitbutton-icon").css("background-position-x","-7px").css("background-position-y","-688px").css("width","20px").css("height","16px"))}_setCustomPositionCssMinMax(e=this.isFullScreen()){const t=$(".oracle-live");if(e?t.addClass("oracle-live-video-panel-maximized"):t.removeClass("oracle-live-video-panel-maximized"),this._customization){console.log("_setCustomPositionCssMinMax",e),this._defineCustomPosition();const i=$(".oracle-live-video-panel"),o=$(".oracle-live-menu");if(e)i.removeClass("oracle-live-video-panel-minimized"),this._clearCustomPositionCss(i),i.addClass("oracle-live-video-panel-maximized"),this._clearCustomPositionCss($(".oracle-live-menu")),$(".oracle-live-menu-rightspacer").hide(),$(".oracle-live-menu-leftspacer").hide(),this._clearCustomPositionCss($(".oracle-live-dialog")),this._reverseButtonBar();else{i.removeClass("oracle-live-video-panel-maximized"),this._clearCustomPositionCss(i),i.addClass("oracle-live-video-panel-minimized"),this._clearCustomPositionCss(o);let e="",s="",n="",a="",r="",l="",c="",d="",u="",h="",g="",m="",p="",v="",S="",_="",f="",C="",b="",E="",R="",A="",T="",y="",I="",w="";const k=$(".oracle-live-menu-rightspacer"),L=$(".oracle-live-menu-leftspacer");"left"===this._horzpn?(k.hide(),L.show(),L.css("display","inline-block"),e=this._horzpx+38+"px",s="unset",r=this._horzpx+10+"px",l=e,e=this._horzpx+238+"px",s="unset",c=this._horzpx+206+"px",d="unset",g=this._horzpx+216+"px",m="unset",S=this._horzpx+"px",_="unset",b=this._horzpx+10+"px",E="unset",T=this._horzpx+"px",y="unset",this._reverseButtonBar()):(k.show(),k.css("display","inline-block"),L.hide(),e="unset",s=this._horzpx+38+"px",r=this._horzpx+10+"px",l=s,c="unset",d=this._horzpx+232+"px",g="unset",m=this._horzpx+242+"px",S="unset",_=this._horzpx+"px",b="unset",E=this._horzpx+242+"px",T="unset",y=this._horzpx+"px"),"top"===this._vertpn?(n=this._vertpx+18+"px",a="unset",u=this._vertpx+70+"px",h="unset",p=this._vertpx+68+"px",v="unset",f=this._vertpx+100+"px",C="unset",R=this._vertpx+278+"px",A="unset",I=this._vertpx+95+"px",w="unset"):(n="unset",a=this._vertpx+18+"px",u="unset",h=this._vertpx+68+"px",p="unset",v=this._vertpx+66+"px",f="unset",C=this._vertpx+100+"px",R="unset",A=this._vertpx+110+"px",I="unset",w=this._vertpx+95+"px");let O=document.querySelector(".oracle-live-menu");if(O){let e=document.getElementById("oracle-live-menu-animation"),t=document.createElement("style");t.id="oracle-live-menu-animation",t.textContent="@keyframes oracle-live-buttonmenu-show-keyframes {0% { opacity: 0; "+this._horzpn+": "+r+"; width: 0px } 100% { opacity: 1; "+this._horzpn+" : "+l+"; width: fit-content } }\n@keyframes oracle-live-buttonmenu-hide-keyframes {0% { opacity: 1; "+this._horzpn+": "+l+"; width: fit-content } 100% { opacity: 0; "+this._horzpn+": "+r+"; width: 0px } }",e&&e.parentNode.removeChild(e),O.appendChild(t)}$(".oracle-live-menu").css("left",e).css("right",s).css("top",n).css("bottom",a).css("width","fit-content").css("overflow","hidden"),$(".oracle-live-menu-more").css("left",c).css("right",d).css("top",u).css("bottom",h).css("width","fit-content").css("overflow","hidden"),document.body.style.setProperty("--menu-more-after-top",p),document.body.style.setProperty("--menu-more-after-left",g),document.body.style.setProperty("--menu-more-after-right",m),document.body.style.setProperty("--menu-more-after-bottom",v),t.hasClass("oracle-live-video-associate-on")&&t.hasClass("oracle-live-video-enduser-on")||t.hasClass("oracle-live-screenshare-associate-on")&&t.hasClass("oracle-live-video-enduser-on")?$(".oracle-live-video-panel-enduser").css("left",b).css("right",E).css("top",R).css("bottom",A):$(".oracle-live-video-panel-enduser").css("left",S).css("right",_).css("top",f).css("bottom",C),$(".oracle-live-video-panel-associate").css("left",S).css("right",_).css("top",f).css("bottom",C),$(".oracle-live-dialog").css("left",T).css("right",y).css("top",I).css("bottom",w)}}else{let e=document.querySelector(".oracle-live-menu");if(e){let t=document.getElementById("oracle-live-menu-animation"),i=document.createElement("style");i.id="oracle-live-menu-animation",i.textContent="@keyframes oracle-live-buttonmenu-show-keyframes {0% { opacity: 0; right: 0px; width: 0px } 100% { opacity: 1; right: 58px; width: fit-content } }\n@keyframes oracle-live-buttonmenu-hide-keyframes {0% { opacity: 1; right: 58px; width: fit-content } 100% { opacity: 0; right: 0px; width: 0px } }",t&&t.parentNode.removeChild(t),e.appendChild(i)}}}_reverseButtonBar(){this._customization&&"left"===this._horzpn&&0!==$(".oracle-live-menu [role='button']").length&&($(".oracle-live").hasClass("oracle-live-video-panel-maximized")?"Reversed"===this._buttonBarReversed&&(this._reverseLiveMenu(),this._reverseLiveMenuMore(),this._buttonBarReversed="Default"):"Default"===this._buttonBarReversed&&(this._reverseLiveMenu(),this._reverseLiveMenuMore(),this._buttonBarReversed="Reversed"))}_reverseLiveMenu(){let e=$(".oracle-live-menu [role='button']");const t=$(".oracle-live-menu-leftspacer"),i=$(".oracle-live-menu-rightspacer");$(".oracle-live-menu").append(t);for(let t=e.length-1;t>=0;t--)$(".oracle-live-menu").append(e[t]);$(".oracle-live-menu").append(i)}_reverseLiveMenuMore(){let e=$(".oracle-live-menu-more [role='button']");for(let t=e.length-1;t>=0;t--)$(".oracle-live-menu-more").append(e[t])}_setCustomCssMinMax(e=this.isFullScreen()){this._setCustomPositionCssMinMax(e),this._setCustomColourCssMinMax(e)}_setHover(e,t,i,o,s,n,a,r,l,c,d,u){e.mouseenter(()=>{"true"!==e.attr("aria-disabled")&&(i&&e.css("background-color",i).css("border-color",i),o&&(l>=0&&o.css("background-position-x",-1*l+"px"),c>=0&&o.css("background-position-y",-1*c+"px"),d>=0&&o.css("width",d+"px"),u>=0&&o.css("height",u+"px")))}),e.mouseleave(()=>{"true"!==e.attr("aria-disabled")&&(t&&e.css("background-color",t).css("border-color",t),o&&(s>=0&&o.css("background-position-x",-1*s+"px"),n>=0&&o.css("background-position-y",-1*n+"px"),a>=0&&o.css("width",a+"px"),r>=0&&o.css("height",r+"px")))}),e.keypress(()=>{e.mouseenter()})}_setCustomPositionCss(){if(this._customization){this._defineCustomPosition();let e="",t="",i="",o="",s="",n="",a="",r="",l="",c="",d="",u="",h="",g="",m="",p="",v="";"left"===this._horzpn?(e=this._horzpx+"px",t="unset",s=this._horzpx+92+"px",n="unset",c=this._horzpx+"px",d="unset",g=this._horzpx+"px",m="unset"):(e="unset",t=this._horzpx+"px",s="unset",n=this._horzpx+92+"px",c="unset",d=this._horzpx+"px",g="unset",m=this._horzpx+"px"),"top"===this._vertpn?(i=this._vertpx+"px",o="unset",a=this._vertpx+40+"px",r="unset",l="translate(0, -50%)",u=this._vertpx+100+"px",h="unset",p=this._vertpx+100+"px",v="unset"):(i="unset",o=this._vertpx+"px",a="unset",r=this._vertpx+40+"px",l="translate(0, 50%)",u="unset",h=this._vertpx+100+"px",p="unset",v=this._vertpx+100+"px"),$(".oracle-live-main-button").css("left",e).css("right",t).css("top",i).css("bottom",o),$(".oracle-live-popmessage").css("left",s).css("right",n).css("top",a).css("bottom",r).css("transform",l).css("-ms-transform",l),$(".oracle-live-callinfo").css("left",c).css("right",d).css("top",u).css("bottom",h),$(".oracle-live-call-queue-info").css("left",g).css("right",m).css("top",p).css("bottom",v),this._setCustomPositionCssMinMax(!1)}}_setMainButtonColourCss(e){if(this._customization){let t=!1,i=!1;const o=$(".oracle-live");o.hasClass("oracle-live-precall-dialog")||o.hasClass("oracle-live-video-preview")||o.hasClass("oracle-live-shortcode")||o.hasClass("oracle-live-connecting")||o.hasClass("oracle-live-transferring")||o.hasClass("oracle-live-waiting")||o.hasClass("oracle-live-disconnected")?(t=!0,i=!0):$(".oracle-live").hasClass("oracle-live-connected")||(t=!0,e&&(i=!0)),t?i?($(".oracle-live-main-button").css("background-color",this._customization.mainButtonInitialInverseBackgroundColour).css("border-color",this._customization.mainButtonInitialInverseBackgroundColour),$(".oracle-live-mainbutton-icon").css("background-position-y","-50px")):($(".oracle-live-main-button").css("background-color",this._customization.mainButtonInitialBackgroundColour).css("border-color",this._customization.mainButtonInitialBackgroundColour),$(".oracle-live-mainbutton-icon").css("background-position-y","-8px")):($(".oracle-live-main-button").css("background-color",this._customization.mainButtonInlineBackgroundColour).css("border-color",this._customization.mainButtonInlineBackgroundColour).css("color",this._customization.mainButtonInlineFontColour),$(".oracle-live-mainbutton-initials").css("color",this._customization.mainButtonInlineFontColour))}}_setCustomColourCss(){if(this._customization){const e=$(".oracle-live");this._customization.initialMessageBackgroundColour&&$(".oracle-live-popmessage").css("background-color",this._customization.initialMessageBackgroundColour).css("border-color",this._customization.initialMessageBackgroundColour),this._customization.initialMessageFontColour&&($(".oracle-live-popmessage").css("color",this._customization.initialMessageFontColour),$(".oracle-live-popmessage-text").css("color",this._customization.initialMessageFontColour),$(".oracle-live-popmessage-shortcode").css("color",this._customization.initialMessageFontColour)),this._customization.infoPanelBackgroundColour&&($(".oracle-live-callinfo").css("background-color",this._customization.infoPanelBackgroundColour).css("border-color",this._customization.infoPanelBackgroundColour),$(".oracle-live-call-queue-info").css("background-color",this._customization.infoPanelBackgroundColour).css("border-color",this._customization.infoPanelBackgroundColour)),this._customization.infoPanelFontColour&&($(".oracle-live-callinfo").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-associate").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-recording").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-channel-icon").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-maximize-icon").css("color",this._customization.infoPanelFontColour),$(".oracle-live-callinfo-timer").css("color",this._customization.infoPanelFontColour),$(".oracle-live-call-queue-info").css("color",this._customization.infoPanelFontColour),$(".oracle-live-position-in-queue").css("color",this._customization.infoPanelFontColour)),this._customization.buttonBarBackgroundColour&&($(".oracle-live-menu").css("background-color",this._customization.buttonBarBackgroundColour).css("border-color",this._customization.buttonBarBackgroundColour),$(".oracle-live-menu-more").css("background-color",this._customization.buttonBarBackgroundColour).css("border-color",this._customization.buttonBarBackgroundColour),document.body.style.setProperty("--menu-more-after-background-color",this._customization.buttonBarBackgroundColour)),this._customization.menuButtonDefaultBackgroundColour&&$(".oracle-live-buttonbar-button").css("background-color",this._customization.menuButtonDefaultBackgroundColour).css("border-color",this._customization.menuButtonDefaultBackgroundColour),this._customization.menuEndButtonDefaultBackgroundColour&&($(".oracle-live-exit-button").css("background-color",this._customization.menuEndButtonDefaultBackgroundColour).css("border-color",this._customization.menuEndButtonDefaultBackgroundColour),this._customization.menuEndButtonInverseBackgroundColour&&(this._setHover($(".oracle-live-exit-button"),this._customization.menuEndButtonDefaultBackgroundColour,this._customization.menuEndButtonInverseBackgroundColour,$(".oracle-live-exitbutton-icon"),7,688,20,16,7,708,20,16),$(".oracle-live-exit-button").click(()=>{this._setButtonBarEndButtonIconCss(!0)}),$(".oracle-live-dialog-cancel").click(()=>{this._setButtonBarEndButtonIconCss(!1)}),this._okButton.click(()=>{e.hasClass("oracle-live-disconnected")||e.hasClass("oracle-live-disconnecting")||this._setButtonBarEndButtonIconCss(!1)}))),this._customization.dialogPrimaryButtonBackgroundColour&&this._okButton.css("background-color",this._customization.dialogPrimaryButtonBackgroundColour),this._customization.dialogPrimaryButtonBorderColour&&this._okButton.css("border-color",this._customization.dialogPrimaryButtonBorderColour),this._customization.dialogPrimaryButtonFontColour&&this._okButton.css("color",this._customization.dialogPrimaryButtonFontColour),this._customization.dialogSecondaryButtonBackgroundColour&&$(".oracle-live-dialog-cancel").css("background-color",this._customization.dialogSecondaryButtonBackgroundColour),this._customization.dialogSecondaryButtonBorderColour&&$(".oracle-live-dialog-cancel").css("border-color",this._customization.dialogSecondaryButtonBorderColour),this._customization.dialogSecondaryButtonFontColour&&$(".oracle-live-dialog-cancel").css("color",this._customization.dialogSecondaryButtonFontColour);let t=(e,t,i)=>{this._setDialogButtonColourCss(e,t,i)};const i=this._okButton;i.mousedown(e=>{1===e.which&&t(i,!0,!0)}),i.mouseleave(()=>{t(i,!0,!1)});const o=$(".oracle-live-dialog-cancel");o.mousedown(e=>{1===e.which&&t(o,!1,!0)}),o.mouseleave(()=>{t(o,!1,!1)})}this._setButtonBarEndButtonIconCss(!1),this._setCustomColourCssMinMax(!1)}_setIconColour(){this._customization&&(this._liveUpdatedIcons?this._setIconColourCss():new Promise((e,t)=>{let i=$(".oracle-live-mainbutton-icon").css("background-image");i&&(this._liveUpdatedIcons=new n(i,this._iconColours,e,t))}).then(e=>{this._setIconColourCss()}).catch(e=>{console.error("Error updating icons:",e),this._liveUpdatedIcons=null}))}_customize(){if(console.log("_customize",this._customization),this._customization){this._iconColours=this._customization.iconColours,this._setIconColour(),this._setMainButtonColourCss(!1),this._setCustomColourCss(),this._setCustomPositionCss();const e=$(".oracle-live-main-button");let t=e=>{this._setMainButtonColourCss(e)};e.mouseenter(()=>{t(!0)}),e.mouseleave(()=>{t(!1)})}else $(".oracle-live-menu-leftspacer").hide()}_populateMessages(){this._greetingMessage=this._messages.application_universal_message_welcome,this._connectingMessage=this._messages.application_universal_message_connecting_next_associate,this._messages.application_universal_message_transferring_to_another_associate||(this._messages.application_universal_message_transferring_to_another_associate="We are transferring you to another associate..."),this._transferringMessage=this._messages.application_universal_message_transferring_to_another_associate,this._meetingTitle=this._messages.application_meeting_label_title,$(".oracle-live-dialog-cancel").text(this._messages.application_universal_button_cancel).prop("title",this._messages.application_universal_button_cancel),this._okButton.text(this._messages.application_universal_button_yes).prop("title",this._messages.application_universal_button_yes),$(".oracle-live-dialog-question").text(this._messages.application_universal_message_service_quality_rating),$(".oracle-live-dialog-option-poor label").text(this._messages.application_universal_label_service_quality_bad),$(".oracle-live-dialog-option-poor").prop("title",this._messages.application_universal_label_service_quality_bad),$(".oracle-live-dialog-option-good label").text(this._messages.application_universal_label_service_quality_good),$(".oracle-live-dialog-option-good").prop("title",this._messages.application_universal_label_service_quality_good),$(".oracle-live-dialog-option-excellent label").text(this._messages.application_universal_label_service_quality_excellent),$(".oracle-live-dialog-option-excellent").prop("title",this._messages.application_universal_label_service_quality_excellent),$(".oracle-live-cancel-button").text(this._messages.application_universal_button_cancel),$(".oracle-live-rejoin-button").text(this._messages.application_universal_button_rejoin),$(".oracle-live-exit-button").prop("title",this._messages.application_universal_tooltip_end_call),$(".oracle-live-video-closeall").prop("title",this._messages.application_video_call_tooltip_hide),$(".oracle-live-video-closelocal").prop("title",this._messages.application_video_call_tooltip_hide_local_video),$(".oracle-live-poor-video-connection-text").text(this._messages.application_universal_title_poor_connection),$(".oracle-live-position-in-queue-label").text(this._messages.application_universal_label_position_in_queue).attr("aria-label",this._messages.application_universal_label_position_in_queue),$(".oracle-live-main-button").attr("aria-label",this._messages.application_universal_label_main_button),$(".oracle-live-swap-camera").prop("title",this._messages.application_universal_button_switch_camera).attr("aria-label",this._messages.application_universal_button_switch_camera),this._setChannelIconText()}showComponent(){console.log("LiveButtonMenu: showComponent"),this._impl.dispatchEvent(i.LiveProgressIndicator,!1),$(".oracle-live").removeClass("oracle-live-hidden")}hideEndCallButton(){$(".oracle-live-exit-button").hide()}hidePauseResumeButton(){$(".oracle-live-pause-button").hide()}hideQueueLengthIndicator(e){const t=$(".oracle-live-call-queue-info");e||!0===this._shortCodeMode?t.addClass("oracle-live-hide-queue-info"):t.removeClass("oracle-live-hide-queue-info")}hideComponent(){$(".oracle-live").addClass("oracle-live-hidden")}setIdle(){console.log("LiveButtonMenu::setIdle"),this._idle=!0,this.setAssociateName(""),this._avatarImageUrl=null,this._callTimer.resetTimer(),this._enableZoom(!1),this._liveZoom=null,this._shortCode=null,this.setPopMessageText(this._greetingMessage,null),this.setPopMessageAriaDisabled(!1);const e=$(".oracle-live"),t=e.hasClass("oracle-live-cancelled");this.resetClass("oracle-live"),t&&e.addClass("oracle-live-cancelled"),!0===this._startInVideo?e.addClass("oracle-live-start-in-video"):e.removeClass("oracle-live-start-in-video"),!0===this._startInScreenShare?e.addClass("oracle-live-start-in-screenshare"):e.removeClass("oracle-live-start-in-screenshare"),$(".oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_minimize_video),$(".oracle-live-callinfo-maximize-icon").prop("title",this._messages.application_audio_call_tooltip_maximize_callinfo),$(".oracle-live-recording").attr("aria-label",this._messages.application_universal_label_recording),$(".oracle-live-video-associate-maximized-title").attr("tabindex",0),this._isMeeting&&e.addClass("oracle-live-cancelled"),!0===this._usingExternalAudio?e.addClass("oracle-live-external-audio"):e.removeClass("oracle-live-external-audio"),this._setChannelIconText(),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}showStartCallDialog(e){e?($(".oracle-live").addClass("oracle-live-precall-dialog"),this._setDialogMessage(this._messages.application_universal_title_request_for_recording),$(".oracle-live-main-button").attr("aria-disabled","true"),this._showConfirmDialog()):($(".oracle-live").removeClass("oracle-live-precall-dialog").removeClass("oracle-live-show-dialog"),$(".oracle-live-main-button").attr("aria-disabled","false")),this._setMainButtonColourCss(!1)}countryListItemSelect(e){console.log("event: ",e);let t=e.target.dataset.countryCode,i=e.target.text;if(!t)return console.warn("country code not initialised"),console.log(e.target),void console.log(e.target.dataset);console.log("country: "+i),console.log("country code: "+t),document.getElementById("phone-number-country-code").value=t,document.getElementById("phone-number-digits").focus()}populateCountryCodes(){console.log("populateCountryCodes");let e=document.getElementById("phone-number-country-list");this._thisCallbackInputInitialized||(this._thisCallbackInputInitialized=!0,e.innerHTML="",o.CountryCodes.forEach(t=>{let i=document.createElement("li");i.setAttribute("class","country-item"),i.setAttribute("id","oracle-live-country-item-"+t[1].substring(30)),console.log("Country: "+t[0]+", "+t[1].substring(30)),t[0]&&0!==t[0].length||console.warn("Country code not initialised: "+t[0]),i.addEventListener("click",this.countryListItemSelect),e.appendChild(i),i.innerHTML=i.innerHTML+'<a tabindex="0" class="phone-number-country-selector" data-country-code="+'+t[0]+'" id="phone-number-country-'+t[1].substring(30)+'" class="phone-number-country-'+t[0]+" phone-number-country-"+t[1].substring(30)+'">'+this._messages[t[1]]+" +"+t[0]+"</a>"}),e.focus(),this.initFocusOut())}showAllCountriesInCountrySelector(){o.CountryCodes.forEach(e=>{const t=e[1].substring(30);let i=$("#oracle-live-country-item-"+t);i.hasClass("country-item-hidden")&&i.removeClass("country-item-hidden")})}showCountryCodesList(){this.populateCountryCodes(),this.showAllCountriesInCountrySelector(),$(".oracle-live").hasClass("oracle-live-country-select")?$(".oracle-live").removeClass("oracle-live-country-select"):$(".oracle-live").addClass("oracle-live-country-select")}setFilterOnInput(e,t,i){["keydown","keyup","mousedown","mouseup","input","select"].forEach(o=>{console.log("Adding event listener for: "+o),e.addEventListener(o,o=>{t(e.value)?(e.oldValue=e.value,e.oldSelectionStart=e.selectionStart,e.oldSelectionEnd=e.selectionEnd):e.hasOwnProperty("oldValue")?(e.value=e.oldValue,e.setSelectionRange(e.oldSelectionStart,e.oldSelectionEnd)):e.value="",i&&i(o,e.value)})})}initFocusOut(){let e=e=>{const t=document.getElementById("phone-number-country-input-container"),i=document.getElementById("phone-number-country-list");t.id!==e.target.id&&i.id!==e.target.id&&(console.log("Focus out dropdown: e.target.id = "+e.target.id),$(".oracle-live").hasClass("oracle-live-country-select")&&$(".oracle-live").removeClass("oracle-live-country-select"))};document.removeEventListener("mouseup",e),document.addEventListener("mouseup",e)}validateCallbackPhoneNumber(e,t){if(e&&("+"===e||0===e.length))return this.showCallbackNumberValidationError(!0),!1;let i=e+t;if(i){const e="^\\+[1-9]\\d{9,14}$";let t=(i=i.replace("(","").replace(")","").replace("-","")).match(new RegExp(e));return console.log("Phone number match: "),console.log(t),t?(console.log("Phone number is valid"),this.showCallbackNumberValidationError(!1)):(console.log("Phone number is invalid"),this.showCallbackNumberValidationError(!0)),t}return this.showCallbackNumberValidationError(!1),!1}populateCallbackPhoneNumber(){const e=document.getElementById("oracle-live-phone-number-fields"),t=document.getElementById("phone-number-country-code"),i=document.getElementById("phone-number-digits"),s=document.getElementById("phone-number-digits-readonly");if(this._impl.haveCallbackNumber()){let e=this._impl.getCallbackNumber();console.log("Attempting to populate callback dialig with pre-configured number: "+e);let n=e;e.startsWith("+")?n=e.substring(1):e.startsWith("00")&&(n=e.substring(2)),o.CountryCodes.find(e=>{const o=e[0];if(n.startsWith(o))return t.value="+"+o,i.value=n.substring(o.length),console.log("Match on: "+this._messages[e[1]]),s.innerHTML="+"+o+n.substring(o.length),!0})||(console.log("Failed to match "+e+" against a country code"),e.startsWith("+")&&(t.value="+"),i.value=n,s.innerHTML="(+...) "+n)}const n=this._impl._behaviours.allowCallbackAlternateNumber;console.log("isEditable: "+n),t.disabled=!n,i.disabled=!n,document.getElementById("oracle-live-country-list-expand-icon").style.display=n?"block":"none",e&&(n&&e.classList.contains("oracle-live-phone-number-readonly")&&e.classList.remove("oracle-live-callback-phone-readonly"),n||e.classList.contains("oracle-live-phone-number-readonly")||e.classList.add("oracle-live-phone-number-readonly"))}showCallbackNumberValidationError(e){let t=$(".phone-number-digits-input-container"),i=$(".phone-number-digits-readonly"),o=document.getElementById("phone-number-digits-error-container");if(e){o.style.display="block",console.log("Phone number is invalid"),t.hasClass("phone-number-digits-validation-error")||t.addClass("phone-number-digits-validation-error"),i.hasClass("phone-number-digits-validation-error")||i.addClass("phone-number-digits-validation-error");let e=document.getElementById("phone-number-digits-error-title"),s=document.getElementById("phone-number-digits-error-action");e.innerHTML=this.messages.application_universal_call_message_incorrect_value,s.innerHTML=this.messages.application_universal_call_message_incorrect_value_action}else o.style.display="none",t.hasClass("phone-number-digits-validation-error")&&t.removeClass("phone-number-digits-validation-error"),i.hasClass("phone-number-digits-validation-error")&&i.removeClass("phone-number-digits-validation-error")}showRequestCallbackDialog(e){console.log("showRequestCallbackDialog"),this._timedDialogTimer&&(console.log("A timed dialog is showing, so cancel it before showing our dialog"),clearTimeout(this._timedDialogTimer),this._timedDialogTimer=null),this._isCallbackDialogVisible=!0,this._inputPhoneNumber="",this._impl._callbackAlreadyOfferred=!0,document.getElementById("phone-number-digits").value="",this.validateCallbackPhoneNumber(null,null);let t=e||this._messages.application_universal_call_message_offer_callback_message;$(".oracle-live").addClass("oracle-live-callback-dialog"),$(".oracle-live-main-button").addClass("oracle-live-main-button-deemphasize"),this._setDialogMessage(t),$(".oracle-live-main-button").attr("aria-disabled","true"),document.getElementById("label-phone-number-country").innerHTML=this._messages.application_universal_label_country,document.getElementById("label-phone-number-digits").innerHTML=this._messages.application_universal_label_phone_number,this._inputListenersInitialized||(this._inputListenersInitialized=!0,this.setFilterOnInput(document.getElementById("phone-number-country-code"),e=>/^\+[0-9]*$|^$/.test(e),(e,t)=>{console.log("event: ",e),console.log("value: ",t)}),this.setFilterOnInput(document.getElementById("phone-number-digits"),e=>/^[0-9]*$/.test(e),(e,t)=>{console.log("event: ",e),console.log("value: ",t),8===e.keyCode&&this.validateCallbackPhoneNumber(null,null)})),this.populateCallbackPhoneNumber(),this._showConfirmDialog(!0)}getCallbackPhoneNumber(){return this._inputPhoneNumber=document.getElementById("phone-number-digits")?document.getElementById("phone-number-digits").value:"",this._inputPhoneNumber}getCallbackCountryCode(){return this._inputPhoneCountryCode=document.getElementById("phone-number-country-code")?document.getElementById("phone-number-country-code").value:"",this._inputPhoneCountryCode}hideRequestCallbackDialog(){console.log("hideRequestCallbackDialog"),this._isCallbackDialogVisible=!1,$(".oracle-live").removeClass("oracle-live-callback-dialog").removeClass("oracle-live-show-dialog"),$(".oracle-live-main-button").removeClass("oracle-live-main-button-deemphasize"),$(".oracle-live-main-button").attr("aria-disabled","false"),this._okButton.text(this._messages.application_universal_button_yes),$(".oracle-live-dialog-cancel").text(this._messages.application_universal_button_cancel),this._setMainButtonColourCss(!1),this._showCallInfo()}closeTimedDialog(){console.log("Close timed dialog"),console.log("_timedDialogTimer: "+this._timedDialogTimer),this._timedDialogTimer&&(console.log("Clearing _timedDialogTimer: "+this._timedDialogTimer),clearTimeout(this._timedDialogTimer),this._timedDialogTimer=null),$(".oracle-live").removeClass("oracle-live-show-dialog"),$(".oracle-live-main-button").attr("aria-disabled","false"),document.querySelector(".timed-dialog-hidden")&&$(".oracle-live-dialog").removeClass("timed-dialog-hidden")}showTimedDialog(e){console.log("showTimedDialog: _timedDialogTimer="+this._timedDialogTimer),this._setDialogMessage(e),this._showNotifyDialog(),this._timedDialogTimer&&(clearTimeout(this._timedDialogTimer),this._timedDialogTimer=null),this._timedDialogTimer=setTimeout(()=>this.fadeTimedDialog(),1e3*l),console.log("Setting _timedDialogTimer: "+this._timedDialogTimer),this._setMainButtonColourCss(!1)}fadeTimedDialog(){console.log("fadeTimedDialog"),$(".oracle-live-dialog").addClass("timed-dialog-hidden");let e=document.querySelector(".timed-dialog-hidden");const t=()=>{console.log("finishFade: remove transitionend listener"),e.removeEventListener("transitionend",t,!0),this.closeTimedDialog(),this._okButton.click(),this._timedDialogTimer&&(console.log("Clearing _timedDialogTimer: "+this._timedDialogTimer),clearTimeout(this._timedDialogTimer),this._timedDialogTimer=null)};e&&(console.log("fadeTimedDialog: add transitionend listener"),e.addEventListener("transitionend",t,!0)),this._setMainButtonColourCss(!1)}showMessagingPanel(e){console.log("showDialog: "+(e?"showing messaging dialog":"hiding messaging dialog")),e?(console.log("showing now"),this._oldFocus=document.activeElement,$(".oracle-live").addClass("oracle-live-show-messaging"),$(".oracle-live-dialog-close").focus()):(console.log("hiding now"),$(".oracle-live").removeClass("oracle-live-show-messaging"),this._oldFocus&&this._oldFocus.focus())}resetMessagingHistory(){this._messagingMsgId=1;const e=document.getElementById("oracle-live-messaging-messages");for(;e.firstChild;)e.removeChild(e.firstChild)}inChannelTextToHtml(e){let t,i,o,s;return i=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,o=/(^|[^\/])(www\.[\S]+(\b|$))/gim,s=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=(t=(t=(t=e.replace(i,'<a href="$1" target="_blank">$1</a>')).replace(o,'$1<a href="http://$2" target="_blank">$2</a>')).replace(s,'<a href="mailto:$1">$1</a>')).replace(/(?:\r\n|\r|\n)/g,"<br>")}handleInChannelMessage(e,t,i){console.log("handleInChannelMessage"),console.log("From: "+i),console.log("message: "+e),this.resetMessagingHistory();let o=this._messages.application_universal_in_channel_message_title;$(".oracle-live-messaging-header p").html(o||"Messaging");const s=document.createElement("div"),n=document.getElementById("oracle-live-messaging-messages");s.innerHTML='<div class="oracle-live-messaging-from" role="note" aria-labelledby="oracle-live-messaging-msg-id-'+this._messagingMsgId+'" aria-live="polite"><span id="oracle-live-messaging-msg-id-'+this._messagingMsgId+'">'+(t||t)+":</span>&nbsp;</div>",this._messagingMsgId++,s.innerHTML=s.innerHTML+'<div class="oracle-live-messaging-message" role="note" aria-labelledby="oracle-live-messaging-msg-id-'+this._messagingMsgId+'" aria-live="polite"><span id="oracle-live-messaging-msg-id-'+this._messagingMsgId+'">'+this.inChannelTextToHtml(e)+"</span></div>",n.appendChild(s),this._closeMessagingButton=$(".oracle-live-messaging-close"),this._closeMessagingButton.attr("aria-disabled","false").text(this._messages.application_universal_button_close).prop("title",this._messages.application_universal_button_close),this._closeMessagingButton.click(()=>{this.showMessagingPanel(!1)}),this.showMessagingPanel(!0),this._messagingMsgId++}setConfirmCallback(){this.showTimedDialog(this._messages.application_universal_call_message_confirm_callback_message)}setCallbackError(){this.showTimedDialog(this._messages.application_universal_call_message_callback_error_message)}setRequestingCallback(e){e?($(".oracle-live").addClass("oracle-live-requesting-callback"),$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_wait)):($(".oracle-live").removeClass("oracle-live-requesting-callback"),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_connecting),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(this._messages.application_universal_label_connecting)),this._setMainButtonColourCss(!1)}setDiagnostics(e,t){this._diagnosticsRunning=e,e?(console.log("LiveButtonMenu::setDiagnostics, type="+t),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(this._messages.application_diagnostic_label_checking),"video"===t?this.setPopMessageText(this._messages.application_diagnostics_message_mic_camera_check,null):this.setPopMessageText(this._messages.application_diagnostics_message_mic_check,null)):(!0===this._shortCodeMode?($(".oracle-live").addClass("oracle-live-shortcode"),console.log("Set the text to ",this._messages.application_short_code_message_provide_code),this.setPopMessageText(this._messages.application_short_code_message_provide_code,this._shortCode)):this.setPopMessageText(this._connectingMessage,null),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(this._messages.application_universal_label_waiting_for_associate)),this._setMainButtonColourCss(!1)}setScreenshareReady(e){console.log("Updating screenshare ready status: "+e);const t=$(".oracle-live"),i=t.hasClass("oracle-live-screeenshare-ready");!i&&e&&t.addClass("oracle-live-screeenshare-ready"),i&&!e&&t.removeClass("oracle-live-screeenshare-ready"),this._updateMenuButtons()}setCobrowseReady(e){console.log("Updating cobrowse ready status: "+e);const t=$(".oracle-live"),i=t.hasClass("oracle-live-cobrowse-ready");!i&&e&&t.addClass("oracle-live-cobrowse-ready"),i&&!e&&t.removeClass("oracle-live-cobrowse-ready"),this._updateMenuButtons()}setConnecting(e){console.log("setConnecting"),this._idle=!1,this._shortCode=e||null;const t=$(".oracle-live"),i=t.hasClass("oracle-live-video-preview"),o=t.hasClass("oracle-live-video-enduser-maximized");this.resetClass("oracle-live oracle-live-connecting"),this.setPopMessageAriaDisabled(!1),this._usingExternalAudio&&t.addClass("oracle-live-external-audio"),this._preCallIDCheck&&(console.log("Adding class oracle-live-preCallIDCheck-call-associate back in "),t.addClass("oracle-live-preCallIDCheck-call-associate")),!0===i&&(t.addClass("oracle-live-video-enduser-on"),!0===o&&(t.addClass("oracle-live-video-enduser-maximized"),$(".oracle-live-exit-button").attr("aria-disabled",!1))),null!==this._shortCode?!0===this._startInScreenShare?this.setPopMessageText(this._messages.application_short_code_message_provide_code,this._shortCode):this.setPopMessageText(this._messages.application_short_code_message_provide_code_audio,this._shortCode):this.setPopMessageText(this._connectingMessage,null),$(".oracle-live-video-panel-message").text(this._messages.application_universal_label_waiting_for_associate),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_waiting_for_associate),this._setTitle(),this._setMainButtonColourCss(!1),this._setChannelIconText()}setConnectingAudio(e){if(console.log("Setting connecting audio to "+e+" - browser is:",this._browser),this._isMeeting)return void console.log("Having nothing to do with connecting audio since this is a meeting call");if(navigator.userAgent.includes("iPad")||navigator.userAgent.includes("iPhone"))return void console.log("setConnectingAudio: since we are using mobile Safari - ignoring this request..");e||null===this._connectingAudioTimer||(clearInterval(this._connectingAudioTimer),this._connectingAudioTimer=null);const t=document.getElementById("connectingAudio");if(t){if(console.log("Obtained a connecting audio, display="+t.style.display,t),!e)return console.log("Pausing connecting audio"),void t.pause();t.src!==this._connectingAudioSrc&&(t.src=this._connectingAudioSrc);let i=function(e){e._diagnosticsRunning?console.log("Still running diagnostics, not playing connecting audio yet"):(console.log("Playing connecting audio"),t.play())};i(this),this._connectingAudioTimer=setInterval(()=>{i(this)},4e3)}else console.log("Unable to control connectingAudio file")}_setMeetingTitle(){let e="";if(this._isMeeting){e=this._meetingTitle;let t="";for(let e of this._impl._associates)t+=e.name+", ";""!==t&&(e=e+" ("+this._messages.application_meeting_label_with+" "+t.slice(0,-2)+")"),console.log('setMeetingTitle: "'+e+'"'),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(e),$(".oracle-live-video-panel .oracle-live-heading").text(e),$(".oracle-live-audio-panel [role='heading']").text(e),$(".oracle-live-video-associate-maximized-title").text(e).attr("aria-label",e),$(".current-associate").text(e).attr("aria-label",e)}}_setAssociateTitle(){let e="";this._agentName&&""!==this._agentName&&(e+=this._agentName),console.log('setAssociateTitle: "'+e+'"'),$(".oracle-live-video-associate-maximized-title").text(e).attr("aria-label",e),$(".current-associate").text(e).attr("aria-label",e),$(".oracle-live-video-associate-name").text(e).attr("arial-label",e)}_setEndUserTitle(){let e="";this._endUserName&&""!==this._endUserName&&(e+=this._endUserName),console.log('setEndUserTitle: "'+e+'"'),$(".oracle-live-video-end-user-maximized-title").text(e).attr("aria-label",e)}countRemoteVideos(){return $(".oracle-live-remote-video-container.oracle-live-streaming").length}isRemoteStreaming(e){return 0!==$(".oracle-live-remote-video-container.oracle-live-streaming[data-avid='"+e+"']").length}_setNumberOfParticipants(){this._numParticipants=1,this._impl._conversation&&this._impl._conversation.participants&&(this._numParticipants=this._impl._conversation.participants.size()),console.log("Number of participants: "+this._numParticipants),$(".oracle-live-remote-video-count").text(this._numParticipants)}_singleVideo(){this._streamingCurrentOnly(),this.countRemoteVideos()<2?$(".oracle-live-video-panel-associate").removeClass("oracle-live-multi-video"):$(".oracle-live-video-panel-associate").addClass("oracle-live-multi-video")}_streamingCurrentOnly(){$(".oracle-live-remote-video-container.oracle-live-video-current:not(.oracle-live-streaming)").removeClass("oracle-live-video-current")}_positionVideoLabelHeight(){const e=$(".oracle-live-video-panel-associate:not(.oracle-live-video-grid-single) .oracle-live-remote-video-container.oracle-live-streaming video");e.length>1&&e.each((e,t)=>{const i=t.videoWidth,o=t.videoHeight,s=t.clientWidth;let n=(t.clientHeight-o*(s/i))/2;n<=0?n=0:n+="px",$(t).siblings(".oracle-live-video-stream-label").css("top",n),$(t).siblings(".oracle-live-video-maximize-camera").css("top",n),$(t).siblings(".oracle-live-video-maximize-camera-backing").css("top",n)})}_setTitle(){let e=$(".oracle-live-video-current");if(e.length)this._agentName=e[0].dataset.name;else{let e=$(".oracle-live-streaming");e.length&&($(".oracle-live-remote-video-container:not(.oracle-live-video-off).oracle-live-streaming").first().addClass("oracle-live-video-current"),this._agentName=e[0].dataset.name)}this._singleVideo(),this._isMeeting?this._setMeetingTitle():this._setAssociateTitle(),this._setNumberOfParticipants(),this._setEndUserTitle()}setWaiting(e){this._setTitle(),e?($(".oracle-live").addClass("oracle-live-waiting"),$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_wait)):($(".oracle-live").removeClass("oracle-live-waiting"),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_connecting),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(this._messages.application_universal_label_connecting)),this._setMainButtonColourCss(!1)}setCancelled(e){e?($(".oracle-live").addClass("oracle-live-cancelled"),$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_left)):($(".oracle-live").removeClass("oracle-live-cancelled"),$(".oracle-live-audio-panel-message").text("")),this._setMainButtonColourCss(!1)}isPausedByAssociate(){return $(".oracle-live").hasClass("oracle-live-paused-associate")}setConnected(e){console.log("LiveButtonMenu::setConnected");const t=this.isPausedByAssociate();this._idle=!1;const i=$(".oracle-live"),o=i.hasClass("oracle-live-recording-on"),s=i.hasClass("oracle-live-video-enduser-on"),n=i.hasClass("oracle-live-video-enduser-maximized")||!0===this._shortCodeMode&&!0===this._startVideoInFullScreen&&0===this.countRemoteVideos(),a=i.hasClass("oracle-live-video-associate-maximized")&&!n&&this.countRemoteVideos();this.resetClass("oracle-live oracle-live-connected"),this._showCallInfo(),a&&this._maximizeAssociateVideo(!0),this.setPopMessageAriaDisabled(!0),!0===s&&(i.addClass("oracle-live-video-enduser-on"),n&&this._maximizeEndUserVideo(!0)),this._usingExternalAudio&&(i.addClass("oracle-live-external-audio"),i.addClass("oracle-live-hide-mute"),i.hasClass("oracle-live-callinfo-maximized")&&this._maximizeCallInfoAudio(!0)),this._preCallIDCheck&&(console.log("Adding class oracle-live-preCallIDCheck-call-associate back in "),i.addClass("oracle-live-preCallIDCheck-call-associate")),this._endUserControlsCamera&&i.addClass("oracle-live-video-control-enduser"),this._endUserControlsScreenShare&&i.addClass("oracle-live-screenshare-control-enduser"),this._endUserControlsCobrowse&&i.addClass("oracle-live-cobrowse-control-enduser"),this._startInScreenShare&&i.addClass("oracle-live-hide-mute"),this._impl.enableCobrowse(),e||this._callTimer.startTimer(),this._avatarImageUrl&&i.addClass("oracle-live-agent-image-loaded");let r=!1;for(let e of this._impl._av._localVideoStream)if(e[1].active)for(let t of e[1].getVideoTracks())if("[object MediaStreamTrack]"===t.toString()&&t.enabled){r=!0,console.log("Found active enabled local video: "+e[0]);break}r&&i.addClass("oracle-live-video-enduser-on"),this.countRemoteVideos()>0&&i.addClass("oracle-live-video-associate-on"),this._setTitle(),e&&(this._resumeConnectedStatus=!0),this._setChannelIconText(),this._updateMenuButtons(),this._setMainButtonColourCss(!1),t&&(console.log("Maintaining pause after setConnected..."),this.setPausedByAssociate(!0)),o&&i.addClass("oracle-live-recording-on"),this._endUserName=this._impl.contextAttributes.get("fullName")||""}setDisconnecting(e){e?($(".oracle-live").addClass("oracle-live-disconnecting"),this._setDialogMessage(this._messages.application_universal_message_exit_session),this._showConfirmDialog()):($(".oracle-live").removeClass("oracle-live-disconnecting"),this._showDialog(!1)),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}setDisconnected(e,t){console.log("LiveButtonMenu::setDisconnected, feedback=",e,", error=",t),this._callTimer.stopTimer(),this._agentName="",this._endUserName="",this._setTitle(),this._isMeeting&&$(".oracle-live-audio-panel-message").text(this._messages.application_meeting_label_left),this.setEndUserAnnotationOn(!1);const o=$(".oracle-live");o.removeClass("oracle-live-cobrowse-enduser-on"),o.removeClass("oracle-live-connected"),o.addClass("oracle-live-disconnected"),o.hasClass("oracle-live-video-enduser-maximized")||o.hasClass("oracle-live-video-associate-maximized")||o.hasClass("oracle-live-screenshare-associate-maximized")||o.hasClass("oracle-live-callinfo-maximized")||this._setCustomCssMinMax(!1),o.removeClass("oracle-live-feedback");const s=$(".oracle-live-cancel-rejoin-buttons");if(this._canRejoinMeeting?(console.log("showing rejoin button"),s.hasClass("oracle-live-no-rejoin")&&s.removeClass("oracle-live-no-rejoin")):(console.log("hiding rejoin button"),s.hasClass("oracle-live-no-rejoin")||s.addClass("oracle-live-no-rejoin")),t){let e;o.addClass("oracle-live-error");let s=!1;t===i.LiveConnectingNoAnswer?(e=this._messages.application_universal_message_no_agent_available,s=!0):e=t===i.LiveConnectingError?this._messages.application_universal_message_failed_to_connect:t===i.LiveConnectingTeamBusy?this._messages.application_universal_message_team_busy:t===i.LiveDiagnosticsFailed?this._messages.application_diagnostics_message_failed:this._messages.application_universal_message_service_ended,s?this.showTimedDialog(e):(this._setDialogMessage(e),this._showNotifyDialog())}else this._setDialogMessage(this._messages.application_universal_message_service_ended),!0===e?(o.addClass("oracle-live-feedback"),this._showSubmitDialog()):this._showNotifyDialog();!0===this._startInVideo?o.addClass("oracle-live-start-in-video"):o.removeClass("oracle-live-start-in-video"),!0===this._startInScreenShare?o.addClass("oracle-live-start-in-screenshare"):o.removeClass("oracle-live-start-in-screenshare"),!0===this._usingExternalAudio?o.addClass("oracle-live-external-audio"):o.removeClass("oracle-live-external-audio"),this._setChannelIconText(),this._havePausedResumed=!1,this._updateMenuButtons(),this._setMainButtonColourCss(!1)}sessionEnded(){$(".oracle-live-main-button").focus(),this._removeActiveClasses()}setReconnectingEndUser(e){console.log("LiveButtonMenu::setReconnectingEndUser",e),!0===e?($(".oracle-live-notification").text(this._messages.application_universal_message_local_attempting_to_reconnect),$(".oracle-live").addClass("oracle-live-reconnecting-enduser")):($(".oracle-live-notification").text(this._messages.application_universal_message_local_reconnected),$(".oracle-live").removeClass("oracle-live-reconnecting-enduser")),this._showNotification(),this._updateMenuButtons()}showNotificationAssociateJoined(e){let t=this._messages.application_universal_message_multiparty_associate_joined;e?(t=t.replace("%s",e),this._lastAssociateJoined=e):this._lastAssociateJoined&&(t=t.replace("%s",this._lastAssociateJoined)),console.log(t),$(".oracle-live-notification").text(t),this._showNotification()}showNotificationAssociateLeft(e){let t=this._messages.application_universal_message_multiparty_associate_left;t=t.replace("%s",e),console.log(t),$(".oracle-live-notification").text(t),this._showNotification()}showNotificationAssociateNowHost(e){let t=this._messages.application_universal_message_multiparty_associate_now_host;const i=this._impl.getAssociateName(e);t=t.replace("%s",i||this._messages.application_universal_label_associate),console.log(t),$(".oracle-live-notification").text(t),this._showNotification()}setReconnectingAssociate(e){console.log("LiveButtonMenu::setReconnectingAssociate",e),!0===e?($(".oracle-live-notification").text(this._messages.application_universal_message_associate_disconnected),$(".oracle-live").addClass("oracle-live-reconnecting-associate"),this.restoreFromAnnotation()):($(".oracle-live-notification").text(this._messages.application_universal_message_associate_reconnected),$(".oracle-live").removeClass("oracle-live-reconnecting-associate")),this._showNotification(),this._updateMenuButtons()}showVideoPreview(e){console.log("LiveButtonMenu::showVideoPreview",e),this.setEndUserControlsCamera(e);const t=$(".oracle-live");if(e){this.setCancelled(!1),console.log("ADDING class video-preview"),t.addClass("oracle-live-video-preview"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(this._messages.application_diagnostic_label_video_preview),$(".oracle-live-preview-cancel-button").text(this._messages.application_universal_button_cancel).attr("aria-disabled","false");const e=t.hasClass("oracle-live-connected");$(".oracle-live-preview-start-button").text(this._messages.application_universal_button_share).attr("aria-disabled","false"),e&&!1===this.isRemoteVideoOn()&&!0===this._startVideoInFullScreen?this._maximizeEndUserVideo(!0):e||!0!==this._startVideoInFullScreen||!0===this._shortCodeMode?this._setCustomCssMinMax(!1):this._maximizeEndUserVideo(!0)}else console.log("REMOVING class video-preview"),t.removeClass("oracle-live-video-preview"),this._maximizeEndUserVideo(!1),this.setEndUserVideoOn(!1);this._updateMenuButtons(),this._setMainButtonColourCss(!1)}setEndUserVideoOn(e){console.log("setEndUserVideoOn=",e);const t=$(".oracle-live");t.removeClass("oracle-live-video-preview"),!0===e?(t.addClass("oracle-live-video-enduser-on"),this._setTitle(),!1===this._startVideoInFullScreen&&this._maximizeEndUserVideo(!1)):(this.setAssociateVideoAnnotationOn(!1),this._clearVideoAnnotations(),t.removeClass("oracle-live-video-enduser-on"),t.removeClass("oracle-live-annotation-associate-video-on")),this._updateMenuButtons(),this._setCustomCssMinMax(),this._setChannelIconText()}setAssociateVideoOn(e,t){console.log("LiveButtonMenu::setAssociateVideoOn: "+e+" for avid: "+t);const i=$(".oracle-live");if(!0===e)this._setNumberOfParticipants(),t&&($(".oracle-live-remote-video-container[data-avid='"+t+"']").removeClass("oracle-live-video-off"),console.log("Video container not paused: "+t)),0===$(".oracle-live-remote-video-container.oracle-live-video-off.oracle-live-streaming").length&&i.hasClass("oracle-live-video-enduser-on")&&i.hasClass("oracle-live-video-enduser-maximized")&&!this._havePausedResumed?i.hasClass("oracle-live-frozen-annotation")||i.hasClass("oracle-live-annotation-associate-video-on")||this._maximizeAssociateVideo(!0):!1===this.isVideoOn()&&!0===this._startVideoInFullScreen?this._maximizeAssociateVideo(!0):this._impl._isRehydratingMeetingCall()?this._maximizeAssociateVideo(!0):!this._isMeeting||i.hasClass("oracle-live-video-enduser-maximized")||i.hasClass("oracle-live-screenshare-associate-maximized")?this._numParticipants>2&&this._videoMaxStateBeforeOff?(this._previousMaximizedFeed=this._videoMaxStateBeforeOff,this._videoMaxStateBeforeOff=null):i.hasClass("oracle-live-video-enduser-on")||!1!==this._startVideoInFullScreen||this._maximizeAssociateVideo(!1):this._maximizeAssociateVideo(!0),i.addClass("oracle-live-video-associate-on");else if(t&&($(".oracle-live-remote-video-container[data-avid='"+t+"']").addClass("oracle-live-video-off"),console.log("Video container show pause: "+t)),0===$(".oracle-live-remote-video-container.oracle-live-streaming:not(.oracle-live-video-off)").length&&0===$(".oracle-live.oracle-live-paused-associate").length){const e=this.getMaximizedFeed(),t=i.hasClass("oracle-live-video-enduser-on")&&i.hasClass("oracle-live-video-associate-maximized");i.removeClass("oracle-live-video-associate-on"),this._maximizeAssociateVideo(!1),t&&(this._maximizeEndUserVideo(!0),this._videoMaxStateBeforeOff=e)}this._setCustomCssMinMax(),this._setTitle()}setVideoLoading(e){console.log("LiveButtonMenu::setVideoLoading=",e);const t=$(".oracle-live");e?t.addClass("oracle-live-video-loading"):(t.removeClass("oracle-live-video-loading"),this._resumeConnectedStatus&&(this._resumeConnectedStatus=!1,this.restoreFromAnnotation()))}setAssociateScreenShareOn(e){console.log("LiveButtonMenu::setAssociateScreenShareOn=",e);const t=$(".oracle-live");!0===e?(this._maximizedFeedWhenScreenShareAdded=this.getMaximizedFeed(),t.hasClass("oracle-live-video-enduser-on")&&t.hasClass("oracle-live-video-enduser-maximized")?this._maximizeAssociateScreenShare(!0):!1===this.isVideoOn()&&!0===this._startVideoInFullScreen&&this._maximizeAssociateScreenShare(!0),t.addClass("oracle-live-screenshare-associate-on"),this._setTitle()):(t.removeClass("oracle-live-screenshare-associate-on"),this._maximizeAssociateScreenShare(!1),"associateVideo"===this._maximizedFeedWhenScreenShareAdded?this._maximizeAssociateVideo(!0):"endUserVideo"===this._maximizedFeedWhenScreenShareAdded?this._maximizeEndUserVideo(!0):"callInfoPanel"===this._maximizedFeedWhenScreenShareAdded?this._maximizeCallInfoAudio(!0):this._maximizeAssociateVideo(!1)),this._updateMenuButtons(),this._setCustomCssMinMax()}setEndUserScreenShareOn(e){console.log("LiveButtonMenu::setEndUserScreenShareOn",e),!0===e?($(".oracle-live").addClass("oracle-live-screenshare-enduser-on"),document.getElementsByClassName("oracle-live-top-notify-stop-screenshare-message")[0].innerHTML=this._messages.application_universal_message_screen_share_tap_to_stop):(this.setEndUserAnnotationOn(!1),this.setAssociateAnnotationOn(!1),$(".oracle-live").removeClass("oracle-live-screenshare-enduser-on")),this._updateMenuButtons(),this._setChannelIconText()}setEndUserCobrowseOn(e){console.log("LiveButtonMenu::setEndUserCobrowseOn",e),!0===e?($(".oracle-live").addClass("oracle-live-cobrowse-enduser-on"),document.getElementsByClassName("oracle-live-top-notify-stop-cobrowse-message")[0].innerHTML=this._messages.application_universal_message_cobrowse_tap_to_stop):$(".oracle-live").removeClass("oracle-live-cobrowse-enduser-on"),this._updateMenuButtons(),this._setChannelIconText()}isEndUserAnnotationOn(){return $(".oracle-live").hasClass("oracle-live-annotation-enduser-on")}setEndUserAnnotationOn(e){console.log("setEndUserAnnotationOn:"+e);const t=$(".oracle-live");t.hasClass("oracle-live-annotation-associate-on")||(!0===e?(t.addClass("oracle-live-annotation-enduser-on"),this._addEndUserAnnotationSupport()):(t.removeClass("oracle-live-annotation-enduser-on"),this._removeAnnotationSupport()),this._updateMenuButtons())}setAssociateAnnotationOn(e){console.log("setAssociateAnnotationOn:"+e);const t=$(".oracle-live");if(!t.hasClass("oracle-live-annotation-enduser-on"))if(!0===e&&!0!==t.hasClass("oracle-live-annotation-associate-on")){let e=this._messages.application_video_call_message_remote_annotation_started;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),t.addClass("oracle-live-annotation-associate-on"),this._addAssociateAnnotationSupport(),this._updateMenuButtons()}else if(!0!==e&&t.hasClass("oracle-live-annotation-associate-on")){let e=this._messages.application_video_call_message_remote_annotation_stopped;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),t.removeClass("oracle-live-annotation-associate-on"),this._removeAnnotationSupport(),this._updateMenuButtons()}}setAssociateVideoAnnotationOn(e,t){console.log("setAssociateVideoAnnotationOn:"+e);const i=$(".oracle-live");if(e&&!i.hasClass("oracle-live-annotation-associate-video-on")){let e=this._messages.application_video_call_message_remote_annotation_video_started;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),i.addClass("oracle-live-annotation-associate-video-on"),i.hasClass("oracle-live-frozen-annotation")||($(".oracle-live-unfreeze-annotation-cross").prop("title",this._messages.application_video_call_tooltip_unannotate_video),this.setOriginMaximizedVideo(),this._maximizeEndUserVideo(!0),i.hasClass("oracle-live-collapsed")&&(this.setCollapsed(!1),i.addClass("oracle-live-collapsed-restore"))),this._addAssociateVideoAnnotationSupport()}else if(!0!==e&&i.hasClass("oracle-live-annotation-associate-video-on")){let e=this._messages.application_video_call_message_remote_annotation_video_stopped;e&&e.length>0&&!t&&($(".oracle-live-notification").text(e),this._showNotification()),i.removeClass("oracle-live-annotation-associate-video-on"),i.hasClass("oracle-live-frozen-annotation")||this.restoreOriginMaximizedVideo(),this._removeVideoAnnotationSupport(),t&&this._impl._conversation.relayCommandTo(null,"*","video_annotate_stop",[{}])}this._updateMenuButtons()}setFrozenAnnotationOn(e,t){const i=$(".oracle-live");if(e){let e=this._messages.application_video_call_message_remote_frozen_annotation_started;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification()),i.addClass("oracle-live-frozen-annotation"),$(".oracle-live-unfreeze-annotation-cross").prop("title",this._messages.application_video_call_tooltip_unfreeze_video),$(".oracle-live-unfreeze-annotation-camera").prop("title",this._messages.application_video_call_tooltip_frozen_video),i.hasClass("oracle-live-annotation-associate-video-on")||this.setOriginMaximizedVideo(),this._impl._av.freezeEndUserVideo(!0)}else{if(t){let e=this._messages.application_video_call_message_remote_frozen_annotation_stopped;e&&e.length>0&&($(".oracle-live-notification").text(e),this._showNotification())}i.removeClass("oracle-live-frozen-annotation"),i.hasClass("oracle-live-annotation-associate-video-on")||this.restoreOriginMaximizedVideo(),this._impl._av.freezeEndUserVideo(!1),this._frozenUrl=null,t||this._impl._conversation.relayCommandTo(null,"*","unfreeze_customer_stream",[{}]),this._clearVideoAnnotations()}this._updateMenuButtons()}restoreFromAnnotation(){this.setAssociateVideoAnnotationOn(!1,!0),this.setFrozenAnnotationOn(!1,!1),this._previousMaximizedFeed=this.getMaximizedFeed()}setOriginMaximizedVideo(){const e=$(".oracle-live");e.hasClass("oracle-live-video-associate-maximized")?this._originMaximizedVideo="ASSOCIATE":e.hasClass("oracle-live-video-enduser-maximized")?this._originMaximizedVideo="ENDUSER":this._originMaximizedVideo="NONE",e.hasClass("oracle-live-collapsed")&&(this.setCollapsed(!1),e.addClass("oracle-live-collapsed-restore")),this._maximizeEndUserVideo(!0),this._hideTopbarAndToolbar()}restoreOriginMaximizedVideo(){const e=$(".oracle-live");"NONE"===this._originMaximizedVideo?this._maximizeEndUserVideo(!1):"ASSOCIATE"===this._originMaximizedVideo&&this._maximizeAssociateVideo(!0),e.hasClass("oracle-live-collapsed-restore")&&(this.setCollapsed(!0),e.removeClass("oracle-live-collapsed-restore")),this._unHideTopbarAndToolbar(!0)}showUnfreezeAnnotationDialog(e){e?($(".oracle-live").addClass("oracle-live-unfreeze-annotation"),0===this._videoAnnotationList.length?this._setDialogMessage(this._messages.application_video_call_message_discard_frozen):this._setDialogMessage(this._messages.application_video_call_message_discard_frozen_annotation),this._showConfirmDialog()):($(".oracle-live").removeClass("oracle-live-unfreeze-annotation").removeClass("oracle-live-show-dialog"),$(".oracle-live-main-button").attr("aria-disabled","false"),this._okButton.text(this._messages.application_universal_button_yes)),this._updateMenuButtons(),this._setMainButtonColourCss(!1)}isUnsupportedBrowser(){let e=null;return this._impl._browserUnsupported?(e=this._messages.application_browser_unsupported_message+this._impl._browserUnsupported+".",this.showUnsupportedBrowser(e),!0):!!this._impl._browserVersionUnsupported&&(e=this._messages.application_browser_version_unsupported_message,this.showUnsupportedBrowser(e),!0)}showUnsupportedBrowser(e){$(".oracle-live").addClass("oracle-live-unsupported-browser"),this._setDialogMessage(e),this._showNotifyDialog()}distance(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}lineIntersects(e,t,i,o,s,n,a,r){const l=1e-5;function c(e,t,i){return e-l<=t&&t<=i+l}let d=((e*o-t*i)*(s-a)-(e-i)*(s*r-n*a))/((e-i)*(n-r)-(t-o)*(s-a)),u=((e*o-t*i)*(n-r)-(t-o)*(s*r-n*a))/((e-i)*(n-r)-(t-o)*(s-a));if(isNaN(d)||isNaN(u))return!1;if(e>=i){if(!c(i,d,e))return!1}else if(!c(e,d,i))return!1;if(t>=o){if(!c(o,u,t))return!1}else if(!c(t,u,o))return!1;if(s>=a){if(!c(a,d,s))return!1}else if(!c(s,d,a))return!1;if(n>=r){if(!c(r,u,n))return!1}else if(!c(n,u,r))return!1;return console.log("lineIntersects returning true"),!0}checkLineIntersectsWithAnnotations(e,t,i,o,s,n,a){n.forEach((n,r)=>{console.log("checkLineIntersectsWithAnnotations: processing annotation index (looking for intersection): ",r);for(let l=0;l<n.length-1;l++){let c=this.lineIntersects(e[0].x,e[0].y,e[1].x,e[1].y,n[l].x*t+o,n[l].y*i+s,n[l+1].x*t+o,n[l+1].y*i+s);console.log("checkLineIntersectsWithAnnotations: eraseAnnotation: intersects: ",c),c&&(console.log("checkLineIntersectsWithAnnotations: eraseAnnotation: found an intersection at index "+r),a.push(r))}})}_drawCursorPoint(e,t,i,o,s){let n;(n=e||(this._canvasCtx?this._canvasCtx:this._videoCanvasCtx)).beginPath(),n.moveTo(i,o),"circle"===t?n.arc(i,o,10,0,2*Math.PI):n.rect(i-10,o-10,20,20),n.strokeStyle=s,n.stroke()}eraseAnnotation(e){console.log("LiveButtonMenu::eraseAnnotation: ",e);let t=[];if(e.length>0){let i=e[0].annotationIds;i&&this._annotationList.forEach((e,o)=>{e[0].objectId&&i.includes(e[0].objectId)&&(console.log("Marking screenshare '"+e[0].objectId+"' annotation["+o+"] for deletion"),t.push(o))})}if(0===t.length)console.log("LiveButtonMenu::eraseAnnotation: failed to find anything to delete");else{let e=[];console.log("LiveButtonMenu::eraseAnnotation: removing all intersecting annotations"),this._annotationList.forEach((i,o)=>{console.log("processing annotation index: ",o),t.includes(o)||e.push(i)}),console.log("LiveButtonMenu::eraseAnnotation: clearing annotations"),this._clearAnnotations(),console.log("LiveButtonMenu::eraseAnnotation: Redrawing annotations with just the survivors"),e.forEach((e,t)=>{this.displayAssociateAnnotation(e)})}}displayAssociateAnnotation(e){if(console.log("LiveButtonMenu::displayAssociateAnnotation",e),!this._canvasCtx)return;if(e&&"erase"===e[0].mode)return void this.eraseAnnotation(e);e&&e[0].color&&(this._canvasCtx.strokeStyle=e[0].color),this._annotationList.push(e);let t=0,i=0,o=0;"Chrome"!==this._browser&&"Edge"!==this._browser||"browser"!==this._impl._screen.getDisplaySurface()?(i=window.outerWidth,t=window.outerHeight,o=t-window.innerHeight):(i=window.innerWidth,t=window.innerHeight);const s=(e,s)=>{if(0===s)this._oldPosition={x:e.x*i,y:e.y*t-o};else{const s={x:e.x*i,y:e.y*t-o};this._drawGraph(this._oldPosition,s),this._oldPosition=s}};let n=window.screen.width,a=window.screen.height;const r=(e,t)=>{let i=n*e.x,s=a*e.y,r=i-(window.screenLeft-n),l=s-window.screenTop-o;if(0===t)this._oldPosition={x:r,y:l};else{const e={x:r,y:l};this._drawGraph(this._oldPosition,e),this._oldPosition=e}};"Chrome"!==this._browser&&"Edge"!==this._browser||"monitor"!==this._impl._screen.getDisplaySurface()?e.forEach((e,t)=>{s(e,t)}):e.forEach((e,t)=>{r(e,t)})}getXOffset(e){console.log("LiveButtonMenu::getXOffset");let t=0;if(!e)return t;const i=e.clientWidth,o=e.clientHeight,s=e.videoWidth,n=e.videoHeight,a=i/o,r=s/n;return console.log("LiveButtonMenu::cw: "+i+"  ch: "+o+"  vw: "+s+"  vh: "+n),console.log("LiveButtonMenu::car: "+a+"    ar: "+r),a>r&&(t=(i-o*s/n)/2),console.log("LiveButtonMenu::xOffset: "+t),t}getYOffset(e){console.log("LiveButtonMenu::getYOffset");let t=0;if(!e)return t;const i=e.clientWidth,o=e.clientHeight,s=e.videoWidth,n=e.videoHeight,a=i/o,r=s/n;return console.log("LiveButtonMenu::cw: "+i+"  ch: "+o+"  vw: "+s+"  vh: "+n),console.log("LiveButtonMenu::car: "+a+"    ar: "+r),a<r&&(t=(o-i*n/s)/2),console.log("LiveButtonMenu::yOffset: "+t),t}eraseVideoAnnotation(e){console.log("LiveButtonMenu::eraseVideoAnnotation: ",e);let t=[];if(e.length>0){let i=e[0].annotationIds;i&&this._videoAnnotationList.forEach((e,o)=>{e[0].objectId&&i.includes(e[0].objectId)&&(console.log("Marking video '"+e[0].objectId+"' annotation["+o+"] for deletion"),t.push(o))})}if(0===t.length)console.log("LiveButtonMenu::eraseVideoAnnotation: failed to find anything to delete");else{let e=[];console.log("LiveButtonMenu::eraseVideoAnnotation: removing all intersecting annotations"),this._videoAnnotationList.forEach((i,o)=>{console.log("processing annotation index: ",o),t.includes(o)||e.push(i)}),console.log("LiveButtonMenu::eraseAnnotation: clearing annotations"),this._clearVideoAnnotations(),console.log("LiveButtonMenu::eraseAnnotation: Redrawing annotations with just the survivors"),e.forEach((e,t)=>{this.displayAssociateVideoAnnotation(e)})}}clearAllAnnotations(){$(".oracle-live").hasClass("oracle-live-frozen-annotation")||(this._videoAnnotationList=[],this._annotationList=[],this._clearAnnotations(),this._clearVideoAnnotations())}redrawVideoAnnotations(){console.log("LiveButtonMenu::redrawVideoAnnotation");let e=this._videoAnnotationList;this._clearVideoAnnotations(),console.log("LiveButtonMenu::redrawVideoAnnotation Redrawing the video annotations"),e.forEach((e,t)=>{this.displayAssociateVideoAnnotation(e)})}displayAssociateVideoAnnotation(e){if(console.log("LiveButtonMenu::displayAssociateVideoAnnotation",e),!this._videoCanvasCtx)return;if(e&&"erase"===e[0].mode)return void this.eraseVideoAnnotation(e);e&&e[0].color&&(this._videoCanvasCtx.strokeStyle=e[0].color),this._videoAnnotationList.push(e);const t=$(".oracle-live-local-video")[0],i=this.getXOffset(t),o=this.getYOffset(t);let s=0,n=0;n=t.clientWidth-2*i,s=t.clientHeight-2*o,window.navigator&&window.navigator.userAgent&&window.navigator.userAgent.toLowerCase().indexOf("mobi")>0&&t.clientHeight>this._videoCanvasCtx.canvas.height&&this._videoCanvasCtx.canvas.height-2*o>=50&&(s=this._videoCanvasCtx.canvas.height-2*o);const a=(e,t,i,o)=>{if(0===t)this._oldPosition={x:e.x*n+i,y:e.y*s+o};else{const t={x:e.x*n+i,y:e.y*s+o};this._drawVideoGraph(this._oldPosition,t),this._oldPosition=t}};e.forEach((e,t)=>{a(e,t,i,o)})}setPausedByUser(e){const t=$(".oracle-live");!0===e?(this._liveZoom&&this._liveZoom.saveScrollPosition(),t.addClass("oracle-live-paused-enduser"),this._impl.sendParticipantStreamStatus("paused"),this._endUserAnnotationOnPriorToPause=this.isEndUserAnnotationOn(),this._previousMaximizedFeed=this.getMaximizedFeed(),this._havePausedResumed=!0,this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!1),$(".oracle-live-notification").text(this._messages.application_universal_message_local_hold),this._showNotification(!0)):(console.log("setPausedByUser(resume): showingPausedNotification: "+this._showingPausedNotification),t.removeClass("oracle-live-paused-enduser"),this._liveZoom&&this._liveZoom.restoreScrollPosition(),this._impl.sendParticipantStreamStatus("active"),this._showingPausedNotification&&(console.log("Closing notification (setPausedByUser, pause="+e+")"),t.removeClass("oracle-live-notification-show")),this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!0),this.maximize(this._previousMaximizedFeed,!0)),this._updateMenuButtons()}setPausedByAssociate(e){const t=$(".oracle-live");!0===e?(console.log("setPausedByAssociate: pause option"),this._toolbarsHidden=!1,t.hasClass("oracle-live-videopanel-toolbars-hidden")&&(t.removeClass("oracle-live-videopanel-toolbars-hidden"),this._toolbarsHidden=!0),$(".oracle-live-notification").text(this._messages.application_universal_message_remote_hold),this._liveZoom&&this._liveZoom.saveScrollPosition(),t.addClass("oracle-live-paused-associate"),this._endUserAnnotationOnPriorToPause=this.isEndUserAnnotationOn(),this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!1),this._previousMaximizedFeed=this.getMaximizedFeed(),this._havePausedResumed=!0,this._showNotification(!0),console.log("setPausedByAssociate: transferMode = "+this._transferMode),(t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on"))&&this._unHideTopbarAndToolbar()):(console.log("setPausedByAssociate: resume option"),console.log("- has class paused-associate: "+t.hasClass("oracle-live-paused-associate")),console.log("- showingPausedNotification: "+this._showingPausedNotification),t.hasClass("oracle-live-paused-associate")&&(t.removeClass("oracle-live-paused-associate"),this._showingPausedNotification&&(console.log("Closing notification (setPausedByAssociate, pause="+e+")"),t.removeClass("oracle-live-notification-show")),this._liveZoom&&this._liveZoom.restoreScrollPosition()),this._endUserAnnotationOnPriorToPause&&this.setEndUserAnnotationOn(!0),this.maximize(this._previousMaximizedFeed,!0),this._toolbarsHidden&&t.addClass("oracle-live-videopanel-toolbars-hidden")),this._updateMenuButtons()}setTransferMode(e){this._transferMode=e}setTransferringToAnotherAssociate(e){console.log("setTransferringToAnotherAssociate"),this._idle=!1;let t=$(".oracle-live"),i=t.hasClass("oracle-live-local-audio-mute");this.resetClass("oracle-live oracle-live-transferring"),this.setPopMessageAriaDisabled(!1),"Transfer"===this._transferMode&&(this._transferringMessage=this._messages.application_universal_message_transferring_to_another_associate),"AddParticipant"===this._transferMode&&(this._transferringMessage=this._messages.application_universal_message_multiparty_busy_adding_participant),this.setPopMessageText(this._transferringMessage,null),i&&(console.log("setTransferringToAnotherAssociate: mute button is on"),t.addClass("oracle-live-local-audio-mute")),this._updateMenuButtons(),$(".oracle-live-video-panel-enduser .oracle-live-video-end-user-maximized-title").text(this._messages.application_universal_label_transferring),$(".oracle-live-audio-panel-message").text(this._messages.application_universal_label_transferring),this._setTitle(),this._setMainButtonColourCss(!1)}setTransferredToAnotherAssociate(e){console.log("TRANSFER: setTransferredToAnotherAssociate",e);const t=this.isPausedByAssociate();let i=$(".oracle-live"),o=i.hasClass("oracle-live-local-audio-mute");this.setConnected(!0),o&&(console.log("setTransferredToAnotherAssociate: mute button is on"),i.addClass("oracle-live-local-audio-mute")),t&&(console.log("Maintaining pause after setConnected..."),this.setPausedByAssociate(!0)),this._impl._av._associateVideoInitiallyPaused&&(console.log("Resetting to no associate video showing"),$(".oracle-live").removeClass("oracle-live-video-associate-on")),this._impl._av._userVideoInitiallyPaused&&(console.log("Resetting to no end user video showing"),$(".oracle-live").removeClass("oracle-live-video-enduser-on")),this._updateMenuButtons()}cancelCallTransfer(){console.log("cancelCallTransfer"),this._impl._av.cancelTransferSwitchoverStream();const e=this.isPausedByAssociate();let t=$(".oracle-live"),i=t.hasClass("oracle-live-local-audio-mute");this.setConnected(!0),i&&(console.log("setTransferredToAnotherAssociate: mute button is on"),t.addClass("oracle-live-local-audio-mute")),e&&(console.log("Maintaining pause after setConnected..."),this.setPausedByAssociate(!0)),this._updateMenuButtons()}setAssociateName(e){this._agentName=e,$(".oracle-live-associate").text(e).prop("title",e);const t=(e=>{let t="";if(null===e)return t;const i=(e=e.trim()).indexOf(" ");return(t=-1===i?e.substring(0,1):e.substring(0,1)+e.substring(i).trim().substring(0,1)).toUpperCase()})(this._agentName);console.log("Agent initials="+t),$(".oracle-live-mainbutton-initials").text(t),$(".oracle-live-video-enduser-name").text(e).prop("title",e),$(".oracle-live-screenshare-associate-name").text(e).prop("title",e),this._setTitle()}transferAssociatePanel(e,t,i){console.log("Transferring video panel from: "+t+" to: "+i+" video: "+e),$(".oracle-live-remote-video-container[data-uri='"+t+"']").attr("data-uri",i).attr("data-name",this._impl.getAssociateName(i)),e||$(".oracle-live-remote-video-container[data-uri='"+i+"']").removeClass("oracle-live-streaming").removeCalss("oracle-live-video-current"),this._setTitle()}setAdditionalAssociateName(e){console.log("setAdditionalAssociateName: name="+e),this.showAssociates("before add");const t=document.createElement("div");t.className="oracle-live-callinfo-associate";const i=document.createElement("div");i.className="oracle-live-associate";const o=document.createTextNode(e);i.appendChild(o),t.appendChild(i);const s=document.createElement("div");s.className="oracle-live-additional-participant-icon-container";const n=document.createElement("div");n.className="oracle-live-callinfo-merge-call-icon",n.setAttribute("role","button"),s.appendChild(n),t.appendChild(s);const a=document.getElementById("oracle-live-callinfo-associate"),r=document.getElementsByClassName("oracle-live-callinfo");if(console.log("  parentDiv.length = "+r.length),r.length>=1){r[0].insertBefore(t,a),console.log(" New Associate ("+e+") inserted before main associate");const i=a.getElementsByClassName("oracle-live-associate");i&&i.length>0&&console.log("Current main associate is: "+i[0].textContent)}this.showAssociates("after add")}showAssociates(e){console.log("showAssociates: "+e);let t=document.getElementsByClassName("oracle-live-callinfo");if(t.length>=1){const e=t[0].childNodes;console.log("- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -");for(let t=0;t<e.length;t++)if(e[t].className&&e[t].className.includes("oracle-live-callinfo-associate"))if("oracle-live-callinfo-associate"===e[t].id){const i=e[t].getElementsByClassName("oracle-live-associate");i&&i.length>0&&console.log("  - "+i[0].textContent+" (Main associate)")}else{const i=e[t].getElementsByClassName("oracle-live-associate");i&&i.length>0&&console.log("  - "+i[0].textContent)}console.log("- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -")}}resetAssociates(){console.log("resetAssociates");let e=document.getElementsByClassName("oracle-live-callinfo");if(e.length>=1){const t=e[0].childNodes;console.log("oracle-live-callinfo parent node has "+t.length);for(let e=0;e<t.length;e++)t[e].className&&t[e].className.includes("oracle-live-callinfo-associate")&&("oracle-live-callinfo-associate"===t[e].id?console.log("  Not resetting main associate name"):t[e].getElementsByClassName("oracle-live-associate").length>=1&&(console.log("  resetAssociates: removing "+name),t[e].remove()))}}removeAdditionalAssociateName(e){console.log("removeAdditionalAssociateName: name="+e),this.showAssociates("before remove");let t=document.getElementsByClassName("oracle-live-callinfo");if(t.length>=1){const i=t[0].childNodes;console.log("oracle-live-callinfo parent node has "+i.length);for(let t=0;t<i.length;t++)if(i[t].className&&i[t].className.includes("oracle-live-callinfo-associate")){if("oracle-live-callinfo-associate"===i[t].id){this.removeMainAssociateMakeAdditionalMain();break}{const o=i[t].getElementsByClassName("oracle-live-associate");if(console.log("  Checking name: '"+o[0].textContent+"'"),o.length>=1&&o[0].textContent===e){console.log("  Removing "+e),i[t].remove();break}}}}this.showAssociates("after remove"),this._setTitle()}removeMainAssociateMakeAdditionalMain(){console.log("removeMainAssociateMakeAdditionalMain");const e=document.getElementById("oracle-live-callinfo-associate").getElementsByClassName("oracle-live-associate"),t=e.length>0?e[0].textContent:null;if(console.log("main associate name: "+(t||"not found")),t){const e=this._impl._associates.find(e=>e.name!==t);if(e)return console.log("Switching name and avatar to new main associate: "+e.url+" ("+e.name+")"),this.removeAdditionalAssociateName(e.name),this._impl.removeAssociate(e.url),this.setAssociateName(e.name),this._impl.changeMainAssociate(e.url),t}return null}setNewMainAssociate(e){console.log("removeMainAssociateMakeAdditionalMain");const t=document.getElementById("oracle-live-callinfo-associate").getElementsByClassName("oracle-live-associate"),i=t.length>0?t[0].textContent:null;if(console.log("main associate name: "+(i||"not found")),i){const t=this._impl._associates.find(t=>t.url===e);if(t)return console.log("Switching name and avatar to new main associate: "+t.url+" ("+t.name+")"),this._impl.removeAssociate(t.url),this.setAssociateName(t.name),this._impl._associates.push(t),this._impl.changeMainAssociate(t.url),this.removeAdditionalAssociateName(t.name),i}return null}getMainAssociateName(){console.log("getMainAssociateName");const e=document.getElementById("oracle-live-callinfo-associate").getElementsByClassName("oracle-live-associate"),t=e.length>0?e[0].textContent:null;return console.log("main associate name: "+(t||"not found")),t}swapSetNewMainAssociateName(e){console.log("swapMainAssociateWithAdditionalAssociate");const t=this._impl._associates.find(t=>t.url===e),i=this.getMainAssociateName();if(console.log(" Existing host: "+i),console.log("      New Host: "+e),i!==t.name){const t=this.setNewMainAssociate(e);t&&this.setAdditionalAssociateName(t)}}setAssociatePhoto(e){const t=this._messages.application_universal_message_picture_description.replace(/\{0\}/,this._agentName);this._avatarImageUrl=e,e&&$(".oracle-live").addClass("oracle-live-agent-image-loaded"),$(".oracle-live-agent-image").attr("src",e).prop("title",t)}setConnectingAudioSource(e){this._connectingAudioSrc=e}setPoorNetwork(e){console.log("LiveButtonMenu::setPoorNetwork",e);const t=$(".oracle-live");!0===e?($(".oracle-live-video-panel-message").text(this._messages.application_universal_title_poor_connection),t.hasClass("oracle-live-connecting")?$(".oracle-live-notification").text(this._messages.application_universal_message_poor_network_connection):(t.hasClass("oracle-live-connected")||t.hasClass("oracle-live-transferring"))&&$(".oracle-live-notification").text(this._messages.application_universal_message_check_network_connection),t.addClass("oracle-live-poor-connection")):(t.removeClass("oracle-live-poor-connection"),this._setTitle()),this._updateMenuButtons(),this._showNotification()}_setBodyMarginTop(e){this._defaultBodyMarginTop?$("body").css("margin-top","calc("+this._defaultBodyMarginTop+" + "+e+")"):$("body").css("margin-top",e)}_resetBodyMarginTop(){this._defaultBodyMarginTop?$("body").css("margin-top",this._defaultBodyMarginTop):$("body").css("margin-top","")}setCollapsed(e){console.log("LiveButtonMenu::setCollapsed ",e);const t=$(".oracle-live");!0===e?(console.log("LiveButtonMenu::setCollapsed Removing maximized styles and adding collapsed style"),t.removeClass("oracle-live-video-enduser-maximized").removeClass("oracle-live-video-associate-maximized").removeClass("oracle-live-screenshare-associate-maximized").removeClass("oracle-live-callinfo-maximized"),this._resetBodyMarginTop(),t.addClass("oracle-live-collapsed")):(console.log("LiveButtonMenu::setCollapsed Removing collapsed styles"),t.removeClass("oracle-live-collapsed oracle-live-video-hide").removeClass("oracle-live-video-local-hide"),(t.hasClass("oracle-live-annotation-associate-video-on")||t.hasClass("oracle-live-frozen-annotation"))&&t.addClass("oracle-live-video-enduser-maximized"),t.hasClass("oracle-live-annotation-associate-video-on")&&this._resizeVideoAnnotationCanvas()),this._updateMenuButtons(),e||this._setMenuMinWidth()}_setMenuMinWidth(){if("Safari"===this._impl._browserName){let e=$(".oracle-live-buttonbar-button:visible").length;if(e>0){console.log("Number of visible buttons: "+e);let t=41*e+41;this.isFullScreen()||(t+=59),console.log("oracle-live-menu min-width: "+t),$(".oracle-live-menu").css("min-width",t+"px")}}}setScreenShareDialogShowing(e){e?$(".oracle-live").addClass("oracle-live-screenshare-system-dialog"):$(".oracle-live").removeClass("oracle-live-screenshare-system-dialog"),this._updateMenuButtons()}setCobrowseDialogShowing(e){e?$(".oracle-live").addClass("oracle-live-cobrowse-system-dialog"):$(".oracle-live").removeClass("oracle-live-cobrowse-system-dialog"),this._updateMenuButtons()}setCobrowseEnded(e){switch(console.log("Co-browse ended, reason: ",e),e){case"declined":$(".oracle-live-notification").text(this._messages.application_universal_message_stop_cobrowse_declined);break;case"associate":$(".oracle-live-notification").text(this._messages.application_universal_message_stop_cobrowse_associate);break;case"nostart":$(".oracle-live-notification").text(this._messages.application_universal_message_start_cobrowse_nostart);break;case"user":$(".oracle-live-notification").text(this._messages.application_universal_message_stop_cobrowse_user);break;case"cancelled":$(".oracle-live-notification").text(this._messages.application_universal_message_stop_cobrowse_cancelled);break;case"end_call":case"other":return;default:console.warn("Unknown cobrowse ending request: ",e)}this._showNotification()}setCobrowseUnableToStart(){$(".oracle-live-notification").text(this._messages.application_universal_message_start_unable),this._showNotification()}setRecording(e){!0===e?$(".oracle-live").addClass("oracle-live-recording-on"):$(".oracle-live").removeClass("oracle-live-recording-on")}setRating(e){const t=$(".oracle-live");switch(e){case"poor":t.removeClass("oracle-live-quality-good").removeClass("oracle-live-quality-excellent").addClass("oracle-live-quality-poor");break;case"good":t.removeClass(" oracle-live-quality-excellent").removeClass("oracle-live-quality-poor").addClass("oracle-live-quality-good");break;case"excellent":t.removeClass("oracle-live-quality-poor").removeClass("oracle-live-quality-good").addClass("oracle-live-quality-excellent")}this._okButton.attr("aria-disabled","false"),$(".oracle-live-dialog-option-poor").prop("tabindex","poor"===e?0:-1).attr("aria-checked","poor"===e),$(".oracle-live-dialog-option-good").prop("tabindex","good"===e?0:-1).attr("aria-checked","good"===e),$(".oracle-live-dialog-option-excellent").prop("tabindex","excellent"===e?0:-1).attr("aria-checked","excellent"===e)}getMaximizedFeed(){const e=$(".oracle-live");return e.hasClass("oracle-live-collapsed")?null:e.hasClass("oracle-live-video-enduser-maximized")?"endUserVideo":e.hasClass("oracle-live-video-associate-maximized")?"associateVideo":e.hasClass("oracle-live-screenshare-associate-maximized")?"associateScreenShare":e.hasClass("oracle-live-callinfo-maximized")?"callInfoPanel":null}isVideoOn(){const e=$(".oracle-live");return e.hasClass("oracle-live-video-enduser-on")||e.hasClass("oracle-live-video-associate-on")||e.hasClass("oracle-live-screenshare-associate-on")}isRemoteVideoOn(){const e=$(".oracle-live");return e.hasClass("oracle-live-video-associate-on")||e.hasClass("oracle-live-screenshare-associate-on")}isFullScreen(){const e=$(".oracle-live");return e.hasClass("oracle-live-video-enduser-maximized")||e.hasClass("oracle-live-video-associate-maximized")||e.hasClass("oracle-live-screenshare-associate-maximized")||e.hasClass("oracle-live-callinfo-maximized")}maximize(e,t){if(console.log("LiveButtonMenu::maximize ",e,t),$(".oracle-live").hasClass("oracle-live-collapsed"))console.log("is collapsed - returning");else{if("endUserVideo"===e)this._maximizeEndUserVideo(t);else if("associateVideo"===e)this._maximizeAssociateVideo(t);else if("associateScreenShare"===e)this._maximizeAssociateScreenShare(t);else if("callInfoPanel"===e)this._maximizeCallInfoAudio(t);else{const i=$(".oracle-live-remote-video-container.oracle-live-streaming[data-avid='"+e+"']");i.length&&($(".oracle-live-video-current").removeClass("oracle-live-video-current"),i.addClass("oracle-live-video-current"),$(".oracle-live-video-panel").removeClass("oracle-live-video-grid-horizontal").removeClass("oracle-live-video-grid-vertical").addClass("oracle-live-video-grid-single"),this._maximizeAssociateVideo(t))}this._updateMenuButtons()}}_setDialogMessage(...e){if(!e||e&&!e.length)return void console.error("_setDialogMessage : invalid messages for dialog");let t="",i=document.getElementsByClassName("oracle-live-dialog-message")[0];i&&(e.forEach((e,i,o)=>{t+="dialog-msg-"+i.toString()+(i!==o.length-1?" ":"")}),t+="",i.setAttribute("aria-labelledby",t),i.setAttribute("aria-live","polite"));let o=e.map((e,t)=>'<p id="dialog-msg-'+t.toString()+`">${e}</p>`).join("");$(".oracle-live-dialog-message").html(o)}_hideCallInfo(){$(".oracle-live-callinfo").hasClass("oracle-live-callinfo-hide")||$(".oracle-live-callinfo").addClass("oracle-live-callinfo-hide")}_showCallInfo(){$(".oracle-live-callinfo").hasClass("oracle-live-callinfo-hide")&&$(".oracle-live-callinfo").removeClass("oracle-live-callinfo-hide")}_showDialog(e,t){console.log("showDialog: "+(e?"showing dialog":"hiding dialog"));const i=this._okButton,o=$(".oracle-live-dialog-cancel");this._setDialogButtonColourCss(i,!0,!1),this._setDialogButtonColourCss(o,!1,!1),e?(console.log("showing now"),this.showMessagingPanel(!1),this._oldFocus=document.activeElement,$(".oracle-live").addClass("oracle-live-show-dialog"),!0===t?(this._cancelButton.removeClass("oracle-live-hide"),o.focus()):(this._cancelButton.addClass("oracle-live-hide"),i.focus()),this._hideCallInfo()):(this.closeTimedDialog(),this._showCallInfo(),console.log("hiding now"),$(".oracle-live").removeClass("oracle-live-show-dialog"),this._oldFocus&&this._oldFocus.focus(),this._updateMenuButtons()),this._setButtonBarEndButtonIconCss(e)}_showNotifyDialog(){this._okButton.attr("aria-disabled","false").text(this._messages.application_universal_button_close).prop("title",this._messages.application_universal_button_close),this._cancelButton.attr("aria-disabled","true"),$(".oracle-live-dialog-close").attr("aria-disabled","true"),this._showDialog(!0,!1)}_showConfirmDialog(e){const t=e?this._messages.application_universal_button_no:this._messages.application_universal_button_cancel;this._okButton.attr("aria-disabled","false").text(this._messages.application_universal_button_yes).prop("title",this._messages.application_universal_button_yes),this._cancelButton.attr("aria-disabled","false").text(t).prop("title",t),this._showDialog(!0,!0)}_showSubmitDialog(){this._okButton.attr("aria-disabled","true").text(this._messages.application_universal_button_ok).prop("title",this._messages.application_universal_button_ok),this._cancelButton.attr("aria-disabled","false"),this._showDialog(!0,!0)}_maximizeCallInfoAudio(e){console.log("LiveButtonMenu::_maximizeCallInfoAudio ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeCallInfoAudio (max and not olc)"),t.removeClass("oracle-live-video-associate-maximized"),t.removeClass("oracle-live-screenshare-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.removeClass("oracle-live-video-enduser-maximized"),t.addClass("oracle-live-callinfo-maximized"),this._setBodyMarginTop($(".oracle-live-callinfo-toolbar").css("height")),$(".oracle-live-callinfo-panel-maximized .oracle-live-video-maximize").prop("title",this._messages.application_audio_call_tooltip_minimize_callinfo)):(t.removeClass("oracle-live-callinfo-maximized"),this._resetBodyMarginTop()),e&&($(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),$(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize)),this._setCustomCssMinMax(e)}_setDefaultFullScreenVideoPanelLayout(){console.log("_setDefaultFullScreenVideoPanelLayout");const e=$(".oracle-live");e.hasClass("oracle-live-video-panel-maximized")&&(console.log("Video panel is maximized"),e.hasClass("oracle-live-video-enduser-maximized")&&(console.log("End user is maximized, switch to max associate instead"),this._maximizeAssociateVideo(!0)))}_maximizeEndUserVideo(e){console.log("LiveButtonMenu::_maximizeEndUserVideo ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeEndUserVideo (max and not olc)"),t.removeClass("oracle-live-callinfo-maximized"),this._resetBodyMarginTop(),t.removeClass("oracle-live-video-associate-maximized"),t.removeClass("oracle-live-screenshare-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.addClass("oracle-live-video-enduser-maximized"),$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_minimize_video),this._resizeVideoAnnotationCanvas()):(console.log("LiveButtonMenu::_maximizeEndUserVideo (not max) or (max and olc)"),t.removeClass("oracle-live-video-enduser-maximized"),$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",e?this._messages.application_video_call_tooltip_minimize_video:this._messages.application_video_call_tooltip_maximize),this._resizeVideoAnnotationCanvas()),e&&$(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),this._setCustomCssMinMax(e)}_maximizeAssociateVideo(e){console.log("LiveButtonMenu::_maximizeAssociateVideo ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeAssociateVideo (max and not olc)"),t.removeClass("oracle-live-callinfo-maximized"),this._resetBodyMarginTop(),t.removeClass("oracle-live-video-enduser-maximized"),t.removeClass("oracle-live-screenshare-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.addClass("oracle-live-video-associate-maximized"),$(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_minimize_video)):(console.log("LiveButtonMenu::_maximizeAssociateVideo (not max) or (max and olc)"),t.removeClass("oracle-live-video-associate-maximized"),$(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",e?this._messages.application_video_call_tooltip_minimize_video:this._messages.application_video_call_tooltip_maximize)),e&&$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),this._setCustomCssMinMax(e)}_maximizeAssociateScreenShare(e){console.log("LiveButtonMenu::_maximizeAssociateScreenShare ",e);const t=$(".oracle-live");e&&!t.hasClass("oracle-live-collapsed")?(console.log("LiveButtonMenu::_maximizeAssociateScreenShare (max and not olc)"),t.removeClass("oracle-live-callinfo-maximized"),t.removeClass("oracle-live-video-enduser-maximized"),t.removeClass("oracle-live-video-associate-maximized"),t.removeClass("oracle-live-videopanel-toolbars-hidden"),t.addClass("oracle-live-screenshare-associate-maximized"),this._enableZoom(!0)):(console.log("LiveButtonMenu::_maximizeAssociateScreenShare (not max) or (max and olc)"),t.removeClass("oracle-live-screenshare-associate-maximized"),this._enableZoom(!1)),e&&($(".oracle-live-video-panel-associate .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize),$(".oracle-live-video-panel-enduser .oracle-live-video-maximize").prop("title",this._messages.application_video_call_tooltip_maximize)),this._setCustomCssMinMax(e)}_updateMenuButtons(){const e=$(".oracle-live"),t=$(".oracle-live-menu"),i=$(".oracle-live-pause-button"),o=$(".oracle-live-mute-button"),s=$(".oracle-live-ellipses-button"),n=$(".oracle-live-video-button"),a=$(".oracle-live-screenshare-button"),r=$(".oracle-live-annotate-button"),l=$(".oracle-live-exit-button"),c=$(".oracle-live-cobrowse-button");!0===this._hideEndCallButton&&this.hideEndCallButton(),!0===this._hidePauseButton&&this.hidePauseResumeButton();const d=e.hasClass("oracle-live-show-dialog"),u=e.hasClass("oracle-live-video-preview"),h=e.hasClass("oracle-live-screenshare-system-dialog"),g=e.hasClass("oracle-live-cobrowse-system-dialog"),m=e.hasClass("oracle-live-connected"),p=e.hasClass("oracle-live-disconnecting"),v=e.hasClass("oracle-live-disconnected"),S=e.hasClass("oracle-live-reconnecting-enduser"),_=e.hasClass("oracle-live-screeenshare-ready"),f=e.hasClass("oracle-live-cobrowse-ready"),C=e.hasClass("oracle-live-paused-associate"),b=e.hasClass("oracle-live-paused-enduser"),E=e.hasClass("oracle-live-local-audio-mute"),R=e.hasClass("oracle-live-show-more-menu"),A=e.hasClass("oracle-live-video-enduser-on"),T=e.hasClass("oracle-live-video-control-enduser"),y=e.hasClass("oracle-live-screenshare-enduser-on"),I=e.hasClass("oracle-live-screenshare-control-enduser"),w=e.hasClass("oracle-live-screenshare-associate-on"),k=e.hasClass("oracle-live-annotation-enduser-on"),L=e.hasClass("oracle-live-annotation-associate-on"),O=e.hasClass("oracle-live-cobrowse-enduser-on");if(this._isMeeting?u||!m||p||v?t.css("display","none"):t.css("display","block"):!(!0!==this._hidePauseButton||A||T||y||I||k||O||!0!==this._hideEndCallButton)||!m&&!p&&!v||e.hasClass("oracle-live-videopanel-topbar-toolbar-hidden")||e.hasClass("oracle-live-collapsed")||u&&e.hasClass("oracle-live-video-enduser-maximized")?t.css("display","none"):t.css("display","block"),!0===this._idle)return!0!==this._hidePauseButton?i.prop("title",this._messages.application_universal_tooltip_pause_call).attr("aria-pressed",!1).attr("aria-disabled",!1):i.prop("title",this._messages.application_universal_tooltip_pause_call_disabled).attr("aria-pressed",!1).attr("aria-disabled",!0),n.prop("title",this._messages.application_video_call_tooltip_share_camera).attr("aria-pressed",!1).attr("aria-disabled",!1),a.prop("title",this._messages.application_video_call_tooltip_share_screen).attr("aria-pressed",!1).attr("aria-disabled",!1),!0!==this._hideEndCallButton?l.prop("title",this._messages.application_universal_tooltip_end_call).attr("aria-pressed",!1).attr("aria-disabled",!1):l.prop("title",this._messages.application_universal_tooltip_end_call_disabled).attr("aria-pressed",!1).attr("aria-disabled",!0),c.prop("title",this._messages.application_video_call_tooltip_cobrowse).attr("aria-pressed",!1).attr("aria-disabled",!1),this._addedOracleLiveVideoControlEnduser=!1,void(this._cameraDefaultOn=null);const P=S||C||p||v||d||u||h||g;i.attr("aria-disabled",P||this._hidePauseButton),i.attr("aria-pressed",b),P||this._hidePauseButton?(i.prop("title",this._messages.application_universal_tooltip_pause_call_disabled),this._setButtonBarButtonColourCss(i,!1,!0)):b?(i.prop("title",this._messages.application_universal_tooltip_resume_call),this._setButtonBarButtonColourCss(i,!0,!1)):(i.prop("title",this._messages.application_universal_tooltip_pause_call),this._setButtonBarButtonColourCss(i,!1,!1));const M=P||b||C;o.attr("aria-disabled",M),o.attr("aria-pressed",E),M?(o.prop("title",this._messages.application_universal_tooltip_mute_call_disabled),this._setButtonBarButtonColourCss(o,!1,!0)):E?(o.prop("title",this._messages.application_universal_tooltip_unmute_call),this._setButtonBarButtonColourCss(o,!0,!1)):(o.prop("title",this._messages.application_universal_tooltip_mute_call),this._setButtonBarButtonColourCss(o,!1,!1)),s.attr("aria-disabled",M),s.attr("aria-pressed",R),M?(s.prop("title",this._messages.application_universal_tooltip_show_more_disabled),this._setButtonBarButtonColourCss(s,!1,!0)):R?(s.prop("title",this._messages.application_universal_tooltip_show_less),this._setButtonBarButtonColourCss(s,!0,!1)):(s.prop("title",this._messages.application_universal_tooltip_show_more),this._setButtonBarButtonColourCss(s,!1,!1)),n.attr("aria-disabled",M),n.attr("aria-pressed",A),e.hasClass("oracle-live-frozen-annotation")||e.hasClass("oracle-live-annotation-associate-video-on")?$(".oracle-live-video-maximize.oracle-live-video-toolbar-enduser").attr("aria-disabled",!0):$(".oracle-live-video-maximize.oracle-live-video-toolbar-enduser").attr("aria-disabled",!1),M?(n.prop("title",this._messages.application_video_call_tooltip_share_camera_disabled),this._setButtonBarButtonColourCss(n,!1,!0)):A?(null===this._cameraDefaultOn&&(this._cameraDefaultOn=!0),n.prop("title",this._messages.application_video_call_tooltip_stop_camera_share),this._setButtonBarButtonColourCss(n,!0,!1),e.hasClass("oracle-live-video-control-enduser")||(this._addedOracleLiveVideoControlEnduser=!0,e.addClass("oracle-live-video-control-enduser"))):(null===this._cameraDefaultOn&&(this._cameraDefaultOn=!1),n.prop("title",this._messages.application_video_call_tooltip_share_camera),this._setButtonBarButtonColourCss(n,!1,!1),this._addedOracleLiveVideoControlEnduser&&!1===this._cameraDefaultOn&&(this._addedOracleLiveVideoControlEnduser=!1,e.removeClass("oracle-live-video-control-enduser")));const N=M||w||!_;a.attr("aria-disabled",N),a.attr("aria-pressed",y),N?(a.prop("title",this._messages.application_video_call_tooltip_screen_share_disabled),this._setButtonBarButtonColourCss(a,!1,!0)):y?(a.prop("title",this._messages.application_video_call_tooltip_stop_screen_share),this._setButtonBarButtonColourCss(a,!0,!1)):(a.prop("title",this._messages.application_video_call_tooltip_share_screen),this._setButtonBarButtonColourCss(a,!1,!1));const D=M||!f;c.attr("aria-disabled",D),c.attr("aria-pressed",O),D?(c.prop("title",this._messages.application_video_call_tooltip_cobrowse_disabled),this._setButtonBarButtonColourCss(a,!1,!0)):O?(c.prop("title",this._messages.application_video_call_tooltip_stop_cobrowse),this._setButtonBarButtonColourCss(a,!0,!1)):(c.prop("title",this._messages.application_video_call_tooltip_cobrowse),this._setButtonBarButtonColourCss(a,!1,!1)),r.attr("aria-disabled",M||L),r.attr("aria-pressed",k),M?(r.prop("title",this._messages.application_video_call_tooltip_annotation_disabled),this._setButtonBarButtonColourCss(r,!1,!0)):k?(r.prop("title",this._messages.application_video_call_tooltip_stop_annotation),this._setButtonBarButtonColourCss(r,!0,!1)):(r.prop("title",this._messages.application_video_call_tooltip_annotate),this._setButtonBarButtonColourCss(r,!1,!1));const x=p||v||d||u||this._hideEndCallButton;l.attr("aria-disabled",x),x?l.prop("title",this._messages.application_universal_tooltip_end_call_disabled):l.prop("title",this._messages.application_universal_tooltip_end_call),this._setButtonBarEndButtonColourCss(!1,x),this._setMenuMinWidth()}_enableZoom(e){e?(this._liveZoom||(this._liveZoom=new s(this._customization)),this._liveZoom.disable(!1)):this._liveZoom&&this._liveZoom.disable(!0)}hideVideo(){$(".oracle-live").addClass("oracle-live-video-hide")}hideLocalVideo(){$(".oracle-live").addClass("oracle-live-video-local-hide")}muteLocalAudio(e,t){console.log("muteLocalAudio in ButtonMenu, mute: "+e);let i=this._impl._av.muteLocalAudio(e);t||(i?(console.log("muteLocalAudio Succeed"),e?$(".oracle-live").addClass("oracle-live-local-audio-mute"):$(".oracle-live").removeClass("oracle-live-local-audio-mute"),this._updateMenuButtons()):console.log("muteLocalAudio failed"))}showMenuMore(e){e?$(".oracle-live").addClass("oracle-live-show-more-menu"):$(".oracle-live").removeClass("oracle-live-show-more-menu"),this._updateMenuButtons()}swapCamera(){console.log("Swap the local camera"),this._impl._av.swapCamera()}displayMessageDialog(e){"SpecialSafariAudioHint"===e?(console.log("Displaying special Safari audio hint"),this._setDialogMessage(this._messages.application_universal_title_audio_safari_hint,this._messages.application_universal_message_audio_safari_hint)):this._setDialogMessage(this._messages[e]),this._showNotifyDialog()}closeMessageDialog(){return this._okButton.text()===this._messages.application_universal_button_close&&(this._okButton.text(this._messages.application_universal_button_yes),this._showDialog(!1),!0)}showShareRequest(e,t){this._resetChromeScreenSharePluginClasses(),e?("associate-screenshare"===t?this._setDialogMessage(this._messages.application_universal_title_remote_add_screen_share,this._messages.application_universal_message_remote_add_screen_share):"user-screenshare"===t?this._setDialogMessage(this._messages.application_universal_title_share_screen,this._messages.application_universal_message_start_screen_share):"user-video"===t?this._hidePauseButton?this._setDialogMessage(this._messages.application_video_call_message_see_surroundings,this._messages.application_video_call_message_no_pause):this._setDialogMessage(this._messages.application_video_call_message_see_surroundings,this._messages.application_video_call_message_pause):"user-cobrowse"===t?this._setDialogMessage(this._messages.application_universal_message_start_cobrowse_user_header,this._messages.application_universal_message_start_cobrowse_body,this._messages.application_universal_message_start_cobrowse_footer):"associate-cobrowse"===t?this._setDialogMessage(this._messages.application_universal_message_start_cobrowse_associate_header,this._messages.application_universal_message_start_cobrowse_body,this._messages.application_universal_message_start_cobrowse_footer):console.log("showShareRequest: Unknown share type: '"+t+"'"),$(".oracle-live").addClass("oracle-live-share-media-request"),this._showConfirmDialog()):($(".oracle-live").removeClass("oracle-live-share-media-request"),this._showDialog(!1)),this._updateMenuButtons()}_resetChromeScreenSharePluginClasses(){$(".oracle-live").removeClass("oracle-live-install-plugin-request").removeClass("oracle-live-installing-plugin").removeClass("oracle-live-installed-plugin"),this._okButton.text(this._messages.application_universal_button_yes)}showInstallChromeScreenSharePluginRequest(e){console.log("showInstallChromeScreenSharePluginRequest: show="+e),this._resetChromeScreenSharePluginClasses(),e?(this._setDialogMessage(this._messages.application_screen_share_plugin_install_chrome,this._messages.application_screen_share_plugin_install_permission_chrome),$(".oracle-live").addClass("oracle-live-install-plugin-request"),this._okButton.text(this._messages.application_screen_share_plugin_install_extension).attr("aria-disabled","false"),this._showDialog(!0,!1)):this._showDialog(!1),this._updateMenuButtons()}showInstallingChromeScreenSharePlugin(e){console.log("showInstallingChromeScreenSharePlugin: show="+e),this._resetChromeScreenSharePluginClasses(),e?(this._setDialogMessage(this._messages.application_screen_share_plugin_installing_message_chrome),$(".oracle-live").addClass("oracle-live-installing-plugin"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),this._showDialog(!0,!0)):this._showDialog(!1),this._updateMenuButtons()}showInstalledChromeScreenSharePlugin(e){console.log("showInstalledChromeScreenSharePlugin: show="+e),this._resetChromeScreenSharePluginClasses(),e?(this._setDialogMessage(this._messages.application_screen_share_plugin_installed_title_chrome,this._messages.application_screen_share_plugin_installed_message_chrome),$(".oracle-live").addClass("oracle-live-installed-plugin"),$(".oracle-live-dialog-cancel").attr("aria-disabled","false"),this._okButton.text(this._messages.application_screen_share_plugin_installed_share_screen),this._showDialog(!0,!0)):this._showDialog(!1),this._updateMenuButtons()}setStartInVideo(e){e!==this._startInVideo&&(this._startInVideo=e,!0===this._idle&&(!0===this._startInVideo?$(".oracle-live").addClass("oracle-live-start-in-video"):$(".oracle-live").removeClass("oracle-live-start-in-video")))}setStartInScreenShare(e){console.log("LiveButtonMenu::setStartInScreenShare",e),e!==this._startInScreenShare&&(this._startInScreenShare=e,!0===this._idle&&(!0===this._startInScreenShare?$(".oracle-live").addClass("oracle-live-start-in-screenshare"):$(".oracle-live").removeClass("oracle-live-start-in-screenshare")))}setStartVideoInFullScreen(e){console.log("setStartVideoInFullScreen: "+e),this._startVideoInFullScreen=e}setStartVideoWithFrontCamera(e){console.log("setStartVideoWithFrontCamera: "+e),this._startVideoWithFrontCamera=e}setHideEndCallButton(e){console.log("setHideEndCallButton: "+e),this._hideEndCallButton=e}setHidePauseButton(e){console.log("setHidePauseButton: "+e),this._hidePauseButton=e}setHideQueueLengthIndicator(e){console.log("setQueueLengthIndicator: "+e),this._hideQueueLengthIndicator=e}setEndUserControlsCamera(e){console.log("setEndUserControlsCamera: "+e),this._endUserControlsCamera=e}setEndUserControlsScreenShare(e){console.log("setEndUserControlsScreenShare: "+e),this._endUserControlsScreenShare=e}setEndUserControlsCobrowse(e){console.log("setEndUserControlsCobrowse: "+e),this._endUserControlsCobrowse=e}setShortCodeMode(e){e!==this._shortCodeMode&&(this._shortCodeMode=e)}setUsingExternalAudio(e){e!==this._usingExternalAudio&&(this._usingExternalAudio=e,!0===this._idle&&(!0===this._usingExternalAudio?$(".oracle-live").addClass("oracle-live-external-audio"):$(".oracle-live").removeClass("oracle-live-external-audio"))),this._setChannelIconText()}setPreCallIDCheck(e){console.log("LiveButtonMenu::setPreCallIDCheck setting _preCallIDCheck: ",e),e!==this._preCallIDCheck&&(this._preCallIDCheck=e)}getPreCallIDCheck(){return this._preCallIDCheck}updatePositionInQueue(e){e&&e.length>0?(console.log(`Setting positionInQueue: ${e}`),$(".oracle-live-position-in-queue").text(e).attr("aria-label",e),this.hideQueueLengthIndicator(this._hideQueueLengthIndicator)):(console.log("No valid position, hiding queue position"),this.hideQueueLengthIndicator(!0))}_showNotification(e){this._showingPausedNotification=e||!1,console.log("LiveButtonMenu::_showNotification"),this._notificationTimer&&(console.log("Clearing Notification timer: "+this._notificationTimer),clearTimeout(this._notificationTimer));let t=$(".oracle-live-notification").text();this._showingPausedNotification&&(t+=" (Paused Notification)");const i=$(".oracle-live");i.hasClass("oracle-live-notification-show")?console.log("Notification already being displayed. So keep showing: '"+t+"'"):(console.log("Showing notification '"+t+"'"),i.addClass("oracle-live-notification-show '"+t+"'")),this._notificationTimer=setTimeout(()=>{console.log("Closing notification "+this._notificationTimer+" (after timeout)'"+t+"'"),i.removeClass("oracle-live-notification-show  oracle-live-notification-close"),this._notificationTimer=null,this._showingPausedNotification=!1},this._notificationUptime),console.log("Started Notification timer: "+this._notificationTimer)}closeNotificationMessage(){console.log("LiveButtonMenu::closeNotificationMessage()"),this._showingPausedNotification=!1,$(".oracle-live").addClass("oracle-live-notification-close")}_removeActiveClasses(){console.log("LiveButtonMenu::_removeActiveClasses");const e=$(".oracle-live-pause-button");!0===this._hidePauseButton?this.hidePauseResumeButton():e.css("display","inline-block"),!0===this._hideEndCallButton&&this.hideEndCallButton(),$(".oracle-live").removeClass("oracle-live-disconnecting oracle-live-feedback").removeClass("oracle-live-paused-enduser oracle-live-paused-associate").removeClass("oracle-live-reconnecting-enduser oracle-live-reconnecting-associate").removeClass("oracle-live-show-dialog").removeClass("oracle-live-recording-on oracle-live-collapsed").removeClass("oracle-live-video-enduser oracle-live-video-enduser-on").removeClass("oracle-live-video-associate oracle-live-video-associate-on").removeClass("oracle-live-screenshare-enduser oracle-live-screenshare-enduser-on").removeClass("oracle-live-screenshare-associate oracle-live-screenshare-associate-on").removeClass("oracle-live-screenshare-associate-maximized").removeClass("oracle-live-screenshare-system-dialog").removeClass("oracle-live-cobrowse-system-dialog").removeClass("oracle-live-video-associate-maximized").removeClass("oracle-live-video-enduser-maximized").removeClass("oracle-live-enduser-screenshare-annotation-on").removeClass("oracle-live-videopanel-toolbars-hidden").removeClass("oracle-live-callinfo-maximized"),this._resetBodyMarginTop(),this._setChannelIconText()}_addEndUserAnnotationSupport(){console.log("LiveButtonMenu::_addEndUserAnnotationSupport"),this._canvas=$(".oracle-live-annotation-canvas"),this._canvasCtx=this._canvas[0].getContext("2d"),this._oldPosition={x:0,y:0};const e=e=>(this._oldPosition={x:e.clientX,y:e.clientY},!0);this._resizeAnnotationCanvas(),$(window).off("resize.oraclelive").on("resize.oraclelive",e=>(this._resizeAnnotationCanvas(),!0)),this._canvas.off("mousemove").on("mousemove",e=>{if(console.log("LiveButtonMenu::_addEndUserAnnotationSupport::draw"),1!==e.buttons)return!0;const t={x:e.clientX,y:e.clientY};return this._drawGraph(this._oldPosition,t),this._oldPosition=t,!0}).off("mousedown").on("mousedown",t=>{console.log("LiveButtonMenu::_addEndUserAnnotationSupport::startGraph"),this._clearAnnotations();const i=$(".oracle-live");i.addClass("oracle-live-enduser-annotation-hide");const o=document.elementFromPoint(t.clientX,t.clientY);return $(o).click(),i.removeClass("oracle-live-enduser-annotation-hide"),e(t)}).off("mouseenter").on("mouseenter",e)}_addAssociateAnnotationSupport(){console.log("LiveButtonMenu::_addAssociateAnnotationSupport()"),this._canvas=$(".oracle-live-annotation-canvas"),this._canvasCtx=this._canvas[0].getContext("2d"),this._oldPosition={x:0,y:0},this._resizeAnnotationCanvas(),$(window).off("resize.oraclelive").on("resize.oraclelive",e=>(this._resizeAnnotationCanvas(),!0)),this._canvas.off("mousedown").on("mousedown",e=>{const t=$(".oracle-live");t.addClass("oracle-live-enduser-annotation-hide");const i=document.elementFromPoint(e.clientX,e.clientY);$(i).click(),t.removeClass("oracle-live-enduser-annotation-hide")})}_addAssociateVideoAnnotationSupport(){console.log("LiveButtonMenu::_addAssociateVideoAnnotationSupport"),this._videoCanvas=$(".oracle-live-annotation-video-canvas"),this._videoCanvasCtx=this._videoCanvas[0].getContext("2d"),this._oldPosition={x:0,y:0},this._resizeVideoAnnotationCanvas(),$(window).off("resize.oraclelive").on("resize.oraclelive",e=>(this._resizeVideoAnnotationCanvas(),!0)),this._videoCanvas.off("mousedown").on("mousedown",e=>{const t=$(".oracle-live");if(t.hasClass("oracle-live-frozen-annotation")||t.hasClass("oracle-live-annotation-associate-video-on"))return this._toggleTopbarAndToolbar(),!0;t.addClass("oracle-live-associate-annotation-video-hide");const i=document.elementFromPoint(e.clientX,e.clientY);$(i).click(),t.removeClass("oracle-live-associate-annotation-video-hide")})}_drawGraph(e,t){this._canvasCtx?(this._canvasCtx.beginPath(),this._canvasCtx.lineWidth=3,this._canvasCtx.lineCap="round",this._canvasCtx.strokeStyle||(this._canvasCtx.strokeStyle="#FF0000"),this._canvasCtx.moveTo(e.x,e.y),this._canvasCtx.lineTo(t.x,t.y),this._canvasCtx.stroke()):console.log("LiveButtonMenu::_drawGraph has no canvas context")}_drawVideoGraph(e,t){this._videoCanvasCtx?(this._videoCanvasCtx.beginPath(),this._videoCanvasCtx.lineWidth=3,this._videoCanvasCtx.lineCap="round",this._videoCanvasCtx.strokeStyle||(this._videoCanvasCtx.strokeStyle="#FF0000"),this._videoCanvasCtx.moveTo(e.x,e.y),this._videoCanvasCtx.lineTo(t.x,t.y),this._videoCanvasCtx.stroke()):console.log("LiveButtonMenu::_drawVideoGraph has no canvas context")}_removeAnnotationSupport(){this._clearAnnotations(),$(window).off("resize.oraclelive"),$(".oracle-live-annotation-canvas").off("mousemove").off("mousedown").off("mouseenter"),this._canvas=null,this._canvasCtx=null,this._annotationList=[]}_removeVideoAnnotationSupport(){console.log("_removeVideoAnnotationSupport:"),this._clearVideoAnnotations(),$(window).off("resize.oraclelive"),$(".oracle-live-annotation-video-canvas").off("mousemove").off("mousedown").off("mouseenter"),this._videoCanvas=null,this._videoCanvasCtx=null,this._videoAnnotationList=[]}_resizeAnnotationCanvas(){if(!this._canvasCtx)return;const e=window.innerWidth,t=window.innerHeight;this._canvasCtx&&this._canvasCtx.canvas?(this._canvasCtx.canvas.width=e,this._canvasCtx.canvas.height=t,console.log("LiveButtonMenu::_resizeAnnotationCanvas, success this time")):console.error("LiveButtonMenu::_resizeAnnotationCanvas, no canvas found!")}_resizeVideoAnnotationCanvas(){const e=$(".oracle-live");if(this._videoCanvasCtx)if(e.hasClass("oracle-live-video-enduser-maximized")){const e=window.innerWidth,t=window.innerHeight;this._videoCanvasCtx&&this._videoCanvasCtx.canvas?(this._videoCanvasCtx.canvas.width=e,this._videoCanvasCtx.canvas.height=t-44,this.redrawVideoAnnotations(),console.log("LiveButtonMenu::_resizeVideoAnnotationCanvas, success this time")):console.error("LiveButtonMenu::_resizeVideoAnnotationCanvas, no canvas found!")}else{const e=350,t=262;this._videoCanvasCtx.canvas.width=e,this._videoCanvasCtx.canvas.height=t,this.redrawVideoAnnotations()}}_clearAnnotations(){this._canvasCtx&&(this._canvasCtx.clearRect(0,0,this._canvasCtx.canvas.width,this._canvasCtx.canvas.height),this._annotationList=[])}_clearVideoAnnotations(){console.log("_clearVideoAnnotations"),this._videoCanvasCtx&&(this._videoCanvasCtx.clearRect(0,0,this._videoCanvasCtx.canvas.width,this._videoCanvasCtx.canvas.height),this._videoAnnotationList=[])}_setChannelIconText(){const e=$(".oracle-live"),t=$(".oracle-live-video-panel-channel-icon"),i=$(".oracle-live-callinfo-channel-icon");e.hasClass("oracle-live-external-audio")?(t.prop("title",this._messages.application_universal_tooltip_audio_external).attr("aria-label",this._messages.application_universal_tooltip_audio_external),i.prop("title",this._messages.application_universal_tooltip_audio_external).attr("aria-label",this._messages.application_universal_tooltip_audio_external)):e.hasClass("oracle-live-video-enduser-on")?(t.prop("title",this._messages.application_universal_tooltip_video_call).attr("aria-label",this._messages.application_universal_tooltip_video_call),i.prop("title",this._messages.application_universal_tooltip_video_call).attr("aria-label",this._messages.application_universal_tooltip_video_call)):e.hasClass("oracle-live-screenshare-enduser-on")?(t.prop("title",this._messages.application_universal_tooltip_screenshare_call).attr("aria-label",this._messages.application_universal_tooltip_screenshare_call),i.prop("title",this._messages.application_universal_tooltip_screenshare_call).attr("aria-label",this._messages.application_universal_tooltip_screenshare_call)):(t.prop("title",this._messages.application_universal_tooltip_audio_call).attr("aria-label",this._messages.application_universal_tooltip_audio_call),i.prop("title",this._messages.application_universal_tooltip_audio_call).attr("aria-label",this._messages.application_universal_tooltip_audio_call))}addRemoteVideo(e,t,i){console.log("addRemoteVideo id: "+e+" uri: "+t+" hide: "+i);let o,s=document.createElement("div");s.classList.add("oracle-live-remote-video-container"),i||s.classList.add("oracle-live-streaming"),document.querySelector(".oracle-live-remote-video-container.oracle-live-video-current")||s.classList.add("oracle-live-video-current"),(o="Share"===t?t:this._impl.getAssociateName(t))?s.dataset.name=o:(console.log("addRemoteVideo: Starting video element with no known label"),s.dataset.name=""),s.dataset.uri=t,s.dataset.avid=e;let n=document.createElement("div");n.classList.add("oracle-live-video-pause-graphic");let a=document.createElement("span"),r=document.createElement("div");r.classList.add("oracle-live-video-stream-label"),a.innerText=o;let l=document.createElement("video");l.id="oracle-live-remote-video-"+e,l.classList.add("oracle-live-remote-video"),l.setAttribute("autoplay",""),l.setAttribute("playsinline",""),l.setAttribute("preload","metadata");let c=document.createElement("div");c.classList.add("oracle-live-video-maximize-camera-backing");let d=document.createElement("div");if(d.classList.add("oracle-live-video-maximize-camera"),d.setAttribute("name",e),d.setAttribute("role","button"),d.setAttribute("tabindex","0"),"screenshare"===e){let e=document.createElement("div");e.classList.add("oracle-live-video-buttons-zoom");let t=document.createElement("div"),i=document.createElement("div"),o=document.createElement("div");t.setAttribute("role","button"),i.setAttribute("role","button"),o.setAttribute("role","button"),t.setAttribute("tabindex","button"),i.setAttribute("tabindex","button"),o.setAttribute("tabindex","button"),i.setAttribute("aria-disabled","true"),o.setAttribute("aria-disabled","true"),t.classList.add("oracle-live-video-zoomin-button"),i.classList.add("oracle-live-video-default-button"),o.classList.add("oracle-live-video-zoomout-button"),t.innerText="+",i.innerText=this._messages.application_universal_message_zoom_default_text,o.innerText="-",e.appendChild(t),e.appendChild(i),e.appendChild(o),s.appendChild(e),l.classList.add("oracle-live-remote-screenshare");let n=document.createElement("div");n.classList.add("oracle-live-video-scroller"),n.appendChild(l),s.appendChild(n)}else s.appendChild(l);r.appendChild(a),s.appendChild(n),s.appendChild(r),s.appendChild(c),s.appendChild(d),document.querySelector(".oracle-live-remote-videos").prepend(s);const u=this.countRemoteVideos();return console.log("LiveButtonMenu:Added video: "+l.id+" now "+u+" streaming"),u}activateRemoteVideo(e,t){t?$(".oracle-live-remote-video-container[data-avid='"+e+"']").addClass("oracle-live-streaming"):$(".oracle-live-remote-video-container[data-avid='"+e+"']").removeClass("oracle-live-streaming");const i=this.countRemoteVideos();return console.log("LiveButtonMenu:activate "+t+" video: "+e+" now "+i+" streaming"),i}}}),define("LiveState",["LiveEvents","LiveButtonMenu","LiveSessionStore"],function(LiveEvents,LiveButtonMenu,LiveSessionStore){"use strict";const Paused={None:"None",Local:"Local",Remote:"Remote"};let prevLayout=null,isResume=!1;const Layout={Horizontal:"Horizontal",Vertical:"Vertical",Single:"Single"},Name={Idle:"Idle",Connecting:"Connecting",Connected:"Connected",Transferring:"Transferring",RequestingCallback:"RequestingCallback",ReconnectingLocal:"ReconnectingLocal",ReconnectingRemote:"ReconnectingRemote",Disconnecting:"Disconnecting",Disconnected:"Disconnected",PreCallIDCheck:"PreCallIDCheck"},TransferState={None:"None",Started:"Started",AssociateObtained:"AssociateObtained",RemoveOriginalAssociate:"RemoveOriginalAssociate"},TransferMode={None:"None",Transfer:"Transfer",AddParticipant:"AddParticipant"},Rating={Poor:1,Good:50,Excellent:100};class AbstractState{constructor(e){if(new.target===AbstractState)throw"Cannot instantiate abstract State";this._context=e}get context(){return this._context}get name(){return"Invalid"}enter(){}leave(){}start(){}pause(){}muteLocalAudio(){}showMenuMore(){}toggleVideo(){}toggleCobrowse(){}stopCobrowse(){}toggleScreenShare(){}toggleScreenShareAnnotate(){}end(){}notification_close(){console.log("Close notification")}dialog_ok(){return this.context.menu.closeMessageDialog()}dialog_cancel(){console.log("Dialog Cancel ignored")}dialog_close(){console.log("AbstractState: dialog_close ignored")}video_preview_start(){console.log("Start in video preview ignored")}video_preview_cancel(){console.log("Cancel in video preview ignored")}poor(){}good(){}excellent(){}changeSize(e){}hideVideo(){}hideLocalVideo(){}swapCamera(){}event(e,t){switch(e){case LiveEvents.LiveMessageEmitted:this.context.menu.displayMessageDialog(t);break;default:console.log("Ignore event: "+e,t||"")}}remoteResume(){console.log("remoteResume request"),isResume=!0,this.context.paused===Paused.Remote?this.context.controller.resumeCallWithAssociate()?(this.context.menu.setPausedByAssociate(!1),this.context.paused=Paused.None):console.log("Unable to resume call with associate"):console.log("Invalid remote resume request, paused context is: "+this.context.paused)}remotePause(){console.log("remotePause request"),this.context.paused===Paused.None&&(this.context.paused=Paused.Remote,this.context.menu.setPausedByAssociate(!0),this.context.controller.holdCallWithAssociate())}localPauseResume(){if(console.log("LiveState::localPauseResume, previewActive="+this.context.previewActive+", oldPausedState="+this.context.paused),!0!==this.context.previewActive)switch(this.context.paused){case Paused.None:this.context.paused=Paused.Local,this.context.menu.setPausedByUser(!0),this.context.controller.holdCallWithAssociate();break;case Paused.Local:this.context.paused=Paused.None,this.context.menu.setPausedByUser(!1),this.context.controller.resumeCallWithAssociate()}else console.log("Ignore pause/resume when preview is active")}remoteUpgrade(e){console.log("remoteUpgrade"),this.context.associateVideoOn=!0,this.context.maximizedFeed=null,isResume?(this.context.menu.activateRemoteVideo(e,!0)>1&&"Single"!==prevLayout?this.toggleRemoteLayout(Layout.Vertical):this.context.menu.activateRemoteVideo(e,!0)>1&&"AddParticipant"===this._transferMode&&this.toggleRemoteLayout(Layout.Vertical),isResume=!1):this.context.menu.activateRemoteVideo(e,!0)>1&&this.toggleRemoteLayout(Layout.Vertical),this.context.menu.setAssociateVideoOn(!0,e)}reset(){this.context.state=Idle}collapseExpand(){this.context.collapsed=!this.context.collapsed,this.context.menu.setCollapsed(this.context.collapsed),this.context.collapsed?this._maximizedFeed=null:this.context.hiddenVideo&&(this.context.hiddenVideo=!1)}startCall(){console.log("--\x3e startCall"),this.context.menu.showStartCallDialog(!1),this.context.menu.hideRequestCallbackDialog(),console.log("Idle::start requirePreview="+this.context.isStartWithEndUserVideo()),console.log("Idle::start isPreCallIDCheck="+this.context.isPreCallIDCheck()),this.context.menu.showMessagingPanel(!1),this.context.menu.resetMessagingHistory(),this.context.isPreCallIDCheck()?(console.log("LiveState: about to initiate a preCallIDCheck"),this.context.state=PreCallIDCheck):this.context.isStartWithEndUserVideo()?(this.context.previewActive=!0,this.context.controller.startVideoPreview(),this.context.menu.showVideoPreview(!0)):(this.context.showMenu(!0),this.context.menu.showComponent(),this.context.state=Connecting)}endCall(){console.log("--\x3e endCall"),this.context.controller.endCallWithAssociate(),this.context.menu.showVideoPreview(!1),this.context.controller.stopVideoPreview(!0),this.context.state=Idle}registerForCallback(){console.log("Register for callback...");const e=this.context.controller.getCallbackPhoneNumber();console.log("Callback phone number: "+e);const t=this.context.controller.getCallbackCountryCode(),i=t+e;console.log("Callback country code: "+t);const o=this.context.controller.validateCallbackPhoneNumber(t,e);return o&&(this.context.controller.stopConnectingTimers(),this.context.menu.hideRequestCallbackDialog(),this.context.controller.registerForCallback(i)),o}maximizeAssociateScreenShare(){this.context.controller._permanentTwoWayScreenShare||"associateVideo"===this.context.menu.getMaximizedFeed()&&this.context.menu.maximize("associateScreenShare",!0)}toggleStreamMenu(e,t){}toggelRemoteLayout(e){}activateRemoteVideo(e,t){}}class Idle extends AbstractState{constructor(e,t){console.log("Constructor for Idle State",e,t),super(e),super.context.controller.initIdle(),super.context.menu.setIdle(),super.context.configureComponent(),super.context.controller.service.startCallDirectly&&super.context.menu.hideComponent()}get name(){return Name.Idle}start(){console.log("---\x3e Idle:start()"),super.context.controller.isCallbackOnly()&&super.context.controller.callbackAvailable()?super.context.menu.showRequestCallbackDialog(super.context.menu.messages.application_universal_call_message_offer_callback_message):super.context.isMeeting||super.context.isPreCallIDCheck()||super.context.controller.service.startCallDirectly?super.startCall():super.context.previewActive||(super.context.controller.service.skipRecordingPermissionRequest?super.startCall():super.context.menu.showStartCallDialog(!0))}dialog_ok(){super.dialog_ok()||(super.context.isCallbackOnly()?super.registerForCallback():(this.context.menu.showStartCallDialog(!1),super.context.menu._startInScreenShare?super.context.controller._screen.makeBrowserScreenShareRequest(super.context.menu).then(e=>{super.context.controller._screen._prefetchedBrowserSSStream.getVideoTracks()[0].onended=(()=>{super.endCall(),super.context.menu.showTimedDialog(super.context.menu.messages.application_universal_message_screenshare_stopped)}),super.startCall()},e=>{super.context.menu.showTimedDialog(super.context.menu.messages.application_universal_message_screenshare_stopped)}):super.startCall()))}dialog_cancel(){super.context.menu.showStartCallDialog(!1),super.context.menu.hideRequestCallbackDialog()}dialog_close(){super.context.menu.closeTimedDialog()}video_preview_start(){console.log("---\x3e Idle:video_preview_start moving to Connecting state"),super.context.state=Connecting,super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0),super.context.controller._av.startVideo(!0)}video_preview_cancel(){super.context.previewActive=!1,super.context.menu.showVideoPreview(!1),super.context.controller.stopVideoPreview(!0),super.context.controller.service.startCallDirectly&&super.context.menu.hideComponent()}changeSize(e){const t=e!==super.context.menu.getMaximizedFeed();super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null}swapCamera(){super.context.menu.swapCamera()}verificationTryAgain(){console.log("LiveState::idle::verificationTryAgain"),this.context.controller.resetPreCallIDCheckState()}event(e,t){switch(e){case LiveEvents.LiveStartCall:console.log("Received event LiveStartCall"),this.start();break;case LiveEvents.LiveCanceled:super.context.menu.setCancelled(!0);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveDiagnosticsAudioVideoStarted:super.context.menu.setDiagnostics(!0,"video");break;case LiveEvents.LiveDiagnosticsAudioStarted:super.context.menu.setDiagnostics(!0,"audio");break;case LiveEvents.LiveDiagnosticsComplete:super.context.menu.setDiagnostics(!1);break;case LiveEvents.LiveLocalVideoStopped:super.context.previewActive&&(console.log("Cannot show video preview - continue as audio"),this.video_preview_cancel(),console.log("--\x3e Idle:LiveLocalVideoStopped moving to Connecting state"),super.context.state=Connecting);break;case LiveEvents.LiveCallbackRegister:super.context.state=RequestingCallback,super.context.menu.setRequestingCallback(!0);break;default:super.event(e,t)}}}class RequestingCallback extends AbstractState{constructor(e,t){super(e)}get name(){return Name.RequestingCallback}enter(){super.enter()}leave(){super.leave()}start(){}end(){}dialog_ok(){!super.dialog_ok()&&super.context.isCallback()&&super.registerForCallback()}dialog_cancel(){super.context.menu.hideRequestCallbackDialog(),super.endCall()}dialog_close(){super.context.menu.closeTimedDialog()}event(e,t){switch(e){case LiveEvents.LiveCallbackRegisterSuccess:console.log("LiveEvents.LiveCallbackRegisterSuccess triggered"),this.context.state=Idle;break;case LiveEvents.LiveCallbackRegisterFailure:console.log("LiveEvents.LiveCallbackRegisterFailure triggered"),this.context.state=Idle;break;default:super.event(e,t)}}}class Connecting extends AbstractState{constructor(e,t){super(e),console.log("Connecting state"),super.context.controller._isAssociateConnected=!0;const i=super.context.isShortCodeEnabled(),o=super.context.isMeeting;console.log("LiveState::shortCodeEnabled =",i),o&&console.log("LiveState::isMeeting, ignoring shortCodeEnabled");let s=null;!o&&i&&(s=super.context.controller.generateShortCode(),console.log("Short code is ",s)),super.context.controller._simulatePstn&&!super.context.controller._simulatePstn.startsWith("in")&&(s=super.context._simulatePstn,console.log("Simulate Outbound Code: ",s)),super.context.menu.setConnecting(s),super.context.controller.initCallWithAssociate(null,s)}get name(){return Name.Connecting}enter(){super.enter(),super.context.controller._isAssociateConnected=!0,super.context.menu.setConnectingAudio(!0)}leave(){super.leave(),super.context.menu.setConnectingAudio(!1)}start(){console.log("Customer action to end call"),super.context.controller._endCallReason="userCanceled",super.endCall()}startLocalVideo(){super.context.controller.startVideoPreview()}end(){super.endCall()}dialog_ok(){!super.dialog_ok()&&super.context.isCallback()&&super.registerForCallback()}dialog_cancel(){console.log("dialog cancel in state connecting: "+super.context.menu._isCallbackDialogVisible),super.context.menu._isCallbackDialogVisible&&(super.context.menu.hideRequestCallbackDialog(),null===super.context.controller._connectionTimer&&(console.log("Connecting timer has expired, so ending the call"),this.end()))}changeSize(e){const t=e!==super.context.menu.getMaximizedFeed();super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null}swapCamera(){super.context.menu.swapCamera()}event(e,t){switch(e){case LiveEvents.LiveWaiting:super.context.menu.setWaiting(!0);break;case LiveEvents.LiveCanceled:super.context.menu.setCancelled(!0);break;case LiveEvents.LiveConnecting:super.context.menu.setWaiting(!1);break;case LiveEvents.LiveConnected:super.context.state=Connected;break;case LiveEvents.LiveConnectingNoAnswer:case LiveEvents.LiveConnectingError:case LiveEvents.LiveConnectingTeamBusy:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveParticipantLeft:case LiveEvents.LiveEnded:super.endCall();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveRemoteVideoStarted:console.log("LiveState::Got LiveRemoteVideoStarted"),super.remoteUpgrade(t);break;case LiveEvents.LiveRemoteVideoStopped:console.log("LiveState::Got LiveRemoteVideoStop"),super.context.associateVideoOn=!1,this.context.menu.activateRemoteVideo(t,!1),super.context.menu.setAssociateVideoOn(!1,t);break;case LiveEvents.LiveLocalVideoStarted:console.log("LiveState::Got LiveLocalVideoStarted"),super.context.userVideoOn=!0,super.context.menu.setEndUserVideoOn(!0);break;case LiveEvents.LiveLocalVideoStopped:super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveDiagnosticsAudioVideoStarted:super.context.menu.setDiagnostics(!0,"video");break;case LiveEvents.LiveDiagnosticsAudioStarted:super.context.menu.setDiagnostics(!0,"audio");break;case LiveEvents.LiveDiagnosticsComplete:super.context.menu.setDiagnostics(!1);break;case LiveEvents.LiveDiagnosticsFailed:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveCallQueuePositionUpdate:super.context.menu.updatePositionInQueue(super.context.controller.getPositionInQueue());break;case LiveEvents.LiveCallbackPromptUser:if(t){let e=t;console.log("reason: "+e);let i=null,o=null,s=!1;e.startsWith("Associate is busy")||e.startsWith("No associate is available")?(console.log("Handling "+e),i=super.context.menu.messages.application_universal_call_message_offer_callback_message,o=LiveEvents.LiveConnectingNoAnswer,s=e.startsWith("No associate is available")):(e.startsWith("No team is available")||e.startsWith("The associate team is busy"))&&(console.log("Handling "+e),i=super.context.menu.messages.application_universal_call_message_offer_callback_message_no_team,o=LiveEvents.LiveConnectingTeamBusy,s=!0),s&&(super.context.state=Disconnected,super.context.menu.setDisconnected(!1,o)),super.context.controller.callbackAvailable()&&super.context.controller._callbackAlreadyOfferred&&console.log("Callback already offered previously, so not offering callback prompt to user"),super.context.controller.callbackAvailable()&&!super.context.controller._callbackAlreadyOfferred&&(console.log("showing RequestCallbackDialog"),super.context.menu.showRequestCallbackDialog(i))}else console.error("Connecting state: Cannot display callback dialog because no reason was specified"),super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveCallbackRegisterSuccess:super.context.menu.hideRequestCallbackDialog(),super.context.state=Idle;break;default:super.event(e,t)}}}class Connected extends AbstractState{constructor(e,t){super(e),console.log("Connected state"),super.context.controller._isAssociateConnected=!0,t===Name.Connecting&&super.context.menu.setConnected()}get name(){return Name.Connected}enter(){super.enter()}leave(){super.leave()}start(){super.collapseExpand()}remoteResume(){super.remoteResume()}remotePause(){super.remotePause()}pause(){super.localPauseResume()}toggleVideo(){console.log("toggleVideo in Connected state"),super.context.paused===Paused.None?(super.context.userVideoOn?(super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1),super.context.controller.downgradeLocalVideo(),super.context.localMute&&super.context.menu.muteLocalAudio(!0,!0)):super.context.isEndUserVideoPossible()&&(super.context.previewActive=!0,super.context.controller._isMeeting&&(super.context.controller._rehydratingToState=null),super.context.controller.startVideoPreview(),console.log("super.context.controller._av._haveAskedUserPermissionForSharingVideo = "+super.context.controller._av._haveAskedUserPermissionForSharingVideo),super.context.controller._av._haveAskedUserPermissionForSharingVideo?(super.context.menu.showVideoPreview(!1),super.context.menu.setEndUserVideoOn(!0)):super.context.menu.showVideoPreview(!0)),super.context.showMoreMenu&&this.showMenuMore()):console.log("Ignore video button in paused state",super.context.paused)}toggleScreenShare(){super.context.paused===Paused.None?(super.context.userScreenShareOn?super.context.controller.sendScreenShare(!1):super.context.isEndUserScreenSharePossible()&&super.context.controller.sendScreenShare(!0),super.context.showMoreMenu&&this.showMenuMore()):console.log("Ignore video button in paused state",super.context.paused)}toggleScreenShareAnnotate(){super.context.userScreenShareOn&&(super.context.menu.isEndUserAnnotationOn()?super.context.menu.setEndUserAnnotationOn(!1):super.context.menu.setEndUserAnnotationOn(!0),super.context.userScreenShareAnnotationOn=super.context.menu.isEndUserAnnotationOn(),super.context.showMoreMenu&&this.showMenuMore())}toggleCobrowse(){super.context.paused===Paused.None?(super.context.cobrowseOn?super.context.controller.startCobrowse(!1):super.context.isEndUserCobrowsePossible()&&super.context.controller.startCobrowse(!0),super.context.showMoreMenu&&this.showMenuMore()):console.log("Ignore cobrowse button in paused state",super.context.paused)}stopCobrowse(){super.context.controller.startCobrowse(!1)}video_preview_start(){super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0),super.context.menu._setTitle(),console.log("Connected::preview-start: associateVideoOn=",super.context.associateVideoOn),super.context.controller.upgradeLocalVideo(),super.context.localMute&&super.context.menu.muteLocalAudio(!0,!0)}video_preview_cancel(){super.context.previewActive=!1,super.context.controller.stopVideoPreview(!1),super.context.menu.showVideoPreview(!1)}end(){super.context.state=Disconnecting}changeSize(e){if(e.startsWith("av"))this.toggleRemoteLayout(Layout.Single),super.context.menu.maximize(e,!0),this.maximizedFeed="associateVideo",super.context.showMoreMenu&&this.showMenuMore();else{console.log("LiveState::changeSize: feed ="+e+", max feed=",super.context.menu.getMaximizedFeed()),console.log("LiveState::changeSize: maximizedFeed = "+super.context.menu.getMaximizedFeed());const t=e!==super.context.menu.getMaximizedFeed();console.log("LiveState::changeSize: maximize = "+t),super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null,super.context.showMoreMenu&&this.showMenuMore(),"endUserVideo"!==e&&"associateVideo"!==e||this.toggleRemoteLayout(Layout.Single)}}hideVideo(){super.context.hiddenVideo=!0,super.context.menu.hideVideo()}hideLocalVideo(){super.context.hiddenLocalVideo=!0,super.context.menu.hideLocalVideo()}muteLocalAudio(){console.log("muteLocalAudio in LiveState"),super.context.localMute?(super.context.menu.muteLocalAudio(!1),super.context.localMute=!1):(super.context.menu.muteLocalAudio(!0),super.context.localMute=!0)}showMenuMore(){super.context.showMoreMenu?(super.context.menu.showMenuMore(!1),super.context.showMoreMenu=!1):(super.context.menu.showMenuMore(!0),super.context.showMoreMenu=!0)}swapCamera(){super.context.menu.swapCamera()}dialog_ok(){if(!super.dialog_ok()){if($(".oracle-live").hasClass("oracle-live-install-plugin-request"))return console.log("The user is permitting the chrome plugin install!"),super.context.menu.showInstallChromeScreenSharePluginRequest(!1),void super.context.controller.installChromeScreenSharePlugin();if($(".oracle-live").hasClass("oracle-live-installed-plugin"))return console.log("The user is confirming the offer to share screen after the plugin install"),super.context.menu.showInstalledChromeScreenSharePlugin(!1),void super.context.controller.sendScreenShare(!0);if($(".oracle-live").hasClass("oracle-live-unfreeze-annotation"))return console.log("The user is confirming unfreezing annotation"),super.context.menu.showUnfreezeAnnotationDialog(!1),super.context.menu.setFrozenAnnotationOn(!1),void super.context.menu.setAssociateVideoAnnotationOn(!1,!0);super.context.menu.showShareRequest(!1),super.context.controller.upgradeRequestIsAssociateScreenShare()?super.context.controller.acceptUpgradeRequest():super.context.controller.upgradeRequestIsUserScreenShare()?this.toggleScreenShare():super.context.controller.isRequestUserCobrowse()?this.context.controller._cobrowse.start():(super.context.previewActive=!0,super.context.controller.startVideoPreview(),console.log("showVideoPreview(true)"),super.context.controller._av._haveAskedUserPermissionForSharingVideo?(super.context.previewActive=!1,super.context.menu.showVideoPreview(!1),super.context.menu.setEndUserVideoOn(!0)):super.context.menu.showVideoPreview(!0))}}dialog_cancel(){return $(".oracle-live").hasClass("oracle-live-install-plugin-request")?(console.log("The user is declining the offer to install the chrome plugin"),super.context.menu.showInstallChromeScreenSharePluginRequest(!1),void super.context.controller.declineUpgradeRequest()):$(".oracle-live").hasClass("oracle-live-installing-plugin")?(console.log("The user is canceling the wait for the chrome plugin install"),super.context.menu.showInstallingChromeScreenSharePlugin(!1),void super.context.controller.cancelChromeScreenSharePluginInstall()):$(".oracle-live").hasClass("oracle-live-installed-plugin")?(console.log("The user is canceling the offer to share screen after the plugin install"),super.context.menu.showInstalledChromeScreenSharePlugin(!1),void super.context.controller.declineUpgradeRequest()):$(".oracle-live").hasClass("oracle-live-unfreeze-annotation")?($("body").css("visibility","hidden"),$(".oracle-live").css("visibility","visible"),console.log("The user is canceling the unfreeze annotation"),void super.context.menu.showUnfreezeAnnotationDialog(!1)):(super.context.menu.showShareRequest(!1),void super.context.controller.declineUpgradeRequest())}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveParticipantLeft:console.log("Connected:LiveParticipantLeft: -> ParticipantLeft"),console.log("TRANSFER: TransferState = "+super.context.transferState),super.context.isTransferring()?console.log("TRANSFER: TransferingCall: Participant has left."):super.context._controller.getNumberOfParticipantsInConversation()>=2?console.log("Have 2 or more participants in the call. Maintaining current state"):(console.log("Not a transfer call, so disconnecting call."),super.context.state=Disconnected);break;case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveReconnectingLocal:super.context.state=ReconnectingLocal;break;case LiveEvents.LiveReconnectingRemote:super.context.state=ReconnectingRemote;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveScreenSharePluginRequired:console.log("Trying to show the Chrome plugin install permission dialog"),super.context.menu.showInstallChromeScreenSharePluginRequest(!0);break;case LiveEvents.LiveScreenSharePluginInstalling:console.log("Showing a dialog that the Chrome plugin install is in progress"),super.context.menu.showInstallingChromeScreenSharePlugin(!0);break;case LiveEvents.LiveScreenSharePluginInstalled:console.log("Closing the dialog that the Chrome plugin install is in progress"),super.context.menu.showInstallingChromeScreenSharePlugin(!1),super.context.menu.showInstalledChromeScreenSharePlugin(!0);break;case LiveEvents.LiveStartVideoRequested:super.context.menu.showShareRequest(!0,"user-video");break;case LiveEvents.LiveRemoteScreenShareRequested:super.context.menu.showShareRequest(!0,"associate-screenshare");break;case LiveEvents.LiveStartScreenShareRequested:super.context.menu.showShareRequest(!0,"user-screenshare");break;case LiveEvents.LiveStartVideoRequestCancelled:case LiveEvents.LiveRemoteScreenShareCancelled:case LiveEvents.LiveStartScreenShareRequestCancelled:super.context.menu.showShareRequest(!1);break;case LiveEvents.LiveRemoteVideoStarted:super.remoteUpgrade(t);break;case LiveEvents.LiveRemoteVideoStopped:super.context.associateVideoOn=!1,this.context.menu.activateRemoteVideo(t,!1),super.context.menu.setAssociateVideoOn(!1,t);break;case LiveEvents.LiveRemoteVideoRemoved:{console.log("LiveState::Got LiveRemoteVideoRemoved"),this.context.menu.activateRemoteVideo(t,!1);const e=super.context.menu.countRemoteVideos();e<2&&(super.context.remoteLayout=super.context.menu.toggleRemoteLayout(Layout.Single),0===e&&super.context.menu.setAssociateVideoOn(!1,t));break}case LiveEvents.LiveRemoteVideoLoading:super.context.menu.setVideoLoading(!0);break;case LiveEvents.LiveRemoteVideoLoaded:super.context.menu.setVideoLoading(!1);break;case LiveEvents.LiveLocalVideoStarted:super.context.userVideoOn=!0,super.context.menu.setEndUserVideoOn(!0);break;case LiveEvents.LiveLocalVideoStopped:super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1);break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveRemoteScreenStarted:super.context.associateScreenOn=!0,super.context.menu.setAssociateScreenShareOn(!0),this.context.controller._permanentTwoWayScreenShare&&(super.context.menu.maximize("screenshare",!0),super.context.menu._enableZoom(!0),this.maximizedFeed="associateVideo");break;case LiveEvents.LiveRemoteScreenStopped:super.context.associateScreenOn=!1,super.context.menu.setAssociateScreenShareOn(!1);break;case LiveEvents.LiveRemoteScreenActive:super.maximizeAssociateScreenShare();break;case LiveEvents.LiveLocalScreenStarted:super.context.userScreenShareOn=!0,super.context.menu.setEndUserScreenShareOn(!0);break;case LiveEvents.LiveLocalScreenStopped:super.context.userScreenShareOn=!1,super.context.menu.setEndUserScreenShareOn(!1);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveSystemScreenShareDialogShowing:super.context.menu.setScreenShareDialogShowing(!0);break;case LiveEvents.LiveSystemScreenShareDialogRemoved:super.context.menu.setScreenShareDialogShowing(!1);break;case LiveEvents.LiveAssociateAnnotationStarted:super.context.menu.setAssociateAnnotationOn(!0);break;case LiveEvents.LiveAssociateAnnotationStopped:super.context.menu.setAssociateAnnotationOn(!1);break;case LiveEvents.LiveAssociateAnnotationReceived:super.context.menu.displayAssociateAnnotation(t);break;case LiveEvents.LiveAssociateVideoAnnotationStarted:super.context.menu.setAssociateVideoAnnotationOn(!0);break;case LiveEvents.LiveAssociateVideoAnnotationStopped:super.context.menu.setAssociateVideoAnnotationOn(!1);break;case LiveEvents.LiveAssociateVideoAnnotationReceived:super.context.menu.displayAssociateVideoAnnotation(t);break;case LiveEvents.LiveAssociateFreezeCustomerStream:super.context.menu.setFrozenAnnotationOn(!0);break;case LiveEvents.LiveAssociateUnfreezeCustomerStream:super.context.menu.setFrozenAnnotationOn(!1,!0);break;case LiveEvents.LiveAssociateTransferStarted:console.log("TRANSFER: Connected: TransferStarted"),super.context.userScreenShareOn&&(console.log("TRANSFER: Turning screenshare off when transfer starts"),this.toggleScreenShare()),this._transferMode="Transfer",super.context.state=Transferring;break;case LiveEvents.LiveCobrowseRequest:super.context.controller.setIsRequestUserCobrowse(!0),super.context.menu.showShareRequest(!0,"associate-cobrowse");break;case LiveEvents.LiveCobrowseStart:super.context.controller.setIsRequestUserCobrowse(!0),super.context.menu.showShareRequest(!0,"user-cobrowse");break;case LiveEvents.LiveCobrowseStarted:super.context.menu.userCobrowseOn=!0,super.context.menu.setEndUserCobrowseOn(!0);break;case LiveEvents.LiveCobrowseEnded:super.context.menu.userCobrowseOn=!1,super.context.menu.setEndUserCobrowseOn(!1),super.context.menu.setCobrowseEnded(t),super.context.menu.showShareRequest(!1);break;case LiveEvents.LiveAssociateAddParticipantStarted:console.log("TRANSFER: Connected: AddParticipantStarted"),super.context.userScreenShareOn&&(console.log("TRANSFER: Turning screenshare off when transfer starts"),this.toggleScreenShare()),this._transferMode="AddParticipant";break;case LiveEvents.LiveAssociateAddParticipantStartStream:console.log("Transferring: AddParticipantStartStream");break;case LiveEvents.LiveAssociateAddParticipantCompleted:console.log("Transferring: AddParticipantComplete"),super.context.menu.setTransferredToAnotherAssociate(t),super.context.userScreenShareOn=!1,super.context.menu.showNotificationAssociateJoined();break;case LiveEvents.LiveAssociateAddParticipantFailed:console.log("Transferring: AddParticipantFailed"),super.context.menu.cancelCallTransfer();break;case LiveEvents.LiveAssociateAddParticipantStopped:console.log("Transferring: AddParticipantStopped"),super.context.menu.cancelCallTransfer(),super.remoteResume();break;default:super.event(e,t)}}unfreezeAnnotation(){const e=$(".oracle-live");e.hasClass("oracle-live-paused-associate")||(e.hasClass("oracle-live-frozen-annotation")?super.context.menu.showUnfreezeAnnotationDialog(!0):super.context.menu.setAssociateVideoAnnotationOn(!1,!0))}toggleStreamMenu(e,t){super.context.menu.toggleStreamMenu(e,t)}toggleRemoteLayout(e){if(e)super.context.remoteLayout=e;else switch(super.context.remoteLayout){case Layout.Horizontal:super.context.remoteLayout=Layout.Vertical;break;case Layout.Vertical:super.context.remoteLayout=Layout.Single;break;case Layout.Single:super.context.remoteLayout=Layout.Vertical;break;default:super.context.remoteLayout=Layout.Single}super.context.remoteLayout=super.context.menu.toggleRemoteLayout(super.context.remoteLayout),prevLayout=super.context.remoteLayout,console.log("Previous layout status ",prevLayout)}nextRemoteVideo(){super.context.menu.nextRemoteVideo()}prevRemoteVideo(){super.context.menu.prevRemoteVideo()}addRemoteVideo(e,t,i){console.log("Adding remote video and checking layout"),super.context.menu.addRemoteVideo(e,t,i)>1?this.toggleRemoteLayout(Layout.Vertical):this.toggleRemoteLayout(Layout.Single)}activateRemoteVideo(e,t){super.context.menu.activateRemoteVideo(e,t)>1&&"Single"!==prevLayout?this.toggleRemoteLayout(Layout.Vertical):this.toggleRemoteLayout(Layout.Single)}}class Transferring extends AbstractState{constructor(e,t){super(e),super.context.menu.setTransferringToAnotherAssociate(!0)}get name(){return Name.Transferring}enter(){super.enter()}leave(){super.leave()}start(){}end(){}addRemoteVideo(e,t,i){console.log("Transferring:addRemote and checking layout"),super.context.menu.addRemoteVideo(e,t,i)}event(e,t){switch(e){case LiveEvents.LiveAssociateTransferStartStream:console.log("Transferring: TransferStartStream");break;case LiveEvents.LiveAssociateAddParticipantStartStream:console.log("Transferring: AddParticipantStartStream");break;case LiveEvents.LiveAssociateTransferCompleted:console.log("Transferring: TransferComplete"),super.context.state=Connected,super.context.menu.setTransferredToAnotherAssociate(t),super.context.userScreenShareOn=!1;break;case LiveEvents.LiveAssociateAddParticipantCompleted:console.log("Transferring: AddParticipantComplete"),super.context.state=Connected,super.context.menu.setTransferredToAnotherAssociate(t),super.context.userScreenShareOn=!1,super.context.menu.showNotificationAssociateJoined();break;case LiveEvents.LiveAssociateTransferFailed:console.log("Transferring: TransferFailed"),super.context.state=Connected,super.context.menu.cancelCallTransfer();break;case LiveEvents.LiveAssociateAddParticipantFailed:console.log("Transferring: AddParticipantFailed"),super.context.state=Connected,super.context.menu.cancelCallTransfer();break;case LiveEvents.LiveAssociateTransferStopped:console.log("Transferring: TransferStopped"),super.context.state=Connected,super.context.menu.cancelCallTransfer();break;case LiveEvents.LiveAssociateAddParticipantStopped:console.log("Transferring: AddParticipantStopped"),super.context.state=Connected,super.context.menu.cancelCallTransfer();break;default:super.event(e,t)}}}class ReconnectingLocal extends AbstractState{constructor(e,t){super(e),super.context.menu.setReconnectingEndUser(!0)}get name(){return Name.ReconnectingLocal}enter(){super.enter()}leave(){super.leave()}start(){super.collapseExpand()}remoteResume(){super.remoteResume()}remotePause(){super.remotePause()}pause(){super.localPauseResume()}end(){super.context.state=Disconnecting}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveStreamActive:case LiveEvents.LiveReconnectedLocal:super.context.menu.setPoorNetwork(!1),super.context.menu.setReconnectingEndUser(!1),super.context.controller.sendNetworkStatus("network_recover"),super.context.state=Connected;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveParticipantLeft:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;default:super.event(e,t)}}}class ReconnectingRemote extends AbstractState{constructor(e,t){super(e),super.context.menu.setReconnectingAssociate(!0)}get name(){return Name.ReconnectingRemote}enter(){super.enter()}leave(){super.leave()}start(){super.collapseExpand()}remoteResume(){super.remoteResume()}remotePause(){super.remotePause()}pause(){super.localPauseResume()}end(){super.context.state=Disconnecting}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveReconnectedRemote:super.context.menu.setReconnectingAssociate(!1),super.context.state=Connected;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveParticipantLeft:super.context.state=Disconnected,super.context.menu.setDisconnected(!1,e);break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;default:super.event(e,t)}}}class Disconnecting extends AbstractState{constructor(e,t){super(e),super.context.menu.setDisconnecting(!0)}get name(){return Name.Disconnecting}dialog_ok(){super.dialog_ok()||(super.context.state=Disconnected)}dialog_cancel(){super.context.menu.setDisconnecting(!1),super.context.state=Connected}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}event(e,t){switch(e){case LiveEvents.LiveEnded:super.context.state=Disconnected;break;case LiveEvents.LiveReconnectedRemote:super.context.menu.setReconnectingAssociate(!1),super.context.state=Connected;break;case LiveEvents.LivePausedRemotely:super.remotePause();break;case LiveEvents.LiveResumedRemotely:super.remoteResume();break;case LiveEvents.LiveRecordingStarted:super.context.menu.setRecording(!0);break;case LiveEvents.LiveRecordingStopped:super.context.menu.setRecording(!1);break;case LiveEvents.LiveRatingRequired:super.context.ratingRequired=!0;break;case LiveEvents.LiveNetworkPoor:super.context.menu.setPoorNetwork(!0);break;case LiveEvents.LiveNetworkNormal:super.context.menu.setPoorNetwork(!1);break;case LiveEvents.LiveLocalVideoStopped:super.context.userVideoOn=!1,super.context.menu.setEndUserVideoOn(!1);break;case LiveEvents.LivePreCallIDCheckComplete:case LiveEvents.LivePreCallIDCheckIncomplete:case LiveEvents.LivePreCallIDCheckCancelled:case LiveEvents.LivePreCallIDCheckFailed:super.context.state=Idle;break;default:super.event(e,t)}}}class Disconnected extends AbstractState{constructor(e,t){super(e);try{super.context.controller.endCallWithAssociate()}catch(e){console.error("LiveState::DISCONNECTED::could not end the call because of ",e)}super.context.menu.setDisconnected(super.context.ratingRequired)}get name(){return Name.Disconnected}notification_close(){console.log("Close notification"),super.context.menu.closeNotificationMessage()}swapCamera(){super.context.menu.swapCamera()}dialog_ok(){if(super.dialog_ok(),super.context.menu._isCallbackDialogVisible&&super.context.isCallback())super.registerForCallback()&&(super.context.state=Idle);else{const e=super.context.rating;super.context.reset(),super.context.state=Idle,super.context.menu.sessionEnded(),e>0&&(super.context.controller._rest.sendPostCallRating(e,()=>{console.log("Submitted rating: "+e)}),super.context.controller.dispatchEvent(LiveEvents.LiveRatingCompleted))}super.context.menu.setAssociateName("")}enter(){super.enter(),super.context.controller._av.cancelTransferSwitchoverStream(),super.context.controller._offerCallbackTimer&&(clearTimeout(super.context.controller._offerCallbackTimer),super.context.controller._offerCallbackTimer=null)}leave(){super.leave()}start(){super.context.isMeeting&&(console.log("Rejoin a meeting"),super.startCall())}dialog_cancel(){super.context.menu._isCallbackDialogVisible?super.context.menu.hideRequestCallbackDialog():(console.log("Resetting state on cancel from what must have been post call rating dialog"),super.context.reset()),super.context.state=Idle}video_preview_start(){super.context.isMeeting&&(console.log("Rejoin a meeting"),console.log("---\x3e Disconnected:video_preview_start moving to Connecting state"),super.context.state=Connecting,super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0))}video_preview_cancel(){super.context.state=Idle,super.context.isMeeting&&super.context.menu.setCancelled(!0)}poor(){super.context.rating=Rating.Poor,super.context.menu.setRating("poor")}good(){super.context.rating=Rating.Good,super.context.menu.setRating("good")}excellent(){super.context.rating=Rating.Excellent,super.context.menu.setRating("excellent")}verificationSuccessContinue(){console.log("LiveState::disconnected::verificationSuccessContinue"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationTryAgain(){console.log("LiveState::disconnected::verificationTryAgain"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationEnd(){console.log("LiveState::disconnected::verificationEnd"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.context.controller.addClass(".oracle-live","oracle-live-preCallIDCheck-error")}event(e,t){switch(e){case LiveEvents.LivePreCallIDCheckComplete:case LiveEvents.LivePreCallIDCheckIncomplete:case LiveEvents.LivePreCallIDCheckCancelled:case LiveEvents.LivePreCallIDCheckFailed:super.context.state=Idle;break;default:super.event(e,t)}}}class PreCallIDCheck extends AbstractState{constructor(e,t){console.log("Constructor for PreCallIDCheck state",e,t),super(e),this.context.menu.setPreCallIDCheck(!0),this.context.controller.startPreCallIDCheck(window)}get name(){return Name.PreCallIDCheck}startPreCallIDCheck(){console.log("LiveState::PreCallIDCheck::starting")}continueVerification(){console.log("LiveState::PreCallIDCheck::continueVerification"),this.context.controller.continueVerification()}verificationSuccessContinue(){console.log("LiveState::PreCallIDCheck::verificationSuccessContinue"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationTryAgain(){console.log("LiveState::PreCallIDCheck::verificationTryAgain"),this.context.controller.resetPreCallIDCheckState(),super.context.state=Idle}verificationEnd(){console.log("LiveState::PreCallIDCheck::verificationEnd"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.context.controller.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.context.controller.addClass(".oracle-live","oracle-live-preCallIDCheck-error"),this.context.controller.netVerificationCancelled(LiveEvents.LivePreCallIDCheckCancelled),super.context.state=Idle}video_preview_start(){console.log("---\x3e LiveState::PreCallIDCheck::video_preview_start moving to Connecting state"),super.context.state=Connecting,super.context.previewActive=!1,super.context.menu.setEndUserVideoOn(!0)}video_preview_cancel(){console.log("LiveState::PreCallIDCheck::video_preview_cancel"),super.context.previewActive=!1,super.context.menu.showVideoPreview(!1),console.log("Stopping preview and cancelling call"),super.context.controller.stopVideoPreview(!0)}changeSize(e){const t=e!==super.context.menu.getMaximizedFeed();super.context.menu.maximize(e,t),this.maximizedFeed=t?e:null}startAssociateVerificationCall(){console.log("LiveState::PreCallIDCheck::startAssociateVerificationCall"),this.context.isStartWithEndUserVideo()?(console.log("startAssociateVerificationCall: starting video preview"),this.context.previewActive=!0,this.context.controller.startVideoPreview(),this.context.menu.showVideoPreview(!0)):(console.log("---\x3e startAssociateVerificationCall: moving to connecting state"),this.context.state=Connecting)}showRecordingDialog(){super.context.previewActive||super.context.controller.service.skipRecordingPermissionRequest||super.context.menu.showStartCallDialog(!0)}dialog_ok(){super.dialog_ok()||(super.context.menu.showStartCallDialog(!1),this.startAssociateVerificationCall())}dialog_cancel(){super.context.menu.showStartCallDialog(!1)}event(e,t){switch(console.log("LiveState::PreCallIDCheck:event ",e,t),e){case LiveEvents.LiveCanceled:super.context.menu.setCancelled(!0);break;case LiveEvents.LiveStartVerificationCall:this.showRecordingDialog();break;case LiveEvents.LiveDiagnosticsAudioVideoStarted:super.context.menu.setDiagnostics(!0,"video");break;case LiveEvents.LiveDiagnosticsAudioStarted:super.context.menu.setDiagnostics(!0,"audio");break;case LiveEvents.LiveDiagnosticsComplete:super.context.menu.setDiagnostics(!1);break;case LiveEvents.LivePreCallIDCheckComplete:case LiveEvents.LivePreCallIDCheckIncomplete:case LiveEvents.LivePreCallIDCheckCancelled:case LiveEvents.LivePreCallIDCheckFailed:super.context.state=Idle;break;default:super.event(e,t)}}}class LiveState{constructor(e){this._controller=e,this._buttonMenu=new LiveButtonMenu(e),this._state=new Idle(this,null),this._stateName=this._state.name,this._isMeeting=!1,this._associateName=null,this._associatePhotoURL=null,this._connectingAudioURL=null,this._positionInQueue=0,this._paused=Paused.None,this._collapsed=!1,this._rating=0,console.log("LiveState::constructor Setting rating required to false"),this._ratingRequired=!1,this._transferState=TransferState.None,this._transferMode=TransferMode.None,this._userVideo=!1,this._userScreen=!1,this._userScreenAnnotate=!1,this._associateVideo=!1,this._associateScreen=!1,this._previewActive=!1,this._hiddenVideo=!1,this._hiddenLocalVideo=!1,this._localMute=!1,this._showMoreMenu=!1,this._userCobrowse=!1,this._remoteLayout=Layout.Single,this._maximizedFeed=null,this._hideWhenIdle=!1,this._hidden=!1,this._available=!0,this._canRejoinMeeting=!0,this._messages=null,this._currentOrientation="portrait",this._mql=window.matchMedia("(orientation: portrait)"),this._mql.matches?this._currentOrientation="portrait":this._currentOrientation="landscape",this._mql.addListener(e=>{const t=e.matches?"portrait":"landscape";t!==this._currentOrientation&&this._orientationChanged(),this._currentOrientation=t,console.log(`LiveState::  ORIENTATION is now : ${t}`)}),LiveSessionStore.initState("LiveState",this),$(()=>{LiveSessionStore.loadState("LiveState",e=>{const t=e.stateName;this._stateSupportsRehydration(t)&&(this._stateName=e.stateName,this._positionInQueue=e.positionInQueue,this._associateName=e.associateName,this._associatePhotoURL=e.associatePhotoURL,this._connectingAudioURL=e.connectingAudioURL,this._paused=e.paused,this._collapsed=!1,this._maximizedFeed=e.maximizedFeed,this._associateVideo=e.associateVideo,this._userVideo=e.userVideo,this._isMeeting=e.isMeeting,this._canRejoinMeeting=e.canRejoinMeeting,this._userScreenAnnotate=e.userScreenAnnotate,this._associateScreen=e.associateScreen,this._previewActive=e.previewActive,this._hiddenVideo=e.hiddenVideo,this._hiddenLocalVideo=e.hiddenLocalVideo,this._rating=e.rating,this._transferState=e.transferState,this._transferMode=e.transferMode,this._ratingRequired=e.ratingRequired,this._hideWhenIdle=e.hideWhenIdle,this._hidden=e.hidden,this._available=e.available,this._messages=e.messages,this._currentOrientation=e.currentOrientation,console.log("LiveState: Loaded"))})})}toJSON(){return this._stateSupportsRehydration(this._stateName)?JSON.stringify({stateName:this._stateName,positionInQueue:this._positionInQueue,associateName:this._associateName,associatePhotoURL:this._associatePhotoURL,connectingAudioURL:this._connectingAudioURL,isMeeting:this._isMeeting,canRejoinMeeting:this._canRejoinMeeting,paused:this._paused,userVideo:this._userVideo,userScreenAnnotate:this._userScreenAnnotate,associateVideo:this._associateVideo,associateScreen:this._associateScreen,previewActive:this._previewActive,hiddenVideo:this._hiddenVideo,hiddenLocalVideo:this._hiddenLocalVideo,rating:this._rating,transferState:this._transferState,transferMode:this._transferMode,ratingRequired:this._ratingRequired,hideWhenIdle:this._hideWhenIdle,hidden:this._hidden,available:this._available,messages:this._messages,maximizedFeed:this._maximizedFeed,currentOrientation:this._currentOrientation}):null}loadComplete(){if(console.log("LiveState::loadComplete"),!this._stateSupportsRehydration(this._stateName))return void console.log("We will not have restored our state, stay in Idle");const stateClass=eval(this._stateName);this._state=new stateClass(this,null),console.log("LiveState::loadComplete restored state: ",this.stateName,this._buttonMenu);let recoverLocalVideoView=!1;"Connected"===this._stateName?(this._buttonMenu.setConnected(!0),this._hidden?this.hideMenu():this.showMenu()):"Disconnecting"===this._stateName?(this._buttonMenu.setConnected(!0),this._buttonMenu.setDisconnecting(!0),this._hidden?this.hideMenu():this.showMenu()):this.isEndUserVideo()&&(recoverLocalVideoView=!0),this._buttonMenu.updatePositionInQueue(this._positionInQueue),this._buttonMenu.setAssociateName(this._associateName),this._buttonMenu.setAssociatePhoto(this._associatePhotoURL),this._buttonMenu.setConnectingAudioSource(this._connectingAudioURL),console.log("About to restore the paused state: "+this._paused),this._paused===Paused.Local?this._buttonMenu.setPausedByUser(!0):this._paused===Paused.Remote&&this._buttonMenu.setPausedByAssociate(!0),this._associateVideo&&(console.log("About to turn associate video back on"),this._buttonMenu.setAssociateVideoOn(!0)),this._associateScreen&&(console.log("About to turn associate screen back on"),this._buttonMenu.setAssociateScreenShareOn(!0)),this._previewActive&&this._buttonMenu.showVideoPreview(!0),(this._userVideo||recoverLocalVideoView)&&(console.log("About to turn end user video back on"),this._buttonMenu.setEndUserVideoOn(!0),this._controller.startVideoPreview()),this._userScreen&&this._buttonMenu.setEndUserScreenShareOn(!0),this._userScreenAnnotate&&this._buttonMenu.setEndUserAnnotationOn(!0),this._userCobrowse&&this._buttonMenu.setEndUserCobrowseOn(!0),this._hiddenVideo&&this._buttonMenu.hideVideo(),this._hiddenLocalVideo&&this._buttonMenu.hideLocalVideo(),this._maximizedFeed&&this._buttonMenu.maximize(this._maximizedFeed,!0),this._buttonMenu.setStartVideoWithFrontCamera(this.isStartVideoWithFrontCamera()),this._buttonMenu.setStartVideoInFullScreen(this.isStartVideoInFullScreen()),this._buttonMenu.setHideEndCallButton(this.isHideEndCallButton()),this._buttonMenu.setHidePauseButton(this.isHidePauseButton()),this._buttonMenu.setHideQueueLengthIndicator(this.isHideQueueLengthIndicator()),this._remoteLayout=this._buttonMenu.toggleRemoteLayout(this._remoteLayout)}_orientationChanged(){this._buttonMenu.clearAllAnnotations()}reset(){console.log("LiveState::reset"),this._positionInQueue=0,this._associateName=null,this._associatePhotoURL=null,this._paused=Paused.None,this._collapsed=!1,this._maximizedFeed=null,this._associateVideo=!1,this._userVideo=!1,this._userScreen=!1,this._userScreenAnnotate=!1,this._associateScreen=!1,this._previewActive=!1,this._hiddenVideo=!1,this._hiddenLocalVideo=!1,this._canRejoinMeeting=!0,this._rating=0,this._localMute=!1,this._transferState=TransferState.None,this._transferMode=TransferMode.None,console.log("LiveState::reset Setting rating required to false"),this._ratingRequired=!1,this._userCobrowse=!1,this._remoteLayout=this._buttonMenu.toggleRemoteLayout(Layout.Single)}set state(e){const t=this._state;this._state.leave(e),this._state=new e(this,t.name),this._state.enter(t),this._stateName=this.stateName,console.log("state transition: "+t.name+" -> "+this.stateName)}get state(){return this._state}get stateName(){return this.state.name}get menu(){return this._buttonMenu}get controller(){return this._controller}get associateName(){return this._associateName}set associateName(e){console.log("set associate name: "+e),this._associateName=e,this._buttonMenu.setAssociateName(e),console.log("associates: ",JSON.stringify(this._controller._associates))}set additionalAssociateName(e){this._buttonMenu.setAdditionalAssociateName(e),this._buttonMenu.showNotificationAssociateJoined(e)}removeAssociate(e){const t=this._controller.removeAssociate(e);t&&(this._buttonMenu.removeAdditionalAssociateName(t,e),this._buttonMenu.showNotificationAssociateLeft(t))}swapAssociates(e){this._buttonMenu.swapSetNewMainAssociateName(e),this._buttonMenu.showNotificationAssociateNowHost(e)}resetAssociates(){this._buttonMenu.resetAssociates()}get associatePhotoURL(){return this._associatePhotoURL}set associatePhotoURL(e){this._associatePhotoURL=e,this._buttonMenu.setAssociatePhoto(e)}set connectingAudioURL(e){this._connectingAudioURL=e,this._buttonMenu.setConnectingAudioSource(e)}get connectingAudioURL(){return this._connectingAudioURL}get paused(){return this._paused}set paused(e){this._paused=e}get collapsed(){return this._collapsed}set collapsed(e){this._collapsed=e}get associateVideoOn(){return this._associateVideo}set associateVideoOn(e){this._associateVideo=e}get userVideoOn(){return this._userVideo}set userVideoOn(e){this._userVideo=e}get userScreenShareOn(){return this._userScreen}set userScreenShareOn(e){this._userScreen=e}get userCobrowseOn(){return this._userCobrowse}set userCobrowseOn(e){this._userCobrowse=e}get userScreenShareAnnotationOn(){return this._userScreenAnnotate}set userScreenShareAnnotationOn(e){this._userScreenAnnotate=e,e?this._controller.sendAnnotationStart():this._controller.sendAnnotationStop()}get associateScreenOn(){return this._associateScreen}set associateScreenOn(e){this._associateScreen=e}get previewActive(){return this._previewActive}set previewActive(e){this._previewActive=e}get hiddenVideo(){return this._hiddenVideo}set hiddenVideo(e){this._hiddenVideo=e}get hiddenLocalVideo(){return this._hiddenLocalVideo}set hiddenLocalVideo(e){this._hiddenLocalVideo=e}get localMute(){return this._localMute}set localMute(e){this._localMute=e}get showMoreMenu(){return this._showMoreMenu}set showMoreMenu(e){this._showMoreMenu=e}get rating(){return this._rating}set rating(e){this._rating=e}get transferState(){return this._transferState}set transferState(e){this._transferState=e}get transferMode(){return this._transferMode}set transferMode(e){this._transferMode=e,this._buttonMenu.setTransferMode(e)}get isMeeting(){return this._isMeeting}set isMeeting(e){this._isMeeting=e,this.menu._isMeeting=e}get canRejoinMeeting(){return this._canRejoinMeeting}set canRejoinMeeting(e){this._canRejoinMeeting=e,this.menu._canRejoinMeeting=e}get ratingRequired(){return console.log("Get ratingRequired",this._ratingRequired),this._ratingRequired}set ratingRequired(e){console.log("Setting ratingRequired to ",e),this._ratingRequired=e}set messages(e){this._messages=e}get messages(){return this._messages}set remoteLayout(e){this._remoteLayout=e}get remoteLayout(){return this._remoteLayout||(this._remoteLayout=Layout.Single),this._remoteLayout}isTransferring(){const e=this._transferState!==TransferState.None;return console.log("Transfer: isTransferring: "+e+"("+this._transferState+")"),e}isEndUserVideo(){return this.controller._behaviours&&this.controller._behaviours.isEndUserVideo()}isEndUserVideoPossible(){return this.controller._behaviours&&this.controller._behaviours.isEndUserVideoPossible()}isEndUserControlsCamera(){const e=this.controller._behaviours&&this.controller._behaviours.isEndUserVideoPossible()&&!0===this.controller._behaviours.endUserCanAddVideo;return console.log("isEndUserControlsCamera: "+!!e),!!e}isEndUserScreenSharePossible(){return this.controller._behaviours&&this.controller._behaviours.isEndUserScreenSharePossible()}isEndUserCobrowsePossible(){return this.controller._behaviours&&this.controller._behaviours.isEndUserCobrowsePossible()}isEndUserControlsScreenShare(){const e=this.controller._behaviours&&this.controller._behaviours.isEndUserScreenSharePossible()&&!0===this.controller._behaviours.endUserCanAddScreenShare;return console.log("isEndUserControlsScreenShare: "+!!e),!!e}isEndUserControlsCobrowse(){const e=this.controller._behaviours&&this.controller._behaviours.isEndUserCobrowsePossible()&&!0===this.controller._behaviours.endUserCanAddCobrowse;return console.log("IsEndUserControlsCobrowse"+!!e),!!e}isAssociateAudioPossible(){return this.controller._behaviours&&this.controller._behaviours.isAssociateAudioPossible()}isAssociateVideoPossible(){return this.controller._behaviours&&this.controller._behaviours.isAssociateVideoPossible()}isStartWithEndUserVideo(){return this.controller._behaviours&&this.controller._behaviours.isStartWithEndUserVideo()}isStartWithAssociateVideo(){return this.controller._behaviours&&this.controller._behaviours.isStartWithAssociateVideo()}isStartWithEndUserScreenShare(){return this.controller._behaviours&&this.controller._behaviours.isStartWithEndUserScreenShare()}isShortCodeEnabled(){const e=!this.isMeeting&&this.controller._behaviours&&this.controller._behaviours.shortCodeEnabled;return console.log("LiveState::isShortCodeEnabled=",e),!0===e}isUsingExternalAudio(){const e=this.controller._behaviours&&this.controller._behaviours.usingExternalAudio;return console.log("LiveState::UsingExternalAudio=",e),!0===e}isPreCallIDCheck(){return console.log("LiveState::isPreCallIDCheck=",this.controller._behaviours&&this.controller._behaviours.preCallIDCheck),!0===(this.controller._behaviours&&this.controller._behaviours.preCallIDCheck)}isCallback(){return this.controller.isCallback()}isCallbackOnly(){return this.controller.isCallbackOnly()}isStartVideoWithFrontCamera(){const e=(this.isMeeting||this._controller.settings.startVideoWithFrontCamera)&&this.isEndUserVideoPossible();return console.log("LiveState::isStartVideoWithFrontCamera=",e),!0===e}isStartVideoInFullScreen(){const e=(this.isMeeting||this._controller.settings.startVideoInFullScreen)&&(this.isAssociateVideoPossible()||this.isEndUserVideoPossible());return console.log("LiveState::isStartVideoInFullScreen=",e),!0===e}isHideEndCallButton(){return console.log("LiveState: isHideEndCallButton=",this._controller.settings.hideEndCallButton),!0===this._controller.settings.hideEndCallButton}isHidePauseButton(){return console.log("LiveState: isHidePauseButton=",this._controller.settings.hidePauseButton),!0===this._controller.settings.hidePauseButton}isHideQueueLengthIndicator(){return console.log("LiveState: isHideQueueLengthIndicator=",this._controller.settings.hideQueueLengthIndicator),!0===this._controller.settings.hideQueueLengthIndicator}addMenu(e){console.log("addMenu");const t=this.controller.contextAttributes.get("meetingTitle");this._messages&&this.menu.setMessages(this._messages),this.controller._customization&&this.menu.setCustomization(this.controller._customization),this.menu.addComponent(this.controller._messages,this.controller._browserName,t),e?console.log("addMenu: refreshing - not returning to Idle state"):this.menu.setIdle(),this.configureComponent(),this._setClickHandlers(),this._hidden?this.hideMenu():this.showMenu(),console.log("addMenu: isPrecallIDCheck="+this.isPreCallIDCheck()),(this.controller.service.startCallDirectly||this.isPreCallIDCheck())&&(live.resumeAudioContext(),console.log("addMenu start() now"),this.start())}updateMenu(){const e=this.stateName;console.log("updateMenu in state: "+e),e===Name.Idle&&this.configureComponent()}resetMenu(){this.menu.showStartCallDialog(!1),this.menu.hideRequestCallbackDialog()}handleInChannelMesssage(e,t,i){let o=i.conversation.getRemoteParticipant().uri;this.menu.handleInChannelMessage(e,t,o)}configureComponent(){const e=this.controller.contextAttributes.get("meetingTitle");this.menu.updateMessages(this.controller._messages,e),this.menu.setCustomization(this.controller._customization);const t=this.isStartWithEndUserVideo()||this.isStartWithAssociateVideo();this.menu.setStartInVideo(t),this.menu.setStartVideoWithFrontCamera(this.isStartVideoWithFrontCamera()),this.menu.setStartVideoInFullScreen(this.isStartVideoInFullScreen()),this.menu.setStartInScreenShare(this.isStartWithEndUserScreenShare()),this.menu.setShortCodeMode(this.isShortCodeEnabled()),this.menu.setPreCallIDCheck(this.isPreCallIDCheck()),this.menu.setHideEndCallButton(this.isHideEndCallButton()),this.menu.setHidePauseButton(this.isHidePauseButton()),this.menu.setHideQueueLengthIndicator(this.isHideQueueLengthIndicator()),this.menu.setUsingExternalAudio(this.isUsingExternalAudio()),this.configureBehaviours()}hidePauseResumeButton(){this.menu.hidePauseResumeButton()}hideQueueLengthIndicator(){console.log("hideQueueLengthIndicator"),this.menu.hideQueueLengthIndicator(this.isHideQueueLengthIndicator())}configureBehaviours(){this.menu.setEndUserControlsCamera(this.isEndUserControlsCamera()),this.menu.setEndUserControlsScreenShare(this.isEndUserControlsScreenShare()),this.menu.setEndUserControlsCobrowse(this.isEndUserControlsCobrowse())}_stateSupportsRehydration(e){let t="Connecting"===e||"Connected"===e||"Disconnecting"===e;return console.log("supportsRehydration("+e+") returning "+t),t}_setClickHandlers(){this._connectHandlers($(".oracle-live-main-button"),()=>{this.menu.isUnsupportedBrowser()||(live.resumeAudioContext(),this.start())}),this._connectHandlers($(".oracle-live-exit-button"),()=>{this.end()}),this._connectHandlers($(".oracle-live-cancel-button"),()=>{this.end()}),this._connectHandlers($(".oracle-live-rejoin-button"),()=>{this._controller.reloadRatherThanRejoin()?location.reload():this.start()}),this._connectHandlers($(".oracle-live-pause-button"),()=>{this.pause()}),this._connectHandlers($(".oracle-live-mute-button"),()=>{this.muteLocalAudio()}),this._connectHandlers($(".oracle-live-ellipses-button"),()=>{this.showMenuMore()}),this._connectHandlers($(".oracle-live-video-button"),()=>{this.toggleVideo()}),this._connectHandlers($(".oracle-live-screenshare-button"),()=>{this.toggleScreenShare()}),this._connectHandlers($(".oracle-live-top-notify-stop-screenshare-button"),()=>{this.toggleScreenShare()}),this._connectHandlers($(".oracle-live-cobrowse-button"),()=>{this.toggleCobrowse()}),this._connectHandlers($(".oracle-live-top-notify-stop-cobrowse-button"),()=>{this.stopCobrowse()}),this._connectHandlers($(".oracle-live-annotate-button"),()=>{this.toggleScreenShareAnnotate()}),this._connectHandlers($(".oracle-live-notificationmessage"),()=>{this.notification_close()}),this._connectHandlers($(".oracle-live-dialog-ok"),()=>{this.dialog_ok()}),this._connectHandlers($(".oracle-live-dialog-cancel"),()=>{this.dialog_cancel()}),this._connectHandlers($(".oracle-live-dialog-close"),()=>{this.dialog_close()}),this._connectHandlers($(".oracle-live-phone-number-country-code-expand"),()=>{this.showCountryCodesList()}),this._connectHandlers($(".oracle-live-dialog-option-poor"),()=>{this.poor()}),this._connectHandlers($(".oracle-live-dialog-option-good"),()=>{this.good()}),this._connectHandlers($(".oracle-live-dialog-option-excellent"),()=>{this.excellent()}),this._connectHandlers($(".oracle-live-preview-start-button"),()=>{this.video_preview_start()}),this._connectHandlers($(".oracle-live-preview-cancel-button"),()=>{this.video_preview_cancel()}),this._connectHandlers($(".oracle-live-video-maximize"),e=>{if(e&&e.target){const t=e.target.getAttribute("name");this.changeSize(t)}}),this._connectHandlers($(".oracle-live-callinfo-maximize-icon"),e=>{if(e&&e.target){const t=e.target.getAttribute("name");this.changeSize(t)}}),this._connectHandlers($(".oracle-live-video-closeall"),()=>{this.hideVideo()}),this._connectHandlers($(".oracle-live-swap-camera"),()=>{this.swapCamera()}),this._connectHandlers($(".oracle-live-video-closelocal"),()=>{this.hideLocalVideo()}),this._connectHandlers($(".oracle-live-verification-continue-button"),()=>{this.continueVerification()}),this._connectHandlers($(".oracle-live-verification-success-button"),()=>{this.verificationSuccessContinue()}),this._connectHandlers($(".oracle-live-verification-failed-try-again-button"),()=>{console.log("Failed - try again"),this.verificationTryAgain()}),this._connectHandlers($(".oracle-live-verification-cancelled-try-again-button"),()=>{console.log("Cancelled - try again"),this.verificationTryAgain()}),this._connectHandlers($(".oracle-live-verification-incomplete-try-again-button"),()=>{console.log("Incomplete - try again"),this.verificationTryAgain()}),this._connectHandlers($(".oracle-live-verification-close"),()=>{this.verificationEnd()}),this._connectHandlers($(".oracle-live-unfreeze-annotation-cross"),()=>{this.unfreezeAnnotation()}),this._connectHandlers($(".oracle-live-video-swap-camera"),()=>{this.swapCamera()}),this._connectHandlers($(".oracle-live-stop-camera"),()=>{this.hideVideo()}),this._connectHandlers($(".oracle-live-maximize-camera"),()=>{this.toggleVideo()}),this._connectHandlers($(".oracle-live-video-display-menu-button"),e=>{if(event&&event.target){const e=event.target.getAttribute("name");this.toggleStreamMenu(e,null)}}),this._connectHandlers($(".oracle-live-video-maximized-display-grid"),()=>{this.toggleRemoteLayout(null)}),this._connectHandlers($(".oracle-live-video-left"),()=>{this.prevRemoteVideo()}),this._connectHandlers($(".oracle-live-video-right"),()=>{this.nextRemoteVideo()})}_connectRemoteVideoPanelHandlers(){this._connectHandlers($(".oracle-live-video-display-menu-button"),e=>{if(event&&event.target){const e=event.target.getAttribute("name");this.toggleStreamMenu(e,null)}}),this._connectHandlers($(".oracle-live-video-swap-camera"),()=>{this.swapCamera(),this.toggleStreamMenu(null,!1)}),this._connectHandlers($(".oracle-live-video-stop-camera"),()=>{if(event&&event.target){event.target.getAttribute("name");this.toggleStreamMenu(null,!1)}}),this._connectHandlers($(".oracle-live-video-maximize-camera"),e=>{if(e&&e.target){const t=e.target.getAttribute("name");this.changeSize(t),this.toggleStreamMenu(null,!1)}})}_connectHandlers(e,t){e&&t||console.log("Missing component",e," or handler ",t),e.off("click").click(i=>{if(!0!==e.attr("aria-disabled")&&"true"!==e.attr("aria-disabled"))return t(i),!1;console.log("Clicked on component is disabled",e)}),e.off("keypress").keypress(i=>{if(!0===e.attr("aria-disabled")||"true"===e.attr("aria-disabled"))return;const o=i.keyCode||i.which;return 13===o||32===o?(t(i),!1):void 0})}showMenu(e){console.log("-> showMenu"+(e?" (forceOverride)":"")),this._available&&(this._hidden=!1,this._hideWhenIdle=!1,!e&&this.controller.service.startCallDirectly?console.log("Not showing menu, startCallDirectly flag is set"):(console.log("showMenu in state: "+this.stateName),this.stateName!==Name.PreCallIDCheck&&!this.isPreCallIDCheck()||this.stateName===Name.Connected?(this.menu.showComponent(),this.controller._behaviours&&!this.controller.isComponentAvailable()&&this.menu.hideComponent()):(console.log("Precall id check, hiding component"),this.menu.hideComponent())))}hideMenu(){this._hidden=!0,this.menu.showStartCallDialog(!1),this.menu.hideRequestCallbackDialog(),console.log("hideMenu in state: "+this.stateName),this.stateName===Name.Idle?(this.menu.hideComponent(),this._hideWhenIdle=!1):(console.log("Cannot hide component in state: "+this.stateName+", will hide when Idle"),this._hideWhenIdle=!0)}setAvailable(e){this._available=e,console.log("LiveState::setAvailable: ",this._available)}isAvailable(){return this._available}hideWhenIdle(){this._hideWhenIdle&&this._hidden&&(this.menu.hideComponent(),this._hideWhenIdle=!1)}start(){console.log("click: start in state: "+this.stateName),this._state.start(),this.stateName!==Name.PreCallIDCheck&&this.showMenu(!0)}remoteResume(){console.log("remote resume request in state: "+this.stateName),this._state.remoteResume()}remotePause(){console.log("remote pause request in state: "+this.stateName),this._state.remotePause()}pause(){console.log("click: pause in state: "+this.stateName),this._state.pause()}muteLocalAudio(){console.log("click: mute in state: "+this.stateName),this._state.muteLocalAudio()}showMenuMore(){console.log("click: ellipses in state: "+this.stateName),this._state.showMenuMore()}toggleVideo(){console.log("click: video in state: "+this.stateName),this._state.toggleVideo()}toggleScreenShare(){console.log("click: toggle screen share in state: "+this.stateName),this._state.toggleScreenShare()}toggleCobrowse(){console.log("click: toggle cobrowse in state: "+this.stateName),this._state.toggleCobrowse()}stopCobrowse(){console.log("click: stop cobrowse in state: "+this.stateName),this._state.stopCobrowse()}toggleScreenShareAnnotate(){console.log("click: toggle screen share annotate in state: "+this.stateName),this._state.toggleScreenShareAnnotate()}end(){console.log("click: end in state: "+this.stateName),this._state.end()}notification_close(){console.log("click: X in state: "+this.stateName),this._state.notification_close()}dialog_ok(){console.log("click: ok in state: "+this.stateName),this._state.dialog_ok()}dialog_cancel(){console.log("click: cancel in state: "+this.stateName),this._state.dialog_cancel()}dialog_close(){console.log("click: close in state: "+this.stateName),this._state.dialog_close()}showCountryCodesList(){this.menu.showCountryCodesList()}video_preview_start(){console.log("click: start video preview in state: "+this.stateName),this.controller._av._haveAskedUserPermissionForSharingVideo=!0,this._state.video_preview_start()}video_preview_cancel(){console.log("click: cancel video preview in state: "+this.stateName),this._state.video_preview_cancel()}poor(){console.log("click: poor in state: "+this.stateName),this._state.poor()}good(){console.log("click: good in state: "+this.stateName),this._state.good()}excellent(){console.log("click: excellent in state: "+this.stateName),this._state.excellent()}changeSize(e){this._state.changeSize(e)}hideVideo(){console.log("click: hideVideo in state: "+this.stateName),this._state.hideVideo()}hideLocalVideo(){console.log("click: hideVideo in state: "+this.stateName),this._state.hideLocalVideo()}swapCamera(){console.log("click: swapCamera in state: "+this.stateName),this._state.swapCamera()}continueVerification(){console.log("click: continueVerification in state: "+this.stateName),this._state.continueVerification()}verificationSuccessContinue(){console.log("click: verificationSuccessContinue in state: "+this.stateName),this._state.verificationSuccessContinue()}verificationTryAgain(){console.log("click: verificationTryAgain in state: "+this.stateName),this._state.verificationTryAgain()}verificationEnd(){console.log("click: verificationEnd in state: "+this.stateName),this._state.verificationEnd()}unfreezeAnnotation(){$("body").css("visibility","visible"),console.log("click: veriunfreezeAnnotation in state: "+this.stateName),this._state.unfreezeAnnotation()}event(e,t){console.log("event: "+e+" in state: "+this.stateName),this._state.event(e,t)}toggleStreamMenu(e,t){console.log("click: toggleStreamMenu in state: "+this.stateName+" for location: "+(e||"all ")+(t?" (show)":null===t?" (toggle)":" (hide)")),this._state.toggleStreamMenu(e,t)}toggleRemoteLayout(e){console.log("click: toggleRemoteLayout in state: "+this.stateName),this._state.toggleRemoteLayout(e)}nextRemoteVideo(){console.log("click: nextRemoteVideo in state: "+this.stateName),this._state.nextRemoteVideo()}prevRemoteVideo(){console.log("click: prevRemoteVideo in state: "+this.stateName),this._state.prevRemoteVideo()}addRemoteVideo(e,t,i){console.log("addRemoteVideo in state: "+this.stateName),this._state.addRemoteVideo(e,t,i),this._connectRemoteVideoPanelHandlers()}activateRemoteVideo(e,t){console.log("activateRemoteVideo "+t+" for "+e+" in state: "+this.stateName),this._state.activateRemoteVideo(e,t)}}return LiveState}),define("LiveScenarioBehaviours",[],function(){"use strict";const e={NONE:"NONE",AUDIO_VIDEO:"AUDIO_VIDEO",AUDIO_ONLY:"AUDIO_ONLY",SCREEN_SHARE:"SCREEN_SHARE",VIDEO_ONLY:"VIDEO_ONLY"},t={NONE:"NONE",AVAILABLE:"AVAILABLE",CALLBACK_ONLY:"CALLBACK_ONLY"};return class{constructor(t){if(this.StartMediaType=e,t){const i=i=>!0===t.usingExternalAudio&&i===e.AUDIO_VIDEO?e.VIDEO_ONLY:i;this.usingExternalAudio=t.usingExternalAudio,this.endUserCanAddAudio=t.endUserCanAddAudio&&!t.usingExternalAudio,this.endUserCanAddVideo=t.endUserCanAddVideo,this.endUserCanAddScreenShare=t.endUserCanAddScreenShare,this.associateCanAddAudio=t.associateCanAddAudio&&!t.usingExternalAudio,this.associateCanAddVideo=t.associateCanAddVideo,this.associateCanAddScreenShare=t.associateCanAddScreenShare,this.associateCanRequestEndUserAudio=t.associateCanRequestEndUserAudio&&!t.usingExternalAudio,this.associateCanRequestEndUserVideo=t.associateCanRequestEndUserVideo,this.associateCanRequestEndUserScreenShare=t.associateCanRequestEndUserScreenShare,this.preCallIDCheck=t.preCallIDCheck,this.endUserInitialMedia=i(t.endUserInitialMedia),this.associateInitialMedia=i(t.associateInitialMedia),this.shortCodeEnabled=t.shortCodeEnabled,this.meetingsEnabled=t.meetingsEnabled,this.transferEnabled=t.transferEnabled,this.addCallEnabled=t.addCallEnabled,this.allowInChannelMessaging=t.allowInChannelMessaging,this.callback=t.callback,this.allowCallbackAlternateNumber=t.allowCallbackAlternateNumber,this.allowCobrowse=t.allowCobrowse,this.endUserCanAddCobrowse=t.endUserCanAddCobrowse,this.associateCanRequestEndUserCobrowse=t.associateCanRequestEndUserCobrowse}}toJSON(){return{endUserCanAddAudio:this.endUserCanAddAudio,endUserCanAddVideo:this.endUserCanAddVideo,endUserCanAddScreenShare:this.endUserCanAddScreenShare,associateCanAddAudio:this.associateCanAddAudio,associateCanAddVideo:this.associateCanAddVideo,associateCanAddScreenShare:this.associateCanAddScreenShare,associateCanRequestEndUserAudio:this.associateCanRequestEndUserAudio,associateCanRequestEndUserVideo:this.associateCanRequestEndUserVideo,associateCanRequestEndUserScreenShare:this.associateCanRequestEndUserScreenShare,preCallIDCheck:this.preCallIDCheck,endUserInitialMedia:this.endUserInitialMedia,associateInitialMedia:this.associateInitialMedia,shortCodeEnabled:this.shortCodeEnabled,meetingsEnabled:this.meetingsEnabled,transferEnabled:this.transferEnabled,addCallEnabled:this.addCallEnabled,allowInChannelMessaging:this.allowInChannelMessaging,callback:this.callback,allowCallbackAlternateNumber:this.allowCallbackAlternateNumber,allowCobrowse:this.allowCobrowse,endUserCanAddCobrowse:this.endUserCanAddCobrowse,associateCanRequestEndUserCobrowse:this.associateCanRequestEndUserCobrowse,usingExternalAudio:this.usingExternalAudio}}allowDowngrades(t){console.log("Allowing Downgrades ("+t+")"),this.endUserInitialMedia!==e.AUDIO_ONLY&&this.endUserInitialMedia!==e.AUDIO_VIDEO||this.endUserCanAddAudio!==t&&(console.log("Altering endUserCanAddAudio to be ("+t+")"),this.endUserCanAddAudio=t),this.endUserInitialMedia===e.AUDIO_VIDEO&&this.endUserCanAddVideo!==t&&(console.log("Altering endUserCanAddVideo to be ("+t+")"),this.endUserCanAddVideo=t)}isEndUserAudioPossible(){return this.endUserCanAddAudio||this.associateCanRequestEndUserAudio||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.AUDIO_ONLY}isEndUserVideoPossible(){return this.endUserCanAddVideo||this.associateCanRequestEndUserVideo||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isStartWithEndUserVideo(){return this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isStartWithAssociateVideo(){return this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.VIDEO_ONLY}isStartWithEndUserScreenShare(){return console.log("liveScenarioBehaviours::isStartWithEndUserScreenShare",this.endUserInitialMedia===e.SCREEN_SHARE),this.endUserInitialMedia===e.SCREEN_SHARE}isEndUserScreenSharePossible(){return this.endUserCanAddScreenShare||this.associateCanRequestEndUserScreenShare||this.endUserInitialMedia===e.SCREEN_SHARE}isEndUserCobrowsePossible(){return this.endUserCanAddCobrowse||this.associateCanRequestEndUserCobrowse}isAssociateAudioPossible(){return this.associateCanAddAudio||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.AUDIO_ONLY}isAssociateVideoPossible(){return this.associateCanAddVideo||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.VIDEO_ONLY}isAssociateScreenSharePossible(){return this.associateCanAddScreenShare||this.associateInitialMedia===e.SCREEN_SHARE}isAudioPossible(){return this.endUserCanAddAudio||this.associateCanAddAudio||this.associateCanRequestEndUserAudio||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.AUDIO_ONLY||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.AUDIO_ONLY}isAudioOnly(){return this.associateInitialMedia===e.AUDIO_ONLY&&this.endUserInitialMedia===e.AUDIO_ONLY}isVideoPossible(){return this.endUserCanAddVideo||this.associateCanAddVideo||this.associateCanRequestEndUserVideo||this.associateInitialMedia===e.AUDIO_VIDEO||this.associateInitialMedia===e.VIDEO_ONLY||this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isVideoOnly(){return this.associateInitialMedia===e.AUDIO_VIDEO&&this.endUserInitialMedia===e.AUDIO_VIDEO}isEndUserVideo(){return this.endUserInitialMedia===e.AUDIO_VIDEO||this.endUserInitialMedia===e.VIDEO_ONLY}isScreenSharePossible(){return this.endUserCanAddScreenShare||this.associateCanAddScreenShare||this.associateCanRequestEndUserScreenShare||this.associateInitialMedia===e.SCREEN_SHARE||this.endUserInitialMedia===e.SCREEN_SHARE}isPreCallIDCheck(){return this.preCallIDCheck}getMediaType(){let e="";return this.isAudioPossible()&&(e+="audio"),this.isVideoPossible()&&(""!==e&&(e+=","),e+="video"),this.isScreenSharePossible()&&(""!==e&&(e+=","),e+="screenshare"),e}isCallback(){console.log("callback: '"+this.callback+"'"),console.log("CallbackType.NONE: '"+t.NONE+"'");const e=this.callback&&this.callback!==t.NONE;return console.log("isCallback() returning: "+e),e}isCallbackOnly(){return this.callback===t.CALLBACK_ONLY}isUsingExternalAudio(){return this.usingExternalAudio}}}),define("LiveRestHelper",["LiveEvents","LiveSessionStore","LiveScenarioBehaviours"],function(e,t,i){"use strict";const o=1e4;return class{constructor(e){this._impl=e,this._callQueue=null,this._clientId=null,this._clientKey=null,this._haveContextResponse=!1,this._appName=null,this._noProxyForKyc=!1,this._kycAttemptNumber=0,this._runningForChromeExtension=!1,this._promisesInFlight={},t.initState("LiveRestHelper",this),$(()=>{console.log("LiveRestHelper: Loading"),t.loadState("LiveRestHelper",e=>{this._clientId=e.clientId,this._clientKey=e.clientKey,this._haveContextResponse=e.haveContextResponse,this._appName=e.appName,this._noProxyForKyc=e.noProxyForKyc,this._kycAttemptNumber=e.kycAttemptNumber,this._impl.contextAttributes.set("appName",this._appName),this._impl.contextAttributes.set("clientId",this._clientId),console.log("Loaded appName = "+this._impl.contextAttributes.get("appName")),console.log("LiveRestHelper: Loaded")})});let i=this._promisesInFlight;this.messageHandler=function(e){if(e.data&&e.data.lxRequest&&"LiveRestHelper.js"===e.data.lxRequest.sender){console.log("We have a response to a background XHR request..",e.data);let t=i[e.data.lxRequest.promiseId];if(t){if(console.log("Resolving - and deleting - promise...",t),e.data.lxError)t.reject(e.data.lxError);else if(0===e.data.lxResponse.length)t.resolve("");else{let i;try{i=JSON.parse(e.data.lxResponse)}catch(t){i=e.data.lxResponse}t.resolve(i)}delete i[e.data.lxRequest.promiseId],console.log("Note: promisesInFlight cache now=",i)}}},window.addEventListener("message",this.messageHandler,!1)}toJSON(){return JSON.stringify({clientId:this._clientId,clientKey:this._clientKey,haveContextResponse:this._haveContextResponse,appName:this._appName,noProxyForKyc:this._noProxyForKyc,kycAttemptNumber:this._kycAttemptNumber})}beforeUnload(){console.log("LiveRestHelper: Attempting to close the call queue"),this.closeCallQueue()}loadComplete(){console.log("LiveRestHelper: Load complete")}generateId(e){let t="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=i.length;for(let s=0;s<e;s++)t+=i.charAt(Math.floor(Math.random()*o));return t}defer(){let e,t,i=new Promise((i,o)=>{e=i,t=o});return i.resolve=e,i.reject=t,i}_fetchInBackground(e,t,i,o,s){console.log("LiveRestHelper.fetchInBackground - handing off to the background doXHR mechanism.."),console.log("LiveRestHelper.fetchInBackground: method=",e),console.log("LiveRestHelper.fetchInBackground: url=",t),console.log("LiveRestHelper.fetchInBackground: data=",i),console.log("LiveRestHelper.fetchInBackground: auth=",o),console.log("LiveRestHelper.fetchInBackground: contentType=",s);let n=this.defer(),a=this.generateId(8);return this._promisesInFlight[a]=n,window.postMessage({sender:"LiveRestHelper.js",msg:"doXHR",method:e,accept:s,contentType:s,auth:o||"Bearer "+this._impl.service.authToken,url:t,body:i,promiseId:a},"*"),n}_fetch(e,t,i,o,s){const n=o||this._impl.service.authToken,a=s||"application/json";return this._runningForChromeExtension?this._fetchInBackground(e,t,i,o,a):fetch(t,{method:e,body:i,mode:"cors",credentials:"include",headers:{"Content-Type":a,Accept:a,Authorization:"Bearer "+n,"X-Requested-With":"XMLHttpRequest"}}).then(e=>{if(e.ok)return 200===e.status?e.text():Promise.resolve(e.statusText);{const t=new Error(e.statusText);throw t.response=e,t}}).then(e=>{try{if(!e)return Promise.resolve(e);try{return Promise.resolve(JSON.parse(e))}catch(t){return Promise.resolve(e)}}catch(t){return console.log("LiveRestHelper::fetch could not process : '"+e+"'"),console.warn("response : '"+t+"''"),Promise.resolve(e)}})}_get(e,t){return this._fetch("GET",e,null,null,t)}_post(e,t){return this._fetch("POST",e,t)}_put(e,t){return this._fetch("PUT",e,t)}_delete(e,t){return this._fetch("DELETE",e,null,t)}closeCallQueue(){this._callQueue&&this._callQueue.close(),this._callQueue=null,this.stopKeepAliveTimer()}addToCallQueue(t,i,o){console.log("LiveRestHelper::addToCallQueue: mediaType="+t);let s=this._impl.service.authToken,n=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/pending?mediaType="+t+"&version="+this._impl.version+"&jwt="+s+(this._clientKey?"&clientKey="+this._clientKey:"");console.log("LiveRestHelper::addToCallQueue: pendingURI="+n),this.closeCallQueue(),this._callQueue=new EventSource(n),this._callQueue.addEventListener("Success",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: success: address="+t,e),this.closeCallQueue(),i(t)},!1),this._callQueue.addEventListener("Upgrade",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: upgrade: eventData="+t,e),this.closeCallQueue(),i(t)},!1),this._callQueue.addEventListener("Error",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: error: message="+t,e),this.closeCallQueue(),o("Error",t)}),this._callQueue.addEventListener("None",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: none: message="+t,e),this.closeCallQueue(),o("None",t)}),this._callQueue.addEventListener("TeamBusy",e=>{const t=e.data;console.log("LiveRestHelper::addToCallQueue: teamBusy: message="+t,e),this.closeCallQueue(),o("TeamBusy",t)}),this._callQueue.addEventListener("KeepAlive",t=>{const i=t.data;console.log("LiveRestHelper::addToCallQueue: keep-alive: message="+i,t);try{const t=JSON.parse(i);console.log("LiveRestHelper::addToCallQueue: keep-alive: waitTime="+t.waitTime+", queuePosition="+t.queuePosition),this._impl.setPositionInQueue(t.queuePosition),t.associatesBusy&&this._impl.canOfferCallback()&&(this._impl._offerCallbackTimer=setTimeout(()=>{console.log("associate is busy and callback is configured"),this._impl.dispatchEvent(e.LiveCallbackPromptUser,"Associate is busy"),this._impl._offerCallbackTimer=null},15e3))}catch(e){console.log("LiveRestHelper::addToCallQueue: keep-alive: failed to parse keep-alive response",e)}}),this.startKeepAliveTimer(t)}closeCallQueueAndRemove(t,i){if(console.log("closeCallQueueAndRemove",this._callQueue),!this._callQueue)return;this.closeCallQueue(),this._impl.dispatchEvent(e.LiveCanceled);let o=this._impl.service.authToken;this.removeFromQueue(t,o,i)}removeFromQueue(e,t,i){const o="userCanceled"===this._impl._endCallReason?"true":"false";let s=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/pending?userCanceled="+o+"&mediaType="+e+"&jwt="+t+"&version="+this._impl.version+(this._clientKey?"&clientKey="+this._clientKey:"");console.log("removeFromQueue: pendingURI: "+s),this._delete(s,t).then(()=>{console.log("Got success for delete pending"),i()}).catch(e=>{404!==e.response.status?console.log("Failed to delete pending call, Error: "+e.message,e.response):(console.log("Pending call already removed"),i())})}startKeepAliveTimer(e){this.stopKeepAliveTimer(),console.log("startKeepAliveTimer"),this._keepAliveTimer=setInterval(()=>{this.sendQueueKeepAlive(e)},o)}stopKeepAliveTimer(){this._keepAliveTimer&&(console.log("stopKeepAliveTimer"),clearInterval(this._keepAliveTimer),this._keepAliveTimer=null)}sendQueueKeepAlive(t){let i=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/keepAlive?version="+this._impl.version+(this._clientKey?"&clientKey="+this._clientKey:"");console.log("sendQueueKeepAlive: keepaliveURI: "+i),this._post(i,null).then(()=>{console.log("Got success to queue keep-alive")}).catch(i=>{console.log("Failed to send queue keep-alive, Error: "+i.message,i.response),i.response&&404===i.response.status&&(console.log("Got queue keep-alive 'Not Found' error response - pending call has been cancelled"),this.closeCallQueueAndRemove(t,()=>{console.log("Removed pending call"),this._impl.dispatchEvent(e.LiveEnded)}))})}getAppAvailability(e){console.log("LiveRestHelper::getAppAvailability: for tenantID=",this._impl.service.tenantID);let t=this._impl.service.address+"/tenant/api/tenants/"+this._impl.service.tenantID+"/application?version="+this._impl.version;this._get(t).then(t=>{console.log("Got availability response: ",t),e(t)}).catch(e=>{console.log("Failed to get availability, Error: "+e.message,e.response)})}getMetaScenario(e){if(console.log("LiveRestHelper::getMetaScenario: for tenantID=",this._impl.service.tenantID),!this._impl.service.tenantID)return;navigator.userAgent.includes("iPad")||navigator.userAgent.includes("iPhone")?this._impl.contextAttributes.set("devType","Mobile (iOS)"):navigator.userAgent.includes("Android")?this._impl.contextAttributes.set("devType","Mobile (Android)"):this._impl.contextAttributes.set("devType","web");let t=this._impl.service.address+"/tenant/api/tenants/"+this._impl.service.tenantID+"/match-meta-scenario?version="+this._impl.version;this._impl.service.appName&&(t+="&appName="+this._impl.service.appName);let i=JSON.stringify(this._impl.contextAttributes.toWebContext());this._post(t,i).then(t=>{console.log("LiveRestHelper::getMetaScenario: Got success for post/match-meta-scenario: ",t);const i=t.Application;this._clientId=i.clientId,console.log("application.name received in matched metaScenario = "+i.name),this._appName=i.name,this._impl.contextAttributes.set("appName",i.name),this._impl.contextAttributes.set("clientId",i.clientId);const o=t.Configuration,s=t.Components;e(o,s)}).catch(e=>{console.error("Failed to match meta scenario (no response text), Error: "+e.message,e.response)})}createCallback(e){if(console.log("createCallback: "+e),!this._impl.service.tenantID)return;const t=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/conversation/callback?clientKey="+this._clientKey+"&version="+this._impl.version;let i=JSON.stringify({callbackNumber:e});return this._put(t,i)}getCallbackOptions(){if(!this._impl.service.tenantID||!this._clientId)return;const e=this._impl.service.address+"/tenant/api/apps/"+this._impl.service.tenantID+"/application/"+this._clientId+"/callbackOptions",t=this._get(e);return t.then(e=>{console.log("callbackOptions got response: request: ",e),this._impl.setCallbackAvailable(!0===e.PSTNAvailable||!0===e.inAppAvailable)}).catch(e=>{console.log("Failed to retrieve associate info, Error: "+e.message,e.response)}),t}getMessages(e,t){this._impl.service.tenantID&&this._clientId||(console.warn("LiveRestHelper::getMessages Cannot retrieve messages for invalid tenant"),t());let i=this._impl.service.address+"/tenant/api/tenant/"+this._impl.service.tenantID+"/localisation/application/"+this._clientId+"/messages/locale/"+e+"/?usageType=mce";this._get(i,"application/octet-stream").then(e=>{e?e.application_layer?t(e.application_layer):t(e):t()}).catch(e=>{console.warn("LiveRestHelper::getMessages Cannot retrieve messages, Error: "+e.message,e.response),t()})}getCommitHash(){const e=this._impl.apiVersion.commitHash;return console.log("sig="+e),e.substring(0,8)}sendContext(e){console.log("Inside sendContext");const t=this.getCommitHash();let i=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/context?version="+this._impl.version+(t?"&sig="+t:"")+(this._clientKey?"&clientKey="+this._clientKey:""),o=this._impl.contextAttributes.toJSON();console.log("LiveRestHelper::sendContext: ",this._impl.contextAttributes),sessionStorage.setItem("previousJWT",this._impl.service.authToken),this._haveContextResponse=!1,this._post(i,o).then(t=>{console.log("LiveRestHelper::sendContext: responseData: ",JSON.stringify(t)),t&&(this._haveContextResponse=!0,t.clientKey?this._clientKey=t.clientKey:t.key&&(this._clientKey=t.key)),console.log("LiveRestHelper::sendContext: clientKey: "+this._clientKey),e()}).catch(e=>{console.error("LiveRestHelper::sendContext: Failed to send context info, Error: "+e.message,e.response)})}sendPostCallRating(e,t){console.log("sendPostCallRating: rating="+e),this._impl._conversationId||console.warn("Cannot submit post-call rating - invalid conversation ID");let i=JSON.stringify({uri:this._impl.service.userID,qualityRating:e}),o=this._impl.service.address+"/sr/api/tenant/"+this._impl.service.tenantID+"/application/"+this._clientId+"/session/"+this._impl._conversationId+"/participantcallrating/?version="+this._impl.version;console.log("sendRating: "+i+" to: "+o),this._post(o,i).then(()=>{console.log("Successfully sent call rating"),this._impl._conversationId=null,t()}).catch(e=>{console.error("Failed to send call rating, Error: "+e.message,e.response)})}getAssociateInfo(){console.log("Entered getAssociateInfo..");let e=this._impl.service.tenantID,t=this._impl._associateUri;if(!t)return void console.log("No associateURI field available so skipping retrieval");let i=encodeURI(this._impl.service.address+"/assoc/api/tenant/"+e+"/assoc/"+t+"?version="+this._impl.version);console.log("Fetch associate info from URL: "+i);const o=this._get(i);return o.then(e=>{console.log("Got response from associate info request..",e),e.name&&this._impl.addAssociate(t,e.name)}).catch(e=>{console.log("Failed to retrieve associate info, Error: "+e.message,e.response)}),o}getTeamConfig(e){console.log("Entered getTeamConfig.."),this._behaviours=new i(this._impl.contextAttributes.get("behaviours"));let t=this._impl.service.address+"/assoc/api/tenant/"+this._impl.service.tenantID+"/assoc/teamconfig?mediaType="+this._behaviours.getMediaType(),o=this._impl.contextAttributes.toJSON();this._post(t,o).then(t=>{this._maxWaitTime=36e5,t&&t.maxWaitTime&&(this._maxWaitTime=60*t.maxWaitTime*1e3),e(this._maxWaitTime),console.log("LiveRestHelper::getTeamConfig: maxWaitTime: "+this._maxWaitTime)}).catch(e=>{console.error("LiveRestHelper::getTeamConfig: Failed to send context info, Error: "+e.message,e.response)})}getAssociateAvatar(){console.log("Entered getAssociateAvatar..");let e=this._impl.service.authToken,t=this._impl.service.tenantID,i=this._impl._associateUri;if(!i)return void console.log("No associateURI field available so skipping retrieval");let o=encodeURI(this._impl.service.address+"/auth/user/api/users/avatar/"+t+"/"+i+"?version="+this._impl.version);console.log("Fetch associate avatar from URL: "+o),fetch(o,{credentials:"include",mode:"cors",headers:{Accept:"application/octet-stream","X-Requested-With":"XMLHttpRequest",Authorization:"Bearer "+e}}).then(e=>{if(e.ok)return e.blob();console.log("Failed to find avatar: "+e.status,e.statusText)}).then(e=>{let t=URL.createObjectURL(e);console.log("Successfully downloaded avatar",t),this._impl.setAssociatePhoto(t)}).catch(e=>{console.log("Failed to download associate avatar: ",e.message)})}updatePreCallIdCheck(e,t,i,o){if(console.log("LiveRestHelper::updatePreCallIdCheck:  for tenantID=",e.tenantID),console.log("clientKey: ",i),i||(i=this._clientKey),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::updatePreCallIdCheck:Cannot update PreCallIDCheck for invalid tenant"),void o(void 0);let s=e.address+"/sl/api/kyc/tenant/"+e.tenantID+"/client/"+i+"/attempt/"+this.getLastUsedKycAttemptNumber()+"/update/"+t;this._post(s).then(e=>{console.log("LiveRestHelper::updatePreCallIdCheck: got response: "+e),e&&o(e)}).catch(e=>{console.log("LiveRestHelper::updatePreCallIdCheck: failed to updatePreCallIdCheck, Error: "+e.message,e.response)})}getLocale(){let e="en";return navigator.languages&&navigator.languages.length?e=navigator.languages[0]:navigator.language&&(e=navigator.language),console.log("LiveRestHelper::getLocale: language: ",e),e}setClientId(e){this._clientId=e}getClientKey(){return this._clientKey}getContextResponse(){return this._haveContextResponse}resetContextResponse(){this._haveContextResponse=!1}createInitiatePreCallCheckPayload(){return{deviceType:"web",attemptNumber:this.getIncrementedKycAttemptNumber(),clientId:this._clientId,clientKey:this._clientKey,userId:this._impl.service.userID,locale:this.getLocale(),noProxy:this._noProxyForKyc}}initiatePreCallIDCheck(e,t,i,o){if(console.log("LiveRestHelper::initiatePreCallIDCheck: for tenantID=",e.tenantID),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::initiatePreCallIDCheck:Cannot initiate PreCallIDCheck for invalid tenant"),void i(void 0);let s=e.address+"/kyc/api/tenant/"+e.tenantID+"/application/"+this._clientId+"/initiate";console.log("LiveRestHelper::initiatePreCallIDCheck: uri: ",s),console.log("LiveRestHelper::initiatePreCallIDCheck: data: ",t),this._post(s,JSON.stringify(t)).then(e=>{console.log("LiveRestHelper::initiatePreCallIDCheck: got response: ",e),e&&i(e)}).catch(e=>{console.log("LiveRestHelper::initiatePreCallIDCheck: failed to initiatePreCallIDCheck, Error: "+e.message,e.response),o(e.response)})}getPreCallIDCheckStatus(e,t,i,o){if(console.log("LiveRestHelper::getPreCallIDCheckStatus:  for tenantID=",e.tenantID),console.log("transactionReference: ",t),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::getPreCallIDCheckStatus:Cannot get PreCallIDCheck for invalid tenant"),void o(void 0);let s=e.address+"/kyc/api/tenant/"+e.tenantID+"/application/"+this._clientId+"/transaction/"+t+"/status";this._get(s).then(e=>{console.log("LiveRestHelper::getPreCallIDCheckStatus: got response: "+e),e&&i(e)}).catch(e=>{console.log("LiveRestHelper::getPreCallIDCheckStatus: failed to getPreCallIDCheckStatus, Error: "+e.message,e.response),o(e.response)})}getPreCallIDCheckResult(e,t){if(console.log("LiveRestHelper::getPreCallIDCheckResult:  for tenantID=",e.tenantID),console.log("clientKey: ",t),!e.tenantID||!this._clientId)return console.log("LiveRestHelper::getPreCallIDCheckStatus:Cannot get PreCallIDCheck for invalid tenant"),Promise.reject(void 0);let i=e.address+"/sr/api/kyc/tenant/"+e.tenantID+"/session/"+t+"/id-verification/result";return this._get(i)}getLastUsedKycAttemptNumber(){return this._kycAttemptNumber}getIncrementedKycAttemptNumber(){return this._kycAttemptNumber+=1,this.getLastUsedKycAttemptNumber()}setNoProxyForKyc(e){console.log("LiveRestHelper::setNoProxyForKyc noProxy: ",e),this._noProxyForKyc=e}deleteIdentityVerificationTransaction(e,t){if(console.log("LiveRestHelper::deleteIdentityVerificationTransaction:  for tenantID=",e.tenantID),console.log("transactionReference: ",t),console.log("attempt: ",this._kycAttemptNumber),!e.tenantID||!this._clientKey)return console.log("LiveRestHelper::deleteIdentityVerificationTransaction: Cannot delete transaction for invalid tenant/app"),Promise.reject(new Error("Invalid tenant or application"));const i=e.address+"/sl/api/kyc/tenant/"+e.tenantID+"/client/"+this._clientKey+"/attempt/"+this._kycAttemptNumber+"/result",o={transactionReference:t,result:"Failed"};return this._post(i,JSON.stringify(o))}setRunningForChromeExtension(e){console.log("liveAPI REST helper: setRunningForChromeExtension="+e),this._runningForChromeExtension=e}}}),define("LiveDiagnostics",["LiveSessionStore","LiveEvents"],function(e,t){"use strict";const i=51,o=50,s=11,n=79,a="LXDiagnosticsResults",r=!1;return class{constructor(t){this._impl=t,this._browserName=null,this._browserVersion=null,this._browserOS=null,this._isMobileOS=!1,this._haveAudioIn=!1,this._haveAudioOut=!1,this._haveVideo=!1,this._haveTwoCameras=!1,this._cancelled=!1,this._videoStream=null,this._networkTestRunning=!1,this._networkResult=0,this._networkPromise=null,this._browserUnsupported=null,this._browserVersionUnsupported=!1,this._diagnosticsTimer={},this._diagnosticsTimeout=2e4,this._audioOutDiagnosticsTimeout=6e4,this._reloadedForDiagnosticsRun=!1,e.initState("LiveDiagnostics",this),$(()=>{console.log("LiveDiagnostics: Loading"),e.loadState("LiveDiagnostics",e=>{this._browserName=e.browserName,this._browserVersion=e.browserVersion,this._browserOS=e.browserOS,this._haveAudioIn=e.haveAudioIn,this._haveAudioOut=e.haveAudioOut,this._haveVideo=e.haveVideo,this._haveTwoCameras=e._haveTwoCameras,this._networkResult=e.networkResult,this._browserUnsupported=e.browserUnsupported,this._browserVersionUnsupported=e.browserVersionUnsupported,console.log("LiveDiagnostics: Loaded")})})}toJSON(){return JSON.stringify({browserName:this._browserName,browserVersion:this._browserVersion,browserOS:this._browserOS,isMobileOS:this._isMobileOS,haveAudioIn:this._haveAudioIn,haveAudioOut:this._haveAudioOut,haveVideo:this._haveVideo,haveTwoCameras:this._haveTwoCameras,networkResult:this._networkResult,browserUnsupported:this._browserUnsupported,browserVersionUnsupported:this._browserVersionUnsupported})}setAutoTest(e){console.log("LiveDiagnostics::setAutoTest setting to: ",e),!0===e&&(this._haveAudioIn=!0,this._haveAudioOut=!0,this._haveVideo=!0,this._haveTwoCameras=!1)}checkBrowser(){return new Promise((e,t)=>{if(!this._browserName||!this._browserVersion||!this._browserOS){const e=live.testBrowser().details;this._browserName=e.browserName,this._browserVersion=e.browserVersion,this._browserOS=e.OS}const a="Chrome"===this._browserName||"Firefox"===this._browserName||"Safari"===this._browserName||"Edge"===this._browserName,r="Chrome"===this._browserName||"Firefox"===this._browserName||"Safari"===this._browserName||"Edge"===this._browserName,l="Chrome"===this._browserName||"Firefox"===this._browserName||"Edge"===this._browserName;"iOS"===this._browserOS&&"Safari"!==this._browserName?this._browserUnsupported="Safari":"Mac"!==this._browserOS||r?"Windows"!==this._browserOS||l?a||(this._browserUnsupported="Chrome or Firefox"):this._browserUnsupported="Edge, Chrome, or Firefox":this._browserUnsupported="Safari, Chrome, or Firefox","Chrome"===this._browserName&&this._browserVersion>i||"Firefox"===this._browserName&&this._browserVersion>o||"Edge"===this._browserName&&this._browserVersion>n||"Safari"===this._browserName&&this._browserVersion>=s?this._browserVersionUnsupported=!1:"Android"===this._browserOS&&"Safari"===this._browserName?this._browserVersionUnsupported=!1:this._browserVersionUnsupported=!0,"iOS"===this._browserOS||"Android"===this._browserOS?this._isMobileOS=!0:this._isMobileOS=!1,console.log("Supported browser: "+this._browserName+", version: "+this._browserVersion),e({browserName:this._browserName,browserVersion:this._browserVersion,browserUnsupported:this._browserUnsupported,browserVersionUnsupported:this._browserVersionUnsupported,isMobileOS:this._isMobileOS})})}cancelChecks(){console.log("cancelChecks: Diagnostics cancelled"),this._cancelled=!0}checkMeetingDiagnostics(e){console.log("checkMeetingDiagnostics: videoRequired="+e);const t=sessionStorage.getItem(a);return t?(this._meetingDiagnostics=JSON.parse(t),console.log("Have meeting diagnostics results: "+JSON.stringify(this._meetingDiagnostics,null,2)),this._haveAudioIn=this._meetingDiagnostics.audioIn,this._haveAudioOut=this._meetingDiagnostics.audioOut,this._haveVideo=this._meetingDiagnostics.video,this._networkResult=this._meetingDiagnostics.network,this._reloadedForDiagnosticsRun||this._haveAudioIn&&this._haveAudioOut||(console.log("We're headed for a diagnostics failure on meeting Rejoin, so reloading page instead"),this._reloadedForDiagnosticsRun=!0,location.reload()),this._checkNetworkResult(!e,this._networkResult)):(console.log("Warning: no meeting diagnostics results found"),Promise.resolve("No results"))}testVideo(e){if(console.log("$$$ LiveDiagnostics::testVideo upgradeableAudioCall="+e),e&&r){console.log("Asking permission to use the camera (alone)");let e=this;return new Promise(t=>{let i={video:!0};console.log("Invoking getUserMedia[5]: constraints=",i),navigator.mediaDevices.getUserMedia(i).then(i=>{console.log("We have been given stream:",i),i.getTracks().forEach(e=>{e.enabled=!1,e.stop()}),e._videoStream=i,t("Video check completed")}).catch(e=>{console.error("Failed while getting optional camera:",e),t("Failed to get video permission - but it was optional anyway")})})}return console.log("Camera is mandatory (or omitted) so do nothing here and leave it to the combined devices test"),Promise.resolve("Standalone video check was not required")}testCombinedDevices(e){if(console.log("LiveDiagnostics::testCombinedDevices includeCamera="+e),this._haveAudioIn&&this._haveAudioOut&&(!e||this._haveVideo))return console.log("LiveDiagnostics::testCombinedDevices success from restored values"),Promise.resolve("Diagnostics completed already");e?this._impl.dispatchEvent(t.LiveDiagnosticsAudioVideoStarted):this._impl.dispatchEvent(t.LiveDiagnosticsAudioStarted);let i={audio:!0};e&&(console.log("Including camera (video) as mandatory device.."),i.video={width:{min:640,ideal:1280,max:1920},height:{min:360,ideal:720,max:1080}});let o=this,s=t=>{let i=!1,s=!1,n=!1,a=[],r=!1,l=!1;(e=>{let t=navigator.mediaDevices.enumerateDevices();t&&t.then?navigator.mediaDevices.enumerateDevices().then(e).catch(()=>{e([])}):e([])})(c=>{c.forEach(e=>{let t={};for(let i in e)if("function"!=typeof e[i])try{t[i]=e[i]}catch(e){console.log("Error occurred checking for _device function",e)}if(console.log("Enumerated media device....",t),"audio"===t.kind&&(t.kind="audioinput"),"video"===t.kind&&(t.kind="videoinput"),"audioinput"===t.kind&&(r=!0,i=!0),"audiooutput"===t.kind&&(s=!0),"videoinput"===t.kind&&(n=!0,l=null!==o._videoStream)){const e={id:t.deviceId,label:t.label};a.push(e),console.log("cameraInfo: id: "+e.id+"  label: "+e.label)}}),console.log("mic="+i+", speakers="+s+", camera="+n+", micPermissions="+r+", camPermissions="+l),o._haveAudioIn=i&&r,o._haveAudioOut=o._haveAudioIn||s,o._haveVideo=!e||n&&l,o._haveTwoCameras=a.length>1,console.log("haveTwoCameras: "+(a.length>1)),console.log(`enumeratesFunction: cameras: ${JSON.stringify(a)}`),t("Camera, mic and speaker tests have been performed")})};return new Promise(t=>{console.log("Requesting user media with constraints:",i),console.log("Invoking getUserMedia[4]: constraints=",i),navigator.mediaDevices.getUserMedia(i).then(i=>{e&&(o._videoStream=i),i.getTracks().forEach(e=>{e.enabled=!1,e.stop()}),s(t)}).catch(e=>{console.log("Error occurred getting user media",e),s(t)})})}hasAudio(){return console.log("LiveDiagnostics: hasAudio - haveAudioIn="+this._haveAudioIn+", haveAudioOut="+this._haveAudioOut),this._haveAudioIn&&this._haveAudioOut}hasVideo(){return console.log("LiveDiagnostics: hasVideo - haveVideo="+this._haveVideo),this._haveVideo}hasTwoCameras(){return console.log("LiveDiagnostics: hasTwoCameras - haveTwoCameras="+this._haveTwoCameras),this._haveTwoCameras}startNetworkCheck(e){return this._checkNetwork(e)}_clearDiagnosticsTimer(e){const t=this._diagnosticsTimer[e];t&&(clearTimeout(t),delete this._diagnosticsTimer[e])}_checkAudioOutput(){return this._haveAudioOut?Promise.resolve("Audio out already verified"):(this._haveAudioOut=!1,new Promise((e,t)=>{this._diagnosticsTimer.audio_out=setTimeout(()=>{console.warn("LiveDiagnostics::_checkAudioOutput timed out at ",(new Date).toString()),t("Audio output diagnosis timed out")},this._audioOutDiagnosticsTimeout),live.testAudio().then(i=>{this._clearDiagnosticsTimer("audio_out");let o=null,s=!1;i.available?(console.log("LiveDiagnostics::_checkAudioOutput Audio output works",i),this._haveAudioOut=!0,o="Audio output success",s=!0):"Firefox"===this._browserName||"Safari"===this._browserName?(console.log("LiveDiagnostics::_checkAudioOutput failure ignored in browser "+this._browserName),this._haveAudioOut=!0,o="Audio output failure ignored",s=!0):(console.warn("LiveDiagnostics::_checkAudioOutput failed",i),o="Audio output diagnosis failed"),this._cancelled?t("CANCELLED"):s?e(o):t(o)}).catch(e=>{console.warn("LiveDiagnostics::_checkAudioOutput check failed",e),this._clearDiagnosticsTimer("audio_out"),t("Audio output does not work")})}))}_checkAudioInput(){return this._haveAudioIn?Promise.resolve("Audio in already verified"):(this._haveAudioIn=!1,new Promise((e,t)=>{this._diagnosticsTimer.audio_in=setTimeout(()=>{this._clearDiagnosticsTimer("audio_in"),console.log("LiveDiagnostics::_checkAudioInput timed out at ",(new Date).toString()),t("Audio input diagnosis timed out")},6e4),live.testMicrophone().then(i=>{this._clearDiagnosticsTimer("audio_in"),i.available?(console.log("LiveDiagnostics::_checkAudioInput: Microphone works"),this._haveAudioIn=!0,this._cancelled?t("CANCELLED"):e("Audio input works"),console.log("Audio input works"),this._haveAudioIn=!0,e("Audio input works")):"Safari"===this._browserName?(console.log("Audio input test failure result ignored in browser "+this._browserName),this._haveAudioIn=!0,e("Audio input failure ignored")):(console.warn("LiveDiagnostics::_checkAudioInput Audio input does not work",i),t("Audio input does not work"))}).catch(e=>{this._clearDiagnosticsTimer("audio_in"),console.warn("LiveDiagnostics::_checkAudioInput Audio input does not work",e),t("Audio input does not work")})}))}_checkNetwork(e){return console.log("LiveDiagnostics::_checkNetwork: result="+this._networkResult),this._networkResult?this._checkNetworkResult(e,this._networkResult):this._checkNetworkInternal(e)}_checkNetworkInternal(e){return console.log("LiveDiagnostics::_checkNetworkInternal: audio=",e),this._networkTestRunning&&this._networkPromise?this._networkPromise:(this._networkPromise=new Promise(t=>{const i=e=>{this._networkResult=0,this._clearDiagnosticsTimer("network"),this._networkTestRunning=!1,console.log("Network check failed",e),t("Network check failure")},o=(t,i)=>(this._clearDiagnosticsTimer("network"),console.log("Network Quality: status:"+t+", hints:",i),this._networkTestRunning=!1,this._networkResult=t,this._checkNetworkResult(e,this._networkResult));this._diagnosticsTimer.network=setTimeout(()=>{this._clearDiagnosticsTimer("network"),this._networkTestRunning=!1,console.log("Network diagnosis timed out"),t("Network diagnosis timed out")},this._diagnosticsTimeout),this._networkTestRunning?console.log("Network status check already running"):(console.log("Checking network status"),this._networkResult=0,this._impl.getNetworkStatus(o,i),this._networkTestRunning=!0)}),this._networkPromise)}_checkNetworkResult(e,t){return new Promise(i=>{switch(t){case 1:this._haveAudioOut=!1,i("Audio quality too low: "+t);break;case 2:e?i("Audio quality maybe low: "+t):(this._haveVideo=!1,i("Video quality too low: "+t));break;case 3:i("Video quality maybe low: "+t);break;case 4:case 5:i("Acceptable for audio and video: "+t);break;default:i("Unknown result: "+t)}})}}}),define("LiveScreenSharing",["LiveEvents","LiveSessionStore"],function(e,t){"use strict";return class{constructor(e){this._impl=e,this._remoteOutgoingSS=null,this._remoteIncomingSS=null,this._remoteOutgoingStreamId=null,this._remoteIncomingStreamId=null,this._localOutgoingSS=null,this._localIncomingSS=null,this._localOutgoingStreamId=null,this._localIncomingStreamId=null,this._outgoingScreenshareId=null,this._incomingScreenshareId=null,this._canvas=null,this._showScreenShareLoadingHint=!1,this._showSelectedScreenShareStream=!0,this._screenShareArrivingCanvasReady=!1,this._sharedTrack=null,this._outgoingSSCurrentTrackId=null,this._outgoingSSPreviousTrackId=null,this._showScreenSharePending=!1,this._haveDisplayedIncomingScreenShareInThisCallAlready=!1,this._screenSharePendingTimeout=null,this._screenShareStreamSettings={},this._localStreamOptions=null,this._localMedia=null,this._localScreenShareActive=!1,this._remoteScreenShareActive=!1,this._restartSendingScreenShare=!1,this._minChromeVersionForScreenShare=72,this._minSafariVersionForScreenShare=13,this._minFirefoxVersionForGetDisplayMedia=68,this._connectionRestored=!1,this._restoredStreams=[],this._qualityMetricsCallback=null,this._prefetchedBrowserSSStream=null,this.debugStreams(),t.initState("LiveScreenSharing",this),$(()=>{console.log("LiveScreenSharing: Loading"),t.loadState("LiveScreenSharing",e=>{this._remoteScreenShareActive=e.remoteScreenShareActive,this._localScreenShareActive=e.localScreenShareActive,this._restartSendingScreenShare=e.restartSendingScreenShare,this._remoteOutgoingStreamId=e.remoteOutgoingStreamId,this._remoteIncomingStreamId=e.remoteIncomingStreamId,this._localOutgoingStreamId=e.localOutgoingStreamId,this._localIncomingStreamId=e.localIncomingStreamId,this._localStreamOptions=e.localStreamOptions,console.log("LiveScreenSharing: Loaded: localOutgoingStreamId="+this._localOutgoingStreamId)})})}toJSON(){return JSON.stringify({remoteScreenShareActive:this._remoteScreenShareActive,localScreenShareActive:this._localScreenShareActive,restartSendingScreenShare:this._localScreenShareActive||this._restartSendingScreenShare,localStreamOptions:this._localStreamOptions,localOutgoingStreamId:this._localOutgoingSS?this._localOutgoingSS.getId():null,localIncomingStreamId:this._localIncomingSS?this._localIncomingSS.getId():null,remoteOutgoingStreamId:this._remoteOutgoingSS?this._remoteOutgoingSS.getId():null,remoteIncomingStreamId:this._remoteIncomingSS?this._remoteIncomingSS.getId():null})}loadComplete(){console.log("LiveScreenSharing:loadComplete()"),this._connectionRestored&&(console.log("LiveScreenSharing:loadComplete() resumes screen share"),console.log("LiveScreenSharing:loadComplete() State is:","\n_remoteScreenShareActive:\t\t",this._remoteScreenShareActive,"\n_localScreenShareActive:\t\t",this._localScreenShareActive,"\n_restartSendingScreenShare:\t\t",this._restartSendingScreenShare,"\n_localStreamOptions:\t\t",this._localStreamOptions,"\n_localOutgoingStreamId:\t\t",this._localOutgoingStreamId,"\n_localIncomingStreamId:\t\t",this._localIncomingStreamId),this._resumeScreenShare())}setConnectionRestored(){this._connectionRestored=!0}checkStreamPeerConnection(e,t){t&&(t.call?t.call.peerConnection||console.log("Something is wrong: "+e+" has no call.peerConnection reference"):console.log("Something is wrong: "+e+" has no call reference"))}showConversationStreams(){if(this._impl._conversation){let e=this._impl._conversation.getStreams();if(e){console.log("Conversation has streams:");for(let t=0;t<e.length;t++)console.log(" - stream id: "+e[t].getId())}}else console.log("Conversation has no streams")}debugStreams(){console.log("======= WEB API STREAMS ======="),console.log("=== _localOutgoingSS",this._localOutgoingSS),console.log("=== _localIncomingSS",this._localIncomingSS),console.log("=== _localOutgoingStreamId",this._localOutgoingStreamId),console.log("=== _localIncomingStreamId",this._localIncomingStreamId),console.log("=== _localScreenShareActive",this._localScreenShareActive),console.log("=== _remoteOutgoingSS",this._remoteOutgoingSS),console.log("=== _remoteIncomingSS",this._remoteIncomingSS),console.log("=== _remoteOutgoingStreamId",this._remoteOutgoingStreamId),console.log("=== _remoteIncomingStreamId",this._remoteIncomingStreamId),console.log("=== _remoteScreenShareActive",this._remoteScreenShareActive),this.isPermanentTwoWayScreenShare()&&(this.checkStreamPeerConnection("hidden outgoing",this._localOutgoingSS),this.checkStreamPeerConnection("hidden incoming",this._localIncomingSS)),this.showConversationStreams(),console.log("================================"),setTimeout(()=>{this.debugStreams()},3e4)}createScreenShareStream(e,t,i){if(!this._impl._conversation)return Promise.reject(new Error("No ongoing conversation"));let o=null;try{return i||(this._impl._screenshareStreamSendRecv?t?i=live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.SENDRECV,live.MEDIADIRECTION.SENDRECV):(i=live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.SENDRECV,live.MEDIADIRECTION.SENDRECV),o=e||null):i=t?live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.SENDONLY):live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.RECVONLY)),this._impl._conversation.addScreenShareStream(o,i)}catch(e){return Promise.reject(e)}}startReceivingScreenShare(e){console.log("LiveScreenSharing::startReceivingScreenShare",e,this._localIncomingSS,this._remoteIncomingSS),this._remoteIncomingSS=e,this._localIncomingSS?console.log("LiveScreenSharing::startReceivingScreenShare Local SS incoming stream already active"):(console.log("Creating screen share stream to receive remote SS"),this.createScreenShareStream(e.getId(),!1).then(e=>{this._localIncomingSS=e.stream,this._incomingScreenshareId=this._localIncomingSS.getId(),console.log(`startReceivingScreenShare: Incoming Screenshare ID = ${this._incomingScreenshareId}`),this._qualityMetricsCallback&&(this._localIncomingSS.onQualityMetrics=this._qualityMetricsCallback),this._localStreamOptions=e.options,this._initCallbacks(this._localIncomingSS),this._localIncomingSS.start([])}).catch(e=>{console.warn("LiveScreenSharing::startReceivingScreenShare Could not start local stream",e)}))}statsCollectorStop(){this._localIncomingSS&&(this._localIncomingSS.onQualityMetrics=null,console.log("TRANSFER: stopping stats collector for SS stream"),this._localIncomingSS.call.statsStop()),this._localOutgoingSS&&(console.log("TRANSFER: stopping stats collector for SS stream"),this._localOutgoingSS.call.statsStop())}statsCollectorStart(){this._localIncomingSS&&(this._localIncomingSS.onQualityMetrics=this._qualityMetricsCallback,console.log("TRANSFER: starting stats collector for SS stream"),this._localIncomingSS.call.statsStart()),this._localOutgoingSS&&(console.log("TRANSFER: starting stats collector for SS stream"),this._localOutgoingSS.call.statsStart())}stopReceivingScreenShare(){console.log("LiveScreenSharing: stopReceivingScreenShare"),this._impl.stopStream(this._localMedia),this._localMedia=null,this._impl._buttonState.activateRemoteVideo("screenshare",!1),this._remoteIncomingSS=null,this._localIncomingSS&&(this._localIncomingSS.end(),this._localIncomingSS=null),this._remoteScreenShareActive,this._remoteScreenShareActive=!1}populateScreenShareStream(e,t){if(console.log("populateScreenShareStream entered:",e,t),!this._localOutgoingSS)return console.log("no outgoing SS - where did it go???"),void alert("Can no longer share screen in this call as reference to outgoing screen share stream has been lost");if(!e)return void console.log("populateScreenShareStream given no content stream - ignoring");let i=null;console.log("have initialized promise to:",i);let o=this;const s=function(){console.log("Caught stream ended on screen share track"),o.stopSendingScreenShare()};let n=this._localOutgoingSS.call.peerConnection;console.log(`About to populate screenshare: ${this._localOutgoingSS.getId()}`);let a=!1;return n?(console.log("_outgoingSSPreviousTrackId="+this._outgoingSSPreviousTrackId),console.log("_outgoingSSCurrentTrackId="+this._outgoingSSCurrentTrackId),this._impl._av._activeLocalVideoTrack&&console.log("_av._activeLocalVideoTrack.id="+this._impl._av._activeLocalVideoTrack.id),e.getTracks().forEach(e=>{console.log("_outgoingSSPreviousTrackId="+this._outgoingSSPreviousTrackId),console.log("_outgoingSSCurrentTrackId="+this._outgoingSSCurrentTrackId),console.log("real (new) SS track..",e.id,e.label);let o=n.getSenders().find(t=>t.track.kind===e.kind);console.log("we have found remote sender and have new track",o,e),i=o.replaceTrack(e),console.log("we have requested the track replacement and have new promise",i),this._isChrome()?e.enabled=!0:(e.enabled=!1,console.log("Delaying track enable; required by FF"),i.then(()=>{setTimeout(()=>{console.log("Enabling track (after short delay; required by FF)"),e.enabled=!0},750)})),a=!0,this._sharedTrack=e,t&&(e.onended=s)})):console.warn("No peer connection available - cannot substitute screen share stream tracks as desired"),a?i:Promise.reject("Failed to replace any screen share tracks in LX populateScreenShareStream")}populateEmptyScreenShareStream(){this.populateScreenShareStream(this.getEmptyMediaStream(),!1)}populateStreamWithScreenShareComingHint(){this._showScreenShareLoadingHint&&(console.log("populateStreamWithScreenShareComingHint entered"),this._addCanvasBackground().then(()=>{console.log("have canvas background ready.. using it to capture a stream"),this._hintStream=this._canvas.captureStream(1);let e=this._hintStream.getTracks().find(e=>(console.log("Found Stream with track.id: "+e.id+", label:"+e.label),"video"===e.kind));e&&(console.log("Found hint stream with track id: "+e.id),null!==this._outgoingSSCurrentTrackId&&(this._outgoingSSPreviousTrackId=this._outgoingSSCurrentTrackId),this._outgoingSSCurrentTrackId=e.id,console.log("_outgoingSSCurrentTrackId="+this._outgoingSSCurrentTrackId),console.log("_outgoingSSPreviousTrackId="+this._outgoingSSPreviousTrackId)),console.log("have stream..",this._hintStream),this.populateScreenShareStream(this._hintStream,!0)}).catch(e=>{console.warn("LiveScreenSharing::populateStreamWithScreenShareComingHint failed:",e)}))}getEmptyMediaStream(){try{let e=document.querySelector("#screen-share-arriving");console.log("Starting hidden screen share stream using empty media, canvas=",e),this._isFirefox()&&(console.log("Helping the captureStream call to succeed for Firefox"),e.getContext("2d"));let t=e.captureStream(1);console.log("getEmptyMediaStream returning:",t);let i=t.getTracks().find(e=>(console.log("Found Stream with track.id: "+e.id+", label:"+e.label),"video"===e.kind));return i&&(console.log("Found screenshare with track id: "+i.id),null!==this._outgoingSSCurrentTrackId&&(this._outgoingSSPreviousTrackId=this._outgoingSSCurrentTrackId),this._outgoingSSCurrentTrackId=i.id,console.log("_outgoingSSCurrentTrackId="+this._outgoingSSCurrentTrackId),console.log("_outgoingSSPreviousTrackId="+this._outgoingSSPreviousTrackId)),t}catch(e){return console.warn("getEmptyMediaStream failed with exception:",e),null}}startDummyScreenShare(){let t;console.log("xxx-----\x3e LiveScreenSharing::startDummyScreenShare"),this.showConversationStreams(),t=this._impl._screenshareStreamSendRecv?live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.SENDRECV,live.MEDIADIRECTION.SENDRECV):live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.SENDRECV,live.MEDIADIRECTION.SENDONLY),this.createScreenShareStream(null,!0,t).then(t=>{console.log("we have dummy SS with stream/options",t),this._localOutgoingSS=t.stream,this._outgoingScreenshareId=this._localOutgoingSS.getId(),console.log(`startDummyScreenShare: Outgoing Screenshare ID = ${this._outgoingScreenshareId}`),this._qualityMetricsCallback&&(this._localOutgoingSS.onQualityMetrics=this._qualityMetricsCallback),this._localStreamOptions=t.options,this._initCallbacks(this._localOutgoingSS);let i=this.getEmptyMediaStream();i?this._localOutgoingSS.start([i]):this._localOutgoingSS.start([]),console.log("startDummyScreenShare: _localOutgoingSS: ",this._localOutgoingSS),this._impl.dispatchEvent(e.LiveLocalScreenStopped)}).catch(e=>{console.warn("LiveScreenSharing::startDummyScreenShare could not start local outgoing stream",e)}),$("#oracle-live-remote-screenshare").off("resize").on("resize",()=>{this._showScreenSharePending&&(console.log("Have been waiting for this resize - showing incoming screen share now.."),this.showIncomingScreenShareNow())}),console.log("Finished startDummyScreenShare"),this.showConversationStreams()}cleanSharedTrack(){this._sharedTrack&&(this._sharedTrack.stop(),this._sharedTrack=null)}startSendingScreenShareStream(e){console.log("LiveScreenSharing::startSendingScreenShareStream got permission to start"),this._impl.acceptUpgradeRequest(),this.populateScreenShareStream(e,!0).then(()=>{console.log("Track is replaced - other party can show the screen share again"),this.showHideScreenShare(!0)}).catch(e=>{console.warn("LiveScreenSharing::startSendingScreenShareStream: populate call failed:",e)})}getDisplaySurface(){return this._screenShareStreamSettings.displaySurface}startSendingScreenShare(){if(!this.isPermanentTwoWayScreenShare())return void this.startSendingScreenShareOriginal();if(console.log("LiveScreenSharing::startSendingScreenShare: remoteSS=",this._remoteOutgoingSS),this._remoteOutgoingSS)return console.log("LiveScreenSharing::startSendingScreenShare Remote SS stream already active"),this._impl.dispatchEvent(e.LiveLocalScreenStopped),void this._impl.declineUpgradeRequest();const t=(t,i)=>{console.warn(t,i),this._impl.declineUpgradeRequest(),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.stopSendingScreenShare(),this._isFirefox()&&this._impl.dispatchEvent(e.LiveMessageEmitted,"application_video_call_message_screen_share_declined")};if(this._isChrome()&&(console.log("Checking Chrome version >= ",this._minChromeVersionForScreenShare),parseInt(this._impl._browserVersion)<this._minChromeVersionForScreenShare))return this._impl.dispatchEvent(e.LiveMessageEmitted,"application_get_latest_browser_versionMessage"),console.log("In order to share your screen from Chrome you need version "+this._minChromeVersionForScreenShare+" or later"),void t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:","Your Chrome version ("+this._impl._browserVersion+") is inadequate - must be "+this._minChromeVersionForScreenShare+" or later");if(this._isSafari()&&(console.log("Checking Safari version >= ",this._minSafariVersionForScreenShare),parseInt(this._impl._browserVersion)<this._minSafariVersionForScreenShare))return this._impl.dispatchEvent(e.LiveMessageEmitted,"application_get_latest_browser_versionMessage"),console.log("In order to share your screen from Safari you need version "+this._minSafariVersionForScreenShare+" or later"),void t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:","Your Safari version ("+this._impl._browserVersion+") is inadequate - must be "+this._minSafariVersionForScreenShare+" or later");let i=!1;if(this._isFirefox()&&(console.log("Checking Firefox version >= ",this._minFirefoxVersionForGetDisplayMedia),parseInt(this._impl._browserVersion)<this._minFirefoxVersionForGetDisplayMedia&&(i=!0)),this._screenShareStreamSettings={},i)console.log("Using getUserMedia"),this._getMediaConstraints().then(e=>(console.log("LiveScreenSharing::startSendingScreenShare got constraints",e),console.log("Invoking getUserMedia[6]: constraints=",e),navigator.mediaDevices.getUserMedia(e))).then(e=>{this.startSendingScreenShareStream(e)}).catch(e=>{t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:",e)});else{console.log("Using getDisplayMedia");let e={video:!0};navigator.mediaDevices.getDisplayMedia(e).then(e=>{this._screenShareStreamSettings=e.getTracks()[0].getSettings(),console.log("Stream settings are: ",this._screenShareStreamSettings),this.startSendingScreenShareStream(e)},e=>{console.log("Unable to acquire screen capture",e),t("LiveScreenSharing::startSendingScreenShare error when starting screenshare:",e)})}}startSendingScreenShareOriginal(){if(console.log("LiveScreenSharing::startSendingScreenShareOriginal"),this._remoteOutgoingSS)return console.log("LiveScreenSharing::startSendingScreenShareOriginal Remote SS stream already active"),this._impl.dispatchEvent(e.LiveLocalScreenStopped),void this._impl.declineUpgradeRequest();const t=(t,i)=>{console.warn(t,i),this._impl.declineUpgradeRequest(),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.stopSendingScreenShare(),this._isFirefox()&&this._impl.dispatchEvent(e.LiveMessageEmitted,"application_video_call_message_screen_share_declined")};this.createScreenShareStream(null,!0).then(e=>{this._localOutgoingSS=e.stream,this._outgoingScreenshareId=this._localOutgoingSS.getId(),console.log(`startSendingScreenShareOriginal: Outgoing Screenshare ID = ${this._outgoingScreenshareId}`),this._qualityMetricsCallback&&(this._localOutgoingSS.onQualityMetrics=this._qualityMetricsCallback),this._localStreamOptions=e.options,this._initCallbacks(this._localOutgoingSS),null!==this._prefetchedBrowserSSStream?(console.log("Pre-fetching screenshare displayMedia stream ",this._prefetchedBrowserSSStream),this._impl.acceptUpgradeRequest(),this._localOutgoingSS.start([this._prefetchedBrowserSSStream]),this._prefetchedBrowserSSStream=null):!this._isMobileOS()&&(this._isChrome()||this._isSafari()||this._isFirefox())?(console.log("We're in a Desktop OS and in Chrome or Safari or Firefox so we'll use getDisplayMedia.."),navigator.mediaDevices.getDisplayMedia({video:!0}).then(e=>{console.log("We have a media stream from getDisplayMedia"),this._impl.acceptUpgradeRequest(),this._localOutgoingSS.start([e])},e=>{console.log("Unable to acquire screen capture",e)})):this._getMediaConstraints().then(e=>(console.log("LiveScreenSharing::startSendingScreenShareOriginal got constraints ",e),console.log("Invoking getUserMedia[7]: constraints=",e),navigator.mediaDevices.getUserMedia(e))).then(e=>{console.log("LiveScreenSharing::startSendingScreenShareOriginal got permission to start"),this._impl.acceptUpgradeRequest(),this._localOutgoingSS.start([e])}).catch(e=>{t("LiveScreenSharing::startSendingScreenShareOriginal error when starting screenshare:",e)})}).catch(e=>{t("LiveScreenSharing::startSendingScreenShareOriginal error when creating screenshare stream:",e),console.warn("LiveScreenSharing::startSendingScreenShareOriginal Could not start local stream",e)})}isPermanentTwoWayScreenShare(){return this._impl._permanentTwoWayScreenShare}clearPendingScreenShare(){this._showScreenSharePending=!1,this._screenSharePendingTimeout&&(clearTimeout(this._screenSharePendingTimeout),this._screenSharePendingTimeout=null)}showIncomingScreenShareNow(){console.log("Showing incoming screen share right now",this._localIncomingSS,this._remoteIncomingSS),this.clearPendingScreenShare(),this._remoteScreenShareActive=!0,this._impl._buttonState.activateRemoteVideo("screenshare",!0),this._impl.dispatchEvent(e.LiveRemoteScreenStarted)}showIncomingScreenShare(){console.log("We've been told to show incoming screen share"),this._isFirefox()||this._haveDisplayedIncomingScreenShareInThisCallAlready?this.showIncomingScreenShareNow():(console.log("First time, non-FF: we'll rely on screen resize to inform us of remote screen share arrival"),this._showScreenSharePending=!0,this._screenSharePendingTimeout=setTimeout(()=>{console.log("We're giving up waiting for resize event to trigger showing of screen share"),this.showIncomingScreenShareNow()},1500)),this._haveDisplayedIncomingScreenShareInThisCallAlready=!0}hideIncomingScreenShare(){console.log("We've been told to hide incoming screen share"),this._remoteScreenShareActive=!1,this._impl._buttonState.activateRemoteVideo("screenshare",!1),this._impl.dispatchEvent(e.LiveRemoteScreenStopped)}showHideScreenShare(t){console.log("showHideScreenShare("+t+")"),this._impl._conversation?t?(console.log("Web API sending relay message to show screen share"),this._impl._conversation.relayCommandTo(null,"*","show_screen_share",[{}]),this._impl.dispatchEvent(e.LiveLocalScreenStarted)):(console.log("Web API sending relay message to hide screen share"),this._impl.isCallEndedEvent()?console.log("showHideScreenShare("+t+") - Nothing to do because call has ended (callEnded event dispatched)"):(this._impl._conversation.relayCommandTo(null,"*","hide_screen_share",[{}]),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.cleanSharedTrack(),this.stopOutgoingSSVideo())):console.log("No conversation, so showHideScreenShare("+t+") call having no effect"),this._localScreenShareActive=t}stopSendingScreenShare(){console.log("LiveScreenSharing: stopSendingScreenShare"),this.showConversationStreams(),this.isPermanentTwoWayScreenShare()||this._impl._behaviours.isStartWithEndUserScreenShare()?(this.showHideScreenShare(!1),this._impl._behaviours.isStartWithEndUserScreenShare()&&!this.isPermanentTwoWayScreenShare()&&this.stopSendingScreenShareOriginal()):this.stopSendingScreenShareOriginal()}stopSendingScreenShareOriginal(){console.log("LiveScreenSharing: stopSendingScreenShareOriginal"),this._impl.stopStream(this._localMedia),this._localMedia=null,this._localScreenShareActive=!1,this._localOutgoingSS&&(this._localOutgoingSS.end(),this._localOutgoingSS=null),this._impl.dispatchEvent(e.LiveLocalScreenStopped),this.showConversationStreams()}pauseResumeStream(e){this._impl.isUsingExternalAudio()&&(e.audio=live.PAUSERESUME.PAUSE),console.log("LiveScreenSharing: pauseResumeStream",e),this._localOutgoingSS&&(console.log("LiveScreenSharing: pauseResumeStream - local outgoing:",this._localOutgoingSS),this._localOutgoingSS.pauseResumeStream(e)),this._localIncomingSS&&(console.log("LiveScreenSharing: pauseResumeStream - local incoming:",this._localIncomingSS),this._localIncomingSS.pauseResumeStream(e))}streamJoined(e){console.log("=== LiveScreenSharing: streamJoined",e);let t=!1;(t=this._impl._screenshareStreamSendRecv?this._incomingScreenshareId&&this._incomingScreenshareId===e.getId():"recvonly"===e.streamOptions.videoConfig)&&(console.log("=== streamJoined: can join"),console.log("=== streamJoined: Our dummy screen share has started - make sure we've got it paused"),this._localScreenShareActive?console.log("Looks like an associate reconnect.. leaving the (currently shared) stream alone"):this.isPermanentTwoWayScreenShare()&&this.stopOutgoingSSVideo())}pauseResumeOutgoing(e){if(console.log("LiveScreenSharing: pauseResumeOutgoing: paused=",e),this._localOutgoingSS&&this._localOutgoingSS.call){let t=this._localOutgoingSS.call.peerConnection;if(t){let i=t.getSenders().find(e=>"video"===e.track.kind),o=e?"pausing":"resuming";console.log("LiveScreenSharing: "+o+" video track:",i.track),i.track.enabled=!e}}this._impl._av.disableAudioForScreenshareStream()}stopOutgoingSSVideo(){if(console.log("LiveScreenSharing: stopOutgoingSSVideo"),this._localOutgoingSS){this.populateEmptyScreenShareStream(),console.log("Attempting to disable video tracks of hidden outgoing screen share stream (to save RTP)");let e=this._localOutgoingSS.call.peerConnection;if(e){let t=e.getSenders().find(e=>"video"===e.track.kind);console.log("Disabling video track of sender",t.track,t),t.track.enabled=!1}}}beforeUnload(){!0===this._localScreenShareActive?(console.log("LiveScreenSharing::beforeUnload - attempt to stop local screenshare"),this._restartSendingScreenShare=!0,this.stopSendingScreenShare()):console.log("LiveScreenSharing::beforeUnload - do nothing")}resume(e){console.log("======= LiveScreenSharing::resume",e),this._restoredStreams.push(e)}maybeSelectRemoteSS(){console.log("LiveScreenSharing::maybeSelectRemoteSS: remoteScreenShareActive=",this._remoteScreenShareActive,this._localIncomingSS,this._remoteIncomingSS),this._localIncomingSS&&this._remoteIncomingSS&&(console.log("Setting layout on incoming screen share"),this._remoteIncomingSS.setLayout(live.STREAMSIZE.PRIMARY,this._localIncomingSS))}makeBrowserScreenShareRequest(e){return this._isMobileOS()?this._makeUnsupportedBrowserScreenShareRequest(e):this._makeSupportedBrowserScreenShareRequest(e)}_makeSupportedBrowserScreenShareRequest(e){return console.log("LiveScreenSharing::_makeSupportedBrowserScreenShareRequest"),navigator.mediaDevices.getDisplayMedia({video:!0}).then(t=>{console.log("LiveScreenSharing::BrowserScreenShareRequest: We have a media stream for screenshare"),this._prefetchedBrowserSSStream=t,e&&e.showStartCallDialog(!0)},e=>{throw console.error("LiveScreenSharing::BrowserScreenShareRequest: Unable to acquire screen capture: ",e),e})}_makeUnsupportedBrowserScreenShareRequest(e){return console.log("_makeUnsupportedBrowserScreenShareRequest"),this._getMediaConstraints().then(e=>(console.log("LiveScreenSharing::startSendingScreenShare got constraints",e),console.log("Invoking getUserMedia[8]: constraints=",e),navigator.mediaDevices.getUserMedia(e))).then(e=>{this._prefetchedBrowserSSStream=e}).catch(e=>{throw console.error("LiveScreenSharing::BrowserScreenShareRequest: Unable to acquire screen capture: ",e),e})}stopPreFetchedBrowserSSStream(){console.log("stopPreFetchedBrowserSSStream:"),console.dir(this._prefetchedBrowserSSStream),this._prefetchedBrowserSSStream?(console.log("stopPreFetchedBrowserSSStream: stopping tracks"),this._prefetchedBrowserSSStream.getTracks().forEach(e=>e.stop()),this._prefetchedBrowserSSStream=null):console.log("stopPreFetchedBrowserSSStream: no stream")}isActive(){return!!this._localOutgoingSS||!!this._localIncomingSS}_resumeScreenShare(){if(console.log("=== LiveScreenSharing::_resumeScreenShare",this._restoredStreams),this._restoredStreams.forEach(e=>{console.log("resuming stream",e);const t=e.getId();t===this._localOutgoingStreamId?(console.log("=== (this is _localOutgoingSS)"),this._localOutgoingSS=e):t===this._localIncomingStreamId?(console.log("=== (this is _localIncomingSS)"),this._localIncomingSS=e):t===this._remoteOutgoingStreamId?(console.log("=== (this is _remoteOutgoingSS)"),this._remoteOutgoingSS=e):t===this._remoteIncomingStreamId&&(console.log("=== (this is _remoteIncomingSS)"),this._remoteIncomingSS=e)}),console.log("=== Assigned local and remote streams: ","_localOutgoingSS:",this._localOutgoingSS,"_remoteOutgoingSS:",this._remoteOutgoingSS,"_localIncomingSS:",this._localIncomingSS,"_remoteIncomingSS:",this._remoteIncomingSS),this._localOutgoingSS){console.log("LiveScreenSharing::resume: resuming hidden outgoing stream");try{this._initCallbacks(this._localOutgoingSS),this._localOutgoingSS.resume(()=>{console.log("LiveScreenSharing::resume: local outgoing stream resumed"),this.stopOutgoingSSVideo()},e=>{console.log("LiveScreenSharing::resume: FAILED to resume local outgoing SS stream:",e)})}catch(e){console.warn("LiveScreenSharing::resume could not restart outgoing screen share stream",e)}}if(this._localIncomingSS){console.log("LiveScreenSharing::resume: resuming hidden incoming stream");try{this._initCallbacks(this._localIncomingSS),this._localIncomingSS.resume(()=>{console.log("LiveScreenSharing::resume: local incoming stream resumed")},e=>{console.log("LiveScreenSharing::resume: FAILED to resume local incoming SS stream:",e)})}catch(e){console.warn("LiveScreenSharing::resume could not restart incoming screen share stream",e)}}!0===this._restartSendingScreenShare&&(console.log("LiveScreenSharing::resume ask user if they want to start the screenshare again"),this.startSendingScreenShare(),this._restartSendingScreenShare=!1)}_isChrome(){return"Chrome"===this._impl._browserName}_isFirefox(){return"Firefox"===this._impl._browserName}_isSafari(){return"Safari"===this._impl._browserName}_isMobileOS(){return this._impl._isMobileOS}reset(){this.stopPreFetchedBrowserSSStream(),this._remoteScreenShareActive=!1,this._localScreenShareActive=!1,this._restartSendingScreenShare=!1,this._localStreamOptions=null,this._remoteStreamId=null,this._remoteOutgoingSS=null,this._remoteIncomingSS=null,this._remoteOutgoingStreamId=null,this._remoteIncomingStreamId=null,this._outgoingScreenshareId=null,this._incomingScreenshareIdS=null,this._localOutgoingSS=null,this._localIncomingSS=null,this._localOutgoingStreamId=null,this._localIncomingStreamId=null,this._sharedTrack=null,this._screenShareArrivingCanvasReady=!1,this._showScreenSharePending=!1,this._haveSharedScreenInThisCallAlready=!1,this._screenSharePendingTimeout=null,this._haveDisplayedIncomingScreenShareInThisCallAlready=!1,this._screenShareStreamSettings={},this._prefetchedBrowserSSStream=null}_getMediaConstraints(){if(this._isFirefox()){const e={video:{mediaSource:"window"}};return Promise.resolve(e)}if(this._isSafari()){const e={video:{mediaSource:"window"}};return Promise.resolve(e)}console.warn("_getMediaConstraints() called, but doing nothing, for browser: "+this._impl._browserName)}_initCallbacks(e){console.log("Adding callbacks to stream:",e),e.withCallbacks(this.detectWhenScreenSharingHasChangedState.bind(this,e),this._makeScreenSharingStreamsLive.bind(this),this.detectWhenScreenSharingIsUpdated.bind(this,e),this.detectWhenStreamHasFailed.bind(this),this.detectStreamPauseResumeRequest.bind(this),this.detectWhenStreamOptionsAreUpdated.bind(this))}detectWhenScreenSharingHasChangedState(e,t){console.log("LiveScreenSharing: detectWhenScreenSharingHasChangedState: streamState=",JSON.stringify(t,null,2),e);const i=t.state,o=t.status,s=0+o.code,n=o.reason;switch(this._impl._connection.logEventTimestamp("ssStreamStateTo"+i),i){case live.STREAMSTATE.FAILED:case live.STREAMSTATE.ENDED:this._impl.onScreenShareEnded();break;case live.STREAMSTATE.ESTABLISHED:this._impl.onCallEstablished(!0),this._impl._screenshareStreamSendRecv||this._localStreamOptions.videoConfig!==live.MEDIADIRECTION.SENDRECV||(console.log("LiveScreenSharing: Downgrade local SS to sendonly"),this._localStreamOptions=live.StreamInfo.createStreamOptions(live.MEDIADIRECTION.INACTIVE,live.MEDIADIRECTION.SENDONLY),e.update(this._localStreamOptions));break;case live.STREAMSTATE.ERROR:console.log("LiveAudioVideo: detectWhenStreamHasChangedState - ERROR: code="+s+", reason="+n),s===live.ERRORCODE.ICE_CONNECTION_ERROR&&(console.log("LiveScreenSharing: ICE connection error"),this._impl.onCallStreamStateError())}}detectStreamPauseResumeRequest(t,i,o,s){const n=s.reason,a=n===live.PAUSERESUMEREASON.PAUSE_RESUME,r=s.audio===live.PAUSERESUME.PAUSE&&s.video===live.PAUSERESUME.PAUSE;console.log("LiveScreenSharing::detectStreamPauseResumeRequest() reason=",n,", isPause=",r),a&&(o.accept(),this.pauseResumeStream(s),r?this._impl.dispatchEvent(e.LivePausedRemotely):this._impl.dispatchEvent(e.LiveResumedRemotely))}_makeScreenSharingStreamsLive(t,i){if(console.log("LiveScreenSharing::_makeScreenSharingStreamsLive: event=",t,i),i instanceof RTCRtpReceiver||i instanceof RTCRtpSender){if(null===i.track)return void console.log("LiveScreenSharing::_makeScreenSharingStreamsLive: ignore screen-sharing event without video")}else if(0===i.getVideoTracks().length)return void console.log("LiveScreenSharing::_makeScreenSharingStreamsLive: ignore screen-sharing event without video");const o=$(".oracle-live-local-screenshare"),s=$("#oracle-live-remote-video-screenshare");switch(t){case live.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED:this._localMedia=i,o.length?(this._impl._av.attachToMedia(i,o[0],!1,this.detectWhenScreenSharingEnds.bind(this)),this.isPermanentTwoWayScreenShare()||this._impl.dispatchEvent(e.LiveLocalScreenStarted)):console.error("LiveScreenSharing: _makeScreenSharingStreamsLive no element");break;case live.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED:this._impl.stopStream(this._localMedia),this._localMedia=null,o.length?o[0].srcObject=null:console.error("LiveScreenSharing: _makeScreenSharingStreamsLive No screen share element"),this.isPermanentTwoWayScreenShare()||this._impl.dispatchEvent(e.LiveLocalScreenStopped);break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED:s.length||this._impl._buttonState.addRemoteVideo("screenshare","Share",!0),this._impl._av.attachToMedia(i,document.getElementById("oracle-live-remote-video-screenshare"),!1),this.isPermanentTwoWayScreenShare()?(this._remoteScreenShareActive=!1,this._impl._buttonState.activateRemoteVideo("screenshare",!1)):(this._remoteScreenShareActive=!0,this._impl._buttonState.activateRemoteVideo("screenshare",!0),this._impl.dispatchEvent(e.LiveRemoteScreenStarted));break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED:this._remoteScreenShareActive=!1,s.length?(s[0].srcObject=null,this._impl._buttonState.activateRemoteVideo("screenshare",!1)):console.error("LiveScreenSharing: _makeScreenSharingStreamsLive no element")}}detectWhenScreenSharingEnds(){console.log("LiveScreenSharing: detectWhenScreenSharingEnds"),this.stopSendingScreenShare()}detectWhenScreenSharingIsUpdated(e,t){console.log("LiveScreenSharing: detectWhenScreenSharingIsUpdated",t),e&&(this._localStreamOptions=t,e.accept(t))}detectWhenStreamHasFailed(t){console.log("LiveScreenSharing: detectWhenStreamHasFailed, error="+JSON.stringify(t,null,2)),this._impl.dispatchEvent(e.LiveStreamError)}detectWhenStreamOptionsAreUpdated(e,t,i,o){console.log("LiveScreenSharing: detectWhenStreamOptionsAreUpdated: streamRequest="+JSON.stringify(i,null,2)+", streamOptions="+JSON.stringify(o,null,2),t),i.accept(),t&&(this._localStreamOptions=o,t.accept(o))}isScreenScreenSharePossible(){return this._isFirefox()||this._isChrome()}_addCanvasBackground(){return this._screenShareArrivingCanvasReady?Promise.resolve():new Promise((e,t)=>{console.log("adding screenshare-arriving canvas background image"),this._canvas=document.querySelector("#screen-share-arriving"),console.log("have found screen share canvas:",this._canvas);let i=this._canvas.getContext("2d");i.font="14px Arial",i.fillStyle="white",i.textAlign="center",i.fillText("Screen Share Frames Arriving...",this._canvas.width/2,this._canvas.height/2),this._screenShareArrivingCanvasReady=!0,e()})}}}),define("LiveAudioVideo",["jquery","LiveEvents","LiveSessionStore"],function($,e,t){"use strict";return class{constructor(e){this._impl=e,this._avStreams=new Set,this._localAudioStream=null,this._localVideoStream=new Map,this._previewStream=null,this._cameraAction=null,this._cameraApplyToLiveStream=!0,this._haveAskedUserPermissionForSharingVideo=!1,this._localStreamOptions=null,this._originalStreamOptions=null,this._userVideoInitiallyPaused=!1,this._associateVideoInitiallyPaused=!1,this._userIsCurrentlyPaused=new Map,this._userPauseStreamState=null,this._isVideoActuallyPaused=new Map,this._upgradePauseResume=null,this._sidebar=!1,this._qualityMetricsCallback=null,this._currentCameraId=null,this._hasTransferStreamStarted=!1,this._isSwitchingToNewAssocStream=!1,this._isShowingDummyVideoTrack=!1,this._myVideoStillFrozen=!1,this._activeLocalVideoTrack=new Map,this._cameras=[],this._hasTwoCameras=!1,t.initState("LiveAudioVideo",this),$(()=>{console.log("LiveAudioVideo: Loading"),t.loadState("LiveAudioVideo",e=>{this._localStreamOptions=e.localStreamOptions,this._originalStreamOptions=e.originalStreamOptions,this._avStreams=new Set(e.avStreams),this._userVideoInitiallyPaused=e.userVideoInitiallyPaused,this._associateVideoInitiallyPaused=e.associateVideoInitiallyPaused,this._userIsCurrentlyPaused=new Map(Object.entries(e.userIsCurrentlyPaused)),this._isVideoActuallyPaused=new Map(Object.entries(e.isVideoActuallyPaused)),this._hasTwoCameras=e.hasTwoCameras,this._currentCameraId=e.currentCameraId,this._cameras=e.cameras,this._hasTransferStreamStarted=e.hasTransferStreamStarted,this._isSwitchingToNewAssocStream=e.isSwitchingToNewAssocStream,this._isShowingDummyVideoTrack=e.isShowingDummyVideoTrack,console.log("LiveAudioVideo: Loaded, AVSet=",this._avStreams),console.log("LiveAudioVideo: Loaded, currentCameraId=",this._currentCameraId)})})}toJSON(){let e=[];for(let t of this._avStreams){let i={};i.id=t.id,e.push(i)}return JSON.stringify({localStreamOptions:this._localStreamOptions,originalStreamOptions:this._originalStreamOptions,avStreams:e,userVideoInitiallyPaused:this._userVideoInitiallyPaused,associateVideoInitiallyPaused:this._associateVideoInitiallyPaused,userIsCurrentlyPaused:Object.fromEntries(this._userIsCurrentlyPaused),isVideoActuallyPaused:Object.fromEntries(this._isVideoActuallyPaused),hasTwoCameras:this._hasTwoCameras,currentCameraId:this._currentCameraId,cameras:this._cameras,hasTransferStreamStarted:this._hasTransferStreamStarted,isSwitchingToNewAssocStream:this._isSwitchingToNewAssocStream,isShowingDummyVideoTrack:this._isShowingDummyVideoTrack})}loadComplete(){if(console.log("LiveAudioVideo: Load complete"),this._avStreams.length&&this._impl._conversation){console.log("LiveAudioVideo: Attempting to resolve AVSet: ",this._avStreams);for(let e of this._avStreams){let t=this._impl._conversation.getAudioVideoStream(e.id);t&&t.getId()===t.id?e.stream=t:this._avStreams.delete(e)}}this._showSwapCameraButton()}_isEdge(){return"Edge"===this._impl._browserName}isActive(){let e=!1;for(let t of this._avStreams)e=e||t.stream;return e}isStreamActive(e){for(let t of this._avStreams)if(e.getId()===t.id)return!!t.stream;return!1}_showSwapCameraButton(){const e=$(".oracle-live-swap-camera"),t=navigator.userAgent.includes("Android")&&"Firefox"===this._impl._browserName;e&&(this._hasTwoCameras&&!t?(console.log("LiveAudioVideo:_showSwapCameraButton removing oracle-live-hide-camera-swap-button class"),e.removeClass("oracle-live-hide-camera-swap-button")):(console.log("LiveAudioVideo:_showSwapCameraButton adding oracle-live-hide-camera-swap-button class"),e.addClass("oracle-live-hide-camera-swap-button")))}_getCameraDeviceIds(e){console.log("LiveAudioVideo::_getCameraDeviceIds");let t=!1;e.forEach(e=>{if("videoinput"===e.kind){console.log("LiveAudioVideo::_getCameraDeviceIds found a camera: ",e);const i=e.label.toLowerCase().includes("front")||e.label.includes("");console.log("LiveAudioVideo::_getCameraDeviceIds: from its label we think this is "+(i?"":"NOT ")+"a front-facing camera");const o={deviceId:e.deviceId,label:e.label,isFront:i};this._cameras.push(o),o.isFront&&(t=!0)}}),console.log("Did we have a front camera?"),this._cameras.length>0&&!t&&(console.log("We didn't find a 'front' camera so assume the first device is the front camera"),this._cameras[0].isFront=!0),console.log("LiveAudioVideo::_getCameraDeviceIds cameras: ",this._cameras),this._hasTwoCameras=this._cameras.length>1,this._showSwapCameraButton()}_getDifferentCameraId(e){let t;if(console.log("LiveAudioVideo::_getDifferentCameraId"),this._cameras){let i=this._cameras.find(t=>t.deviceId&&t.deviceId===e),o=!i||i.isFront;this._isShowingDummyVideoTrack&&console.log("We're looking for a video track different from our dummy video track: direction irrelevant"),t=this._cameras.find(t=>(console.log("LiveAudioVideo::_getDifferentCameraId  camera: ",t),t.deviceId&&t.deviceId!==e&&(this._isShowingDummyVideoTrack||t.isFront!==o)))}return t?t.deviceId:e}_getCameraStreamWithDeviceId(e,t,i){console.log(`getCameraStream for camera with deviceId: ${e}`);let o=null;const s={audio:!1,video:!e||""===e||{deviceId:{exact:e}}};console.log("Invoking getUserMedia[1]: constraints=",s),navigator.mediaDevices.getUserMedia(s).then(e=>{console.log("_getCamera: we got a stream"),t(o=e)}).catch(t=>{console.log(`getCameraStream failed to obtain stream for camera with deviceID: ${e}`),console.error("getCameraStream error:  ",t),console.error(`getCameraStream error:  name: ${t.name}   message: ${t.message}`),i(t)})}reset(){this._impl.stopStream(this._localAudioStream),this._localVideoStream.forEach((e,t)=>{this._impl.stopStream(e),this._localVideoStream.delete(t)}),this._userPauseStreamState=null,this._impl.stopStream(this._previewStream),this._avStreams=new Set,this._activeLocalVideoTrack.clear(),this._localAudioStream=null,this._localVideoStream.clear(),this._previewStream=null,this._cameraAction=null,this._cameraApplyToLiveStream=!0,this._haveAskedUserPermissionForSharingVideo=!1,this._localStreamOptions=null,this._originalStreamOptions=null,this._userVideoInitiallyPaused=!1,this._associateVideoInitiallyPaused=!1,this._userIsCurrentlyPaused.clear(),this._isVideoActuallyPaused.clear(),this._upgradePauseResume=null,this._sidebar=!1,this._currentCameraId=null,this._hasTransferStreamStarted=!1,this._isSwitchingToNewAssocStream=!1,this._isShowingDummyVideoTrack=!1,this._myVideoStillFrozen=!1,document.querySelectorAll(".oracle-live-remote-video-container").forEach(e=>e.remove())}start(e,t,i){console.log("LiveAudioVideo: start");let o=!1;if(this._previewStream&&this._previewStream.getVideoTracks()&&this._previewStream.getVideoTracks()[0])o=!0;else{const e=this._impl._behaviours.isStartWithEndUserVideo();this._impl._behaviours.isEndUserVideoPossible()&&!e&&(console.log("LiveAudioVideo: start - upgradeable audio call so we'll supply the initial stream"),o=!0)}console.log("LiveAudioVideo: start -  usePreviewStream: ",o);let s=this._impl._conversation.createAudioVideoStream(e,null,t);this._avStreams.add({stream:s,id:s.getId(),active:!1}),this._localStreamOptions=e;const n=e=>{this._initCallbacks(s),s.start(e)};if(this._qualityMetricsCallback&&(s.onQualityMetrics=this._qualityMetricsCallback),i)console.log("LiveAudioVideo: start - Attempting to use custom constraints: "+JSON.stringify(i,null,2)),console.log("Invoking getUserMedia[2]: constraints=",i),navigator.mediaDevices.getUserMedia(i).then(e=>{console.log("LiveAudioVideo: start - Got media for custom constraints",e),this._localVideoStream.set(s.getId(),e),n(e)}).catch(e=>{console.log("LiveAudioVideo: start - Failed to getUserMedia with custom constraints",e),n(null)});else if(o)if(this._previewStream)console.log(`start: Searching local video stream: Length = ${this._localVideoStream.size}`),console.log(`Adding local video stream: ${s.getId()}`),this._localVideoStream.set(s.getId(),this._previewStream),n(this._previewStream);else{const e={audio:!0};console.log("LiveAudioVideo: start - Invoking getUserMedia[DUMMY]: constraints=",e),navigator.mediaDevices.getUserMedia(e).then(e=>{console.log("LiveAudioVideo: getUserMedia[DUMMY] - we got audio stream",e),console.log("LiveAudioVideo: adding a dummy video track for audio upgradeable call");let t=this.getDummyCameraStreamVideoTrack();t&&(e.addTrack(t),this._isShowingDummyVideoTrack=!0),console.log("LiveAudioVideo: getUserMedia[DUMMY] - starting call with real audio and dummy video"),n(e)}).catch(e=>{console.log("LiveAudioVideo: start - we failed to get a stream",e)})}else console.log("LiveAudioVideo: start - starting local av media with null stream"),n(null)}getDummyCameraStreamVideoTrack(){let e=null;try{let t=document.querySelector("#screen-share-arriving"),i=t.getContext("2d");console.log("got canvas context(2d):",i),console.log("getDummyCameraStreamVideoTrack: using canvas",t);let o=t.captureStream(1).getTracks().find(e=>(console.log("getDummyCameraStreamVideoTrack: Have manufactured track with id: "+e.id+", label:"+e.label),"video"===e.kind));o&&(e=o)}catch(e){}return console.log("getDummyCameraStreamVideoTrack: returning",e),e}_getStreamById(e){for(let t of this._avStreams)if(t.id===e)return t;return null}resume(e){const t=e.getId();console.log("LiveAudioVideo: resume, stream id=",t);let i=this._getStreamById(t);null!==i?(i.stream=e,this._initCallbacks(i.stream),console.log("LiveAudioVideo: resume - member of _avStreams"),new Promise((t,i)=>{e.resume(t,i)}).then(()=>{console.log("LiveAudioVideo: resume - AV stream resumed",e),$(".oracle-live").hasClass("oracle-live-local-audio-mute")&&(console.log("Local audio is muted. Restoring mute status"),this.updateAudioForEchoCancellation(!0)),this._impl.addQualityMonitor(),this._impl.reconnectedLocal()}).catch(e=>{console.log("LiveAudioVideo: resume - FAILED to resume AV stream:",e);for(let e of this._avStreams)if(e.id===t){this._impl.reset();break}})):console.warn("LiveAudioVideo: resume - Invalid stream ID: "+t,e)}_initCallbacks(e){e.withCallbacks(this.detectWhenStreamHasChangedState.bind(this,e),this.makeAudioVideoStreamsLive.bind(this,e),this.detectWhenAudioVideoIsUpdated.bind(this,e),this.detectWhenStreamHasFailed.bind(this,e),this.detectStreamPauseResumeRequest.bind(this))}stop(){console.log("LiveAudioVideo: stop");for(let e of this._avStreams)e.stream.end(),this._avStreams.delete(e)}streamJoined(e){if(console.log("LiveAudioVideo: streamJoined, userPaused="+this._userVideoInitiallyPaused+", assocPaused="+this._associateVideoInitiallyPaused,e),this.startRemoteStreamForNewAssociate(e?e.streamId:null),this.isActive()&&(this._userVideoInitiallyPaused&&this.stopVideo(),this._associateVideoInitiallyPaused||this._impl.isUsingExternalAudio())){const t=e.getStreamProfile();t.upgraded=!1,t.paused_by=this._impl.service.userID,t.pauseResume.pausedBy=this._impl.service.userID,this._impl.isUsingExternalAudio()&&(t.pauseResume.audio=live.PAUSERESUME.PAUSE),this._associateVideoInitiallyPaused&&(t.pauseResume.video=live.PAUSERESUME.PAUSE),t.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,console.log("LiveAudioVideo: Associate is initially paused - updating stream profile",t),e.pauseResumeStream(t.pauseResume)}}disableReceiverAudio(e){let t=e.call?e.call.peerConnection:null;if(t){const i=e.getId();let o=t.getReceivers().find(e=>e&&e.track&&"audio"===e.track.kind);if(o&&o.track){const e=o.track.enabled;o.track.enabled=!1,console.log(`disableReceiverAudio(${i} receiver track: ${e} -> ${o.track.enabled}`)}else console.warn("disableReceiverAudio: Cannot find receiver track")}else console.warn("setAudioSendRecvForStream: Cannot find peer connection")}setAudioSendRecvForStream(e,t,i){let o=e.call?e.call.peerConnection:null;if(o){const s=e.getId();let n=o.getSenders().find(e=>e&&e.track&&"audio"===e.track.kind);if(n&&n.track?(n.track.enabled=t,console.log("setAudioSendRecvForStream("+s+"): sender track="+t)):console.warn("setAudioSendRecvForStream: Cannot find sender track"),i)console.log("Muted only condition, not affecting receiver track");else{let e=o.getReceivers().find(e=>(console.log("setAudioSendRecvForStream("+s+"): receiver track="+t),e&&e.track&&"audio"===e.track.kind));e&&e.track?e.track.enabled=t:console.warn("setAudioSendRecvForStream: Cannot find receiver track")}}else console.warn("setAudioSendRecvForStream: Cannot find peer connection")}setVideoSendRecvForStream(e,t,i){let o=e.call?e.call.peerConnection:null;if(o){const s=e.getId();let n=o.getSenders().find(e=>e&&e.track&&"video"===e.track.kind);n&&n.track?(n.track.enabled=t,console.log("setVideoSendRecvForStream("+s+"): sender track="+t)):console.warn("setVideoSendRecvForStream: Cannot find sender track");let a=o.getReceivers().find(e=>(console.log("setVideoSendRecvForStream("+s+"): receiver track="+i),e&&e.track&&"video"===e.track.kind));a&&a.track?a.track.enabled=i:console.warn("setVideoSendRecvForStream: Cannot find receiver track")}else console.warn("setVideoSendRecvForStream: Cannot find peer connection")}updateVideoForBrokenWsc(e){if(console.log("updateVideoForBrokenWsc"),e&&"boolean"!=typeof e){console.log("Type of pauseResumeStatus = ",typeof e);for(let t of this._avStreams)if(t&&t.stream){let i=e.video!==live.PAUSERESUME.PAUSE;this.setVideoSendRecvForStream(t.stream,i,i)}}}disableAudioForScreenshareStream(){console.log("disableAudioForScreenshareStream");let e=this._impl._conversation.getStreams().filter(e=>e.getType()===live.STREAMTYPE.SCREENSHARE&&!e.getStreamState().isFinalState());for(let t=0;t<e.length;t++)this.disableReceiverAudio(e[t])}updateAudioForEchoCancellation(e){let t=!0;if(e&&"boolean"!=typeof e){console.log("Type of pauseResumeStatus = ",typeof e);for(let i of this._avStreams)if(i&&i.stream)if(t){let o=e.audio!==live.PAUSERESUME.PAUSE,s=!0;console.log(`updateAudioForEchoCancellation: Using pauseResumeStatus, audio enabled = ${o}`),this._impl._buttonState.localMute&&(o=!1,console.log("mute button state is active, so setting mutedOnly"),s=!0),this.setAudioSendRecvForStream(i.stream,o,s),t=!1}else this.setAudioSendRecvForStream(i.stream,!1)}else{let i,o=null;"boolean"==typeof e&&(console.log(`updateAudioForEchoCancellation: pauseResumeStatus = ${e}`),o=e);let s=!1;this._userIsCurrentlyPaused.forEach(e=>{s=s||e}),!1===o?(console.log("Setting muted state to false"),i=!1):!0===o?(i=!0,console.log("Setting muted state to true")):(i=s||this._impl._buttonState.localMute,console.log(`Setting muted state to "${i}"`)),console.log("updateAudioForEchoCancellation: user paused state: "+s+" user mute state: "+i+" force mute: "+o);for(let e of this._avStreams)if(e&&e.stream)if(t){let o=!i;o=this.determineFinalAudioState(o),i&&(o=!1),this.setAudioSendRecvForStream(e.stream,o,!s&&i),t=!1}else this.setAudioSendRecvForStream(e.stream,!1)}}determineFinalAudioState(e){let t=e;return this._userPauseStreamState&&(this._userPauseStreamState.audio===live.PAUSERESUME.PAUSE?(console.log("determineFinalAudioState: user audio state is paused"),t=!1):this._userPauseStreamState.audio===live.PAUSERESUME.RESUME&&(console.log("determineFinalAudioState: user audio state is resumed"),t=!0)),t}startRemoteStreamForNewAssociate(e){console.log("startRemoteStreamForNewAssociate: streamId="+e);let t=this._avStreams.values().next().value.stream.getStreamOptions(),i=live.StreamInfo.createStreamOptions(t.audioConfig,t.videoConfig);const o=new live.StreamProfile(!0,!1,this._impl.service.userID,new live.PauseResume(live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,null));let s=this._impl._conversation.createAudioVideoStream(i,e||null,o);this._avStreams.add({id:s.getId(),stream:s}),this._initCallbacks(s),s.start(),console.log("Finished starting remote Stream For New Associate: streamId="+e),this._impl._screen.showConversationStreams()}switchToAvStreamForNewAssociate(e){console.log("Switching av streams for new associate");let t,i=null;for(t of this._avStreams)t.id===e&&(i=t);t.id===i.id&&(t=null),console.log("avStreamTo is "+(t?"valid":"null")),console.log("Switchover: Replacing tracks...");let o=this._impl._conversation.getParticipant(this._impl._transferringAssociateUri);if(t&&i&&t.stream&&i.stream)if(console.log("Switchover: We have a new av stream to new associate (NOT using same stream id"),console.log("Switchover: Switching to new av1 stream, but don't end the stream."),console.log("Switchover: Switching to new av1 stream"),this._isSwitchingToNewAssocStream=!0,i.stream.end(),this._avStreams.delete(i.stream),console.log("Removing participant (first associate): "+this._impl._transferringAssociateUri),o){let e=o.getStreamInfos();e&&e.length>0&&(console.log("Removing steams for participant: "+this._impl._transferringAssociateUri),e[0].remove()),console.log("Removing participant: "+this._impl._transferringAssociateUri),o.remove()}else console.warn("Could not find first associate: "+this._impl._transferringAssociateUri);else console.log("Switchover: We do not have a new av stream to new associate (Using SAME stream id"),this._isSwitchingToNewAssocStream=!0,console.log("Removing participant (first associate): "+this._impl._transferringAssociateUri),o?(console.log("Removing participant: "+this._impl._transferringAssociateUri),o.remove()):console.warn("Could not find first associate: "+this._impl._transferringAssociateUri);this._impl._screen.showConversationStreams()}saveAvStreamForNewAssociate(e){console.log("saveAvStreamForNewAssociate");let t,i=null;for(t of this._avStreams)t.id===e&&(i=t);t&&i&&t.id===i.id&&(t=null),i&&t&&i.stream&&t.stream?console.log("saveAvStreamForNewAssociate: We have a new av stream to new associate (not using same stream id"):console.log("saveAvStreamForNewAssociate: Do not have a new av stream to new associate"),this._impl._screen.showConversationStreams()}removeRemoteById(e){console.log("Removing reference to avstream: "+e);for(let t of this._avStreams)if(t.id===e){this._avStreams.delete(t);break}}stopRemoteById(t){console.log("LiveAudioVideo: stopRemote Stop the remote stream by streamid",t),this._avStreams.forEach(i=>{if(i.stream&&i.id===t){let o=document.getElementById("oracle-live-remote-video-"+i.id);o?(console.log("LiveAudioVideo: Element found for stopped stream, removing"),console.log("LiveAudioVideo:stopRemoteById:Removed video element: "+o.id),o.parentNode.remove(),0===this._impl._buttonState.menu.countRemoteVideos()?(console.log("LiveAudioVideo:stopRemoteById:No more video elements"),this._impl.dispatchEvent(e.LiveRemoteVideoStopped,t)):this._impl.dispatchEvent(e.LiveRemoteVideoRemoved,t),this._avStreams.delete(i)):console.log("LiveAudioVideo: Element not found for stopped stream, perhaps audio conference: "+this._impl._behaviours.isAudioOnly())}})}stopRemote(t){console.log("LiveAudioVideo: stopRemote Stop the remote stream",t),this._avStreams.forEach(i=>{if(i.stream&&i.id===t.getId()){let t=document.getElementById("oracle-live-remote-video-"+i.id);t?(console.log("LiveAudioVideo:stopRemote:Removed video element: "+t.id),t.parentNode.remove(),0===this._impl._buttonState.menu.countRemoteVideos()?(console.log("LiveAudioVideo:stopRemote:No more video elements"),this._impl.dispatchEvent(e.LiveRemoteVideoStopped,i.id)):this._impl.dispatchEvent(e.LiveRemoteVideoRemoved,i.id),this._avStreams.delete(i)):console.log("LiveAudioVideo: Element not found for stopped stream, perhaps audio conference: "+this._impl._behaviours.isAudioOnly())}})}pauseResumeSingleStream(e,t){console.log("pauseResumeSingleStream: "+(e?e.id:"(no stream")),this._userPauseStreamState=t;let i=null;e.stream?(console.log("pauseResumeSingleStream: avstream.stream"),e.stream.pauseResumeStream(t,()=>{console.log("LiveAudioVideo: pauseResumeSingleStream - successful: "+e.id),i=e.stream.isVideoPaused(),console.log("avstream.stream.isVideoPaused: "+i),this._isVideoActuallyPaused.get(e.id)&&(i=!0,console.log("Video is actually paused (from _isVideoActuallyPaused)")),console.log("Setting pauseState to: "+i),this._userIsCurrentlyPaused.set(e.id,i)},t=>{console.log("LiveAudioVideo: pauseResumeSingleStream - failed: "+e.id,t)})):console.log("pauseResumeSingleStream: Did not find avstream.stream"),!1===i&&this._myVideoStillFrozen&&(console.log("Unfreezing previously frozen video"),this._myVideoStillFrozen=!1,this.freezeEndUserVideo(!1))}pauseResumeStream(e){this._impl.isUsingExternalAudio()&&(e.audio=live.PAUSERESUME.PAUSE),this._userIsCurrentlyPaused.clear(),this._avStreams.forEach(t=>{this.pauseResumeSingleStream(t,e)}),this.updateAudioForEchoCancellation(e),this.updateVideoForBrokenWsc(e),this.disableAudioForScreenshareStream()}makeAudioVideoStreamsLive(t,i,o){console.log("LiveAudioVideo: makeAudioVideoStreamsLive avStream, event, stream",t,i,o);let s,n,a,r,l=!1,c=null;o instanceof RTCRtpReceiver||o instanceof RTCRtpSender?o.track&&"video"===o.track.kind&&(l=!0,c=o.track.getSettings().deviceId):(l=o.getVideoTracks().length>0,o.getVideoTracks()&&o.getVideoTracks()[0]&&(c=o.getVideoTracks()[0].getSettings().deviceId)),console.log("LiveAudioVideo: makeAudioVideoStreamsLive - deviceId: ",c),console.log("LiveAudioVideo: makeAudioVideoStreamsLive - stream has video="+l);let d=$(".oracle-live-local-video");switch(i){case live.MEDIASTREAMEVENT.LOCAL_STREAM_ADDED:if(l){this._cameras&&0===this._cameras.length&&navigator.mediaDevices.enumerateDevices().then(this._getCameraDeviceIds.bind(this)),r=document.querySelector(".oracle-live-local-video"),console.log("LiveAudioVideo: Have local video: ",r);let i=!1;this._userIsCurrentlyPaused.forEach(e=>{i=i||e});const s=this._userVideoInitiallyPaused||i;console.log("LiveAudioVideo: User video is fully paused="+s,this._userIsCurrentlyPaused),r&&(console.log("LiveAudioVideo: Setting local video stream",o),this._localVideoStream.set(t.getId(),o),this.attachToMedia(o,r,s)),s||(d.show(),this._impl.dispatchEvent(e.LiveLocalVideoStarted)),console.log("LiveAudioVideo: currentCameraId: ",this._currentCameraId),console.log("LiveAudioVideo: deviceId: ",c),this._currentCameraId&&c?c!==this._currentCameraId&&(this._currentCameraId=c,this.swapCamera()):this._cameras.find(e=>e.deviceId===c)&&(this._currentCameraId=c)}else a=document.querySelector(".oracle-live-local-audio"),console.log("LiveAudioVideo: attach local audio:",a),console.log("LiveAudioVideo: attach local audio: External audio:",this._impl.isUsingExternalAudio()),a&&!this._impl.isUsingExternalAudio()&&(console.log("LiveAudioVideo: Setting local audio stream",o),this._localAudioStream=o,a.srcObject=o,this.playMedia(a));break;case live.MEDIASTREAMEVENT.LOCAL_STREAM_REMOVED:if(console.log("local_stream_removed received in transferState: "+this._impl._buttonState.transferState),"None"!==this._impl._buttonState.transferState&&this._isSwitchingToNewAssocStream&&(console.log("Transfer: Not stopping local streams because it's being transfers to annother associate"),this._isSwitchingToNewAssocStream=!1,!this._localVideoStream.has(t.getId())))break;if(r=document.querySelector(".oracle-live-local-video"),this._localVideoStream.has(t.getId())&&(this._localVideoStream.delete(t.getId()),this._impl.stopStream(o)),0===this._localVideoStream.size)console.log("LiveAudioVideo: Processing LOCAL_STREAM_REMOVED event"),(a=document.querySelector(".oracle-live-local-audio"))&&(a.srcObject=null),this._impl.stopStream(this._localAudioStream),this._localAudioStream=null,r&&(r.srcObject=null),d.hide(),this._impl.dispatchEvent(e.LiveLocalVideoStopped);else if(console.log("Check if there is still a local video stream ready to attach"),console.table(this._localVideoStream),this._localVideoStream.size){console.table(this._localVideoStream);let e=this._localVideoStream.values().next().value,t=this._localVideoStream.keys().next().value;this.attachToMedia(e,r,this._userVideoInitiallyPaused||this._userIsCurrentlyPaused.get(t))}break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_ADDED:if(l){if(!(n=document.getElementById("oracle-live-remote-video-"+t.getId()))){let e=t.getConversation().getParticipants().find(e=>e.streams.containsKey(t.getId())&&e.streams.get(t.getId()).uri!==t.getConversation().getLocalParticipantUri()).getUri();this._impl._buttonState.addRemoteVideo(t.getId(),e,!1),n=document.getElementById("oracle-live-remote-video-"+t.getId())}if(n){let i=this._associateVideoInitiallyPaused;const s=this._impl._conversation.getRemoteParticipant();if(s){const e=s.getStreamInfos()[0].getStreamOptions(),t=s.getStreamInfos()[0].getStreamProfile();e&&(console.log("LiveAudioVideo: Remote stream options: video="+e.videoConfig),i=i||e.videoConfig===live.MEDIADIRECTION.RECVONLY||e.videoConfig===live.MEDIADIRECTION.INACTIVE),t&&(console.log("LiveAudioVideo: Remote stream profile: "+JSON.stringify(t,null,2)),i=i||!t.upgraded||t.pauseResume.video===live.PAUSERESUME.PAUSE&&t.pauseResume.reason===live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE)}console.log("LiveAudioVideo: Remote video is paused="+i),this.attachToMedia(o,n,i);for(let e of this._avStreams)e.id===t.getId()&&(e.active=i);i||this._impl.dispatchEvent(e.LiveRemoteVideoStarted,t.getId())}}else s=document.querySelector("#oracle-live-remote-audio"),console.log("LiveAudioVideo: attach remote audio:",s),console.log("LiveAudioVideo: attach remote audio: External audio:",this._impl.isUsingExternalAudio()),s&&!this._impl.isUsingExternalAudio()&&(s.srcObject=o,this.playMedia(s));break;case live.MEDIASTREAMEVENT.REMOTE_STREAM_REMOVED:console.log("LiveAudioVideo: REMOTE_STREAM_REMOVED: haveVideo: ",l),l?((n=document.getElementById("oracle-live-remote-video-"+t.getId()))&&(console.log("LiveAudioVideo:REMOTE_STREAM_REMOVED:Removed video element: "+n.id),n.parentNode.remove()),0===this._impl._buttonState.menu.countRemoteVideos()?(console.log("LiveAudioVideo:REMOTE_STREAM_REMOVED:No more video elements"),this._impl.dispatchEvent(e.LiveRemoteVideoStopped,t.getId())):this._impl.dispatchEvent(e.LiveRemoteVideoRemoved,t.getId())):(s=document.querySelector(".oracle-live-remote-audio"))&&(s.srcObject=null)}}attachToMedia(e,t,i,o){if(e&&t){console.log("LiveAudioVideo: attachToMedia: stream=",e,", media=",t),e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?(e.track&&"video"===e.track.kind&&(e.track.enabled=!1),e.track&&"audio"===e.track.kind&&(e.track.enabled=!1)):(e.getVideoTracks().forEach(e=>{e.enabled=!1}),e.getAudioTracks().forEach(e=>{e.enabled=!1}));const s=()=>{console.log("LiveAudioVideo: Loaded metadata",e),t.removeEventListener("loadedmetadata",s);let n=!i||"Safari"===this._impl._browserName;e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?(e.track&&"video"===e.track.kind&&(console.log("LiveAudioVideo: Loaded metadata: downgradedVideo="+i),e.track.enabled=n,console.log("LiveAudioVideo: video track enabled = "+e.track.enabled),o&&(e.track.onended=o)),e.track&&"audio"===e.track.kind&&(e.track.enabled=!0)):(e.getVideoTracks().forEach(e=>{console.log("LiveAudioVideo: Loaded metadata: downgradedVideo="+i),e.enabled=n,console.log("LiveAudioVideo: video track enabled = "+e.enabled),o&&(e.onended=o)}),e.getAudioTracks().forEach(e=>{e.enabled=!0}))};"Safari"===this._impl._browserName?s():t.addEventListener("loadedmetadata",s,{once:!0}),t.srcObject=e,this.playMedia(t)}}playMedia(e){e&&"function"==typeof e.play&&(console.log("Start playing media"),this._isEdge()?e.play():e.play().then(()=>{console.log("Started playing media")}).catch(e=>{console.log("Failed to start playing media",e)}))}detectWhenStreamHasChangedState(e,t){console.log("LiveAudioVideo: detectWhenStreamHasChangedState - streamState=",JSON.stringify(t,null,2),e,this._avStreams);const i=t.state,o=t.status,s=o.code+0,n=o.reason;switch(this._impl._connection.logEventTimestamp("avStreamStateTo"+i),i){case live.STREAMSTATE.ESTABLISHED:e&&e.streamId&&this._impl._rememberMyStreams(e.streamId),this._impl.onCallEstablished();break;case live.STREAMSTATE.ERROR:console.log("LiveAudioVideo: detectWhenStreamHasChangedState - ERROR: code="+s+", reason="+n),s!==live.ERRORCODE.ICE_CONNECTION_ERROR||this._sidebar||(console.log("LiveAudioVideo: ICE connection error"),this._impl.onCallStreamStateError()),this._sidebar&&(this._sidebar=!1);break;case live.STREAMSTATE.FAILED:case live.STREAMSTATE.ENDED:{"None"!==this._impl._buttonState.transferState?(console.log("TRANSFER: live.STREAMSTATE.ENDED: Stream Ended. reason="+n),console.log("TRANSFER: transferring agent still connected="+this._impl._transferringAssociateStillConnected),this._impl._transferringAssociateStillConnected||(console.log("Transferring agent no longer connected, so setting transfer state to None"),this._impl._buttonState.transferState="None"),this.stopRemoteById(e.streamId)):console.log("live.STREAMSTATE.ENDED: Stream Ended. reason="+n),console.log("     Call State = "+this._impl._buttonState.stateName),console.log("  transferState = "+this._impl._buttonState.transferState);const t=this._impl._conversation.getParticipants(),i=t.length;console.log("Number of participants in conversation = "+i);let o=!1,s=null;console.log("Original participant: "+this._impl._transferringAssociateUri);for(let e=0;e<i;e++)console.log("Remaining participant: "+t[e].uri),t[e].uri===this._impl._transferringAssociateUri&&(console.log("Found original associate (^ uri shown above)"),o=!0,s=t[e]);if(console.log("Found original assoc: "+o),"None"!==this._impl._buttonState.transferState){console.log("TRANSFER: Transfer State="+this._impl._buttonState.transferState);let t=this._impl._conversation.getStreams();console.log("TRANSFER: avStream id="+e.streamId),1===t.length&&t[0].getId()===e.streamId&&1===this._avStreams.size&&this._avStreams.values().next().value.id===e.streamId&&(console.log("The stream that has ended is our only active stream"),console.log("LiveAudioVideo: Ending AV1 stream"),this._impl.onCallEnded(),this._avStreams=new Set,this.reset())}else 1===this._avStreams.size&&this._avStreams.values().next().value.id===e.streamId&&(console.log("LiveAudioVideo: Ending AV1 stream"),this._impl.onCallEnded(),this._avStreams=new Set,this.reset());console.log("liveAudioVideo: Ensuring stream removed from active set"),this.removeRemoteById(e.streamId)}}}detectWhenAudioVideoIsUpdated(e,t){console.log("LiveAudioVideo: detectWhenAudioVideoIsUpdated",t,e),e.getId();let i=!1;for(let o of this._avStreams)if(o.id===e.getId()){i=!0,this._localStreamOptions=t,o.accept(t);break}}detectWhenStreamHasFailed(t,i){console.log("LiveAudioVideo: detectWhenStreamHasFailed, error: ",JSON.stringify(i,null,2),t);const o=t.getId();for(let t of this._avStreams)t.id===o&&this._impl.dispatchEvent(e.LiveStreamError)}detectStreamPauseResumeRequest(t,i,o,s){let n=s.reason,a=n===live.PAUSERESUMEREASON.PAUSE_RESUME,r=s.audio===live.PAUSERESUME.PAUSE&&s.video===live.PAUSERESUME.PAUSE,l=s.audio===live.PAUSERESUME.RESUME&&s.video===live.PAUSERESUME.RESUME,c=s.audio===live.PAUSERESUME.RESUME&&s.video===live.PAUSERESUME.PAUSE,d=i.getType();console.log("LiveAudioVideo: detectStreamPauseResumeRequest - reason="+n+", isPause="+r+", isUpgrade="+l+", isDowngrade="+c,s),this._impl.isUsingExternalAudio()&&(s.audio=live.PAUSERESUME.PAUSE),a?(o.accept(),$(".oracle-live").hasClass("oracle-live-frozen-annotation")?(this._isVideoActuallyPaused.set(i.getId(),s.video===live.PAUSERESUME.PAUSE),s.video=live.PAUSERESUME.RESUME):this._isVideoActuallyPaused.delete(i.getId()),this._impl._screen.pauseResumeOutgoing(r),r?this._impl.dispatchEvent(e.LivePausedRemotely):this._impl.dispatchEvent(e.LiveResumedRemotely)):c?(o.accept(),d===live.STREAMTYPE.AUDIOVIDEO&&(this._impl.dispatchEvent(e.LiveLocalVideoStopped),console.log("LiveAudioVideo: pausing removed video"),this.pauseResumeStream(s),this.updateAudioForEchoCancellation(s))):l&&(this._upgradePauseResume=s,this._impl._upgradeRequest=o,this._impl._upgradeRequestStreamType=d,this._impl._upgradeRequestForUser="user",d===live.STREAMTYPE.AUDIOVIDEO&&this._impl.dispatchEvent(e.LiveStartVideoRequested))}startVideo(t=!1){if(console.log("LiveAudioVideo: startVideo",this._upgradePauseResume),this._cameraApplyToLiveStream=!0,t)return void console.log("starting in idle state");this._previewStream&&null!==this._cameraAction&&(this.selectCameraStream(this._cameraAction,this._previewStream),this.playLocalCameraVideo(this._previewStream),this._previewStream=null,this._cameraAction=null),this._impl._behaviours.endUserInitialMedia===this._impl._behaviours.StartMediaType.AUDIO_ONLY&&(this._cameras&&(this._cameras.find(e=>e.deviceId&&e.deviceId===this._currentCameraId)||(console.log("LiveAudioVideo: startVideoPreview: Did not find current camera, so now selecting one..."),this.selectFrontCamera())),this._localVideoStream.forEach((e,t)=>{if(e instanceof RTCRtpReceiver||e instanceof RTCRtpSender)e.track&&"video"===e.track.kind&&(console.log("LiveAudioVideo: Enable video tracks: length=1",e.track),e.track.enabled=!0);else{const t=e.getVideoTracks();console.log("LiveAudioVideo: Enable video tracks: length="+t.length,t),t.forEach(e=>{e.enabled=!0})}})),null===this._upgradePauseResume&&(console.log("relaying to destination: *"),this._impl._conversation.relayCommandTo(null,"*","video_upgrade",[{}]));let i=this._upgradePauseResume;i||this._avStreams.forEach(e=>{if(e.stream){const t=live.StreamProfile.create(e.stream.getStreamInfo().getStreamProfile());t.upgraded=!0,t.paused_by=this._impl.service.userID,t.pauseResume.pausedBy=this._impl.service.userID,t.pauseResume.video=live.PAUSERESUME.RESUME,t.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,i=t.pauseResume}}),this._impl.isUsingExternalAudio()&&(i.audio=live.PAUSERESUME.PAUSE),console.log("LiveAudioVideo: startVideo: pauseResume="+JSON.stringify(i,null,2)),this._avStreams.forEach(t=>{t.stream&&(console.log("Pause/resume avstreams"),t.stream.pauseResumeStream(i,()=>{console.log("LiveAudioVideo: Started local video "+t.id),this._impl.dispatchEvent(e.LiveLocalVideoStarted),this._userVideoInitiallyPaused=!1}))}),this._upgradePauseResume=null,this.updateAudioForEchoCancellation(i)}stopVideo(){let t=null;console.log("LiveAudioVideo: stopVideo"),this._avStreams.forEach(i=>{const o=i.stream.getStreamInfo().getStreamProfile();o.upgraded=!1,o.paused_by=this._impl.service.userID,o.pauseResume.pausedBy=this._impl.service.userID,o.pauseResume.video=live.PAUSERESUME.PAUSE,t=o.pauseResume,o.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,this._impl.isUsingExternalAudio()&&(o.pauseResume.audio=live.PAUSERESUME.PAUSE),i.stream&&i.stream.pauseResumeStream(o.pauseResume,()=>{console.log("liveAudioVideo: Stopped local video "+i.id),this._impl.dispatchEvent(e.LiveLocalVideoStopped),this._userVideoInitiallyPaused=!0})}),this.updateAudioForEchoCancellation(t)}startVideoPreview(t){this._showSwapCameraButton();let i=this._userVideoInitiallyPaused;for(let e of this._avStreams)i=i||e.stream.isVideoPaused();console.log("LiveAudioVideo: startVideoPreview: videoIsPaused="+i),this._impl.acceptUpgradeRequest(),$(".oracle-live-local-video").show();let o=!1;if(this._impl._behaviours.endUserInitialMedia===this._impl._behaviours.StartMediaType.AUDIO_ONLY&&(o=!0),this._haveAskedUserPermissionForSharingVideo&&i&&this._localVideoStream.size>0){console.log("LiveAudioVideo: startVideoPreview: preview in Connected state"),this._cameras&&0===this._cameras.length&&navigator.mediaDevices.enumerateDevices().then(this._getCameraDeviceIds.bind(this));let e=!0;if(this._cameras){let i=this._cameras.find(e=>e.deviceId&&e.deviceId===this._currentCameraId);i?(e=i.isFront,!0===t&&e&&this.swapCamera()):(console.log("LiveAudioVideo: startVideoPreview: Did not find current camera, so now selecting one..."),this.selectFrontCamera())}this._localVideoStream.forEach((e,t)=>{if(e instanceof RTCRtpReceiver||e instanceof RTCRtpSender)e.track&&"video"===e.track.kind&&(console.log("LiveAudioVideo: Enable video tracks: length=1",e.track),e.track.enabled=!0);else{const t=e.getVideoTracks();console.log("LiveAudioVideo: Enable video tracks: length="+t.length,t),t.forEach(e=>{e.enabled=!0})}}),o&&!this._haveAskedUserPermissionForSharingVideo||this._impl._buttonState._state.video_preview_start()}else{let t=!this._impl.isMeetingPSTNUpgrade();console.log("LiveAudioVideo: startVideoPreview: preview in Idle state: audioConstraint="+t);const i={audio:t,video:{facingMode:"user"}};this._currentCameraId&&(i.video.deviceId={exact:this._currentCameraId}),console.log("this._currentCameraId = "+this._currentCameraId);const o=e=>{if(console.log("LiveAudioVideo: Got preview stream for constraints:",i),this._cameras&&0===this._cameras.length&&navigator.mediaDevices.enumerateDevices().then(this._getCameraDeviceIds.bind(this)),console.log("LiveAudioVideo: this._cameras: ",this._cameras),e instanceof RTCRtpReceiver||e instanceof RTCRtpSender)e.track&&"video"===e.track.kind&&(this._currentCameraId=e.track.getSettings().deviceId,console.log("LiveAudioVideo: Using RTCRtp video device: "+e.track.label));else{const t=e.getVideoTracks();this._currentCameraId=t[0].getSettings().deviceId,console.log("LiveAudioVideo: Using video device: "+t[0].label)}e.oninactive=(()=>{console.log("LiveAudioVideo: Preview stream inactive")}),this._previewStream=e,console.log(`startVideoPreview: Searching local video stream: Length = ${this._localVideoStream.size}`),this._localVideoStream.forEach((t,i)=>{console.log(`Updating localVideoStream: avid=${i}`),this._localVideoStream.set(i,e)}),this._cameraAction="selectCamera",this._cameraApplyToLiveStream=!1;const t=document.getElementById("oracle-live-local-video");t?(t.srcObject=e,this.playMedia(t)):(console.warn("LiveAudioVideo: Failed to attach preview stream"),this._impl.stopStream(this._previewStream))},s=t=>{console.warn("LiveAudioVideo: Failed to get preview stream",t),this._impl.dispatchEvent(e.LiveLocalVideoStopped)};console.log("Invoking getUserMedia[3]: constraints=",i),navigator.mediaDevices.getUserMedia(i).then(o.bind(this)).catch(s.bind(this))}}stopVideoPreview(){this._impl.stopStream(this._previewStream),this._previewStream=null,this._cameraAction=null,this._cameraApplyToLiveStream=!0;for(let e of this._avStreams)e.stream&&e.stream.isVideoPaused()||!this._localVideoStream.has(e.id)||(this._impl.stopStream(this._localVideoStream.get(e.id)),this._localVideoStream.delete(e.id))}replaceStreamVideoTrack(e,t){if(console.log("LiveAudioVideo::replaceStreamVideoTrack"),e&&t){const i=e.getVideoTracks();e.removeTrack(i[0]),e.addTrack(t)}else console.log("LiveAudioVideo::replaceStreamVideoTrack  unable to replace track")}muteLocalAudio(e){console.log("muteLocalAudio in LiveAudioVideo: mute: "+e);let t=null;return this._avStreams.forEach(i=>{if(i.stream){const o=i.stream.call;if(o&&"ENDED"!==o.callState.state){let i=o.mute(e);t=!!i&&(null===t||t)}else console.warn("Avstream: "+i.id+" not valid for mute")}}),t?this.updateAudioForEchoCancellation(e):console.warn("Unsuccessful: Did not apply echo cancellation for mute: "+e),!!t}swapCamera(e){if(console.log("LiveAudioVideo::swapCamera: reset="+e),console.log("this._currentCameraId="+this._currentCameraId),!this._hasTwoCameras&&!this._isShowingDummyVideoTrack)return void console.log("LiveAudioVideo::swapCamera - no point to a camera swap so returning");e&&(this._currentCameraId=null),this._activeLocalVideoTrack.clear(),this._avStreams.forEach(e=>{if(e.stream){const t=e.stream.call;if(t){let e=t.getPeerConnection().getSenders().find(e=>e.track&&"video"===e.track.kind);e&&(console.log("LiveAudioVideo::swapCamera - stopping sender video track"),e.track.stop())}}});const t=e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=!1,e.track.stop()):e.getVideoTracks().forEach(e=>{e.enabled=!1,e.stop()})},i=this._getDifferentCameraId(this._currentCameraId);console.log("LiveAudioVideo::swapCamera  newDeviceId: ",i),document.getElementById("oracle-live-local-video"),this._localVideoStream.forEach((e,i)=>{console.log("LiveAudioVideo::swapCamera stopping avid: {}, local stream: {}",i,e),t(e)}),this._previewStream&&(console.log("LiveAudioVideo::swapCamera  stopping preview video tracks"),t(this._previewStream)),this._getCameraStreamWithDeviceId(i,e=>{console.log("LiveAudioVideo::swapCamera: gotStream()"),this._localVideoStream.forEach((t,i)=>{this._localVideoStream.set(i,e)});const t=e.getVideoTracks();this._currentCameraId=t[0].getSettings().deviceId,console.log("this._currentCameraId="+this._currentCameraId),this._cameraAction="swapCamera",this._previewStream=e,this._cameraApplyToLiveStream&&this.selectCameraStream(this._cameraAction,e),this.playLocalCameraVideo(e)},e=>{console.log("LiveAudioVideo::swapCamera: error trying to obtain camera stream: ",e)})}selectFrontCamera(){console.log("LiveAudioVideo::selectFrontCamera"),this._activeLocalVideoTrack.clear(),this._avStreams.forEach(e=>{if(e.stream){const t=e.stream.call;if(t){let e=t.getPeerConnection().getSenders().find(e=>e.track&&"video"===e.track.kind);e&&(console.log("LiveAudioVideo::selectFrontCamera - stopping sender video track"),e.track.stop())}}});const e=e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=!1,e.track.stop()):e.getVideoTracks().forEach(e=>{e.enabled=!1,e.stop()})};let t=this._cameras.find(e=>e.isFront);t||(console.log("LiveAudioVideo::selectFrontCamera - Didn't find front camera, using first device as front"),t=this._cameras[0]),this._currentCameraId=t.deviceId;const i=this._currentCameraId;console.log("LiveAudioVideo::selectFrontCamera deviceId: ",i),document.getElementById("oracle-live-local-video"),this._localVideoStream.forEach((t,i)=>{console.log("LiveAudioVideo::selectFrontCamera  stopping _localVideoStream's: "+i),e(t)}),this._previewStream&&(console.log("LiveAudioVideo::selectFrontCamera  stopping preview video tracks"),e(this._previewStream)),this._getCameraStreamWithDeviceId(i,e=>{console.log("LiveAudioVideo::selectFrontCamera: gotStream()"),this._localVideoStream.forEach((t,i)=>{this._localVideoStream.set(i,e)});const t=e.getVideoTracks();this._currentCameraId=t[0].getSettings().deviceId,this._previewStream=e,this._cameraAction="selectCamera",this._cameraApplyToLiveStream&&this.selectCameraStream(this._cameraAction,e),this.playLocalCameraVideo(e)},e=>{console.log("LiveAudioVideo::swapCamera: error trying to obtain camera stream: ",e)})}playLocalCameraVideo(e){const t=document.getElementById("oracle-live-local-video");t?(t.srcObject=e,this.playMedia(t)):(console.warn("LiveAudioVideo: Failed to attach stream to html video tag"),this._impl.stopStream(this._previewStream))}selectCameraStream(e,t){const i=t.getVideoTracks();this._currentCameraId=i[0].getSettings().deviceId,console.log("this._currentCameraId="+this._currentCameraId);const o=document.getElementById("oracle-live-local-video");$(".oracle-live").hasClass("oracle-live-video-preview")&&(console.log("LiveAudioVideo::selectCameraStream:  replacing preview video track"),o?(this._previewStream&&this.replaceStreamVideoTrack(this._previewStream,i[0]),this._localVideoStream.forEach((e,t)=>{console.log("LiveAudioVideo:selectCameraStream: video replace local video track: "+t),this.replaceStreamVideoTrack(e,i[0])})):console.warn("LiveAudioVideo::selectCameraStream Failed to replace preview stream")),this._avStreams.forEach(e=>{if(e.stream){console.log("LiveAudioVideo::selectCameraStream: stream: ",e.stream),console.log("LiveAudioVideo::selectCameraStream: cameraVideoTracks",i);const t=e.stream.call.getPeerConnection();t&&t.getSenders().forEach(e=>{if(e instanceof RTCRtpSender&&e.track){const t=e.track.kind;"video"===t?(console.log("LiveAudioVideo::selectCameraStream: pcSenders replacing track with camera"),e.replaceTrack(i[0])):console.log("LiveAudioVideo::selectCameraStream: kind '"+t+"' is not video.")}else console.log("LiveAudioVideo::selectCameraStream: is RTCRtpSender="+(e instanceof RTCRtpSender)),console.log("LiveAudioVideo::selectCameraStream: sender.track="+e.track)})}}),$(".oracle-live").hasClass("oracle-live-video-preview")||("selectCamera"===e&&o&&this._localVideoStream.size&&(console.log("LiveAudioVideo::selectCameraStream(selectCamera): using first local stream"),this.replaceStreamVideoTrack(this._localVideoStream.values().next().value,i[0])),"swapCamera"===e&&o&&this._localVideoStream.forEach((e,t)=>{console.log("LiveAudioVideo::selectCameraStream(swapCamera): video element swap tracks for: "+t),this.replaceStreamVideoTrack(e,i[0])}))}isRemoteVideoActive(e){let t=!1;for(let i of this._avStreams)if(i.id===e&&i.stream){t=this._impl._buttonState.menu.isRemoteStreaming(i.id)&&i.active,console.log("isRemoteVideoActive:streamid: "+i.id+" is "+t);break}return t}enableRemoteVideo(t){let i=!1;for(let e of this._avStreams)if(e.id===t&&e.stream){e.active=!0,e.stream.getRemoteStreams().forEach(e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=!0):e.getVideoTracks().forEach(e=>{e.enabled=!0})}),i=!0;break}i?(console.log("LiveAudioVideo:enableRemoteVideo Upgraded remote stream: "+t),this._impl.dispatchEvent(e.LiveRemoteVideoStarted,t),this._associateVideoInitiallyPaused=!1):console.log("LiveAudioVideo:enableRemoteVideo Stream to upgrade not found: "+t)}disableRemoteVideo(t){let i=!1,o="Safari"===this._impl._browserName;for(let e of this._avStreams)if(e.id===t&&e.stream){e.active=!1,e.stream.getRemoteStreams().forEach(e=>{e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?e.track&&"video"===e.track.kind&&(e.track.enabled=o):e.getVideoTracks().forEach(e=>{e.enabled=o})}),i=!0;break}i?(console.log("LiveAudioVideo:disableRemoteVideo Downgraded remote stream (except for Safari) "+t),o||(0===this._impl._buttonState.menu.countRemoteVideos()?(console.log("LiveAudioVideo:stopRemote:No more video elements"),this._impl.dispatchEvent(e.LiveRemoteVideoStopped,t)):this._impl.dispatchEvent(e.LiveRemoteVideoRemoved,t))):console.log("LiveAudioVideo:disableRemoteVideo remote stream not found "+t)}incomingAV(e,t){console.log("incomingAV");let i=null,o=e.getStreamOptions();console.log("LiveAudioVideo: incomingAV: Incoming AV1 stream",e),this._avStreams.add({id:e.getId(),stream:e}),this._originalStreamOptions=live.StreamInfo.createStreamOptions(o.audioConfig,o.videoConfig),i=this._originalStreamOptions,console.log("LiveAudioVideo: incomingAV: Old streamOptions="+JSON.stringify(i,null,2)+", New local streamOptions="+JSON.stringify(o,null,2)+", New remote streamOptions="+JSON.stringify(t,null,2));const s=this._impl._conversation.getParticipants().find(e=>e.getUri()!==this._impl._conversation.getLocalParticipantUri());let n=!1;s&&(console.log("LiveAudioVideo: Checking if remote participant only has screen-share active"),n=s.getStreamInfos().every(e=>e.getType()===live.STREAMTYPE.SCREENSHARE)),console.log("LiveAudioVideo: incomingAV: remoteScreenShareOnly="+n),this._impl._screen._restartSendingScreenShare||n?(console.log("LiveAudioVideo: remoteScreenShareActive is "+this._impl._screen._remoteScreenShareActive),o=live.StreamInfo.createStreamOptions(i.audioConfig,live.MEDIADIRECTION.RECVONLY),console.log("LiveAudioVideo: incomingAV: Have active local screen share - Overriding stream options to: "+JSON.stringify(o,null,2))):console.log("LiveAudioVideo: incomingAV: New stream options are: "+JSON.stringify(o,null,2)),this._initCallbacks(e),e.accept(o),this._localStreamOptions=o;const a=this._impl._conversation.getLocalParticipant();if(a){const t=a.getStreamInfo(e.getId());if(t){console.log("LiveAudioVideo: incomingAV: Local stream options:",t.streamOptions);const e=t.getStreamProfile();console.log("LiveAudioVideo: incomingAV: Local stream profile:",e);const i=this._impl._behaviours;if(i){let t=!1;i.associateInitialMedia&&(t=i.associateInitialMedia===i.StartMediaType.AUDIO_VIDEO||i.associateInitialMedia===i.StartMediaType.VIDEO_ONLY);const o=i.associateCanAddVideo;console.log("LiveAudioVideo: incomingAV: startWithVideo:"+t+", canAdd:"+o),!t&&o&&(e.upgraded=!1,this._userVideoInitiallyPaused=!0,console.log("LiveAudioVideo: incomingAV: Overriding local profile to have downgraded video"))}}}if(s){const t=s.getStreamInfo(e.getId());if(t){const e=t.streamOptions;console.log("LiveAudioVideo: incomingAV: Remote stream options:",e);const i=t.getStreamProfile();if(console.log("LiveAudioVideo: incomingAV: Remote stream profile:",i),e){const t=e.videoConfig===live.MEDIADIRECTION.SENDRECV||e.videoConfig===live.MEDIADIRECTION.SENDONLY;console.log("LiveAudioVideo: incomingAV: Setting Remote upgraded on incomingAV to "+t),this._associateVideoInitiallyPaused=!t}}}}statsCollectorStop(){this._avStreams.forEach(e=>{e.stream&&(e.stream.onQualityMetrics=null,console.log("TRANSFER: stopping stats collector"),e.stream.call.statsStop())})}statsCollectorStart(){if(!this._avStreams.size)return this._impl._screen.showConversationStreams(),void console.log("TRANSFER: failed to start stats collector because no valid av streams");this._avStreams.forEach(e=>{e.stream&&null===e.stream.onQualityMetrics&&this._qualityMetricsCallback&&(e.stream.onQualityMetrics=this._qualityMetricsCallback,console.log("TRANSFER: starting stats collector"),e.stream.call.statsStart())})}cancelTransferSwitchoverStream(){if("None"!==this._impl._buttonState.transferState){if(console.log("TRANSFER: cancelTransferSwitchoverStream"),this._avStreams.size){const e=this._avStreams.values().next().value.stream;e&&null===e.onQualityMetrics&&this._qualityMetricsCallback&&(e.onQualityMetrics=this._qualityMetricsCallback,e.call.statsStart())}else console.log("TRANSFER: QualityMetrics not set; Did not restart statsCollector.");this._impl._buttonState.transferState="None"}}replaceSenderVideoTrack(e,t){if(e){const i=e.getPeerConnection();if(i){const e=i.getSenders();console.log("*** pcSenders: ",e),e.forEach(e=>{e instanceof RTCRtpSender&&e.track&&"video"===e.track.kind&&e.replaceTrack(t)})}}}showSenderTracksForCallTransfer(){}replaceLocalStreamVideoTrack(e,t){if(console.log("replaceLocalStreamVideoTrack: track: {} ",t),e&&t){const i=e.getVideoTracks();return e.removeTrack(i[0]),e.addTrack(t),i[0]}return null}freezeEndUserVideo(e){if($(".oracle-live").hasClass("oracle-live-paused-enduser")&&!e)return console.log("LiveAudioVideo:freezeEndUserVideo not unfreezing because call is locally paused"),void(this._myVideoStillFrozen=!0);if(!e){if(this._activeLocalVideoTrack.size){for(let e of this._avStreams)e.stream&&this._localVideoStream.has(e.id)?(console.log("LiveAudioVideo:freezeEndUserVideo putting back local to remote stream: "+e.id),this.replaceSenderVideoTrack(e.stream.call,this._activeLocalVideoTrack.get(e.id))):console.log("LiveAudioVideo:freezeEndUserVideo no avstream {} mapped to local {}",e.id,this._localVideoStream);this._localVideoStream.forEach((e,t)=>{this._activeLocalVideoTrack.has(t)&&(console.log("LiveAudioVideo:freezeEndUserVideo putting back local stream: "+t),this.replaceLocalStreamVideoTrack(e,this._activeLocalVideoTrack.get(t)),this._activeLocalVideoTrack.delete(t))})}return}let t=$("#oracle-live-local-video")[0],i=document.createElement("canvas");i.width=t.videoWidth,i.height=t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height);let o=i.captureStream();console.log("Canvas stream ",o),this._localVideoStream.forEach((e,t)=>{const i=this.replaceLocalStreamVideoTrack(e,o.getVideoTracks()[0]);i&&this._activeLocalVideoTrack.set(t,i)});for(let e of this._avStreams)e.stream&&this.replaceSenderVideoTrack(e.stream.call,o.getVideoTracks()[0])}showTrackStatus(e){console.log("showTrackStatus: type="+e);const t="screenshare"===e?"video":e,i="screenshare"===e?live.STREAMTYPE.SCREENSHARE:live.STREAMTYPE.AUDIOVIDEO;let o=[];const s=this._impl._conversation;if(s){const n=s.getStreams();for(let s=0;s<n.length;s++)if(n[s].getType()===i){const i=n[s].call?n[s].call.peerConnection:null;if(i){const a=n[s].getId();let r={id:a,type:e};const l=i.getSenders().find(e=>e.track&&e.track.kind===t);l?(console.log("- ["+s+"]="+a+" Sender "+t+" track enabled = "+l.track.enabled),r.sender=l.track.enabled):console.log("- ["+s+"]="+a+" Sender "+t+" has no tracks");const c=i.getReceivers().find(e=>e.track&&e.track.kind===t);c?(console.log("  ["+s+"]="+a+" Receiver "+t+" track enabled = "+c.track.enabled),r.receiver=c.track.enabled):console.log("- ["+s+"]="+a+" Receiver "+t+" has no tracks"),o.push(r)}else console.warn("showTrackStatus: no peer connection")}}else console.warn("showTrackStatus: no conversation");return o}}}),define("LiveScenarioMessages",[],function(){"use strict";return class{constructor(e){e&&(this.greetingMessage=e.greetingMessage,this.connectingMessage=e.connectingMessage)}}}),define("LiveNetworkQualityMonitor",["LiveEvents"],function(e){"use strict";const t=1e4;return class{constructor(e){this._impl=e,this._monitoredStreams=new Map,this._qualityMap={},this._isBad=!1,this._lastQualityResult=live.ExperienceStatus.GOOD,this._qualityPeriod=2e4,this._qualityTimer=null,this._videoLoadingTimer=null}_getExperienceStatus(e){switch(e){case live.ExperienceStatus.GOOD:return"GOOD";case live.ExperienceStatus.BAD:return"BAD";case live.ExperienceStatus.NOT_AVAILABLE:return"N/A";default:return"I/S"}}monitor(i,o){const s=o?"local":"remote",n=i.getId(),a=i.getType();if(this._monitoredStreams[s+a+n])return void this.optionallyLog("LiveNetworkQualityMonitor::monitor: Already monitoring "+s+" stream id: "+n+", type: "+a);this._monitoredStreams[s+a+n]=!0,this.optionallyLog("LiveNetworkQualityMonitor::monitor: Start monitoring "+s+" stream id: "+n+", type: "+a);const r=i.getQualityMonitor();if(r.onNewStatus(live.ExperienceFactor.VIDEO_INBOUND,(e,t)=>{const o=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+s+":"+a+":"+n+").InVideoStatus: "+o+" - hints: "+r+")"),i.getStreamOptions().shouldReceiveVideo()&&!i.isVideoPaused()&&this._updateMos(n,live.ExperienceFactor.VIDEO_INBOUND,e)}),r.onNewStatus(live.ExperienceFactor.VIDEO_OUTBOUND,(e,t)=>{const o=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+s+":"+a+":"+n+").OutVideoStatus: "+o+" - hints: "+r+")"),i.getStreamOptions().shouldSendVideo()&&!i.isVideoPaused()&&this._updateMos(n,live.ExperienceFactor.VIDEO_OUTBOUND,e)}),r.onNewStatus(live.ExperienceFactor.AUDIO_INBOUND,(e,t)=>{const o=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+s+":"+a+":"+n+").InAudioStatus: "+o+" - hints: "+r+")"),i.getStreamOptions().shouldReceiveAudio()&&!i.isAudioPaused()&&this._updateMos(n,live.ExperienceFactor.AUDIO_INBOUND,e)}),r.onNewStatus(live.ExperienceFactor.AUDIO_OUTBOUND,(e,t)=>{const o=this._getExperienceStatus(e),r=JSON.stringify(t);this.optionallyLog("QM("+s+":"+a+":"+n+").OutAudioStatus: "+o+" - hints: "+r+")"),i.getStreamOptions().shouldSendAudio()&&!i.isAudioPaused()&&this._updateMos(n,live.ExperienceFactor.AUDIO_OUTBOUND,e)}),o){let i=!0;a===live.STREAMTYPE.AUDIOVIDEO&&(this._impl.dispatchEvent(e.LiveRemoteVideoLoading),this._videoLoadingTimer=setTimeout(()=>{this._videoLoaded()},t)),r.withCallbacks(e=>{this.optionallyLog("QM("+s+":"+a+":"+n+").InFrRate: "+e),a===live.STREAMTYPE.AUDIOVIDEO&&e>0&&i&&(i=!1,this._videoLoaded())},e=>{this.optionallyLog("QM("+s+":"+a+":"+n+").OutFrRate: "+e)},(e,t)=>{this.optionallyLog("QM("+s+":"+a+":"+n+").InRes: "+e+"x"+t),a===live.STREAMTYPE.AUDIOVIDEO&&e>0&&t>0&&i&&(i=!1,this._videoLoaded())},(e,t)=>{this.optionallyLog("QM("+s+":"+a+":"+n+").OutRes: "+e+"x"+t)})}this._checkQualityStatus(this._qualityPeriod)}_videoLoaded(){this._impl.dispatchEvent(e.LiveRemoteVideoLoaded),this._videoLoadingTimer&&clearTimeout(this._videoLoadingTimer),this._videoLoadingTimer=null}_updateMos(e,t,i){const o="LiveNetworkQualityMonitor::_updateMos:";this.optionallyLog(`${o} streamId: ${e} factor: ${t}  status: ${i}`);const s={};s.status=i,s.timestamp=Date.now();const n=e+t;this._qualityMap[n]=this._qualityMap[n]||[],this._qualityMap[n].push(s),this.optionallyLog(`${o}key: ${n} = ${JSON.stringify(this._qualityMap[n])})`),this._isBad||i===live.ExperienceStatus.BAD&&(this._isBad=!0,this.optionallyLog("QoE value has changed to BAD. Show first BAD message now."),this._lastQualityResult=live.ExperienceStatus.BAD)}_getQualityResultOfLastPeriod(e){const t=Date.now(),i=this._impl._conversation.getLocalParticipant();if(!i)return this.optionallyLog("LiveNetworkQualityMonitor::_getQualityResultOfLastPeriod: returning not available"),live.ExperienceStatus.NOT_AVAILABLE;const o=[],s=[];return i.getStreamInfos().forEach(i=>{const n=i.getId(),a=i.getStreamOptions(),r=this._impl.getAssociateStreamInfo(i.getType());if(!r)return null;const l=this._qualityMap[n+live.ExperienceFactor.VIDEO_INBOUND],c=this._qualityMap[n+live.ExperienceFactor.VIDEO_OUTBOUND],d=this._qualityMap[n+live.ExperienceFactor.AUDIO_INBOUND],u=this._qualityMap[n+live.ExperienceFactor.AUDIO_OUTBOUND];void 0!==l&&l.length>0&&a.shouldReceiveVideo()&&!r.isVideoPaused()&&o.push(this._getQuality(t,e,live.ExperienceFactor.VIDEO_INBOUND,n)),void 0!==c&&c.length>0&&a.shouldSendVideo()&&!i.isVideoPaused()&&o.push(this._getQuality(t,e,live.ExperienceFactor.VIDEO_OUTBOUND,n)),void 0!==d&&d.length>0&&a.shouldReceiveAudio()&&!r.isAudioPaused()&&s.push(this._getQuality(t,e,live.ExperienceFactor.AUDIO_INBOUND,n)),void 0!==u&&u.length>0&&a.shouldSendAudio()&&!i.isAudioPaused()&&s.push(this._getQuality(t,e,live.ExperienceFactor.AUDIO_OUTBOUND,n))}),o.find(e=>e===live.ExperienceStatus.BAD)||s.find(e=>e===live.ExperienceStatus.BAD)?(this.optionallyLog("LiveNetworkQualityMonitor::_getQualityResultOfLastPeriod: returning BAD"),live.ExperienceStatus.BAD):(this.optionallyLog("LiveNetworkQualityMonitor::_getQualityResultOfLastPeriod: returning GOOD"),live.ExperienceStatus.GOOD)}_getQuality(e,t,i,o){const s=o+i,n=this._qualityMap[s],a=e-t,r={};r.status=n[n.length-1].status,r.timestamp=e,n.push(r);let l=0,c=0,d=0;this.optionallyLog(`LiveNetworkQualityMonitor::_getQuality: qualityTagList: ${JSON.stringify(n)}`);for(let e=0;e<n.length;e++){const t=n[e];if(t.timestamp>a){if(e>0){const i=n[e-1],o=t.timestamp-i.timestamp;i.status===live.ExperienceStatus.BAD?c+=o:i.status===live.ExperienceStatus.GOOD?l+=o:d+=o}}else t.timestamp=a}const u=n[n.length-1];this._qualityMap[s]=[],this._qualityMap[s].push(u);const h=Math.round(100*c/t);return this.optionallyLog(i+" of stream "+o+": bad time is: "+c/1e3+" seconds, the percentage is: "+h),h<30?live.ExperienceStatus.GOOD:live.ExperienceStatus.BAD}_checkQualityStatus(e){this._qualityTimer?this.optionallyLog("LiveNetworkQualityMonitor::_checkQualityStatus: qualityTimer is running - returning"):this._qualityTimer=setInterval(()=>{const t=this._getQualityResultOfLastPeriod(e);t?(this.optionallyLog(`LiveNetworkQualityMonitor::qualityTimer: result of last period: ${t} previousResult: ${this._lastQualityResult}`),t===live.ExperienceStatus.BAD?this._lastQualityResult===live.ExperienceStatus.GOOD&&this.optionallyLog("LiveNetworkQualityMonitor::qualityTimer: QoE value changed to BAD"):t===live.ExperienceStatus.GOOD?(this._lastQualityResult===live.ExperienceStatus.BAD&&this.optionallyLog("LiveNetworkQualityMonitor::qualityTimer: QoE value changed to GOOD"),this._isBad=!1):this.optionallyLog(`LiveNetworkQualityMonitor::qualityTimer: Unexpected QoE result: ${t}`),this._lastQualityResult=t):console.warn("Cannot get quality result for last period")},e)}reset(){this.optionallyLog("LiveNetworkQualityMonitor::reset"),this._qualityTimer&&(clearInterval(this._qualityTimer),this._qualityTimer=null),this._qualityMap={},this._isBad=!1,this._lastQualityResult=live.ExperienceStatus.GOOD,this._videoLoadingTimer&&clearTimeout(this._videoLoadingTimer),this._videoLoadingTimer=null}optionallyLog(e){}}}),define("LiveScenarioQuality",[],function(){"use strict";return class{constructor(e){this.maxVideoBitrate=0,e&&e.video&&(this.maxVideoBitrate=e.video),console.log("maxVideoBitrate",this.maxVideoBitrate)}toJSON(){return{video:this.maxVideoBitrate}}getMaxVideoBitrate(){return this.maxVideoBitrate}}}),define("LiveCobrowse",["LiveEvents","LiveRestHelper"],function(e,t){"use strict";return class{constructor(e){console.log("LiveCobrowse::constructor"),this._impl=e,this._sessionId=null,this.loaded=!1}start(){if(console.log("LiveCobrowse::start"),!this.loaded)return void console.log("Unable to start cobrowse as visitor.js is not loaded.");this._sessionId=this._impl._rest.generateId(6);let t=this._impl.service.tenantID;console.log("Cobrowse:initiate: unique sessionId: ",this._sessionId),this._impl._conversation.relayCommandTo(null,"*","start_cobrowse",[{cobrowseId:this._sessionId}]),this._impl.dispatchEvent(e.LiveCobrowseStarted,this._sessionId);let i=this._impl.service.address+"/tenant/api/apps/"+t+"/application/global/cobrowse/jwt?userName=webdemo&displayName=Webdemo&role=contact",o=this._impl.service.address+"/tenant/api/apps/"+t+"/application/global/cobrowse/siteid";const s=this._impl._rest._get(o),n=this._impl._rest._get(i,"*/*");this._impl.acceptUpgradeRequest(),Promise.all([n,s]).then(e=>{console.log("Cobrowse:initiate: siteId, jwt retrieved: ",e[0],e[1]);let t={apiKey:e[1].siteId,authToken:e[0],session:this._sessionId},i={cobrowse:{}};this.MCServiceAPI.ready().then(()=>{if(-1===this.MCServiceAPI.supportedChannels.indexOf("cobrowse"))return console.error("Cobrowse channel is not supported here"),void this._impl.unableToStartCobrowse();this.MCServiceAPI.Channels.cobrowse.Events.Error.listen(e=>{console.log("Unable to connect Co-browse: ",e.code),this.MCServiceAPI.Site&&this.MCServiceAPI.Site.endSession("Unable to connect").then(()=>{console.log("End session due to error completed")}).catch(e=>{console.log("End session rejected: ",e.code,e.reason)})}),this.MCServiceAPI.Site.start(t,i).then(()=>{console.log("Cobrowse session started")}).catch(e=>{console.log("Unable to start cobrowse session: "+e.code+" ("+e.reason+")"),this._impl.unableToStartCobrowse()})}).catch(e=>{console.log("Failed to get cobrowse ready, Error: "+e.message,e.response),this._impl.unableToStartCobrowse()})}).catch(e=>{console.log("Failed to get cobrowse jwt, Error: "+e.message,e.response),this._impl.unableToStartCobrowse()})}ready(e){let t=()=>{if(""!==this._impl.service.tenantID){let t=this._impl.service.address+"/tenant/api/apps/"+this._impl.service.tenantID+"/application/global/cobrowse/siteid";this._impl._rest._get(t).then(t=>{if(console.log("Cobrowse:ready: siteId retrieved: ",t),t&&t.siteId&&""!==t.siteId){let i=this._impl.service.address+"/auth/user/api/integration/"+this._impl.service.tenantID+"/cobrowse?jwt="+this._impl.service.authToken;t.qa&&""!=t.qa&&(i+="&sandbox="+t.qa),$.getScript(i).done((t,i)=>{console.log("Finished loading visitor.js, status: "+i),this.loaded=!0,this.MCServiceAPI=window.MCServiceAPI;let o=5,s=setInterval(()=>{this.MCServiceAPI?(clearInterval(s),this.MCServiceAPI.ready().then(e)):(o-=1)<=0&&(console.log("Gave up waiting for MCServiceAPI to be available"),clearInterval(s))},300)}).fail(()=>{console.log("Unable to load cobrowse visitor.js in this environment.")})}else console.log("Cobrowse:ready: not configured, not loading")})}else setTimeout(t,250)};t()}decline(){this._impl._conversation.relayCommandTo(null,"*","stop_cobrowse",[{}])}isCobrowseActive(){return null!==this._sessionId}cleanup(t){this._impl.dispatchEvent(e.LiveCobrowseEnded,t)}shutdown(e){this._impl._isAssociateConnected&&this._impl._conversation&&this._impl._conversation.relayCommandTo(null,"*","stop_cobrowse",[{cobrowseId:this._sessionId}]),this.cleanup(e)}terminate(e){if(this._sessionId)if(this.MCServiceAPI&&this.MCServiceAPI.Site){let t=this.MCServiceAPI.Site.endSession(e);t?t.then(()=>{console.log("Client stopped cobrowse session due to :"+e),this.shutdown(e)},t=>{console.error("Unable to cleanly terminate cobrowse session: "+t.code+" ("+t.reason+")"),this.shutdown(e)}):(console.log("Cobrowse endSession did not return promise: "+this._sessionId),this.shutdown(e)),this._sessionId=null}else this._sessionId=null;else"declined"===e&&(e="cancelled"),this.cleanup(e)}}}),define("LiveControllerImpl",["oracle.live.sdk","jquery","LiveService","LiveContextAttributes","LiveSettings","LiveApiVersion","LiveEvents","LiveExposedEvents","LiveState","LiveRestHelper","LiveCallTimer","LiveDiagnostics","LiveScreenSharing","LiveAudioVideo","LiveScenarioBehaviours","LiveScenarioMessages","LiveSessionStore","LiveNetworkQualityMonitor","LiveScenarioCustomization","LiveScenarioQuality","LiveCobrowse"],function(e,$,t,i,o,s,n,a,r,l,c,d,u,h,g,m,p,v,S,_,f){"use strict";return class{constructor(){console.log("LiveControllerImpl::constructor START"),this.service=new t(this),this.contextAttributes=new i(this),this.settings=new o,this.apiVersion=new s,this.version=this.apiVersion.version,this._browserName=null,this._browserVersion=null,this._browserUnsupported=null,this._browserVersionUnsupported=!1,this._isMobileOS=!1,this._screenshareStreamSendRecv=!1,this._networkQualityMonitor=new v(this),this._isMeeting=!1,this._simulatePstn=null,this._buttonState=new r(this),this._rest=new l(this),this._diags=new d(this),this._screen=new u(this),this._av=new h(this),this._cobrowse=new f(this),this._cobrowseRequestForUser=!1,this._behaviours=null,this._messages=null,this._customization=null,this._associates=[],this._quality=null,this._connection=null,this._retry=!1,this._callMediaType="",this._conversation=null,this._conversationId=null,this._associateUri=null,this._transferringAssociateUri=null,this._transferToAssociateUri=null,this._transferringAssociateStillConnected=!1,this._upgradeRequest=null,this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null,this._rehydratingToState=null,this._connectionId=null,this._readyToStartConnection=!1,this._readyToAddComponent=!1,this._haveRequestedVideoPreview=!1,this._isCallbackAvailable=!1,this._offerCallbackTimer=null,this._offerCallbackNoAnswerTimer=null,this._callbackAlreadyOfferred=!1,this._progressIndicatorStarted=!1,this._callEndedEventReceived=!1,this._callEstablished=!1,this._haveTweakedSpeakerVolumeSinceStartOfCall=!1,this._connectionTimer=null,this._reconnectionTimer=null,this._reconnectionTimeout=2e4,this._reconnectingLocal=!1,this._statusCheckTimer=null,this._statusCheckTimeout=1e4,this._callbackNumberAttrTag="phone",this._dynamicChromeExtensionInstall=!1,this._permanentTwoWayScreenShare=!1,this._dummyScreenShareCreated=!1,this._isAssociateConnected=!1,this._endCallReason="",this._canRejoinMeeting=!0,this._componentAdded=!1,this._autoTest=!1,this._transactionReference=null,this._positionInQueue=0,this._myStreams=[],this._agentStreams=new Map,window.wce={};const e=this;window.wce.updateAudioForEchoCancellation=function(){e._av.updateAudioForEchoCancellation(null)},window.wce.conversation=function(){return e._conversation},window.wce.showTrackStatus=(()=>{console.log("showTrackStatus");let t=(new Date).toISOString(),i=[],o=e._av.showTrackStatus("audio");i=i.concat(o);let s=e._av.showTrackStatus("video");i=i.concat(s);let n=e._av.showTrackStatus("screenshare"),a={timestamp:t,status:i=i.concat(n)};return console.log(JSON.stringify(a,null,2)),JSON.stringify(a)}),p.initState("LiveControllerImpl",this),$(()=>{console.log("LiveControllerImpl::constructor about to restore"),p.loadState("LiveControllerImpl",e=>{console.log("LiveControllerImpl: Loading, found ",e),this._isMeeting=e.isMeeting;const t=e.state;this._autoTest=e.autoTest,this._browserVersion=e.browserVersion,this._browserName=e.browserName,this._browserUnsupported=e.browserUnsupported,this._browserVersionUnsupported=e.browserVersionUnsupported,this._metaScenario=e.metaScenario,this._screenshareStreamSendRecv=e.screenshareStreamSendRecv,this._conversationId=e.conversationId,this.setPermanentTwoWayScreenShare(e.permanentTwoWayScreenShare),this._dummyScreenShareCreated=e.dummyScreenShareCreated,console.log("LiveControllerImpl::getMetaScenario resetting the metaScenario"),e.metaScenario&&(e.metaScenario.behaviours&&e.metaScenario.messages&&(this._behaviours=new g(e.metaScenario.behaviours),console.log("Restored behaviours: ",this._behaviours),this.contextAttributes.set("behaviours",e.metaScenario.behaviours),this._messages=new m(e.metaScenario.messages),console.log("Restored messages: ",this._messages),this.contextAttributes.set("messages",e.metaScenario.messages)),e.metaScenario.quality&&(this._quality=new _(e.metaScenario.quality),console.log("Restored quality settings: ",this._quality))),e.customization&&(this._customization=new S(e.customization),console.log("Restored customization: ",this._customization)),this._browserName&&this._browserVersion&&this.contextAttributes.populateContext(this.version,this._browserName,this._browserVersion),console.log("Context attributes are: ",this.contextAttributes),console.log("Loading state: ",t),console.log("Meeting is: ",this._isMeeting);let i=window.location.toString()===e.url;console.log("Location (URL) is: ",i?"unchanged":"changed"),!0===this._isMeeting&&i||this._buttonState._stateSupportsRehydration(t)?(this._rehydratingToState=this._isMeeting?"Meeting":t,this._callMediaType=e.callMediaType,this._associateUri=e.associateUri,this._transferringAssociateUri=e.transferringAssociateUri,this._transferToAssociateUri=e.transferToAssociateUri,this._transferringAssociateStillConnected=e.transferringAssociateStillConnected,this._connectionId=e.connectionId,console.log("Restored connection ID: ",this._connectionId)):(this._rehydratingToState=null,console.log("LiveControllerImpl::Not rehydrating, resetting the button state"),this._buttonState.reset(),"Connecting"===t&&(this._authToken=e.authToken,this.beforeUnload(),this._authToken=null)),console.log("LiveControllerImpl::constructor Attempting to restore state: "+this._rehydratingToState),console.log("LiveControllerImpl::constructor done restoring, creating the component=",this._readyToAddComponent),this._readyToStartConnection=!0,!0===this._readyToAddComponent&&this._addComponent(),this._transactionReference=e.transactionReference,this._positionInQueue=e.positionInQueue},()=>{console.log("LiveControllerImpl::constructor no state to restore, add component"),this._readyToStartConnection=!0,!0===this._readyToAddComponent&&this._addComponent()})}),console.log("LiveControllerImpl::constructor end")}toJSON(){return!0===this._isMeeting||this._buttonState._stateSupportsRehydration(this._buttonState.stateName)?JSON.stringify({isMeeting:this._isMeeting,url:window.location.toString(),metaScenario:this._metaScenario,callMediaType:this._callMediaType,associateUri:this._associateUri,transferringAssociateUri:this._transferringAssociateUri,transferToAssociateUri:this._transferToAssociateUri,transferringAssociateStillConnected:this._transferringAssociateStillConnected,state:this._buttonState.stateName,authToken:this.service.authToken,connectionId:this._connection.getConnectionId(),browserName:this._browserName,browserVersion:this._browserVersion,browserUnsupported:this._browserUnsupported,isMobileOS:this._isMobileOS,browserVersionUnsupported:this._browserVersionUnsupported,conversationId:this._conversationId,permanentTwoWayScreenShare:this._permanentTwoWayScreenShare,dummyScreenShareCreated:this._dummyScreenShareCreated,transactionReference:this._transactionReference,positionInQueue:this._positionInQueue,autoTest:this._autoTest,screenshareStreamSendRecv:this._screenshareStreamSendRecv,customization:this._customization}):null}setAutoTest(e){console.log("LiveControllerImpl::setAutoTest setting to: ",e),this._diags.setAutoTest(e),this._autoTest=e}setQualityMetricsCallback(e){this._av._qualityMetricsCallback=e,this._screen._qualityMetricsCallback=e}setRunningForChromeExtension(e){this._rest.setRunningForChromeExtension(e)}setNoProxyForKyc(e){console.log("LiveControllerImpl::setNoProxyForKyc setting to: ",e),this._rest.setNoProxyForKyc(e)}callbackAvailable(){return this._isCallbackAvailable}haveCallbackNumber(){const e=this.contextAttributes.get(this._callbackNumberAttrTag);return void 0!==e&&e.length>0}getNumberOfParticipantsInConversation(){if(this._conversation){const e=this._conversation.getParticipants();return console.log("Number of Participants in conversation = "+e.length),e.length}return console.log("No active conversation: Number of Participants in conversation = 0"),0}getCallbackNumber(){const e=this.contextAttributes.get(this._callbackNumberAttrTag);return console.log("Pre-configured Callback number: "+e),void 0===e?null:e}setCallbackAvailable(e){this._isCallbackAvailable=e,console.log("callback is: "+(this._isCallbackAvailable?"available":"not available"))}isCallbackOnly(){return this._behaviours.isCallbackOnly()}isCallback(){const e=this._behaviours.isCallback();return e&&this._behaviours.allowCallbackAlternateNumber||e&&!this._behaviours.allowCallbackAlternateNumber&&this.haveCallbackNumber()}checkCallbackConditions(){const e=this._behaviours.isCallback(),t=this._behaviours.isCallbackOnly(),i=this._behaviours.allowCallbackAlternateNumber||this.haveCallbackNumber();return console.log("- Callback: "+e),console.log("- Callback only: "+t),console.log("- Allow Alt Number option: "+this._behaviours.allowCallbackAlternateNumber),console.log("- Callback Number Configured: "+this.haveCallbackNumber()),console.log("- Have Alt Number: "+i),console.log("- PSTN or inApp configured: "+this.callbackAvailable()),this.callbackAvailable()&&i}showFailedCallbackConditions(){console.log("--\x3e Callback conditions not met because:"),this.callbackAvailable()||console.log("  - PSTN or inApp not configured"),this.haveCallbackNumber()||console.log("  - No phone number configured in WCE"),this._behaviours.allowCallbackAlternateNumber||console.log("  - Allow Alternate Callback Number option not checked in Admin UI")}isComponentAvailable(){console.log("Checking if Live Experience component should be displayed:");const e=this.checkCallbackConditions();let t=!0;return this._behaviours.isCallbackOnly()&&!e&&(t=!1,this.showFailedCallbackConditions()),console.log("--\x3e RESULT: "+(t?"Component will be displayed":"Component will be hidden")),t}canOfferCallback(){console.log("Checking if Callback can be offered:");const e=!!this.checkCallbackConditions(),t=!!this._behaviours.isCallback();console.log("Callback configured: "+t),console.log("Callback conditions: "+e);let i=t;return t&&!e&&(i=!1,this.showFailedCallbackConditions()),console.log("--\x3e RESULT: "+(i?"Callback will be offered":"Callback will not be offered")),i}reset(){console.log("Controller::reset"),this._networkQualityMonitor.reset();const e=e=>{e&&(console.log("reset method is clearing media..",e),e.srcObject=null)};this._screen.stopReceivingScreenShare(),this._screen.reset(),this._associates=[],this._buttonState.resetAssociates(),this._callEndedEventReceived=!1,this._autoTest=!1,this._cobrowse.terminate("end_call"),e(document.querySelector(".oracle-live-local-audio")),e(document.querySelector(".oracle-live-local-video")),e(document.querySelector(".oracle-live-remote-audio")),document.querySelectorAll(".oracle-live-remote-video").forEach(e=>e.remove()),e(document.querySelector(".oracle-live-local-screenshare")),e(document.querySelector(".oracle-live-remote-screenshare")),clearTimeout(this._connectionTimer),clearTimeout(this._reconnectionTimer),clearTimeout(this._statusCheckTimer),this._statusCheckTimer=null,this._reconnectionTimer=null,this._connectionTimer=null,this._callEstablished=!1,this._endCallReason="",this._simulatePstn=null,this._screenshareStreamSendRecv=!1,this._conversation&&!this._conversation.isPostCallRatingRequired()&&(console.log("No post call rating required so clearing state now"),this._buttonState.reset()),this._conversation=null,this._av.reset(),this._associateUri=null,this._transferringAssociateUri=null,this._transferToAssociateUri=null,this._transferringAssociateStillConnected=!1,this._upgradeRequest=null,this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null,this.setIsRequestUserCobrowse(!1),this._rehydratingToState=null,this._transactionReference=null,this._positionInQueue=0,this.setPermanentTwoWayScreenShare(!1),this._dummyScreenShareCreated=!1,this._reconnectingLocal=!1,this._haveRequestedVideoPreview=!1,this._precallIDCheckCancelled=!1,this._haveTweakedSpeakerVolumeSinceStartOfCall=!1,this._rest.closeCallQueue(),this._diags.cancelChecks(),this._transactionReference=null,this.contextAttributes.remove("preCallCheckId"),$(".kyc-jumio-iframe").attr("src",null),$(".oracle-live-local-video").hide(),document.querySelectorAll(".oracle-live-remote-video").forEach(e=>e.remove())}beforeUnload(){let e=this._authToken?this._authToken:this.service.authToken;e&&(console.log("beforeUnload: attempting to remove from queue",e),this._rest.removeFromQueue(this._callMediaType,e,()=>{console.log("success")}),this._authToken=null),this._cobrowse.terminate("end_call")}_isRehydrating(){let e=!!this._rehydratingToState;return console.log("_isRehydrating:",e,", state: ",this._rehydratingToState),e}_isRehydratingMeetingCall(){let e=this._isRehydrating()&&"Meeting"===this._rehydratingToState;return console.log("_isRehydratingMeetingCall:",e),e}_isRehydratingNonMeetingCall(){let e=this._isRehydrating()&&"Meeting"!==this._rehydratingToState;return console.log("_isRehydratingNonMeetingCall:",e),e}addComponent(e){console.log("LiveControllerImpl::addComponent"),e&&"remove"===e?this.shutdown():(console.log("---\x3e addComponent: "+(this._componentAdded?"component already added":"component not yet added")),console.log("this.service.authToken: "+(this.service.authToken?"Have authToken":"Don't have auth token")),this._componentAdded?this.updateComponent():(e&&(console.log("We have a root tag, this is a meeting"),this._eventNode=e,this._isMeeting=!0),!0===this._readyToStartConnection?(console.log("LiveControllerImpl::addComponent ready, adding now"),this._addComponent()):(console.log("LiveControllerImpl::addComponent setting add when ready"),this._readyToAddComponent=!0)))}_addComponent(){console.log("LiveControllerImpl::_addComponent"),console.log("-> _addComponent"),this._isRehydrating()?(console.log("LiveControllerImpl::_addComponent/rehydrating"),this.loginToLiveExperience()):(console.log("LiveControllerImpl::_addComponent/not rehydrating"),this._diags.checkBrowser().then(e=>{this._browserName=e.browserName,this._browserVersion=e.browserVersion,this._browserUnsupported=e.browserUnsupported,this._browserVersionUnsupported=e.browserVersionUnsupported,this._isMobileOS=e.isMobileOS,console.log("Set the value of the browser name: "+this._browserName+" and browser version: "+this._browserVersion),this.service.isValid()&&this.contextAttributes.isValid()&&(this.contextAttributes.populateContext(this.version,this._browserName,this._browserVersion),this.loginToLiveExperience())}).catch(e=>{console.warn("Not displaying the component",e)}))}updateComponent(){if(console.log("---\x3e updateComponent"),this.service.authToken)this._buttonState.hideMenu(),console.log("-> updateComponent: called hideMenu, now calling getMetaScenario"),this.getMetaScenario(()=>{this._componentAdded?(this._buttonState.updateMenu(),(this.service.startCallDirectly||this._buttonState.isPreCallIDCheck())&&(console.log("--\x3e updateComponent: Start a new call directly"),this._buttonState.start())):this._getMessagesAndAddComponent(()=>{(this.service.startCallDirectly||this._buttonState.isPreCallIDCheck())&&(console.log("--\x3e updateComponent: Start a new call directly"),this._buttonState.start())})});else{console.log("Not attempting to resolve meta scenario while unauthorised");const e=this.contextAttributes.get("appLocation");console.log(" - updateComponent: MetaScenario appLocation is ",e)}}getNetworkStatus(e,t){console.log("LiveAPI::getNetworkStatus",this._connection),this._connection?this._connection.getNetworkStatus(e,t):t("Invalid connection")}updateAuthToken(e){this._connection&&this._connection.updateWebSocketUri(this._getWebSocketUri(e))}stopStream(e){e&&(console.log("stop stream",e),e instanceof RTCRtpReceiver||e instanceof RTCRtpSender?(e.track&&"video"===e.track.kind&&(console.log("stop video track",e.track),e.track.stop&&e.track.stop(),e.track.enabled&&(e.track.enabled=!1),console.log("After stopping, track muted property="+e.track.muted)),e.track&&"audio"===e.track.kind&&(console.log("stop audio track",e.track),e.track.stop&&e.track.stop(),e.track.enabled&&(e.track.enabled=!1),console.log("After stopping, track muted property="+e.track.muted))):(e.getVideoTracks().forEach(e=>{console.log("stop video track",e),e.stop&&e.stop(),e.enabled&&(e.enabled=!1),console.log("After stopping, track muted property="+e.muted)}),e.getAudioTracks().forEach(e=>{console.log("stop audio track",e),e.stop&&e.stop(),e.enabled&&(e.enabled=!1),console.log("After stopping, track muted property="+e.muted)})))}loginToLiveExperience(){console.log("loginToLiveExperience(): "+this.service.userID),this.loginAndConnect().then(()=>{console.log("Connected with username: "+this.service.userID+" and tenant: "+this.service.tenantID),this._connection.initCallbacks(this.detectIncomingStream.bind(this),this.refreshConnection.bind(this),this.detectWhenConnectionHasChanged.bind(this));const e=this._connection.isRefresh()||this._isRehydratingMeetingCall();if(console.log("Login success, refresh = "+e),e){const e=this._connection.getConversations(),t=e.length||0;console.log("Handling browser refresh",e),e&&t>0&&this.refreshConnection(e[t-1]),this._isMeeting&&(this._buttonState.isMeeting=!0),this._buttonState.addMenu(!0),p.loadStateCompleted(),this.dispatchEvent(n.LiveStateReloaded,{state:this._buttonState.stateName})}else this._componentAdded?(console.log("-> Already added the component"),(this.service.startCallDirectly||this._buttonState.isPreCallIDCheck())&&(console.log("Start a new call directly"),this._buttonState.isPreCallIDCheck()||(this._buttonState.showMenu(!0),this._buttonState.menu.showComponent()),live.resumeAudioContext(),this._buttonState.start())):(console.log("-> Have not added the component previously"),this._isMeeting?(console.log("-> Meeting: Getting metaScenario and Messages"),this.getMetaScenario(()=>{this._getMessagesAndAddComponent()})):(this.getAvailability(),console.log("-> Getting metaScenario and Messages"),this.getMetaScenario(()=>{this._getMessagesAndAddComponent()})));this.readyCobrowse(),this.dispatchEvent(n.LiveLoginSuccess)}).catch(e=>{console.error("Failed to connect",e),this.dispatchEvent(n.LiveLoginError)})}loginAndConnect(){return console.log("loginAndConnect()"),this._retry=!1,new Promise((e,t)=>{console.log("ConnectToLiveExperience Attempt 1"),this.connectToLiveExperience(e,i=>{this._retry?(console.log("Failed to connect to Live Experience (2) - already retried",i),t(i)):(console.log("Failed to connect to Live Experience (1) - retrying",i),this._retry=!0,console.log("ConnectToLiveExperience Attempt 2"),this.connectToLiveExperience(e,t))})})}_getWebSocketUri(e){let t=this.service.address.replace(/^http/,"ws")+"/ws/webrtc/cloud";return t+="?jwt="+e+"&tenant_profile_key="+this.service.tenantID,console.log("Connection has WebSocketURI: "+t),t}connectToLiveExperience(e,t){if(!(this.service.userID&&""!==this.service.userID&&this.service.userID.indexOf("@")>0))return console.log("connectToLiveExperience: Invalid username: "+this.service.userID),void this.logoutFromLiveExperience();let i=null;this._buttonState.connectingAudioURL=this.service.address+"/meeting/media/connecting.wav";let o=this.service.authToken;!0===this._isRehydrating()&&this._connectionId?(console.log("connectToLiveExperience: Rehydrating plus we have an existing session: "+this._connectionId),i=this._connectionId):(console.log("connectToLiveExperience: is rehydrating "+this._isRehydrating()),console.log("connectToLiveExperience: connectionId "+this._connectionId),console.log("connectToLiveExperience: Not rehydrating or no connection id to restart"),this._rehydratingToState=null),console.log("Logged in with username: "+this.service.userID+", tenant: "+this.service.tenantID),console.log("Local connection ID is: "+i),console.log("Creating connection with JWT: "+o);let s=this._getWebSocketUri(o);this._connection=new live.Connection(this.service.userID,s,e,t).withEarlyCallbacks(this.detectWhenConnectionHasChanged.bind(this),()=>null).withConnectionId(i).withExtPayloads({capability:{appid:"web"}}).start(),this._connection.setTrickleIceMode("full"),console.log("Starting connection: wsUri="+s,this._connection)}logoutFromLiveExperience(){console.log("LiveControllerImpl::logoutFromLiveExperience"),this._connection&&(console.log("logout: "+this.service.userID),this.beforeUnload(),this._connection.close(),this._connection=null,this._retry=!1,this.service.authToken=null,this._componentAdded=!1),this.reset()}getMetaScenario(e){const t=this.contextAttributes.get("appLocation");if(console.log("MetaScenario appLocation is ",this._metaScenarioAppLocation),"wce_test"===t||"wce_sim"===t){console.log("LiveControllerImpl::getMetaScenario Using locally set configuration for test purposes: ",this._metaScenario);const i=this.contextAttributes.get("wceTestType");return this._metaScenarioAppLocation=t,this.contextAttributes.set("devType","web"),"pstn"===i&&this._metaScenario._simulatePstn?(this._simulatePstn=this._metaScenario._simulatePstn,console.log("Setting this._simulatePstn="+this._simulatePstn),this.contextAttributes.remove("wceTestType"),this._behaviours=new g({shortCodeEnabled:!1,transferEnabled:!0,associateCanRequestEndUserVideo:!1,endUserCanAddAudio:!1,associateCanAddScreenShare:!1,associateInitialMedia:"AUDIO_ONLY",endUserInitialMedia:"AUDIO_ONLY",associateCanAddAudio:!1,endUserCanAddVideo:!1,usingExternalAudio:!1,meetingsEnabled:!1,preCallIDCheck:!1,endUserCanAddScreenShare:!1,associateCanAddVideo:!1,associateCanRequestEndUserAudio:!1,associateCanRequestEndUserScreenShare:!1}),"string"==typeof this._simulatePstn&&this._simulatePstn.length>0&&(this.contextAttributes.set("callType","PSTN"),this.contextAttributes.remove("location"),this.contextAttributes.remove("appLocation"),this.contextAttributes.remove("deviceType"),this.contextAttributes.remove("devType"),this.contextAttributes.remove("browser"),this.contextAttributes.remove("browserVersion"),this.contextAttributes.remove("osVersion"),this.contextAttributes.remove("url"),this.contextAttributes.remove("email"),this.contextAttributes.set("fullName","+6445551234"),this.contextAttributes.set("phone","+6445551234"),this.contextAttributes.set("devDesc","Telephone"),this.contextAttributes.set("devType","Phone"),this._simulatePstn.startsWith("in")?(console.log("Inbound PSTN"),this._simulatePstn=null,console.log("Setting this._simulatePstn="+this._simulatePstn)):(console.log("Outbound PSTN: "+this._simulatePstn),this.contextAttributes.set("clientKey",this._simulatePstn),this.contextAttributes.set("shortCode",this._simulatePstn),this._metaScenario._doAnswer=(()=>{this._conversation&&this._conversation.relayCommandTo(null,"*","outbound_pstn_ready",[{}])})))):(this._behaviours=new g(this._metaScenario.behaviours),this._behaviours.allowDowngrades(!1),this._metaScenario._doAnswer=null,this._simulatePstn=null,console.log("Setting this._simulatePstn="+this._simulatePstn)),this.contextAttributes.set("behaviours",this._metaScenario.behaviours),this._callMediaType=this._behaviours.getMediaType(),this._quality=new _(this._metaScenario.quality),e&&e(),void this._buttonState.showMenu()}if(this._metaScenarioAppLocation&&this._metaScenarioAppLocation===t)return console.log("Scenario already downloaded, don't do anything"),e&&e(),this._buttonState.isPreCallIDCheck()&&(console.log("We're starting a KYC call directly; this will take a few seconds longer"),this.dispatchEvent(n.LiveProgressIndicator,!0)),void this._buttonState.showMenu();this._buttonState.hideMenu(),this._rest.getMetaScenario((i,o)=>{console.log("Got metaScenario response..."),this._rest.getCallbackOptions(),i?(this._isMeeting&&(i=this._meet.applyPossiblePstnOverride(i)),this._metaScenario=i,this._metaScenarioAppLocation=t,this._behaviours=new g(i.behaviours),this._behaviours.allowDowngrades(!1),this._messages=new m(i.messages),this._quality=new _(i.quality),this._callMediaType=this._behaviours.getMediaType(),console.log("Configuration.behaviours: ",i.behaviours),console.log("Configuration.messages: ",i.messages),console.log("Configuration.quality: ",i.quality),this.contextAttributes.set("behaviours",i.behaviours),console.log("Stored behaviours: "+JSON.stringify(this.contextAttributes.get("behaviours"),null,2)),this.contextAttributes.set("messages",i.messages),console.log("Stored messages: "+JSON.stringify(this.contextAttributes.get("messages"),null,2)),this._buttonState.isPreCallIDCheck()&&(console.log("We're starting a KYC call directly; this will take a few seconds longer"),this.dispatchEvent(n.LiveProgressIndicator,!0))):console.log("getMetaScenario: No configuration"),o?(this._components=o,this._customization=new S(o.customization),console.log("Components.customization: ",o.customization)):console.log("getMetaScenario: No components"),this._buttonState.updateMenu(),this._isMeeting?(console.log("Hiding oracle-live-experience"),this._buttonState.isMeeting=!0,e&&e()):(e&&e(),this._buttonState.showMenu())})}overrideBehaviours(e){console.log("Overriding behaviours to be "+JSON.stringify(e,null,2)),this._behaviours=new g(e),this._callMediaType=this._behaviours.getMediaType(),this.contextAttributes.set("behaviours",e),this._buttonState.updateMenu()}_getMessagesAndAddComponent(e){console.log("-> getMessagesAndComponent");const t=this.settings.locale||navigator.language;this._rest.getMessages(t,t=>{t&&(t.application_universal_message_audio_safari_hint?console.log("No need to patch messages for new Safari hint text: wording=",t.application_universal_message_audio_safari_hint):(console.log("Patching messages to include new Safari hint text"),t.application_universal_message_audio_safari_hint="If you are having trouble hearing the operator please increase your call volume using the volume control buttons, or tap the red mic icon on the top to mute and un-mute."),t.application_universal_title_audio_safari_hint?console.log("No need to patch messages for new Safari hint title: wording=",t.application_universal_title_audio_safari_hint):(console.log("Patching messages to include new Safari hint title"),t.application_universal_title_audio_safari_hint="Increase Volume"),this._buttonState.messages=t),this._buttonState.addMenu(!1),this._componentAdded=!0,console.log("Component added: messages retrieved=",t),e&&e()})}getAvailability(){this._rest.getAppAvailability(e=>{this.refreshAvailability(e.nextChange),console.log("getAvailability: available="+e.available),this._buttonState.setAvailable(!0===e.available||"true"===e.available),!0===e.available||"true"===e.available?this._buttonState.showMenu():this._buttonState.hideMenu()})}refreshAvailability(e){if(console.log("refreshAvailability: nextChange="+e),e){const t=1e3*e,i=Math.floor(t/1e3),o=Date.now(),s=Math.floor(o/1e3),n=t-o,a=Math.floor(n/1e3),r=c.formatDuration(s,i);console.log("Will refresh availability in: "+a+" seconds ("+r+" [hours:mins:secs])"),setTimeout(()=>{this.getAvailability()},n)}}checkPostCallRating(){this._conversation.isPostCallRatingRequired()&&(console.log("LiveAudioVideo: Post-call rating is required"),this._conversationId=this._conversation.getKey(),this.dispatchEvent(n.LiveRatingRequired))}initCallWithAssociate(e,t){this._rest.getTeamConfig(i=>{if(console.log("Checking if we can startCallWithAssociate. State="+this._buttonState.stateName),"Connecting"===this._buttonState.stateName){console.log("this._simulatePstn="+this._simulatePstn);let o=this._simulatePstn?this._simulatePstn:t;this.startCallWithAssociate(e,o,i)}else console.log("Not starting call with associate because not in Connecting state")})}stopConnectingTimers(){this._offerCallbackNoAnswerTimer&&(clearTimeout(this._offerCallbackNoAnswerTimer),this._offerCallbackNoAnswerTimer=null),this._offerCallbackTimer&&(clearTimeout(this._offerCallbackTimer),this._offerCallbackTimer=null),this._connectionTimer&&(clearTimeout(this._connectionTimer),this._connectionTimer=null)}startCallWithAssociate(e,t,i){console.log("LiveControllerImpl::startCallWithAssociate: shortCode="+t),console.log("LiveControllerImpl::startCallWithAssociate: rehydratingToState="+this._rehydratingToState),this._endCallReason="";let o=(new Date).getTime();if(this._callbackAlreadyOfferred=!1,this._isMeeting||(this._connectionTimer=setTimeout(()=>{console.log("LiveControllerImpl::startCallWithAssociate associate did not respond in "+i+" ms."),this._buttonState.menu._isCallbackDialogVisible?console.log("Letting callback dialog handle ending the call"):this.dispatchEvent(n.LiveConnectingNoAnswer),this._connectionTimer=null,this.stopConnectingTimers()},i),this._offerCallbackNoAnswerTimer=setTimeout(()=>{console.log("LiveControllerImpl::startCallWithAssociate associate did not respond in 15 s"),this.canOfferCallback()&&(console.log("Offering callback because associate did not respond within 15 s"),this._offerCallbackNoAnswerTimer=null,this.dispatchEvent(n.LiveCallbackPromptUser,"Associate not answering"))},15e3)),!0===this._reconnectingLocal)return void console.log("LiveControllerImpl::startCallWithAssociate: reconnectingLocal is true so returning");this.contextAttributes.set("shortCode",t||null);const s=t=>{console.log("LiveControllerImpl::startCallWithAssociate: waiting for answer.."),this._buttonState.hideQueueLengthIndicator(),this.dispatchEvent(n.LiveWaiting),this._connection.logEventTimestamp("availableAgentRequestSent"),this._rest.addToCallQueue(this._callMediaType,i=>{let o=i,s=null;if(i.startsWith("{")&&i.endsWith("}")){const e=JSON.parse(i);o=e.assignedAgent,s=e.conversationKey,console.log("LiveControllerImpl::_hidePauseResumeButton... "),this._buttonState.hidePauseResumeButton(),console.log("LiveControllerImpl::startCallWithAssociate: Have a conversationKey="+s)}console.log("LiveControllerImpl::startCallWithAssociate: Call answered, address="+o),this._offerCallbackTimer&&(clearTimeout(this._offerCallbackTimer),this._offerCallbackTimer=null),this._buttonState.menu.hideRequestCallbackDialog(),this._connection.logEventTimestamp("availableAgentSuccessResponseGot"),this.dispatchEvent(n.LiveConnecting),this.startCall(o,e,s),t&&(console.log("Restore original behaviours for next call"),this.contextAttributes.set("behaviours",t))},(e,i)=>{console.log("LiveControllerImpl::startCallWithAssociate: No answer: reason=",e,", message=",i),this._connection.logEventTimestamp("availableAgentFailResponseGot"),"Error"===e?(console.log("LiveControllerImpl::startCallWithAssociate: Error"),this.dispatchEvent(n.LiveConnectingError)):"TeamBusy"===e?(console.log("LiveControllerImpl::startCallWithAssociate: TeamBusy"),this.dispatchEvent(n.LiveConnectingTeamBusy)):this.canOfferCallback()?(console.log("LiveControllerImpl::startCallWithAssociate: canOfferCallBack()"),this.dispatchEvent(n.LiveCallbackPromptUser,i)):(console.log("LiveControllerImpl::startCallWithAssociate: None"),this.dispatchEvent(n.LiveConnectingNoAnswer)),t&&(console.log("Restore original behaviours for next call"),this.contextAttributes.set("behaviours",t))})},a=()=>{if(!this._isMeeting){let e=(new Date).getTime()-o;e>300&&null!==this._connectionTimer&&(console.log("LiveControllerImpl::startCallWithAssociate re-setting timer to loose "+e+"ms delay"),clearTimeout(this._connectionTimer),this._connectionTimer=setTimeout(()=>{console.log("LiveControllerImpl::startCallWithAssociate associate did not respond in "+i+" ms"),this.dispatchEvent(n.LiveConnectingNoAnswer),this._connectionTimer=null},i))}if(this.dispatchEvent(n.LiveDiagnosticsComplete),"Connecting"===this._rehydratingToState){let e=sessionStorage.getItem("previousJWT");e&&this._rest.removeFromQueue(this._callMediaType,e,()=>{console.log("Have removed earlier call made with JWT:"+e),console.log("LiveControllerImpl::startCallWithAssociate sending context"),this._rest.sendContext(()=>{s(this._behaviours)})})}else console.log("LiveControllerImpl::startCallWithAssociate sending context"),this._rest.sendContext(()=>{console.log("Context sent..."),"Connecting"===this._buttonState.stateName?(console.log("Waiting for answer..."),s(this._behaviours)):(console.log("Not in Connecting State. State is: "+this._buttonState.stateName),console.log("So ending call with associate"),this.stopConnectingTimers(),this.endCallWithAssociate())})},r=()=>{this._diags.hasAudio()?(this._diags.hasAudio()&&!this._diags.hasVideo()&&console.log("LiveControllerImpl::startCallWithAssociate: Cannot start video call - we will idle camera stream instead"),a()):this._buttonState.event(n.LiveDiagnosticsFailed)};if(this._isMeeting)this._diags.checkMeetingDiagnostics(this._behaviours.isEndUserVideoPossible()).then(e=>{console.log("LiveControllerImpl::startCallWithAssociate: Audio & video checks completed: ",e),r()}).catch(e=>{console.log("LiveControllerImpl::startCallWithAssociate: Audio & video checks failed: ",e),r()});else if(!0===this._behaviours.isStartWithEndUserScreenShare())console.log("LiveControllerImpl::startCallWithAssociate: no diagnostics for screenshare call"),a();else{if(this._behaviours.isStartWithEndUserVideo()&&navigator.userAgent.match(/iPhone|iPad/i)&&(console.log("We're on iPhone or iPad (i.e. mobile Safari)"),/OS[/\s](\d+_\d+)/.test(navigator.userAgent))){const e=Number(RegExp.$1.replace("_","."));if(console.log("The iOS/iPadOS version is:",e),e<14)return console.log("We are starting a video call from an older mobile Safari version - skipping diagnostics"),void a()}const e=this._behaviours.isStartWithEndUserVideo(),t=this._behaviours.isEndUserVideoPossible()&&!e;console.log("LiveControllerImpl::startCallWithAssociate: initiating split diags process.."),Promise.all([this._diags.testVideo(t),this._diags.testCombinedDevices(e)]).then(e=>{console.log("LiveControllerImpl::startCallWithAssociate: diagnostics completed: ",e),r()}).catch(e=>{console.warn("LiveControllerImpl::startCallWithAssociate: diagnostics failed: ",e),"CANCELLED"!==e&&this._buttonState.event(n.LiveDiagnosticsFailed)})}}initIdle(){this._isAssociateConnected=!1,this._rest&&(this._rest._haveContextResponse=!1)}shutdown(){console.log("controller shutdown"),this.endCallWithAssociate(),this._buttonState.state._context.state.reset(),this._buttonState.hideMenu(),this._buttonState.menu.hideComponent(),this.reset()}endCallWithAssociate(){if($("body").css("visibility","visible"),console.log("LiveControllerImpl::endCallWithAssociate"),console.log("Is associate connected: "+this._isAssociateConnected),!this._isAssociateConnected)return;if(this._isAssociateConnected=!1,this._rest.resetContextResponse(),this._resetMyStreams(),this._av)try{this._av.stop()}catch(e){console.log("LiveControllerImpl::endCallWithAssociate Conversation already closed",e)}let e;if(this._screen.stopSendingScreenShare(),this._screen.stopReceivingScreenShare(),this.resetDummyScreenshareCreatedFlag(),this._cobrowse.terminate("end_call"),this._conversation){console.log("LiveControllerImpl::endCallWithAssociate ending conversation",this._conversation),e=this._conversation.conversationKey,console.log("Removing local participant from conversation");let t=this._conversation.getLocalParticipant();if(t||(console.warn("Could not find local participant. Searching for: "+this.service.userID),t=this._conversation.getParticipant(this.service.userID)),t){console.log("Removing participant");let e=t.getStreamInfos();if(e&&e.length>0)for(let t=0;t<e.length;t++)e[t].remove();t.remove()}else{console.warn("Could not find local participant: "+this.service.userID);const e=this._conversation.getParticipants();1===e.length&&(console.warn("Only 1 participant left in conversation. Must be us, so leave"),console.log(e[0].uri),e[0].remove())}}else{console.log("LiveControllerImpl::endCallWithAssociate no call, remove from queue");let e=this.service.authToken;this._rest.removeFromQueue(this._callMediaType,e,()=>{console.log("LiveControllerImpl::endCallWithAssociate removed from call queue")})}this._buttonState.isPreCallIDCheck()?this.getVerificationResult(e).finally(()=>this.reset()):this.reset(),console.log("LiveControllerImpl::endCallWithAssociate Finished")}holdCallWithAssociate(){if(console.log("LiveControllerImpl::holdCallWithAssociate uri: "+this._associateUri),this._buttonState.isTransferring())return void console.log("Not holding call with associate because we're transferring a call");let e=new live.PauseResume(live.PAUSERESUME.PAUSE,live.PAUSERESUME.PAUSE,live.PAUSERESUMEREASON.PAUSE_RESUME);this._screen.isActive()&&(this._screen.pauseResumeStream(e),this._screen.pauseResumeOutgoing(!0)),$(".oracle-live"),$(".oracle-live").hasClass("oracle-live-frozen-annotation")&&(e.video=live.PAUSERESUME.RESUME),this._av.pauseResumeStream(e),this.dispatchEvent(n.LivePausedLocally)}resumeCallWithAssociate(){if(console.log("LiveControllerImpl::resumeCallWithAssociate"),this._buttonState.isTransferring())return console.log("Not resuming call with associate because we're transferring a call"),!1;let e=new live.PauseResume(this.isUsingExternalAudio()?live.PAUSERESUME.PAUSE:live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,live.PAUSERESUMEREASON.PAUSE_RESUME);return this._av.pauseResumeStream(e),this.dispatchEvent(n.LiveResumedLocally),this._screen.isActive()&&(this._screen.pauseResumeStream(e),this._screen.pauseResumeOutgoing(!1)),this._av.updateAudioForEchoCancellation(e),!0}registerForCallback(e){if(console.log("controller.registerForCallback: "+e),e){const t=t=>{t?console.log("LiveControllerImpl::registerForCallback: Received response for sendContext"):console.log("LiveControllerImpl::registerForCallback: registering now using previous sendContext response"),this._rest.createCallback(e).then(()=>{console.log("Callback created"),this._rest.closeCallQueue(),this.dispatchEvent(n.LiveCallbackRegisterSuccess),this._buttonState.menu.setConfirmCallback()}).catch(e=>{console.log("err: ",e.message),this.dispatchEvent(n.LiveCallbackRegisterFailure),this._buttonState.menu.setCallbackError()})};this.dispatchEvent(n.LiveCallbackRegister),this._rest.getContextResponse()?(console.log("Don't need to sendContext() as we've already done it."),t(!1)):(console.log("Now calling sendContext() as we have not done it yet."),this._rest.sendContext(()=>{t(!0)}))}}validateCallbackPhoneNumber(e,t){return this._buttonState.menu.validateCallbackPhoneNumber(e,t)}getCallbackPhoneNumber(){return this._buttonState.menu.getCallbackPhoneNumber()}getCallbackCountryCode(){return this._buttonState.menu.getCallbackCountryCode()}isCallEndedEvent(){return this._callEndedEventReceived}dispatchEvent(e,t){console.log("LiveControllerImpl::dispatchEvent: "+e,t),e===n.LiveProgressIndicator&&(this._progressIndicatorStarted=t),e===n.LiveEnded&&(this._callEndedEventReceived=!0);let i={bubbles:!0};t&&(i.detail=t);const o=new CustomEvent(e,i);if(console.log("LiveControllerImpl::dispatchEvent new event: ",o),this._eventNode)console.log("LiveControllerImpl::dispatchEvent dispatching on: ",this._eventNode),document.querySelector(this._eventNode).dispatchEvent(o);else{let t=document.querySelector("body");if(null===t)return void console.warn("No body element on this page - there's nowhere to dispatch its events to");a.find(t=>t===e)?t.dispatchEvent(o):console.log("Cannot dispatch event '"+e+"' Event is not exposed")}this._buttonState.event(e,t)}event(e){console.log("LiveControllerImpl::receivedEvent: ",e),this._buttonState.event(e)}reloadAssociateAvatar(e){this._associateUri=e,console.log("reloadAssociateAvatar: associateUri: "+this._associateUri),this._isMeeting||this._rest.getAssociateAvatar()}startCall(e,t,i){console.log("startCall with: "+e+", conversationKey:"+i),this._associateUri=e,console.log("startCall: associate uri="+this._associateUri),this._rest.getAssociateInfo(),this._isMeeting||this._rest.getAssociateAvatar();const o=i&&i.length>0;this._buttonState.canRejoinMeeting=!o,this._behaviours.allowDowngrades(o),this._buttonState.configureComponent(),this._resetMyStreams();const s=this._quality?this._quality.getMaxVideoBitrate():0;console.log("startCall: maxVideoBitrate: ",s),s>0&&(this._connection.setVideoSendBitrate(s),this._connection.setVideoRecvBitrate(s)),console.log("startCall: _connection:",this._connection),this._conversation=this._connection.makeConversation().withKey(i).withCallbacks(this.detectWhenRecordingStateChanges.bind(this),this.detectWhenParticipantsChange.bind(this),this.detectWhenCallHasFailed.bind(this),this.detectWhenRelayCommandIsReceived.bind(this)).withContext(this.contextAttributes.toWebContext()).withoutShortCircuit(),console.log("startCall: endUserInitialMedia="+this._behaviours.endUserInitialMedia+", associateInitialMedia="+this._behaviours.associateInitialMedia+", meetingsEnabled="+this._behaviours.meetingsEnabled);const n=new live.StreamProfile(!0,!1,this.service.userID,new live.PauseResume(live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,null));this._behaviours.associateInitialMedia!==this._behaviours.StartMediaType.AUDIO_ONLY&&this._behaviours.associateInitialMedia!==this._behaviours.StartMediaType.NONE||(console.log("Updating associate stream profile to disable video"),n.upgraded=!1,n.pauseResume.video=live.PAUSERESUME.PAUSE,n.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,this._av._associateVideoInitiallyPaused=!0),console.log("startCall: assocStreamProfile="+JSON.stringify(n,null,2));const a=this._buildRemoteStreamOptions();if(this._behaviours.isStartWithEndUserScreenShare())this.startCallScreenShareStream(a,n);else{const e=new live.StreamProfile(!0,!1,this.service.userID,new live.PauseResume(live.PAUSERESUME.RESUME,live.PAUSERESUME.RESUME,null));this._behaviours.endUserInitialMedia!==this._behaviours.StartMediaType.AUDIO_ONLY&&this._behaviours.endUserInitialMedia!==this._behaviours.StartMediaType.NONE||(console.log("Updating user stream profile to disable video"),e.upgraded=!1,e.pauseResume.video=live.PAUSERESUME.PAUSE,e.pauseResume.reason=live.PAUSERESUMEREASON.UPGRADE_DOWNGRADE,this._av._userVideoInitiallyPaused=!0);const i=this._buildLocalStreamOptions();console.log("startCall: userStreamProfile="+JSON.stringify(e,null,2)),this.startCallAudioVideoStream(i,a,t,e,n)}}_resetMyStreams(){console.log("Resetting remembered streams"),this._myStreams=[],this._agentStreams=new Map}_rememberMyStreams(e){console.log("Remembering streamId: "+e),this._myStreams.includes(e)||this._myStreams.push(e)}_buildLocalStreamOptions(){let e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.INACTIVE;return this._behaviours.isStartWithEndUserScreenShare()?(e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.SENDONLY):(this._behaviours.isAssociateAudioPossible()&&this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.SENDONLY:this._behaviours.isAssociateAudioPossible()&&(e=live.MEDIADIRECTION.RECVONLY),this._behaviours.isAssociateVideoPossible()&&this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.SENDONLY:this._behaviours.isAssociateVideoPossible()&&(t=live.MEDIADIRECTION.RECVONLY)),console.log("localStreamOptions: audio="+e+", video="+t),live.StreamInfo.createStreamOptions(e,t)}_buildRemoteStreamOptions(){let e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.INACTIVE;return this._behaviours.isStartWithEndUserScreenShare()?(e=live.MEDIADIRECTION.INACTIVE,t=live.MEDIADIRECTION.RECVONLY):(this._behaviours.isAssociateAudioPossible()&&this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserAudioPossible()?e=live.MEDIADIRECTION.RECVONLY:this._behaviours.isAssociateAudioPossible()&&(e=live.MEDIADIRECTION.SENDONLY),this._behaviours.isAssociateVideoPossible()&&this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.SENDRECV:this._behaviours.isEndUserVideoPossible()?t=live.MEDIADIRECTION.RECVONLY:this._behaviours.isAssociateVideoPossible()&&(t=live.MEDIADIRECTION.SENDONLY)),console.log("remoteStreamOptions: audio="+e+", video="+t),live.StreamInfo.createStreamOptions(e,t)}startCallAudioVideoStream(e,t,i,o,s){console.log("startCallAudioVideoStream: associateUri="+this._associateUri),o&&console.log("Overriding local stream profile: ",o),this._conversation.withParticipant(this._associateUri,t,s),this._av.start(e,o,i)}startCallScreenShareStream(e,t){console.log("LiveControllerImpl::startScreensharing: associateUri="+this._associateUri),this._conversation.withParticipant(this._associateUri,e,t,live.STREAMTYPE.SCREENSHARE),this._screen.startSendingScreenShare()}onCallEstablished(e){!0!==this._callEstablished&&(this._callEstablished=!0,clearTimeout(this._connectionTimer),this.dispatchEvent(n.LiveConnected),this.checkPostCallRating(),this.stopReconnectionTimer(),this._simulatePstn=null,console.log("Setting this._simulatePstn="+this._simulatePstn),e&&this._behaviours&&"SCREEN_SHARE"===this._behaviours.endUserInitialMedia&&this.dispatchEvent(n.LiveLocalScreenStarted))}onCallStreamStateError(){!0!==this._reconnectingLocal&&(this.dispatchEvent(n.LiveReconnectingLocal),this.sendNetworkStatus("network_disconnect"),this.startReconnectionTimer())}onCallEnded(){clearTimeout(this._connectionTimer),this.resetDummyScreenshareCreatedFlag(),this._simulatePstn=null,console.log("Setting this._simulatePstn="+this._simulatePstn),this.dispatchEvent(n.LiveEnded)}onScreenShareEnded(){this._behaviours.isStartWithEndUserScreenShare()&&(clearTimeout(this._connectionTimer),this.dispatchEvent(n.LiveEnded))}detectWhenCallHasFailed(e){console.log("LiveControllerImpl::detectWhenCallHasFailed: ",JSON.stringify(e,null,2)),this.dispatchEvent(n.LiveCanceled)}detectWhenParticipantsChange(e,t,i){switch(console.log("LiveControllerImpl::detectWhenParticipantsChange change="+t,i),console.log("       participant uri:"+i.getUri()),e.getLocalParticipant()&&console.log(" local participant uri:"+e.getLocalParticipant().getUri()),t){case live.CONVERSATIONSTATE.STREAM_ADDED:if(i.initCallbacks(this.detectWhenParticipantStateChanges.bind(this,i),this.detectWhenAddLocalStreamRequested.bind(this),this.detectWhenAddRemoteStreamRequested.bind(this)),"None"!==this._buttonState.transferState&&(console.log("TRANSFER: new associate uri="+this._associateUri),console.log("stream_added: participant uri="+i.uri),"AssociateObtained"!==this._buttonState.transferState&&!this._transferToAssociateUri&&i.getUri()!==e.getLocalParticipant())){this._buttonState.transferState="AssociateObtained";const e=this._associateUri;this._associateUri=i.uri,this._transferToAssociateUri=this._associateUri,this._rest.getAssociateInfo().then(()=>{this.reloadAssociateAvatar(this._associateUri),this._buttonState.menu.transferAssociatePanel(this._behaviours.isStartWithAssociateVideo(),e,this._associateUri)})}break;case live.CONVERSATIONSTATE.STREAM_LEFT:case live.CONVERSATIONSTATE.STREAM_REMOVED:{this._av.updateAudioForEchoCancellation(null),i.uri!==this._transferringAssociateUri&&(console.log(t+": Dispatching LiveParticipantLeft Event..."),this.dispatchEvent(n.LiveParticipantLeft,i)),"RemoveOriginalAssociate"===this._buttonState.transferState&&this._transferringAssociateStillConnected&&i.uri===this._transferringAssociateUri&&(this._transferringAssociateStillConnected=!1,this._buttonState.transferState="None",console.log("Participant ("+i.uri+") has left. Setting transferState to None")),this._buttonState.removeAssociate(i.uri);let e=i.getStreamInfos();if(e&&e.length>0)for(let t=0;t<e.length;t++)e[t].remove()}break;case live.CONVERSATIONSTATE.STREAM_REJECTED:this.dispatchEvent(n.LiveParticipantLeft,i)}}addQualityMonitor(){const e=this.getAssociateStreamInfo(live.STREAMTYPE.AUDIOVIDEO);e&&(console.log("addQualityMonitor: AV",e),this._networkQualityMonitor.monitor(e,!1));const t=this.getAssociateStreamInfo(live.STREAMTYPE.SCREENSHARE);t&&(console.log("addQualityMonitor: SS",t),this._networkQualityMonitor.monitor(t,!1));const i=this.getLocalStreamInfo(live.STREAMTYPE.AUDIOVIDEO);i&&(console.log("addQualityMonitor: AV",i),this._networkQualityMonitor.monitor(i,!0));const o=this.getLocalStreamInfo(live.STREAMTYPE.SCREENSHARE);o&&(console.log("addQualityMonitor: SS",o),this._networkQualityMonitor.monitor(o,!0))}detectWhenParticipantStateChanges(e,t,i){const o=e.getUri(),s=i.getType();console.log("LiveControllerImpl::detectWhenParticipantStateChanges: state="+t+", uri="+o+", streamType="+s,e,i),this._screen.showConversationStreams();const a=i.getStreamProfile();console.log("Incoming stream profile=",JSON.stringify(a,null,2));const r=i.getStreamOptions();console.log("Incoming stream options=",JSON.stringify(r,null,2));const l=r.shouldSendVideo();switch(t){case live.CONVERSATIONSTATE.STREAM_ACTIVE:this._connection.logEventTimestamp((s===live.STREAMTYPE.AUDIOVIDEO?"av":"ss")+(o===this.service.userID?"Local":"Remote")+"ParticipantStateToSTREAM_ACTIVE"),o===this._associateUri&&(this.addQualityMonitor(),this._haveTweakedSpeakerVolumeSinceStartOfCall||this._behaviours.isEndUserVideoPossible()||!this._isMeeting&&navigator.userAgent.match(/iPhone/i)&&(console.log("We're on an iPhone (i.e. iOS Safari)"),this._haveTweakedSpeakerVolumeSinceStartOfCall=!0,setTimeout(()=>{console.log("Muting local audio on iOS as workaround for low-volume remote audio (WebKit bug 196539)"),this._av.muteLocalAudio(!0),setTimeout(()=>{console.log("Resuming local audio on iOS as workaround for low-volume remote audio"),this._av.muteLocalAudio(!1)},200)},200),this._buttonState&&this._buttonState.messages&&this._buttonState.messages.application_universal_message_audio_safari_hint&&this.dispatchEvent(n.LiveMessageEmitted,"SpecialSafariAudioHint"))),s===live.STREAMTYPE.AUDIOVIDEO&&(this.dispatchEvent(n.LiveStreamActive),this.reconnectedLocal(),this._av.updateAudioForEchoCancellation(null)),o===this.service.userID&&s===live.STREAMTYPE.SCREENSHARE&&this._screen.maybeSelectRemoteSS(),s===live.STREAMTYPE.SCREENSHARE&&(console.log("Screenshare stream active received"),this._av.disableAudioForScreenshareStream(),this._screenshareStreamSendRecv&&this._buttonState.menu.setScreenshareReady(!0),this._behaviours.isStartWithEndUserScreenShare()&&(console.log("Call starts in screenshare, so sending show_screen_share to ensure valid recording"),this._screen.showHideScreenShare(!0))),console.log("this._buttonState.isTransferring(): "+this._buttonState.isTransferring()),console.log("               participant.uri: "+e.uri),console.log("this._transferringAssociateUri: "+this._transferringAssociateUri),console.log("this._transferToAssociateUri: "+this._transferToAssociateUri),console.log("_transferringAssociateStillConnected: "+this._transferringAssociateStillConnected),console.log("this._buttonState.transferState: "+this._buttonState.transferState),!this._buttonState.isTransferring()||e.uri!==this._transferToAssociateUri&&e.uri!=="null@"+this._transferToAssociateUri||(console.log("New participant has connected: "+e.uri),console.log("                 associateUri: "+this._associateUri),"RemoveOriginalAssociate"!==this._buttonState.transferState||this._transferringAssociateStillConnected||(this._buttonState.transferState="None")),o===this._associateUri&&s===live.STREAMTYPE.SCREENSHARE&&l&&this.dispatchEvent(n.LiveRemoteScreenActive);break;case live.CONVERSATIONSTATE.STREAM_JOINED:if(o===this._associateUri&&s===live.STREAMTYPE.SCREENSHARE){console.log("Screen share STREAM_JOINED!",i,JSON.stringify(r,null,2));let e=!1;o===this._associateUri&&(console.log(`Screenshare stream_joined is from remote agent ${o}`),this._screenshareStreamSendRecv?(console.log("and agent is expected to be SENDRECV"),this._screen._outgoingScreenshareId&&null===this._screen._incomingScreenshareId&&(console.log("We have an outgoing screenshare, but no incoming screenshare"),this._screen._outgoingScreenshareId===i.getId()&&(console.log("This is our outgoing SS stream, so not receiving SS"),e=!1),this._screen._outgoingScreenshareId!==i.getId()&&(console.log("This is NOT our outgoing SS stream, so assume it's agent's incoming SS"),e=!0)),this._screen._incomingScreenshareId&&this._screen._incomingScreenshareId===i.getId()&&(console.log("This is our incoming SS stream, and we've started receiving before, so now join"),e=!1)):"sendonly"===i.streamOptions.videoConfig&&(console.log("Incoming stream from agent is sendonly, so can start receiving SS"),e=!0)),e?(console.log("streamJoined: The associate is sending us a screen share"),this._screen.startReceivingScreenShare(i)):(this._screen.streamJoined(i),this._buttonState.menu.setScreenshareReady(!0))}else if(s===live.STREAMTYPE.AUDIOVIDEO&&this._av.isActive())if(console.log("LiveControllerImpl::STREAM_JOINED: uri: "+o+" streamid: "+i.getId()+"transfer uri: "+this._transferToAssociateUri),o!==this._transferToAssociateUri&&o!=="null@"+this._transferToAssociateUri||this._agentStreams.has(o)&&this._agentStreams.get(o).has(i.getId())||this._conversation.getStreams().some(e=>e.getId()===i.getId()))console.log("LiveControllerImpl::STREAM_JOINED: Already have: "+i.getId());else{if(console.log("LiveControllerImpl::STREAM_JOINED: Remote participant: "+o+" should this stream: "+i.getId()+" be joined?"),"Transfer"===this._buttonState.transferMode)console.log("LiveControllerImpl::STREAM_JOINED: transfer so joining first remote stream"),this._av.streamJoined(i);else if(this._agentStreams.has(o)&&this._agentStreams.get(o).size)console.log("LiveControllerImpl::STREAM_JOINED: joining second remote stream notification only"),this._av.streamJoined(i),this._agentStreams.get(o).add(i.getId());else{console.log("LiveControllerImpl::STREAM_JOINED: ignoring first remote stream for an agent");let e=new Set;e.add(i.getId()),this._agentStreams.set(o,e)}console.log("LiveControllerImpl::STREAM_JOINED: Agent streams: ",this._agentStreamw)}break;case live.CONVERSATIONSTATE.STREAM_REMOVED:if(console.log("Received stream_removed"),console.log("               uri = "+o),console.log("Transferring agent = "+this._transferringAssociateUri),console.log(" Transfer to agent = "+this._transferToAssociateUri),console.log("     _associateUri = "+this._associateUri),console.log("        streamType = "+s),console.log("            stream = "+i.getId()),console.log("Transferring agent still connected = "+this._transferringAssociateStillConnected),this._agentStreams.has(o)&&this._agentStreams.get(o).has(i.getId())&&(console.log("LiveControllerImpl::STREAM_REMOVED: uri {}, agentStreams {}",o,this._agentStreams),this._agentStreams.get(o).delete(i.getId())),o===this._associateUri&&s===live.STREAMTYPE.SCREENSHARE)console.log("Screenshare stream removed. Calling stopReceivingScreenShare"),this._screen.stopReceivingScreenShare(),this._screen.stopSendingScreenShare(),this._screen._localOutgoingSS&&this._screen._localOutgoingSS.getId()===i.getId()&&this._screen.stopSendingScreenShareOriginal();else if(s===live.STREAMTYPE.AUDIOVIDEO){if(console.log("STREAM_REMOVED: check if a valid remote stream and stop: ",i.getId()),this._av.stopRemote(i),!this._behaviours.isAudioOnly()){this._av.removeRemoteById(i.getId());for(let e=0;e<this._conversation.getStreams().length;e++)this._conversation.getStreams()[e].getStreamInfo().getId()===i.getId()&&this._conversation.getStreams()[e].getStreamInfo().remove();this._agentStreams.has(e.getUri())&&this._agentStreams.get(e.getUri()).has(i.getId())&&this._agentStreams.get(e.getUri()).delete(i.getId());const t=this._myStreams.indexOf(i.getId());t>-1&&this._myStreams.splice(t,1)}this._av.updateAudioForEchoCancellation(null)}this._transferringAssociateStillConnected&&o===this._transferringAssociateUri&&i.getType()===live.STREAMTYPE.AUDIOVIDEO&&(console.log("TRANSFER: Transferring associate ("+e.uri+") has left"),this._transferringAssociateStillConnected=!1,console.log("Transferring agent still connected = "+this._transferringAssociateStillConnected));break;case live.CONVERSATIONSTATE.STREAM_CHANGED:s===live.STREAMTYPE.AUDIOVIDEO&&(console.log("Remote participant changed: upgraded="+a.upgraded+", paused="+a.paused+", video_paused="+a.pauseResume.video),i&&i.streamId&&this._myStreams.includes(i.streamId)?(console.log("Validated stream"),o!==this._conversation.getLocalParticipantUri()?r.videoConfig===live.MEDIADIRECTION.SENDRECV||r.videoConfig===live.MEDIADIRECTION.SENDONLY?a.upgraded?"resume"===a.pauseResume.video?this._av.isRemoteVideoActive(i.getId())?console.log("Incoming video stream is already upgraded and in resume state"):this._av.enableRemoteVideo(i.getId()):"pause"===a.pauseResume.video?this._av.isRemoteVideoActive(i.getId())?this._av.disableRemoteVideo(i.getId()):console.log("Incoming video stream is either already downgraded or in pause state"):console.log("Ignoring video stream that is not an <upgrade resume> or downgrade"):"resume"===a.pauseResume.audio?this._av.isRemoteVideoActive(i.getId())?this._av.disableRemoteVideo(i.getId()):console.log("Incoming video stream is already downgraded"):console.log("Ignoring profile_updated that is not a downgrade resume"):console.log("Ignoring non video or non video sending stream"):console.log("STREAM_CHANGED: ignoring because not an associate, check: "+o)):console.log("Ignoring STREAM_CHANGED for not valid streamId: "+(i&&i.streamId?i.streamId:"(invalid streamId)")));break;case live.CONVERSATIONSTATE.PROFILE_UPDATED:s===live.STREAMTYPE.AUDIOVIDEO&&(console.log("Remote participant changed: upgraded="+a.upgraded+", paused="+a.paused+", video_paused="+a.pauseResume.video),i&&i.streamId&&this._myStreams.includes(i.streamId)?(console.log("Validated stream, uri: "+o),r.videoConfig===live.MEDIADIRECTION.SENDRECV||r.videoConfig===live.MEDIADIRECTION.SENDONLY?a.upgraded?"resume"===a.pauseResume.video?this._av.isRemoteVideoActive(i.getId())?console.log("Incoming video stream is already upgraded"):this._av.enableRemoteVideo(i.getId()):"pause"===a.pauseResume.video?this._av.isRemoteVideoActive(i.getId())?this._av.disableRemoteVideo(i.getId()):console.log("Incoming video stream is either already downgraded or in pause state"):console.log("Ignoring profile_updated that is not an upgrade (resume or pause)"):"resume"===a.pauseResume.audio?this._av.isRemoteVideoActive(i.getId())?this._av.disableRemoteVideo(i.getId()):console.log("Incoming video stream is already downgraded"):console.log("Ignoring profile_updated that is not a downgrade resume"):console.log("Ignoring non video stream")):console.log("Ignoring PROFILE_UPDATED for not valid streamId: "+(i&&i.streamId?i.streamId:"(invalid streamId)")));break;case live.CONVERSATIONSTATE.SIDEBAR_CREATED:console.log("Sidebar created"),this._conversation.addRemainingStreams()}}detectWhenAddRemoteStreamRequested(e,t,i,o,s){console.log("LiveControllerImpl::detectWhenAddRemoteStreamRequested: conversation:",e),console.log(".. participant:",t),console.log(".. streamRequest:",i),console.log(".. streamType:",o),console.log(".. streamOptions:",s),this._upgradeRequest=i,this._upgradeRequestStreamType=o,this._upgradeRequestForUser="associate",o===live.STREAMTYPE.SCREENSHARE&&this.dispatchEvent(n.LiveRemoteScreenShareRequested)}detectWhenAddLocalStreamRequested(e,t,i,o,s){console.log("LiveControllerImpl::detectWhenAddLocalStreamRequested: conversation:",e),console.log(".. participant:",t),console.log(".. streamRequest:",i),console.log(".. streamType:",o),console.log(".. streamOptions:",s),this._upgradeRequest=i,this._upgradeRequestStreamType=o,this._upgradeRequestForUser="user",this.dispatchEvent(n.LiveStartScreenShareRequested)}upgradeRequestIsAssociateScreenShare(){return this._upgradeRequestStreamType===live.STREAMTYPE.SCREENSHARE&&"associate"===this._upgradeRequestForUser}upgradeRequestIsUserScreenShare(){return this._upgradeRequestStreamType===live.STREAMTYPE.SCREENSHARE&&"user"===this._upgradeRequestForUser}upgradeRequestIsUserVideo(){return this._upgradeRequestStreamType===live.STREAMTYPE.AUDIOVIDEO&&"user"===this._upgradeRequestForUser}isRequestUserCobrowse(){return!0===this._cobrowseRequestForUser}setIsRequestUserCobrowse(e){this._cobrowseRequestForUser=e}reconnectedLocal(){if(console.log("reconnectedLocal: reconnecting="+this._reconnectingLocal),this._reconnectingLocal&&(this.dispatchEvent(n.LiveReconnectedLocal),this.stopReconnectionTimer(),this.sendNetworkStatus("network_recover")),this._conversation){const e=this._conversation.getRemoteParticipant(),t=this._conversation.getLocalParticipant();(e&&e.isRecording()||t&&t.isRecording()||this._conversation.isRecording())&&this.dispatchEvent(n.LiveRecordingStarted)}}changeMainAssociate(e){console.log("changeMainAssociate to "+e),this._associateUri=e,this._rest.getAssociateInfo().then(()=>{this.reloadAssociateAvatar(this._associateUri)})}isMeetingPSTNUpgrade(){const e=this._isMeeting&&this._meet._isPstnUpgrade;return console.log("isMeetingPSTNUpgrade returning "+e),e}detectWhenRelayCommandIsReceived(e,t,i,o,s){switch(console.log("detectWhenRelayCommandIsReceived: command="+o,s),o){case"network_disconnect":this._associates.length<=1&&(this.dispatchEvent(n.LiveReconnectingRemote),this.startReconnectionTimer());break;case"network_recover":this.dispatchEvent(n.LiveReconnectedRemote),this.stopReconnectionTimer();break;case"upgrade_downgrade":this._av.isActive()&&this._av.detectStreamPauseResumeRequest(e,t,i,s[0]),this._screen.isActive()&&this._screen.detectStreamPauseResumeRequest(e,t,i,s[0]);break;case"cancel":this.cancelUpgradeRequest(s[0].original_directive);break;case"annotate_start":this.dispatchEvent(n.LiveAssociateAnnotationStarted);break;case"annotate_stop":this.dispatchEvent(n.LiveAssociateAnnotationStopped);break;case"video_annotate_start":this.dispatchEvent(n.LiveAssociateVideoAnnotationStarted);break;case"video_annotate_stop":this.dispatchEvent(n.LiveAssociateVideoAnnotationStopped);break;case"freeze_customer_stream":$("body").css("visibility","hidden"),$(".oracle-live").css("visibility","visible"),this.dispatchEvent(n.LiveAssociateFreezeCustomerStream,s);break;case"unfreeze_customer_stream":$("body").css("visibility","visible"),this.dispatchEvent(n.LiveAssociateUnfreezeCustomerStream);break;case"hidden_screen_share":{console.log("hidden_screen_share received on stream:",t),this._screenshareStreamSendRecv=!1;const e=this._behaviours&&(this._behaviours.endUserCanAddScreenShare||this._behaviours.associateCanRequestEndUserScreenShare);s.length>0&&s[0].direction&&s[0].direction.length>0&&e&&(this._screenshareStreamSendRecv="sendrecv"===s[0].direction,console.log(`_screenshareStreamSendRecv = ${this._screenshareStreamSendRecv}`)),this.setPermanentTwoWayScreenShare(!0),this.startDummyScreenShareIfNecessary()}break;case"show_screen_share":console.log("show_screen_share received on stream:",t),this._screen.showIncomingScreenShare();break;case"hide_screen_share":this._screen.hideIncomingScreenShare();break;case"stop_screen_share":this._screen.stopSendingScreenShare();break;case"add_call_started":console.log("TRANSFER: add_call_started"),this._buttonState.transferState="Started",this._buttonState.transferMode="AddParticipant",this._transferringAssociateUri=this._associateUri,this.dispatchEvent(n.LiveAssociateAddParticipantStarted,s);break;case"transfer_started":console.log("TRANSFER: transfer_started"),this._buttonState.transferMode="Transfer",this._av._hasTransferStreamStarted=!1,this._av._isSwitchingToNewAssocStream=!1,this._transferringAssociateStillConnected=!0,this._buttonState.menu.setScreenshareReady(!1),this.isMeetingPSTNUpgrade()&&(console.log("Received a transfer during PSTN upgrade, ending meeting leg"),this.endCallWithAssociate()),this.prepareForCallTransfer(),this._transferringAssociateUri=this._associateUri,this._buttonState.transferState="Started",this.dispatchEvent(n.LiveAssociateTransferStarted,s);break;case"transfer_start_stream":case"add_call_start_stream":if(console.log("Transfer Mode: "+this._buttonState.transferMode),s.length>0&&s[0].target&&s[0].target.length>0){if("Transfer"===this._buttonState.transferMode){const e=this._associateUri;this._associateUri=s[0].target,this._transferToAssociateUri=this._associateUri,this._rest.getAssociateInfo().then(()=>{this.reloadAssociateAvatar(this._associateUri),this._buttonState.menu.transferAssociatePanel(this._behaviours.isStartWithAssociateVideo(),e,this._associateUri)}),console.log("TRANSFER: Received "+o),console.log("  Transferring from associate: "+this._transferringAssociateUri),console.log("    Transferring to associate: "+this._associateUri),this.dispatchEvent(n.LiveAssociateTransferStartStream,s)}else this._transferringAssociateUri=this._associateUri,this._transferToAssociateUri=s[0].target,this._associateUri=s[0].target,this._rest.getAssociateInfo().then(()=>{this._associateUri=this._transferringAssociateUri}),console.log("TRANSFER ADD_PARTICIPANT: Received "+o),console.log("  Transferring from associate: "+this._transferringAssociateUri),console.log("    Transferring to associate: "+this._transferToAssociateUri),this.dispatchEvent(n.LiveAssociateAddParticipantStartStream,s);this._buttonState.transferState="AssociateObtained"}break;case"transfer_completed":console.log("TRANSFER: transfer_complete"),this._buttonState.transferMode="None",this._buttonState.transferState="RemoveOriginalAssociate",this.dispatchEvent(n.LiveAssociateTransferCompleted,s),this.finishCallTransfer("transfer",t.getId());break;case"add_call_completed":this._buttonState.transferMode="None",this.finishCallTransfer("addParticipant"),this.dispatchEvent(n.LiveAssociateAddParticipantCompleted,s);break;case"transfer_failed":console.log("TRANSFER: transfer_failed"),this._buttonState.transferState="None",this.dispatchEvent(n.LiveAssociateTransferFailed,s),this.cancelCallTransfer();break;case"add_call_failed":console.log("TRANSFER: add_call_failed"),this._buttonState.transferState="None",this.dispatchEvent(n.LiveAssociateAddParticipantFailed,s),this.cancelCallTransfer();break;case"transfer_stopped":console.log("TRANSFER: transfer_stopped"),this._buttonState.transferState="None",this.dispatchEvent(n.LiveAssociateTransferStopped,s),this.cancelCallTransfer();break;case"add_call_stopped":console.log("TRANSFER: add_call_stopped"),this._buttonState.transferState="None",this.dispatchEvent(n.LiveAssociateAddParticipantStopped,s),this.cancelCallTransfer();break;case"annotate_customer_stream":{let e=s&&s[0]&&s[0].annotation_type?s[0].annotation_type:void 0;console.log("annotationType: ",e),void 0===e?(console.log("annotate_customer_screen missing annotation_type"),this.dispatchEvent(n.LiveAssociateAnnotationReceived,s)):"screen_share"===e?this.dispatchEvent(n.LiveAssociateAnnotationReceived,s):"video"===e&&this.dispatchEvent(n.LiveAssociateVideoAnnotationReceived,s);break}case"send_text_snippet":{let e=s&&s[0]&&s[0].message?s[0].message:void 0,i=s&&s[0]&&s[0].messageSender?s[0].messageSender:void 0;e&&this._buttonState.handleInChannelMesssage(e,i,t);break}case"request_cobrowse":console.log("COBROWSE: actioning relay request_cobrowse"),this.setIsRequestUserCobrowse(!0),this.dispatchEvent(n.LiveCobrowseRequest);break;case"stop_cobrowse":console.log("COBROWSE: actioning relay stop_cobrowse"),this._cobrowse.terminate(this._cobrowse.isCobrowseActive()?"associate":"other"),this.setIsRequestUserCobrowse(!1);break;case"decline_cobrowse":this._cobrowse.terminate("declined"),this.setIsRequestUserCobrowse(!1);break;case"call_control_transferred":{let e=s&&s[0]&&s[0].newHost?s[0].newHost:s&&s[0]&&s[0].from?s[0].from:null;e&&(console.log("Received "+o+" changing host to: "+e),this._buttonState.swapAssociates(e));break}case"pause_participant_stream":s.length>0&&s[0].target&&s[0].target.length>0&&s[0].target===this.service.userID&&(console.log("PAUSE: actioning relay pause_participant_stream"),this.dispatchEvent(n.LivePausedRemotely));break;case"resume_participant_stream":s.length>0&&s[0].target&&s[0].target.length>0&&s[0].target===this.service.userID&&(console.log("PAUSE: actioning relay resume_participant_stream"),this.dispatchEvent(n.LiveResumedRemotely),this.sendResumeAll(i.relayFrom));break;default:console.log("Ignoring directive: ",o,", args: ",s)}}sendResumeAll(e){if(this._conversation){console.log("sendResumeAll to all remote participants");for(let t of this._conversation.getParticipants())if(t.getUri()!==this._conversation.getLocalParticipantUri()&&t.getUri()!==e)for(let e of t.getStreamInfos())for(let i of this._av._avStreams)if(i.id===e.getId()){console.log("resume_participant_stream target avid: "+e.getId()+" uri: "+t.getUri()),this._conversation.relayCommandTo(i.id,"*","resume_participant_stream",[{target:t.getUri()}]);break}}}sendParticipantStreamStatus(e){if(this._conversation){console.log("sendParticipantStreamStatus to all remote participants");for(let t of this._conversation.getParticipants())if(t.getUri()!==this._conversation.getLocalParticipantUri())for(let i of t.getStreamInfos())for(let o of this._av._avStreams)if(o.id===i.getId()){console.log("sendParticipantStreamStatus target avid: "+i.getId()+" uri: "+t.getUri()),this._conversation.relayCommandTo(o.id,"*","participant_stream_status",[{target:t.getUri(),status:{uri:this._conversation.getLocalParticipantUri(),status:e,source:"local-user-paused"}}]);break}}}prepareForCallTransfer(){console.log("TRANSFER: Stopping stat collectors"),this._av.statsCollectorStop(),this._screen.statsCollectorStop(),this._screen.stopSendingScreenShareOriginal(),this._screen.stopReceivingScreenShare()}cancelCallTransfer(){this.resetDummyScreenshareCreatedFlag(),console.log("cancelCallTransfer"),this._av.statsCollectorStart(),this._screen.statsCollectorStart(),this._buttonState._buttonMenu._setDefaultFullScreenVideoPanelLayout()}finishCallTransfer(e,t){console.log("finishCallTransfer"),"transfer"===e&&(this._av.switchToAvStreamForNewAssociate(t),this._buttonState.transferState="RemoveOriginalAssociate"),"addParticipant"===e&&(this._av.saveAvStreamForNewAssociate(t),this._buttonState.transferState="None"),this.resetDummyScreenshareCreatedFlag(),console.log("TRANSFER: Starting stat collectors"),this._av.statsCollectorStart(),this._screen.statsCollectorStart()}resetDummyScreenshareCreatedFlag(){this._permanentTwoWayScreenShare&&(console.log("Resetting dummy screenhsare flag"),this._dummyScreenShareCreated=!1)}detectWhenRecordingStateChanges(e,t){console.log("Conversation "+(t?"IS":"is NOT")+" being recorded"),t?this.dispatchEvent(n.LiveRecordingStarted):this.dispatchEvent(n.LiveRecordingStopped)}setPermanentTwoWayScreenShare(e){console.log("setPermanentTwoWayScreenShare => "+e),this._permanentTwoWayScreenShare=e}installChromeScreenSharePlugin(){this.dispatchEvent(n.LiveScreenSharePluginInstalling),this._screen.installChromeScreenSharePlugin()}cancelChromeScreenSharePluginInstall(){this.declineUpgradeRequest(),this._screen.cancelChromeScreenSharePluginInstall()}acceptUpgradeRequest(){this._upgradeRequest?(console.log("Accepting request for: "+this._upgradeRequestStreamType+" to: "+this._upgradeRequestForUser),this._upgradeRequest.accept(),this._upgradeRequest=null,console.log("Accepted remote upgrade request"),this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null):this.isRequestUserCobrowse()&&(console.log("Accepting cobrowse request, no longer requesting.`"),this.setIsRequestUserCobrowse(!1))}declineUpgradeRequest(){this._upgradeRequest?(console.log("Declining request for: "+this._upgradeRequestStreamType+" to: "+this._upgradeRequestForUser),this._upgradeRequest.decline(),this._upgradeRequest=null,this._av._upgradePauseResume=null,this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null):this.isRequestUserCobrowse()&&(console.log("Declining cobrowse request."),this.setIsRequestUserCobrowse(!1),this._cobrowse.decline())}cancelUpgradeRequest(e){console.log("Associate has cancelled request: "+e),this._upgradeRequestStreamType&&this._upgradeRequestForUser&&console.log("Pending request for: "+this._upgradeRequestStreamType+" to: "+this._upgradeRequestForUser),"add_stream"===e?this.upgradeRequestIsAssociateScreenShare()?this.dispatchEvent(n.LiveRemoteScreenShareCancelled):this.upgradeRequestIsUserScreenShare()?this.dispatchEvent(n.LiveStartScreenShareRequestCancelled):this.upgradeRequestIsUserVideo()&&this.dispatchEvent(n.LiveStartVideoRequestCancelled):"pause_resume_stream"===e&&(this.upgradeRequestIsUserScreenShare()?this.dispatchEvent(n.LiveStartScreenShareRequestCancelled):this.upgradeRequestIsUserVideo()&&this.dispatchEvent(n.LiveStartVideoRequestCancelled)),this._upgradeRequestStreamType=null,this._upgradeRequestForUser=null,this._av._upgradePauseResume=null,this.setIsRequestUserCobrowse(!1)}upgradeLocalVideo(){this._av.startVideo()}downgradeLocalVideo(){this._av.stopVideo()}startVideoPreview(){if(console.log("LiveControllerImpl.startVideoPreview"),this._isRehydratingNonMeetingCall()||this._isRehydratingMeetingCall())console.log("LiveControllerImpl.startVideoPreview: rehydrating so not starting preview");else{this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),console.log("LiveControllerImpl.startVideoPreview: call LiveAudioVideo.startVideoPreview"),this._haveRequestedVideoPreview=!0;let e=null;this._isMeeting&&(e=this._behaviours.endUserInitialMedia===this._behaviours.StartMediaType.AUDIO_ONLY),this._av.startVideoPreview(e)}}stopVideoPreview(e){if(console.log("LiveControllerImpl.stopVideoPreview: "+(e?"cancelling call":"progressing with call")),this._av.stopVideoPreview(),this.hasClass(".oracle-live","oracle-live-preCallIDCheck-call-associate")&&this.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),e){const e=this._buttonState.isPreCallIDCheck();console.log("Cancelling call: "+(e?" Call is ID Verify Call":"Regular call")),e?(console.log("ID check call - cancelling"),this.netVerificationCancelled(n.LiveCanceled),this.dispatchEvent(n.LivePreCallIDCheckCancelled),this._precallIDCheckCancelled=!0):(console.log("Non-ID check call - cancelling"),this.dispatchEvent(n.LiveCanceled))}}sendScreenShare(e){console.log("LiveControllerImpl::sendScreenShare",!0===e),e?this._screen.startSendingScreenShare():this._screen.stopSendingScreenShare()}readyCobrowse(){null===this.service.authToken?setTimeout(this.readyCobrowse,250):this._cobrowse.ready(()=>{})}enableCobrowse(){this._buttonState.menu.setCobrowseReady(this._cobrowse.loaded)}unableToStartCobrowse(){this.dispatchEvent(n.LiveCobrowseEnded,"nostart")}startCobrowse(e){console.log("LiveControllerImpl::startCobrowse",!0===e),e?this.dispatchEvent(n.LiveCobrowseStart):this._cobrowse.terminate("user")}detectWhenConnectionHasChanged(e){switch(console.log("LiveControllerImpl::detectWhenConnectionHasChanged: state=",e),e){case live.CONNECTIONSTATE.FAILED:console.log("LiveControllerImpl::detectWhenConnectionHasChanged FAILED"),this._conversation?this.dispatchEvent(n.LiveStreamError):(console.error("Failed to connect to server"),this._connectionId=null,this.dispatchEvent(n.LiveLoginError),this.reset(),this._connection=null);break;case live.CONNECTIONSTATE.RECONNECTING:this._reconnectingLocal=!0,this.dispatchEvent(n.LiveReconnectingLocal),this.sendNetworkStatus("network_disconnect"),this.startReconnectionTimer();break;case live.CONNECTIONSTATE.CONNECTED:this.reconnectedLocal()}}detectIncomingStream(e,t,i){console.log("detectIncomingStream: streamOptions="+JSON.stringify(i,null,2),t),t.getType()===live.STREAMTYPE.AUDIOVIDEO?(console.log("incomingAV: ",t),this._av.incomingAV(t,i)):console.log("incomingSS: ",t)}sendNetworkStatus(e){this._conversation&&(console.log("sendNetworkStatus: "+e),this._conversation.relayCommandTo(null,"*",e,[{target:this._conversation.getLocalParticipantUri()}]))}sendUpdatedContextAttribute(e,t){if(this._conversation&&this._av.isActive()){const i={};i[e]=t,console.log("sendUpdatedContextAttribute: "+JSON.stringify(i,null,2)),this._conversation.conversationKey&&this._conversation.relayCommandTo(null,"*","context_updated",[i])}}sendAnnotationStart(){const e=this.getAssociateStreamInfo(live.STREAMTYPE.SCREENSHARE);if(e){const t=e.getId();if(t)return void this._conversation.relayCommandTo(t,"*","annotate_start",[{}])}console.log("sendAnnotationStart: failed to send annotationStart relay message")}sendAnnotationStop(){const e=this.getAssociateStreamInfo(live.STREAMTYPE.SCREENSHARE);if(e){const t=e.getId();if(t)return void this._conversation.relayCommandTo(t,"*","annotate_stop",[{}])}console.log("sendAnnotationStop: failed to send annotationStop relay message")}startReconnectionTimer(){this._reconnectionTimer?console.log("Reconnection timer already running"):(console.log("Starting the reconnection timer"),this._reconnectingLocal=!0,this._reconnectionTimer=setTimeout(()=>{console.log("Reconnection timer expired, assume that remote participant has left"),this.dispatchEvent(n.LiveParticipantLeft)},this._reconnectionTimeout),this.stopStatusCheckTimer())}stopReconnectionTimer(){this._reconnectionTimer&&(console.log("Stopped the reconnection timer"),clearTimeout(this._reconnectionTimer),this._reconnectingLocal=!1,this._reconnectionTimer=null,this._conversation&&this.startStatusCheckTimer())}startStatusCheckTimer(){this._statusCheckTimer?console.log("StatusCheck timer already running"):(console.log("Starting the StatusCheck timer"),this._statusCheckTimer=setTimeout(()=>{console.log("StatusCheck timer, checking the status of the call"),this._conversation?this._conversation.checkStatus(()=>{console.log("Status check successful")},e=>{console.log("Status check failed: "+e),this.dispatchEvent(n.LiveParticipantLeft)}):this.dispatchEvent(n.LiveParticipantLeft)},this._statusCheckTimeout))}stopStatusCheckTimer(){this._statusCheckTimer&&(console.log("Stopped the StatusCheck timer"),clearTimeout(this._statusCheckTimer),this._statusCheckTimer=null)}generateCode(){const e={},t=window.location.search.substring(1).split("&");for(let i=0;i<t.length;i++){const o=t[i].split("=");void 0===e[o[0]]?e[o[0]]=decodeURIComponent(o[1]):"string"==typeof e[o[0]]?e[o[0]]=[e[o[0]],decodeURIComponent(o[1])]:e[o[0]].push(decodeURIComponent(o[1]))}let i={};const o=e.meeting_id;return o?(i.id=o,i.type="meetingCode"):sessionStorage.getItem("Code")?i=JSON.parse(sessionStorage.getItem("Code")):(i.id=this.generateShortCode(),i.type="shortCode"),sessionStorage.setItem("Code",JSON.stringify(i)),console.log("Generated code: "+i.id+","+i.type),i}generateShortCode(){let e="23456789ABCDEFGHJKLMNPQRSTUVWXYZ",t=Math.ceil(1),i=Math.floor(e.length),o=window.crypto||window.msCrypto,s="";for(let n=0;n<6;n++){let n=new Uint32Array(1);o.getRandomValues(n);let a=n[0]/4294967296;s+=e[Math.floor(a*(i-t+1))+t-1]}return console.log("Generated short-code: "+s),s}refreshConnection(e){console.log("LiveControllerImpl::refreshConnection ",e),this._conversation=e,this._reconnectingLocal=!0,this._conversation.withCallbacks(this.detectWhenRecordingStateChanges.bind(this),this.detectWhenParticipantsChange.bind(this),this.detectWhenCallHasFailed.bind(this),this.detectWhenRelayCommandIsReceived.bind(this)),this._conversation.getParticipants().forEach(e=>{e.initCallbacks(this.detectWhenParticipantStateChanges.bind(this,e),this.detectWhenAddLocalStreamRequested.bind(this),this.detectWhenAddRemoteStreamRequested.bind(this))});const t=this._conversation.getLocalParticipantUri(),i=this._conversation.getParticipants().find(e=>e.getUri()!==t);i&&(console.log("Found remote participant: "+JSON.stringify(i,null,2)),this._associateUri=i.getUri(),console.log("Settting associate uri = "+this._associateUri+" from remote participant"),console.log("LiveControllerImpl::refreshConnection: Reload associate avatar"),this.reloadAssociateAvatar(this._associateUri)),e.getStreams().forEach(e=>{e.getType()===live.STREAMTYPE.AUDIOVIDEO?this._av.resume(e):(console.log("LiveControllerImpl::refreshConnection screenshare stream ",e),this._screen.resume(e)),this._screen.setConnectionRestored()}),this.sendUpdatedContextAttribute("url",this.contextAttributes.get("url"))}setPositionInQueue(e){console.log(`positionInQueue: ${e}`),this._positionInQueue=e,this.dispatchEvent(n.LiveCallQueuePositionUpdate)}getPositionInQueue(){console.log("getPositionInQueue");let e="";return this._positionInQueue&&(e+=this._positionInQueue),e.endsWith("1")&&"11"!==e?e+="st":e.endsWith("2")&&"12"!==e?e+="nd":e.endsWith("3")&&"13"!==e?e+="rd":0!==e.length&&(e+="th"),e}setAssociateName(e){console.log("Setting main associate name: "+e),this._buttonState.associateName=e}getAssociateName(e){const t=this._associates.find(t=>t.url===e);return t?t.name:null}addAssociate(e,t){if(this._associates.find(t=>t.url===e))return void console.log("Not adding associate because one already exists");const i={url:e,name:t};console.log("addAssociate: Pushing: ",JSON.stringify(i)),this._associates.push(i),console.log("Associate length = "+this._associates.length),console.log("associates: ",JSON.stringify(this._associates)),1===this._associates.length?this.setAssociateName(i.name):(console.log("Adding additional associate name"),this._buttonState.additionalAssociateName=i.name,console.log("Associate length = "+this._associates.length),console.log("associates: ",JSON.stringify(this._associates)))}removeAssociate(e){console.log("removeAssociate: "+e);const t=this._associates.findIndex(t=>{if(t.url===e)return t});if(t>=0){console.log("Removing associate at index: "+t);const e=this._associates[t];return console.log("Removing associate: url="+e.url+" "+e.name),this._associates.splice(t,1),e.name}return null}setAssociatePhoto(e){this._buttonState.associatePhotoURL=e}getAssociateStreamInfo(e){return this._conversation.getParticipant(this._associateUri)?this._conversation.getParticipant(this._associateUri).getStreamInfos().find(t=>t.getType()===e):null}getLocalStreamInfo(e){return this._conversation.getLocalParticipant().getStreamInfos().find(t=>t.getType()===e)}startDummyScreenShareIfNecessary(){console.log("startDummyScreenShareIfNecessary()"),this._behaviours&&console.log("endUserScreenSharePossible: "+this._behaviours.isEndUserScreenSharePossible()),console.log("   dummyScreenShareCreated: "+this._dummyScreenShareCreated),this._dummyScreenShareCreated||this._behaviours&&this._behaviours.isEndUserScreenSharePossible()&&(console.log("End user can share screen - creating a dummy screen share stream for faster on/off"),this._dummyScreenShareCreated=!0,console.log("   dummyScreenShareCreated: "+this._dummyScreenShareCreated),console.log("adding dummy screen share"),this._screen.startDummyScreenShare())}netVerificationCancelled(e=n.LivePreCallIDCheckError){this.dispatchEvent(e),this._rest.deleteIdentityVerificationTransaction(this.service,this._transactionReference).then(e=>console.log("netVerificationCancelled: got response: "+e)).catch(e=>console.error("netVerificationCancelled: failed to delete transaction: "+e.message,e.response))}waitForVerificationStatus(e,t=1e4,i=6e5){console.log("LiveControllerImpl::waitForVerificationStatus  transactionReference: ",e);const o=Number(new Date)+i;let s="PENDING",a="FAILURE";const r=e=>{e&&console.log("LiveControllerImpl::rejectCallback: received response: ",e),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckFailed),this.netVerificationCancelled()},l=i=>{i&&(s=i.status,a=i.lxResult),this.service.kycScanReference=e,console.log("Saving kycScanReference: "+this.service.kycScanReference),console.log("LiveControllerImpl::resolveCallback received response: ",i),"DONE"!==s||"SUCCESS"!==a&&"UNSURE"!==a?"ERROR"===s||"FAILURE"===a?(console.log("LiveControllerImpl::resolveCallback error received"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckFailed),this.netVerificationCancelled()):"PENDING"===s&&(console.log("LiveControllerImpl::resolveCallback: about to call poll"),setTimeout(()=>{c()},t)):(console.log("LiveControllerImpl::resolveCallback we have a successful verification"),this.contextAttributes.set("preCallCheckId",e),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-verified"))},c=()=>{const t=Number(new Date);console.log("LiveControllerImpl::poll status: "+s+"  endTime: "+o+" now: "+t),"PENDING"===s?t<o?(console.log("LiveControllerImpl::poll:  waiting"),console.log("LiveControllerImpl::poll:  polling"),this._rest.getPreCallIDCheckStatus(this.service,e,l,r)):(console.log("Polling timeout occurred - verification failed"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckFailed),this.netVerificationCancelled()):console.log("LiveControllerImpl::poll: stop polling: ")};c()}skipVerificationStatusStartCallToAssociate(e,t=1e4,i=6e5){console.log("LiveControllerImpl::skipVerificationStatusStartCallToAssociate  transactionReference: ",e),this.contextAttributes.set("preCallCheckId",e),this.service.kycScanReference=e,console.log("Saved kycScanReference: "+this.service.kycScanReference),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-verified")}startPreCallIDCheck(e){console.log("LiveControllerImpl::startPreCallIDCheck"),this.dispatchEvent(n.LivePreCallIDCheckStarted);const t=this,i=o=>{if(console.log("LiveControllerImpl::jumioMessageHandler origin: ",o.origin),this._buttonState.menu.showComponent(),this._autoTest||!o.origin||o.origin.length){let s=JSON.parse(o.data);if(console.log("LiveControllerImpl::jumioMessageHandler data: ",JSON.stringify(s,null,2)),this.addClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),s.payload){const o=s.payload.value;"loaded"===o?console.log("LiveControllerImpl::jumioMessageHandler received 'loaded' message"):"success"===o?(console.log("LiveControllerImpl::jumioMessageHandler We have success!"),e.removeEventListener("message",i,!1),this.addClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),t._transactionReference=s.transactionReference,t._transactionReference&&t.skipVerificationStatusStartCallToAssociate(t._transactionReference)):"error"===o&&(this._transactionReference=s.transactionReference,this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),this.dispatchEvent(n.LivePreCallIDCheckIncomplete),this.netVerificationCancelled())}}else console.log("LiveControllerImpl::jumioMessageHandler with an invalid origin - ignoring")};this._precallIDCheckCancelled=!1,this._rest.sendContext(()=>{const t=this._rest.createInitiatePreCallCheckPayload();this.settings.attemptFaceMatchWhenVerifyingIdentity&&(console.log("Including a face match in the ID Verification process"),t.faceMatch=!0),console.log("LiveControllerImpl::startPreCallIDCheck: data: ",t),this._rest.initiatePreCallIDCheck(this.service,t,t=>{console.log("LiveControllerImpl::startPreCallIDCheck received response: ",t);let o="",s="";if(t.redirectUrl){o=t.redirectUrl,s=t.transactionReference,console.log("LiveControllerImpl::startPreCallIDCheck redirectUrl",o),console.log("LiveControllerImpl::startPreCallIDCheck transactionRef",s),e.addEventListener("message",i,!1);const a=document.getElementsByClassName("kyc-jumio-iframe");if(a.length>0){console.log("Re-creating kyc-iframe...");let e=a[0],t=document.createElement("iframe");t.id="kyc-iframe",t.classList.add("kyc-jumio-iframe"),t.allow="camera",console.log("Setting iframe src..."),t.src=o,e.parentNode.replaceChild(t,e),console.log("New kyc-iframe created"),this.addClass(".oracle-live","oracle-live-preCallIDCheck-in-progress")}this._buttonState.isPreCallIDCheck()&&(console.log("Stopping progress indicator"),this.dispatchEvent(n.LiveProgressIndicator,!1))}},e=>{console.log("LiveControllerImpl::startPreCallIDCheck failed: ",e),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),console.log("Cancelling Verification:",e),this.dispatchEvent(n.LivePreCallIDCheckCancelled,e),this.netVerificationCancelled()})})}continueVerification(){console.log("LiveControllerImpl::continueVerification"),this._rest.updatePreCallIdCheck(this.service,this._transactionReference,null,e=>{e&&console.log("LiveControllerImpl::rejectCallback: received response: ",e)}),this.addClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this.addClass(".oracle-live","oracle-live-video-enduser-maximized"),this.dispatchEvent(n.LiveStartVerificationCall)}getVerificationResult(e){console.log("LiveControllerImpl::getVerificationResult: conversationKey: ",e);let t="Failure";return this._rest.getPreCallIDCheckResult(this.service,e).then(e=>{console.log("LiveRestHelper::getPreCallIDCheckResult: got response: "+e),console.log("LiveControllerImpl::getVerificationResult: received response: ",e),e&&(t=e.result),"Success"===t?(console.log("resolveCallback: result: Success"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckComplete)):"INCOMPLETE"===t?(console.log("resolveCallback: result: INCOMPLETE"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckIncomplete)):(console.log("resolveCallback: result: Failure"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckFailed))}).catch(e=>{console.log("LiveRestHelper::getPreCallIDCheckResult: failed to getPreCallIDCheckResult, Error: "+e.message,e.response),e.response&&console.log("LiveControllerImpl::rejectCallback: received response: ",e.response),this._precallIDCheckCancelled?(this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckCancelled)):(this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.dispatchEvent(n.LivePreCallIDCheckIncomplete)),this.netVerificationCancelled()})}resetPreCallIDCheckState(){console.log("LiveControllerImpl::resetPreCallIDCheckState"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verifying"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-verified"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-enabled"),this.removeClass(".oracle-live","oracle-live-preCallIDCheck-call-associate"),this._transactionReference=null,this._precallIDCheckCancelled=!1,this.contextAttributes.remove("preCallCheckId"),$(".kyc-jumio-iframe").attr("src",null)}removeClass(e,t){e&&t?$(e).removeClass(t):console.log("LiveControllerImpl::removeClass: unable to remove class - invalid parameters")}addClass(e,t){e&&t?$(e).addClass(t):console.log("LiveControllerImpl::removeClass: unable to add class - invalid parameters")}hasClass(e,t){if(e&&t)return $(e).hasClass(t);console.log("LiveControllerImpl::removeClass: unable to remove class - invalid parameters")}isUsingExternalAudio(){return this._buttonState.isUsingExternalAudio()}reloadRatherThanRejoin(){if(console.log("reloadRatherThanRejoin making an assessment.. nav="+navigator.userAgent),navigator.userAgent.match(/iPhone|iPad/i)&&(console.log("We're on iPhone or iPad (i.e. iOS Safari)"),/OS[/\s](\d+_\d+)/.test(navigator.userAgent))){const e=Number(RegExp.$1.replace("_","."));if(console.log("We're on iOS and OS version is:",e),e<13.4&&this._isMeeting)return console.log("We are a meeting on an iOS device running less than 13.4 - say reload!"),!0}return!1}}}),define("LiveMeeting",[],function(){"use strict";return class{constructor(e){this._impl=e,console.log("Resetting pstn upgrade indicator to false"),this._isPstnUpgrade=!1}addComponent(e){this._impl.addComponent(e)}event(e){this._impl.event(e)}getNetworkStatus(e,t){this._impl.getNetworkStatus(e,t)}getMetaScenario(e){this._impl._rest.getMetaScenario(e)}overrideBehaviours(e){this._impl.overrideBehaviours(e)}setPstnOverride(e){return console.log("setPstnOverride.."),this._isPstnUpgrade=!0,null===e?null:this.applyPossiblePstnOverride(e)}applyPossiblePstnOverride(e){return console.log("applyPossiblePstnOverride.."),this._isPstnUpgrade&&(console.log("applyPossiblePstnOverride knows this meeting is a PSTN upgrade."),e=this.removeAudio(e),this.overrideBehaviours(e.behaviours)),console.log("applyPossiblePstnOverride returning config:",e),e}removeAudio(e){return console.log("Removing audio from configuration behaviours: "+JSON.stringify(e.behaviours,null,2)),"AUDIO_ONLY"===e.behaviours.endUserInitialMedia?e.behaviours.endUserInitialMedia="NONE":"AUDIO_VIDEO"===e.behaviours.endUserInitialMedia&&(e.behaviours.endUserInitialMedia="VIDEO_ONLY"),"AUDIO_ONLY"===e.behaviours.associateInitialMedia?e.behaviours.associateInitialMedia="NONE":"AUDIO_VIDEO"===e.behaviours.associateInitialMedia&&(e.behaviours.associateInitialMedia="VIDEO_ONLY"),e.behaviours.endUserCanAddAudio=!1,e.behaviours.associateCanAddAudio=!1,e.behaviours.associateCanRequestEndUserAudio=!1,console.log("Configuration behaviours is now: "+JSON.stringify(e.behaviours,null,2)),e}}}),define("LiveController",["LiveControllerImpl","LiveEvents","LiveMeeting"],function(e,t,i){"use strict";return class{constructor(){console.log("construct LiveController"),this._impl=new e,this._meet=new i(this._impl),this._impl._meet=this._meet}get service(){return this._impl.service}get contextAttributes(){return this._impl.contextAttributes}get settings(){return this._impl.settings}get version(){return this._impl.version}get events(){return t}addComponent(e){this._impl.addComponent(e)}updateComponent(){this._impl.updateComponent()}}}),define("oracle.live.api",["LiveController"],function(e){"use strict";return console.log("Oracle Live Experience loaded"),{controller:new e}});